

<HTML>
<HEAD>
<TITLE>HOWTO: Call NetUserGetInfo API from Visual Basic </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q151774">
<META NAME="KBModify" CONTENT="1997/03/26">
<META NAME="KBCreate" CONTENT="1996/05/29">
<META NAME="Keywords" CONTENT="APrgOther kbusage vb432 VB4WIN vb5all vb5howto VBKBWinAPI kbhowto">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  The NetUserGetInfo function is a Unicode-only Windows NT API. The last parameter of this function is a pointer to a pointer to a structure whose members contain DWORD data and pointers to Unicode strings. In order to call this function correctly fr...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBS0,QATX,QAGI,QAY5,QAO3,QAO2,QBWP,QAB9,QA5F,QAMA,QBV8,QAUD,QANF,QAML,QAH4 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>HOWTO: Call NetUserGetInfo API from Visual Basic</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 26, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q151774</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual Basic Control Creation, Learning, Professional,
   Enterprise Editions for Windows, version 5.0
<LI>Standard, Professional, and Enterprise Editions of Microsoft
   Visual Basic, 32-bit only, for Windows, version 4.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
The NetUserGetInfo function is a Unicode-only Windows NT API. The last
parameter of this function is a pointer to a pointer to a structure whose
members contain DWORD data and pointers to Unicode strings. In order to
call this function correctly from a Visual Basic application, you need to
de-reference the pointer returned by the function and then you need to
convert the Visual Basic string to a Unicode string and vice versa. This
article illustrates these techniques in an example that calls
NetUserGetInfo to retrieve a USER_INFO_3 structure from a Visual Basic
application.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The example below uses the Win32 RtlMoveMemory function to de-reference the
pointer returned by the NetUserGetInfo call. For more information on how to
declare and use RtlMoveMemory function in Visual Basic, please see the
following article in the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE ID: <B><A href="../vbwin/q129947.htm">Q129947</A></B>
   TITLE     : Win32 Replacement for the hmemecpy Function

</PRE>For more information on how to convert Visual Basic string to Unicode
string and vice versa, please see the following article in the Microsoft
Knowledge Base:
<P>
<PRE>   ARTICLE ID: <B><A href="../vbwin/q145727.htm">Q145727</A></B>:
   TITLE     : How to Call the Unicode Version of an API Function with VB

</PRE>NOTE: In order to run the code in the example, you need to change the NT
domain logon name in step 5 to your valid NT domain logon name. An invalid
domain logon name will cause the application to GPF.
<P>
<P><h3>Step-by-Step Example</h3>
 

<OL><P><LI>Start Visual Basic. If Visual Basic is already running, from the File
   menu, choose New Project. Form1 is created by default.

<P><LI>Add a Command button, Command1, to Form1.

<P><LI>Add the following code to the General Declarations section of Form1:
<P>
<P><PRE>      'USER_INFO_3 structure is defined in Win32 SDK, below is the VB
      'declare.
      'LPWSTR is a pointer to a Unicode string.
      'The storage of the USER_INFO_3  structure, including the string
      'buffer referred by its LPWSTR members, are all allocated by Windows
      'NT so the function caller doesn't have to allocate memory.
</PRE><P>
<P><PRE>      Private Type USER_INFO_3
<PRE></PRE>          usri3_name As Long           'LPWSTR in SDK
          usri3_password As Long       'LPWSTR in SDK
          usri3_password_age As Long      'DWORD in SDK
          usri3_priv As Long           'DWORD in SDK
          usri3_home_dir As Long       'LPWSTR in SDK
          usri3_comment As Long        'LPWSTR in SDK
          usri3_flags As Long          'DWORD in SDK
          usri3_script_path As Long    'LPWSTR in SDK
          usri3_auth_flags As Long        'DWORD in SDK
          usri3_full_name As Long         'LPWSTR in SDK
          usri3_usr_comment As Long    'LPWSTR in SDK
          usri3_parms As Long          'LPWSTR in SDK
          usri3_workstations As Long      'LPWSTR in SDK
          usri3_last_logon As Long        'DWORD in SDK
          usri3_last_logoff As Long    'DWORD in SDK
          usri3_acct_expires As Long      'DWORD in SDK
          usri3_max_storage As Long    'DWORD in SDK
          usri3_units_per_week As Long    'DWORD in SDK
          usri3_logon_hours As Long    'PBYTE in SDK
          usri3_bad_pw_count As Long      'DWORD in SDK
          usri3_num_logons As Long        'DWORD in SDK
          usri3_logon_server As Long      'LPWSTR in SDK
          usri3_country_code As Long      'DWORD in SDK
          usri3_code_page As Long         'DWORD in SDK
          usri3_user_id As Long        'DWORD in SDK
          usri3_primary_group_id As Long  'DWORD in SDK
          usri3_profile As Long        'LPWSTR in SDK
          usri3_home_dir_drive As Long    'LPWSTR in SDK
          usri3_password_expired As Long  'DWORD in SDK
      End Type

      Private Declare Function NetUserGetInfo Lib "netapi32.dll" ( _
         strServerName As Any, strUserName As Any, ByVal dwLevel As Long, _
         pBuffer As Long) As Long

      Private Declare Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory" _
         (hpvDest As Any, ByVal hpvSource As Long, ByVal cbCopy As Long)

</PRE><P><LI>Place the following code in the Command1 Click event procedure:
<P>
<P><PRE>      Private Sub Command1_Click()
<PRE></PRE>          Dim pServer() As Byte, pUser() As Byte
          'You need to change "Your_Domain_Logon_Name" in the next line
          'to your valid NT domain logon name.
          pUser = "Your_Domain_Logon_Name" &amp; vbNullChar
          pServer = "" &amp; vbNullChar
          'The above two lines convert VB string to Unicode string.

          Dim dwLevel As Long
          dwLevel = 3

          Dim tmpBuffer As USER_INFO_3
          Dim ptmpBuffer As Long

          NetUserGetInfo pServer(0), pUser(0), dwLevel, ptmpBuffer
          'As last param is dimmed as long, the pointer to ptmpBuffer is
          'passed to dll, and the function returns a pointer to a pointer
          'to our UDT. Therefore ptmpBuffer on return holds a pointer
          'to our UDT.

          'Deference it!!!
          CopyMemory tmpBuffer, ptmpBuffer, LenB(tmpBuffer)

          Dim sUser As String
          Dim sByte() As Byte
          ReDim sByte(255)

          'Convert LPWSTR (Unicode string) to VB string.
          CopyMemory sByte(0), tmpBuffer.usri3_name, 256
          sUser = sByte
          sUser = sUser &amp; vbNullChar
          MsgBox Trim$(sUser)
          'Now I get my user name back, it's VB string now'
      End Sub
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: Unicode NetUserGetInfo<BR>
Keywords            : APrgOther kbusage vb432 VB4WIN vb5all vb5howto VBKBWinAPI kbhowto<BR>
Version             : 4.0 5.0<BR>
Platform            : NT WINDOWS<BR>
Issue type          : kbhowto<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 26, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
