

<HTML>
<HEAD>
<TITLE>PRB: Deactivate Event of Non-Modal ActiveX Form Fails to Fire </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q170370">
<META NAME="KBModify" CONTENT="1997/11/26">
<META NAME="KBCreate" CONTENT="1997/06/19">
<META NAME="Keywords" CONTENT="vb5all VBKBAutomation VBKBAX VBKBComp VBKBDLL">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  Visual Basic 5.0 allows developers to create in-process ActiveX servers with non-modal forms. However, when a user switches between a non-modal form that is part of the main application and a non-modal form that is part of an in-process ActiveX ser...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBS0,QAH4,QBXS,QAPN,QAGI,QAGX,QAFF,QA2Q,QAO4,QBJZ,QAHV,QAMA,QAI2,QBWS,QADO V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: Deactivate Event of Non-Modal ActiveX Form Fails to Fire</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  November 26, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q170370</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual Basic Professional and Enterprise Editions for
   Windows, version 5.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Visual Basic 5.0 allows developers to create in-process ActiveX servers
with non-modal forms. However, when a user switches between a non-modal
form that is part of the main application and a non-modal form that is part
of an in-process ActiveX server, the Deactivate Event of the forms will not
fire.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
You can work around this limitation using any message hooking control
or AddressOf. See the REFERENCES section below for more information.
<P>
The message you need to hook is WM_ACTIVATE. When you receive WM_ACTIVATE
you should check the lower word of the wParam to see if it is equal to
WA_INACTIVE. If it is then your form is being deactivated and you can call
your deactivation code. The following code snippet shows how your message
handler would work:
<P>
<PRE>   Private Const WM_ACTIVATE As Long = &amp;H6
   Private Const WA_INACTIVE As Integer = 0
   Private Const WA_ACTIVE As Integer = 1
   Private Const WA_CLICKACTIVE As Integer = 2

   Function WindowProc(ByVal hw As Long, ByVal uMsg As _
      Long, ByVal wParam As Long, ByVal lParam As Long) As Long
      Select Case Msg
         Case WM_ACTIVATE
            Dim fActive As Integer
            fActive = &amp;HFFFF&amp; And wparam
            Select Case fActive
               Case WA_INACTIVE
                  ' Call deactivation code here
               Case WA_ACTIVE
                  ' Call activation code here
               Case WA_CLICKACTIVE
                  ' Call activation code here
               Case Else
            End Select
         Case Else
      End Select
   End Function

</PRE>NOTE: If you have third-party controls on your for, they may be subclassing
the form as well. If you try to remove your subclass in this scenari, you
could crash. In these circumstances, you can just leave your subclass in
place.
<P>
<P><h2>STATUS</h2>
 
<P>
This behavior is by design.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The Visual Basic 5.0 help topic for the Deactivate event explains the
following:
<P>
"If an .exe file built by Visual Basic displays a dialog box created
by a .dll file also built in Visual Basic, the .exe file's form will
get the Deactivate and LostFocus events. This may be unexpected,
because you should not get the Deactivate event:

<UL><LI>If the object is an out-of-process component.
<LI>If the object isn't written in Visual Basic.
<LI>In the development environment when calling a DLL built in
   Visual Basic."
<P>
</UL>This documentation is a little misleading and should state the
following instead:
<P>
"You should not get a Deactivate event if the focus is changed to
another form that is not part of the VB Project containing the form
that currently has the focus."
<P>
<P><h3>Steps to Reproduce Behavior</h3>
 

<OL><P><LI>Create a new ActiveX DLL project in Visual Basic 5.0. From the Project
   Menu, select Add Form.

<P><LI>Add a Label to the new form and set the Caption to the following:
<P>
<P><PRE>      Non-modal ActiveX form
</PRE>
<P><LI>Add the following code to the Form_Deactivate:
<P>
<P><PRE>      Beep
</PRE>
<P><LI>Change the Name of the Form to "frmActiveX" without the quotes.

<P><LI>Change the name of Class1 to "FormClass" without the quotes.

<P><LI>Change the name of the Project to "FormPrb" without the quotes.

<P><LI>Add the following code the class module:
<P>
<P><PRE>      Public Sub ShowForm()
<PRE></PRE>        frmActiveX.Show 0 'show it modeless
      End Sub

</PRE><P><LI>Save the Project, and then choose Make FormPrb.DLL from the File menu.

<P><LI>From the File Menu, select New Project, and then select Standard EXE.

<P><LI>Add a CommandButton to the Form.

<P><LI>Add the following code to the Form:
<P>
<P><PRE>      Dim oFormPrb As Object
</PRE><P>
<P><PRE>      Private Sub Command1_Click()
<PRE></PRE>         oFormPrb.showform
      End Sub

      Private Sub Form_Deactivate()
         Beep
      End Sub

      Private Sub Form_Load()
         Set oFormPrb = CreateObject("FormPrb.formclass")
      End Sub

</PRE><P><LI>Run the Form and then click the CommandButton.

<P><LI>Try moving between the two forms. You will notice that the Beep in the
   Form_Deactivate does not fire. However, the title bar of forms changes
   to show which form has the focus.
<P>
</OL><h2>REFERENCES</h2>
 
<P>
For more information, please see the following articles in the Microsoft
Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../vbwin/q170570.htm">Q170570</A></B>
   TITLE     : HOWTO: Build a Windows Message Handler with AddressOf in VB5

   ARTICLE-ID: <B><A href="../vbwin/q168795.htm">Q168795</A></B>
   TITLE     : HOWTO: Hook Into a Window's Messages Using AddressOf
</PRE></OL> 
<PRE>Keywords          : vb5all VBKBAutomation VBKBAX VBKBComp VBKBDLL
Version           : 5.0
Platform          : WINDOWS
Issue type        : kbprb</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  November 26, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
