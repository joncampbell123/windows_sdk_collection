

<HTML>
<HEAD>
<TITLE>PRB: Winsock Control Generates Error 10048 - Address in Use </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q173619">
<META NAME="KBModify" CONTENT="1997/09/09">
<META NAME="KBCreate" CONTENT="1997/09/09">
<META NAME="Keywords" CONTENT="vb5all kberrmsg">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  The Winsock control will get an error after a Connect method is called if the same local port has been used within the past four minutes.  CAUSE =====  The Windows socket control does not have the ability to set the socket option SO_REUSEADDR. This...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAH4,QDL9,QBWQ,QBWO,QBWN,QDJP,QAKG,QAB4,QBS0,QAAP,QDKF,QA7O,QAOE,QAMN,QAB5 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: Winsock Control Generates Error 10048 - Address in Use</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 9, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q173619</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual Basic Enterprise Edition for Windows, version 5.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The Winsock control will get an error after a Connect method is called if
the same local port has been used within the past four minutes.
<P>
<P><h2>CAUSE</h2>
 
<P>
The Windows socket control does not have the ability to set the socket
option SO_REUSEADDR. This option allows the socket to be bound to an
address that is already in use.
<P>
When you close the handle to a socket, some additional negotiation goes on
between the client and the server. The socket will wait for up to two times
the maximum time that windows would wait to receive an acknowledgement from
the other end of the socket that closed the port. By default, this option
is set to two minutes. Therefore, Windows may wait up to four minutes
before the port is actually released.
<P>
This makes that specific port unavailable until it is actually released.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
The only workaround is to not use a specific local port. If you set the
LocalPort property to Zero, Winsock will pick a random local port for you
and use it until a Close method is called on the WinSock Control.
<P>
<P><h2>STATUS</h2>
 
<P>
This behavior is by design.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
Setting the LocalPort property of the socket to Zero, will cause Windows to
pick a random port.
<P>
To do this, place the following code just before the line that does the
connect:
<P>
<PRE>   Winsock1.LocalPort = 0
   Winsock1.Connect

</PRE><h3>Steps to Reproduce Behavior</h3>
 
<P>
The following sample demonstrates how to reproduce the issue and how to
work around it. In the code "myserver" indicates any Windows NT Server
running Simple TCP/IP Services, which includes an Echo server on Port 7.

<OL><P><LI>Start a new project in Visual Basic. Form1 is created by default.

<P><LI>Add the Windows Socket Control to Form1.

<P><LI>Add the following code to the form:
<P>
<P><PRE>      Option Explicit
      Private Sub Form_Load()
<PRE></PRE>        Dim res As Long
        Winsock1.LocalPort = 2500
        Winsock1.RemoteHost = "myserver"
        Winsock1.RemotePort = 7
        Winsock1.Connect
      End Sub

      Private Sub Winsock1_Error(ByVal Number As Integer, _
        Description As String, ByVal Scode As Long, _
        ByVal Source As String, ByVal HelpFile As String, _
        ByVal HelpContext As Long, CancelDisplay As Boolean)

        MsgBox Description, vbOKOnly, "Winsock Error: " &amp; Number
        CancelDisplay = True
      End Sub

</PRE><P><LI>Run the program.

<P><LI>Exit the program.

<P><LI>Run the program again. Note that this causes a dialog box to appear
<P><PRE>    with the error message: Address in use.
</PRE><P>
</OL>To correct the code, change the line:
<P>
<PRE>   Winsock1.LocalPort = 2500

</PRE></OL>to:
<P>
<PRE>   Winsock1.LocalPort = 0

</PRE>and perform steps 4 through 6 several times. You should not get any errors.
 
<PRE>Keywords          : vb5all kberrmsg
Version           : WINDOWS:5.0
Platform          : WINDOWS
Issue type        : kbprb</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 9, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
