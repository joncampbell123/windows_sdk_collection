

<HTML>
<HEAD>
<TITLE>RDO: Hstmt Error with Asynchronous SQL Server Queries </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q143032">
<META NAME="KBModify" CONTENT="1996/06/21">
<META NAME="KBCreate" CONTENT="1996/01/24">
<META NAME="Keywords" CONTENT="kbprg kbusage kbhowto">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  Trying to simultaneously execute a second query on the same rdoConnection that currently has an asynchronous query executing will cause the following error:     S1000: [Microsoft][ODBC SQL Server Driver]Connection is busy with    results for anothe...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QANF,QAI5,QBS0,QANE,QABM,QACF,QBXS,QBGT,QAJQ,QAPN,QBG2,QAB4,QAAP,QATX,QAH4 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>RDO: Hstmt Error with Asynchronous SQL Server Queries</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  June 21, 1996</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q143032</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Enterprise Editions of Microsoft Visual Basic, version 4.0, for
   Windows
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Trying to simultaneously execute a second query on the same rdoConnection
that currently has an asynchronous query executing will cause the following
error:
<P>
<PRE>   S1000: [Microsoft][ODBC SQL Server Driver]Connection is busy with
   results for another hstmt

</PRE><h2>CAUSE</h2>
 
<P>
After you execute an asynchronous query you cannot access the recordset or
execute another asynchronous query on the same rdoConnection until the
StillExecuting property of the recordset is False. This behavior is by
design.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
You need to allow for the asynchronous query to finish before executing
another query on the same rdoConnection or accessing the recordset object.
<P>
You can check to see if the query is finished by checking the
StillExecuting property of the recordset. This can also be resolved by
opening a separate rdoConnection for each query you want to execute
simultaneously.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
Steps to Reproduce Problem in Visual Basic Version 4.0:
<P>
This example uses a "DSN-less" ODBC connection so you will not need to set
up a DSN with the ODBC Admin utility.

<OL><P><LI>Start a new project in Visual Basic. Form1 is created by default.

<P><LI>Add two command buttons to Form1.

<P><LI>Paste the following code into the General Declarations section of form1.
<P>
<PRE>   Private Sub Command1_Click()
     'The following code will cause the error:
     Dim en As rdoEnvironment
     Dim cn As rdoConnection
     Dim rs1 As rdoResultset
     Dim rs2 As rdoResultset
     Dim sql1 As String
     Dim sql2 As String

     'establish connection
     Set en = rdoEngine.rdoEnvironments(0)
     en.CursorDriver = rdUseOdbc
     'this should be modified to connect to your database
     Dim cnStr As String
     cnStr = "driver={SQL Server};server=myserver;" &amp; _
       "database=pubs;uid=myuid;pwd=mypwd"
     Set cn = en.OpenConnection(dsname:="", Prompt:=rdDriverNoPrompt, _
       Connect:=cnStr)

     'create SQL statements that take at least a few seconds to finish
     sql1 = "Select title From Titles"
     Set rs1 = cn.OpenResultset(Name:=sql1, Type:=rdOpenStatic, _
       Option:=rdAsyncEnable)

     sql2 = "Select au_id From Authors"
     ' The next line will cause the error:
     ' "Connection is busy with results for another hstmt"
     Set rs2 = cn.OpenResultset(Name:=sql2, Type:=rdOpenStatic, _
       Option:=rdAsyncEnable)

     While rs1.StillExecuting Or rs2.StillExecuting
       DoEvents
     Wend
     MsgBox "rs1 and rs1 have both completed"
   End Sub


   Private Sub Command2_Click()
     'The following code will not cause the error:
     Dim en As rdoEnvironment
     Dim cn1 As rdoConnection
     Dim cn2 As rdoConnection  'a second connection has been added
     Dim rs1 As rdoResultset
     Dim rs2 As rdoResultset
     Dim sql1 As String
     Dim sql2 As String

     'establish connection
     Set en = rdoEngine.rdoEnvironments(0)
     en.CursorDriver = rdUseOdbc
     'this should be modified to connect to your database
     Dim cnStr As String
     cnStr = "driver={SQL Server};server=myserver;" &amp; _
       "database=pubs;uid=myuid;pwd=mypwd"
     Set cn1 = en.OpenConnection(dsname:="", Prompt:=rdDriverNoPrompt, _
       Connect:=cnStr)
     Set cn2 = en.OpenConnection(dsname:="", Prompt:=rdDriverNoPrompt, _
       Connect:=cnStr)

     'create SQL statements that take at least a few seconds to finish
     sql1 = "Select title From Titles"
     Set rs1 = cn1.OpenResultset(Name:=sql1, Type:=rdOpenStatic, _
       Option:=rdAsyncEnable)

     sql2 = "Select au_id From Authors"
     Set rs2 = cn2.OpenResultset(Name:=sql2, Type:=rdOpenStatic, _
       Option:=rdAsyncEnable)

     While rs1.StillExecuting Or rs2.StillExecuting
       DoEvents
     Wend
     MsgBox "rs1 and rs1 have both completed"
   End Sub

</PRE><P><LI>Note that you will need to change your DRIVER, SERVER, DATABASE, UID,
   and PWD in the OpenConnection method. You will also need to modify the
   SQL statement contained in the Command1_Click event to match your own
   SQL data source.

<P><LI>Clicking on Command1 will cause the error: "Connection is busy with
   results for another hstmt." This is because you are trying to
   simultaneously execute a second query on the same rdoConnection.
   Clicking on Command2 will successfully execute each query simultaneously
   because they are each on a separate rdoConnection.
<P>
</OL><h2>REFERENCES</h2>
 
<P>
<PRE>   (Hitchhiker's Guide to Visual Basic and SQL Server, Microsoft Press.
   ISBN: 1-55615-906-4.).
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 4.0<BR>
KBCategory: kbprg kbusage kbhowto<BR>
KBSubcategory: APrgDataOther PrgCtrlsCus<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  June 21, 1996</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
