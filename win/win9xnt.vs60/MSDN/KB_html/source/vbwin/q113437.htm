

<HTML>
<HEAD>
<TITLE>BUG: SQL Server GetDate() Function Error: Record is Deleted </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q113437">
<META NAME="KBModify" CONTENT="1996/02/18">
<META NAME="KBCreate" CONTENT="1994/04/04">
<META NAME="Keywords" CONTENT="kbprg kbbuglist">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  Error 3167  Record is deleted  can occur as records from the Dynaset are fetched when both of the following conditions are present:   - The Dynaset is opened on a table in a SQL Server database that has    an index based on a field of type date/tim...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBS0,QA5V,QABM,QAH4,QBXT,QAYZ,QAIB,QAB9,QA5F,QAZV,QAY5,QAY2,QAMA,QAKP,QA2Q V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: SQL Server GetDate() Function Error: Record is Deleted</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 18, 1996</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q113437</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:
<P>
- Professional Edition of Microsoft Visual Basic for Windows,
<PRE>  version 3.0
</PRE> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Error 3167 "Record is deleted" can occur as records from the Dynaset are
fetched when both of the following conditions are present:

<UL><LI>The Dynaset is opened on a table in a SQL Server database that has
   an index based on a field of type date/time.

<LI>That indexed date/time field has been populated by the native SQL
   server function GetDate().
<P>
</UL>The records on which the error will occur are not predictable but are
consistent.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
Any one of the following three possible workarounds will work:

<UL><LI>Use a snapshot object instead, or use a Dynaset with the
   DB_SQLPASSTHROUGH option, which is functionally the same thing as
   a snapshot.

<LI>Drop the index before and rebuild it after Visual Basic does the update
   if a non-passthrough Dynaset is needed in order to update the table in
   question.

<LI>Let Visual Basic do the updates to that table using the Now
   function instead of the stored procedure.
<P>
</UL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in Visual Basic version 3.0 for
Windows. We are researching this problem and will post new information here
in the Microsoft Knowledge Base as it becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
If records are added directly by Visual Basic (filling the date/time field
by using the Now function), there is no problem. But if the indexed
date/time field is assigned by the GetDate() function, the error occurs.
<P>
<P><h3>Using GetDate() and a Stored Procedure that May Result in the Problem</h3>
 
<P>
The GetDate() function is an intrinsic function native to Microsoft SQL
Server. The most likely situation is for this to be called from within a
stored procedure, which in turn is called from a Visual Basic program. The
following is the SQL Server syntax used to create a stored procedure that
adds records to a SQL Server table named GetDateBugTab:
<P>
create proc getdatebug
As
declare @dt datetime,
@messagestr varchar(39)
select @dt=GetDate()
select @messagestr = "This record added from stored proc"
insert into GetDateBugTab
(fDateTime, fsourceofdate)
select @dt,@messagestr
<P>
The structure of GetDateBugTab is reported by executing the system
procedure sp_help GetDateBugTab against the SQL Server database.
<P>
Results look somewhat like this:
<P>
<PRE>Name                           Owner                        Type
GetDateBugTab                  dbo                          user table
Column_name   Type             Length Nulls Default_name    Rule_name
</PRE>------------- ---------------- ------ ----- --------------- ---------------
<PRE>fDateTime     datetime         8       1     (null)         (null)
fsourceofdate varchar          39      1     (null)         (null)
index_name    index_description                             index_keys
}ndx          nonclustered, unique located on default       fDateTime

</PRE>The stored procedure would be executed from Visual Basic by using code
such as this:
<P>
Dim db As database
<PRE>' Enter the following two lines as one, single line of code:
</PRE>Set db = OpenDatabase("", 0, 0,
<PRE>   "odbc;uid=sa;pwd=;DSN=sqlserver2;database=playpen2;")
</PRE>label1 = db.ExecuteSQL("getdatebug")
<P>
<P><h3>Filling the Table by Using Visual Basic Directly Causes No Problem</h3>
 
<P>
By contrast, if the table is filled by Visual Basic code, no problem
occurs. For example, the following code works without a problem:
<P>
Dim db As database
<PRE>' Enter the following two lines as one, single line of code:
</PRE>Set db = OpenDatabase("", 0, 0,
<PRE>   "odbc;uid=sa;pwd=;DSN=sqlserver2;database=playpen2;")
</PRE>dt$ = Now
<PRE>' Enter the following two lines as one, single line of code:
</PRE>label1 = db.ExecuteSQL("insert into GetDateBugTab (fDateTime,fsourceofdate)
<PRE>   select '" &amp; dt$ &amp; "', 'This is from VB Now function'")

</PRE><h3>Using SQLPASSTHROUGH Still Causes a Problem</h3>
 
<P>
Alternatively, the entire body of the stored procedure can be sent to the
SQL Server from Visual Basic. This is because the ExecuteSQL uses the
SQLPASSTHROUGH flag and sends the syntax to the SQL Server for processing.
This will still cause the error, however.
<P>
Dim db As database
<PRE>' Enter the following two lines as one, single line of code:
</PRE>Set db = OpenDatabase("", 0, 0,
<PRE>   "odbc;uid=sa;pwd=;DSN=sqlserver2;database=playpen2;")
</PRE>dt$ = Now
<PRE>' Enter the following four lines as one, single line of code:
</PRE>label1 = db.ExecuteSQL("declare @dt datetime, @messagestr varchar(39)select
<PRE>   @dt=GetDate() select @messagestr = "This record added from stored proc"
   insert into GetDateBugTab (fDateTime,fsourceofdate)
   select @dt,@messagestr")

</PRE><h2>REFERENCES</h2>
 
<P>
More information about calling stored procedures is documented in the
following Microsoft SQL manual which covers the Visual Basic Library
for SQL Server: "Microsoft SQL Server Programmer's Reference for Visual
Basic."
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: buglist3.00 3.00 buglist3.00<BR>
KBCategory: kbprg kbbuglist<BR>
KBSubcategory: APrgDataOther<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 18, 1996</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
