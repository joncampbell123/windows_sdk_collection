

<HTML>
<HEAD>
<TITLE>How to Pass a String or String Arrays Between VB and a C DLL </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q118643">
<META NAME="KBModify" CONTENT="1997/10/10">
<META NAME="KBCreate" CONTENT="1994/07/26">
<META NAME="Keywords" CONTENT="">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  This article demonstrates techniques to perform the following tasks between Visual Basic and a C DLL:   - Pass a string to a C DLL.   - Pass (and modify) an array of strings to a C DLL.   - Return a string from a function within a C DLL.  Each of t...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBS0,QATX,QBFY,QAD7,QAH7,QAH6,QAY5,QAUD,QABB,QAB9,QAH4,QBV8,QA3P,QABA,QAY2 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>How to Pass a String or String Arrays Between VB and a C DLL</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  October 10, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q118643</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
3.00
WINDOWS
kbprg kbcode
<P>
 
The information in this article applies to:

<UL><LI>Professional Edition of Microsoft Visual Basic Programming System
   for Windows, version 3.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
This article demonstrates techniques to perform the following tasks between
Visual Basic and a C DLL:

<UL><LI>Pass a string to a C DLL.

<LI>Pass (and modify) an array of strings to a C DLL.

<LI>Return a string from a function within a C DLL.
<P>
</UL>Each of these techniques demonstrates slightly different way of handling
strings within a DLL, and the last two require the Control Development Kit,
which comes with Visual Basic version 3.0, Professional Edition.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
There are two parts to each technique demonstrated: the declaration within
your Visual Basic code for the C function, and the internals of the C
function that process the data being passed, modified, or sent back.
<P>
<P><h3>Pass a String to a C DLL</h3>
 
<P>
The declaration for the C function must use ByVal for C to receive a
string. C functions typically expect strings to end in a "null character"
(binary zero). When you declare the function argument using ByVal, this
tells Visual Basic to pass the string as a null-terminated string. Thus,
the declaration looks like this:
<P>
<PRE>   Declare Sub passOneString Lib "mydll.dll" (ByVal lpszBuf As String)

</PRE>The actual C function looks like this:
<P>
<PRE>   void __far __pascal __export passOneString(char __far *lpszBuf)

</PRE>The actual internals of the C function are straightforward while it
receives the argument as a standard C string.
<P>
NOTE: Both "far" and "pascal" are compiler-specific keywords that are
allowed by the ANSI standard. They should have the appropriate number of
underscores to put them in the appropriate name space. The latest compilers
strictly follow the standard and say that you need two underscores (but
will allow fewer for backward compatibility). Some previous Microsoft
compilers only allowed 0 or 1 underscores.
<P>
<P><h3>Pass (and Modify) an Array of Strings to a C DLL</h3>
 
<P>
The declaration for the function demonstrating this technique does not use
ByVal. Because an array is being passed, the declaration needs to pass the
array of strings to the function using the internal Visual Basic array
descriptor (HAD). Thus, the declaration looks like this:
<P>
<PRE>   Declare Sub passStrings Lib "mydll.dll" (theArray() As String,
                   ByVal nIndex% )

</PRE>The actual C function looks like this:
<P>
<PRE>   void __far __pascal __export passStrings(HAD had, int nIndex)

</PRE>The function VBArrayElement() is used to extract a Visual Basic string
handle (HLSTR) from the array (using the index into the array specified by
nIndex). Then VBGetHlstr() converts that string handle into a standard C
string. If you want, and if the buffer used to receive the string is large
enough for the changes, then you can modify that C string as you like.
However, the modified string needs to be stored in the original Visual
Basic string handle. This is done through the VBSetHlstr() function.
<P>
<P><h3>Return a String from a Function Within a C DLL</h3>
 
<P>
For a Visual Basic routine to receive a string from a function, that
function must be declared to return a string and, within the C side, to
return a variable of type HLSTR. Thus, the declaration looks like this:
<P>
<PRE>   Declare Function returnAString Lib "mydll.dll" () As String

</PRE>The actual C function looks like this:
<P>
<PRE>   hlstr __far __pascal __export returnAString()

</PRE>This time, the VBCreateTempHlstr is used to transform a given standard C
string into a Visual Basic string handle. Then the function simply returns
that handle, which Visual Basic receives as a string.
<P>
Additionally, the VBRuntimeError function is used to generate a Visual
Basic run-time error. If an error condition exists after calling
VBCreateTempHlstr, VBRuntimeError sets a Visual Basic error code and then
exits the function. For this reason, this function should only be used in a
routine that is called directly by Visual Basic, not in the control
procedure of a custom control or other location where Windows itself
invokes the code.
<P>
<P><h3>Step-by-Step Example to Create the DLL</h3>
 
<P>
Here are the steps necessary to build a DLL using Visual C++:

<OL><P><LI>Start Visual C++.

<P><LI>Create a new project by choosing New from the Project menu. Select the
   following options:
<P>
<P><PRE>    - Set the Project Type to "Windows dynamic-link library (.DLL)".
</PRE><P>
<P><PRE>    - Clear the "Use Microsoft Foundation Classes" check box.
</PRE>
<P><LI>Create a new file, add the following text and save it as "MYDLL.DEF":
<P>
<PRE>   LIBRARY        MYDLL
   DESCRIPTION    "String Manipulation DLL"
   EXETYPE        WINDOWS 3.1
   CODE           PRELOAD MOVEABLE DISCARDABLE
   DATA           PRELOAD MOVEABLE SINGLE
   HEAPSIZE       4096
   EXPORTS
            passOneString  @1
            passStrings    @2
            returnAString  @3

</PRE><P><LI>Create a new file, add the following code, and save it as "MYDLL.C":
<P>
<PRE>   #include &lt;windows.h&gt;
   #include &lt;string.h&gt;
   #include &lt;stdio.h&gt;
   #include "vbapi.h"

   #define USHORT unsigned short

   //-------------------------------------------------------------------
   // Global Variables
   //-------------------------------------------------------------------
   HANDLE hmodDLL;

   //-------------------------------------------------------------------
   // Receive a single string in functions argument list:
   // display string to user
   //-------------------------------------------------------------------
   void __far __pascal __export passOneString(LPSTR lpszBuf)
   {
      // Display old string to user.
      MessageBox( NULL, lpszBuf, "Inside DLL...  (unmodified)", 0 );
   }

   //-------------------------------------------------------------------
   // Receive/modify array of strings in functions argument list:
   // - Retrieve a specified element in an array of strings.
   // - Transform that element into a standard C string.
   // - Modify that standard C string.
   // - Save the modified string back into the original element of the
   //   array.
   //-------------------------------------------------------------------
   void __far __pascal __export passStrings(HAD had, int nIndex)
   {
      HLSTR       hlstr;               // Reference to VB string
      int         idx[1];              // Array in one dimension
      char        lpszBuf[255];        // "Std C" string buffer
      USHORT      cbCount;             // # of characters in string

      // Retrieve a specified element (nIndex) in an array of strings.
      idx[0] = nIndex;
      hlstr = VBArrayElement(had, 1, (LPINT)idx);

      // Transform that element into a standard C string.
      cbCount = VBGetHlstr( hlstr, lpszBuf, sizeof( lpszBuf ) - 1 );

      // Display old string to user.
      MessageBox( NULL, lpszBuf, "Inside DLL...  (unmodified)", 0 );

      // Modify that standard C string.
      wsprintf(lpszBuf, "%s &lt;-- size = %d", lpszBuf, lstrlen(lpszBuf));

      // Save the modified string in the original element of the array.
      VBSetHlstr( &amp;hlstr, lpszBuf, lstrlen( lpszBuf ) );
   }

   //-------------------------------------------------------------------
   // Return a string from a function back to a Visual Basic program:
   // - Create Hlstr from standard C string.
   // - Report error (if any).
   // - Return Hlstr to calling VB function.
   //-------------------------------------------------------------------
   HLSTR __far __pascal __export returnAString()
   {
       HLSTR temp;
       char *buff = {"This function returns a string from a DLL."};

      // Creates Hlstr from standard C string.
       temp = VBCreateTempHlstr(buff, lstrlen(buff));

      // Report error (if any).
      if (HIWORD(temp) == -1)
         VBRuntimeError(LOWORD(temp));

      // Return Hlstr to calling VB function.
      return temp;
   }

   //-------------------------------------------------------------------
   // Initialize library.
   // This routine is called from the DLL entry point in LIBINIT.ASM,
   // which is called when the first client loads the DLL.
   //-------------------------------------------------------------------
   BOOL FAR PASCAL LibMain(HANDLE hmod, HANDLE segDS, USHORT cbHeapSize)
   {
       // Avoid warnings on unused (but required) formal parameters.
       cbHeapSize = cbHeapSize;
       segDS = segDS;

       hmodDLL = hmod;

       // Leave the DS unlocked when not running.
       // Required only under Windows version 3.1
       // Win32 does not require or support UnlockData()
       UnlockData( 0 );

       return TRUE;
   }

   //-------------------------------------------------------------------
   // Handle exit notification from Windows.
   // This routine is called by Windows when the library is freed
   // by its last client.
   //-------------------------------------------------------------------
   VOID __far __pascal __export WEP (BOOL fSystemExit)
   {
       // Avoid warnings on unused (but required) formal parameters.
       fSystemExit = fSystemExit;
   }

</PRE><P><LI>From the Project menu, choose the Build MYDLL.DLL option.

<P><LI>Add the MYDLL.DEF, MYDLL.C, and \VB\CDK\VBAPI.LIB files to the project.
   This assumes you have installed Visual Basic in the \VB directory.
   Otherwise, modify this last entry to the correct path.
<P>
</OL><h3>Step-by-Step Example to Create Visual Basic Application to Use DLL</h3>
 

<OL><P><LI>Start a new project in Visual Basic. Form1 is created by default.

<P><LI>Place three command buttons (Command1, Command2, and Command3) on Form1.

<P><LI>Using the following table as a guide, set the properties of the
   controls added in step 2.
<P>
<PRE>   Control name   Property   New value
   ---------------------------------------------
   Command1       Caption    &amp;Pass a String
   Command2       Caption    Pass &amp;And Modify Array
   Command3       Caption    &amp;Receive a String

</PRE><P><LI>Add the following code to the (general) (declarations) section of Form1:
<P>
<PRE>   ' Enter each of the following Declare statements as one, single line:
   Declare Sub passOneString Lib "mydll.dll" (ByVal lpszBuf As String)
   Declare Sub passStrings Lib "mydll.dll" (theArray() As String,
      ByVal nIndex%)
   Declare Function returnAString Lib "mydll.dll" () As String

</PRE><P><LI>Place the following code in the Command1 Click event procedure:
<P>
<PRE>   Sub Command1_Click ()
      Dim MyStr As String * 80
      Dim My2ndStr$

      MyStr = "Hello World (First String)"
      My2ndStr$ = "Hello World Again (Second String)"

      Call passOneString(MyStr)
      Call passOneString(My2ndStr$)
   End Sub

   NOTE: This demonstrates that either method of defining a string works
   equally well.

</PRE><P><LI>Place the following code in the Command2 Click event procedure:
<P>
<PRE>   Sub Command2_Click ()
      Dim i%
      ReDim array(0 To 2) As String

      array(0) = "Short"
      array(1) = "Medium Medium"
      array(2) = "Long Longer Longest"

      For i% = 0 To 2
         Call passStrings(array(), i%)
         MsgBox array(i%), 0, "Inside VB...  (modified)"
      Next i%
   End Sub

</PRE><P><LI>Place the following code in the Command3 Click event procedure:
<P>
<PRE>   Sub Command3_Click ()
      Dim MyStr$

      MyStr$ = returnAString()

      MsgBox MyStr$, 0, "Returned from DLL..."
   End Sub

</PRE><P><LI>Choose Start from the Run menu to run the program.
<P>
</OL><h2>REFERENCES</h2>
 

<UL><LI>Visual Basic for Windows, version 3.0 "Programmer’s Guide," pp. 563-566.

<LI>Visual Basic for Windows, version 3.0 "Professional Features Book 1:
   Control Development Guide," pp. 69-71.

<LI>Knowledge Base article <B><A href="../vbapps/q106553.htm">Q106553</A></B>, "How to Write C DLLs and Call Them from
   Visual Basic."
<P></UL>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 3.00 DLL Strings HLSTR<BR>
KBCategory: kbprg kbcode<BR>
KBSubCategory: APrgOther<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  October 10, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
