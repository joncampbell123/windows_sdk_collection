

<HTML>
<HEAD>
<TITLE>BUG: Unloading a Form After Assigning Text Property Causes GPF </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q150184">
<META NAME="KBModify" CONTENT="1996/10/08">
<META NAME="KBCreate" CONTENT="1996/04/23">
<META NAME="Keywords" CONTENT="kbprg kbbuglist">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  If the Text property of a Text box is set equal to the Text property of a Text box on a separate modal form, and if that statement is followed by unloading the modal form, a General Protection Fault results.  STATUS ======  Microsoft has confirmed ...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBT6,QBV4,QBS0,QAHP,QAPN,QAJ6,QAH4,QATX,QAMB,QALZ,QAB4,QAFF,QDKW,QAB9,QA4Q V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Unloading a Form After Assigning Text Property Causes GPF</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  October 8, 1996</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q150184</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Standard, Professional, and Enterprise Editions of Microsoft
   Visual Basic, 16-bit and 32-bit, for Windows, version 4.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
If the Text property of a Text box is set equal to the Text property of a
Text box on a separate modal form, and if that statement is followed by
unloading the modal form, a General Protection Fault results.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be an issue in the Microsoft products
listed at the beginning of this article. Microsoft is researching this
issue and will post new information here in the Microsoft Knowledge Base
as it becomes available.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
Rather than use the Unload statement to unload the modal dialog box, use
the PostMessage API function. The declaration for PostMessage is:
<P>
<PRE>   #If Win32 Then

   Private Declare Function PostMessage Lib "user32" Alias _
   "PostMessageA"(ByVal hWnd As Long, ByVal wMsg As Long, _
   ByVal wParam As Long, ByVal lParam As Long) As Long

   #Else

   Private Declare Function PostMessage Lib "User" (ByVal hWnd As Integer,
   ByVal wMsg As Integer, ByVal wParam As Integer, lParam As Any) As
   Integer

   #End If

</PRE>To post a close message for a form, set the first parameter to the hWnd of
the target form, and the other three parameters as specified below:
<P>
<PRE>   Const NILL = 0&amp;

   Const WM_SYSCOMMAND = &amp;H112

   Const SC_CLOSE = &amp;HF060

</PRE>so the following statement closes down Form2:
<P>
<PRE>   PostMessage Form2.hWnd, WM_SYSCOMMAND, SC_CLOSE, NILL

</PRE><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Steps To Reproduce Problem</h3>
 

<OL><P><LI>Start a new project in Visual Basic. Form1 is created by default. Add a
   Text box to Form1. In the Click event for Form1, place the following
   code:
<P>
<PRE>   Private Sub Form_Click()
     Form2.Show 1
   End Sub

</PRE><P><LI>From the Insert menu, select Form to add another form to the project.
   On Form2, place a Text box. Add the following code to Form2:
<P>
<PRE>   Private Sub Text1_DblClick()
     Form1.Text1 = Text1
     Unload Me
   End Sub

</PRE><P><LI>Run the project by pressing F5. Click on Form1 to show Form2 modally.
   Double-click on the text box in Form2, and a General Protection Fault
   occurs.
<P>
</OL>In one test on Windows NT 3.51, with the 32-Bit Edition of Visual Basic,
the error message was:
<P>
<PRE>   The instruction at "0x00428646" referenced memory at "0x00d10cd8". The
   memory could not be "read".

</PRE></OL>In another test with, the 16-Bit Edition of Visual Basic, the error message
was:
<P>
<PRE>   VB caused a General Protection Fault in module VB.EXE at 0016:2BFB.

</PRE>To work around the problem, place the declaration given in the Workaround
Section above in the General Declarations section of Form2, and change the
code in the DblClick event of the Text box on Form2 to:
<P>
<PRE>   Private Sub Text1_DblClick()

   Const NILL = 0&amp;

   Const WM_SYSCOMMAND = &amp;H112

   Const SC_CLOSE = &amp;HF060

   Form1.Text1.Text = Text1.Text

   PostMessage Form2.hWnd, WM_SYSCOMMAND, SC_CLOSE, NILL

   End Sub
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 4.00 vb4win vb4all<BR>
KBCategory: kbprg kbbuglist<BR>
KBSubcategory: PrgOther<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  October 8, 1996</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
