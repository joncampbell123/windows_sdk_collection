

<HTML>
<HEAD>
<TITLE>BUG: TreeView: Nodes Count Property Limited to 32767 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q182231">
<META NAME="KBModify" CONTENT="1998/03/10">
<META NAME="KBCreate" CONTENT="1998/03/09">
<META NAME="Keywords" CONTENT="VB4ALL VB4WIN vb5all VBKBAX VBKBComp VBKBCtrl kberrmsg">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  The Count property of the Nodes collection for a TreeView control returns an incorrect value if you add more than 32767 nodes to the TreeView. The Index property of a Node object also returns an incorrect value for the same reason. If you add more ...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Security" CONTENT="PUBLIC ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBJQ,QAPN,QBS0,QAG8,QA01,QAUD,QA7O,QA28,QATJ,QAOE,QAMN,QAAP,QAB5,QAX6,QAKD V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: TreeView: Nodes Count Property Limited to 32767</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 10, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q182231</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual Basic Learning, Professional, and Enterprise Editions
   for Windows, version 5.0
<LI>Microsoft Visual Basic Professional and Enterprise Editions for
   Windows, version 4.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The Count property of the Nodes collection for a TreeView control returns
an incorrect value if you add more than 32767 nodes to the TreeView. The
Index property of a Node object also returns an incorrect value for the
same reason. If you add more than 65535 nodes, the TreeView's scrollbar may
disappear and the TreeView may experience redraw problems.
<P>
NOTE: In Visual Basic 4.0, you may receive the following error if you
attempt to add more than 32767 nodes to a TreeView control:
<P>
<PRE>   Run-time error '7':
   Out of memory

</PRE><h2>CAUSE</h2>
 
<P>
The Count property of the Nodes collection and the Index property of a Node
object are limited to Integer values. If you add an additional node beyond
32767 nodes, the Count property of the Nodes collection returns a value of
-32768 (instead of 32768). Adding another node to the TreeView results in
the Count property returning a value of -32767, and so on. After adding
65536 nodes, the Count property reverts back to a value of 0. When this
occurs, the TreeView control appears empty with no scrollbars because it
thinks there are no actual nodes to display.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
It is not recommended that you add more than 32767 nodes to a TreeView
control. If you need more than 32767 nodes, you should consider using
multiple TreeView controls or a control more suited for larger amounts of
data.
<P>
If you would like to maintain more than 32767 nodes using Visual Basic
versions after version 4.0 in a TreeView control, you should keep the
following in mind:
<P>
- Performance will become extremely slow as you add more and more nodes.
<P>
- Do not add more than 65535 nodes.
<P>
- Use the SendMessage API to obtain the true node count. Alternately, you
<PRE>  can use a module- or public-level variable to keep track of how many
  nodes are in the TreeView. Each time you add or remove a node, increment
  or decrement the variable by one. This is necessary if you need to
  determine the count of nodes because the Count property of the Nodes
  collection will not return the correct value.

</PRE>- Don't rely on the Index property of a node object. For example, the Index
<PRE>  property is 32767 for node 32767 but is -32768 for node 32768.

</PRE>- You can still refer to a node by using its Key or by passing a number to
<PRE>  the Nodes collection. For example:

     TreeView1.Nodes(40000) refers to node 40000.

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products
listed at the beginning of this article. We are researching this
bug and will post new information here in the Microsoft Knowledge
Base as it becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Steps to Reproduce Behavior</h3>
 

<OL><P><LI>Create a new Standard EXE project in Visual Basic. Form1 is created
   by default.

<P><LI>Click Components on the Project menu and select "Microsoft Windows
   Common Controls."

<P><LI>Add a TreeView, CommandButton, and a TextBox to Form1.

<P><LI>Copy and paste the following code to the code window of Form1:
<P>
<P><PRE>      Option Explicit
</PRE><P>
<P><PRE>      Private Const TVM_GETCOUNT = &amp;H1105&amp;
      Private Declare Function SendMessage Lib "user32" Alias
<PRE></PRE>        "SendMessageA" (ByVal hwnd As Long, ByVal wMsg As Long, ByVal _
        wParam As Long, lParam As Any) As Long

      Private Sub Command1_Click()
         Dim lngCnt As Long
         Dim nodX As Node
         Set nodX = TreeView1.Nodes.Add(, , "R", "Root")
         For lngCnt = 1 To 32766
            Set nodX = TreeView1.Nodes.Add("R", tvwChild, "C" &amp; lngCnt, _
               "Child " &amp; lngCnt)
            If lngCnt Mod 1000 = 0 Then 'refresh
                Text1.Text = lngCnt
                DoEvents
            End If
         Next
         Text1.Text = TreeView1.Nodes.Count
         MsgBox "Nodes count: " &amp; TreeView1.Nodes.Count
         Set nodX = TreeView1.Nodes.Add("R", tvwChild, "C" &amp; lngCnt, _
            "Child " &amp; lngCnt)
         MsgBox "Nodes count: " &amp; TreeView1.Nodes.Count
         MsgBox "Actual Node Count: " &amp; SendMessage(TreeView1.hwnd, _
                TVM_GETCOUNT, 0, ByVal 0)
      End Sub

</PRE><P><LI>Press the F5 key to start the project.
</OL>6. Click the CommandButton to add nodes to the TreeView. It will take
<PRE>   several minutes to complete on a Pentium class computer.

   Result: After 32767 nodes are added to the TreeView (1 for the Root +
   32766 child nodes), you receive a message box indicating 32767 nodes in
   the TreeView. This is correct. However, the second message box
   incorrectly states there are -32768 nodes after one more node is added
   to the TreeView. The third message box displays the correct node count.
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: scroll bar maximum limitation<BR>
Keywords          : VB4ALL VB4WIN vb5all VBKBAX VBKBComp VBKBCtrl kberrmsg<BR>
Version           : WINDOWS:4.0,5.0<BR>
Platform          : WINDOWS<BR>
Issue type        : kbbug<BR>
Solution Type     : kbpending<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 10, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
