

<HTML>
<HEAD>
<TITLE>PRB:Rate Function Gives Error If It Can't Calculate Accurately </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q138536">
<META NAME="KBModify" CONTENT="1996/05/16">
<META NAME="KBCreate" CONTENT="1995/10/23">
<META NAME="Keywords" CONTENT="kbprg kbprb kbcode">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  If the Rate function is unable to converge to within 0.00001 percent of the correct value after 20 iterations, a trappable error will occur.  In Visual Basic Version 3.0, the error is  Illegal Function Call,  and is error number 5.  In Visual Basic...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAKD,QBS0,QAAP,QAB4,QALA,QAK9,QAY5,QAEN,QAG1,QAH4,QA3U,QAGI,QBXJ,QAKC,QAB9 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB:Rate Function Gives Error If It Can't Calculate Accurately</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 16, 1996</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q138536</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Standard, Professional, and Enterprise Editions of Microsoft
   Visual Basic, 16-bit and 32-bit, for Windows, version 4.0
<LI>Standard and Professional Editions of Microsoft Visual Basic for
   Windows, version 3.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
If the Rate function is unable to converge to within 0.00001 percent of the
correct value after 20 iterations, a trappable error will occur.
<P>
In Visual Basic Version 3.0, the error is "Illegal Function Call," and is
error number 5.
<P>
In Visual Basic Version 4.0, the error is "Invalid procedure call," and is
also error number 5.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
If the error occurs, retry the Rate function with a different initial guess
value. Sometimes a different guess will lead to numerical convergence
within the 20 iterations allowed.
<P>
You might want to set up an error handler that progressively changes the
guess and retries the Rate function. If the Rate function continues to fail
for all the guess values tried, then it may be necessary to warn the user
that an accurate calculation of the rate based on the values for Total
Payment, Number of Payments, and Present Value is not possible.
<P>
The following code implements an error handler to arrive at a Rate value.
<P>
Add the following code to the Form_Click event to include the error
handler, and a new static variable Newguess, which is adjusted each time an
error handler is called:
<P>
<PRE>   Private Sub Form_Click
   Dim Fmt As Variant, FVal As Variant, Guess As Variant, PVal As Variant,_
   TotPmts As Variant, Payment As Variant, PayType As Variant, _
   APR As Variant

   Static NewGuess
   NewGuess = 0.02

   Const ENDPERIOD = 0, BEGINPERIOD = 1    ' When payments are made.
   Const MB_YESNO = 4  ' Define Yes/No buttons.
   Const ID_NO = 7 ' Define No as a response.

   On Error GoTo Errhandler

   Fmt = "##0.00"  ' Define percentage format.
   FVal = 0    ' Usually 0 for a loan.
   Guess = 0.1 ' Guess of 10 percent.
   PVal = 81709.07    '
   Payment = 720.45
   TotPmts = 700
   PayType = BEGINPERIOD
   APR = (Rate(TotPmts, -Payment, PVal, FVal, PayType, Guess) * 12) * 100
   MsgBox "Your interest rate is " &amp; Format(CInt(APR), Fmt) &amp; "percent."

   Exit Sub

</PRE>Errhandler:
<P>
<PRE>   NewGuess = NewGuess + 0.01

   If (NewGuess &gt; 1#) Then
     MsgBox "Calculation of rate not possible-please change Total payments"
     Exit Sub
   End If

   Guess = NewGuess
   Resume

   End Sub

</PRE><h2>STATUS</h2>
 
<P>
This behavior is by design.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Steps to Reproduce Behavior in Visual Basic 4.0</h3>
 

<OL><P><LI>Start a new project. Form1 is created by default.

<P><LI>In the Click event for the form, place the following code:
<P>
   Dim Fmt As Variant, FVal As Variant, Guess As Variant, PVal As Variant,_
   TotPmts As Variant, Payment As Variant, PayType As Variant, _
   APR As Variant
<PRE>   Const ENDPERIOD = 0, BEGINPERIOD = 1    ' When payments are made.
   Const MB_YESNO = 4  ' Define Yes/No buttons.
   Const ID_NO = 7 ' Define No as a response.

   Fmt = "##0.00"  ' Define percentage format.
   FVal = 0    ' Usually 0 for a loan.
   Guess = 0.1 ' Guess of 10 percent.
   PVal = 81709.07    '
   Payment = 720.45
   TotPmts = 700
   PayType = BEGINPERIOD
   APR = (Rate(TotPmts, -Payment, PVal, FVal, PayType, Guess) * 12) * 100
   MsgBox "Your interest rate is " &amp; Format(CInt(APR), Fmt) &amp; "percent."

</PRE><P><LI>Run the program by pressing the F5 key. A run-time error occurs when the
   code calls the Rate function.
<P></OL>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 3.00 4.00 vb4win vb4all<BR>
KBCategory: kbprg kbprb kbcode<BR>
KBSubcategory: PrgOther
<P>


</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 16, 1996</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
