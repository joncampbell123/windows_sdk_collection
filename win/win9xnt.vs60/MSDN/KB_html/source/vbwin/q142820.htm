

<HTML>
<HEAD>
<TITLE>HOWTO: Terminate Windows from a Visual Basic Application </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q142820">
<META NAME="KBModify" CONTENT="1997/10/13">
<META NAME="KBCreate" CONTENT="1996/01/21">
<META NAME="Keywords" CONTENT="APrgOther APrgWindow vb416 VB4WIN kbui">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  The Microsoft Visual Basic for Windows SendKeys function cannot be used to close the Microsoft Windows Program Manager in order to terminate Microsoft Windows. To correctly close Program Manager, you must invoke the ExitWindows API function, as sho...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWO,QBS0,QDL9,QBWN,QAH4,QBWQ,QAGB,QAB9,QAY5,QAJH,QAGU,QBV8,QAIJ,QAH5,QBWS V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>HOWTO: Terminate Windows from a Visual Basic Application</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  October 13, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q142820</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Professional and Enterprise Editions of Microsoft Visual Basic,
   16-bit only, for Windows, version 4.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
The Microsoft Visual Basic for Windows SendKeys function cannot be used to
close the Microsoft Windows Program Manager in order to terminate Microsoft
Windows. To correctly close Program Manager, you must invoke the
ExitWindows API function, as shown below.
<P>
Many software setup or installation programs are designed to exit Windows,
and then restart Windows when the setup or installation is complete. You
can make a Visual Basic program automatically exit Windows and then restart
Windows by passing the EW_RESTARTWINDOWS value to the ExitWindows API
function. The value for the EW_RESTARTWINDOWS constant is &amp;H42.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
You may want to terminate the current Windows session by closing the
Program Manager from within a Visual Basic application. You may think that
you can activate the Program Manager control menu and send the appropriate
key sequences using the Visual Basic SendKeys function. However, this
method does not work because after the Close menu item is chosen, a system
modal dialog box is opened that prompts you to save changes to Program
Manager. A system modal dialog box locks out ALL other programs until it is
satisfied. Therefore, the keystroke you send by using the SendKeys function
never arrives in the dialog box.
<P>
To correctly close Program Manager, you must use the ExitWindows API
function. You can declare this API function in a code module name Module1.
<P>
<P><h3>Step-by-Step Example</h3>
 

<OL><P><LI>Start a new project in Visual Basic.

<P><LI>Draw a Command button on the form.

<P><LI>Add the following as a single line to Module1:
<P>
<PRE>   ' Use for Windows 3.11 or Windows for Workgroups 3.11 applications:
      Declare Function ExitWindows Lib "user" (ByVal wReturnCode as Long, _
         ByVal dwReserved as Integer) as Integer

   ' Use for Windows 95 or Windows NT applications:
      Declare Function ExitWindows Lib "user32" alias "ExitWindowsEx" _
         (ByVal wReturnCode as Long, ByVal dwReserved as Long) as Long

</PRE><P><LI>Add the following line of code to the command button's Click procedure:
<P>
<PRE>   ' Use for Windows 3.11 or Windows for Workgroups 3.11 applications:
      RetVal% = ExitWindows(0,0)

   ' Use for Windows 95 or Windows NT Applications:
      RetVal&amp; = ExitWindows(0&amp;, 0&amp;)

</PRE><P><LI>Run the program.

<P><LI>Click the Command button.
<P>
</OL>The ExitWindows API call initiates the standard Windows shutdown procedure.
If all applications agree to terminate, the windows session is terminated
and control returns to MS-DOS. If the ExitWindows API call fails due to an
open MS-DOS session or for some other reason, FALSE is returned. You should
check for this return value and handle it appropriately.
<P>
<P><h3>Steps to Reproduce Behavior</h3>
 

<OL><P><LI>Start a new Project in Visual Basic.

<P><LI>Draw a Command button on the form.

<P><LI>In the Command button Click event procedure, add this code:
<P>
   AppActivate("Program Manager")
   SendKeys "%{ }{DOWN 5}{ENTER 2}", 0  'ALT, SPACE, DOWN 5, ENTER 2

<P><LI>Run the program.
<P>
</OL>The Program Manager does not close. If you choose the OK button with the
mouse, a message is displayed stating, "Can't quit at this time." If you
choose the Cancel button, a message is displayed stating, "Cannot start
more than one copy of the specified program." These messages are
misleading, but are the result of attempting an unsupported action.
 
<PRE>Keywords          : APrgOther APrgWindow vb416 VB4WIN kbui
Version           : WINDOWS:4.0
Platform          : WINDOWS
Issue type        : kbhowto</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  October 13, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
