

<HTML>
<HEAD>
<TITLE>HOWTO: Retrieve Language and Code Page id Using VerQueryValue </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q160042">
<META NAME="KBModify" CONTENT="1997/07/15">
<META NAME="KBCreate" CONTENT="1996/11/27">
<META NAME="Keywords" CONTENT="APrgWindow vb432 VB4WIN kbhowto">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  Using the VerQueryValue API, the language identifier and the character set identifier can be retrieved from the version-information resource within a file. You can concatenate these two identifiers to form a hexadecimal string and pass the string t...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAWP,QATX,QACJ,QANF,QBS0,QAH4,QAML,QBWI,QAFF,QAI4,QA4H,QA4F,QA2P,QAY5,QARM V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>HOWTO: Retrieve Language and Code Page id Using VerQueryValue</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 15, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q160042</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
4.00
WINDOWS | WINDOWS NT
kbusage kbhowto
<P>
 
The information in this article applies to:

<UL><LI>Standard, Professional, and Enterprise Editions of Microsoft
   Visual Basic, 32-bit only for Windows,, version 4.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
Using the VerQueryValue API, the language identifier and the character set
identifier can be retrieved from the version-information resource within a
file. You can concatenate these two identifiers to form a hexadecimal
string and pass the string to another VerQueryValue call to retrieve the
following version information: CompanyName, FileDescription, FileVersion,
InternalName, LegalCopyright, OriginalFileName, ProductName, and
ProductVersion.
<P>
This article presents a Visual Basic 4.0 32-bit sample application that
retrieves the language identifier, the character set identifier, and
the information mentioned above for the Windows system file, gdi32.dll.
<P>
This article also supplements the following Microsoft Knowledge Base
article that extracts a VS_FIXEDFILEINFO structure from a file's version-
information resource:
<P>
<PRE>   ARTICLE-ID: <B><A href="../vbwin/q139491.htm">Q139491</A></B>
   TITLE     : How To Use Functions in VERSION.DLL - A 32-bit Sample App

</PRE><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Step-by-Step Example</h3>
 

<OL><P><LI>Start Visual Basic. If it is already running, choose New Project from
   the File menu. Form1 is created by default.

<P><LI>Add a CommandButton, Command1, to Form1.

<P><LI>Add a ListBox, List1, to Form1.

<P><LI>Add a module, Module1, to the project. Copy and paste the following
   code to Module1:
<P>
<PRE>Declare Function GetFileVersionInfo Lib "Version.dll" Alias _
   "GetFileVersionInfoA" (ByVal lptstrFilename As String, ByVal _
   dwhandle As Long, ByVal dwlen As Long, lpData As Any) As Long
Declare Function GetFileVersionInfoSize Lib "Version.dll" Alias _
   "GetFileVersionInfoSizeA" (ByVal lptstrFilename As String, _
   lpdwHandle As Long) As Long
Declare Function VerQueryValue Lib "Version.dll" Alias _
   "VerQueryValueA" (pBlock As Any, ByVal lpSubBlock As String, _
   lplpBuffer As Any, puLen As Long) As Long
Declare Function GetSystemDirectory Lib "kernel32" Alias _
   "GetSystemDirectoryA" (ByVal Path As String, ByVal cbBytes As _
   Long) As Long
Declare Sub MoveMemory Lib "kernel32" Alias "RtlMoveMemory" ( _
    dest As Any, ByVal Source As Long, ByVal Length As Long)
Declare Function lstrcpy Lib "kernel32" Alias "lstrcpyA" ( _
    ByVal lpString1 As String, ByVal lpString2 As Long) As Long

</PRE><P><LI>Copy and paste the following code to the code window of Form1:
<P>
</OL>Option Explicit
<P>
<PRE>Private Sub Command1_Click()
   Dim Buffer As String
   Dim rc As Long
   Dim FullFileName As String
   '*** We will check the FileDescription of the gdi32.dll****
   Buffer = String(255, 0)
   rc = GetSystemDirectory(Buffer, Len(Buffer))
   Buffer = LCase$(Mid$(Buffer, 1, InStr(Buffer, Chr(0)) - 1))
   FullFileName = Buffer &amp; "\gdi32.dll"

   Dim lBufferLen As Long, lDummy As Long
   '*** Get size ****
   lBufferLen = GetFileVersionInfoSize(FullFileName, lDummy)
   If lBufferLen &lt; 1 Then
      MsgBox "No Version Info available!"
      Exit Sub
   End If

   Dim sBuffer()  As Byte
   ReDim sBuffer(lBufferLen)
   rc = GetFileVersionInfo(FullFileName, 0&amp;, lBufferLen, _
        sBuffer(0))
   If rc = 0 Then
      MsgBox "GetFileVersionInfo failed."
      Exit Sub
   End If

   Dim lVerPointer As Long

   rc = VerQueryValue(sBuffer(0), "\VarFileInfo\Translation", _
        lVerPointer, lBufferLen)
   If rc = 0 Then
      MsgBox "VerQueryValue failed."
      Exit Sub
   End If
   'lVerPointer is a pointer to four 4 bytes of Hex number,
   'first two bytes are language id, and last two bytes are code
   'page. However, Lang_Charset_String needs a  string of
   '4 hex digits, the first two characters correspond to the
   'language id and last two the last two character correspond
   'to the code page id.

   Dim bytebuffer(255) As Byte
   MoveMemory bytebuffer(0), lVerPointer, lBufferLen
   Dim Lang_Charset_String As String
   Dim HexNumber As Long

    HexNumber = bytebuffer(2) + bytebuffer(3) * &amp;H100 + _
        bytebuffer(0) * &amp;H10000 + bytebuffer(1) * &amp;H1000000
    Lang_Charset_String = Hex(HexNumber)
    'now we change the order of the language id and code page
    'and convert it into a string representation.
    'For example, it may look like 040904E4
    'Or to pull it all apart:
    '04------        = SUBLANG_ENGLISH_USA
    '--09----        = LANG_ENGLISH
    ' ----04E4 = 1252 = Codepage for Windows:Multilingual
    Do While Len(Lang_Charset_String) &lt; 8
        Lang_Charset_String = "0" &amp; Lang_Charset_String
    Loop

    List1.Clear
    Dim strVersionInfo(7) As String
    strVersionInfo(0) = "CompanyName"
    strVersionInfo(1) = "FileDescription"
    strVersionInfo(2) = "FileVersion"
    strVersionInfo(3) = "InternalName"
    strVersionInfo(4) = "LegalCopyright"
    strVersionInfo(5) = "OriginalFileName"
    strVersionInfo(6) = "ProductName"
    strVersionInfo(7) = "ProductVersion"
    Dim i As Integer
    Dim strTemp As String
    For i = 0 To 7
        Buffer = String(255, 0)
        strTemp = "\StringFileInfo\" &amp; Lang_Charset_String _
        &amp; "\" &amp; strVersionInfo(i)
        rc = VerQueryValue(sBuffer(0), strTemp, _
        lVerPointer, lBufferLen)
        If rc = 0 Then
            MsgBox "VerQueryValue failed at" &amp; i
        Exit Sub
        End If

        lstrcpy Buffer, lVerPointer
        Buffer = Mid$(Buffer, 1, InStr(Buffer, Chr(0)) - 1)
        List1.AddItem strVersionInfo(i) &amp; ": " &amp; Buffer
    Next i
End Sub

</PRE></OL>(c) Microsoft Corporation 1996, All Rights Reserved.
Contributions by Wei Hua, Microsoft Corporation
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
KBCategory: kbusage kbhowto<BR>
KBSubcategory: APrgWindow<BR>
Additional reference words: 4.00 vb4win vb432 kbstream<BR>
Keywords          : APrgWindow vb432 VB4WIN kbhowto<BR>
Version           : 4.0<BR>
Platform          : NT WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 15, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
