

<HTML>
<HEAD>
<TITLE>BUG: RegisterDatabase Fails After ODBC Version 2.x Installed </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q126940">
<META NAME="KBModify" CONTENT="1996/02/26">
<META NAME="KBCreate" CONTENT="1995/03/07">
<META NAME="Keywords" CONTENT="kbprg kbbuglist kbcode">
<META NAME="KBArea" CONTENT="Support; KB; vbwin">
<META NAME="Description" CONTENT="  The RegisterDatabase function fails and returns error 3146  ODBC call failed  after ODBC version 2.x has been installed.  CAUSE =====  The ODBC API function SQLConfigDataSource() was not correctly implemented in ODBC version 1.0. The RegisterDataba...">
<META NAME="Product" CONTENT="Visual Basic for Windows">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBS0,QA9E,QAGI,QAUD,QAH4,QAY5,QATX,QAA1,QAB9,QBV8,QBE7,QBE6,QAKP,QAIF,QDI2 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: RegisterDatabase Fails After ODBC Version 2.x Installed</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 26, 1996</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q126940</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:
<P>
- Professional Edition of Microsoft Visual Basic for Windows,
<PRE>  version 3.0
</PRE> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The RegisterDatabase function fails and returns error 3146 "ODBC call
failed" after ODBC version 2.x has been installed.
<P>
<P><h2>CAUSE</h2>
 
<P>
The ODBC API function SQLConfigDataSource() was not correctly implemented
in ODBC version 1.0. The RegisterDatabase function in Visual Basic version
3.0 was designed to use the ODBC version 1.0 implementation of
SQLConfigDataSource().
<P>
SQLConfigDataSource() is now implemented correctly in ODBC version 2.x. If
ODBC version 2.x has been installed you will find that an application that
uses RegisterDatabase will fail with the error 3146 "ODBC call failed."
<P>
Visual Basic exhibits this problem when using RegisterDatabase because it
was based on the original implementation of SQLConfigDataSource(). The
underlying function that RegisterDatabase ultimately calls has been changed
and Visual Basic's RegisterDatabase function will now generate the error if
the ODBC version 2.x DLLs are installed.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
You can code directly to the ODBC API and register your DSN with
SQLConfigDataSource(). Below is a code sample that will replace the
functionality of Visual Basic's RegisterDatabase function. It first tries
to use RegisterDatabase, if that fails, it uses the ODBC API function
SQLConfigDataSource. You can call this function instead of calling
RegisterDatabase.
<P>
<P><h3>Step-by-Step Example</h3>
 

<OL><P><LI>In Visual Basic, create a new module with the following declarations:
<P>
   Option Explicit
<PRE>   Const ODBC_ADD_DSN = 1        ' Add a new data source.
   Const ODBC_CONFIG_DSN = 2     ' Configure (edit) existing data source.
   Const ODBC_REMOVE_DSN = 3     ' Remove existing data source.

   ' Enter the following three lines as one, single line:
   Declare Function SQLConfigDataSource Lib "odbcinst.dll"
      (ByVal hwnd as Integer, ByVal fRefresh as Integer,
      ByVal szDriver as String, ByVal szAttributes as String) As Integer

</PRE><P><LI>Create the following procedure.
<P>
<PRE>   ' Enter the following two lines as one, single line of code:
   Sub RegisterODBCDatabase (dsn As String, driver As String,
      silent As Integer, attributes As String)

      Dim ret As Integer
      On Error GoTo errorhandler

      RegisterDatabase dsn, driver, silent, attributes
   Exit Sub

</PRE></OL>errorhandler:
<PRE>   If Err = 3146 Then    ' ODBC Call Failed.
      Dim temp As String
      Dim spot As Integer

      While InStr(attributes, Chr(13))     ' Replace Carriage returns
         spot = InStr(attributes, Chr(13)) ' with nulls.
         Mid(attributes, spot, 1) = Chr(0)
      Wend
      attributes = attributes &amp; Chr(0) &amp; Chr(0) ' End of attribute section.
      temp = "DSN=" &amp; dsn &amp; Chr(0) &amp; attributes

      ret = SQLConfigDataSource(0, ODBC_ADD_DSN, driver, temp)

      ' ret is equal to 1 on success and 0 if there is an error.
      If ret &lt;&gt; 1 Then
         MsgBox "SQLConfigDataSource call failed"
      Else
         MsgBox " SQLConfigDataSource call succeeded!"
      End If
   End If
   Exit Sub
   End Sub

</PRE><P><LI>To test this procedure, press the F8 key to single step. Then activate
   the Debug window from the Window menu. Type the following, and press
   the ENTER key:
<P>
   RegisterODBCDatabase "Pubs", "SqlServer", "True, Att$
<P>
</OL>As a result, you will receive a message stating the new datasource was
added successfully.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products listed
at the beginning of this article. We are researching this problem and will
post new information here in the Microsoft Knowledge Base as it becomes
available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Steps to Reproduce Problem</h3>
 

<OL><P><LI>Start a new project in Visual Basic. Form1 is created by defalt.

<P><LI>Add a Command button (Command1) to Form1 and add the following code to
   the Command1 button's Click event:
<P>
<PRE>   Sub Command1_Click ()
      Dim Att As String, MyDb As Database
      Att = "Description = SQL Server on server Clinton" &amp; Chr$(13)
      Att = Att &amp; "OemToAnsi=No" &amp; Chr$(13)   ' Build keywords string.
      Att = Att &amp; "Network=DBNMP3" &amp; Chr$(13)
      Att = Att &amp; "Address=\\CLINTON\PIPE\SQL\QUERY" &amp; Chr$(13)
      Att = Att &amp; "Database=Pubs"
      ' Update ODBC.INI.
      RegisterDatabase "Clinton", "SQL Server", True, Att
   End Sub

</PRE><P><LI>Press the F5 key to run the program. If ODBC version 2.x has been
   installed, when you click the command button, you will receive this
   error: "ODBC Call Failed."
<P>
</OL><h2>REFERENCES</h2>
 
<P>
"Microsoft ODBC 2.0 Programmer's Guide and SDK Guide" Chapter 24.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 3.00<BR>
KBCategory: kbprg kbbuglist kbcode<BR>
KBSubcategory: APrgDataODBC
<P>

<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 26, 1996</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
