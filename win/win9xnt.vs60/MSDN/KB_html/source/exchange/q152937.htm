

<HTML>
<HEAD>
<TITLE>XADM: Multipart MIME Message with TNEF Causes Store Failure </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q152937">
<META NAME="KBModify" CONTENT="1998/02/13">
<META NAME="KBCreate" CONTENT="1996/06/25">
<META NAME="Keywords" CONTENT="kbbug5.00 kbfix5.00.sp2 XADM">
<META NAME="KBArea" CONTENT="Support; KB; exchange">
<META NAME="Description" CONTENT="  Receiving a multipart MIME message from a foreign SMTP system can cause the Microsoft Exchange Server information store to fail with an access violation. The Windows NT Event Viewer Application log may show the following information:     Event ID: ...">
<META NAME="Product" CONTENT="Exchange">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAYC,QAYA,QA9A,QAEV,QAVX,QAVW,QAI4,QAJH,QAYY,QAH6,QBWS,QAKP,QBVV,QBEK,QBEJ V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>XADM: Multipart MIME Message with TNEF Causes Store Failure</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 13, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q152937</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Exchange Server, version 5.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Receiving a multipart MIME message from a foreign SMTP system can cause the
Microsoft Exchange Server information store to fail with an access
violation. The Windows NT Event Viewer Application log may show the
following information:
<P>
<PRE>   Event ID: 4097
   Source: DrWatson
   Description:
   The application, store.dbg, generated an application error The error
   occurred on  8/27/1997 @ 13:42:45.955 The exception generated was
   c0000005 at address 004727e0 (CmnBptMessage::cleanTNEF)

</PRE>Specific information about the failure is contained in the "More
Information" section of this article.
<P>
<P><h2>CAUSE</h2>
 
<P>
A MIME Content-Type: application/ms-tnef bodypart was returned from a
foreign SMTP mail system in a manner that caused the information store to
fail during inbound processing.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
One way to work around this issue is to prevent the sending of the MIME
Content-Type application/ms-tnef bodyparts (Rich-Text Information) to
Internet e-mail domains that do not have systems that handle it. This would
prevent the foreign system from returning ms-tnef bodyparts to a Microsoft
Exchange environment on forwarded mail.
<P>
This can be accomplished by using Microsoft Exchange Administrator program
and configuring the Microsoft Exchange Server Internet Mail Service by
performing the following steps:

<OL><P><LI>Open the Internet Mail property page.

<P><LI>Under Specify Message Content by E-Mail Domain:, click the E-Mail
   Domain button.

<P><LI>Click Add and the Add E-Mail Domain dialog box appears.

<P><LI>In the E-Mail Domain edit window, add the Internet E-Mail Domain you
   do not want send Rich-Text Format to. For example, foreign.system.com.

<P><LI>In the Send Attachments Using pane, click Interoperability.

<P><LI>In the Send Microsoft Exchange Rich Text Formatting list, select
   Never.

<P><LI>Click OK until all the open dialog boxes are closed. This accepts
   your changes.
<P>
</OL>For additional information about the purpose of the Content-Type:
application/ms-tnef message body, please refer to the following article in
the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../exchange/q136204.htm">Q136204</A></B>
   TITLE     : XCLN: Sending Messages In Rich-Text Format

</PRE></OL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Microsoft Exchange Server
version 5.0. This problem has been corrected in the latest U.S. Service
Pack for Microsoft Exchange Server version 5.0. For information on
obtaining the Service Pack, query on the following word in the Microsoft
Knowledge Base (without the spaces):
<P>
<PRE>   S E R V P A C K

</PRE><h2>MORE INFORMATION</h2>
 
<P>
Looking in the Drwtsn32.log file may reveal failure information as
follows:
<P>
<PRE>   Application exception occurred:
   App: store.dbg (pid=370)
   When: 8/27/1997 @ 13:42:45.955
   Exception number: c0000005 (access violation)

   State Dump for Thread Id 0x1b6

   eax=000000b0 ebx=036b500c ecx=036be934 edx=ffffffff esi=036be934
   edi=011ff9cc
   eip=004727e0 esp=06edb73c ebp=011ffafc iopl=0 nv up ei pl nz na po nc
   cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000     efl=00000206

   function: CmnBptMessage::cleanTNEF
           004727d0 56               push    esi
           004727d1 8b81c4000000     mov     eax,[ecx+0xc4]
</PRE>ds:036be9f8=011e0000
<PRE>           004727d7 8bf1             mov     esi,ecx
           004727d9 85c0             test    eax,eax
           004727db 7410             jz      CmnBptMessage::cleanTNEF+0x1d
</PRE>(004727ed)
<PRE>           004727dd 50               push    eax
           004727de 8b00             mov     eax,[eax]
</PRE>ds:000000b0=????????
<PRE>   FAULT -&gt;004727e0 ff5008           call    dword ptr [eax+0x8]
</PRE>ds:00f2eab6=????????
<PRE>           004727e3 c786c400000000000000
</PRE>ds:036be9f8=011e0000
<PRE>                                     mov     dword ptr [esi+0xc4],0x0
           004727ed 8b86c8000000     mov     eax,[esi+0xc8]
</PRE>ds:036be9fc=00405298
<PRE>           004727f3 85c0             test    eax,eax
           004727f5 7410             jz      CmnBptMessage::cleanTNEF+0x37
</PRE>(00472807)
<PRE>           004727f7 50               push    eax
           004727f8 8b00             mov     eax,[eax]
</PRE>ds:000000b0=????????
<PRE>           004727fa ff5008           call    dword ptr [eax+0x8]
</PRE>ds:00f2eab6=????????
<PRE>           004727fd c786c800000000000000
</PRE>ds:036be9fc=00405298
<PRE>                                     mov     dword ptr [esi+0xc8],0x0
           00472807 8b86cc000000     mov     eax,[esi+0xcc]
</PRE>ds:036bea00=011ace8c
<PRE>           0047280d 85c0             test    eax,eax
           0047280f 7410             jz      CmnBptMessage::cleanTNEF+0x51
</PRE>(00472821)
<P>
<PRE>   *----&gt; Stack Back Trace &lt;----*

   FramePtr ReturnAd Param#1  Param#2  Param#3  Param#4  Function Name
   06edb740 004e66c6 00000000 00405e08 036b500c 00001feb
</PRE>store!CmnBptMessage::cleanTNEF
<PRE>   06edb75c 004d6d27 036b500c 011ff9cc 036bbd7e 0000028e
</PRE>store!CmcvtrBptEnd::hrExtract
<PRE>   06edb78c 004e4be1 06edb828 00001feb 06edb7ac 00000000
</PRE>store!CINETextr::hrExtract
<PRE>   06edb7cc 004e4a1c 036b1c6c 06edb828 00001feb 06edb824
</PRE>store!CConvertStream::Write
<PRE>   06edb7f4 005679c1 06edb828 00001feb 06edb824 00000001
</PRE>store!CSTREAM::HrWrite
<PRE>   06edf824 004e4a92 00005feb 00000000 011ee4bc 00000000
</PRE>store!CSTREAM::EcRewriteAfterRewindError
<PRE>   06edf83c 00471604 03705844 00005feb 06edf89c 00000000
</PRE>store!CSTREAM::HrWrite
<PRE>   06edf874 00471515 00005feb 03705844 06edf89c 00000000
</PRE>store!EcWriteStreamOp
<PRE>   06edf89c 0040f3eb 00000000 00000031 00000000 06edf948
</PRE>store!EcWriteStream
<PRE>   06edf90c 0040ec1e 06edf928 00006400 06edf92c 06edfb38 store!EcRpc
   06edf928 77e11841 0016a708 037056e4 001802d0 00006400 store!EcDoRpc
   06edf948 77e52265 0040ebe0 06edfb3c 00000004 06edfb50
</PRE>rpcrt4!I_RpcFreeBuffer
<PRE>   06edf964 77e52236 0040ebe0 06edfb3c 00000004 ffffffff rpcrt4!NdrStubCall
   06edfc28 77e51f9e 00000000 00000000 06edfe08 06edfc40 rpcrt4!NdrStubCall
   06edfc7c 77e11122 00410230 06edfe08 06edfdc4 00000000
</PRE>rpcrt4!NdrServerCall
<PRE>   06edfcd0 77e112fb 06edfe08 00000000 06edfdc4 00153418 rpcrt4!&lt;nosymbols&gt;
   06edfcf0 77e119cf 06edfe08 00000000 06edfdc4 06edfe68
</PRE>rpcrt4!I_RpcGetBuffer
<PRE>   06edfdc8 77e12b98 00143a08 06edfe68 06edfe08 06edfe3c
</PRE>rpcrt4!I_RpcFreeBuffer
<PRE>   06edfe40 77e15fff 00143a08 06edfe68 00000000 001693e8
</PRE>rpcrt4!NdrPointerFree
<PRE>   06edff90 77e162f0 77e163e5 00152268 06edffec 00000000
</PRE>rpcrt4!NdrOleAllocate
<PRE>   00003a98 00000000 00000000 00000000 00000000 00000000
</PRE>rpcrt4!NdrOleAllocate
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: crash access violation failure store msexchangeis<BR>
Keywords          : kbbug5.00 kbfix5.00.sp2 XADM<BR>
Version           : WinNT:5.0<BR>
Platform          : winnt<BR>
Issue type        : kbbug<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 13, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
