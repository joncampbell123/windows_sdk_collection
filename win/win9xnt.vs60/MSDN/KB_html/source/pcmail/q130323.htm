

<HTML>
<HEAD>
<TITLE>PC MAPI: Sample VB Code to Determine Mail Session User </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q130323">
<META NAME="KBModify" CONTENT="1995/05/18">
<META NAME="KBCreate" CONTENT="1995/05/17">
<META NAME="Keywords" CONTENT="kbprg kbcode">
<META NAME="KBArea" CONTENT="Support; KB; pcmail">
<META NAME="Description" CONTENT="  The simple Message Application Program Interface (MAPI) for Microsoft Mail for PC Networks does not include a function that allows developers to directly determine the current user who is logged into a mail session. However, that information can be...">
<META NAME="Product" CONTENT="PC Mail">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAEV,QAI4,QAYC,QAH4,QAL7,QAGB,QAAP,QAB4,QAGU,QBCT,QAGC,QAEF,QBS0,QABI,QAA1 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PC MAPI: Sample VB Code to Determine Mail Session User</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 18, 1995</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q130323</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Microsoft Mail for PC Networks, versions 3.0 and 3.2
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
The simple Message Application Program Interface (MAPI) for Microsoft Mail
for PC Networks does not include a function that allows developers to
directly determine the current user who is logged into a mail session.
However, that information can be obtained by using a workaround which
basically involves saving a dummy message, finding that message, reading
the message, and finally deleting it.
<P>
MORE INFORMATION
 
<P>
One possible example is outlined in the Microsoft Visual Basic version 3.0
code below:
<P>
IMPORTANT NOTE: Make sure the MAPI declaration module (MAPILIB.BAS) is
included in the project.
<P>
<PRE>' ****************** WHOAMI ************************
' **************************************************
'        Simple MAPI Declarations
' **************************************************
</PRE>Dim M As MAPIMessage
Dim Mo As MapiRecip
<P>
<PRE>' ***************************************************
'         Set up the dummy message
' ***************************************************
</PRE>M.RecipCount = 0&amp;
M.FileCount = 0&amp;
<P>
MsgId$ = ""
MsgType$ = "IPC.SIMPLEMAPI.WHOAMI" ' "Hidden" message
M.Reserved = 0&amp;
M.Subject = "MAPIWhoAmI message"
M.NoteText = ""
M.MessageType = MsgType$
M.DateReceived = ""
M.Flags = 0&amp;
msg1$ = "Current logged in user: "
msg2$ = "At address: "
NL = Chr(10)
<P>
<PRE>' **************************************************
' Login and start the MAPI Session
' **************************************************
</PRE>rc&amp; = MAPILogon(Form1.hWnd, "", "", MAPI_LOGON_UI, 0&amp;, lhSession&amp;)
If rc&amp; &lt;&gt; SUCCESS_SUCCESS Then
<PRE>  MsgBox "Error logging in"
  End
</PRE>End If
<PRE>' ***************************************************
' Place the dummy message in the inbox
' ***************************************************
'*********************************
</PRE>ReDim Mr(0 To 0) As MapiRecip
ReDim Mf(0 To 0) As MapiFile
<PRE>'*********************************


</PRE>rc&amp; = MAPISaveMail(lhSession&amp;, Form1.hWnd, M, Mr(0), Mf(0), 0&amp;, 0&amp;, MsgId$)
<PRE>  If rc&amp; &lt;&gt; SUCCESS_SUCCESS Then
    MsgBox "Error saving message"
    rc&amp; = MAPILogoff(lhSession&amp;, 0&amp;, 0&amp;, 0&amp;)
    End
  End If
' ***************************************************
' Find then read the dummy message
'****************************************************
</PRE>rc&amp; = MAPIFindNext(lhSession&amp;, 0&amp;, MsgType$, "", 0&amp;, 0&amp;, MsgId$)
<PRE>  If rc&amp; &lt;&gt; SUCCESS_SUCCESS Then
    MsgBox "Error during message find or no messages in Inbox."
    rc&amp; = MAPILogoff(lhSession&amp;, 0&amp;, 0&amp;, 0&amp;)
    End
  End If
</PRE>Do While (rc&amp; = SUCCESS_SUCCESS)
<PRE>  rc&amp; = MAPIReadMail(lhSession&amp;, 0&amp;, MsgId$, 0&amp;, 0&amp;, M, Mo, Mr(), Mf())
  If rc&amp; &lt;&gt; SUCCESS_SUCCESS Then
     MsgBox "Error during MAPIReadMail"
     Exit Do
  End If
  If M.MessageType = MsgType$ Then
   ' Return our user
        MsgBox msg1$ + Mo.Name + NL + NL + msg2$ + Mo.Address
' **************************************************
' Delete the dummy message when found
' **************************************************
   ' Delete dummy message
     rc&amp; = MAPIDeleteMail(lhSession&amp;, 0&amp;, MsgId$, 0&amp;, 0&amp;)
        If rc&amp; &lt;&gt; SUCCESS_SUCCESS Then MsgBox "Error deleting message"
            Exit Do

        End If
    rc&amp; = MAPIFindNext(lhSession&amp;, 0&amp;, MsgType$, MsgId$, 0&amp;, 0&amp;, MsgId$)
    Loop

' **************************************************
' Logoff
' **************************************************
    rc&amp; = MAPILogoff(lhSession&amp;, 0&amp;, 0&amp;, 0&amp;)
    If rc&amp; &lt;&gt; SUCCESS_SUCCESS Then MsgBox "Error logging off """
</PRE>End
<P>
Additional reference words 1.00

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
KBCategory: kbprg kbcode<BR>
KBSubcategory: MailPCMAPI<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 18, 1995</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
