

<HTML>
<HEAD>
<TITLE>Claiming Critical Sections on Timer Ticks </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q100579">
<META NAME="KBModify" CONTENT="1995/04/12">
<META NAME="KBCreate" CONTENT="1993/06/23">
<META NAME="Keywords" CONTENT="kbprg">
<META NAME="KBArea" CONTENT="Support; KB; win16ddk">
<META NAME="Description" CONTENT="  A deadlock situation in which the system is apparently frozen but the mouse still moves on the screen.  CAUSE =====  Claiming a critical section from inside a timer (IRQ 0) interrupt handler may cause a deadlock in the following scenario:  1. Virtu...">
<META NAME="Product" CONTENT="Win16 DDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QADN,QAHC,QATK,QAHB,QAH4,QDH9,QBVV,QACE,QDL9,QBWO,QBWN,QAY4 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Claiming Critical Sections on Timer Ticks</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  April 12, 1995</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q100579</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Microsoft Windows Software Development Kit (SDK) for Windows,
   version 3.1
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
A deadlock situation in which the system is apparently frozen but the
mouse still moves on the screen.
<P>
<P><h2>CAUSE</h2>
 
<P>
Claiming a critical section from inside a timer (IRQ 0) interrupt
handler may cause a deadlock in the following scenario:

<OL><P><LI>Virtual machine (VM) A claims the critical section.
</OL>2. VM B receives a virtual timer interrupt, tries to claim the critical
<PRE>   section itself, and gets suspended.
</PRE></OL>3. VM A waits on a timer tick before it releases the critical section,
<PRE>   but will no longer see timer interrupts. This deadlocks the machine.

</PRE>Note that it is not uncommon for global terminate-and-stay-resident
(TSR) programs to wait for timer interrupts to occur before resuming
execution; in particular, many network drivers use this technique to
periodically retry unsuccessful packet transmissions.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
The workaround for this problem is to use the documented
TimerCriticalSection entry in SYSTEM.INI, which will implicitly wrap
the virtual interrupt into a critical section.
<P>
Alternatively, application code could call into a VxD to obtain the
critical section status (using the Get_Crit_Sect_Status service)
before attempting to claim the critical section in a timer tick.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
VM A no longer receives timer interrupts in the above scenario because
the virtual timer device (VTD) sets the V86 interrupt vector of each
virtual machine to a small code stub that filters out certain timer
interrupts. In particular, the code stub does not allow nested timer
interrupts to be reflected into the same virtual machine. Thus,
virtual machine B has a pending timer interrupt, and therefore,
virtual machine A does not receive any timer interrupts but does not
release the critical section because it waits for a timer interrupt,
while VM B does not finish processing the timer interrupt because it
is suspended on the critical section. This scenario will deadlock the
two processes.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 3.10<BR>
KBCategory: kbprg<BR>
KBSubcategory: D3MiscVTD<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  April 12, 1995</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
