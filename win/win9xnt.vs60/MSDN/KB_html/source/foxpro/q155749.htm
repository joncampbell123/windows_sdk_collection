

<HTML>
<HEAD>
<TITLE>FIX: Trigger Failed Error When Updating a Compound Primary Key </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q155749">
<META NAME="KBModify" CONTENT="1997/02/20">
<META NAME="KBCreate" CONTENT="1996/09/06">
<META NAME="Keywords" CONTENT="kbtool kbbuglist kbfixlist">
<META NAME="KBArea" CONTENT="Support; KB; foxpro, crossnet, odbc">
<META NAME="Description" CONTENT="  When you make a change to a column in a table that makes up a portion of a primary key or a compound primary key, and the Referential Integrity Builder has referential integrity in place, the Cascade Update to the Child table fails with a  Trigger ...">
<META NAME="Product" CONTENT="Visual FoxPro">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QACI,QATP,QAHT,QABE,QA9N,QABD,QAY4,QAKD,QDO0,QAXB,QBFY,QAAP,QAB9,QAKC,QBD2 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Trigger Failed Error When Updating a Compound Primary Key</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 20, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q155749</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Microsoft Visual FoxPro for Windows, versions 3.0, 3.0b
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you make a change to a column in a table that makes up a portion of a
primary key or a compound primary key, and the Referential Integrity
Builder has referential integrity in place, the Cascade Update to the Child
table fails with a "Trigger Failed."
<P>
<P><h2>CAUSE</h2>
 
<P>
The following REPLACE command in the RIUPDATE procedure improperly
evaluates out to "FieldName1+FieldName2":
<P>
REPLACE (tcFieldName) WITH tcNewValue
<P>
This is why looking at the GaError array, which is filled by the
Referential Integrity Builder, reveals the trigger failed because of a
syntax error.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
To work around this problem, go into the Stored Procedures and modify the
call to the RIUPDATE routine in the procedure called
"__RI_UPDATE_your_table_name" so that it sends an additional argument of
"lcParentWkArea." It should then read the following:
<P>
llRetVal=riupdate("&lt;fieldname1&gt;+&lt;fieldname2&gt;",lcParentID,lcParentWkArea)
<P>
instead of the following:
<P>
llRetVal=riupdate("ONE+TWO",lcParentID)
<P>
Make the following modifications to the RIUPDATE routine:

<OL><P><LI>Add the following additional parameter to the Parameters statement:
<P>
   PARAMETERS tcFieldName,tcNewValue, tcParentWkArea

<P><LI>Add the following variables to the LOCAL declaration line:
<P>
   tcParentTable
   ncount

<P><LI>Add the following immediately after the LOCAL statement:
<P>
   tcParentTable=ALIAS(tcParentWkArea)

<P><LI>Remark out the current REPLACE command.

<P><LI>Add the following code immediately after the commented REPLACE command:
<P>
   ncount=OCCURS('+',tcFieldName)+1
   FOR i = 1 TO ncount
<P><PRE>     DO CASE
      CASE i = 1 &amp;&amp; First occurrence of "+"
       REPLACE (SUBSTR(tcFieldName,i,AT("+",tcFieldName,i)-1));
       WITH EVAL(tcParentTable+'.'+;
       SUBSTR(tcFieldName,i,AT("+",tcFieldName,i)-1))
      CASE i = ncount &amp;&amp; Last occurrence of "+"
       REPLACE (SUBSTR(tcFieldName,AT('+',tcFieldName,ncount-1)+1)) ;
       WITH EVAL(tcParentTable+'.'+ ;
       SUBSTR(tcFieldName,AT('+',tcFieldName,ncount-1)+1))
      OTHERWISE &amp;&amp; Any number of occurrences of + in between.
       REPLACE (SUBSTR(tcFieldName,AT('+',tcFieldName,(i-1))+1, ;
       ((AT('+',tcFieldName,i)-AT('+',tcFieldName,(i-1)))-1))) ;
       WITH EVAL(tcParentTable+'.'+SUBSTR(tcFieldName, ;
       AT('+',tcFieldName,(i-1))+1,((AT('+',tcFieldName,i)- ;
       AT('+',tcFieldName,(i-1)))-1)))
     ENDCASE
</PRE>   NEXT i
<P>
   The above code works with any number of columns in a compound key.
<P>
</OL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in the Microsoft products
listed at the beginning of this article. This problem has been fixed in
Visual FoxPro 5.0 for Windows.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
This problem is limited to FOREIGN KEYs, based on expressions that use the
concatenation character, "+", or complex expressions in the RIUPDATE
routine.
<P>
<P><h3>Steps to Reproduce Behavior</h3>
 

<OL><P><LI>Copy and Paste the following into a program and run it:
<P>
    CREATE DATABASE test
    CREATE TABLE xparent (half1 c(3), half2 c(3), other c(5))
    ALTER TABLE xparent ADD PRIMARY KEY half1+half2 TAG pkey
    CREATE TABLE xchild (half1 c(3), half2 c(3), other c(5), ;
       FOREIGN KEY half1+half2 TAG fkey REFERENCES xparent )
    CLOSE TABLES ALL
    USE xparent
    INSERT INTO xparent (half1, half2, other) VALUES ('aaa','111','a1')
    INSERT INTO xparent (half1, half2, other) VALUES ('bbb','222','b2')
    INSERT INTO xparent (half1, half2, other) VALUES ('ccc','333','c3')
    USE xchild
    INSERT INTO xchild (half1, half2, other) VALUES ('aaa','111','a1')
    INSERT INTO xchild (half1, half2, other) VALUES ('bbb','222','b1')
    INSERT INTO xchild (half1, half2, other) VALUES ('ccc','333','c1')
    INSERT INTO xchild (half1, half2, other) VALUES ('bbb','222','b2')
    INSERT INTO xchild (half1, half2, other) VALUES ('aaa','111','a2')
    INSERT INTO xchild (half1, half2, other) VALUES ('aaa','111','a3')
    MODIFY DATA NOWAIT

<P><LI>When the Database Designer appears, select persistent relationship.

<P><LI>Alternate click the persistent relationship and choose the Referential
    Integrity Builder.

<P><LI>Set the UPDATE to CASCADE.

<P><LI>Click OK on the dialog boxes.

<P><LI>Return to the Database Designer and Browse the xparent.

<P><LI>Modify the contents of either the "half1" or the "half2" field.

<P><LI>Press the Down Arrow to move off the record to invoke the Update
    Trigger.

<P><LI>Choose Revert in the Trigger Failed message box.

<P><LI>In the Command window issue a DISPLAY MEMORY LIKE GAERRORS.

<P><LI>Look on the Visual FoxPro desktop, note the error that caused the
    Trigger to fail is a syntax error.
<P></OL>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
KBCategory: kbtool kbbuglist kbfixlist<BR>
KBSubcategory: FxtoolBuilder vfoxwin buglist3.00 buglist3.00b fixlist5.00<BR>
Additional reference words: 3.00 3.00b<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 20, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
