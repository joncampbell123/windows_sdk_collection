

<HTML>
<HEAD>
<TITLE>PRB: Handling Violation of Field Rules in Forms </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q164358">
<META NAME="KBModify" CONTENT="1997/02/28">
<META NAME="KBCreate" CONTENT="1997/02/27">
<META NAME="Keywords" CONTENT="FxprgTable vfoxwin kbprb kbprg">
<META NAME="KBArea" CONTENT="Support; KB; foxpro, crossnet, odbc">
<META NAME="Description" CONTENT="  If the REVERT or HELP buttons are not desirable in the dialog box that Visual FoxPro 5.0 presents for violations of Field Rules, it is possible to trap the error and present a custom dialog box. These errors were not trappable in either Visual FoxP...">
<META NAME="Product" CONTENT="Visual FoxPro">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAPN,QAPF,QAIB,QA7O,QA7N,QAAP,QAH4,QAB4,QAW6,QBWS,QAEF,QABI,QABH,QAGB,QBV4 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: Handling Violation of Field Rules in Forms</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 28, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q164358</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
5.00
WINDOWS
kbprg kbprb
<P>
 
The information in this article applies to:

<UL><LI>Microsoft Visual FoxPro for Windows, version 5.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
If the REVERT or HELP buttons are not desirable in the dialog box that
Visual FoxPro 5.0 presents for violations of Field Rules, it is possible to
trap the error and present a custom dialog box. These errors were not
trappable in either Visual FoxPro 3.0 or 3.0b.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
There are basically three potential workarounds for this situation:
<P>
The first can be with or without the use of classes. Using classes,
however, is recommended and the implementation below allows you to use the
workaround on a form not using any custom classes.

<OL><P><LI>Create a custom Form Property called lFlagError.

<P><LI>In the Error Method of the Form, add the following code:
<P>
<P><PRE>      IF nError = 1582 &amp;&amp; Field "name" validation rule is violated
<PRE></PRE>         THIS.lFlagError = .T.
      ENDIF

</PRE><P><LI>In the LOSTFOCUS of any TextBox that is based on a field with
   a field rule, add the following code:
<P>
<P><PRE>      IF THISFORM.lFlagError
<PRE></PRE>         NODEFAULT &amp;&amp; Do not move Focus to Next Object
         THISFORM.lFlagError = .F.
      ENDIF

</PRE></OL>The second option involves modifying the Field Rule. Instead of having a
field rule that is merely an expression or a function that checks the
condition and then returns a True or False, change the expression into a
Function (or modify the existing function) so that it checks for the
desired condition. In addition, if the rule fails, REPLACE the field with a
valid value or the DEFAULT VALUE, as in the following example:
<P>
<PRE>   Current Rule: .NOT. EMPTY(&lt;fieldname&gt;)

   Modified Rule*: MyCustomRule()
   *Best placed in Store Procedures of the Database container

   FUNCTION MyCustomRule()
      IF EMPTY(&lt;fieldname&gt;)
         REPLACE &lt;fieldname&gt; WITH ;
         EVAL(DBGETPROP('&lt;alias.fieldname','FIELD','DEFAULTVALUE'))
      ENDIF

</PRE>The third option makes use of a Timer. The SETFOCUS of the object that
caused the Rule violation cannot be called from within the Form's ERROR
method due to the Visual FoxPro Object Model. At the time of the error the
current object is still the object that caused the error and its LOSTFOCUS
event has not yet occurred; therefore, when the ERROR method code is
finished, the object's LOSTFOCUS occurs, moving it to the next object in
the tab order, negating any SETFOCUS() command in the ERROR method of the
Form. The Timer allows the Object Model to progress through normally and
then move the focus back to the object that caused the rule violation. Use
the following steps to implement this workaround:

<OL><P><LI>From the File menu, click New, and then click Class.

<P><LI>From the "Based On" combo box click Timer (for a name, use ErrTimer).

<P><LI>Choose a Class library to store the class in and click OK.

<P><LI>From the Class menu, click Property and name it - oObjRef.

<P><LI>In the Timer Method, enter the following code:
<P>
<P><PRE>      &amp;&amp; Turn the Timer back off
      THIS.INTERVAL = 0
</PRE><P>
<P><PRE>      &amp;&amp; Tell the user there was an error
      =MESSAGEBOX(MESSAGE(),48)
</PRE><P>
<P><PRE>      &amp;&amp; Put the user back in the control
      THIS.oObjRef.SETFOCUS()
      THIS.oObjRef=.NULL.
</PRE>
<P><LI>Create a form.

<P><LI>Add the following code to the form's ERROR method:
<P>
<P><PRE>      &amp;&amp; Check and see if the error was due to Rule Validation
      IF nError = 1582
</PRE><P>
<PRE>         &amp;&amp; Store an object reference of the Current Control to the
         &amp;&amp; custom property oObjRef
         THIS.Errtimer1.oObjRef = THIS.ACTIVECONTROL

         &amp;&amp; The interval can be critical, setting it to low and timing
         &amp;&amp; problems occur, such as the Timer's custom property
         &amp;&amp; not getting set.
         THIS.Errtimer1.INTERVAL = 100
      ENDIF

</PRE></OL><h2>STATUS</h2>
 
<P>
This behavior is by design.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Steps to Reproduce Behavior</h3>
 

<OL><P><LI>Issue the following commands in the Command window:
<P>
<P><PRE>      CREATE DATABASE beakrul
      CREATE TABLE tTemp ;
<PRE></PRE>        (cFld1 c(3) CHECK .NOT. EMPTY(cFld1) ERROR 'Cannot be empty!')
      CREATE FORM breakrul

</PRE><P><LI>Set the Form's BUFFERMODE to "2 - Optimistic."

<P><LI>Right-click on the form and click "Data Environment."

<P><LI>Right-click in the DataEnvironment Window and click "Add Table."

<P><LI>Select the above table.

<P><LI>Click Close to close the "Add Table or View" dialog box.

<P><LI>Click on a field in the Data Environment window and drag it onto the
   form.

<P><LI>Add a CommandButton to the Form.

<P><LI>Double-Click on the CommandButton.

<P><LI>In the CommandButton's CLICK method add the following code:
<P>
<P><PRE>       APPEND BLANK
       THISFORM.REFRESH()
</PRE>
<P><LI>Save and run the form.

<P><LI>Click on the CommandButton.

<P><LI>Tab to the TextBox.

<P><LI>Type anything in the TextBox and hit Enter

<P><LI>Tab back to the TextBox.

<P><LI>Delete the contents of the TextBox and press Enter. The Field
   Validation dialog box appears.
<P>
</OL><h2>REFERENCES</h2>
 
<P>
For more information about replacing values from field rules, please see
the following article in the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../foxpro/q158255.htm">Q158255</A></B>
   TITLE     : How To Modify a Rule's Table to Which It Belongs in VFP 5.0
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
KBCategory: kbprg kbprb<BR>
KBSubcategory: FxprgTable vfoxwin<BR>
Additional reference words: 5.00<BR>
Keywords            : FxprgTable vfoxwin kbprb kbprg<BR>
Version             : 5.00<BR>
Platform            : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 28, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
