

<HTML>
<HEAD>
<TITLE>XL7: Code to Access MS Excel Doesn't Work in Version 7.0 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q138723">
<META NAME="KBModify" CONTENT="1997/09/02">
<META NAME="KBCreate" CONTENT="1995/10/25">
<META NAME="Keywords" CONTENT="kbprg PgmHowTo kbcode kbole kbprg">
<META NAME="KBArea" CONTENT="Support; KB; vbapps">
<META NAME="Description" CONTENT="  In earlier versions of Microsoft Excel, you can create Visual Basic or C/C++ code to allow another application to access a currently running instance of Microsoft Excel. To do this, you use code similar to the code in the following examples:     VB...">
<META NAME="Product" CONTENT="vbapps">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBVP,QAH4,QBFY,QAPF V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>XL7: Code to Access MS Excel Doesn't Work in Version 7.0</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 2, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q138723</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Excel for Windows 95, version 7.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
In earlier versions of Microsoft Excel, you can create Visual Basic or
C/C++ code to allow another application to access a currently running
instance of Microsoft Excel. To do this, you use code similar to the code
in the following examples:
<P>
<PRE>   VB Code Example
   ---------------

   Dim myExcelApp As Object
   Set myExcelApp = GetObject(, "Excel.Application")

   C/C++ Code Example
   ------------------

   LPOLESTR   lpszProgID = OLESTR("Excel.Application");
   LPUNKNOWN pUnk;
   if (FAILED(CLSIDFromProgID(lpszProgID, &amp;clsid)))
      return;
   HRESULT hr =GetActiveObject(clsid,NULL,pUnk);

</PRE>This code will not work with Microsoft Excel version 7.0, even if Microsoft
Excel is running.
<P>
<P><h2>CAUSE</h2>
 
<P>
Earlier versions of Microsoft Excel register the application object in the
OLE RunningObjectTable (ROT) on startup. This registration occurs under all
circumstances, regardless of whether Microsoft Excel is started by OLE.
However, Microsoft Excel 7.0 does not register the application object in
the ROT on startup by default.
<P>
<P><h2>STATUS</h2>
 
<P>
This change in Microsoft Excel 7.0 is by design.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
Microsoft Excel 7.0 DOES register itself in the ROT in the following
situations:

<UL><LI>When it's started by OLE; that is, when a client calls
   CoCreateInstance(), CoGetClassObject(), or CreateInstance().

<LI>When a module is inserted in one of the workbooks.

<LI>When a WM_USER+18 message is sent to the Main window of Microsoft Excel.
<P>
</UL>The following VB 4.0 and C/C++ code samples show how to use the WM_USER+18
option to get an OLE Automation object from an already running instance of
Excel.
<P>
<P><h3>Sample VB Code</h3>
 
<P>
<PRE>Private Declare Function FindWindowA lib "User32" (byval sClass as String,
</PRE>byval xTitle as long) as long
<P>
<PRE>Private Declare Function SendMessageA lib "User32" (byval hwnd as long,
</PRE>byval msg as long, byval wParam as long, byval lParam as long) as long
<P>
Private const WM_USER = 1024
Dim myExcelApp As Object
<P>
<PRE>sub KickExcel()
   dim hwnd as long

   hwnd = FindWindowA("XLMAIN", 0)
   if hwnd = 0 then
      msgbox "No instances of Excel running?"
      exit sub
   endif
   SendMessageA hwnd, WM_USER + 18, 0, 0
</PRE>Set myExcelApp = GetObject(, "Excel.Application")
end sub
<P>
<P><h3>Sample C/C++ Code</h3>
 
<P>
<PRE>LPOLESTR   lpszProgID = OLESTR("Excel.Application");
</PRE>LPUKNOWN pUnk;
HWND hExcelMainWnd =0;
hExcelMainWnd = FindWindow("XLMAIN",NULL);
if(!hExcelMainWnd)
<PRE>   MessageBox(NULL,"No instances of Excel running?","Error",MB_OK);
</PRE>SendMessage(hExcelMainWnd,WM_USER + 18, 0, 0);
if (FAILED(CLSIDFromProgID(lpszProgID, &amp;clsid)))
<PRE>   return;
</PRE>HRESULT hr =GetActiveObject(clsid,NULL,pUnk);
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: kbinf launched<BR>
Keywords          : kbprg PgmHowTo kbcode kbole kbprg<BR>
Version           : 7.00<BR>
Platform          : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 2, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
