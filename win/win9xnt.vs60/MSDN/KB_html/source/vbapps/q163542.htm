

<HTML>
<HEAD>
<TITLE>XL97: Calculation Problems with Arrays in Custom Functions </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q163542">
<META NAME="KBModify" CONTENT="1998/02/27">
<META NAME="KBCreate" CONTENT="1997/02/12">
<META NAME="Keywords" CONTENT="kbcode">
<META NAME="KBArea" CONTENT="Support; KB; vbapps">
<META NAME="Description" CONTENT="  When you use a custom function in a workbook, the function may return incorrect values. Recalculating the workbook may also take longer than it does in earlier versions of Microsoft Excel.  CAUSE =====  This problem occurs when the following condit...">
<META NAME="Product" CONTENT="vbapps">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Security" CONTENT="PUBLIC ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBVP,QAY5,QAB9,QBV8,QAUD,QAE5,QARW,QAVZ,QAKC,QAKP,QATA,QASR,QAPF,QAM9,QALX P1 P2 P3 P4 P5 P6 T2 P7 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>XL97: Calculation Problems with Arrays in Custom Functions</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 27, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q163542</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Excel 97 for Windows
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you use a custom function in a workbook, the function may return
incorrect values. Recalculating the workbook may also take longer than it
does in earlier versions of Microsoft Excel.
<P>
<P><h2>CAUSE</h2>
 
<P>
This problem occurs when the following conditions are true:

<UL><LI>The custom function references a range of cells.
<P>
<P><PRE>    -and-
</PRE>
<LI>You enter the custom function across multiple cells as an array.
<P>
<P><PRE>    -and-
</PRE>
<LI>You recalculate the custom function.
<P>
</UL><h2>WORKAROUND</h2>
 
<P>
Microsoft provides programming examples for illustration only, without 
warranty either expressed or implied, including, but not limited to, the 
implied warranties of merchantability and/or fitness for a particular 
purpose. This article assumes that you are familiar with the programming 
language being demonstrated and the tools used to create and debug 
procedures. Microsoft support engineers can help explain the functionality 
of a particular procedure, but they will not modify these examples to 
provide added functionality or construct procedures to meet your specific 
needs. If you have limited programming experience, you may want to contact 
the Microsoft fee-based consulting line at (800) 936-5200. For more 
information about the support options available from Microsoft, please see 
the following page on the World Wide Web:
<P>
<PRE>   <B><A href="http://www.microsoft.com/support/supportnet/refguide/default.asp">http://www.microsoft.com/support/supportnet/refguide/default.asp</A></B>

</PRE>To work around this problem, follow these steps:

<OL><P><LI>Add the Volatile method to your Visual Basic for Applications custom
   function. This line must immediately follow the Function statement. For
   example, the following function uses the Volatile function:
<P>
<P><PRE>      Function MyFunction(InputRange) As Integer
<PRE></PRE>         Application.Volatile
         MyFunction = InputRange * 10%
      End Function

</PRE><P><LI>Reenter the formula that contains the custom function. To locate and
   select the number of cells that comprises the array formula, follow
   these steps:
<P>
   a. In the worksheet, click any one cell that contains the custom
<P><PRE>      array function.
</PRE><P>
   b. On the Edit menu, click Go To. In the Go To dialog box, click
<P><PRE>      Special. In the Go To Special dialog box, click Current Array.
</PRE><P>
<P><PRE>      Every cell that is in the array is selected.
</PRE><P>
   c. Press F2 to edit the entire array. Press CTRL+SHIFT+ENTER to
<P><PRE>      reenter the array formula.
</PRE>
<P><LI>Save the workbook.
<P>
</OL>The custom function is calculated correctly.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in the Microsoft products
listed at the beginning of this article. This problem was corrected in
Microsoft Excel for Windows, Service Release 1, and in Microsoft Excel 98 
Macintosh Edition.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
Arrays in Microsoft Excel 97 are recalculated &lt;n&gt; times, where &lt;n&gt; is the 
number of elements in the array. In earlier versions of Microsoft Excel, 
the array function is recalculated only once. Therefore, the number of 
elements in the array is directly proportional to the decrease in 
performance when the array is recalculated. Depending on the calculations 
Microsoft Excel performs in the custom function, incorrect values may be 
returned. For example, an incorrect value is returned if the function 
increments a counter and uses the counter value as part of a calculation.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: 97 XL97<BR>
Keywords          : kbcode<BR>
Version           : WINDOWS:97<BR>
Platform          : WINDOWS<BR>
Issue type        : kbbug<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 27, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
