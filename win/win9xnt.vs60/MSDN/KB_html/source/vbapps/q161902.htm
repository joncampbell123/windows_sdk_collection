

<HTML>
<HEAD>
<TITLE>XL97: Macro Created in Form by Web Form Wizard </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q161902">
<META NAME="KBModify" CONTENT="1998/02/27">
<META NAME="KBCreate" CONTENT="1997/01/08">
<META NAME="Keywords" CONTENT="kbcode kbprg kbtool xlvbainfo xlwiz xlweb">
<META NAME="KBArea" CONTENT="Support; KB; vbapps">
<META NAME="Description" CONTENT="  When you use the Microsoft Excel 97 Web Form Wizard to create a form for gathering data over the Internet or an intranet, and you select the  Microsoft Internet Information Server with the Internet Database Connector  option in Step 3 of the Wizard...">
<META NAME="Product" CONTENT="vbapps">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Security" CONTENT="PUBLIC ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAH4,QBEO,QBS0,QANF,QAVZ,QBVP,QAIK,QAGX,QATX,QAAP,QAFF,QAYY,QBWS,QAB4,QBFY P1 P2 P3 P4 P5 P6 T2 P7 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>XL97: Macro Created in Form by Web Form Wizard</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 27, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q161902</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Excel 97 for Windows
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
When you use the Microsoft Excel 97 Web Form Wizard to create a form for
gathering data over the Internet or an intranet, and you select the
"Microsoft Internet Information Server with the Internet Database
Connector" option in Step 3 of the Wizard, a Visual Basic for Applications
module, called WebForm_Submit, is added to the workbook form created by
the Wizard. This article provides the macro code created by the Wizard,
and some information on the Auto_Open macro in the module that can be
edited.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
Microsoft provides examples of Visual Basic for Applications procedures for
illustration only, without warranty either expressed or implied, including,
but not limited to the implied warranties of merchantability and/or fitness
for a particular purpose. The Visual Basic procedures in this article are
provided 'as is' and Microsoft does not guarantee that they can be used in
all situations. While Microsoft support engineers can help explain the
functionality of a particular macro, they will not modify these examples to
provide added functionality, nor will they help you construct macros to
meet your specific needs. If you have limited programming experience, you
may want to consult one of the Microsoft Solution Providers. Solution
Providers offer a wide range of fee-based services, including creating
custom macros. For more information about Microsoft Solution Providers,
call Microsoft Customer Information Service at (800) 426-9400.
<P>
If you create a form using the Web Form Wizard, the following macros are
added to a module that is included with the form.
<P>
NOTE: Some lines of code have been modified with line continuation
characters (_) to fit this document.
<P>
Attribute VB_Name = "WebForm_Submit"
<P>
Option Explicit
<P>
<PRE>' If you remove the comment markers from the following code, only the
' cells that you specified as input cells in the Web Form Wizard will be
' selectable when the user opens the form. This protects the form from
' users attempting to delete or change objects or cells on the form.
' See the help topic on EnableSelection for additional information.
'Sub Auto_Open()
'
'    With ThisWorkbook.ActiveSheet
'        .EnableSelection = xlUnlockedCells
'        .Protect DrawingObjects:=True, Contents:=True, _
'            UserInterfaceOnly:=True
'    End With
'End Sub

Sub SubmitInfo()
    Dim aControl As Variant
    Dim MyArray()
    Dim i, j, UBoundaControl, UBoundTestaControl As Integer
    Dim sInfoToSubmit, sURL As String
    Dim sThisField As String
    Dim fDoneFirst As Boolean
    Dim iListIndex As Integer
    Dim Wks As Worksheet

    ' Check if there is some hidden name if not quit it
    On Error Resume Next
        Set Wks = ThisWorkbook.ActiveSheet
        sURL = Evaluate(Wks.Names("WebForm_URLOfIDC").Value)
    On Error GoTo 0

    If IsEmpty(sURL) Then GoTo SheetDamaged

    On Error GoTo SheetDamaged
    aControl = Evaluate(Wks.Name &amp; "!WebForm_Control")

    On Error Resume Next
        UBoundTestaControl = UBound(aControl, 2)
    On Error GoTo 0

    If UBoundTestaControl = 0 Then
        UBoundaControl = 1
    Else
        UBoundaControl = UBound(aControl, 1)
    End If

    On Error GoTo SheetDamaged
    ReDim MyArray(UBoundaControl, 3)
    For j = LBound(aControl, 1) To UBoundaControl
        If UBoundTestaControl = 0 Then
            MyArray(j, 1) = aControl(1)
            MyArray(j, 2) = aControl(2)
        Else
            MyArray(j, 1) = aControl(j, 1)
            MyArray(j, 2) = aControl(j, 2)
        End If

        Select Case TypeName(Evaluate(MyArray(j, 1)))
            Case "Range"
                MyArray(j, 3) = Wks.Range(MyArray(j, 1)).Value
                If Len(MyArray(j, 3)) &gt; 249 Then GoTo StringTooLong
            Case "ListBox"
                iListIndex = Wks.DrawingObjects(MyArray(j, 1)).ListIndex
                If iListIndex &lt;&gt; 0 Then
                    MyArray(j, 3) = Wks.DrawingObjects(MyArray(j, 1)) _
                    .List(Wks.DrawingObjects(MyArray(j, 1)).ListIndex)
                Else
                    MyArray(j, 3) = ""
                End If
            Case "DropDown"
                iListIndex = Wks.DrawingObjects(MyArray(j, 1)).ListIndex
                If iListIndex &lt;&gt; 0 Then
                    MyArray(j, 3) = Wks.DrawingObjects(MyArray(j, 1)) _
                    .List(Wks.DrawingObjects(MyArray(j, 1)).ListIndex)
                Else
                    MyArray(j, 3) = ""
                End If
            Case "CheckBox"
                If Wks.DrawingObjects(MyArray(j, 1)).Value = 1 Then
                    MyArray(j, 3) = "on"
                Else
                    MyArray(j, 3) = "off"
                End If
            Case "OptionButton"
                If Wks.DrawingObjects(MyArray(j, 1)).Value = 1 _
                   Then MyArray(j, 3) = MyArray(j, 1)
            Case Else
                MyArray(j, 3) = Wks.DrawingObjects(MyArray(j, 1)).Value
        End Select
        Next j

    fDoneFirst = False
    sInfoToSubmit = ""
    For j = LBound(aControl, 1) To UBoundaControl
        If Len(CStr(MyArray(j, 3))) &gt; 0 Then
            sThisField = URLEncodeString(CStr(MyArray(j, 2))) &amp; -_
               "=" &amp; URLEncodeString(CStr(MyArray(j, 3)))

            If fDoneFirst Then
                sInfoToSubmit = sInfoToSubmit &amp; "&amp;" &amp; sThisField
            Else
                sInfoToSubmit = sThisField
                fDoneFirst = True
            End If
        End If
    Next j

    sInfoToSubmit = sURL &amp; "?" &amp; sInfoToSubmit

    On Error GoTo BadURLOrSheetDamaged
        With ThisWorkbook
            .Saved = True
            .FollowHyperlink Address:=sInfoToSubmit
        End With
    On Error GoTo 0


    Exit Sub

</PRE>StringTooLong:
<PRE>   MsgBox "One or more responses are too long. To continue, shorten any" _
      &amp; " response than is more than 249 characters. No information has" _
      &amp; " been submitted."
    Exit Sub

</PRE>SheetDamaged:
<PRE>   MsgBox "This form has been modified or damaged. No information has " _
     &amp; "been submitted. Please report this problem to the administrator" _
     &amp; " of the form."
   Exit Sub

</PRE>BadURLOrSheetDamaged:
<PRE>   MsgBox "No information has been submitted. The reason might be one" _
     &amp; " of the following:" &amp; Chr(13) &amp; "* One or more files used in" _
     &amp; " this process seems to have been damaged." &amp; Chr(13) &amp; "* The" _
     &amp; " URL address which is saved in a defined name in this worksheet" _
     &amp; " might be wrong." &amp; Chr(13) &amp; Chr(13) &amp; "Please contact the" _
     &amp; " administrator of this file."
    Exit Sub
End Sub

</PRE>Function URLEncodeString(ByVal Sin As String) As String
<PRE>    Dim sOut As String
    Dim iLen As Integer
    Dim i As Integer
    Dim c As Integer

    iLen = Len(Sin)
    For i = 1 To iLen
        c = Asc(Mid(Sin, i, 1))
        Select Case c
        ' a to z, A to Z, 0 to 9, &lt;period&gt;, &lt;underscore&gt;, &lt;minus&gt;
        Case 97 To 122, 65 To 90, 48 To 57, 46, 95, 45
            sOut = sOut &amp; Chr(c)

        Case 32             ' space
            sOut = sOut &amp; "+"

        Case Else
            sOut = sOut &amp; MakeHexSubstitution(c)
        End Select
    Next
    URLEncodeString = sOut
</PRE>End Function
<P>
Function MakeHexSubstitution(c As Integer) As String
<PRE>    Dim sResult As String

    sResult = Hex(c)
    If Len(sResult) &lt; 2 Then
        sResult = "0" &amp; sResult
    End If
    MakeHexSubstitution = "%" &amp; sResult
</PRE>End Function
<P>
NOTE: The Auto_Open sub procedure that is commented-out, by default, can
be uncommented to change the protection of your form. If you uncomment
this procedure and then save and close the workbook, the next time you
open the workbook (either manually or through your browser) you will only
be able to select the cells you specified for data input when the form was
created with the Web Form Wizard. This is because the cells for data input
are not locked and the macro turns on worksheet protection with the
EnableSelection property for the worksheet set to xlUnlockedCells.
<P>
<P><h2>REFERENCES</h2>
 
<P>
For more information about the Web Form Wizard, click the Index tab in
Microsoft Excel Help, type the following text
<P>
<PRE>   web form wizard

</PRE>and then double-click the selected text to go to the "About setting up
your data gathering system" topic.
<P>
For more information about the EnableSelection Property, click the
Office Assistant in the Visual Basic Editor, type "enableselection",
click Search, and then click to view "EnableSelection Property".
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: 97 XL97<BR>
Keywords          : kbcode kbprg kbtool xlvbainfo xlwiz xlweb<BR>
Version           : WINDOWS:97<BR>
Platform          : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 27, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
