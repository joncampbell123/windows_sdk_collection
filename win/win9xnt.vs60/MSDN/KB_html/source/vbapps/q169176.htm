

<HTML>
<HEAD>
<TITLE>XL97: Page Fault When Running DDE Macro or Closing Windows </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q169176">
<META NAME="KBModify" CONTENT="1998/02/27">
<META NAME="KBCreate" CONTENT="1997/05/28">
<META NAME="Keywords" CONTENT="kbcode kberrmsg xlvbainfo xlgpf">
<META NAME="KBArea" CONTENT="Support; KB; vbapps">
<META NAME="Description" CONTENT="  When you run a Microsoft Visual Basic for Applications macro or procedure  that uses dynamic data exchange (DDE) commands or you try to restart or  shut down Microsoft Windows, one of the following error messages appears:     Microsoft Windows 95  ...">
<META NAME="Product" CONTENT="vbapps">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Security" CONTENT="PUBLIC ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBVP,QAH4,QDL9,QBWO,QBWN,QBWS,QBS0,QAZ2,QAGB,QBJZ,QAPN,QAB4,QAJH,QBII,QAIJ P1 P2 P3 P4 P5 P6 T2 P7 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>XL97: Page Fault When Running DDE Macro or Closing Windows</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 27, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q169176</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Excel 97 for Windows
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you run a Microsoft Visual Basic for Applications macro or procedure 
that uses dynamic data exchange (DDE) commands or you try to restart or 
shut down Microsoft Windows, one of the following error messages appears:
<P>
<PRE>   Microsoft Windows 95
   --------------------

      This program has performed an illegal operation
      and will be shut down.

      If the problem persists, contact the program
      vendor.

   When you click Details, an error message similar to one of the following
   appears:

      EXCEL caused an invalid page fault in
      module OLEAUT32.DLL at 0137:65349854.

      EXCEL caused an invalid page fault in
      module EXCEL.EXE at 0137:302036d4.

   Microsoft Windows NT
   --------------------

      This Windows application cannot respond to the End Task
      request. It may be busy, waiting for a response from you, or
      it may have stopped executing.

      -or-

      An application error has occurred
      and an application error log is being generated.

      EXCEL.exe
      Exception access violation (0xc0000005),Address 0x30276e52.

</PRE><h2>CAUSE</h2>
 
<P>
This problem occurs when you do the following:

<UL><LI>You run Visual Basic code that opens more than one DDE channel to a 
   program and does not properly terminate the open channels.
<P>
<P><PRE>    -and-
</PRE>
<LI>You do either of the following:
<P>
<P><PRE>    - You quit Microsoft Windows.
</PRE><P>
<PRE>        -or-

    - You run the same procedure or another procedure that creates a DDE 
      channel to the same program.

</PRE></UL><h2>RESOLUTION</h2>
 
<P>
If you open a DDE channel, you must terminate the channel before you quit
Microsoft Excel. To terminate a DDE channel, use the DDETerminate method,
as in the following example:
<P>
<PRE>   Application.DDETerminate &lt;ChanNum&gt;

</PRE>where &lt;ChanNum&gt; is the channel number returned by the DDEInitiate method.
<P>
If you encounter this problem, restart Microsoft Windows, and then edit the 
macro or procedure in Microsoft Excel. Insert the DDETerminate statement 
into the appropriate location in the code. For more information, see the 
sample macro in the "More Information" section of this article.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in the Microsoft products
listed at the beginning of this article. We are researching this problem
and will post new information here in the Microsoft Knowledge Base as it
becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
Microsoft provides programming examples for illustration only, without
warranty either expressed or implied, including, but not limited to, the
implied warranties of merchantability and/or fitness for a particular
purpose. This article assumes that you are familiar with the programming
language being demonstrated and the tools used to create and debug
procedures. Microsoft support engineers can help explain the functionality
of a particular procedure, but they will not modify these examples to
provide added functionality or construct procedures to meet your specific
needs. If you have limited programming experience, you may want to contact
the Microsoft fee-based consulting line at (800) 936-5200. For more
information about the support options available from Microsoft, please see
the following page on the World Wide Web:
<P>
<PRE>   <B><A href="http://www.microsoft.com/support/supportnet/refguide/default.asp">http://www.microsoft.com/support/supportnet/refguide/default.asp</A></B>

</PRE>The following macro creates two DDE sessions to Microsoft Excel, inserts a
new workbook, and then terminates the DDE channels that it created.
<P>
To run this macro, follow these steps:

<OL><P><LI>Start Microsoft Excel 97. In a new workbook, press Alt+F11 to
   start the Visual Basic Editor.

<P><LI>On the Insert menu, click Module and type the following macro in
   the module sheet:
<P>
<PRE>      Sub DDESessions()

      Dim LobjExcelApp as Object
      Dim LwbNewWB as Object
         ' Perform commands within loop two times.
         For i = 1 to 2
            ' Create an object to Microsoft Excel.
            Set LobjExcelApp = CreateObject("Excel.application")
            ' Create workbook object.
            Set LwbNewWB = LobjExcelApp.Workbooks.Add
            ' Get DDE channel to Microsoft Excel.
            LwChanNum1 = Application.DDEInitiate("Excel", "System")
            ' Insert new workbook.
            Application.DDEExecute LwChanNum1, "[New]"
            ' Quit workbook.
            Application.DDEExecute LwChanNum1, "[Quit()]"
            ' Terminate this DDE channel.
            Application.DDETerminate LwChanNum1
         Next i
         MsgBox "DDESessions is complete"

      End Sub

</PRE><P><LI>On the File menu, click "Close and Return to Microsoft Excel."

<P><LI>In the workbook, click Macro on the Tools menu, and then click Macros.
   Click DDESessions, and then click Run. When the message box that 
   indicates the macro is completed appears, click OK.
<P>
</OL><h2>REFERENCES</h2>
 
<P>
For more information about creating DDE channels, click the Index tab in
Visual Basic Help, type the following text
<P>
<PRE>   DDEInitiate method

</PRE></OL>and then double-click the selected text to go to the "DDEInitiate Method"
topic.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: XL97<BR>
Keywords          : kbcode kberrmsg xlvbainfo xlgpf<BR>
Version           : WINDOWS:97<BR>
Platform          : WINDOWS<BR>
Issue type        : kbprb<BR>
Solution Type     : kbworkaround<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 27, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
