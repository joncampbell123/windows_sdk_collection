

<HTML>
<HEAD>
<TITLE>ACC97:Transaction in ODBCDirect Workspace Causes Corrupted Index </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q173163">
<META NAME="KBModify" CONTENT="1998/01/15">
<META NAME="KBCreate" CONTENT="1997/08/26">
<META NAME="Keywords" CONTENT="kberrmsg OdbcOthr ODBCGen">
<META NAME="KBArea" CONTENT="Support; KB; vbapps">
<META NAME="Description" CONTENT="  Advanced: Requires expert coding, interoperability, and multiuser skills.  A Visual Basic for Applications procedure that uses ODBCDirect to create and populate a table in another Microsoft Access database also creates corrupted unique indexes in t...">
<META NAME="Product" CONTENT="vbapps">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QATJ,QA28,QA1S,QA5V,QBS0,QDN9,QBXR,QAPN,QAZV,QATX,QAKH,QAYY,QBNL,QA9E,QAB9 P1 P2 P3 P4 P5 P6 T2 P7 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>ACC97:Transaction in ODBCDirect Workspace Causes Corrupted Index</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  January 15, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q173163</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Access 97
<LI>Microsoft Visual Basic Standard and Enterprise Editions, 32-bit only,
   for Windows, version 4.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Advanced: Requires expert coding, interoperability, and multiuser skills.
<P>
A Visual Basic for Applications procedure that uses ODBCDirect to create
and populate a table in another Microsoft Access database also creates
corrupted unique indexes in that table. This behavior occurs if the
procedure performs the following steps in sequence:

<OL><P><LI>BeginTrans on the ODBCDirect workspace

<P><LI>Execute method on a connection to Create Table with Unique Indexes

<P><LI>Execute method on the connection to Append records to that table

<P><LI>Execute method on the connection to Update the newly added records

<P><LI>CommitTrans on the ODBCDirect workspace
<P>
</OL>If you modify data in a field that is a unique index in the resulting table
but is not a primary key, you receive the following error message when you
try to commit the record:
<P>
<PRE>   Reserved Error (-1601); there is no message for this error.

</PRE></OL>You are able to make changes to data in other fields.
<P>
This behavior occurs when the ODBC data source is a Microsoft Access 97
database or a Microsoft Access version 7.0 database.
<P>
This behavior also occurs if you use Remote Data Object (RDO) instead of
ODBCDirect in the Enterprise Edition of Microsoft Visual Basic version 4.0.
<P>
This article assumes that you are familiar with Visual Basic for
Applications and with creating Microsoft Access applications using the
programming tools provided with Microsoft Access. For more information
about Visual Basic for Applications, please refer to the "Building
Applications with Microsoft Access 97" manual.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
If you have already created the table and are unable to enter data because
unique indexes are corrupted, press ESC to cancel the changes to the
record. Then compact the database. After you have compacted the database,
you can make changes to the data in the unique index fields.
<P>
There are three methods to prevent the corruption from occurring.
<P>
<P><h3>Method 1</h3>
 
<P>
The recommended resolution is to use a Microsoft Jet workspace rather than
an ODBCDirect workspace to create and modify the table. When you use an
ODBCDirect workspace to modify a Microsoft Jet database, data access
objects (DAO) loads the Microsoft Jet ODBC driver, which in turn loads
Microsoft Jet. A procedure in which DAO creates and modifies the table
directly without going through ODBC is more efficient.
<P>
<P><h3>Method 2</h3>
 
<P>
Commit the transaction after you have created the table but before you
append the records, or after you have appended the records but before you
modify them.
<P>
<P><h3>Method 3</h3>
 
<P>
If you must create the table, append the records and modify the records
within a single transaction, create the unique indexes by executing an SQL
statement that is separate from the SQL statement that creates the table.
Note that you can create a primary key in the same SQL statement that
creates the table; although other unique indexes become corrupted, a
primary index does not become corrupted.
<P>
The following example contains a procedure that creates the table, appends
the records, and modifies the records within a single transaction.

<OL><P><LI>Create a blank database in Microsoft Access version 7.0 or 97.

<P><LI>Create an ODBC DSN whose data source is the database created in Step 1,
   and name it "TestRDO97" (without the quotation marks).

<P><LI>Create a blank database in Microsoft Access 97.

<P><LI>Create a module and type the following line in the Declarations
   section if it is not already there:
<P>
<P><PRE>      Option Explicit
</PRE>
<P><LI>Type the following procedure:
<P>
<PRE>      Sub CreateIndexTrans (strTableName as string, strDSN as string)
         Dim Connection1 As Connection, ws As Workspace
         On Error GoTo Errorhandler
         Set ws = DBEngine.CreateWorkspace _
            ("TransAct", "Admin", "", dbUseODBC)
         Set Connection1 = ws.OpenConnection("Con1", _
           dbDriverCompleteRequired, , "ODBC;DSN=" &amp; strDSN)
         ws.BeginTrans
            Connection1.Execute "CREATE TABLE " &amp; strTableName &amp; _
               " (ID INTEGER constraint ID PRIMARY KEY, " &amp; _
               "LastName Text (50), FirstName Text (50), keyCode " &amp; _
               "Text (10), SSN Text (20))"
         '----------- Create Indexes ------------------
            Connection1.Execute "CREATE INDEX " &amp; _
               "idxLastName ON " &amp; strTableName &amp; " (LastName)"
            Connection1.Execute "CREATE UNIQUE INDEX " &amp; _
               "idxKeyCode ON " &amp; strTableName &amp; " (KeyCode)"
            Connection1.Execute "CREATE UNIQUE INDEX " &amp; _
               "idxSSN ON " &amp; strTableName &amp; " (SSN)"
         '---------------------------------------------
            Connection1.Execute "INSERT INTO " &amp; strTableName &amp; _
               " (ID, FirstName, LastName, KeyCode, SSN) " &amp; _
               "Values (1, 'Bob', 'Wire', 'ABC','012-34-5678')"
            Connection1.Execute "UPDATE " &amp; strTableName &amp; _
               " SET FirstName = 'Robert', LastName='Wires', " &amp; _
               "KeyCode='A1B1C1', SSN='987-65-4321' WHERE ID = 1"
         ws.CommitTrans
         Connection1.Close
         MsgBox strTableName &amp; " created in other database."

         Exit_CreateIndexProblem:
            Exit Sub

         Errorhandler:
            MsgBox CStr(Err) &amp; " " &amp; Err.Description
            Resume Exit_CreateIndexProblem

      End Sub

</PRE><P><LI>To run this subroutine, type the following line in the Debug window,
   and then press ENTER:
<P>
<P><PRE>      CreateIndexTrans "tblIndexTrans", "TestRDO97"
</PRE>
<P><LI>Open the database you created in Step 1.

<P><LI>Open tblIndexTrans.

<P><LI>Change the data in the keyCode field or in the SSN field. Note that you
   can successfully commit the record.
<P>
</OL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Microsoft Access 97. We
are researching this problem and will post new information here in the
Microsoft Knowledge Base as it becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Steps to Reproduce Problem</h3>
 

<OL><P><LI>Create a blank database in Microsoft Access version 7.0 or 97.

<P><LI>Create an ODBC DSN whose data source is the database created in Step 1,
   and name it "TestRDO97" (without the quotation marks).

<P><LI>Create a blank database in Microsoft Access 97.

<P><LI>Create a module and type the following line in the Declarations
   section if it is not already there:
<P>
<P><PRE>      Option Explicit
</PRE>
<P><LI>Type the following procedure:
<P>
<PRE>      Sub CreateIndexProblem(strTableName as string, strDSN as string)
         Dim Connection1 As Connection, ws As Workspace
         On Error GoTo Errorhandler
         Set ws = DBEngine.CreateWorkspace  _
            ("TransAct", "Admin", "", dbUseODBC)
         Set Connection1 = ws.OpenConnection("Con1", _
            dbDriverCompleteRequired, , "ODBC;DSN=" &amp; strDSN)
         ws.BeginTrans
            Connection1.Execute "CREATE TABLE " &amp; strTableName &amp; _
               " (ID INTEGER Constraint ID PRIMARY KEY, " &amp; _
               "LastName Text Constraint idxLastName NOT NULL, " &amp; _
               "FirstName Text, " &amp; _
               "keyCode Text Constraint idxKeyCode UNIQUE, " &amp; _
               "SSN Text Constraint idxSSN UNIQUE)"
            Connection1.Execute "INSERT INTO " &amp; strTableName &amp; _
               " (ID, FirstName, LastName, KeyCode, SSN) " &amp; _
               "Values (1, 'Bob', 'Wire', 'ABC','012-34-5678')"
            Connection1.Execute "UPDATE " &amp; strTableName &amp; _
               " SET FirstName = 'Robert', LastName='Wires', " &amp;  _
               "KeyCode='A1B1C1', " &amp; _
               "SSN='987-65-4321' WHERE ID = 1"
         ws.CommitTrans
         Connection1.Close
         MsgBox strTableName &amp; " created in other database."

      Exit_CreateIndexProblem:
         Exit Sub

      Errorhandler:
         MsgBox CStr(Err) &amp; " " &amp; Err.Description
         Resume Exit_CreateIndexProblem
      End Sub

</PRE><P><LI>To run this subroutine, type the following line in the Debug window,
   and then press ENTER:
<P>
<P><PRE>       CreateIndexProblem "tblTransProblem", "TestRDO97"
</PRE>
<P><LI>Open the database you created in Step 1.

<P><LI>Open tblTransProblem.

<P><LI>Change the data in the keyCode field or in the SSN field; then try
   to commit the record. Note that you receive the error described
   in the "Symptoms" section.
<P>
</OL><h2>REFERENCES</h2>
 
<P>
For more information about ODBCDirect, search the Help Index for
"ODBCDirect Workspaces."
<P>
For more information about setting up ODBC data sources, search the Help
Index for "ODBC, setting up data sources."
<P>
For more information about the SQL command CREATE TABLE, search the Help
Index for "CREATE TABLE Statement (Microsoft Jet SQL)."
<P>
For more information about the SQL command CREATE INDEX, search the Help
Index for "CREATE INDEX Statement (Microsoft Jet SQL)."
<P>
For more information about the SQL command INSERT INTO, search the Help
Index for "INSERT INTO Statement (Microsoft Jet SQL)."
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: pra<BR>
Keywords          : kberrmsg OdbcOthr ODBCGen<BR>
Version           : WINDOWS:4.0,97<BR>
Platform          : WINDOWS<BR>
Issue type        : kbbug<BR>
Solution Type     : kbworkaround<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  January 15, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
