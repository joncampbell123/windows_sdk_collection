

<HTML>
<HEAD>
<TITLE>ACC: Cannot Open Recordset on SQL Server Inside Transaction </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q131342">
<META NAME="KBModify" CONTENT="1997/08/29">
<META NAME="KBCreate" CONTENT="1995/06/08">
<META NAME="Keywords" CONTENT="JetRS JetTrans kbusage OdbcSqlMs">
<META NAME="KBArea" CONTENT="Support; KB; vbapps">
<META NAME="Description" CONTENT="  Advanced: Requires expert coding, interoperability, and multiuser skills.  When you open a recordset on a SQL Server table, you receive the following error message:   - SQL Server Version 4.2X  - Microsoft Access 7.0 and 97:        Run-time error '...">
<META NAME="Product" CONTENT="vbapps">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QA1S,QDN9,QAB4,QABM,QAAP,QBS0,QBXT,QA5V,QA5F,QAY5,QAMA,QAIB,QBWS,QAH4,QANF P1 P2 P3 P4 P5 P6 T2 P7 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>ACC: Cannot Open Recordset on SQL Server Inside Transaction</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  August 29, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q131342</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Access versions 2.0, 7.0, 97
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Advanced: Requires expert coding, interoperability, and multiuser skills.
<P>
When you open a recordset on a SQL Server table, you receive the following
error message:

<UL><LI>SQL Server Version 4.2X
<LI>Microsoft Access 7.0 and 97:
<P>
<P><PRE>      Run-time error '3146'
      Application-defined or object-defined error
</PRE>
<LI>SQL Server Version 4.2X and 6.x
<LI>Microsoft Access version 2.0:
<P>
<P><PRE>      ODBC--call failed. [Microsoft][ODBC SQL Server Driver][SQL Server]
      stored procedure sp_statistics cannot be run while in a transaction
      (#20001)
</PRE><P>
</UL>This error does not occur when using Microsoft Access 7.0 or 97 with SQL
Server version 6.x.
<P>
This article assumes that you are familiar with Visual Basic for
Applications and with creating Microsoft Access applications using the
programming tools provided with Microsoft Access. For more information
about Visual Basic for Applications, please refer to your version of the
"Building Applications with Microsoft Access" manual.
<P>
NOTE: Visual Basic for Applications is called Access Basic in Microsoft
Access version 2.0. For more information about Access Basic, please refer
to the "Building Applications" manual.
<P>
<P><h2>CAUSE</h2>
 
<P>
You opened the recordset using the OpenDatabase method while a transaction
was pending.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
You can either link (attach) the SQL Server table and open the recordset
on the linked table, or you can open the recordset outside of a pending
transaction.
<P>
To open the recordset outside of a pending transaction, follow these
steps:

<OL><P><LI>Open the sample database Northwind.mdb (or NWIND.MDB in version 2.0).

<P><LI>Create a module and type the following line in the Declarations
   section:
<P>
<P><PRE>      Option Explicit
</PRE>
<P><LI>Type the following procedure:
<P>
   NOTE: In the following sample code, an underscore (_) at the end of a
   line is used as a line-continuation character. Remove the underscore
   from the end of the line when re-creating this code in Access Basic.
<P>
<P><PRE>      Function Trans_Work ()
<PRE></PRE>         Dim db As Database
         Dim ws As WorkSpace
         Dim rs As Recordset
         Dim connectstring As String
         connectstring = "ODBC;DSN=&lt;datasource name&gt;;UID=&lt;username&gt;;_
                         PWD=&lt;password&gt;;DATABASE=PUBS"

         ' NOTE: In the "connectstring" line above replace &lt;datasource
         ' name&gt; with the name of your data source for SQL Server; replace
         ' &lt;username&gt; with the username used to log on to the data
         ' source; and replace &lt;password&gt; with the appropriate password.

         On Error GoTo Trans_Work_Err
         Set ws = dbengine.Workspaces(0)
         Set db = ws.OpenDatabase("", False, False, connectstring)
         Set rs = db.OpenRecordset("dbo.authors")   'Opens the recordset.
         ws.BeginTrans   'Starts the transaction.
         rs.MoveLast
         Debug.Print rs![au_lname]
         ws.CommitTrans   'Commits the transaction.
         rs.Close  'Closes the Recordset.
         db.Close
         Exit Function

      Trans_Work_Err:
         ws.Rollback
         If Err = 3146 Then 'ODBC call failed
            Error (Err)
         Else
            MsgBox Error$   'The message if a different error occurs.
         End If
         Exit Function
      End Function

</PRE><P><LI>Type the following line in the Debug window (or Immediate window in
   version 2.0), and press ENTER.
<P>
<P><PRE>      ? Trans_Work()
</PRE><P>
</OL><h2>STATUS</h2>
 
<P>
This behavior is by design.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The SQL Server driver provided with Microsoft Access calls a SQL Server
catalog stored procedure called SP_STATISTICS to retrieve information
about the table on which you create the recordset. SQL Server does not
allow this stored procedure to run while a transaction is pending.
<P>
<P><h3>Steps to Reproduce Behavior</h3>
 

<OL><P><LI>Open the sample database Northwind.mdb (or NWIND.MDB in version 2.0).

<P><LI>Create a module and type the following line in the Declarations section:
<P>
<P><PRE>      Option Explicit
</PRE>
<P><LI>Type the following procedure:
<P>
   NOTE: In the following sample code, an underscore (_) at the end of a
   line is used as a line-continuation character. Remove the underscore
   from the end of the line when re-creating this code in Access Basic.
<P>
<P><PRE>      Function Trans_Fail ()
<PRE></PRE>         Dim db As Database
         Dim ws As WorkSpace
         Dim rs As Recordset
         Dim connectstring As String
         connectstring = "ODBC;DSN=&lt;datasource name&gt;;UID=&lt;username&gt;;_
                            PWD=&lt;password&gt;;DATABASE=PUBS"

         ' NOTE: For the "connectstring" line above replace &lt;datasource
         ' name&gt; with the name of your data source for SQL Server;
         ' replace &lt;username&gt; with the username used to log on to the data
         ' source; and replace &lt;password&gt; with the appropriate password.

         On Error GoTo Trans_Fail_Err
         Set ws = dbengine.Workspaces(0)
         Set db = ws.OpenDatabase("", False, False, connectstring)
         ws.BeginTrans   'Starts the transaction.
         Set rs = db.OpenRecordset("dbo.authors")   'Opens the recordset.
         rs.MoveLast
         Debug.Print rs![au_lname]
         ws.CommitTrans   'Commits the transaction.
         rs.Close  'Closes the Recordset.
         db.Close
         Exit Function

      Trans_Fail_Err:
         ws.Rollback
         If Err = 3146 Then 'ODBC call failed
            Error (Err)
         Else
            MsgBox Error$   'The message if a different error occurs.
         End If
         Exit Function
      End Function

</PRE><P><LI>Type the following line in the Debug Window (or Immediate window in
   version 2.0)and press ENTER:
<P>
<P><PRE>      ? Trans_Fail()
</PRE><P>
</OL>Note that when the recordset is opened, you receive the error message
described above.
<P>
<P><h2>REFERENCES</h2>
 
<P>
For more information about the OpenRecordSet method, search the Help
Index for "OpenRecordSet method."
<P>
For more information about the OpenDatabase method, search the Help
Index for "OpenDatabase method."
<P>
Microsoft Access "Building Applications," version 2.0, "Using
Transactions to Control Changes," pages 265-267
 
<PRE>Keywords          : JetRS JetTrans kbusage OdbcSqlMs
Version           : 2.0 7.0 97
Platform          : WINDOWS
Hardware          : x86
Issue type        : kbprb
Solution Type     : kbcode</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  August 29, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
