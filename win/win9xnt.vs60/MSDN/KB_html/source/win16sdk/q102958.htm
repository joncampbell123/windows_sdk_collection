

<HTML>
<HEAD>
<TITLE>PRB: Passing Modified Environments to Child Processes </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q102958">
<META NAME="KBModify" CONTENT="1997/07/23">
<META NAME="KBCreate" CONTENT="1993/08/12">
<META NAME="Keywords" CONTENT="kb16bitonly">
<META NAME="KBArea" CONTENT="Support; KB; win16sdk">
<META NAME="Description" CONTENT="  Your application causes a general protection (GP) fault when starting to run under Windows.  CAUSE =====  To provide a new environment for Windows-based applications, the LoadModule() function must be used. LoadModule() is similar to the MS-DOS Int...">
<META NAME="Product" CONTENT="Win16 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAX1,QAHC,QBKN,QDL9,QBWO,QBWN,QAH6,QAIJ,QBXS,QAH7,QAD7,QAJH,QBWQ,QAH4,QBWS V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: Passing Modified Environments to Child Processes</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 23, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q102958</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
3.10
WINDOWS
kbprg kbprb kbcode
<P>
 
The information in this article applies to:

<UL><LI>Microsoft Windows Software Development Kit (SDK) for Windows
   version 3.1
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Your application causes a general protection (GP) fault when starting
to run under Windows.
<P>
<P><h2>CAUSE</h2>
 
<P>
To provide a new environment for Windows-based applications, the
LoadModule() function must be used. LoadModule() is similar to the MS-DOS
Interrupt 21h Function 4Bh call, which uses a structure to find the new
environment.
<P>
The element "envseg" must be set to the selector of a memory block
that contains a correctly formatted environment block. The loader
makes a copy of this memory block for the child process inside
LoadModule(). This copy is formatted similar to an MS-DOS 2.x environment
block. It does not have the MS-DOS versions 3.x and later additional
information, such as the full pathname of the task, attached to the end. If
startup code (such as the Microsoft C run time earlier than C/C++ version
7.0) looks for this additional information, a general protection (GP) fault
will occur. If you are certain that the task started via LoadModule() does
not make this assumption, then it is safe to use it.
<P>
Another bug with LoadModule() is the ownership of the copied memory created
by the loader. It's set to that of the parent, and therefore it needs to
outlive the child or its environment block will be freed when the parent
terminates.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
If it's necessary to provide a modified environment to MS-DOS-based
applications, the supported technique is to use an MS-DOS batch file. The
batch file first sets the new environment settings and then starts the
MS-DOS-based application.
<P>
<PRE>   SET FOOS=BALL
   DOSAPP

</PRE>If the application being started is not a Windows-based application, the
.BAT file technique is the only supportable method.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
Regarding using LoadModule(), below is sample code that passes the current
task's environment as envseg:
<P>
<P><h3>Sample Code</h3>
 
<P>
<PRE>   typedef struct tagCMDSHOW
   {
     WORD wFirst;
     WORD wSecond;
   }
   CMDSHOW;

   typedef CMDSHOW FAR * LPCMDSHOW ;

   typedef struct tagPARAMETERBLOCK
   {
     WORD      wEnvSeg;
     LPSTR     lpCmdLine;
     LPCMDSHOW lpCmdShow;
     DWORD     dwUnused;
   }
   PARAMETERBLOCK;

   typedef PARAMETERBLOCK FAR * LPPARAMETERBLOCK ;

   CMDSHOW        CmdShow;
   PARAMETERBLOCK ParameterBlock;
   char           szCmdName[] = "TASKMAN.EXE";
   char           szCmdLine[] = "";

   ParameterBlock.wEnvSeg            = HIWORD(GetDosEnvironment());
   ParameterBlock.lpCmdLine          = szCmdLine;
   ParameterBlock.lpCmdShow          = &amp;CmdShow;
   ParameterBlock.lpCmdShow-&gt;wFirst  = 2;
   ParameterBlock.lpCmdShow-&gt;wSecond = SW_SHOW;
   ParameterBlock.dwUnused           = NULL;

   LoadModule(szCmdName, &amp;ParameterBlock);
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 3.10 spawn<BR>
KBCategory: kbprg kbprb kbcode<BR>
KBSubcategory: KrTsksIns<BR>
Keywords            : kb16bitonly<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 23, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
