

<HTML>
<HEAD>
<TITLE>SAMPLE: Port Trapping in Windows 3.0/3.1 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q100947">
<META NAME="KBModify" CONTENT="1996/02/15">
<META NAME="KBCreate" CONTENT="1993/06/30">
<META NAME="Keywords" CONTENT="kbprg kbfile">
<META NAME="KBArea" CONTENT="Support; KB; win16sdk">
<META NAME="Description" CONTENT="  In enhanced mode Windows, the I/O permission bitmap (IOPM) is used by the virtual machine manager (VMM) to determine whether I/O is permitted at a given I/O port. The IOPM is clear when the VMM is initialized, which means that any I/O port can be a...">
<META NAME="Product" CONTENT="Win16 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAKG,QDJP,QDL9,QBWO,QBWN,QBWG,QAI5,QBW7,QBWQ,QA5W,QANY,QABB,QAPF,QALG,QADK V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>SAMPLE: Port Trapping in Windows 3.0/3.1</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 15, 1996</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q100947</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Microsoft Windows Software Development Kit (SDK), versions 3.0
   and 3.1
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
In enhanced mode Windows, the I/O permission bitmap (IOPM) is used by
the virtual machine manager (VMM) to determine whether I/O is
permitted at a given I/O port. The IOPM is clear when the VMM is
initialized, which means that any I/O port can be accessed. VxDs can
trap specific I/O ports to prevent direct access. Therefore, unless a
VxD traps a port, direct I/O access is permitted. In standard mode,
the IOPM is not used, so direct I/O access is always permitted. This
does not apply to Windows NT.
<P>
The sample IOPORT.ZIP lists ports trapped by the standard VxDs
included in enhanced mode Windows (IOPMPORT.XLS and IOPMPORT.TXT), and
an MS-DOS program IOPM.EXE, which lists all currently trapped ports.
Also, the DT (dump TSS) command in WDEB386 lists all currently trapped
ports.
<P>
Download IOPORT.EXE, a self-extracting file, from the Microsoft Software
Library (MSL) on the following services:

<UL><LI>Microsoft Download Service (MSDL)
<P><PRE>      Dial (206) 936-6735 to connect to MSDL
      Download <A href="http://support.microsoft.com/download/support/mslfiles/ioport.exe">IOPORT.EXE</A> <I>(size: 23176 bytes)</I> 
</PRE>
<LI>Internet (anonymous FTP)
<P><PRE>      ftp ftp.microsoft.com
      Change to the \SOFTLIB\MSLFILES directory
      Get <A href="http://support.microsoft.com/download/support/mslfiles/ioport.exe">IOPORT.EXE</A> <I>(size: 23176 bytes)</I> 
</PRE><P>
</UL><h2>MORE INFORMATION</h2>
 
<P>
The IOPM is contained in the task state segment (TSS). The I/O
privilege level (IOPL) and the I/O permission bitmap determine whether
a task is allowed to perform I/O. The IOPL determines the minimum
privilege level required to perform I/O without checking the
permission bitmap. For example, if IOPL = 1, then a procedure must
have a code privilege level (CPL) of 1 or 0 (zero) to perform
unrestricted I/O. However, if the CPL of the current task is greater
than the IOPL, or the processor is operating in virtual 8086 mode,
then the I/O permission bitmap is checked to determine whether I/O is
permitted at the requested port.
<P>
In enhanced mode Windows, CPL is always greater than IOPL, so the IOPM
is always checked to determine whether direct I/O access is permitted.
In standard mode, CPL equals IOPL, so the IOPM is never checked.
<P>
Each bit in the bitmap corresponds to an I/O port byte address. For
example, the bit for port address 60 (decimal) corresponds to the 60th
bit, or the 4th bit in the 8th byte of the bitmap. In enhanced mode
Windows, the bitmap is always 8192 bytes, and the bitmap is
initialized to allow I/O at any port.
<P>
When a VxD is initialized, it can call Install_IO_Handler to trap
specific I/O ports. Install_IO_Handler sets the corresponding bits in
the IOPM. When a trapped port is accessed, the VxD I/O handler will
take over and perform the appropriate action. Windows maintains a
single TSS for all VMs. When a VM switch occurs, the TSS IOPM is
updated to reflect the local IOPM of the incoming VM. Port trapping
for a specific port may be disabled locally or globally from a VxD by
calling Disable_Local_Trapping or Disable_Global_Trapping.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 3.10 softlib IOPORT.ZIP<BR>
KBCategory: kbprg kbfile<BR>
KBSubcategory: KrDll<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 15, 1996</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
