

<HTML>
<HEAD>
<TITLE>SAMPLE: DDRM.EXE: Mixing 2D DirectDraw Objects With Direct3D </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q152646">
<META NAME="KBModify" CONTENT="1997/09/05">
<META NAME="KBCreate" CONTENT="1996/06/19">
<META NAME="Keywords" CONTENT="Direct3D kbfile kbgraphic kbprg">
<META NAME="KBArea" CONTENT="Support; KB; win32sdk">
<META NAME="Description" CONTENT="  The DDRM sample demonstrates one method of combining 2D objects on a DirectDraw surface, such as a background, with Direct3D Retained Mode. It also demonstrates how to lock the primary surface's palette down and how to force Retained Mode to utiliz...">
<META NAME="Product" CONTENT="Win32 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAPG,QAG9,QA5W,QAXB,QAPF,QAH1,QAVZ,QAGY,QAA1,QACJ,QAU4,QAPN,QDI2,QBVV,QBD2 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>SAMPLE: DDRM.EXE: Mixing 2D DirectDraw Objects With Direct3D</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 5, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q152646</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
4.00
WINDOWS
kbprg kbgraphic kbfile
<P>
 
The information in this article applies to:

<UL><LI>Microsoft DirectX 2 Software Development Kit (SDK), for Windows 95
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
The DDRM sample demonstrates one method of combining 2D objects on a
DirectDraw surface, such as a background, with Direct3D Retained Mode. It
also demonstrates how to lock the primary surface's palette down and how to
force Retained Mode to utilize what is in the palette and leave the entries
in it unchanged. Since the palette will not change, the pixels of the 2D
objects you create will not have to change. This sample renders to a full
screen, 8 bit-per-pixel DirectDraw surface using double buffering.
<P>
<PRE>You can find <A href="http://support.microsoft.com/download/support/mslfiles/ddrm.exe">DDRM.EXE</A> <I>(size: 59165 bytes)</I> 
                     , a self-extracting file, on these services:

</PRE><LI>Microsoft's World Wide Web site on the Internet
<P><PRE>      On the www.microsoft.com home page, click the Support icon
      Click Knowledge Base, and select the product
<PRE></PRE>      Enter kbfile <A href="http://support.microsoft.com/download/support/mslfiles/ddrm.exe">DDRM.EXE</A> <I>(size: 59165 bytes)</I> 
                           , and click GO!
      Open the article, and click the button to download the file

</PRE><LI>Internet (anonymous FTP)
<P><PRE>      ftp ftp.microsoft.com
      Change to the Softlib/Mslfiles folder
      Get <A href="http://support.microsoft.com/download/support/mslfiles/ddrm.exe">DDRM.EXE</A> <I>(size: 59165 bytes)</I> 
</PRE><P>
</UL>- Microsoft Download Service (MSDL)
<PRE>      Dial (206) 936-6735 to connect to MSDL
      Download <A href="http://support.microsoft.com/download/support/mslfiles/ddrm.exe">DDRM.EXE</A> <I>(size: 59165 bytes)</I> 

</PRE>For additional information about downloading, please see the following
article in the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../zmiscellaneous/q119591.htm">Q119591</A></B>
   TITLE     : How to Obtain Microsoft Support Files from Online Services

</PRE><h2>MORE INFORMATION</h2>
 
<P>
The DDRM sample creates a 640x480 primary surface with one back buffer. It
also creates a 640x480 offscreen surface, on which it stores a 2D bitmap
image. A palette is created for the 2D image and the palette is associated
with both the back buffer and the front buffer. It is necessary to
associate the palette with the back buffer because the back buffer will be
rendered to by Retained Mode. To lock down the palette, you must set the
peFlags member of the PALETTEENTRY structure for all palette entries to
D3DPAL_READONLY. This will let Retained Mode know that it can use but not
change the entries in the palette.
<P>
After obtaining a handle to the back buffer, a 16BPP z-buffer is created
and attached to it. SetPalette() is called to attach the palette to the
back buffer, and a destination color key for blit operations is created for
the back buffer. The color key is palette index 255 (white), so when you
blit to the back buffer, all pixels that are 255 (white) on the surface
will be overwritten by the pixels on the surface you are blitting from. All
other pixels will be preserved. Following is manner in which the
destination color key is created:
<P>
<PRE>   DDCOLORKEY  ddck;
   ddck.dwColorSpaceLowValue = 255;
   ddck.dwColorSpaceHighValue = 255;
   lpDDSBack-&gt;SetColorKey(DDCKEY_DESTBLT, &amp;ddck);

</PRE>After this is done, CreateDeviceFromSurface() is called to create a
Retained Mode device for the back buffer.
<P>
When setting up the scene for the Retained Mode device, you must set the
background color to 255 (white). When doing this, anything you blit to the
back buffer will overwrite the background of the Retained Mode scene.
Calling SetSceneBackground(D3DRGB(1,1,1)) will set up the background
properly if white is the destination color key. It is important that only
the background in the 3D scene contain white pixels. You should choose a
background color (destination color key) you know will never be used on
your 3D objects.
<P>
Following is the sequence of steps to take to update and render the
display:
<P>
<PRE>   {
      HRESULT             ddrval;
      RECT                rcRect;
      DDBLTFX ddBltFx;

      rcRect.left = 0;
      rcRect.top = 0;
      rcRect.right = 640;
      rcRect.bottom = 480;

      // Clear the back buffer
      ZeroMemory(&amp;ddBltFx,sizeof(DDBLTFX));
      ddBltFx.dwSize = sizeof(DDBLTFX);
      ddBltFx.dwFillColor = 255;
      lpDDSBack-&gt;Blt(NULL,NULL,NULL,DDBLT_COLORFILL | DDBLT_WAIT;
      ,&amp;ddBltFx);

      // Update the 3D Retained Mode scene
      scene-&gt;Move(D3DVALUE(1.0));
      view-&gt;Clear();
      view-&gt;Render(scene);
      rmdev-&gt;Update();

      // Use DDBLTFAST_DESTCOLORKEY to blit the 2D bitmap image onto the
      // scene, only updating the white pixels
      while( (ddrval = lpDDSBack-&gt;BltFast( 0, 0, lpDDSOne, &amp;rcRect,
                    DDBLTFAST_DESTCOLORKEY ) ) == DDERR_WASSTILLDRAWING );
      // Update the primary surface
      while(lpDDSPrimary-&gt;Flip( NULL,0 ) == DDERR_WASSTILLDRAWING);
   }

</PRE>NOTE: In this version of Direct3D, you should not change the palette on
your primary surface or your back buffer. Retained Mode will not account
for the palette entry changes. Microsoft is aware of this problem. The DDRM
sample demonstrates this problem by allowing you to change the palette
while it is executing.
<P>
<P><h2>REFERENCES</h2>
 
<P>
DirectDraw code from portions of the DDEX3 sample was used in parts of
this sample.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 4.00<BR>
KBCategory: kbprg kbgraphic kbfile<BR>
KBSubcategory: Direct3D<BR>
Keywords          : Direct3D kbfile kbgraphic kbprg<BR>
Technology        : kbDirectXSDK<BR>
Version           : 4.00<BR>
Platform          : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 5, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
