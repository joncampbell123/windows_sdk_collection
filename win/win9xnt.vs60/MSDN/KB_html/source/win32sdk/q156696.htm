

<HTML>
<HEAD>
<TITLE>BUG: EMF Playback into DC Causes Memory Leak in GDI </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q156696">
<META NAME="KBModify" CONTENT="1997/01/11">
<META NAME="KBCreate" CONTENT="1996/09/29">
<META NAME="Keywords" CONTENT="kbprg kbbuglist">
<META NAME="KBArea" CONTENT="Support; KB; win32sdk">
<META NAME="Description" CONTENT="  In Windows 95, when calling PlayEnhMetaFile() with a non-NULL clipping region selected into the DC, GDI fails to free a copy of the clipping region it creates, thereby causing a memory leak. This leaked resource is a system resource and will not be...">
<META NAME="Product" CONTENT="Win32 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABO,QAGI,QAKP,QAY4,QAKD,QAIM,QAKJ,QBVV,QAUR,QALZ,QABI,QDKW,QAU3,QAMR,QDL9 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: EMF Playback into DC Causes Memory Leak in GDI</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  January 11, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q156696</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Microsoft Win32 Software Development Kit (SDK) for Windows 95 4.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
In Windows 95, when calling PlayEnhMetaFile() with a non-NULL clipping
region selected into the DC, GDI fails to free a copy of the clipping
region it creates, thereby causing a memory leak. This leaked resource is a
system resource and will not be freed when the application exits.
<P>
<P><h2>CAUSE</h2>
 
<P>
When RestoreDC() is called, it copies the hMetaRgn value in the saved block
over the hMetaRgn value in the hDC. If the value in the save block is NULL
and the value in the hDC is not, the only reference to that region is lost
and the region is not freed. Instead, RestoreDC() should check for the
above case and free the region.
<P>
When PlayEnhMetaFile() is called, it calls the following functions:
SaveDC(), SetMetaRgn(), play EMF records, and RestoreDC(). This creates the
hMetaRgn if there is a clipping region in the hDC, and then fails to
release it.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
To work around this problem, render the Enhanced Metafile (EMF) unclipped
to a bitmap, and BitBlt() the image to the screen.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in the Microsoft products
listed at the beginning of this article. We are researching this problem
and will post new information here in the Microsoft Knowledge Base as it
becomes available.
<P>
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Steps to Reproduce Problem</h3>
 

<OL><P><LI>Take the GEN32 sample application and add code to open an .EMF and play
   it on the screen 10,000 times, each time with a region selected into the
   DC:
<P>
   for (i= 1 to 10,000)
   {
<P><PRE>       GetClipBox (&amp;rect)
</PRE><P>
<P><PRE>       hRegion = CreateRectRgnIndirect (&amp;rect);
       SelectClipRgn (hDC, hRegion);
</PRE><P>
<P><PRE>       PlayEnhMetaFile (hDC, hEMF, &amp;rcClient);
</PRE><P>
<P><PRE>      SelectClipRgn (hDC, NULL);
      DeleteObject (hRegion);
</PRE>   }

<P><LI>Use any utility to watch the GDI Resources.

<P><LI>Start the modified Gen32 created in step 1. Load the enhanced metafile
   and draw it 10,000 times. Notice that the gdi resources go down
   considerably.
<P></OL>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
KBCategory: kbprg kbbuglist<BR>
KBSubcategory: kbnocat<BR>
Additional reference words: 4.00 kbdsi
<P>


</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  January 11, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
