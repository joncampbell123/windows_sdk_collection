

<HTML>
<HEAD>
<TITLE>HOWTO: Add CRYPT_MACHINE_KEYSET Flag to CryptAcquireContext </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q161981">
<META NAME="KBModify" CONTENT="1997/10/28">
<META NAME="KBCreate" CONTENT="1997/01/09">
<META NAME="Keywords" CONTENT="BseCrypt">
<META NAME="KBArea" CONTENT="Support; KB; win32sdk">
<META NAME="Description" CONTENT="  In some situations, it is desirable to store Crypto Key material in a location of the registry other than the default location of HKEY_CURRENT_USER. The flag, CRYPT_MACHINE_KEYSET, when combined with CRYPT_NEW_KEYSET in CryptAcquireContext() accomp...">
<META NAME="Product" CONTENT="Win32 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QAHE,QAI5,QBW7,QDO3,QAGU,QBVV,QBWG,QDL9,QBWQ,QBWO,QBWN,QDJ2,QDMW,QBXS V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>HOWTO: Add CRYPT_MACHINE_KEYSET Flag to CryptAcquireContext</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  October 28, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q161981</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Win32 Application Programming Interface (API) for Windows NT,
   version 4.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
In some situations, it is desirable to store Crypto Key material in a
location of the registry other than the default location of
HKEY_CURRENT_USER. The flag, CRYPT_MACHINE_KEYSET, when combined with
CRYPT_NEW_KEYSET in CryptAcquireContext() accomplishes this.
CRYPT_MACHINE_KEYSET is available starting with Service Pack 2 (SP2) of
Windows NT 4.0.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
Crypto Key material is stored in HKEY_CURRENT_USER. If you logon to a
machine interactively, you will normally see two entries below the registry
key HKEY_USERS: .Default, and an entry similar to S-1-5-21-x-x-x-y which is
the SID of the interactively logged on user. If you are running a version
of Windows NT earlier than 4.0, and if you access HKEY_CURRENT_USER from a
service or from a user account that did not logon interactively, registry
access to HKEY_CURRENT_USER goes to HKEY_USERS\.Default, not to your user's
profile. Because of this, you are not able to access any user specific
Crypto Key material, which would normally be seen if the user logged on
interactively.
<P>
For SP2, the flag CRYPT_MACHINE_KEYSET has been added to
CryptAcquireContext(). This flag, when used in conjunction with the
CRYPT_NEWKEYSET flag, causes Crypto Keys to be stored under
HKEY_LOCAL_MACHINE instead of in the default location under
HKEY_CURRENT_USER. In addition, the security descriptor on the registry key
that holds the key set may now be retrieved and set with
CryptGetProvParam() and CryptSetProvParam() calls by using the
PP_KEYSET_SEC_DESCR value in the dwParam parameter.
<P>
Although the CRYPT_MACHINE_KEYSET flag was exposed in Windows NT 4.0
Service Pack 2, Windows developers do not yet have access to a version of
WINCRYPT.H that includes this flag. To take advantage of the functionality
that CRYPT_MACHINE_KEYSET offers add the following to your source code:
<P>
<PRE>   #ifndef CRYPT_MACHINE_KEYSET
   #define CRYPT_MACHINE_KEYSET  0x00000020
   #endif
</PRE> 
<PRE>Keywords          : BseCrypt
Version           : WINDOWS NT:4.0;
Platform          : NT WINDOWS
Issue type        : kbhowto</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  October 28, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
