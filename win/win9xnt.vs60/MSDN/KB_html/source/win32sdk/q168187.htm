

<HTML>
<HEAD>
<TITLE>BUG: recv() Causes Data Corruption of Large Buffer </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q168187">
<META NAME="KBModify" CONTENT="1998/01/15">
<META NAME="KBCreate" CONTENT="1997/05/07">
<META NAME="Keywords" CONTENT="BseMm NtwkWinsock kbbuglist">
<META NAME="KBArea" CONTENT="Support; KB; win32sdk">
<META NAME="Description" CONTENT="  Data buffers passed to the Windows Sockets recv() function have the potential to lose the data they contain. This problem only affects buffers passed to recv(). Data buffers manipulated solely by the application or by API's other than recv() are no...">
<META NAME="Product" CONTENT="Win32 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAEF,QBWA,QDL9,QBWO,QBWN,QAYY,QA8N,QALQ,QBW6,QBXI,QAKP,QBWQ,QAY5,QAW5,QAL3 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: recv() Causes Data Corruption of Large Buffer</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  January 15, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q168187</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Win32 Application Programming Interface (API) included with:
   - Microsoft Windows 95
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Data buffers passed to the Windows Sockets recv() function have the
potential to lose the data they contain. This problem only affects buffers
passed to recv(). Data buffers manipulated solely by the application or by
API's other than recv() are not affected by this problem.
<P>
<P><h2>CAUSE</h2>
 
<P>
The recv() function accepts a buffer to be filled with data received over a
socket connection. For memory management purposes, the system may discard
portions of such a buffer to allow other memory activity of the system to
proceed successfully. When the system does this, it first checks the memory
page's "dirty" bit to determine if the page should be written to the paging
file before being discarded. When the memory is later needed, it is
retrieved from the paging file intact.
<P>
The memory pages touched by recv() are supposed to be marked "dirty" when
modified so that the pages will be properly written to the system paging
file before the memory is discarded. In Windows 95, the pages are not
marked "dirty." This causes the pages to be discarded without first being
written to the paging file. When the data is later needed by the
application, it is treated like newly-allocated zero-initialized memory.
Such data received over the socket connection earlier is now lost.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
There is no absolutely effective workaround to this problem.
<P>
One thing that may work is to use small buffers with the recv() function.
This reduces the risk that some portion of the buffer will need to be
swapped out and subsequently lost. Note that this reduces the risk but
doesn't completely alleviate it.
<P>
Alternatively, a program may dirty each page manually just before or after
calling recv(). A program can dirty each page by writing data to one of the
bytes in each page. The system page size on Windows 95 is 4096 (4K) bytes
so a program only needs to touch a single byte in each 4K section of the
buffer. This causes the pages to be properly written to the paging file
before the memory is discarded, if necessary. The only drawback to this
method is that there is no way to determine when a page will be paged out.
If a page is paged out at an inopportune time, then the data it contains
may be lost.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products listed
at the beginning of this article. We are researching this bug and will post
new information here in the Microsoft Knowledge Base as it becomes
available.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: winsock bse base<BR>
Keywords          : BseMm NtwkWinsock kbbuglist<BR>
Version           : 95<BR>
Platform          : NT WINDOWS<BR>
Issue type        : kbbug<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  January 15, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
