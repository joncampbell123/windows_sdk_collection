

<HTML>
<HEAD>
<TITLE>PRB: DLL Load Fails Under Win32s When Apps Share a DLL </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q131224">
<META NAME="KBModify" CONTENT="1997/01/06">
<META NAME="KBCreate" CONTENT="1995/06/06">
<META NAME="Keywords" CONTENT="kbprg kbprb">
<META NAME="KBArea" CONTENT="Support; KB; win32sdk">
<META NAME="Description" CONTENT="   LoadLibrary fails under Win32s in the following situation:  1. App1 is executed and loads MYDLL.DLL.  2. App2 is executed and loads MYDLL.DLL as well.  3. App1 is terminated and unloads MYDLL.DLL.  App2 can GP fault when MYDLL.DLL is accessed. In ...">
<META NAME="Product" CONTENT="Win32 SDK">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QDNN,QBWP,QANG,QA7H,QA3A,QBHQ,QDL9,QBWQ,QBWO,QBWN,QAYL,QAJQ,QBW6,QBVV,QBFY V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: DLL Load Fails Under Win32s When Apps Share a DLL</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  January 6, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q131224</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Microsoft Win32s versions 1.30, 1.30a, 1.30c
</UL> 
<P>
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
LoadLibrary fails under Win32s in the following situation:

<OL><P><LI>App1 is executed and loads MYDLL.DLL.

<P><LI>App2 is executed and loads MYDLL.DLL as well.

<P><LI>App1 is terminated and unloads MYDLL.DLL.
<P>
</OL>App2 can GP fault when MYDLL.DLL is accessed. In addition, if App1 is
restarted and attempts to load MYDLL.DLL, the call to LoadLibrary fails and
GetLastError reports ERROR_DLL_INIT_FAILED.
<P>
This problem does not occur under Windows NT or Windows 95.
<P>
<P><h2>CAUSE</h2>
 
<P>
By default, Visual C++ creates a DLL that statically links to the C Run-
time (CRT) using either the LIBC.LIB or LIBCMT.LIB file to resolve external
symbols depending on whether single-threaded (/ML option) or multi-threaded
(/MT option) version was used. This version of the CRT library is not
compatible with Win32s. Problems occur when global data for the CRT is
initialized, because of the shared address space under Windows.
<P>
The static CRT library uses global variables to manage memory allocations.
In the scenario above, App2 can fault when allocating memory, if the global
variables used to access memory refer to memory that was allocated App1
which has since terminated, because the allocated memory was returned to
the heap.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Use the /MD (Multithreaded using CRT in a DLL) option when compiling the
DLL and add the MSVCRT.LIB import library to the library list. Include the
Win32s version of MSVCRT20.DLL or MSVCRT40.DLL which is included in Visual
C++ 2.x or 4.x(it is redistributable) in your project. Then the DLL will
use the DLL version of the CRT libraries that is compatible with Win32s and
the problem will not occur.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
When a DLL that uses the CRT is loaded into memory, all global variables
for the DLL and for the CRT libraries are initialized. Under Windows NT and
Windows 95, the application is given its own copy of the global data for
the DLL. When other applications use the same DLL, they each receive their
own copy of the global variables as well. This eliminates conflicts,
because the data is not shared.
<P>
Under Win32s, DLLs are loaded into the same shared memory space and all
global variables for a DLL are shared. This means that the CRT global data
is also shared. The version of MSVCRT20.DLL that targets Win32s was written
to take this into account and avoid conflicts.
<P>
The Windows NT/Windows 95 version of MSVCRT20.DLL or MSVCRT40.DLL can be
found in the MSVC20\REDIST or MSVC40\REDIST directory of the CD. The Win32s
version can be found in the WIN32S\REDIST directory.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
KBCategory: kbprg kbprb<BR>
KBSubcategory: W32s<BR>
Additional reference words: 1.30 1.30a 1.30c<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  January 6, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
