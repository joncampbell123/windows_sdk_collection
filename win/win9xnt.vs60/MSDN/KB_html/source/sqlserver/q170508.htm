

<HTML>
<HEAD>
<TITLE>FIX: Blocking Lock Remains or Server Stops After Heavy Deadlock </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q170508">
<META NAME="KBModify" CONTENT="1997/12/19">
<META NAME="KBCreate" CONTENT="1997/06/23">
<META NAME="Keywords" CONTENT="kbbug6.00 kbbug6.50 SSrvGen SSrvLock kbfix6.50.sp4 kbusage">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QAA8,QABT,QAR4,QDO3,QBVV,QAGB,QAK7,QAKP,QDKW,QAJ6,QABA,QAJQ,QBVZ,QBFY V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Blocking Lock Remains or Server Stops After Heavy Deadlock</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  December 19, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q170508</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
----------------------- --------------------------------------
The information in this article applies to:

<UL><LI>Microsoft SQL Server, versions 6.0 and 6.5
</UL> 
BUG #: 16986 (6.5)
<PRE>       15716 (6.0)

</PRE><h2>SYMPTOMS</h2>
 
<P>
Under heavy deadlock conditions, certain locking patterns may cause
blocking locks to remain. This may appear as a spid exiting without lock
cleanup. For example a spid holding blocking locks may be KILLed or exit,
yet the locks it held may remain and continue to block others. Afterwards
sp_who may show the blocking spid as a newly-logged in process that holds
no locks in the database, yet is blocking others.
<P>
This condition may infrequently occur on SQL Server builds 6.00.121 through
6.50.258. The sysprocesses.waittype for the blocked or blocking spids is
usually 0x8003 (waiting on exclusive intent lock) or 0x8004 (waiting on
shared intent lock). In some cases, a blocking spid may have a 0x8003 or
0x8004 waittype (hence not running, and will continue blocking others), yet
not itself be blocked as indicated by sysprocesses.blocked. Less
frequently, the server may stop responding following this occurrence.
<P>
Killing blocked spids under these conditions can cause the debug assertions
described below (taken from SQL Server build 6.50.255).
<P>
SQL Server version 6.0 does not have assertions, but the overall behavior
is similar. On SQL Server 6.0, sometimes you will see sysprocesses.blocked
having an irrational value such as 4832. The best way to identify this
problem on SQL Server 6.5 is to run a debug server, watch for abnormal
blocking behavior, and observe whether the following assertions occur:
<P>
<PRE>   Location: lockmgr.c: 5903
   Expression: lo
   Spid: 11
   Description: pss not found on the wait list

   Location: lockmgr.c: 2317
   Expression: pss-&gt;pssnext==NULL
   Spid: 11

</PRE>For more information on what constitutes normal or abnormal blocking, see
the following article in the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../sqlserver/q162361.htm">Q162361</A></B>
   TITLE     : Understanding and Resolving SQL Server Blocking Problems

</PRE><h2>WORKAROUND</h2>
 
<P>
To work around this problem, use standard techniques to reduce locking
contention and deadlocks. This can include shortening the transaction path
length, using lower transaction isolation levels, eliminating extraneous
indexes, or ensuring that transactions acquire locks in the same order.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SQL Server versions 6.0 and
6.5.
This problem was corrected in the latest Microsoft SQL Server 6.5 U.S.
Service Pack. For information on obtaining the service pack, query on
the following word in the Microsoft Knowledge Base (without the spaces):
<P>
<PRE>   S E R V P A C K
</PRE> 
<PRE>Keywords          : kbbug6.00 kbbug6.50 SSrvGen SSrvLock kbfix6.50.sp4 kbusage
Version           : 6.0 6.5
Platform          : WINDOWS
Issue type        : kbbug
Solution Type     : kbworkaround</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  December 19, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
