

<HTML>
<HEAD>
<TITLE>BUG: SELECT INTO Temp Tables w/Identity Columns May Cause Errors </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q180102">
<META NAME="KBModify" CONTENT="1998/02/02">
<META NAME="KBCreate" CONTENT="1998/01/28">
<META NAME="Keywords" CONTENT="kbbug6.50 SSrvErr_Log SSrvLock SSrvTran_SQL">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG #: 17763 (6.5)   An error 3905 or 631 can occur if both of the following conditions are true:   - SELECT INTO is used to create temporary tables against tables with    identity columns in a user-defined transaction.     -and-   - A table with an ...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAAP,QAB4,QABM,QAKP,QAPN,QAE1,QA5V,QA2Q,QAY4,QBWS,QDMN,QBVV,QBF0,QA28,QATJ V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: SELECT INTO Temp Tables w/Identity Columns May Cause Errors</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 2, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q180102</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.5
</UL> 
BUG #: 17763 (6.5)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
An error 3905 or 631 can occur if both of the following conditions are
true:

<UL><LI>SELECT INTO is used to create temporary tables against tables with
   identity columns in a user-defined transaction.
<P>
   -and-

<LI>A table with an identity column is updated.
<P>
</UL><h2>WORKAROUND</h2>
 
<P>
To work around this problem, do either of the following:

<UL><LI>Remove the user-defined transaction and possibly use trace flag 5302 to
   avoid deadlocks in the tempdb database.
<P>
   -or-

<LI>Prevent the SELECT INTO statement from creating the temporary table with
   the identity column. You can do this by using the CONVERT function to
   convert the identity column to its datatype.
<P>
</UL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SQL Server version 6.5. We
are researching this problem and will post new information here in the
Microsoft Knowledge Base as it becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The following are the errors that would normally be seen in the SQL Server
errorlog when this problem occurs:
<P>
<PRE>   Error : 631, Severity: 21, State: 1
   The length of 35 passed to delete row routine for the row at offset 1946
   is incorrect on the following page: Page pointer = 0x1016800, pageno =
   319, status = 0x111, objectid = 3, indexid = 0

   Error : 602, Severity: 21, State: 3
   Could not find row in Sysindexes for dbid '2', object '1655676946',index
   '-1'. Run DBCC CHECKTABLE on Sysindexes.

   -or-

   Error : 3905, Severity: 21, State: 2
   Can't unsplit logical page 316 in object 'syscolumns' in database 'pubs'
   - row number 12 is used on both pages.

   Error : 602, Severity: 21, State: 3
   Could not find row in Sysindexes for dbid '2', object '98099390',index
   '-1'. Run DBCC CHECKTABLE on Sysindexes.

</PRE>Normally in this situation, the locks held by the client that caused the
error will not be cleaned up, and will still show in the sp_lock stored
procedure with a spid of -1. When this problem occurs, clients are unable
to create temporary tables, and you can only stop the SQL Server with the
SHUTDOWN WITH NOWAIT Transact-SQL statement.
<P>
The following is an example of how to avoid the temporary table being
created with the identity column property:
<P>
<PRE>   CREATE TABLE x
   (a int identity(1,1),
   b int)
   GO
   CREATE PROCEDURE sp_selectintoidentity AS
   SELECT Convert(int, a), b INTO #temp FROM x
   RETURN
   GO
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: syscolumns 602<BR>
Keywords          : kbbug6.50 SSrvErr_Log SSrvLock SSrvTran_SQL<BR>
Version           : WINNT:6.5<BR>
Platform          : winnt<BR>
Issue type        : kbbug<BR>
Solution Type     : kbworkaround<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 2, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
