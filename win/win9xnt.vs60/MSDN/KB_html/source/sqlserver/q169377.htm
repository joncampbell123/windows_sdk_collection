

<HTML>
<HEAD>
<TITLE>INF: How to Access SQL Server Within Active Server Pages </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q169377">
<META NAME="KBModify" CONTENT="1997/06/05">
<META NAME="KBCreate" CONTENT="1997/05/30">
<META NAME="Keywords" CONTENT="kbenv kbinterop kbtshoot SSrvProg">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="  This article describes how to establish connections to SQL Server within an ASP script using ActiveX Data Objects (ADO), while taking advantage of the connection pooling feature of ODBC 3.0.  MORE INFORMATION  Connection Pooling  Enable ODBC connec...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QDNQ,QAI5,QBG2,QABM,QA9E,QAN0,QADF,QAU9,QBVV,QAEB,QBXS,QAB4,QBWA,QA7H,QANG V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>INF: How to Access SQL Server Within Active Server Pages</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  June 5, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q169377</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, versions 4.2x, 6.0, and 6.5
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
This article describes how to establish connections to SQL Server within an
ASP script using ActiveX Data Objects (ADO), while taking advantage of the
connection pooling feature of ODBC 3.0.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Connection Pooling</h3>
 
<P>
Enable ODBC connection pooling. For general information on connection
pooling and instructions on how to enable this feature, see the following
article in the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../odbc/q164221.htm">Q164221</A></B>
   TITLE     : How to Enable Connection Pooling in an ODBC Application

</PRE><h3>ODBC DSN</h3>
 
<P>
Using the ODBC Administrator, create a System DSN on the computer where
Microsoft Internet Information Server (IIS) is installed. Specify the
connection attribute once and reuse it on every page. For example, in the
Session_OnStart event within Global.asa, define the connection attribute
as:
<P>
<PRE>   Session("ConnectionString") =
   "dsn=SQLSysDSN;uid=sa;pwd=;DATABASE=pubs;APP=ASP Script"

</PRE>Make sure all of the following conditions are true:

<UL><LI>The Trusted Connection box is not checked in the System DSN definition.

<LI>The SQL Server security mode is not Windows NT Integrated.

<LI>Within the connection attribute, the uid is not blank.
<P>
</UL>Otherwise, a connection to SQL Server may fail with the following message:
<P>
<PRE>   Microsoft OLE DB Provider for ODBC Drivers error '80004005'
   [Microsoft][ODBC SQL Server Driver][SQL Server]Login failed- User: _
   Reason: Not defined as a valid user of a trusted SQL Server connection.

</PRE><h3>Global.asa</h3>
 
<P>
Using the Global.asa file is optional. In its place, entries usually made
in this file can be put on the first page called by the application.
Assuming the ASP scripts are located in a directory that is not defined as
a virtual directory within the Internet Service Manger, but below another
virtual directory, the Global.asa file containing Session variables and DSN
definitions must be kept in the virtual directory. Otherwise, the following
message will be returned:
<P>
<PRE>   Microsoft OLE DB Provider for ODBC Drivers error '80004005'
   [Microsoft][ODBC Driver Manager] Data source name not found and no
   default driver specified

</PRE><h3>Connections in the ASP Script</h3>
 
<P>
Take advantage of connection pooling by opening and closing the connection
to the database on every active server page. To open the connection, type
the following statements in the &lt;Body&gt; section of the page:
<P>
<PRE>   &lt;%
   Set OBJdbConnection = Server.CreateObject("ADODB.Connection")
   OBJdbConnection.Open Session("ConnectionString")
   %&gt;

</PRE>To close the connection, put the following immediately after the &lt;/Body&gt;
tag:
<P>
<PRE>   &lt;%
   OBJdbConnection.Close
   Set OBJdbConnection = Nothing
   %&gt;

</PRE>You may encounter the following two error messages if the connection
settings are not properly defined as outlined above:

<UL><LI>Microsoft OLE DB Provider for ODBC Drivers error '80004005'
   [Microsoft][ODBC SQL Server Driver][DBNMPNTW]Connection broken.

<LI>Microsoft OLE DB Provider for ODBC Drivers error '80004005'
   [Microsoft][ODBC SQL Server Driver]Communication link failure
<P>
</UL>Below is a sample application that consists of Global.asa and Authors.asp.
This sample application will return four columns and all records in the
pubs table called authors.
<P>
<PRE>   Global.asa

   &lt;SCRIPT LANGUAGE=VBScript RUNAT=Server&gt;
   Sub Session_OnStart
   Session("ConnectionString") =
   "DSN=SQLSysDSN;UID=sa;PWD=;DATABASE=pubs;APP=ASP script"
      Session("ConnectionTimeout") = 15
      Session("CommandTimeout") = 30
   End Sub

   Sub Session_OnEnd

   End Sub
   &lt;/SCRIPT&gt;

   Authors.asp

   &lt;HTML&gt;
   &lt;HEAD&gt;
   &lt;TITLE&gt;All Authors&lt;/TITLE&gt;
   &lt;/HEAD&gt;
   &lt;BODY BGCOLOR="#FFFFFF"&gt;

   &lt;% Set OBJdbConnection = Server.CreateObject("ADODB.Connection")
   OBJdbConnection.ConnectionTimeout = Session("ConnectionTimeout")
   OBJdbConnection.CommandTimeout = Session("CommandTimeout")
   OBJdbConnection.Open Session("ConnectionString")
   Set SQLStmt = Server.CreateObject("ADODB.Command")
   Set RS = Server.CreateObject ("ADODB.Recordset")
   %&gt;

   &lt;p&gt;
   &lt;table border="0" bordercolor="#000000"&gt;
   &lt;%
   SQLStmt.CommandText = "select * from authors"
   SQLStmt.CommandType = 1
   Set SQLStmt.ActiveConnection = OBJdbConnection
   RS.Open SQLStmt

   Do While Not RS.EOF
   %&gt;
   &lt;TR&gt;
      &lt;TD Width = 150 ALIGN=LEFT&gt;
         &lt;FONT SIZE=+1&gt;
         &lt;%= RS("au_id") %&gt;
         &lt;/FONT&gt;&lt;/TD&gt;
      &lt;TD&gt;&lt;/TD&gt;
         &lt;TD Width = 150 ALIGN=LEFT&gt;
         &lt;FONT SIZE=+1&gt;
         &lt;%= RS("au_lname")  %&gt;
         &lt;/FONT&gt;&lt;/TD&gt;
      &lt;TD Width = 150 ALIGN=LEFT&gt;
         &lt;FONT SIZE=+1&gt;
         &lt;%= RS("au_fname")  %&gt;
         &lt;/FONT&gt;&lt;/TD&gt;
      &lt;TD Width = 150 ALIGN=LEFT&gt;
         &lt;FONT SIZE=+1&gt;
         &lt;%= RS("phone")  %&gt;
         &lt;/FONT&gt;&lt;/TD&gt;
   &lt;/TR&gt;
   &lt;%
   RS.MoveNext
   Loop
   %&gt;
   &lt;/table&gt;
   &lt;hr&gt;
   &lt;p&gt;
   &lt;/BODY&gt;
   &lt;% OBJdbConnection.Close
   Set OBJdbConnection = Nothing
   %&gt;
   &lt;/HTML&gt;

</PRE>For more information on Active Server Pages, refer to the Roadmap provided
by the ASP setup program on the IIS server.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: browser explorer web<BR>
Keywords            : kbenv kbinterop kbtshoot SSrvProg<BR>
Technology          : ODBC ASP<BR>
Version             : 4.2x 6.0 6.5<BR>
Platform            : WINDOWS<BR>
Issue type          : kbhowto<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  June 5, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
