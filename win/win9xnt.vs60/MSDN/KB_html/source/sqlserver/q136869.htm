

<HTML>
<HEAD>
<TITLE>PRB: SQLMail Functions Hang on MAPI Error </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q136869">
<META NAME="KBModify" CONTENT="1997/05/01">
<META NAME="KBCreate" CONTENT="1995/09/19">
<META NAME="Keywords" CONTENT="kbprg SSrvProg SSrvStProc">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="  In Microsoft SQL Server version 6.0, any SQLMail extended stored procedure that you execute hangs indefinitely and does not return any results. This occurd when a MAPI function encounters an error which causes it to present a dialog box to the user...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QAB4,QAL7,QAAP,QALZ,QA01,QBWS,QBWP,QAYC,QAA1,QDJO,QACK,QAB9,QBW5,QBV8 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: SQLMail Functions Hang on MAPI Error</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 1, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q136869</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, versions 4.21 and 6.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
In Microsoft SQL Server version 6.0, any SQLMail extended stored procedure
that you execute hangs indefinitely and does not return any results. This
occurd when a MAPI function encounters an error which causes it to present
a dialog box to the user. This problem could also affect alert
notifications, scheduled backup notifications, and anything else that
relies on the SQLMail extended stored procedures.
<P>
When this problem occurs, the MSSQLSERVER service may get into a state
where it cannot be shut down and the Windows NT machine must be rebooted in
order to get SQLMail functionality to work properly again.
<P>
<P><h2>CAUSE</h2>
 
<P>
Under some circumstances, the current implementation of MAPI will cause a
dialog box to appear on the desktop to indicate a MAPI error. When such a
MAPI error is encountered while SQLMail is running, it can cause all
SQLMail functions to hang until you click the OK button in the dialog box
on the SQL Server machine. If the MSSQLSERVER service is running under a
user account (or does not have permission to interact with the desktop),
the dialog box never appears on the screen and all SQLMail functions hang
until SQL Server is restarted (this may require restarting Windows NT if
the MSSQLServer service cannot be shut down).
<P>
Note, however, that other queries continue to execute normally on the
server. Only queries which call a SQLMail extended stored procedure
will hang.
<P>
The following two conditions are known to cause the MAPI error dialog box
(other MAPI errors could potentially cause the same symptoms):

<OL><P><LI> The mail .MMF file is stored on the post office server and the post
<P><PRE>    office server is rebooted after SQLMail has been started.
</PRE>
<P><LI> The mail .MMF is stored locally and the drive it is stored on runs out
<P><PRE>    of disk space.
</PRE><P>
</OL>The error message in the MAPI dialog box for both of the above
situations is the following (note that other MAPI error messages are
possible):
<P>
<PRE>   Mail is unable to save information to your message file. Check that the
   connection to your message file still exists and you have disk space
   available.

</PRE></OL><h2>WORKAROUND</h2>
 
<P>
Identify the MAPI error that is being returned in the dialog box and take
the appropriate steps to avoid that error by working with your primary
messaging support provider.
<P>
In order to see the MAPI dialog box on the server, the SQL Server process
must be run in a configuration that allows interaction with the desktop.
There are two methods of accomplishing this:

<OL><P><LI> Run SQL Server from the NT command prompt using the following command:
<P>
<P><PRE>       sqlservr -c
</PRE>
<P><LI> Set up the MSSQLServer service to run under the System account with the
<P><PRE>    option selected to "Allow service to interact with desktop." You can
    set this option in the Control Panel, Services application.
</PRE><P>
</OL>Note that when the SQL Server process is set up to run under the
System account, certain steps may be necessary to enable connectivity
to the mail post office. These steps are described in Chapter 18 of
the SQL Server version 6.0 "Administrator's Companion," and in the
Microsoft Knowledge Base article <B><A href="../sqlserver/q118501.htm">Q118501</A></B> - "INF: Troubleshooting SQLMail
Problems."
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: sql6 xp windows nt<BR>
Keywords            : kbprg SSrvProg SSrvStProc<BR>
Version             : 4.21 6.0<BR>
Platform            : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 1, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
