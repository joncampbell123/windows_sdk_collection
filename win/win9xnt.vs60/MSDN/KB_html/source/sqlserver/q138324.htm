

<HTML>
<HEAD>
<TITLE>FIX: RPC w/ Text/Image Parameters May Cause Handled AV </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q138324">
<META NAME="KBModify" CONTENT="1997/05/01">
<META NAME="KBCreate" CONTENT="1995/10/17">
<META NAME="Keywords" CONTENT="kbbug6.00 kbfix6.00.sp2 kbprg SSrvProg SSrvTran_SQL">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG# NT: 11373 (6.00)   A stored procedure created with a text/image parameter may cause a handled access violation (AV) when executed through dbrpcexec or Transact- SQL.  CAUSE =====  SQL Server fails to handle the text parameter properly when re-ma...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QAS1,QATX,QAMB,QAHE,QAB9,QAR4,QAKP,QALG,QAGI,QANY,QBF0,QAIF,QDNQ,QDIX V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: RPC w/ Text/Image Parameters May Cause Handled AV</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 1, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q138324</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.0
</UL> 
BUG# NT: 11373 (6.00)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
A stored procedure created with a text/image parameter may cause a
handled access violation (AV) when executed through dbrpcexec or Transact-
SQL.
<P>
<P><h2>CAUSE</h2>
 
<P>
SQL Server fails to handle the text parameter properly when re-mapping
stored procedure variables after the stored procedure was bumped out of
procedure cache.
<P>
It is only reproducible if the stored procedure is executed with the length
of the text/image parameter greater than 2048 bytes immediately after it
is reloaded into procedure cache.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
Because this would not happen the first time a stored procedure is loaded
into procedure cache, drop and recreate the stored procedure, which should
avoid the problem. Another way to avoid the problem would be to fake a call
to the stored procedure with the length of the text/image parameter that is
shorter than 2048 bytes, then call it with the real value. For example:
<P>
<PRE>   sp_recompile test_v
   go
   test_v_proc 1,'Fake one'
   go
   test_v_proc 1,'Real, longer then 2048 byte value'
   go

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Microsoft SQL Server
version 6.0. This problem was corrected in Service Pack 2 for SQL Server
version 6.0. For more information, contact your primary support provider.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The following script demonstrates the problem:
<P>
use pubs
go
create table test_v(c1 int, c2 text)
go
insert test_v values(1,'hdsgfhgffdg')
go
create proc test_v_proc
@v1 int,
@v2 text
as
update test_v set c2=@v2 where c1=@v1
go
test_v_proc 1,'First test'
go
sp_recompile test_v
go
<P>
test_v_proc 1,'New Data' &lt;----- This 'New Data' has to be over 2048 byte
go
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: sql6 windows nt sproc sp<BR>
Keywords            : kbbug6.00 kbfix6.00.sp2 kbprg SSrvProg SSrvTran_SQL<BR>
Version             : 6.0<BR>
Platform            : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 1, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
