

<HTML>
<HEAD>
<TITLE>FIX: Scheduled Backups Stop Working After 4/14/93 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q99113 ">
<META NAME="KBModify" CONTENT="1997/06/16">
<META NAME="KBCreate" CONTENT="1993/05/23">
<META NAME="Keywords" CONTENT="kbbug4.20a kbprg SSrvAdmin SSrvDB_Lib">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG# 8517 (4.20)   SQL Administrator scheduled backups will fail when the date is April 14, 1993, or later. Dump files are not produced and an error is not displayed.  CAUSE =====  When you add or modify a scheduled backup event using SQL Administrat...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAYZ,QALB,QACE,QA2Q,QAXB,QAG2,QABM,QBWS,QAU3,QAMR,QAY2,QDIU,QA3W,QAUR,QAGJ V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Scheduled Backups Stop Working After 4/14/93</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  June 16, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q99113 </B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:
<P>
<PRE>  - Microsoft SQL Server for OS/2, version 4.2
</PRE> 
BUG# 8517 (4.20)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
SQL Administrator scheduled backups will fail when the date is April
14, 1993, or later. Dump files are not produced and an error is not
displayed.
<P>
<P><h2>CAUSE</h2>
 
<P>
When you add or modify a scheduled backup event using SQL Administrator,
SQL Monitor uses the hard-coded date 8/1/92 for the Last_dump field of the
MSscheduled_backups table. The sp_MSbackup_now stored procedure is executed
once by SQL Monitor to determine which scheduled backups need to occur. If
any backup events have this 8/1/92 date as the Last_dump, and the date is
4/14/93 or later, the sp_MSbackup_now procedure fails and no scheduled
backups occur.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
Issue the following query from the MASTER database after any changes
or additions have been made to the list of scheduled backup events. It
updates the Last_dump column to yesterday, thus allowing the
sp_MSbackup_now stored procedure to complete.
<P>
<PRE>   update MSscheduled_backups
   set Last_dump = dateadd (day, -1, getdate())
   where datepart (year, Last_dump) = 1992

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SQL Server version
4.2a. This problem is corrected in SQL Server for OS/2 version 4.2b. You
can also correct the problem by running the replacement script below.
Simply copy this script to a file, and issue the following
command:
<P>
<PRE>   isql /Usa /P&lt;password&gt; /S&lt;server&gt; /i&lt;file&gt;

/*******************************************************************/
/* This stored procedure will get all the databases that need to   */
/* be dumped at the time of inquiry                                */
/*******************************************************************/
</PRE>use master
go
<P>
if exists (select * from sysobjects where name = "sp_MSbackup_now"
<PRE>    and sysstat &amp; 7 = 4)
</PRE>begin
<PRE>    drop procedure sp_MSbackup_now
</PRE>end
go
<P>
print ""
print "Creating sp_MSbackup_now"
print ""
go
create procedure sp_MSbackup_now as
declare @now datetime, @dayofweek smallint, @hour smallint,
<PRE>    @minute smallint,
</PRE>@elapsed int, @monthyear varchar(30)
<P>
set nocount on
<P>
<PRE>/* */
/* Get the current date and time. */
/* Parse out the relevant parts of the date */
/* */

</PRE>select @now = getdate()
select @dayofweek = datepart(weekday,@now)
select @monthyear = substring(convert(varchar(12),getdate()),1,12)
<P>
<PRE>/* */
/* Create a temporary table that holds data on what needs to be */
/* dumped */
/* */

</PRE>create table #spdumptab
(
<PRE>id      int         Not Null,   /* Unique identifier */
name    varchar(30) Not Null,   /* Name of database to be dumped */
owner   varchar(30) Not Null,   /* Name of the database owner */
ddump   varchar(30) Null,       /* Database dump device */
ldump   varchar(30) Null,       /* Log dump device */
datacntrltype   smallint    Null,           /* Control type */
logcntrltype    smallint    Null            /* Control type */
)

/* */
/* Check all the databases that are dumped daily, weekly, and */
/* biweekly */
/* Note: The dump can only occur if the start time(HH:MM) */
/* is &gt; the last dump &lt;= now */
/* */

</PRE>insert into #spdumptab
select Event_id, Database_name, Database_owner,Database_dump,
<PRE>    Log_dump,NULL,NULL
</PRE>from MSscheduled_backups
<PRE>where Enabled = 1                        /* Dump turned on */
    /* Dump today or Daily */
    and ((convert(smallint,Day) = @dayofweek) or Frequency = 1)
    /* Freq daily, weekly, or biweekly */
    and Frequency &lt;= 14
    /* Freq time has elapsed */
    and datediff(day, Last_dump, @now)
        &gt;= convert(smallint,Frequency)
    and @now &gt;= convert(datetime, @monthyear + Start_time)
    /* Freq time has elapsed */
    and datediff(hour, Last_dump, @now)
        &gt;= convert(smallint,Frequency)*24
    /* Freq time has elapsed */
    and datediff(minute, Last_dump, @now)
        &gt;= convert(smallint,Frequency)*24*60

/* */
/* Check all the databases that are dumped monthly */
/* Note: First we get this week number, then do the same criteria */
/* as the Daily, weekly, bi-weekly dump. */
/* The dump can only occur if the start time(HH:MM) is &gt; the */
/* last dump &lt;= now */
/* */

</PRE>declare @rundate datetime,
<PRE>    @weekno smallint     /* Get this week number */
</PRE>select @rundate = @now
select @weekno = 1
while datepart(month,dateadd(day,-7,@rundate)) = datepart(month,@now)
begin
<PRE>    select @weekno = @weekno + 1
    select @rundate = dateadd(day,-7,@rundate)
</PRE>end
<P>
insert into #spdumptab
select Event_id, Database_name, Database_owner,Database_dump,
<PRE>    Log_dump,NULL,NULL
</PRE>from MSscheduled_backups
<PRE>where Enabled = 1                       /* Dump turned on */
    /* Dump today */
    and (convert(smallint,Day) = @dayofweek)
    and Frequency &gt;= 31                 /* Freq monthly */
    /* Week of month */
    and (convert(smallint,Frequency) - 30) = @weekno
    /* Freq time has elapsed */
    and datediff(day, Last_dump, @now) &gt;= 30
    and @now &gt;= convert(datetime, @monthyear + Start_time)
    /* Freq time has elapsed */
    and datediff(hour, Last_dump, @now)
        &gt;= convert(smallint,Frequency)*24
    /* Freq time has elapsed */
    and datediff(minute, Last_dump, @now)
        &gt;= convert(smallint,Frequency)*24*60


</PRE>update #spdumptab set datacntrltype
<PRE>    = (select cntrltype from master..sysdevices s
    where #spdumptab.ddump = s.name)

</PRE>update #spdumptab set logcntrltype
<PRE>    = (select cntrltype from master..sysdevices s
    where #spdumptab.ldump = s.name)

</PRE>update #spdumptab set datacntrltype
<PRE>    = (select 5 from MSscheduled_backups s
    where #spdumptab.id = s.Event_id and s.Database_dump like '%+')

</PRE>update #spdumptab set logcntrltype
<PRE>    = (select 5 from MSscheduled_backups s
    where #spdumptab.id = s.Event_id and s.Log_dump like '%+')


</PRE>set nocount off
<P>
<PRE>/* */
/* Output the values to the daemon */
/* */

</PRE>select id = id, name = name, owner = owner, ddump = ddump,
<PRE>    ldump = ldump, dcntrl = datacntrltype, lcntrl = logcntrltype
    from #spdumptab
</PRE>go
<P>
<PRE>/************* DUMP THE TRANSACTION LOG ****************************/
/* Comment this out if you don't want your log dumped.  If you     */
/* rerun this script periodically, you will run out of             */
/* transaction log space.                                          */
</PRE>dump tran master with truncate_only
go
<PRE>/************* END DUMP THE TRANSACTION LOG ************************/
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: scheduled backup SQL Administrator SQL Monitor<BR>
dblib<BR>
Keywords            : kbbug4.20a kbprg SSrvAdmin SSrvDB_Lib<BR>
Version             : 4.2a<BR>
Platform            : OS/2<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  June 16, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
