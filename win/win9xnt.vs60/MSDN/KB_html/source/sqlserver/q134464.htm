

<HTML>
<HEAD>
<TITLE>FIX: DocErr: Recovering Master DB and Expanding MSDB Devices </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q134464">
<META NAME="KBModify" CONTENT="1997/04/30">
<META NAME="KBCreate" CONTENT="1995/08/07">
<META NAME="Keywords" CONTENT="kbbug6.00 kbfix6.00.sp3 kbtool SSrvAdmin SSrvDoc_Err">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG# NT: 11024 (6.00)   The intention of this article is to correct and expand on the Microsoft SQL Server version 6.0 documentation in the  Administrator's Companion,  Part 5 Data Management, Chapter 12 Backing Up and Restoring,  Restoring the maste...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QAZV,QAMA,QAB5,QAAP,QAOE,QBTP,QBXV,QAB4,QDNF,QAKP,QBFY,QALW,QAR4,QBVV V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: DocErr: Recovering Master DB and Expanding MSDB Devices</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  April 30, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q134464</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.0
</UL> 
BUG# NT: 11024 (6.00)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The intention of this article is to correct and expand on the Microsoft SQL
Server version 6.0 documentation in the "Administrator's Companion," Part 5
Data Management, Chapter 12 Backing Up and Restoring, "Restoring the master
Database." One of the early steps outlined in the procedure is to rebuild
the master Database. You should note that the master database rebuild
option found in the SQL Server Setup program will automatically recreate
the MSDB database with the MSDBData (MSDB.DAT) and the MSDBLog
(MSDBLOG.DAT) devices set at the default size of 2 MB each. This is
different from the sizes stated in the documentation, which says that
MSDBDATA will be 2 MB and MSDBLOG will be 1 MB.
<P>
The procedure for restoring the master database outlined in the
documentation details how the master database can be restored by loading
the database from the most recent backup. The master database backup
contains the definition of the size and location for the MSDBData and
MSDBLog database devices used by MSDB. You should expand MSDBData and/or
MSDBLog to the size as defined in the master database backup prior to
loading the backup. Failure to do so will result in SQL Server being unable
to open MSDBData and/or MSDBLog, which will subsequently result in the
failure to recover the MSDB database.
<P>
Another problem related to the failure of expanding these devices prior to
the load of a master database dump is a failure to load a previous dump of
the MSDB database. If the load of a previous backup of the MSDB database is
not attempted, an error is displayed when you try to add events for SQL
Executive. The specific error reported is that the MSDB database has not
been recovered yet. Also, the MSDB database appears in the Server Manager
window with the Database folder unavailable (greyed out).
<P>
<P><h2>WORKAROUND</h2>
 
<P>
The easiest way to resolve the problem is to repeat the steps to rebuild
the Master database/MASTER.DAT. After you recreate MASTER.DAT,
MSDBDATA.DAT, and MSDBLOG.DAT, start the SQL Enterprise Manager and alter
the respective MSDB database devices to the appropriate sizes, then shut
down SQL Server and restart it in 'single user' mode to load the Master
Database dump. If this is not an option or you have made changes to the
MSDB database that are not similar to the above scenarios, contact your
primary support provider for assistance.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in the documentation for
Microsoft SQL Server version 6.0. This problem has been corrected in U.S.
Service Pack 3 for Microsoft SQL Server version 6.0. For more information,
contact your primary support provider.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The following errors were generated after the MSDBData device and msdb
database system/default segments were expanded by 1Mb. The first error
occurs as SQL Server attempts to open the MSDB.dat device:
<P>
<PRE>95/07/25 10:09:10.59 kernel   udopen: File 'C:\SQL60\DATA\MSDB.DAT'
                        is incorrect size (1024 bytes, should be 1536)
95/07/25 10:09:10.62 kernel   udactivate (primary): failed to open
                        device C:\SQL60\DATA\MSDB.DAT for vdn 127
95/07/25 10:09:14.05 kernel   udread: Operating system error 6(The
                        handle is invalid.) on device
                        'C:\SQL60\DATA\MSDB.DAT' (virtpage 0x7f000018).

95/07/25 10:09:14.09 spid11   Error : 840, Severity: 17, State: 2
95/07/25 10:09:14.09 spid11   Device 'MSDBData' (with physical name
                        'C:\SQL60\DATA\MSDB.DAT', and virtual device
                        number 127) is not available.  Please contact
                        System Administrator for assistance.
95/07/25 10:09:14.10 spid11   Buffer a91dd8 from database 'msdb' has
                        page number 0 in the page header and page number
                        24 in the buffer header
95/07/25 10:09:14.17 spid11   Unable to proceed with the recovery of
                        dbid &lt;5&gt; because of previous errors.  Continuing
                        with the next database.

</PRE>If both the MSDBLog device and the log segment are expanded, the
following errors will occur:
<P>
<PRE>95/07/30 07:14:07.26 kernel   udopen: File 'C:\SQL60\DATA\MSDBLOG.DAT'
                        is incorrect size (1024 bytes, should be 1536)
95/07/30 07:14:07.26 kernel   udactivate (primary): failed to open
                        device C:\SQL60\DATA\MSDBLOG.DAT for vdn 126

95/07/30 07:14:11.07 spid11   Recovering database 'msdb'
95/07/30 07:14:11.07 kernel   udread: Operating system error 6(The
                        handle is invalid.) on device
                        'C:\SQL60\DATA\MSDBLOG.DAT' (virtpage
                        0x7e000107).
95/07/30 07:14:11.10 spid11   Error : 840, Severity: 17, State: 2
95/07/30 07:14:11.10 spid11   Device 'MSDBLog' (with physical name
                        'C:\SQL60\DATA\MSDBLOG.DAT', and virtual device
                        number 126) is not available.  Please contact
                        System Administrator for assistance.
95/07/30 07:14:11.12 spid10   Recovery dbid 4 ckpt (888,22)
95/07/30 07:14:11.10 spid11   Buffer a92058 from database 'msdb' has
                        page number 0 in the page header and page number
                        1287 in the buffer header
95/07/30 07:14:11.17 spid11   Error : 3414, Severity: 21, State: 1
95/07/30 07:14:11.17 spid11   Database 'msdb' (dbid 5): Recovery failed.
                        Please contact Technical Support for further
                        instructions.
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: sql6 windows nt recovery<BR>
Keywords            : kbbug6.00 kbfix6.00.sp3 kbtool SSrvAdmin SSrvDoc_Err<BR>
Version             : 6.0<BR>
Platform            : WINDOWS<BR>
Issue type          : kbdocerr<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  April 30, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
