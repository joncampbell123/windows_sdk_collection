

<HTML>
<HEAD>
<TITLE>INF: Testing Methods for SQL Server Tape Dumps or Loads </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q124023">
<META NAME="KBModify" CONTENT="1998/01/22">
<META NAME="KBCreate" CONTENT="1994/12/15">
<META NAME="Keywords" CONTENT="SSrvAdmin kbusage">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="NOTE: This article is specific to Microsoft SQL Server on Windows NT platforms.   The tape device subsystem is made up of several layers that are required for successful SQL Server database dump and load procedures. The primary level is the hardware ...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QBWP,QAB5,QABI,QAVX,QAVW,QADK,QAZV,QAB9,QAMA,QAAP,QAKP,QAA1,QAY2,QANE V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>INF: Testing Methods for SQL Server Tape Dumps or Loads</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  January 22, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q124023</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, versions 4.2x, 6.0, and 6.5
</UL> 
NOTE: This article is specific to Microsoft SQL Server on Windows NT
platforms.
<P>
<P><h2>SUMMARY</h2>
 
<P>
The tape device subsystem is made up of several layers that are required
for successful SQL Server database dump and load procedures. The primary
level is the hardware level, which is made up of the tape device, cable,
terminator, and SCSI controller. The kernel layer consists of the Windows
NT kernel, I/O Manager, file system driver, and the tape device driver. The
final layer is the user or application level. At this level, SQL Server
operates and depends on the operation of the underlying hardware and
operating system levels for successful completion of dump and load
operations to a tape device.
<P>
The purpose of this article is to document a method for testing the SQL
Server dump and load procedures with a tape drive. For additional
information on specific problems with SQL Server dumps or loads, see the
following article in the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../sqlserver/q123405.htm">Q123405</A></B>
   TITLE     : INF: How to Troubleshoot SQL Server Tape Read/Write
               Errors

</PRE><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Preliminary Checks</h3>
 

<OL><P><LI>Make sure that the specific tape device is on the hardware compatibility
   list (HCL). The devices on the HCL have been tested by Microsoft, at the
   request of the manufacturer, for use with the Windows NT operating
   system. Tape drive manufacturers frequently sell tape drives to original
   equipment manufacturer (OEM) vendors, and it is possible that the
   firmware for the repackaged drive has been changed, according to the
   request of the OEM vendor. These changes may result in problems with the
   operation of the tape device under Windows NT and/or SQL Server. As a
   result, even though the underlying tape drive may have been manufactured
   by a vendor on the HCL, the tape drive that has been repackaged and sold
   under a different vendor's label may have compatibility problems, due to
   the firmware changes.

<P><LI>Install the tape device according to the manufacturer's recommendations.
   Make sure you comply with the recommendations for the SCSI controller,
   SCSI cable length, and type of SCSI terminator.

<P><LI>Check with the vendor for changes in the driver being used for the tape
   device. Some vendors will provide tape drivers for use with Windows NT.
   Tape drives supplied by Compaq, which are not on the HCL, should use
   drivers from the Compaq-recommended software support disk (SSD). This is
   because the Compaq tape drive is solely supported by Compaq.

<P><LI>Verify that the tape device has been installed appropriately under
   Windows NT. The following are three areas to check to verify the tape
   device setup:
<P>
<P><PRE>    - For computers running Windows NT 3.5x, run Windows NT Setup, which
      is in the Main program group in Windows NT Program Manager. On the
      Options menu in Setup, click Add/Remove Tape Devices. A driver
      should be listed that matches the tape drive.
</PRE><P>
<P><PRE>      For computers running Windows NT 4.0, check the tape device driver
      in Control Panel Tape Devices.
</PRE><P>
<P><PRE>      NOTE: The manufacturer's documentation or the Windows NT
      documentation will provide details on which driver is appropriate
      for the tape drive attached to the system).
</PRE><P>
<P><PRE>    - In Control Panel Devices, the tape drive should be listed as
      Started and have a startup setting of System.
</PRE><P>
<P><PRE>    - Start Ntbackup.exe. On the Operations menu, click Hardware Setup.
      If the device has been properly set up, the tape drive will be
      visible in the drop down list box.
</PRE>
<P><LI>Test with Ntbackup.exe. Make sure that a successful archive and restore
   of a file or group of files can be accomplished without error.
<P>
   NOTE: It is important to perform both of these operations.
<P>
   Also view the tape catalog and perform an archive with a verification.
   If there are any problems with this procedure, the SQL Server dump and
   load to tape will either not work or not work reliably.

<P><LI>Use SQL Enterprise Manager to verify SQL Server's setup of the tape dump
   device. Go to a query window and execute the following stored procedure:
<P>
<P><PRE>      sp_helpdevice &lt;backup_device_name&gt;
</PRE><P>
   The result you receive should be in the following format, where X is the
   tape device number:
<P>
<P><PRE>      \\.\tapeX
</PRE><P>
   By default, the device numbers start with tape0...tapeX, depending on
   the number of tape devices found by NTDetect when the system starts up.
   Generally, on a system with a single tape drive, the system device
   identifier will be tape0, and the physical definition will be \\.\tape0.
<P>
   For SQL Server 4.2x, go to SQL Administrator, click Devices, then
   double-click the tape dump device. Make sure that the physical path is
   correct.
<P>
</OL><h3>Testing Procedures</h3>
 
<P>
NOTE: The following procedures must be tested by an Administrative login.
The purpose is to verify that the tape unit works, not the system rights
belonging to a particular login. So if the login for SQL Server has been
changed from the default, ensure that the login has Administrative
privileges.
<P>
Also, it is assumed that the database being used for the basic and advanced
tests have no structural problems. If the state of the database is unknown
or if it has not been checked recently, execute DBCC CHECKDB and DBCC
NEWALLOC.
<P>
Review the output of these DBCC checks and correct any structural problems
before attempting the following tests. Structural problems that exist in a
database at the time of the database dump to tape may cause a database load
from the tape device to fail.
<P>
<P><h3>Basic Testing Procedure</h3>
 

<OL><P><LI>Before beginning the procedure, use SQL Server Setup to disable
   automatic startup for SQL Server and SQLExecutive (or SQL Monitor for
   SQL Server 4.2x).

<P><LI>Turn the server off. Wait approximately 60 seconds, then turn the unit
   back on. If the server has an external tape drive, turn it on first and
   wait until it has completed initialization before turning the server on.
   This is an important step, because it resets the tape device back to the
   embedded default settings.

<P><LI>Start SQL Server and go to a command prompt.

<P><LI>Log in to SQL Server as system administrator (SA) and go to the ISQL/W
   query window.

<P><LI>Execute the following statements from the ISQL/W query window:
<P>
<P><PRE>      dump database pubs to tapedump with init,nounload
      go
</PRE><P>
   NOTE: Replace tapedump with the SQL Server logical name for the system
   being tested.
<P>
   You should receive the following message:
<P>
<P><PRE>      Msg 4029, Level 10, State 1:
      Database 'pubs' (89 pages) dumped to file &lt;1&gt; on tape 'SQ0001'.
</PRE><P>
   Review the SQL Server error log, which should have the following
   corresponding message:
<P>
<PRE>      94/02/01 15:49:08.83 kernel   Tape pubs SQ0001 mounted on tape
                                    drive \\.\TAPE0

</PRE><P><LI>Open the Backup or Dump device folder from SQL Enterprise Manager, and
   then open the tape backup device. Verify that the Volume Label and the
   dump Header are displayed.

<P><LI>Switch back to the ISQL/W query window and execute the following
   statements:
<P>
<P><PRE>      dump database pubs to tapedump with noinit,nounload
      go
      dump database pubs to tapedump with noinit,nounload
      go
</PRE><P>
   You should receive the following messages:
<P>
<P><PRE>      Msg 4029, Level 10, State 1:
      Database 'pubs' (89 pages) dumped to file &lt;2&gt; on tape 'SQ0001'.
      Msg 4029, Level 10, State 1:
      Database 'pubs' (89 pages) dumped to file &lt;3&gt; on tape 'SQ0001'.
</PRE><P>
   Review the SQL Server error log, which should have the following
   corresponding messages:
<P>
<PRE>      94/02/01 15:49:08.83 kernel   Tape pubs SQ0001 mounted on tape
                                    drive \\.\TAPE0
      94/02/01 15:50:18.83 kernel   Tape pubs SQ0001 mounted on tape
                                    drive \\.\TAPE0

   If the SQL Server error log does not contain these messages, review the
   previous steps and repeat if necessary. Go to the "Problem" section of
   this article.

</PRE><P><LI>Switch back to the ISQL/W query window and execute the following
   statements:
<P>
<P><PRE>      load database pubs from tapedump with file=2,nounload
      go
</PRE><P>
   Review the SQL Server error log, which should record results similar to
   the following:
<P>
<PRE>      94/02/01 15:49:08.83 server   Recovery dbid 4 ckpt (1017,8)

   NOTE: The information found in the error log may be different, depending
   on the dbid of the database the dump is loaded into. Additionally, the
   ckpt value in parenthesis is the location of the last checkpoint record
   that was found during the recovery process, so it may also vary.

</PRE><P><LI>Testing complete. If there are problems, see the "Problems" section of
   this article.
<P>
</OL><h3>Advanced Testing Procedure</h3>
 
<P>
This section details more extensive testing. Proceeding beyond this point,
an assumption is made that the tape system has been thoroughly tested with
NTBackup, which resulted in the successful completion of both archive and
restore procedures. It is recommended that you do not use production or
important development databases for testing unproved hardware.
<P>
The advanced testing procedure varies mainly in the size of the database
involved and its importance to the organization. If resources are
available, it is certainly appropriate to create a database that mirrors a
production or important development database in size and content for this
testing. It is also important to realize that at some point the production
or development database will need to be dumped to tape.
<P>
As a result, the following procedure has some built-in redundancy that is
illustrated by step 2. The following is the advanced testing procedure:

<OL><P><LI>Shut down SQL Server, either from the SQL Services Manager or from a
   command prompt by using a NET STOP MSSQLSERVER command (for SQL
   Server 4.2x, the command is NET STOP SQLSERVER).

<P><LI>Using Ntbackup.exe, archive ALL database device files, including
   Master.dat and any devices used for tempdb. This procedure MUST be
   performed with the Verify option of NTBackup.

<P><LI>Start SQL Server either through the SQL Services Manager or from a
   command prompt, with a NET START MSSQLSERVER command.

<P><LI>Perform steps 1-0 as listed in the "Basic Testing Procedure" section
   of this article, substituting the desired database for the 'pubs'
   database.
<P>
</OL><h3>Final Notes on Testing</h3>
 
<P>
The successful completion of the testing procedures outlined above does not
guarantee that there will never be problems with your SQL Server dump or
load operations to tape. SQL Server tape operations depend on the
successful operation of all underlying layers that make up the tape
subsystem, as well as a database that is free of structural problems.
<P>
<P><h3>Problems</h3>
 

<OL><P><LI>Review the system log of the Windows NT Event Viewer application
   (found under Administrative tools). Inspect it for any SCSI or tape
   device error.

<P><LI>Review the application log of the Windows NT Event Viewer application
   for any non-SQL Server errors.

<P><LI>Review the SQL Server error log.

<P><LI>Call the appropriate hardware vendor and verify that the problems seen
   have not been corrected by newer firmware versions or device drivers.

<P><LI>Correct any obvious issues and perform testing again.

<P><LI>Contact the appropriate vendor support.
<P>
</OL>When calling Microsoft SQL Server Support, be prepared to provide the
following information:

<UL><LI>The registry entries found in HKEY_LOCAL_MACHINE\Hardware\Devicemap
   for each tape device. Include the specifics regarding the number, type,
   and manufacturer of each SCSI controller, the number of devices on the
   SCSI Port, and SCSI Bus.

<LI>The file size, date, and time for the tape driver being used by the
   device in question.

<LI>Results from the test procedures detailed above, as well as the SQL
   Server error log, system log, and application log from the Event
   Viewer.

<LI>Specific tape drive make and model information (not who makes the
   internal components).

<LI>The results from executing sp_helpdevice and xp_msver.
<P></UL>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: test<BR>
Keywords          : SSrvAdmin kbusage<BR>
Version           : WINNT:4.2x 6.0 6.5<BR>
Platform          : winnt<BR>
Issue type        : kbtshoot<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  January 22, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
