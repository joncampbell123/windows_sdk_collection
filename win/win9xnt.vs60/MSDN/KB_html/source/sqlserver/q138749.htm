

<HTML>
<HEAD>
<TITLE>FIX: BEGIN TRAN After OPEN CURSOR May Not Commit </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q138749">
<META NAME="KBModify" CONTENT="1997/05/02">
<META NAME="KBCreate" CONTENT="1995/10/26">
<META NAME="Keywords" CONTENT="kbbug6.00 kbfix6.00.sp2 kbprg SSrvProg SSrvStProc">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG# NT: 11659 (6.00)   When using Transact-SQL cursors, if BEGIN TRAN is issued after OPEN CURSOR, and then the cursor is closed, there can be an open transaction that cannot be removed with COMMIT TRAN or ROLLBACK TRAN.  WORKAROUND  Call BEGIN TRAN...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAS1,QA2Q,QBWS,QDLB,QAG2,QAO2,QAKD,QAOX,QABM,QBFY,QACI,QA9N,QAY4,QAY2,QAXB V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: BEGIN TRAN After OPEN CURSOR May Not Commit</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 2, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q138749</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.0
</UL> 
BUG# NT: 11659 (6.00)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When using Transact-SQL cursors, if BEGIN TRAN is issued after OPEN
CURSOR, and then the cursor is closed, there can be an open transaction
that cannot be removed with COMMIT TRAN or ROLLBACK TRAN.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
Call BEGIN TRAN before you call OPEN CURSOR.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Microsoft SQL Server
version 6.0. This problem was corrected in Service Pack 2 for SQL Server
version 6.0. For more information, contact your primary support provider.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The following script demonstrates the problem:
<P>
set nocount on
go
print "This works correctly - open cursor after begin tran"
print "==================================================="
go
drop table A
go
create table A (col1 int primary key, col2 char(128),col3 int)
go
insert into A values (1,'d1',1)
insert into A values (2,'d2',2)
insert into A values (3,'d3',3)
insert into A values (4,'d4',4)
go
select 'Values before opening cursor'
select col1, col3 from A
go
declare c cursor for select * from a for update of col3
begin transaction
open c
fetch c
update a set col3=9 where current of c
close C
select 'Values after closing cursor but before ROLLBACK TRAN'
select col1, col3 from A
rollback transaction
select 'Values after closing cursor and after ROLLBACK TRAN'
select col1, col3 from A
deallocate c
go
print "This works incorrectly - open cursor before begin tran"
print "==================================================="
go
drop table A
go
create table A (col1 int primary key, col2 char(128),col3 int)
go
insert into A values (1,'d1',1)
insert into A values (2,'d2',2)
insert into A values (3,'d3',3)
insert into A values (4,'d4',4)
go
select 'Values before opening cursor'
select col1, col3 from A
go
declare c cursor for select * from a for update of col3
open c
begin transaction
fetch c
update a set col3=9 where current of c
close C
select 'Values after closing cursor but before ROLLBACK TRAN'
select col1, col3 from A
rollback transaction
select 'Values after closing cursor and after ROLLBACK TRAN'
select col1, col3 from A
deallocate c
go
print 'Now ROLLBACK TRAN has no effect on @@trancount'
go
select Trancount = @@trancount
go
print 'doing ROLLBACK TRAN'
GO
rollback tran
go
select Trancount = @@trancount
go
print 'doing ROLLBACK TRAN'
GO
rollback tran
go
select Trancount = @@trancount
go
print 'doing ROLLBACK TRAN'
GO
rollback tran
go
select Trancount = @@trancount
go
print 'doing ROLLBACK TRAN'
GO
rollback tran
go
select Trancount = @@trancount
go
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: SQL6 CURSOR TRANSACTION<BR>
Keywords            : kbbug6.00 kbfix6.00.sp2 kbprg SSrvProg SSrvStProc<BR>
Version             : 6.0<BR>
Platform            : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 2, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
