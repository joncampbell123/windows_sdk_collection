

<HTML>
<HEAD>
<TITLE>FIX: Undetected Deadlock with Checkpoint and SELECT INTO </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q163908">
<META NAME="KBModify" CONTENT="1997/06/27">
<META NAME="KBCreate" CONTENT="1997/02/19">
<META NAME="Keywords" CONTENT="kbbug6.50 kbother kbusage SSrvLock SSrvTran_SQL">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG #: 16592 (6.5)   When you SELECT INTO temporary tables with identity columns, you may experience undetected deadlocks with the Checkpoint Handler in the database tempdb, and neither client is chosen as a deadlock victim.  WORKAROUND  To work arou...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QBWS,QA2Q,QAR4,QBF0,QAY4,QAG2,QDKW,QAB9,QAKP,QBXS,QA9N,QARL,QACI,QAA8 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Undetected Deadlock with Checkpoint and SELECT INTO</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  June 27, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q163908</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.5
</UL> 
BUG #: 16592 (6.5)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you SELECT INTO temporary tables with identity columns, you may
experience undetected deadlocks with the Checkpoint Handler in the database
tempdb, and neither client is chosen as a deadlock victim.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
To work around this problem, do any of the following:

<UL><LI>Run SELECT INTO temporary tables outside of manual transactions.

<LI>Create the temporary table and then use INSERT SELECT instead.

<LI>Remove the identity property.

<LI>Use trace flag 5302 to disable holding locks on system tables.
<P>
</UL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Microsoft SQL Server
version 6.5. This problem has been corrected in U.S. Service Pack 3 for
Microsoft SQL Server version 6.5. For more information, contact your
primary support provider.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
You can detect this situation by using the sp_who stored procedure and
looking at the spid, status, command, and blocked columns. The following is
an example of what the sp_who output looks like:
<P>
<PRE>   Spid  Status      Command          Blocked
      4  Sleeping    Dump Transaction 10
      0  Sleeping    Insert           0

</PRE>Note that the spid 4 command changes from Checkpoint Handler to Dump
Transaction when the database is set to Truncate Log on Checkpoint (which
is always set for tempdb) and the Checkpoint Handler runs a checkpoint.
<P>
Additionally, if you run the sp_lock stored procedure, the blocking lock
held by the client will be an exclusive page lock on syscolumns.
<P>
Once this problem occurs, clients are unable to create temporary tables,
and you can only stop the SQL Server with the Transact-SQL command SHUTDOWN
WITH NOWAIT.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: global identity<BR>
Keywords            : kbbug6.50 kbother kbusage SSrvLock SSrvTran_SQL<BR>
Version             : 6.5<BR>
Platform            : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  June 27, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
