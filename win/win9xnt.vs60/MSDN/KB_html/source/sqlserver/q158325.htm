

<HTML>
<HEAD>
<TITLE>INF: Stored Procedures, Transactions, and Error 266 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q158325">
<META NAME="KBModify" CONTENT="1997/04/09">
<META NAME="KBCreate" CONTENT="1996/10/29">
<META NAME="Keywords" CONTENT="kbprg SSrvProg SSrvStProc SSrvTran_SQL">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="  If a stored procedure exits with the @@trancount value that is not the same as when the stored procedure was entered, the following error will occur:     Error: 266, Severity: 16, State: 1    Transaction count after EXECUTE indicates that a COMMIT ...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAS1,QAB9,QBXJ,QDLB,QA2Q,QAAP,QAB4,QAG2,QAPF,QAJQ,QBWS,QATP,QAOX,QABM,QAKP V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>INF: Stored Procedures, Transactions, and Error 266</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  April 9, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q158325</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, versions 4.2x, 6.0, and 6.5
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
If a stored procedure exits with the @@trancount value that is not the same
as when the stored procedure was entered, the following error will occur:
<P>
<PRE>   Error: 266, Severity: 16, State: 1
   Transaction count after EXECUTE indicates that a COMMIT or ROLLBACK TRAN
   is missing. Previous count = %ld, Current count = %ld.

</PRE>This error is for informational purposes only.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The following is a short code example that demonstrates the problem:
<P>
<PRE>   CREATE PROCEDURE test AS
   SELECT @@trancount
   ROLLBACK TRANSACTION
   SELECT @@trancount
   GO
   BEGIN TRANSACTION
   EXEC test
   GO

</PRE>Because @@trancount is not the same in both SELECT statements, error 266 is
generated on return from the stored procedure.
<P>
This is expected behavior, but it does not mean that transactions cannot be
started, completed, or aborted in a stored procedure. Instead, care must be
taken so that the @@trancount global variable matches on both entry and
exit of the stored procedure. This is documented in Transact-SQL under the
topic Reference\T\Transactions\Rollback Transaction.
<P>
This problem is more likely to occur when writing nested stored procedures.
However, there is solution so that the stored procedure works without the
error. The following is a list of solutions, with sample code for each:

<OL><P><LI>Perform final commit or rollback transactions from the same stored
   procedure nesting level where the transaction began, as shown by the
   following examples:
<P>
<P><PRE>      -- Example 1.a
      CREATE PROCEDURE test1a AS
      SELECT @@trancount
      GO
      BEGIN TRANSACTION
      EXEC test1a
      ROLLBACK TRANSACTION
      GO
</PRE><P>
<P><PRE>      -- Example 1.b
      CREATE PROCEDURE test1c AS
      SELECT @@trancount
      GO
      CREATE PROCEDURE test1b AS
      BEGIN TRANSACTION
      EXEC test1c
      COMMIT TRANSACTION
      GO
      EXEC test1b
      GO
</PRE>
<P><LI>If nested transactions are used in a stored procedure, perform matching
   commits. Note the transaction is not committed until @@trancount is
   equal to 0 (zero).
<P>
<P><PRE>      -- Example 2
      CREATE PROCEDURE test2b AS
      SELECT @@trancount
      BEGIN TRANSACTION
      SELECT @@trancount
      COMMIT TRANSACTION
      SELECT @@trancount
      GO
      CREATE PROCEDURE test2a AS
      BEGIN TRANSACTION
      EXEC test2b
      COMMIT TRANSACTION
      GO
      EXEC test2a
      GO
</PRE>
<P><LI>If a rollback is needed and the stored procedure nesting level is
   different than where the transaction began, use RAISERROR, with a valid
   user-defined error, and check the @@error global variable after the
   EXECUTE command.
<P>
<P><PRE>      -- Example 3
      USE master
      EXEC sp_addmessage 50001, 16, 'Rollback of transaction in test3'
      GO
      CREATE PROCEDURE test3 AS
      RAISERROR (50001,16,1)
      GO
      BEGIN TRANSACTION
      EXEC test3
      IF @@error &lt;&gt; 50001
      BEGIN
<PRE></PRE>         PRINT 'Commit'
         COMMIT TRANSACTION
      END
      ELSE
      BEGIN
         PRINT 'Rollback'
         ROLLBACK TRANSACTION
      END
      GO

</PRE><P><LI>The exception to this rule is that if a trigger performs a rollback,
   @@trancount needs not match its starting value, because the batch is
   aborted. However, a stored procedure called by a trigger may cause the
   problem if it aborted the transaction.
<P>
<P><PRE>      -- Example 4
      CREATE TABLE x (col1 int)
      GO
      CREATE TRIGGER xins ON x FOR INSERT AS
      ROLLBACK TRANSACTION
      GO
      CREATE PROCEDURE sp_xinsert AS
      SELECT @@trancount
      INSERT x (col1) VALUES (1)
      SELECT @@trancount
      GO
      BEGIN TRANSACTION
      EXEC sp_xinsert
      IF @@error &lt;&gt; 0
      BEGIN
<PRE></PRE>         PRINT 'Commit'
         COMMIT TRANSACTION
      END
      ELSE
      BEGIN
         PRINT 'Rollback'
         ROLLBACK TRANSACTION
      END
      GO
      SELECT * FROM x
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: commit rollback trigger<BR>
Keywords            : kbprg SSrvProg SSrvStProc SSrvTran_SQL<BR>
Version             : 4.2x 6.0 6.5<BR>
Platform            : WINDOWS<BR>
Issue type          : kberrmsg<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  April 9, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
