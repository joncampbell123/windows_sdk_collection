

<HTML>
<HEAD>
<TITLE>FIX: Msg 1203 &amp; SQL Server May Be Shut Down w/ Large Cursor Row </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q175887">
<META NAME="KBModify" CONTENT="1997/12/19">
<META NAME="KBCreate" CONTENT="1997/10/29">
<META NAME="Keywords" CONTENT="kbbug6.50 SSrvAdmin SSrvLock SSrvProg kbfix6.50.sp4 kberrmsg">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG #: 17175 (NT: 6.5)   SQL Server may recursively print Msg 1203 and be shut down after a stack overflow exception error. This problem can occur if all of the following conditions are true:   - The  LE threshold maximum  configuration option is set...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAO2,QABM,QABT,QDKA,QAA8,QAKP,QAO4,QAAP,QBWA,QA5V,QAR4,QAC6,QAK7,QAJ6,QDIZ V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Msg 1203 &amp; SQL Server May Be Shut Down w/ Large Cursor Row</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  December 19, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q175887</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.5
</UL> 
BUG #: 17175 (NT: 6.5)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
SQL Server may recursively print Msg 1203 and be shut down after a stack
overflow exception error. This problem can occur if all of the following
conditions are true:

<UL><LI>The "LE threshold maximum" configuration option is set so that an
   individual cursor rowset fetch may cause a lock escalation to occur.

<LI>A keyset cursor fetch becomes blocked by another user and subsequently
   escalates to a table lock after the blocking is resolved.

<LI>The table has a unique index or primary key that can be used to build
   the keyset table for the cursor. Note that if this condition is false,
   the cursor reverts to an INSENSITIVE cursor, and the problem does not
   occur.
<P>
</UL>The following is the text of message 1203:
<P>
<PRE>   Caller of lock manager is incorrectly trying to unlock an unlocked
   object. spid=10 locktype=6 dbid=6 lockid=645.

</PRE><h2>CAUSE</h2>
 
<P>
The cursor code improperly handles the lock escalation and attempts to free
page locks at the end of the fetch operation. This causes a recursive error
1203 leading to a stack overflow, at which time SQL Server stops.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
To work around the problem, do either of the following:

<UL><LI>Use a smaller rowset size for your cursor.
<P>
   -or-

<LI>Increase the "LE threshold maximum" configuration option to a higher
   value so that a single cursor fetch rowset will not need to traverse
   enough pages to escalate to a table lock. For example, if the maximum
   row size within your tables allows for 1 row per page, and you have the
   cursor rowset configured to pull back 500 pages at a time, then the "LE
   threshold maximum" should be larger than 500. If you use the default
   escalation value of 200 and only have 1 row per page, use a cursor
   rowset size smaller than 200.
<P>
</UL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SQL Server version 6.5.
This problem was corrected in the latest Microsoft SQL Server 6.5 U.S.
Service Pack. For information on obtaining the service pack, query on
the following word in the Microsoft Knowledge Base (without the spaces):
<P>
<PRE>   S E R V P A C K

</PRE><h2>MORE INFORMATION</h2>
 
<P>
The following is the sequence of events that causes this problem to occur:

<OL><P><LI>Process A opens a keyset cursor on the table. After the cursor is
   opened, the user may perform cursor fetches.

<P><LI>Process B performs a modification operation within a transaction,
   which causes it to hold an exclusive lock on a page.

<P><LI>Process A performs a cursor fetch using a large rowset size. When
   it reaches the exclusively locked page, the process blocks, waiting on
   the lock to be released.

<P><LI>Process B releases the exclusive page lock by either committing or
   rolling back the transaction.

<P><LI>Process A continues scanning to retrieve the remainder of the cursor
   rowset and escalates to a table lock when the operation has scanned
   more pages than the configured "LE threshold maximum" value. When the
   full rowset has been filled, the process attempts to free previously
   obtained locks and encounters error 1203.
<P>
</OL>Because normal ANSI cursors, as exposed through Transact-SQL, only allow a
cursor rowset size of 1, this problem will never occur if you use ANSI
cursors. The client application may set a larger rowset size if it uses
cursors from DB-Library, ODBC, or OLE-DB-based interfaces.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: shutdown terminate terminated<BR>
Keywords          : kbbug6.50 SSrvAdmin SSrvLock SSrvProg kbfix6.50.sp4 kberrmsg<BR>
Version           : Windows:6.5<BR>
Platform          : WINDOWS<BR>
Issue type        : kbbug<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  December 19, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
