

<HTML>
<HEAD>
<TITLE>BUG: Database Fallback May Cause Dbid to Change </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q180603">
<META NAME="KBModify" CONTENT="1998/03/04">
<META NAME="KBCreate" CONTENT="1998/02/05">
<META NAME="Keywords" CONTENT="kbbug6.50 SSrvEntMan">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG #: 17807 (SQLBUG_65)   When a database is brought online by a fallback server, the dbid that was originally assigned to the database may not be available. This causes the fallback server to assign a new dbid number to the database. If execute per...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Security" CONTENT="PUBLIC ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAGU,QAZV,QAB4,QBVV,QABM,QBWG,QAKP,QAR4,QAW6,QAPN,QABA,QAAP,QAB9,QA5E,QAJ2 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Database Fallback May Cause Dbid to Change</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 4, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q180603</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.5
</UL> 
BUG #: 17807 (SQLBUG_65)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When a database is brought online by a fallback server, the dbid that was
originally assigned to the database may not be available. This causes the
fallback server to assign a new dbid number to the database. If execute
permissions for objects have been established in the original database,
users may not have access to the objects until they have been recompiled.
<P>
<P><h2>CAUSE</h2>
 
<P>
When a user attempts to use an object (a view, stored procedure, table, and
so on), permissions are checked before the user is allowed access to the
object. In the case of a stored procedure, the pre-complied version is
resolved by using the original dbid. If the user does not exist in the
corresponding dbid on the fallback server, an error message (error 916)
will be generated, indicating the user was not found in the database. This
message will then resolve and show the correct database name on the
fallback server for the original dbid.
<P>
The text of error 916 is:
<P>
<PRE>   Msg 916, Level 14, State 1
   Server user id %d is not a valid user in database '%.*s'

</PRE>For an example of this situation, see the MORE INFORMATION section of this
article.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
To work around this problem, ensure that the dbid of the original database
is not in use on the fallback server.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SQL Server version 6.5.
A supported fix is now available, but has not been fully regression-
tested and should be applied only to systems experiencing this specific
problem. Unless you are severely impacted by this specific problem,
Microsoft recommends that you wait for the next Service Pack that contains
this fix. Contact Microsoft Technical Support for more information.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The following example illustrates the problem:
<P>
<PRE>   Before Fallback
   ---------------

    - Original server: mydb_1 = dbid 7
    - Fallback server: mydb_2 = dbid 7

   After Fallback
   --------------

    - Fallback server: mydb_2 = dbid 7; mydb_1 = dbid 8

</PRE>In this example, if a user in mydb_1 attempted to execute a stored
procedure that he or she had execute permissions on, the stored procedure
would fail to execute. The error message would show that the user was not
found in database mydb_2 (dbid of 7 on the fallback server). If the user
did exist in dbid 7, the stored procedure would be executed.
<P>
If any user who has create permissions attempted to use the stored
procedure, the stored procedure would be recompiled on error. This would
then re-resolve the database name to the new dbid and allow subsequent
users that had execute permissions to use the object.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: sp_fallback fall back db id<BR>
.END:<BR>
Keywords          : kbbug6.50 SSrvEntMan<BR>
Version           : WINNT:6.5<BR>
Platform          : winnt<BR>
Issue type        : kbbug<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 4, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
