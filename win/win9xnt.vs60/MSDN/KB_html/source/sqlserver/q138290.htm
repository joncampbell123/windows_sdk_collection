

<HTML>
<HEAD>
<TITLE>FIX: Procedure for Repl. Can Fail When Referencing NCI </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q138290">
<META NAME="KBModify" CONTENT="1997/05/01">
<META NAME="KBCreate" CONTENT="1995/10/16">
<META NAME="Keywords" CONTENT="kbbug6.00 kbfix6.00.sp2 kbprg SSrvProg SSrvRep">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG# NT: 10981 (6.00)   If a published article has a stored procedure created FOR REPLICATION that references a column in a non-clustered index on the article's base table, the filter procedure can prevent a transaction from being replicated. Examini...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QAB9,QA28,QATJ,QAGU,QAFO,QAKP,QA6A,QAR4,QAPN,QAH6,QBVV,QAZV,QAUD,QAL3 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Procedure for Repl. Can Fail When Referencing NCI</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 1, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q138290</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.0
</UL> 
BUG# NT: 10981 (6.00)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
If a published article has a stored procedure created FOR REPLICATION
that references a column in a non-clustered index on the article's
base table, the filter procedure can prevent a transaction from being
replicated. Examining the MSjob_commands table in the distribution database
can help you detect this problem.
<P>
<P><h2>CAUSE</h2>
 
<P>
The SELECT statement in the replication filter procedure is being
incorrectly evaluated by SQL Server when applying the filter procedure
against the logged change in the published database.
<P>
The most common occurrence of this problem is when a "restriction clause"
for the article is created using SQL Enterprise Manager where the column
listed in the clause is part of a non-clustered index.
<P>
This problem can also occur if you develop your own filter procedure
using the CREATE PROCEDURE FOR REPLICATION command. This problem does
not affect the proper synchronization of data when first subscribing,
only changes made after synchronization.
<P>
<P><h2>WORKAROUND</h2>
 

<OL><P><LI>Drop the non-clustered index.

<P><LI>Remove the column referenced in the filter procedure from the non-
   clustered index.

<P><LI>Filter the replicated changes on the subscriber by using custom stored
   procedures.
<P>
</OL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Microsoft SQL Server
version 6.0. This problem was corrected in Service Pack 2 for SQL Server
version 6.0. For more information, contact your primary support provider.
<P>
MORE INFORMATION
 
<P>
If a "restriction clause" is specified when creating an article using
SQL Enterprise Manager, a "filter stored procedure," which can be
manually created using the CREATE PROCEDURE FOR REPLICATION command,
is generated to include the criteria for the horizontal partition.
Procedures of this type are applied by SQL Server as part of processing
initiated by the Log Reader task.
<P>
For example, for the employee table in the pubs database, an article
with a restriction clause of "lname like 'A%'" will result in the
creation of the following replication filter procedure automatically
by SQL Enterprise Manager:
<P>
CREATE PROCEDURE FLTR_employee_Table_1__10 FOR REPLICATION
AS
IF EXISTS (SELECT * FROM DBO.EMPLOYEE (NOLOCK) WHERE LNAME LIKE 'A%')
<PRE>   RETURN 1
</PRE></OL>ELSE
<PRE>   RETURN 0
</PRE>END
<P>
In the above example, any modification affecting the employee table
where lname LIKE 'A%' should be replicated to subscribers. However,
if a non-clustered index was created on the lname column, these
changes would not pass the filter stored procedure test and not be
stored in the distribution database.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: sql6 windows nt rep<BR>
Keywords            : kbbug6.00 kbfix6.00.sp2 kbprg SSrvProg SSrvRep<BR>
Version             : 6.0<BR>
Platform            : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 1, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
