

<HTML>
<HEAD>
<TITLE>BUG: Locks May Be Held Longer Than Necessary with Subqueries </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q179923">
<META NAME="KBModify" CONTENT="1998/01/27">
<META NAME="KBCreate" CONTENT="1998/01/27">
<META NAME="Keywords" CONTENT="kbbug6.50 SSrvLock SSrvTran_SQL">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG #: NT: 17713 (6.5)   A subquery run at the default transaction isolation level, READ COMMITTED, holds a shared intent (SH_INT) lock on the table(s) referenced in the subquery until the entire transaction is either committed or rolled back. Howeve...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QABT,QAA8,QAYL,QAL3,QAA3,QBFN,QALZ,QAK7,QAJ6,QBXJ,QABA,QAKP,QBWS,QAA5 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Locks May Be Held Longer Than Necessary with Subqueries</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  January 27, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q179923</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.5
</UL> 
BUG #: NT: 17713 (6.5)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
A subquery run at the default transaction isolation level, READ COMMITTED,
holds a shared intent (SH_INT) lock on the table(s) referenced in the
subquery until the entire transaction is either committed or rolled back.
However, there is no need to hold the lock unless SQL Server is running at
a higher transaction isolation level.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
If possible, rewrite the statement so as to not use a subquery; many
subqueries can be rewritten as joins, which oftentimes execute faster than
a subquery. Alternatively, you can use a temporary table or variable to
store a value representing the result of the expression containing the
subquery. You can populate this table or variable in a prior query, which
will release the lock when the query completes.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SQL Server version 6.5. We
are researching this problem and will post new information here in the
Microsoft Knowledge Base as it becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The default transaction isolation level in SQL Server is READ COMMITTED.
When running in this mode, SQL Server is free to release page locks on each
page as soon as it has successfully sent the qualifying rows from that page
to the client application. As soon as all results have been processed, the
shared intent (SH_INT) lock on the table is also released. A subquery
expression simply returns a value of TRUE or FALSE, and the results are
implicitly processed within the server. SQL Server is unnecessarily
deferring the release of the SH_INT lock on the tables in the subquery
until the end of the transaction, rather than after processing the result
of the subquery.
<P>
In SQL Server 6.5, REPEATABLE READ is a synonym for SERIALIZABLE. When
these more restrictive isolation levels are specified, the locks must be
held so that the subquery would not visit any new or changed rows if it
were to be executed again within the same transaction. Because of this
restriction, these isolation levels require the SH_INT lock to be held on
the table until the transaction completes.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: block blocking concurrency holdlock optimizer hint<BR>
Keywords          : kbbug6.50 SSrvLock SSrvTran_SQL<BR>
Version           : WINNT:6.5<BR>
Platform          : winnt<BR>
Issue type        : kbbug<BR>
Solution Type     : kbworkaround<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  January 27, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
