

<HTML>
<HEAD>
<TITLE>BUG: Cursor Open 533 Error on UNION if MAX or MIN in Subquery </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q147674">
<META NAME="KBModify" CONTENT="1997/05/02">
<META NAME="KBCreate" CONTENT="1996/02/28">
<META NAME="Keywords" CONTENT="kbbug6.00 kbprg SSrvProg SSrvTran_SQL">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG# NT: 13504 (6.00)   Errors can occur when you open a server cursor on a UNION query where the unioned SELECTs contain correlated subqueries which contain MIN() or MAX(). Db-library clients see the following errors:     DB-Library error 10008: Pos...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QA2Q,QAY2,QAG2,QA4H,QAMB,QBWS,QAB4,QAAP,QAKP,QAO2,QAKH,QAY4,QALZ,QDMR V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Cursor Open 533 Error on UNION if MAX or MIN in Subquery</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 2, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q147674</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.0
</UL> 
BUG# NT: 13504 (6.00)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Errors can occur when you open a server cursor on a UNION query where the
unioned SELECTs contain correlated subqueries which contain MIN() or MAX().
Db-library clients see the following errors:
<P>
<PRE>   DB-Library error 10008: Possible network error: Bad token from SQL
                           Server: Datastream processing out of sync.
   Msg 533, Level 20, State 4
                       Can't find a range table entry for range 4.
   DB-Library Process Dead - Connection Broken

</PRE>ODBC clients see the following single error if they call SQLError():
<P>
<PRE>   szSqlState = "S1000", *pfNativeError = 0,
   szErrorMsg="[Microsoft][ODBC SQL Server Driver]
               Unknown token received from SQL Server"

</PRE>The problem happens on all types of server cursors (Dynamic, Keyset,
Static, Forward Only).
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in the Microsoft SQL Server
version 6.00. We are researching this problem and will post new information
here in the Microsoft Knowledge Base as it becomes available.
<P>
This problem no longer occurs in version 6.50.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
Do not use a server cursor to process the command. Alternatively, perform
the two UNIONed SELECTs into temporary tables and then perform the union
between the temporary tables. For example, take:
<P>
<PRE>   select distinct t1.type
   from titles t1
   where t1.type in ( select max(t2.type)
                                  from titles t2
                                  where t1.pub_id != t2.pub_id )
   union
   select distinct t1.type
   from titles t1
   where t1.type in ( select max(t2.type)
                                  from titles t2
                                  where t1.pub_id != t2.pub_id )
</PRE>and change it to:
<P>
<PRE>   select distinct t1.type into #temp1
   from titles t1
   where t1.type in ( select max(t2.type)
                                  from titles t2
                                  where t1.pub_id != t2.pub_id )
   go
   select distinct t1.type into #temp2
   from titles t1
   where t1.type in ( select max(t2.type)
                                  from titles t2
                                  where t1.pub_id != t2.pub_id )
   go
   select * from #temp1
   union
   select * from #temp2
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: sql6 cursor tsql<BR>
Keywords            : kbbug6.00 kbprg SSrvProg SSrvTran_SQL<BR>
Version             : 6.0<BR>
Platform            : WINDOWS<BR>
Issue type          : kberrmsg<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 2, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
