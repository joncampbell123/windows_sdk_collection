

<HTML>
<HEAD>
<TITLE>BUG: AV in Query w/Subselect on View w/JOIN and FORCEPLAN Is On </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q176493">
<META NAME="KBModify" CONTENT="1997/11/10">
<META NAME="KBCreate" CONTENT="1997/11/10">
<META NAME="Keywords" CONTENT="kbbug6.50 SSrvTran_SQL kbusage">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG #: 17418 (WINDOWS: 6.50)   A handled access violation (AV) may occur if all of the following conditions are true:   - A query references a view.   - The view contains a join.   - The query contains a subselect.   - SET FORCEPLAN ON was run before...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAI4,QABM,QBMW,QBXS,QA4H,QADK,QDNC,QDNA,QAKP,QDKW,QA2Q,QAY2,QAB4,QAAP,QACF V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: AV in Query w/Subselect on View w/JOIN and FORCEPLAN Is On</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  November 10, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q176493</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server version 6.5
</UL> 
BUG #: 17418 (WINDOWS: 6.50)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
A handled access violation (AV) may occur if all of the following
conditions are true:

<UL><LI>A query references a view.

<LI>The view contains a join.

<LI>The query contains a subselect.

<LI>SET FORCEPLAN ON was run before the query.
<P>
</UL>If all of these conditions are true, a DB-Library client may receive the
following error:
<P>
<PRE>   DB-Library Process Dead - Connection Broken

</PRE>An ODBC client may receive the following error:
<P>
<PRE>   [Microsoft][ODBC SQL Server Driver]Protocol error in TDS stream

</PRE>You may see in the SQL Server error log messages similar to the following:
<P>
<PRE>   EXCEPTION_ACCESS_VIOLATION raised, attempting to create symptom dump
   Initializing symptom dump and stack dump facilities
   ***BEGIN STACK TRACE***
   0x0042F2C8 in sqlservr.EXE, newlinklock() + 0x0418
   0x00433717 in sqlservr.EXE, opendb() + 0x00F7
   0x0042ED45 in sqlservr.EXE, check_deadlock() + 0x0675
   0x0042EFA8 in sqlservr.EXE, newlinklock() + 0x00F8
   0x00423B50 in sqlservr.EXE, dbswriteflush() + 0x0160
   0x004229BD in sqlservr.EXE, dbswritecheck() + 0x07AD
   0x0040E680 in sqlservr.EXE, ksconsole() + 0x0320
   0x0040F1E5 in sqlservr.EXE, initcfgfix() + 0x03D5
   0x0040ED45 in sqlservr.EXE, initconfig() + 0x0165
   0x0040B7B2 in sqlservr.EXE, SqlDumpLocks() + 0x0052
   0x00415217 in sqlservr.EXE, udasyncwrite() + 0x0187

</PRE><h2>WORKAROUND</h2>
 
<P>
To work around this problem, do either of the following:

<UL><LI>Do not use SET FORCEPLAN ON for the query.
<P>
   -or-

<LI>Change the query to avoid one of the other causes. For the most part,
   you can do this by using a join instead of a subselect.
<P>
</UL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SQL Server version 6.5. We
are researching this problem and will post new information here in the
Microsoft Knowledge Base as it becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Steps to Reproduce the Problem</h3>
 

<OL><P><LI>Create the view:
<P>
<P><PRE>      use pubs
      go
      create view v1 AS
      select ta.title_id, t.pub_id
      from titleauthor ta
      inner join titles t on t.title_id = ta.title_id
</PRE>
<P><LI>Use the following query to cause an AV:
<P>
<P><PRE>      set forceplan on
      select distinct * from v1
      where pub_id in (select pub_id from publishers)
      set forceplan off
</PRE><P>
</OL>The following query can be used for a workaround:
<P>
<PRE>   set forceplan on
   select distinct v1.* from v1
   inner join publishers p on v1.pub_id=p.pub_id
   set forceplan off
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: joinorder join order exception<BR>
Keywords          : kbbug6.50 SSrvTran_SQL kbusage<BR>
Version           : WINNT:6.5<BR>
Platform          : WINDOWS<BR>
Issue type        : kbbug<BR>
Solution Type     : kbworkaround<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  November 10, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
