

<HTML>
<HEAD>
<TITLE>BUG: Agg. Functions in CASE Exp. in Correlated Subquery May AV </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q180300">
<META NAME="KBModify" CONTENT="1998/02/03">
<META NAME="KBCreate" CONTENT="1998/02/02">
<META NAME="Keywords" CONTENT="kbbug6.50 SSrvTran_SQL">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG #: 17770   A query that contains two or more aggregate functions within a CASE expression contained within a correlated subquery may cause a thread level access violation (AV).  Any combination of the MIN(), MAX(), or SUM() functions could cause ...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QA4H,QABM,QAKP,QA2Q,QAY5,QAY2,QAGX,QAG2,QAB9,QBWE,QAVZ,QDKW,QBWS,QBV8,QAY4 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Agg. Functions in CASE Exp. in Correlated Subquery May AV</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 3, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q180300</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server, version 6.5
</UL> 
BUG #: 17770
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
A query that contains two or more aggregate functions within a CASE
expression contained within a correlated subquery may cause a thread level
access violation (AV).
<P>
Any combination of the MIN(), MAX(), or SUM() functions could cause the
problem in this scenario. The COUNT(), COUNT(*), and AVG() functions do not
exhibit this behavior.
<P>
Note that a query that meets the problem criteria outlined above may not
cause the AV if there is less data in the queried tables.
<P>
<P><h2>CAUSE</h2>
 
<P>
This problem can occur if the correlated subquery is in the SELECT list or
in the WHERE clause.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
To work around this problem, break the query into two separate SQL
statements. The first query should collect the required information into a
temporary table; the second can then produce the final result set.
<P>
For example, suppose you had the following query, which causes this
problem:
<P>
<PRE>   SELECT anl.id, anl.type, production =
      (SELECT
         CASE
            WHEN SUM(production) &gt;99999 THEN 1
            WHEN SUM(production) &lt;=99999  AND SUM(production) &gt; 500 THEN 2
            ELSE 3
         END
         FROM    anl_ar
         WHERE anl_ar.id = anl.id
         AND    anl_ar.type = anl.type
      )
      FROM    lan, anl, tak
      WHERE anl.lan = lan.lan
      AND    tak.tak_id = anl.tak_id

</PRE>To avoid the problem, you can rewrite the above query as:
<P>
<PRE>   SELECT anl.id, anl.type, production_sum =
      (SELECT SUM(production)
         FROM    anl_ar
         WHERE anl_ar.id = anl.id
         AND    anl_ar.type = anl.type
      )
      INTO    #temp1
      FROM   lan, anl, tak
      WHERE   anl.lan = lan.lan
      AND   tak.tak_id = anl.tak_id

   SELECT id, type, production =
      CASE
         WHEN production_sum &gt;99999 THEN 1
         WHEN production_sum &lt;=99999  AND production_sum &gt; 500 THEN 2
         ELSE 3
      END
      FROM #temp1

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SQL Server version 6.5. We
are researching this problem and will post new information here in the
Microsoft Knowledge Base as it becomes available.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words:<BR>
Keywords          : kbbug6.50 SSrvTran_SQL<BR>
Version           : WINNT:6.5<BR>
Platform          : winnt<BR>
Issue type        : kbbug<BR>
Solution Type     : kbworkaround<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 3, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
