

<HTML>
<HEAD>
<TITLE>BUG: sp_droppublisher Does Not Clear 'pub' Server Option </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q153780">
<META NAME="KBModify" CONTENT="1997/08/12">
<META NAME="KBCreate" CONTENT="1996/07/17">
<META NAME="Keywords" CONTENT="kbbug6.50 kbfix6.50.sp1">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG# NT: 15184  (6.5)   The sp_droppublisher stored procedure, used to drop a publication server, does not properly clear the 'pub' server option from sysservers. This will prevent users from properly disabling a publication server on the screen  Ena...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAUD,QABM,QA2R,QAMA,QAOE,QABI,QAY2,QAJX,QAEF,QADR,QAI4,QAAP,QALW,QA2Q,QAB4 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: sp_droppublisher Does Not Clear 'pub' Server Option</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  August 12, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q153780</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SQL Server version 6.5
</UL> 
BUG# NT: 15184  (6.5)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The sp_droppublisher stored procedure, used to drop a publication server,
does not properly clear the 'pub' server option from sysservers. This will
prevent users from properly disabling a publication server on the screen
"Enable Subscribing from these Servers."
<P>
<P><h2>WORKAROUND</h2>
 
<P>
In the master database of any server participating in replication, please
replace the sp_droppublisher procedure by running the following script:
<P>
use master
go
if exists (select * from sysobjects where sysstat &amp; 0xf = 4 and name =
<PRE>'sp_droppublisher')
   drop procedure sp_droppublisher
</PRE>go
create procedure sp_droppublisher (
<PRE>   @publisher varchar (30),        /* publisher server name */
   @type varchar (5) = null     /* null or 'dist' */
        ) as

    declare @distaccount varchar(127)
    declare @proc varchar (255)
    declare @retcode int
    declare @privilege varchar (30)

    /*
    ** parameter check:  @publisher.
    ** check to make sure that the publisher exists, that the name isn't
    ** null, and that the name conforms to the rules for identifiers.
    */

    if @publisher is null
        begin
            raiserror (14043, 16, -1, 'the publisher')
            return (1)
        end

    execute @retcode = sp_validname @publisher

    if @retcode &lt;&gt; 0
   return (1)

    /*
    ** perform special logic if dropping a publisher for a distribution
    ** server.
    */
    if lower(@type) = 'dist'
      begin
       if not exists (select *
      from master..sysservers
                where srvname = @publisher
                and srvstatus &amp; 16 &lt;&gt; 0)

       begin
      raiserror (14080, 11, -1)
           return (1)
       end

       execute @retcode = sp_serveroption @publisher, 'dpub', false
       if @@error &lt;&gt; 0 or @retcode &lt;&gt; 0 return (1)

            if exists (select * from master..sysremotelogins
          where remoteserverid = (select srvid from master..sysservers
          where srvname = @publisher)
          and remoteusername = 'sa'
          and suid = 1)    /* 'sa' */
       begin
          execute @retcode = sp_dropremotelogin @publisher, sa, sa
          if @@error &lt;&gt; 0 or @retcode &lt;&gt; 0 return (1)
       end

            if exists (select * from master..sysremotelogins
          where remoteserverid = (select srvid from master..sysservers
          where srvname = @publisher)
          and remoteusername = 'probe'
          and suid = 10)   /* 'probe' */
       begin
          execute @retcode = sp_dropremotelogin @publisher, probe, probe
          if @@error &lt;&gt; 0 or @retcode &lt;&gt; 0 return (1)
       end

       return (0)
   end

    /*
    ** make sure the server is defined as a 'publisher'.
    */
    if not exists (select *
                     from master..sysservers
                    where srvname = @publisher
                      and srvstatus &amp; 2 &lt;&gt; 0)

        begin
            raiserror (14080, 11, -1)
            return (1)
        end

    /*
    ** turn off the server option to indicate that this is a publisher.
    */
    execute @retcode = sp_serveroption @publisher, 'pub', false
    if @@error &lt;&gt; 0 or @retcode &lt;&gt; 0 return (1)

    /*
    ** fetch the publisher's distributor account.
    */

    select @proc = rtrim(@publisher) + '.master..sp_helpdistributor '
    exec @retcode = @proc @account = @distaccount output
    if @@error &lt;&gt; 0 or @retcode &lt;&gt; 0
        begin
            raiserror (14071, 16, -1)
            return (1)
        end

    /*
    ** if @distaccount = 'localsystem' assume 'admin' privilege
    */
    if @distaccount = 'localsystem'
       return (0)

    /*
    ** if @distaccount has 'admin' privilege, do not revoke
    */
    execute @retcode = master.dbo.xp_logininfo @distaccount, 'all',
       @privilege = @privilege output
    if @@error &lt;&gt; 0 or @retcode &lt;&gt; 0 return (1)

    if @privilege = 'admin'
       return  (0)

    /*
    ** revoke replication privilege to the distributor nt account.
    */
    exec @retcode = master.dbo.xp_revokelogin @distaccount
    if @@error &lt;&gt; 0 or @retcode &lt;&gt; 0 return (1)
</PRE>go
<P>
To clear the problem before applying the procedure, you can manually
disable the 'pub' server option by executing the following statement on the
subscription server:
<P>
use master
go
sp_serveroption &lt;publication server&gt;,  'pub', false
go
<P>
Example:
<P>
use master
go
sp_serveroption AIKMAN, 'pub', false
go
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Microsoft SQL Server
version 6.5. This problem has been corrected in U.S. Service Pack 1 for
Microsoft SQL Server version 6.5. For more information, contact your
primary support provider.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
When using SQL Enterprise Manager to disable a publication server (via the
screen "Enable Subscribing from these Servers"), the operation will appear
to succeed and the checkbox indicating the publication server is disabled
will be cleared. If you return to the same screen without exiting SQL
Enterprise Manager, the checkbox will still be cleared. However, any
attempt to re-enable the publication server will result in the following
SQL-DMO error:
<P>
<PRE>   Error 14704: [SQL Server] The server '&lt;publication server&gt;' is already
   listed as a publisher

</PRE>If you exit SQL Enterprise Manager and return to the same screen, the
checkbox will appear selected again indicating the 'pub' server option was
not cleared. This problem essentially will never allow the user to properly
disable the publication server using SQL Enterprise Manager or the
procedure sp_droppublisher.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: sysservers.status<BR>
Keywords          : kbbug6.50 kbfix6.50.sp1<BR>
Version           : 6.5<BR>
Platform          : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  August 12, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
