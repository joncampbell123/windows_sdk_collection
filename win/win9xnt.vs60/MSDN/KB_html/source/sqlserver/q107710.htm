

<HTML>
<HEAD>
<TITLE>FIX: Monthly Scheduled Backup Skips Alternate Months </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q107710">
<META NAME="KBModify" CONTENT="1997/04/28">
<META NAME="KBCreate" CONTENT="1993/11/24">
<META NAME="Keywords" CONTENT="kbbug4.20 kbenv kbfix4.21 SSrvAdmin">
<META NAME="KBArea" CONTENT="Support; KB; sqlserver">
<META NAME="Description" CONTENT="BUG# NT: 9613 (4.20)   When you schedule a backup event to occur monthly, the backup event may not occur every alternate month. For example, assume a monthly backup event is scheduled on October 26, 1993, to occur on Tuesday of the fourth week every ...">
<META NAME="Product" CONTENT="SQL Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QALB,QAYZ,QACE,QA2Q,QAO4,QAU3,QAMR,QAGJ,QAG2,QBWS,QABM,QAFH,QDIV,QDIU,QBWP V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Monthly Scheduled Backup Skips Alternate Months</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  April 28, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q107710</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:
<P>
<PRE>  - Microsoft SQL Server, version 4.2
</PRE> 
BUG# NT: 9613 (4.20)
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you schedule a backup event to occur monthly, the backup event may not
occur every alternate month. For example, assume a monthly backup event is
scheduled on October 26, 1993, to occur on Tuesday of the fourth week every
month (Tuesday monthly-week4). The next backup for that event will not
occur on November 23, 1993; instead, it will occur on December 28, 1993.
<P>
<P><h2>CAUSE</h2>
 
<P>
The stored procedure sp_MSbackup_now incorrectly calculates the time
elapsed for the monthly backup event.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
Drop and recreate the stored procedure sp_MSbackup_now by running the
following script using any query tool, such as ISQL or ISQL/w.
<P>
On SQL Server for Windows NT:
<P>
use master
go
drop proc sp_MSbackup_now
go
create procedure sp_MSbackup_now as
declare @now datetime, @dayofweek smallint, @hour smallint, @minute
smallint, @elapsed int, @monthyear varchar(30)
set nocount on
<PRE>/* */
/* Get the current date and time. */
/* Parse out the relevant parts of the date  */
/* */
</PRE>select @now = getdate()
select @dayofweek = datepart(weekday,@now)
select @monthyear = substring(convert(varchar(12),getdate()),1,12)
<PRE>/* */
/* Create temporary table that holds data on what needs to be dumped */
/* */
</PRE>create table #spdumptab
(
<PRE>id             int           Not Null, /* Unique identifier */
name           varchar(30)   Not Null, /* Name of database to be dumped */
owner          varchar(30)   Not Null, /* Name of the database owner */
ddump          varchar(30)   Null,     /* Database dump device */
ldump          varchar(30)   Null,     /* Log dump device */
datacntrltype  smallint      Null,     /* Control type */
logcntrltype   smallint      Null,     /* Control type */
status         tinyint       Null      /* extra dump parameters */
)
/* */
/* Check all the databases that are dumped daily, weekly, &amp; biweekly */
/* Note: The dump can only occur if the start time(HH:MM) is &gt; the
</PRE>last dump &lt;= now */
<PRE>/* */
</PRE>insert into #spdumptab
select Event_id, Database_name,
Database_owner,Database_dump,Log_dump,NULL,NULL,Stat
from MSscheduled_backups
where Enabled = 1
<PRE>/* Dump turned on */
      and ((convert(smallint,Day) = @dayofweek) or Frequency = 1)
/* Dump to  day or Daily */
      and Frequency &lt;= 14
/* Freq daily, weekly, or biweekly */
      and datediff(day, Last_dump, @now) &gt;=
convert(smallint,Frequency)          /* Freq time has elapsed */
  and @now &gt;= convert(datetime, @monthyear + Start_time)
     and datediff(hour, Last_dump, @now) &gt;=
convert(smallint,Frequency)*24       /* Freq time has elapsed */
      and datediff(minute, Last_dump, @now) &gt;=
convert(smallint,Frequency)*24*60    /* Freq time has elapsed */
/* */
/* Check all the databases that are dumped monthly */

/* NOTE: First we get this week number, then do the same criteria as the
</PRE>Daily, weekly, bi-weekly dump. The dump can only occur if the start
time(HH:MM) is &gt; the last dump &lt;= now */
<PRE>/* */
declare @rundate datetime, @weekno smallint     /* Get this week number */
</PRE>select @rundate = @now
select @weekno = 1
while datepart(month,dateadd(day,-7,@rundate)) = datepart(month,@now)
begin
<PRE>   select @weekno = @weekno + 1
   select @rundate = dateadd(day,-7,@rundate)
</PRE>end
insert into #spdumptab
select Event_id, Database_name,
Database_owner,Database_dump,Log_dump,NULL,NULL,Stat
from MSscheduled_backups
<PRE>where Enabled = 1                   /* Dump turned on */
     and (convert(smallint,Day) = @dayofweek)
/* Dump today */
 and Frequency &gt;= 31                         /* Freq monthly */
      and (convert(smallint,Frequency) - 30) = @weekno  /* Week of month */
      and datediff(day, Last_dump, @now) &gt;= 28  /* Freq time has elapsed */
      and @now &gt;= convert(datetime, @monthyear + Start_time)
      and datediff(hour, Last_dump, @now) &gt;= convert(smallint,28)*24
  /* Freq time has elapsed */
      and datediff(minute, Last_dump, @now) &gt;=
convert(smallint,28)*24*60    /* Freq time has elapsed */
</PRE>update #spdumptab set datacntrltype = (select cntrltype from
master..sysdevices s where
#spdumptab.ddump = s.name)
update #spdumptab set logcntrltype = (select cntrltype from
master..sysdevices s where
#spdumptab.ldump = s.name)
set nocount off
<PRE>/* */
/* Output the values to the daemon */
/* */
</PRE>select id = id, name = name, owner = owner,
ddump = ddump, ldump = ldump,dcntrl = datacntrltype,
lcntrl = logcntrltype, stat = status from #spdumptab
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SQL Server version 4.2 for
Windows NT. This problem was corrected in SQL Server version 4.21. For more
information, contact your primary support provider.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: SQL Monitor Month Windows NT<BR>
Keywords            : kbbug4.20 kbenv kbfix4.21 SSrvAdmin<BR>
Version             : 4.2<BR>
Platform            : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  April 28, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
