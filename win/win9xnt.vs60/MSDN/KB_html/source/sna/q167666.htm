

<HTML>
<HEAD>
<TITLE>SNA TN3270 Access Violation, Event ID 5 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q167666">
<META NAME="KBModify" CONTENT="1998/02/03">
<META NAME="KBCreate" CONTENT="1997/04/28">
<META NAME="Keywords" CONTENT="kbbug3.00 kbbug3.00.sp1 prodsna snatn3270 kbbug3.00.sp2 kbnetwork">
<META NAME="KBArea" CONTENT="Support; KB; sna">
<META NAME="Description" CONTENT="  The TN3270 Server service fails abnormally with an access violation and logs the following event to the Windows NT application log:     Event ID: 5    Source:   TN3270 Server    Description:    The TN3270E Service has abnormally terminated.     EXP...">
<META NAME="Product" CONTENT="SNA Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAI4,QDO3,QAO4,QACK,QBWP,QAR4,QAPN,QBV8,QAB9,QAY5,QAYY,QDN1,QA1S,QDIU,QBE7 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>SNA TN3270 Access Violation, Event ID 5</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 3, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q167666</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SNA Server for Windows NT, version 3.0, 3.0 SP1, and 3.0 SP2
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The TN3270 Server service fails abnormally with an access violation and
logs the following event to the Windows NT application log:
<P>
<PRE>   Event ID: 5
   Source:   TN3270 Server
   Description:
   The TN3270E Service has abnormally terminated.

   EXPLANATION:
   An exception (0xC0000005) has occurred that has caused the TN3270E
   Service to terminate.

</PRE>An entry may be logged in the &lt;NTRoot&gt;\Drwtsn32.log file indicating a
failure in the Tn3servr.exe process.  For example:
<P>
<PRE>   ------------------------------------------------------------------
   Application exception occurred:
          App: exe\tn3servr.DBG
          Exception number: c0000005 (access violation)

   &lt;data omitted&gt;

   Function: RtlDestroyHeap
            &lt;data omitted&gt;
    FAULT -&gt; 77f7ebf  f3ab   rep  stosd      es:00194000=??????

   *----&gt; Stack Back Trace &lt;----*

   FramePtr         Function Name
   &lt;data omitted&gt;   ntdll!RtlDestroyHeap
                    ntdll!RtlAllocateHeap
                    kernel32!LocalAlloc
                    tn3servr!TnAlloc
                    tn3servr!SMG_CB_Allocate
                    tn3servr!SMGScheduleSessionInitialization
                    tn3servr!TCPSessionTerminate
   -----------------------------------------------------------------

</PRE>However, when attached with the NTSD or CDB debugger, the failure may
actually occur in the following function:
<P>
<PRE>    Function:  RtlpFindAndCommitPages

    Stack Back Trace - Function Names
    ntdll!RtlpFindAndCommitPages+0xde
    ntdll!RtlpExtendHeap+0x52
    ntdll!RtlAllocateHeapSlowly+0x894
    ntdll!RtlAllocateHeap+0x67a
    kernel32!LocalAlloc+0x71
    tn3servr!TnAlloc+0xd
    tn3servr!SMG_CB_Allocate+0xb
    tn3servr!SMGScheduleSessionInitiali
    tn3servr!TCPSessionTerminate+0x23d
    tn3servr!TCPThreadMain+0x1d7
    tn3servr!TnMain+0x79
    kernel32!BaseThreadStart+0x51

</PRE><h2>CAUSE</h2>
 
<P>
The TN3270 service does not account for the 5-byte TN3270E header when
receiving data from a TN3270E client causing the TN3270 service to
overwrite the end of the buffer that was allocated for the received data.
This results in the application exception described previously.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
The TN3270 service has been updated to allocate buffers that account for
the 5-byte TN3270E header when receiving data from TN3270E clients. The
following configuration change to the TN3270 Server successfully resolved
the problem at a customer location, therefore it can be used as an interim
solution until the fix can be applied.

<OL><P><LI>In SNA Server Manager, go to the TN3270 Server Properties dialog box.

<P><LI>Choose the Settings folder.

<P><LI>Change the following parameters to the values below:
<P>
   Default RU Sizes:
   Inbound:  2048  (Default is 1024)
   Outbound: 4096  (Default is 2048)
<P>
</OL>This particular customer's host system was sending SNA BIND commands
indicating the above maximum secondary and primary RU sizes above. The
TN3270 Server Inbound RU size should be set to the maximum secondary RU
size indicated by the host system. The TN3270 Server Outbound RU size
should be set to the maximum primary RU size indicated by the host system.
<P>
Note that the host configuration determines these maximum RU size values
for a non-negotiable 3270 session. The host administrator should be
contacted to determine these RU sizes. If this is not possible, the host RU
sizes can be determined by enabling SNA Server Data Link Control messages,
or TN3270 Internal Traces using the SNA Trace too. A BIND command will
appear in the TN3270 trace as follows:
<P>
<PRE>  &gt;04/10 11:09:42.751 (+260 msecs)  Event=TEV_DataFromSNAAsync
   Thread = 0x000000A5  Session = 0x001F7ED8  Socket = 0x00000390
   VCB address=0x001F80AC
   verb_length=0x0044  verb=0x0052 (RUI)  opcode=0x8003 (READ)
   sid=0x00020003  correlator=0x001F7ED8  post_handle=0x000003A4
   prim_rc=LUA_OK  sec_rc=LUA_SEC_RC_OK
   lu_exp     lua_data_length=0x00000023
   lua_message_type=0x31 (LUA_MESSAGE_TYPE_BIND)
   TH Only    efi=1  oadi=0  daf=FD  oaf=01  snf=9E05
   RH  REQ SC  fi=1   sdi=0  bci=1  eci=1  (Only)
   6B 80 00    dr1=1  dr2=0  ri=0   qri=0  pi=0
               bbi=0  ebi=0  cdi=0  csi=0  edi=0  pdi=0
   000000  31010303 b1903080 00018889 80000280  *..........hi....*
   000010  00000000 00000000 03000006 c2c3c3d7  *............BCCP*
   000020  f4f800                               *48.             *

</PRE></OL>The BIND command data appears in the data portion of the above message,
starting at 0x31 (the BIND command, which is byte 0 of the BIND). The
maximum secondary and primary RU sizes appear at offset 10 and 11 (starting
at 0 origin) in the above trace:
<P>
<PRE>   offset 10 = 0x88 (maximum secondary RU size)
   offset 11 = 0x89 (maximum primary RU size)

</PRE>This value is converted to an actual RU size using the following
algorithm (assuming the RU size = 0xMN):
<P>
<PRE>   M * (2**N)

</PRE>Here are some common RU sizes:
<P>
<PRE>  0x87 = 1024
  0x88 = 2048
  0x89 = 4096

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SNA Server version 3.0, 3.0
Service Pack 1, and 3.0 Service Pack 2.
A supported fix is now available, but has not been fully regression tested
and should be applied only to systems experiencing this specific problem.
Unless you are severely impacted by this specific problem, Microsoft
recommends that you wait for the next Service Pack that contains this fix.
Contact Microsoft Technical Support for more information.
 
<PRE>Keywords          : kbbug3.00 kbbug3.00.sp1 prodsna snatn3270 kbbug3.00.sp2 kbnetwork
Version           : WINDOWS:3.0,3.0sp1,3.0sp2
Platform          : WINDOWS
Issue type        : kbbug
Solution Type     : kbfix</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 3, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
