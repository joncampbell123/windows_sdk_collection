

<HTML>
<HEAD>
<TITLE>TN3270 Fails with Access Violation in ntdll!RtlFreeHeap </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q168006">
<META NAME="KBModify" CONTENT="1998/03/19">
<META NAME="KBCreate" CONTENT="1997/05/02">
<META NAME="Keywords" CONTENT="prodsna snatn3270 kbnetwork kbprb">
<META NAME="KBArea" CONTENT="Support; KB; sna">
<META NAME="Description" CONTENT="  The Microsoft SNA Server 3.0 TN3270 Server may fail unexpectedly with an  access violation. If DRWTSN32.EXE is configured as the default Windows NT debugger, an entry will be logged in the         \DRWTSN32.LOG file as follows:     Application exce...">
<META NAME="Product" CONTENT="SNA Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Security" CONTENT="PUBLIC ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QAI4,QDJS,QABA,QAY5,QBW7,QAI5,QA2O,QAUJ,QA1S,QAH4,QDNN,QBV8,QAB9,QAA1 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>TN3270 Fails with Access Violation in ntdll!RtlFreeHeap</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 19, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q168006</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SNA Server for Windows NT, version 3.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The Microsoft SNA Server 3.0 TN3270 Server may fail unexpectedly with an 
access violation. If DRWTSN32.EXE is configured as the default Windows NT
debugger, an entry will be logged in the &lt;ntroot&gt;\DRWTSN32.LOG file as
follows:
<P>
<PRE>   Application exception occurred:
           App: exe\tn3servr.DBG  &lt;process ID&gt;
           When: &lt;date / time &gt;
           Exception number: c0000005 (access violation)

</PRE>The following are examples of various routines and stack traces which may
be indicated when this problem occurs (note that all failures indicate
a calling routine of ntdll!RtlFreeHeap):
<P>
<P>
<PRE>   function: RtlpCoalesceFreeBlocks
   FAULT -&gt;77f7cf1b 8908             mov     [eax],ecx

   *----&gt; Stack Back Trace &lt;----*

   FramePtr ReturnAd Param#1  Param#2  Param#3  Param#4  Function Name
   0c09ff14 77f64c12 01450000 0099a2e8 0c09ff40 00000000 ntdll!RtlpCoalesceFreeBlocks
   0c09ff44 10201ba4 01450000 00000000 0099a2f0 762b1da9 ntdll!RtlFreeHeap

</PRE>* or *
<P>
<PRE>   function: RtlDestroyHeap
   FAULT -&gt;77f7d0d8 8908             mov     [eax],ecx

   *----&gt; Stack Back Trace &lt;----*

   FramePtr ReturnAd Param#1  Param#2  Param#3  Param#4  Function Name
   0bfaff14 77f64c12 01450000 00a71638 0bfaff40 00000000 ntdll!RtlDestroyHeap
   0bfaff44 10201ba4 01450000 00000000 00a71640 762b1da9 ntdll!RtlFreeHeap

</PRE>* or *
<P>
<PRE>   function: RtlpInsertUnCommittedPages
   FAULT -&gt;77f642fb 8b4d00           mov     ecx,[ebp]

   *----&gt; Stack Back Trace &lt;----*

   FramePtr ReturnAd Param#1  Param#2  Param#3  Param#4  Function Name
   00e5fcac 77f64ea7 00000000 00ec4000 00066000 00c50000 ntdll!RtlpInsertUnCommittedPages
   00e5fcec 77f64c3a 00c50000 00ec3370 0000cf00 001425f8 ntdll!RtlpDeCommitFreeBlock
   00e5fd18 0041ad47 00c50000 00000000 00ec3378 0041b22a ntdll!RtlFreeHeap


</PRE>With the NTSD debugger attached, the stack trace may indicate the following
failure:
<P>
<PRE>   NTSD: access violation
   eax=00000000 ebx=00000000 ecx=0ce83040 edx=01450548 esi=0099fea0 edi=01450000
   eip=77f64cfe esp=0c09ff2c ebp=0c09ff44 iopl=0         nv up ei pl zr na po nc
   cs=001b  ss=0023  ds=0023  es=0023  fs=0038  gs=0000 efl=00010246 ntdll!RtlFreeHeap+0x168:
   77f64cfe 8908             mov     [eax],ecx  ds:0023:00000000=????????

   0:013&gt; kb
   ChildEBP RetAddr  Args to Child
   0c09ff44 10201ba4 01450000 00000000 0099fec0 ntdll!RtlFreeHeap+0x168
   0c09ffec 00000000 0101b2c0 00000000 00000000 Image@10200000!free+0x17

</PRE><h2>CAUSE</h2>
 
<P>
This problem was caused after a mismatched version of MSVCRT40.DLL was
installed on the Windows NT machine where the TN3270 Server was running.
MSVCRT40.DLL supports 'C' runtime library functions which may be used and
distributed by third party Windows NT applications developed using
Microsoft Visual C++. If a third party application happens to install 
MSVCRT40.DLL and replace the version installed by Windows NT 4.0 (or 
SNA Server 3.0), this can lead to TN3270 access violations described above.
<P>
The following Microsoft VC++ DLL's are shipped by Windows NT 4.0 (and
SNA Server 3.0). The "Base" and "File Version" can be viewed using the
"DEPENDS" program, or by right-clicking on each DLL using the Windows NT
4.0 "My Computer" program:
<P>
<PRE>   Module        Date      Time     Size      Base        File Version

   MSVCRT.DLL    10/14/96  02:38a   267,536   0x779F0000  4.20.0.6201
   MSVCRT40.DLL  10/14/96  02:38a    65,024   0x779D0000  4.2000.0.6172
   MFC40.DLL     10/14/96  02:38a   924,432   0x762B0000  4.1.0.6139
   MSVCIRT.DLL   10/14/96  02:38a    74,752   0x780A0000  4.20.0.6201

</PRE>The TN3270 Server access violation was observed when the following
MSVCRT40.DLL was installed on the system by a third party application 
(with the other DLL's matching the versions listed above):
<P>
<PRE>   Module        Date      Time     Size      Base        File Version

   MSVCRT40.DLL  9/16/96   07:50a   312,832   0x10200000  4.0.0.5270

</PRE><h2>RESOLUTION</h2>
 
<P>
If an old version of MSVCRT40.DLL is located in the system path, this
version should be renamed and the standard version included with Windows
NT 4.0 should be reapplied. Here is the process to use to resolve this
problem:

<OL><P><LI>Run the PATH command to check the current system path.
</OL>2. Locate all instances of the above DLL's which exist in the system path
<PRE>   (note that the system path may span several drives).
</PRE></OL>3. Run the DEPENDS program against these DLL's and check their versions
<PRE>   against the list documented above (which lists the versions included
   with Windows NT 4.0)
</PRE>4. Rename any "old" versions which may exist on the machine, and apply
<PRE>   the Windows NT 4.0 versions in their place.  If multiple copies of the
   same DLL exists in the system path, rename all duplicate copies and
   leave a single instance in the &lt;ntroot&gt;\system32 directory.
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words:<BR>
Keywords          : prodsna snatn3270 kbnetwork kbprb<BR>
Version           : 3.0<BR>
Platform          : winnt<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 19, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
