

<HTML>
<HEAD>
<TITLE>TN3270 Server Loses Client Session </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q162147">
<META NAME="KBModify" CONTENT="1997/04/17">
<META NAME="KBCreate" CONTENT="1997/01/14">
<META NAME="Keywords" CONTENT="kbbug2.00 kbbug2.10 kbbug2.11 kbnetwork snalua snatn3270">
<META NAME="KBArea" CONTENT="Support; KB; sna">
<META NAME="Description" CONTENT="  When you press the ENTER key repeatedly in the Attachmate EPC 6.1 TN3270 emulator, a TN3270/E session may be dropped. There may also be many other ways to manifest the underlying problem.  See the CAUSE section of this article for trace symptoms.  ...">
<META NAME="Product" CONTENT="SNA Server">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAI4,QBE7,QBE6,QAC2,QAH6,QARL,QAEV,QAR4,QAYY,QDO3,QAR5,QAY2,QAUQ,QAPN,QAO4 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>TN3270 Server Loses Client Session</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  April 17, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q162147</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft SNA Server, versions 2.0, 2.1, 2.11, and 2.11 Service Pack 1
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you press the ENTER key repeatedly in the Attachmate EPC 6.1 TN3270
emulator, a TN3270/E session may be dropped. There may also be many other
ways to manifest the underlying problem.
<P>
See the CAUSE section of this article for trace symptoms.
<P>
<P><h2>CAUSE</h2>
 
<P>
The problem has to do with direction (which half-session has permission to
send data). A host may give the emulator permission to send by setting the
change direction (CD) bit in the Request Header. It is up to the
application to acknowledge this CD message before any emulator data flows
to the host. However, a TN3270 or TN3270E emulator cannot tell whether the
host has given it direction, and may send data out of order. In the failing
case, by the time the data from the emulator reaches the TN3270 server, the
host has in fact sent a CD on a Request Definite Response (RQD) message to
the computer running SNA Server. The TN3270 server then forwards the
message to the client, requesting a positive response. So, when the TN3270
Server gets the data from the emulator, it thinks that the emulator sent
the data correctly, because it now has a direction to send. Therefore, it
sends the data on to the computer running SNA Server, which rejects the
data because it has not yet received a response to the CD message from the
TN3270 Server.
<P>
The following is the message from the host with the CD bit set:
<P>
<PRE>   DLC    ---------------------------------------------- 09:59:44.35
   DLC    05160000-&gt;01020101 DLC DATA
   DLC                       DAF:05 OAF:01 ODAI:off Normal
   DLC                       RQD FMD BC EC DR1 CD
   DLC
   DLC    ---- Header  at address 00DA43B0, 1 elements ----
   DLC    04050100 00002C00 05010018 0100BD00     &lt;......,.........&gt;
   DLC
   DLC    ---- Element at address 0129AB70, start 10, end 12 ----
   DLC    038020                                  &lt;..              &gt;
   FMI    ---------------------------------------------- 09:59:44.35
   FMI    01020202-&gt;0B1D0001 FMI DATA
   FMI                       ACK reqd Key:25 Seq:24 BCI ECI CDI CEI BBIUI
   FMI                       EBIUI
   FMI
   FMI    ---- Header  at address 00DA43B0, 1 elements ----
   FMI    01050019 620E2C00 05010018 0100BD00     &lt;....b.,.........&gt;
   FMI
   FMI    ---- Element at address 0129AB70, start 4, end 12 ----
   FMI    2C000501 00180380 20                    &lt;,.......        &gt;
   FMI    ---------------------------------------------- 09:59:44.35
   FMI    0B1D0001-&gt;01020202 FMIST RSRC
   FMI                       Credit:1
   FMI
   FMI    ---- Header  at address 00DA43B0, 0 elements ----
   FMI    04050001 620E2C00 05010018 0100CF00     &lt;....b.,.........&gt;

</PRE>The following is the message sent from the client emulator:
<P>
<PRE>   &gt;10/24 09:59:44.365 (+ smidgen )  Event=TEV_DataToSNA
      Thread = 0x00000049  Session = 0x00267DA8  Socket = 0x000001D0
      VCB address=0x00267FB8
      verb_length=0x0044  verb=0x0052 (RUI)  opcode=0x8004 (WRITE)
      sid=0x00000003  correlator=0x00267DA8  post_handle=0x000001EC
      prim_rc=LUA_OK  sec_rc=LUA_SEC_RC_OK
      lu_norm    lua_data_length=0x00000003
      RH  REQ FMD fi=0   sdi=0  bci=1  eci=1  (Only)
      03 90 20    dr1=1  dr2=0  ri=1   qri=0  pi=0
                  bbi=0  ebi=0  cdi=1  csi=0  edi=0  pdi=0
      000000  f8c37e                               *8C=             *

</PRE>The following is where the TN3270 Server sends the client emulator message
to the SNA Server Service:
<P>
<PRE>   FMI    ---------------------------------------------- 09:59:44.36
   FMI    0B1D0001-&gt;01020202 FMI DATA
   FMI                       NO ACK reqd Key:1 Seq:24 BCI ECI CDI CEI
   FMI                       BBIUI EBIUI
   FMI
   FMI    ---- Header  at address 00DA43B0, 1 elements ----
   FMI    00050001 620E2C00 05010018 0100CF00     &lt;....b.,.........&gt;
   FMI
   FMI    ---- Element at address 0129AB70, start 4, end 15 ----
   FMI    2C000000 00000390 20F8C37E              &lt;,....... 8C~    &gt;
   FMI    ---------------------------------------------- 09:59:44.36
   FMI    01020202-&gt;0B1D0001 FMIST RSRC
   FMI                       Credit:1
   FMI
   FMI    ---- Header  at address 00DA44B4, 0 elements ----
   FMI    04050001 00002C00 05010018 0100CF00     &lt;......,.........&gt;

</PRE>The server rejects this incoming data from the client because the client
does not have a direction to send.
<P>
<PRE>   FMI    ---------------------------------------------- 09:59:44.36
   FMI    01020202-&gt;0B1D0001 FMIST NACK-2
   FMI                       Msg key:1 Fail: NONCRIT  Err1:200D Err2:0000
   FMI
   FMI    ---- Header  at address 00DA43B0, 0 elements ----
   FMI    01040001 6200200D 00000100 0100CF00     &lt;....b. .........&gt;

   &gt;10/24 09:59:44.365 (+ smidgen )  Event=TEV_DataFromSNA
      Thread = 0x00000049  Session = 0x00267DA8  Socket = 0x000001D0
      VCB address=0x00267FB8
      verb in progress -- opcode=0x8004 (WRITE)

   &gt;10/24 09:59:44.365 (+ smidgen )  Event=TEV_CRTInboundDataSent
      Thread = 0x00000049  Session = 0x00267DA8  Socket = 0x000001D0
      State = OPER        InputState = COLLECT     OutputState = SNARESP
      Toggle = LU-LU       LU State = SNDXMT      CanQueue = NO
      Bracket = INB         DTActive

   &gt;10/24 09:59:44.375 (+ 10 msecs)  Event=TEV_DataFromSNAAsync
      Thread = 0x00000049  Session = 0x00267DA8  Socket = 0x000001D0
      VCB address=0x00267FB8
      verb_length=0x0044  verb=0x0052 (RUI)  opcode=0x8004 (WRITE)
      sid=0x00000003  correlator=0x00267DA8  post_handle=0x000001EC
      prim_rc=0x1400 (LUA_UNSUCCESSFUL)
      sec_rc=0x00000D20 (LUA_RSP_BEFORE_SENDING_REQ)
      lu_norm    lua_data_length=0x00000003
      RH  REQ FMD fi=0   sdi=0  bci=1  eci=1  (Only)
      03 90 20    dr1=1  dr2=0  ri=1   qri=0  pi=0
                  bbi=0  ebi=0  cdi=1  csi=0  edi=0  pdi=0

   &gt;10/24 09:59:44.375 (+ smidgen )  Event=TEV_DataToClient
      Thread = 0x00000049  Session = 0x00267DA8  Socket = 0x000001D0
      NEG RSP
      Number of bytes = 8

   &gt;10/24 09:59:44.375 (+ smidgen )  Event=TEV_TCPSendIssued
      Thread = 0x00000049  Session = 0x00267DA8  Socket = 0x000001D0
      Number of bytes = 8
      000000  0200 0100 0000 ffef                      |........        |

   &gt;10/24 09:59:44.385 (+ 10 msecs)  Event=TEV_SessionTerminationScheduled
      Thread = 0x00000049  Session = 0x00267DA8  Socket = 0x000001D0
      SNAError

</PRE><h2>RESOLUTION</h2>
 
<P>
To resolve this problem, obtain the hotfix mentioned below. The fix
involved changing the TN3270E server so that it does not let a TN3270E
client send data to the host until it has sent to the host a response to
any CD message it has received. Previously, the TN3270e server would let
the TN3270E client send data once the TN3270 server had received a CD
message from the host.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in SNA Server versions 2.0,
2.1, 2.11, and 2.11 Service Pack 1.
A supported fix is now available for SNA Server 2.11 Service Pack 1, but
has not been fully regression-tested and should be applied only to systems
experiencing this specific problem. Unless you are severely impacted by
this specific problem, Microsoft recommends that you wait for the next
Service Pack that contains this fix. Contact Microsoft Technical Support
for more information. Note that the fix is also in SNA Server 3.0.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: prodsna SP1 RH<BR>
Keywords            : kbbug2.00 kbbug2.10 kbbug2.11 kbnetwork snalua snatn3270<BR>
Version             : 2.0 2.1 2.11 2.11.SP1<BR>
Platform            : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  April 17, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
