

<HTML>
<HEAD>
<TITLE>FIX: MASM BELL and SNAP TSR Program Examples Incorrect </TITLE>

<!--STYLE_BEGIN-->
<LINK REL="STYLESHEET" href="/support/kbstyle.css" TYPE="text/css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q85877 ">
<META NAME="KBModify" CONTENT="1997/09/16">
<META NAME="KBCreate" CONTENT="1992/06/22">
<META NAME="Keywords" CONTENT="">
<META NAME="KBArea" CONTENT="Support; KB; masm">
<META NAME="Description" CONTENT="  The BELL and SNAP TSR (terminate-and-stay-resident) sample programs that ship with the Microsoft Macro Assembler (MASM) versions 6.0, 6.0a, and 6.0b are not correct. Because of the errors in this program, other programs that are executed after the ...">
<META NAME="Product" CONTENT="Macro Assembler">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAH4,QAX3,QAR4,QAAP,QBFY,QABO,QBVV,QAKP,QAJQ,QAYL,QAUY,QAB4,QACI,QAA1,QAJH V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: MASM BELL and SNAP TSR Program Examples Incorrect</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 16, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q85877 </B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
6.00 6.00a 6.00b | 6.00 6.00a 6.00b
<PRE>MS-DOS           | OS/2
</PRE>kbtool kbfixlist kbbuglist
<P>
 
The information in this article applies to:

<UL><LI>Microsoft Macro Assembler for MS-DOS, versions 6.0, 6.0a, and 6.0b
<LI>Microsoft Macro Assembler for OS/2, versions 6.0, 6.0a, and 6.0b
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The BELL and SNAP TSR (terminate-and-stay-resident) sample programs
that ship with the Microsoft Macro Assembler (MASM) versions 6.0,
6.0a, and 6.0b are not correct. Because of the errors in this
program, other programs that are executed after the BELL or SNAP
TSR program has been installed may hang the computer.
<P>
<P><h2>CAUSE</h2>
 
<P>
Because of the segment ordering and the way memory is released when
the BELL or SNAP TSR program goes resident, the BeepCount variable
is being freed. Because this variable is changed in the interrupt
service routine (ISR), any program that is run after the BELL or
SNAP TSR program has gone resident may have its memory corrupted.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
To keep BeepCount from being released when BELL.EXE or SNAP.EXE
terminates and goes resident, use one of the following solutions:

<UL><LI>Change the class of the installcode segment so the segments are
   ordered correctly. In INSTALL.ASM and HANDLERS.ASM, a segment
   named installcode is declared with class CODE2, and is grouped
   inside DGROUP. Because both the assembler and linker treat class
   CODE2 the same as class CODE, and BELL.C and SNAP.C use .DOSSEG
   segment ordering, this code segment is placed prior to the data
   segments in DGROUP. If this segment is placed after the _DATA
   segment, where BeepCount is stored, the problem does not occur.
   To order the segments differently, change the class of
   installcode to class CODE2 in both INSTALL.ASM and HANDLERS.ASM.
   Class CODE2 is not treated the same as class CODE so the
   installcode segment will not be considered a code segment.
<P>
   -or-

<LI>Move BeepCount so that it isn't released when the BELL or SNAP
   TSR program terminates and goes resident. This can be
   accomplished by changing the declaration of BeepCount in BELL.C
   or SNAP.C to the following:
<P>
<PRE>   int _based("CODE") BeepCount = 1;

   This will move BeepCount into the code segment where it will not
   be returned to MS-DOS. (Compile this code with Microsoft C
   version 6.0 or later.)

</PRE></UL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in MASM versions 6.0,
6.0a, and 6.0b. This problem was corrected in MASM for MS-DOS version
6.1.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
In MASM 6.0, this program also generates the run-time error:
<P>
<PRE>   R6001 - null pointer assignment

</PRE>This particular problem was corrected in MASM 6.0a and 6.0b by
stubbing out the function that checked for null pointer assignments.
The R6001 error also occurs because of segment ordering and can be
corrected with the first solution above.
<P>
For more information on this problem, please see the following article in
the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../masm/q76945.htm">Q76945</A></B>
   TITLE     : FIX: Sample Program BELL.C Causes R6001 Error
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 6.00 6.00a 6.00b<BR>
KBCategory: kbtool kbfixlist kbbuglist<BR>
KBSubcategory: CodeSam<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 16, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
