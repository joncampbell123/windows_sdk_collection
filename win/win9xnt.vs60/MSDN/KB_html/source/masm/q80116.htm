

<HTML>
<HEAD>
<TITLE>FIX: Illegal Instruction from Structure Member Offset </TITLE>

<!--STYLE_BEGIN-->
<LINK REL="STYLESHEET" href="/support/kbstyle.css" TYPE="text/css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q80116 ">
<META NAME="KBModify" CONTENT="1997/09/16">
<META NAME="KBCreate" CONTENT="1992/01/20">
<META NAME="Keywords" CONTENT="">
<META NAME="KBArea" CONTENT="Support; KB; masm">
<META NAME="Description" CONTENT="  In the Microsoft Macro Assembler (MASM) versions 5.1 and 5.1a, if the offset of a structure template member is used as a 32-bit operand, the code generated may be incorrect. This will cause the program to hang or generate an illegal instruction mes...">
<META NAME="Product" CONTENT="Macro Assembler">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAH4,QAR4,QANY,QATS,QASR,QBV8,QAM1,QAIJ,QAB9,QAO1,QAKP,QAIC,QAG0,QDIX,QDIV V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Illegal Instruction from Structure Member Offset</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 16, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q80116 </B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
5.10 5.10a | 5.10 5.10a
<PRE>MS-DOS     | OS/2
</PRE>kbtool kbfixlist kbbuglist
<P>
 
The information in this article applies to:

<UL><LI>Microsoft Macro Assembler for MS-DOS, versions 5.1 and 5.1a
<LI>Microsoft Macro Assembler for OS/2, versions 5.1 and 5.1a
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
In the Microsoft Macro Assembler (MASM) versions 5.1 and 5.1a, if the
offset of a structure template member is used as a 32-bit operand, the code
generated may be incorrect. This will cause the program to hang or generate
an illegal instruction message in CodeView.
<P>
<P><h2>CAUSE</h2>
 
<P>
The problem occurs when the offset of a structure template member is being
used as a 32-bit immediate value, and the member's offset is greater than
100h. If the offset is greater than 100h, the code generated will not
contain the 66h prefix byte, which makes the instruction a 32-bit
operation.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Embed the 66h byte by using the DB directive, as shown in the example
below.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in MASM version 5.1 and 5.1a.
This problem was corrected in MASM version 6.0.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The following sample code can be used to demonstrate the problem.
<P>
<P>
<P><h3>Sample Code</h3>
 
<P>
;  Assemble options needed: none
<P>
.MODEL small
.386
<P>
strctr  STRUC
<PRE>     data1 DB 100h DUP (?)
     data2 DB 100h DUP (?)
</PRE>strctr  ENDS
<P>
.CODE
start:
<PRE>     mov esi, strctr.data1 ;This works since data1 &lt; 100h.
     ;DB 66h               ;Uncomment to fix next instruction.
     mov esi, strctr.data2 ;This doesn't work since data2 &gt; FFh.

     add esi, strctr.data1 ;This works since data1 &lt; 100h.
     ;DB 66h               ;Uncomment to fix next instruction.
     add esi, strctr.data2 ;This doesn't work since data2 &gt; FFh.

</PRE>END start
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 5.10 5.10a buglist5.10 buglist5.10a fixlist6.00<BR>
KBCategory: kbtool kbfixlist kbbuglist<BR>
KBSubCategory: MLIss<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 16, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
