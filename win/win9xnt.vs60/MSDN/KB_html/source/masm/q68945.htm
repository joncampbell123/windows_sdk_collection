

<HTML>
<HEAD>
<TITLE>FIX: DWORD Local Variables Use Wrong Offset in MASM </TITLE>

<!--STYLE_BEGIN-->
<LINK REL="STYLESHEET" href="/support/kbstyle.css" TYPE="text/css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q68945 ">
<META NAME="KBModify" CONTENT="1997/09/11">
<META NAME="KBCreate" CONTENT="1991/02/01">
<META NAME="Keywords" CONTENT="">
<META NAME="KBArea" CONTENT="Support; KB; masm">
<META NAME="Description" CONTENT="  When using the LOCAL directive in the Microsoft Macro Assembler (MASM) version 5.1 to declare stack space for a DWORD variable, the offset that is generated for the variable is [BP-2]. This may result in the saved value of the BP register to be ove...">
<META NAME="Product" CONTENT="Macro Assembler">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAYL,QAAW,QAR4,QALG,QAH4,QBW5,QAU7,QAUR,QAAP,QAKP,QAPF,QBFY,QAUD,QAM1,QAKD V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: DWORD Local Variables Use Wrong Offset in MASM</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 11, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q68945 </B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
5.10   | 5.10
MS-DOS | OS/2
kbtool kbfixlist kbbuglist
<P>
 
The information in this article applies to:

<UL><LI>Microsoft Macro Assembler for MS-DOS, version 5.1
<LI>Microsoft Macro Assembler for OS/2, version 5.1
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When using the LOCAL directive in the Microsoft Macro Assembler (MASM)
version 5.1 to declare stack space for a DWORD variable, the offset that is
generated for the variable is [BP-2]. This may result in the saved value of
the BP register to be overwritten when a value is stored in the DWORD local
variable.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in MASM version 5.1. This
problem was corrected in version 5.1a.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
Beginning with MASM 5.10, if the optional language parameter is used
with the .MODEL directive, the LOCAL directive may be used to declare
local variables for a procedure (PROC). When the LOCAL directive is
used in a procedure, stack space is set aside for the number and size
of the local variables that were declared. For example, upon
executing the first line of the sample assembly routine below, the
stack frame appears as follows if assembled with MASM 5.10:
<P>
<PRE>      ------------
      | Return   | 2 bytes
      | address  |
      ------------
      | Stored   | 2 bytes
      |   BP     |
      ------------
      | storage  | 2 bytes
</PRE>SP--&gt; | for myvar|
<PRE>      ------------

</PRE>The problem is that DWORD needs four bytes of storage. Because the
"saved BP" is at a higher memory location than the storage of myvar,
myvar "overflows" into the saved BP area. Using MASM 5.1a will solve
the problem by properly allocating 4 bytes of storage for a DWORD.
<P>
<P><h3>Sample Code</h3>
 
<P>
; Assemble options needed: none
<P>
.MODEL SMALL, C
<P>
PUBLIC C myproc
<P>
.CODE
myproc PROC
<PRE>    LOCAL myvar:DWORD
    nop
    ret
</PRE>myproc ENDP
<P>
END
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 5.10 buglist5.10 fixlist5.10a<BR>
KBCategory: kbtool kbfixlist kbbuglist<BR>
KBSubCategory: MLIss<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 11, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
