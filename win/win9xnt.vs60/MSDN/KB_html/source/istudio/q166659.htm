

<HTML>
<HEAD>
<TITLE>PRB: Accessing SQL Database Fails on Second Attempt </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q166659">
<META NAME="KBModify" CONTENT="1997/12/09">
<META NAME="KBCreate" CONTENT="1997/04/09">
<META NAME="Keywords" CONTENT="VIASP VIServer">
<META NAME="KBArea" CONTENT="Support; KB; istudio">
<META NAME="Description" CONTENT="  One of the following error occurs when trying to access a SQL database via Active Server Pages (ASP):     Error '80004005'     Microsoft OLE DB Provider for ODBC Drivers error '80040e21', Errors    Occurred     -or-     80004005:  ConnectionWrite(G...">
<META NAME="Product" CONTENT="istudio">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABM,QAI5,QBWS,QAVZ,QDNQ,QBG2,QAB4,QAAP,QAJQ,QAUJ,QBXS,QBWD,QBWP,QABA,QBWA V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: Accessing SQL Database Fails on Second Attempt</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  December 9, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q166659</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual InterDev, version 1.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
One of the following error occurs when trying to access a SQL database via
Active
Server Pages (ASP):
<P>
<PRE>   Error '80004005'

   Microsoft OLE DB Provider for ODBC Drivers error '80040e21', Errors
   Occurred

   -or-

   80004005:  ConnectionWrite(GetOverLappedResult)

</PRE>The error occurs on the second access to the data. For example, using a
form generated by the DataForm Wizard clicking on the "&gt;&gt;" button to view
the next 10 records results in the error described above.
<P>
This issue occurs when all of the following conditions are met:

<UL><LI>Active Server Pages that have forced NT LanMan (NTLM) authentication
   either by disabling "Allow Anonymous" and enabling "NT
   Challenge/Response" or by setting Web permissions that would force a NT
   Challenge/Response.

<LI>The Web browser on a different machine than the Internet Information
   Server (IIS).

<LI>The recordset object stored in a Session variable.
<P>
</UL>NOTES: In this scenario, if BASIC/Clear Text is turned on and NTLM is
turned off, then this script runs correctly. NTLM makes this problem
surface.
<P>
<P><h2>CAUSE</h2>
 
<P>
When the allow Anonymous User context is turned off, NT is closing the pipe
to SQL Server after the first request is complete. This is because the
first connection to SQL Server is made under the IIS Anonymous User
account. IIS then either impersonates the browser client on that same
thread, or tries to access the connection on a different thread that is
running in the impersonated user context. In either case NT would detect
the attempt to use a network named pipe handle that had been opened in a
different user context and force the pipe closed, per its security rules.
<P>
When the connections are viewed on the SQL Server with a network monitor, a
name pipe close request comes from NT, causing the error in the Web
browser.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
There are two relatively easy workarounds:

<OL><P><LI>If SQL Server is running on the same machine as IIS, you can use a local
   named pipe connection instead of a network named pipe connection. NT
   security rules would not be forced as the pipe is a local connection,
   rather than a network connection that can be impersonated by the
   Anonymous User account. In the SQL Server connection string of the
   Global.asa file, change the keyword SERVER=machinename to
   SERVER=(local). The server name "(local)" with parenthesis is a special
   keyword to the SQL Server ODBC driver.

<P><LI>You can use a non-authenticated protocol between IIS and SQL Server,
   such as TCP/IP sockets. This works when SQL Server is running on either
   the same machine or a different machine than IIS. To do so, you must
   configure both the SQL Server and the SQL Server client on the IIS
   machine:
<P>
   a. To configure SQL Server to listen on TCP/IP sockets as well as
<P><PRE>      named pipes, run SQL Setup. From the Microsoft SQL Server 6.5
      Options dialog box, click Change Network Support and Continue.
      Select the entry for TCP/IP Sockets (leave Named Pipes also
      selected) and click OK. Accept the default Named Pipe name and
      TCP/IP Socket number. Exit SQL Setup. Stop and restart SQL Server.
</PRE><P>
   b. To configure the SQL Server client on the machine running IIS (the
<P><PRE>      same or different machine as the SQL Server), select SQL Client
      Configuration Utility. Click the Net Library tab and select "TCP/IP
      Sockets" as the Default Network. Click Done. IIS should now use
      TCP/IP sockets when connecting to SQL Server.
</PRE><P>
</OL><h2>STATUS</h2>
 
<P>
Microsoft is researching this behavior and will post new information here
in the Microsoft Knowledge Base as it becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Steps to Reproduce Behavior</h3>
 

<OL><P><LI>Place the following script in a project.

<P><LI>Make sure that the Allow Anonymous setting in IIS is turned off.

<P><LI>Open the script from second machine (not the IIS Machine).
<P>
</OL>The script runs correctly and shows the first record.

<OL><P><LI>Click Refresh.
<P>
</OL>The following error appears: error '80004005'.

<OL><P><LI>Click Refresh again.
<P>
</OL>The "Microsoft OLE DB Provider for ODBC Drivers error '80040e21'," appears.
<P>
Following is the sample code:
<P>
<PRE>   &lt;%@ LANGUAGE="VBSCRIPT" %&gt;

   &lt;HTML&gt;
   &lt;HEAD&gt;
   &lt;META NAME="GENERATOR" Content="Microsoft Visual InterDev 1.0"&gt;
   &lt;META HTTP-EQUIV="Content-Type" content="text/html; charset=iso-8859-1"&gt;
   &lt;TITLE&gt;Document Title&lt;/TITLE&gt;
   &lt;/HEAD&gt;
   &lt;BODY&gt;

   &lt;% If IsEmpty(Session("rsConn")) Then

   Set ISSQL65 = Server.CreateObject("ADODB.Connection")
   ISSQL65.Open "DRIVER={SQL Server};
    SERVER=ISSQL65;UID=sa;PWD=;
    APP=Microsoft (R) Developer   Studio;WSID=ISLAB11;DATABASE=ISCon", "sa"
   Set cmdTemp = Server.CreateObject("ADODB.Command")
   Set DataCommand1 = Server.CreateObject("ADODB.Recordset")
   cmdTemp.CommandText = "dbo.""Table1"""
   cmdTemp.CommandType = 2
   Set cmdTemp.ActiveConnection = ISSQL65
   DataCommand1.Open cmdTemp, , 1, 3

   Else
      Set DataCommand1 = Session("rsConn")
   End If %&gt;

   &lt;% Response.Write DataCommand1.EOF &amp; " " &amp; DataCommand1.BOF &amp; "&lt;br&gt;"
   DataCommand1.MoveNext%&gt;
   &lt;%= DataCommand1("Email") %&gt;&lt;br&gt;
   &lt;%= DataCommand1("Fname") %&gt;&lt;br&gt;
   &lt;%= DataCommand1("Lname") %&gt;&lt;br&gt;

   &lt;% Set Session("rsConn") = DataCommand1 %&gt;

   &lt;/BODY&gt;
   &lt;/HTML&gt;

</PRE></OL><h2>REFERENCES</h2>
 
<P>
For the latest Knowledge Base articles and other support information on
Visual InterDev and Active Server Pages, see the following page on the
Microsoft Technical Support site:
<P>
<PRE>   <B><A href="http://support.microsoft.com/support/vinterdev/">http://support.microsoft.com/support/vinterdev/</A></B>

</PRE> 
<PRE>Keywords          : VIASP VIServer
Version           : 1.0
Platform          : WINDOWS
Issue type        : kbprb</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  December 9, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
