

<HTML>
<HEAD>
<TITLE>PRB: MAPI_E_LOGON_FAILED When Calling Logon Method </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q178390">
<META NAME="KBModify" CONTENT="1997/12/30">
<META NAME="KBCreate" CONTENT="1997/12/19">
<META NAME="Keywords" CONTENT="CDO">
<META NAME="KBArea" CONTENT="Support; KB; istudio">
<META NAME="Description" CONTENT="  You are unable to logon to Exchange Server when calling the Logon method of the Collaboration Data Objects (CDO) Session object in an Active Server Page. The following error is generated:      MAPI_E_LOGON_FAILED   (NOTE: CDO was formerly known as ...">
<META NAME="Product" CONTENT="istudio">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAPN,QDJ2,QAI5,QAH4,QAYC,QDNQ,QAW6,QAV5,QBWA,QA62,QBW7,QBW4,QAAP,QAHD,QAGI V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: MAPI_E_LOGON_FAILED When Calling Logon Method</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  December 30, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q178390</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual InterDev, version 1.0
<LI>Collaboration Data Objects (CDO), versions 1.1, 1.2
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
You are unable to logon to Exchange Server when calling the Logon method of
the Collaboration Data Objects (CDO) Session object in an Active Server
Page. The following error is generated:
<P>
<PRE>   "MAPI_E_LOGON_FAILED"

</PRE>(NOTE: CDO was formerly known as Active Messaging.)
<P>
<P><h2>CAUSE</h2>
 
<P>
If an invalid profile name is entered, the error will be generated. The
logon method must refer to an existing profile or must create a new
profile. In most cases in an ASP, it is best to code the Logon method so
that it creates a profile. The profile that is created is temporary and can
be deleted when the CDO Session is ended.
<P>
In order for an existing profile to be available on the server (where the
Logon method is executed), the user you are authenticated as when you
connect to the IIS machine must be logged on interactively on the server.
This occurs because the Logon method searches the HKEY_CURRENT_USER key for
the profile being requested. When IIS logs you onto the server, it is
simply impersonating your user's security context and your profiles are not
loaded into HKEY_CURRENT_USER.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
The way to create a new profile is to use the following syntax (this code
should be on one line):
<P>
<PRE>    objSess.Logon "", "", False, True, 0, True,
        "exchangeServerName" &amp; vbLF &amp; "exchangeE-MailName"

</PRE><h2>STATUS</h2>
 
<P>
This behavior is by design.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
To create a Active Messaging ASP page copy, paste the following code into
an ASP file:
<P>
<PRE>    &lt;%@ LANGUAGE="VBSCRIPT" %&gt;
    &lt;HTML&gt;
    &lt;BODY LANGUAGE=VBS&gt;
    &lt;%
    Const cStrServer        = "&lt;a valid Exchange Server name&gt;"
    Const cStrMailbox       = "&lt;a valid Mailbox Alias&gt;"
    bstrProfileInfo = cStrServer &amp; vbLf &amp; cStrMailbox 'insert a line feed

    Set objSess = Server.CreateObject("mapi.session") 'create session
      objSess.Logon "", "", False, True, 0, True, bstrProfileInfo

    Set objFBMess = objSess.Outbox.Messages.Add
      objFBMess.Subject = "Test Active Messaging"
      objFBMess.Text = "Greetings from Active Messaging in ASP"

    Set objRecips = objFBMess.Recipients
      objRecips.Add ("cstearns@msn.com")  ' e-mail name to send message to
      objRecips.Resolve
      objFBMess.Send
      objSess.Logoff
    %&gt;
    Mail Sent.
   &lt;/BODY&gt;
   &lt;/HTML&gt;

</PRE><h3>Steps to Reproduce Behavior</h3>
 
<P>
To receive the "MAPI_E_LOGON_FAILED" error, simply change the following
line from:
<P>
<PRE>    objSess.Logon "", "", False, True, 0, True, bstrProfileInfo

</PRE>to:
<P>
<PRE>    objSess.Logon "dustin hubbard", "", False, True, 0, True

</PRE>This CODE tries to use an existing profile that does not exist, thus
generating the "MAPI_E_LOGON_FAILED" error.
<P>
<P><h2>REFERENCES</h2>
 
<P>
For more information about the parameters passed to the Logon method,
please see the Online Help for Active Messaging and the "Logon Method
(Session Object)" topic under Collaboration Data Objects in the Microsoft
Developer Network Library (MSDN).
<P>
For the latest Knowledge Base articles and other support information on
Visual InterDev and Active Server Pages, please see the following page on
the Microsoft Technical Support site:
<P>
<PRE>   <B><A href="http://support.microsoft.com/support/vinterdev/">http://support.microsoft.com/support/vinterdev/</A></B>
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: Active Messaging Logon Failed ActMsg OleMsg<BR>
Keywords          : CDO<BR>
Technology        : kbInetDev<BR>
Version           : WINDOWS:1.0,1.1,1.2<BR>
Platform          : WINDOWS<BR>
Issue type        : kbprb<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  December 30, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
