

<HTML>
<HEAD>
<TITLE>HOWTO: Retrieving Bitmap from Access and Displaying In Web Page </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q175261">
<META NAME="KBModify" CONTENT="1997/12/11">
<META NAME="KBCreate" CONTENT="1997/10/16">
<META NAME="Keywords" CONTENT="AXSFMisc kbcode">
<META NAME="KBArea" CONTENT="Support; KB; axsf">
<META NAME="Description" CONTENT="  This article shows by example how to extract the bitmap photos in the Microsoft Access 97 Northwind.mdb database, and view them from a Web browser using Active Server Pages (ASP). In order to accomplish this task, an ActiveX DLL must be created tha...">
<META NAME="Product" CONTENT="Active Server Pages">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT="ActiveX ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAH4,QBWA,QA1S,QAUJ,QAPN,QBS0,QA4Q,QA2Q,QANF,QACJ,QAW6,QAJN,QDN9,QA9Q,QA6A V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>HOWTO: Retrieving Bitmap from Access and Displaying In Web Page</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  December 11, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q175261</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual InterDev, version 1.0
<LI>Microsoft Active Server Pages, version 1.0b
<LI>Microsoft Visual Basic Professional and Enterprise Editions for
   Windows, version 5.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
This article shows by example how to extract the bitmap photos in the
Microsoft Access 97 Northwind.mdb database, and view them from a Web
browser using Active Server Pages (ASP). In order to accomplish this task,
an ActiveX DLL must be created that strips the Access and OLE headers from
the field. This article shows how to create this ActiveX DLL, and how to
implement it.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
WARNING: ANY USE BY YOU OF THE CODE PROVIDED IN THIS ARTICLE IS AT YOUR OWN
RISK. Microsoft provides this code "as is" without warranty of any kind,
either express or implied, including but not limited to the implied
warranties of merchantability and/or fitness for a particular purpose.
<P>
This article demonstrates how to use Visual Basic to retrieve a bitmap
stored in an OLE Object field. Because the definition of OLE object storage
is not documented, the following code searches the object's OLE header for
characters consistent with the start of the graphic. This method may not
work in all circumstances.
<P>
Be aware that Internet Explorer 3.0 is unable to display true color
bitmaps. For this reason, the bitmaps stored in the Access database should
be no higher than 256 colors.
<P>
<P><h3>Step-by-Step Example to Extract the Photos</h3>
 

<OL><P><LI>Create a new project in Visual Basic and make the project an ActiveX
   DLL.

<P><LI>Add a reference to ActiveX Data Objects (ADO) by clicking the Project
   menu and selecting References. Select "Microsoft OLE DB ActiveX Data
   Objects 1.0 Library" and click OK.

<P><LI>Add a new module to the project by selecting the Project menu and
   clicking Add Module. Select Module and click Open.

<P><LI>Place the following code in the (general) (declarations) section of
   MODULE1.BAS:
<P>
<P><PRE>      ' Enter the following Declare statement as one single line:
      Public Declare Sub CopyMemory Lib "kernel32" Alias "RtlMoveMemory"
       (lpvDest As Any, lpvSource As Any, ByVal cbCopy As Long)
</PRE><P>
<P><PRE>      Type PT
<PRE></PRE>        Width As Integer
        Height As Integer
      End Type

      Type OBJECTHEADER
        Signature As Integer
        HeaderSize As Integer
        ObjectType As Long
        NameLen As Integer
        ClassLen As Integer
        NameOffset As Integer
        ClassOFfset As Integer
        ObjectSize As PT
        OleInfo As String * 256
      End Type

</PRE><P><LI>Place the following code in the (general) (declarations) section of
   CLASS1.CLS:
<P>
<P><PRE>      Function DisplayBitmap(ByVal OleField As ADODB.Field)
<PRE></PRE>         Dim Arr() As Byte
        Dim ObjHeader As OBJECTHEADER
        Dim Buffer As String
        Dim ObjectOffset As Long
        Dim BitmapOffset As Long
        Dim BitmapHeaderOffset As Integer
        Dim ArrBmp() As Byte
        Dim i As Long

        'Resize the array, then fill it with
        'the entire contents of the field
        ReDim Arr(OleField.ActualSize)
        Arr() = OleField.GetChunk(OleField.ActualSize)

        'Copy the first 19 bytes into a variable
        'of the OBJECTHEADER user defined type.
        CopyMemory ObjHeader, Arr(0), 19

        'Determine where the Access Header ends.
        ObjectOffset = ObjHeader.HeaderSize + 1

        'Grab enough bytes after the OLE header to get the bitmap header.
        Buffer = ""
        For i = ObjectOffset To ObjectOffset + 512
            Buffer = Buffer &amp; Chr(Arr(i))
        Next i

        'Make sure the class of the object is a Paint Brush object
        If Mid(Buffer, 12, 6) = "PBrush" Then
            BitmapHeaderOffset = InStr(Buffer, "BM")
            If BitmapHeaderOffset &gt; 0 Then

                'Calculate the beginning of the bitmap
                BitmapOffset = ObjectOffset + BitmapHeaderOffset - 1

                'Move the bitmap into its own array
                ReDim ArrBmp(UBound(Arr) - BitmapOffset)
                CopyMemory ArrBmp(0), Arr(BitmapOffset), UBound(Arr) -
                 BitmapOffset + 1

                'Return the bitmap
                DisplayBitmap = ArrBmp
            End If
        End If
      End Function

</PRE><P><LI>Rename the Project by selecting the Project menu, and clicking on
   "Project1 Properties" and type your new name in the "Project Name"
   field. This example assumes that you named the project "MyProject" and
   will refer to that name in future steps.

<P><LI>Make the project Apartment Model Threaded by selecting the
   "Unattended Execution" check box. Click OK.

<P><LI>Rename the Class in the Property Pane. This example assumes that you
   named the class "MyClass" and refers to that name in future steps.

<P><LI>Compile the DLL by clicking the File menu and selecting "Make
   MyProject.dll."

<P><LI>Create an ASP page named "bitmap.asp" that contains the
   following code:
<P>
<P><PRE>      &lt;%@ LANGUAGE="VBSCRIPT" %&gt;
      &lt;%
<PRE></PRE>      '   You need to set up a System DSN named 'NWind' that points to
      '   the Northwind.mdb database
      Set DataConn = Server.CreateObject("ADODB.Connection")
      DataConn.Open "DSN=NWind", "admin", ""
      Set cmdTemp = Server.CreateObject("ADODB.Command")
      Set RS = Server.CreateObject("ADODB.Recordset")
      cmdTemp.CommandText = "SELECT Photo FROM Employees
        WHERE EmployeeID = 1"
      cmdTemp.CommandType = 1
      Set cmdTemp.ActiveConnection = DataConn
      RS.Open cmdTemp, , 0, 1
      Response.ContentType = "image/bmp"
      Set Bitmap = Server.CreateObject("MyProject.MyClass")
      Response.BinaryWrite Bitmap.DisplayBitmap(RS("Photo"))
      RS.Close
      %&gt;

</PRE><P><LI>Create an HTML page named "BitmapTest.htm" that contains
   the following code:
<P>
<P><PRE>      &lt;HTML&gt;
      &lt;HEAD&gt;
      &lt;TITLE&gt;Bitmap Test&lt;/TITLE&gt;
      &lt;/HEAD&gt;
      &lt;BODY&gt;
      &lt;HR&gt;
      &lt;img src="bitmap.asp"&gt;
      &lt;HR&gt;
      &lt;/BODY&gt;
      &lt;/HTML&gt;
</PRE><P>
</OL><h2>REFERENCES</h2>
 
<P>
For additional information, please see the following article in the
Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../axsf/q173308.htm">Q173308</A></B>
   TITLE     : HOWTO: Displaying Images Stored in a BLOB Field

</PRE></OL>For the latest Knowledge Base artices and other support information on
Visual InterDev and Active Server Pages, see the following page on the
Microsoft Technical Support site:
<P>
<PRE>   <B><A href="http://support.microsoft.com/support/vinterdev/">http://support.microsoft.com/support/vinterdev/</A></B>



</PRE> 
<PRE>Keywords          : AXSFMisc kbcode
Technology        : kbInetDev
Version           : WINDOWS:1.0,5.0; WINNT:1.0b
Platform          : WINDOWS winnt
Issue type        : kbhowto</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  December 11, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
