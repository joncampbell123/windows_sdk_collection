

<HTML>
<HEAD>
<TITLE>RAS Server Routing Client IP Packets Degrades Performance </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q157462">
<META NAME="KBModify" CONTENT="1997/11/18">
<META NAME="KBCreate" CONTENT="1996/10/11">
<META NAME="Keywords" CONTENT="kbbug3.50 kbbug3.51 kbfix3.51.sp2 NTRAS NTSrvWkst kbnetwork">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT="  You may notice that the performance of your Remote Access Service (RAS) server degrades when you are using it to route IP packets from several RAS clients to one or more local area network (LAN) segments.  CAUSE =====  This problem occurs when a la...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QAKD,QAVZ,QAJZ,QAKC,QARL,QBVX,QDO3,QBWD,QABA,QAHE,QDNT,QAYY,QAU3,QAMR V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>RAS Server Routing Client IP Packets Degrades Performance</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  November 18, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q157462</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Workstation version 3.51
<LI>Microsoft Windows NT Server version 3.51
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
You may notice that the performance of your Remote Access Service (RAS)
server degrades when you are using it to route IP packets from several RAS
clients to one or more local area network (LAN) segments.
<P>
<P><h2>CAUSE</h2>
 
<P>
This problem occurs when a large number of packets are sent from the RAS
server or a system on the LAN to a RAS client.
<P>
For example, when RAS clients use Internet browsers through a RAS server,
the browsers typically open several TCP connections for each page. The
browsers send several small request packets through the RAS IP router to
the Web server. The Web server then responds by sending lots of frames with
the content of the Web page.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
To resolve this issue, perform the following steps to edit or add the
appropriate registry entries:
<P>
WARNING: Using Registry Editor incorrectly can cause serious, system-wide
problems that may require you to reinstall Windows NT to correct them.
Microsoft cannot guarantee that any problems resulting from the use of
Registry Editor can be solved. Use this tool at your own risk.

<OL><P><LI>Install the latest Windows NT 3.51 Service Pack.
<P>
   For additional information, please see the following article in
   the Microsoft Knowledge Base:
<P>
   ARTICLE-ID: <B><A href="../winnt/q128465.htm">Q128465</A></B>
<PRE>   TITLE     : How To Obtain Windows NT Version 3.51 U.S. Service Pack

</PRE><P><LI>Start Registry Editor (Regedt32.exe) and select the following subkey:
<P>
   HKEY_Local_Machine\System\CurrentControlSet\Services\NdisWanX
<P>
   where X is the adapter number.
<P>
   NOTE: There may be several NdisWanX subkeys. The one you need to
   change will have the subkeys Parameters\Tcpip\. This is often the
   last NdisWan entry.

<P><LI>Go to the Parameters subkey of NdisWanX (that includes the following):
<P>
   a. A value with the following information:
<P>
<P><PRE>      Value name: ServerAdapter
      Data Type:  REG_DWORD
<PRE></PRE>      Data:       1

   b. the TCPIP subkey.

</PRE><P><LI>Select the TCPIP subkey, click Edit, and then click Add Value.

<P><LI>Enter the following:
<P>
   Value Name: MaxForwardPending
   Data Type:  REG_DWORD
<PRE>   Data:       &lt;Range is 1 to 0xFFFFFFFF&gt;

   NOTE: The default value for this key before Service Pack 2 (SP2) is 20
   (decimal); however, for Windows NT before SP2, it was a hard-coded limit
   of 5.

   You can only change MaxForwardPending, but your queue will be limited to
   50 packets. Setting it to more than 50 will not provide any additional
   queuing because there are other buffers that become exhausted at 50. If
   you need more than 50, follow steps 6-8 below. Otherwise, you can skip
   to steps 9-10.

</PRE><P><LI>In the registry, locate the following key:
<P>
   HKEY_Local_Machine\System\CurrentControlSet\Services\Tcpip\Parameters

<P><LI>Click Edit, click Add value, and then type the following:
<P>
<PRE>   Value Name:   NumForwardPackets
   Data Type:    REG_DWORD
   Data:         &lt;Range is 1 to 0xFFFFFFFF&gt;
   Default:      50

   Description: This parameter determines the number of IP packet headers
   allocated for the router packet queue. When all headers are in use, the
   router will begin to discard packets at random from the queue. This
   value should be at least as large as the ForwardBufferMemory value
   divided by the maximum IP data size of the networks connected to the
   router. It should be no larger than the ForwardBufferMemory value
   divided by 256, because at least 256 bytes of forward buffer memory are
   used for each packet. The optimal number of forward packets for a given
   ForwardBufferMemory size depends on the type of traffic carried on the
   network and will be somewhere between these two values. This parameter
   is ignored and no headers are allocated if the router is not enabled.

   NOTE: This value should be set equal to MaxForwardPending for
   adapter key.

</PRE><P><LI>Click Edit, click Add value, and then type the following:
<P>
<PRE>   Value Name:   ForwardBufferMemory
   Data Type:    REG_DWORD
   Data:         &lt;Range is network MTU&gt;
   Default:      74240 (enough for fifty 1480-byte packets, rounded
                 to a multiple of 256)

   Description: This parameter determines how much memory IP allocates to
   store packet data in the router packet queue. When this buffer space is
   filled, the router begins discarding packets at random from its queue.
   Packet queue data buffers are 256 bytes in length, so the value of this
   parameter should be a multiple of 256. Multiple buffers are chained
   together for larger packets. The IP header for a packet is stored
   separately. This parameter is ignored and no buffers are allocated if
   the IP router is not enabled. Ideally you would multiply
   NumForwardPackets times 1480 bytes.

</PRE><P><LI>Click OK, and then quit Registry Editor.

<P><LI>Shut down and then restart Windows NT.
<P>
</OL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Windows NT version 3.51.
This problem has been corrected in the latest U.S. Service Pack for Windows
NT version 3.51. For information on obtaining the Service Pack, query on
the following word in the Microsoft Knowledge Base (without the spaces):
<P>
<PRE>   S E R V P A C K

</PRE></OL><h2>MORE INFORMATION</h2>
 
<P>
When RAS client computers connect to Web servers on the RAS server's IP
network, the backlog becomes extremely large. Web browsers on RAS client
computers use the HTTP protocol, which can have many requests pending at
the same time. In addition, Web browsers transmit small request packets
that generates many large response packets. Consequently, using Web
browsers can increase the number of packets being sent and queued on the
RAS server for each RAS client computer.
<P>
The IP router of the Windows NT TCP/IP stack places IP packets in a queue
and, by default, forwards 20 IP packets at once to an NDIS network driver.
The number of packets that are forwarded depends on the MaxForwardPending
registry value. This value was originally set to 5. After you upgrade to
Windows NT 3.51 Service Pack 2 or greater, the value defaults to 20 and is
user configurable in the registry.
<P>
The default value for MaxForwardPending is sufficient for local network
speed and throughput. However, it is not sufficient for RAS NDIS drivers.
For example, if 1,000 packets are sent to the RAS server for one RAS
client, there is a long delay in completing the transmission of the packets
and a huge backlog on the RAS server. Several third-party multiport serial
interface vendors have developed drivers that can transmit more packets at
once than a standard network card (which uses the Windows NT default value
of 20 packets). These drivers place packets in a queue on the individual
serial connector for each RAS client computer. This process reduces the
load on the higher software layers and places the heavy load on the
hardware.
<P>
For example, if you have a RAS server that uses a 64 multiport serial
interface and one network connection, 64 RAS client computers using
Internet Explorer that can make 5 possible simultaneous connections, and a
Web site with a Web page that contains 5 graphic files (each is 10 KB in
size), the MaxForwardPending data value is 1600 (decimal).
<P>
64 clients * 5 connections/client * 5 files/connection = 1600
<P>
To monitor your RAS IP router backlog queue, you need to use Performance
Monitor. However, first you must install Network Monitor Agent on the RAS
server. This is necessary because it adds additional network interface
counter objects to Performance Monitor.
<P>
Start your test on your normal RAS traffic. Monitor the queue lengths on
the chart. RAS should be the highest value. If the queue length hits your
value for MaxForwardPending it will cause all RAS clients to drop packets.
If this occurs, you should go back to the RESOLUTION section earlier in
this article and increase all your registry parameters.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: prodnt<BR>
Keywords          : kbbug3.50 kbbug3.51 kbfix3.51.sp2 NTRAS NTSrvWkst kbnetwork<BR>
Version           : WinNT:3.51<BR>
Platform          : winnt<BR>
Issue type        : kbbug<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  November 18, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
