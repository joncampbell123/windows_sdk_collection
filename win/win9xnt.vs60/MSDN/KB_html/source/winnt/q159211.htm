

<HTML>
<HEAD>
<TITLE>Diagnoses and Treatment of Black Hole Routers </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q159211">
<META NAME="KBModify" CONTENT="1997/03/28">
<META NAME="KBCreate" CONTENT="1996/11/11">
<META NAME="Keywords" CONTENT="kbnetwork nthowto nttcp">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT="  On a TCP/IP wide area network (WAN), communication over some routes may fail if intermediate network segments have packet sizes smaller than the communicating hosts, and routers do not send appropriate ICMP responses to this condition. A router tha...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QBWD,QAM5,QAVZ,QAG9,QABX,QABA,QAH6,QDKW,QDN1,QBXS,QBVV,QBCU,QAUD,QDNT V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Diagnoses and Treatment of Black Hole Routers</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 28, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q159211</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:
<UL><LI>Microsoft Windows NT Workstation versions 3.5  3.51 and 4.0
<LI>Microsoft Windows NT Server versions 3.5, 3.51 and 4.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
On a TCP/IP wide area network (WAN), communication over some routes may
fail if intermediate network segments have packet sizes smaller than the
communicating hosts, and routers do not send appropriate ICMP responses to
this condition. A router that causes this condition is sometimes known as a
"black hole" router. The Ping utility, a standard utility installed with
the Microsoft Windows NT TCP/IP protocol, can be used to find black hole
routers. Some recommendations are provided to work around or fix problems
with black hole routers.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
When a network router receives a packet larger than the Maximum Transfer
Unit (MTU) of the next network segment, and that packet's IP layer "don’t
fragment" bit is flagged, the router should send an ICMP destination
unreachable message back to the sending host. When this does not happen,
packets can be dropped, causing a variety of errors that will vary with the
application that is communicating over the failed link. These errors will
not occur when an application connects to a computer on a local subnet. The
problem may seem intermittent, but on closer examination, it can be
duplicated, such as in having a client read a large file from a remote
host.
<P>
The Ping utility can be used to find black hole routers by using the -f (do
not fragment) and the -l (buffer size) parameters. Setting the -f parameter
will cause the Ping utility to send an ICMP echo packet with the IP "do not
fragment" bit set. The -l parameter sets the buffer, or payload, size of
the ICMP Echo packet. The largest buffer that can be sent unfragmented
equals the MTU minus the IP and ICMP headers (MTU-28) of the smallest MTU
along a route. For example, because Ethernet has an MTU of 1500 bytes,
under the best circumstances, Ping could echo an unfragmented packet with
an ICMP buffer of 1472 bytes. The syntax for Ping in this case would be:
<P>
<PRE>   Ping &lt;machine name or IP address&gt; -f -l 1472

</PRE>This should work on all local IP addresses. If the MTU of all segments of a
routed connection are 1500 or larger, the packet should be returned as
well. If there are intermediate segments with smaller MTUs, and routers
return the appropriate ICMP Destination Unreachable packet, the utility
should display "Packet needs to be fragmented but DF set". If there are
segments along the route with smaller MTUs, and the appropriate ICMP packet
is not returned, the Ping utility should display "Request timed out." The
default MTUs of common network media are described in Knowledge Base
article <B><A href="../winnt/q140375.htm">Q140375</A></B>.
<P>
By changing the -l parameter on successive Pings, the largest unfragmented
packet that will travel a specific route can be found. The smallest MTU in
general use is 576 bytes, so you should be able to safely start with an
ICMP buffer of 548, then work up from there. For example, if "Ping &lt;host
name or address&gt; -f -l 972" returns packets and "Ping &lt;host name or
address&gt; -f -l 973" fails, the largest MTU that can be used over that route
is 1000 (972+28).
<P>
To fix or work around black hole routers, there are four possible
solutions.

<OL><P><LI>Enable PMTU Black Hole Detection on Windows NT hosts that will be
   communicating over a wide area connection, as documented in Knowledge
   Base article <B><A href="../winnt/q136970.htm">Q136970</A></B>. In this case, Windows NT 3.51 Service Pack 2 or
   greater or Windows NT 4.0 should be used.

<P><LI>Configure intermediate routers to send ICMP type 3 code 4 (destination
   unreachable don't fragment (DF) bit sent and fragmentation required)
   messages. This may require upgrading router software or firmware, router
   configuration or router replacement.

<P><LI>Disable PMTU discovery on Windows NT hosts that communicate over
   troublesome routes. This will configure the default MTU to 576 bytes.
   This could cause significant degradation in network performance.

<P><LI>Set the MTU of the host interface to be the largest the black hole
   router can handle. This guarantees the largest possible packet size will
   be sent over that connection, but will cause local traffic, and traffic
   over routed connections without problems, to use smaller packets than
   they would otherwise. This workaround assumes that you have determined
   the MTU and the state of all possible links that could be used by the
   host in question.
<P>
</OL>For additional information, please see the following articles in the
Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../winnt/q120642.htm">Q120642</A></B>
   TITLE     : TCP/IP &amp; NBT Configuration Parameters for Windows NT 3.5

   ARTICLE-ID: <B><A href="../winnt/q128797.htm">Q128797</A></B>
   TITLE     : Unable to Transfer Files Across DEC 250 and DEC 500 Routers

   ARTICLE-ID: <B><A href="../winnt/q136970.htm">Q136970</A></B>
   TITLE     : PMTU Black Hole Detection Algorithm Change for Windows NT
               3.51

   ARTICLE-ID: <B><A href="../winnt/q138575.htm">Q138575</A></B>
   TITLE     : Communication Fails Through Ethernet Segment Between FDDI
               Rings

   ARTICLE-ID: <B><A href="../winnt/q140375.htm">Q140375</A></B>
   TITLE     : Default MTU Size for Different Network Topology

</PRE></OL>For further information, see Internet RFC 1191 and RFC 1435, available from
<B><A href="http://www.internic.net/">http://www.internic.net/</A></B> and Microsoft Windows NT 3.5/3.51: TCP/IP
Implementation Details, a white paper available from
<B><A href="http://www.microsoft.com/">http://www.microsoft.com/.</A></B>
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: prodnt<BR>
Keywords            : kbnetwork nthowto nttcp<BR>
Version             : 3.5 3.51 4.0<BR>
Platform            : WinNT<BR>
Issue type          : kbtshoot<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 28, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
