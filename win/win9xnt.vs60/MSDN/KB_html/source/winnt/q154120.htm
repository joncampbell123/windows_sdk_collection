

<HTML>
<HEAD>
<TITLE>Debugging User Profiles and System Policies in Windows NT 4.0 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q154120">
<META NAME="KBModify" CONTENT="1998/02/17">
<META NAME="KBCreate" CONTENT="1996/07/30">
<META NAME="Keywords" CONTENT="nthowto NTSrv">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT=" IMPORTANT: This article contains information about editing the registry. Before you edit the registry, make sure you understand how to restore it if a problem occurs. For information on how to do this, view the  Restoring the Registry  online Help t...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QDJ2,QBW4,QBWP,QAUD,QBFY,QABI V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Debugging User Profiles and System Policies in Windows NT 4.0</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 17, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q154120</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Server version 4.0
</UL> 
<P>
IMPORTANT: This article contains information about editing the registry.
Before you edit the registry, make sure you understand how to restore it
if a problem occurs. For information on how to do this, view the
"Restoring the Registry" online Help topic in Regedit.exe or the
"Restoring a Registry Key" online Help topic in Regedt32.exe.
<P>
<P><h2>SUMMARY</h2>
 
<P>
The checked version of Userenv.dll, in conjunction with a registry entry,
creates a log file useful in troubleshooting and debugging problems with
roaming profiles and system policies on Microsoft Windows NT version 4.0
clients.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
To enable the log file:

<OL><P><LI>Rename the Userenv.dll file in the %Windir%\System32 directory to
   Usernv.orig or the unique name of your choice.

<P><LI>Copy the checked version of Userenv.dll to the %Windir%\System32
   directory of the client computer that you want to debug. The checked
   version of the Userenv file must match the version of the operating
   system being used.
<P>
</OL>WARNING: Using Registry Editor incorrectly can cause serious problems that
may require you to reinstall your operating system. Microsoft cannot
guarantee that problems resulting from the incorrect use of Registry
Editor can be solved. Use Registry Editor at your own risk.
<P>
For information about how to edit the registry, view the "Changing Keys
And Values" online Help topic in Registry Editor (Regedit.exe) or the "Add
and Delete Information in the Registry" and "Edit Registry Data" online
Help topics in Regedt32.exe. Note that you should back up the registry
before you edit it.

<OL><P><LI>Start Regdt32 and locate the following path:
<P>
<P><PRE>      HKEY_LOCAL_MACHINE\Software\Microsoft\WindowsNT\CurrentVersion
      \Winlogon
</PRE><P>
   NOTE: The above registry key is one path; it has been wrapped for
   readability.

<P><LI>Create a new value called UserEnvDebugLevel as a reg_dword. Assign
   the value 10002 in hexadecimal format.

<P><LI>Restart the computer with the .dll and registry changes
   in place.
<P>
</OL>Log information will be recorded in the root directory of drive C as
Userenv.log and can be viewed with Notepad, WordPad, or the text editor of
your choice.
<P>
Information displayed in the log includes: profile path, profile type,
system policy path (useful to determine which server the Ntconfig.pol file
was pulled from), whether the profile was successfully loaded and unloaded
at the client, and if the remote profile is newer than the local profile.
<P>
A sample Userenv.log based on the following information is shown below.
<P>
<PRE>   Username = profile
   Profile path defined in User Manager =
      PDCServerName\Profiles\%username%
   Domain Controller = PDCServerName
   System Policy Path: PDCServerName\Netlogon

</PRE></OL>NOTE: The response to the seventeenth line
<P>
<PRE>   Profile is not reachable, error = 2

</PRE>is normal as a check is made for the existence of a mandatory profile path
being defined in User Manager for Domains
(Servername\Sharename\%Username%.man). Mandatory profiles were not used in
this example, so the test fails.
<P>
 
LoadUserProfile: Entering, hToken = &lt;0xa8&gt;, lpProfileInfo = 0x12f4e8
LoadUserProfile: lpProfileInfo-&gt;dwFlags = &lt;0x2&gt;
LoadUserProfile: lpProfileInfo-&gt;lpUserName = &lt;profile&gt;
LoadUserProfile: lpProfileInfo-&gt;lpProfilePath =
&lt;\\PDCServerName\profiles\profile&gt;
LoadUserProfile: lpProfileInfo-&gt;lpDefaultPath =
&lt;\\PDCServerName\netlogon\Default User&gt;
LoadUserProfile: lpProfileInfo-&gt;lpServerName = &lt;\\PDCServerName&gt;
LoadUserProfile: lpProfileInfo-&gt;lpPolicyPath =
&lt;\\PDCServerName\netlogon\ntconfig.pol&gt;
ParseProfilePath: Entering, lpProfilePath =
&lt;\\PDCServerName\profiles\profile&gt;
ParseProfilePath: Tick Count = 60
ParseProfilePath: FindFirstFile found something with attributes &lt;0x10&gt;
ParseProfilePath: Found a directory
LoadUserProfile: ParseProfilePath returned a directory of
&lt;\\PDCServerName\profiles\profile&gt;
RestoreUserProfile:  Entering
RestoreUserProfile:  Profile path = &lt;\\PDCServerName\profiles\profile&gt;
RestoreUserProfile:  User is a Admin
IsCentralProfileReachable:  Entering
IsCentralProfileReachable:  Testing
&lt;\\PDCServerName\profiles\profile\ntuser.man&gt;
IsCentralProfileReachable:  Profile is not reachable, error = 2
IsCentralProfileReachable:  Testing
&lt;\\PDCServerName\profiles\profile\ntuser.dat&gt;
IsCentralProfileReachable:  Found a user profile.
RestoreUserProfile:  Central Profile is reachable
RestoreUserProfile:  Central Profile is floating
GetLocalProfileImage:  Found entry in profile list for existing local
profile
GetLocalProfileImage:  Local profile image filename =
&lt;%SystemRoot%\Profiles\profile&gt;
GetLocalProfileImage:  Expanded local profile image filename =
&lt;C:\WINNT\Profiles\profile&gt;
GetLocalProfileImage:  Found local profile image file ok
&lt;C:\WINNT\Profiles\profile\ntuser.dat&gt;
Local profile is reachable
Local profile name is &lt;C:\WINNT\Profiles\profile&gt;
RestoreUserProfile:  About to call UpdateToLatestProfile
UpdateToLatestProfile: Entering.  Central =
&lt;\\PDCServerName\profiles\profile&gt;
Local = &lt;C:\WINNT\Profiles\profile&gt;
UpdateToLatestProfile:  Central and local profile times match.
RestoreUserProfile:  About to Leave.  Final Information follows:
Profile was successfully loaded.
lpProfile-&gt;szCentralProfile = &lt;\\PDCServerName\profiles\profile&gt;
lpProfile-&gt;szLocalProfile = &lt;C:\WINNT\Profiles\profile&gt;
lpProfile-&gt;dwInternalFlags = 0x112
RestoreUserProfile:  Leaving.
UpgradeProfile: Entering
UpgradeProfile: Build numbers match
UpgradeProfile: Leaving Successfully
ApplyPolicy: Entering
ApplyPolicy:  PolicyPath is: &lt;\\PDCServerName\netlogon\ntconfig.pol&gt;.
ReconcileFile: \\PDCServerName\netlogon\ntconfig.pol ==&gt;
C:\WINNT\Profiles\Policy\ntconfig.pol  [OK]
ApplyPolicy:  Local PolicyPath is:
&lt;C:\WINNT\Profiles\Policy\ntconfig.pol&gt;.
ApplyPolicy:  Leaving succesfully.
LoadUserProfile: Leaving with a value of 1.  hProfile = &lt;0x90&gt;
 
<P>
Below is a successful logoff and update by the client of the server-
based roaming profile.
<P>
 
UnloadUserProfile: Entering, hProfile = &lt;0xe0&gt;
UnloadUserProfile:  Succesfully unloaded profile
UnloadUserProfile:  Copying profile back to
\\PDCServerName\profiles\profile
CopyProfileDirectory: Entering, lpSourceDir = &lt;C:\WINNT\Profiles\profile&gt;,
lpDestinationDir = &lt;\\PDCServerName\profiles\profile&gt;, dwFlags = 0x32
ReconcileFile: C:\WINNT\Profiles\profile\NTUSER.DAT ==&gt;
\\PDCServerName\profiles\profile\NTUSER.DAT  [OK]
ReconcileFile: C:\WINNT\Profiles\profile\ntuser.dat.LOG ==&gt;
\\PDCServerName\profiles\profile\ntuser.dat.LOG  [OK]
CopyProfileDirectory: Leaving with a return value of 1
UnloadUserProfile: Leaving with a return value of 1
 
 
<PRE>Keywords          : nthowto NTSrv
Version           : WinNT:4.0
Platform          : winnt
Issue type        : kbhowto</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 17, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
