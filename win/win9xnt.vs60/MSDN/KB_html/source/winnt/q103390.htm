

<HTML>
<HEAD>
<TITLE>Network Access Validation Algorithm and Example </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q103390">
<META NAME="KBModify" CONTENT="1997/03/25">
<META NAME="KBCreate" CONTENT="1993/08/23">
<META NAME="Keywords" CONTENT="kbnetwork ntnetserv NTSrv">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT=" The following is a simplified algorithm that explains how Windows NT Advanced Server account validation is observed to function during network access. This discussion does not cover the internal workings of this process. With this information, you c...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBG2,QBWP,QAM4,QAWK,QAI5,QA9A,QAHH,QAVZ,QBW3,QAGU,QBBI,QBWO,QAK7,QBVV,QAZV V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Network Access Validation Algorithm and Example</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 25, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q103390</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Advanced Server version 3.1
<LI>Microsoft Windows NT Server versions 3.5, 3.51, 4.0
</UL> 
<P>
The following is a simplified algorithm that explains how Windows NT
Advanced Server account validation is observed to function during
network access. This discussion does not cover the internal workings
of this process. With this information, you can predict Windows NT
network logon behavior under deterministic conditions.
<P>
Keep in mind when following this article that the local database is the
ONLY
database on a domain controller.  But on the other server and all
workstations the local database is different than the domain controller.
<P>
NOTE: All references to Windows NT Advanced Server in this article also
include Windows NT Server.
<P>
<P><h3>Background Information</h3>
 
<P>
When two Microsoft network systems communicate over a network, they
use a high-level protocol called server message block (SMB). These
commands are embedded within the transport protocols like NetBEUI or
TCP/IP. When a client carries out a NET USE command, it sends out a
"SMB Session Setup and X" frame.
<P>
In Windows NT, the Session Setup SMB includes the user account, a
function of the encrypted password and login domain. An Advanced
Server will look at all of this information to determine if the client
has permissions to complete the NET USE command.
<P>
<P><h3>Algorithm</h3>
 
<P>
Windows NT workstation sends the following command to an Advanced
Server:
<P>
<PRE>   NET USE x: \\server\share

</PRE>The Windows NT client sends a Session Setup SMB that contains its
<PRE>    Login Domain, User Account and Password.
</PRE>The Advanced Server checks the SMB specified Domain name
If  the domain is the Advanced Server's own Domain then
<PRE>    It checks its own Domain SAM[Security Account Manager]database for
        a matching account.
    If  it finds a matching account then
        The SMB password is compared to the Domain Database password.
        If  the password matches then
            The Command Completed Successfully.
        If  the password does NOT match then
            User is prompted for a password.
                It is retested as above.
            System error 1326 has occurred.  Logon failure: unknown
            user name or bad password.
        End
    If  it does NOT find the account in the domain SAM database then
        Guest permissions are tested.
        If  the Guest account is Enabled
            The Command Completed Successfully.
        If  the Guest account is Disabled
            * See Note A.
            User is prompted for a password.
            System error 1326 has occurred.  Logon failure:
                unknown user name or bad password.
        End

</PRE>If  the Domain specified in the SMB is one that the Advanced
<PRE>        Server TRUSTS then
    The Advanced Server will do pass through authentication.  The
        network logon request will be sent to an Advanced Server in the
        specified Trusted Domain.
    The Trusted Domain Advanced Server checks its own Domain database
        for a matching account.
    If  it finds a matching account then
        It looks to see if the Account is a Local or Global Account.
        If  the Account is Local then
            Guest permissions on the Original Server are tested.
            If  the Guest account is Enabled
                The Command Completed Successfully.
            If  the Guest account is Disabled
                * See Note A.
                User is prompted for a password.
                System error 1326 has occurred.  Logon failure:
                unknown user name or bad password.
        End
        If  the Account is Global
            The SMB password is compared to the Domain Database
                password.
            If  the password matches then
                The Command Completed Successfully.
                * See Note B.
            If  the password does NOT match then
                User is prompted for a password.
                    It is retested as above.
                System error 1326 has occurred.  Logon failure:
                unknown user name or bad password.
        End
    If  it does NOT find the account in the Trusted domain
            database then
        Guest permissions are tested on the ORIGINAL Advanced
            Server -NOT the Trusted Advanced Server.  * See Note C.
        If  the Guest account is Enabled
            User will have original server guest access.
            The Command Completed Successfully.
        If  the Guest account is Disabled
            * See Note A.
            User is prompted for a password.
            System error 1326 has occurred.  Logon failure:
                unknown user name or bad password.
    End

</PRE>If  the Domain specified in the SMB is UNKNOWN by the Advanced
<PRE>        Server. [A Domain was specified but it was not
        recognized by the Server as a Trusted Domain or
        its own.]
    It  will check its own Domain Account Database for
        a matching account
    If  the Advanced Server finds a matching account then
        The SMB password is compared to the Domain Database password.
        If  the password matches then
            The Command Completed Successfully.
        If  the password does NOT match then
            The User is prompted for a password.
                It is retested as above.
            System error 1326 has occurred.  Logon failure: unknown
            user name or bad password.
    End
    If  it does NOT find the account in the domain database then
        Guest permissions are tested.
        If  the Guest account is Enabled
            The Command Completed Successfully.
        If  the Guest account is Disabled
            System error 1326 has occurred.  Logon failure:
            unknown user name or bad password.
    End

</PRE>If  the Domain specified in the SMB is NULL [None specified] then
<PRE>    The Advanced Server will treat this a local network logon.  It
        will check for a matching account in its own SAM Database.
    If  it finds a matching account then
        The SMB password is compared to the SAM Database password.
        If  the password matches then
            The Command Completed Successfully.
        If  the password does NOT match then
            The User is prompted for a password.
                It is retested as above.
            System error 1326 has occurred.  Logon failure: unknown
            user name or bad password.
    End
    If  it does NOT find the account in the local SAM Database then
        The Advanced Server will Simultaneously ask another Advanced
            Server in each Domain that it Trusts if it has account that
            matches the SMB account.
        The first Trusted Advanced Server to reply is sent a request to
            perform pass through authentication of the client
            information.
        The Trusted Advanced Server will look in its own SAM Database.
        If  an account that matches the SMB account is found then
            It looks to see if the Account is a Local or Global
                Account.
            If  the Account is Local then
                Guest permissions on the original Server are tested.
                If  the Guest account is Enabled
                    The Command Completed Successfully.
                If  the Guest account is Disabled
                The user will be prompted for a password.
                No matter what password is entered, user will receive
                    "Error 5: Access has been denied."
            End
            If  the Account is Global
                The password specified in the SMB is compared
                    to the SAM Database password.
                If  the password matches then
                    The Command Completed Successfully.
                If  the password does NOT match then
                    The User is prompted for a password.
                        It is retested as above.
                    System error 1326 has occurred.  Logon failure:
                    unknown user name or bad password.
            End
    If  no Trusted Domains respond to request to identify the
        account then
        Guest permissions are tested on the Original Advanced Server -
            not the Trusted server.
        If  the Guest account is Enabled
            The Command Completed Successfully.
        If  the Guest account is Disabled
            System error 1326 has occurred.  Logon failure:
            unknown user name or bad password.
    End

</PRE><h3>Notes</h3>
 

<OL><P><LI>At the point that the GUEST account is disabled and the user does
   not have an account, the Windows NT Server will still request a
   password. Although no password will meet its requirements, it will
   still request it. This is a security measure. It insures that an
   unauthorized user cannot tell the difference between a case where
   an account exists and when the account does not exist. Password
   prompting always occurs regardless if the account exists.

<P><LI>At this point, the following information is returned from the
   Trusted Domain in the Response:  Domain SID, User ID, Global Groups
   Memberships, Logon Time, Logoff Time, KickOffTime, Full Name, Password
   LastSet, Password Can Change Flag, Password Must Change Flag, User
   Script, Profile Path, Home Directory and Bad Password Count.

</OL></UL><LI>Guest account only matters in the domain of the Server you are
   attempting to access. Guest accounts on trusted domains never come
   into play.

<LI>All steps above assume Global Account unless specified as Local
   Account. See the "Concepts and Planning Guide" for more information
   on account types.

<LI>The actual internal process is more complicated than the steps
   described above.

<LI>This does not cover the actual pass-through authentication
   mechanics. For more information, query on the following words in
   the Microsoft Knowledge Base:
<P>
<P><PRE>      authentication and msv
</PRE>
<LI>This does not cover the password encryption process used in Windows NT.
   For more information, query on the following words in the Microsoft
   Knowledge Base:
<P>
<P><PRE>      authentication and msv
</PRE><P>
   A function of the One Way Encrypted password is sent.

<LI>This article does not detail the internal workings of the MS
   Authentication Module.

<LI>The above model assumes that the Guest Account, when enabled, has no
   password. This is the default in Windows NT. If a guest account
   password is specified, it must match the users password that sends in
   the SMB.
<P>
</UL><h3>Example</h3>
 
<P>
The following are examples of this algorithm in action:
<P>
I am logged on to my Windows NT workstation local computer. I am using
the same account name and password that is in SCRATCH-DOMAIN Advanced
Server Domain account database. When I carry out the NET USE \\SCRATCH
(Domain Controller for SCRATCH-DOMAIN) command, the command completes
successfully. When I carry out the NET USE \\NET (Controller that
Trust SCRATCH-DOMAIN) command. I receive the error message "System
error 1326 has occurred. Logon failure: unknown user name or bad
password." My account \SCRATCH-DOMAIN\USER1 has permissions on \\NET?
What is the problem?
<P>
<P><h3>Configurations</h3>
 
<P>
Windows NT workstation:

<UL><LI>Login account: USER1
<LI>Password:      PSW1
<LI>Login Domain:  LOCAL1
<P>
</UL>Windows NT Advanced Server:

<UL><LI>Server Name:            NET
<LI>Advanced Server Domain: NET-DOMAIN
<LI>Trust:                  NET-DOMAIN Trust SCRATCH-DOMAIN (Therefore,
   accounts on SCRATCH-DOMAIN can be granted permissions in the NET-
</UL>DOMAIN.
<UL><LI>Domain Account Database for NET-DOMAIN does NOT contain an
   account for USER1.
<LI>Guest Account is DISABLED.
<P>
</UL>Windows NT Advanced Server:

<UL><LI>Server Name:                       SCRATCH
<LI>Advanced Server Domain:            SCRATCH-DOMAIN
<LI>Domain Database contains account:  USER1
<LI>Domain Database contains password: PSW1
<P>
</UL><h3>Answer</h3>
 
<P>
In this example, the Windows NT workstation is logged on to its local
workstation domain--not the Advanced Server SCRATCH-DOMAIN where its
domain account resides.
<P>
NET USE x: \\NET\share

<UL><LI>When the Windows NT workstation carried out the NET USE x:
   \\NET\share command, it sent out account = "USER1", password = "PSW1"
   and domain = "LOCAL1" in the Session Setup SMB.

<LI>The Advanced Server \\NET received the SMB and looked at the account
   name.

<LI>It looks in its local domain account database and does not find a
   match.

<LI>\\NET then looks at the SMB Domain name.

<LI>It does not trust "LOCAL1" so it does not check any of its trusted
   domains.

<LI>\\NET then checks its Guest account.

<LI>The guest account is disabled so the "System error 1326 has
   occurred. Logon failure: unknown user name or bad password." message
   is generated.
<P>
</UL>NET USE x: \\SCRATCH\share

<UL><LI>When the Windows NT workstation carried out the NET USE x:
   \\SCRATCH\share command, it sent out account = "USER1",
   password = "PSW1" and domain = "LOCAL1" in the Session Setup SMB.

<LI>The Advanced Server \\SCRATCH receives the SMB and looks at the account
   name.

<LI>It looks in its local domain account database and finds a match.

<LI>\\SCRATCH then compares the SMB password to the Domain account
</UL>password.

<UL><LI>The passwords match so the "Command Completes Successfully" message
   is generated.
<P>
</UL>In these cases, the trust relationship does not come into play. If the
Workstation had been logged on to the SCRATCH-DOMAIN, the
NET USE x: \\NET\share command would have been successful.
<P>
The real answer here is to have all workstations log on to an Advanced
Server domain. In order to login, the user must specify their correct
domain, account, and password. After this is done, all NET USE type
commands will pass the correct domain, account, and password.
Administrators should try and avoid duplicate accounts on both Windows
NT workstations and multiple Advanced Server domains.
<P>
<P><h3>USER: Workaround</h3>
 
<P>
There is one workaround that can be used in these cases. From the
Windows NT workstation, you could carry out the following command
<P>
<PRE>   NET USE X: \\NET\SHARE /USER:SCRATCH-DOMAIN\USER1 PSW1

</PRE></OL>where
<P>
<PRE>  - \\NET = The computer name of the Advanced Server being accessed.
  - \SHARE = The share name.
  - /USER: command line parameter that lets you specify the domain,
    account and password that should be specified in the Session Setup
    SMB.
  - SCRATCH-DOMAIN = Domain name of the Advanced Server where the user
    account resides.
  - \USER1 = account to be validated against.
  - PSW1 = password that matches account on the domain.

</PRE>For more information, type the following at a Windows NT command
prompt:
<P>
<PRE>   NET USE /?

</PRE><h3>NULL Domain Names</h3>
 
<P>
In addition to Windows for Workgroups 3.1, other Microsoft network
clients also send NULL Domain Names in the Session Setup SMB [x73].
They will also exhibit the behavior described above in the example
problem. The following is a table of how each client handles the
Domain Name.
<P>
<PRE>MS Network                        Domain Name
  Client                           Specified
</PRE> 
<P>
<PRE>Windows for Workgroups 3.1         NULL

Windows for Workgroups 3.11        Logon domain name.

</PRE>MS OS/2 LAN Manager 2.0, 2.1,
<PRE>and 2.2                            NULL

MS-DOS LAN Manager 2.0             NULL

MS-DOS LAN Manager 2.1 &amp; 2.2       Logon domain name. * See Note below.
</PRE>(Including Windows on MS-DOS)
<P>
<PRE>Windows NT 3.1                     Logon domain name.

</PRE><h3>Notes</h3>
 
<P>
The default domain name is specified in the LANMAN.INI file on the
"DOMAIN =" line. This can be overridden by the /DOMAIN: switch with
the NET LOGON command.
<P>
There are typically two representations for "NULL" in the SMB: A
zero-length domain name and a one-byte domain name consisting of the
character '?'. The Windows NT SMB server catches the '?' and
translates it to NULL before passing it to the local security
authority (LSA).
<P>
<P><h3>Troubleshooting</h3>
 
<P>
A good tip for troubleshooting network access problems is to enable
auditing by doing the following:

<OL><P><LI>In the User Manager for Domains window, choose Audit from the Policies
   menu.

<P><LI>Select the Audit These Events button.

<P><LI>Select the Logon and Logoff Success and Failure options.
<P>
</OL>Now, anytime a network user access this server remotely, an audit
trail will be logged in the Event Viewer. In the Event Viewer, choose
Security from the Log menu to see the events.
<P>
For information on trust relationships, pass-through authentication,
user permissions, and domain logins, please see your Windows NT
Advanced Server "Concepts and Planning" guide or query on the
following words in the Microsoft Knowledge Base:
<P>
<PRE>   authentication and pass-through
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: wfw wfwg prodnt<BR>
Keywords            : kbnetwork ntnetserv NTSrv<BR>
Version             : 3.1 3.5 3.51 4.0<BR>
Platform            : WinNT<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 25, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
