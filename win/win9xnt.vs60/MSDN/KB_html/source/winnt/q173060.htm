

<HTML>
<HEAD>
<TITLE>Performance Monitor Counters Cause Stop or Error Messages </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q173060">
<META NAME="KBModify" CONTENT="1998/03/05">
<META NAME="KBCreate" CONTENT="1997/08/25">
<META NAME="Keywords" CONTENT="NTSrvWkst ntstop prodnt kbtool">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT=" IMPORTANT: This article contains information about editing the registry. Before you edit the registry, you should first make a backup copy of the registry files (System.dat and User.dat). Both are hidden files in the Windows folder.   When you use P...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Security" CONTENT="PUBLIC ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAY5,QAMR,QAU3,QAM9,QALX,QBWP,QBHQ,QAL0,QAB4,QAIJ,QDIU,QBWS,QAY2,QAKJ,QAKP V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Performance Monitor Counters Cause Stop or Error Messages</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 5, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q173060</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Workstation version 4.0
<LI>Microsoft Windows NT Server version 4.0
</UL> 
<P>
IMPORTANT: This article contains information about editing the registry.
Before you edit the registry, you should first make a backup copy of the
registry files (System.dat and User.dat). Both are hidden files in the
Windows folder.
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you use Performance Monitor to monitor a computer (either locally or
from a remote computer), the following blue screen STOP message may be
produced on the computer being monitored:
<P>
<PRE>   STOP:0xC000021A (0xe1638608, 0xc0000005, 0x00000000, 0x00000000).

</PRE>-or-
<P>
You get the following message every time you click the + (plus) button
while monitoring locally in Performance Monitor:
<P>
<PRE>   WinLogon.exe App. Error - The instruction at x77f648e2 referenced
   memory at x001cce35. The memory could not be read. Click OK to
   terminate the app.

</PRE>NOTE: Actual memory locations will vary.
<P>
<P><h2>CAUSE</h2>
 
<P>
When you use Performance Monitor to monitor a computer remotely, the
initiating computer attaches to the target computer's Winlogon process
through RPC. The Winlogon process has a perflib component in it for
collecting data. The shared data is passed from the performance counters'
.DLL to Winlogon on the target computer. The performance counters' DLLs
sometimes overwrite their buffers. In the case of remote monitoring, this
overwrite occurs in the context of the Winlogon process on the target
computer, which causes it to have an access violation, compromises the
Winlogon subsystem (which may create a breach of security), and forces
Windows NT into kernel mode to start checking for bugs.
<P>
The performance counter DLLs make three functions available to other
modules: Open, Collect, and Close. It is usually the Collect function that
causes the problem.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Have the malfunctioning extensible Performance Counter fixed so that it
does not overwrite its buffers.
<P>
-or–
<P>
Disable the malfunctioning performance counter's .dll by renaming or
removing its entry from the Windows NT registry.
<P>
To locate all extensible performance counters, use Exctrlst.exe, which
is part of the Windows NT 4.0 Resource Kit. You can run Exctrlst.exe
locally or remotely to bring up a list of all of the extensible counters
found in the computer's registry.
<P>
The counters’ registry entries are located at the following key:
<P>
<PRE>   Hkey_Local_Machine\System\CurrentControlSet\Services\
      Service_Name\Performance\Library.

</PRE>NOTE: The above registry key is one path; it has been wrapped for
readability.
<P>
To disable an extensible counter .dll:
<P>
WARNING: Using Registry Editor incorrectly can cause serious problems that
may require you to reinstall Windows 95. Microsoft cannot guarantee that
problems resulting from the incorrect use of Registry Editor can be solved.
Use Registry Editor at your own risk.
<P>
For information about how to edit the registry, view the Changing Keys and
Values online Help topic in Registry Editor (Regedit.exe). Note that you
should make a backup copy of the registry files (System.dat and User.dat)
before you edit the registry.

<OL><P><LI>Start Registry Editor using RegEdt32.exe.

<P><LI>At each performance entry listed by Exctrlst.exe, select the Library
   value and modify the library name by prefixing it with two x's. For
   example, if the library name is OrigLib.dll, change it to xxOrigLib.dll

<P><LI>When you have changed each performance entry under the
   CurrentControlSet\Services key, restart Perfmon to see if it works.

<P><LI>If Perfmon works, repeat steps 1 and 2, restoring the original library
   name, changing a new one, and trying Perfmon after each change to see
   which library causes the problem.
<P>
<P>
</OL>- or -
<P>

<OL><P><LI>If Exctrlst.exe is unavailable, start the Registry Editor using
   RegEdt32.exe.

<P><LI>Under the HKEY_LOCAL_MACHINE subtree, go to the following subkey:
<P>
<P><PRE>      System\CurrentControlSet\Services
</PRE>
<P><LI>Click Find Key on the View menu.

<P><LI>Type "performance" as the search string, then search down from there.

<P><LI>To disable an extensible counter DLL when you find a performance entry,
   select the Library value and modify the library name by prefixing it
   with two x's: for example, if the library name is OrigLib.dll, change it
   to xxOrigLib.dll.

<P><LI>When you have changed each performance entry under the
   CurrentControlSet\Services key, restart Perfmon to see whether it
   works. If it does, then repeat steps 4 and 5, restoring each original
   library name and trying Perfmon after each change to see which library
   causes the problem.
<P>
</OL>For more information see "Creating the Performance DLL" in the Win32 SDK
<P>
For more information on performance counters, see the following article in
the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../winnt/q152513.htm">Q152513</A></B>
   TITLE     : Troubleshooting Performance Monitor Counter Problems.

</PRE></OL>-  or –
<P>
If you prefer, you can also solve this problem by configuring Windows NT to
write a guard page on either side of the shared memory buffer with various
levels of checking. This setting was enabled by default in early Windows NT
service packs. The guard pages caused too many page faults for large
counters, however, which degraded system performance significantly. In
Service Pack 3, the guard pages and checking were turned off by default.
<P>
To enable the guard page setting, use the following steps:
<P>
WARNING: Using Registry Editor incorrectly can cause serious problems that
may require you to reinstall Windows 95. Microsoft cannot guarantee that
problems resulting from the incorrect use of Registry Editor can be solved.
Use Registry Editor at your own risk.
<P>
For information about how to edit the registry, view the Changing Keys and
Values online Help topic in Registry Editor (Regedit.exe). Note that you
should make a backup copy of the registry files (System.dat and User.dat)
before you edit the registry.

<OL><P><LI>Start Registry Editor (Regedt32.exe) and go to the following sub-key:
<P>
<P><PRE>      HKEY_LOCAL_MACHINE\Software\Microsoft\WindowsNT\
<PRE></PRE>        \CurrentVersion\Perflib

   NOTE: The above registry key is one path; it has been wrapped for
   readability.

      Value: ExtCounterTestLevel
      Type: REG_DWORD
      Data: 2

</PRE><P><LI>Select the desired ExtCounterTestLevel value. You can choose a value
   ranging from 1 to 4:
<P>
<P><PRE>      1 - Most extensive testing, can be expensive.
      2 - Basic testing.
      3 - No testing.
      4 - Don't even allocate a guard page (default from SP3 onwards).
</PRE>
<P><LI>Once this is entered, restart the system.
<P></OL>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: 0xc21A perfmon<BR>
Keywords          : NTSrvWkst ntstop prodnt kbtool<BR>
Version           : WinNT:4.0<BR>
Platform          : winnt<BR>
Issue type        : kbprb<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 5, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
