

<HTML>
<HEAD>
<TITLE>TCP/IP Performance Degrades When Resuming Large Data Transfer </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q153596">
<META NAME="KBModify" CONTENT="1996/09/07">
<META NAME="KBCreate" CONTENT="1996/07/24">
<META NAME="Keywords" CONTENT="kbnetwork">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT="  Windows NT clients using TCP/IP may notice a considerable delay resuming data transfer to client applications that take a long time to clear the TCP/IP receive window.  A Protocol Analyzer trace of the slow performance will show the following behav...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QARL,QAB7,QAH6,QBWP,QDNT,QBWD,QAR4,QAML,QAEF,QAA7,QAYY,QAMR,QAKC,QAAP,QBVX V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>TCP/IP Performance Degrades When Resuming Large Data Transfer</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 7, 1996</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q153596</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Workstation version 3.51
<LI>Microsoft Windows NT Server version 3.51
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Windows NT clients using TCP/IP may notice a considerable delay resuming
data transfer to client applications that take a long time to clear the
TCP/IP receive window.
<P>
A Protocol Analyzer trace of the slow performance will show the following
behavior:

<OL><P><LI>The server sends a large data transfer.

<P><LI>The client runs out of receive windows space and indicates a zero-byte
   window.

<P><LI>The server enters exponential backoff until it hits the maximum limit of
   240 seconds between window probe packets. Because the time between
   probes is longer than the 120-second Address Resolution Packet (ARP)
   cache life, each new window probe now requires that the server ARP for
   the client's Media Access Control (MAC) address.

<P><LI>The client clears its receive window and advertises additional
   window space.

<P><LI>The server begins transmitting data with an incorrect sequence number.

<P><LI>The client acknowledges a previous data send.

<P><LI>The server takes up to four minutes to send the correct sequence number.
<P>
</OL><h2>CAUSE</h2>
 
<P>
The server falls out of sequence because its window probes are 240 seconds
apart so the server has to ARP for the client's MAC address when the client
advertises its new window space. The reason this causes the server to
fall out of sequence is that the server begins sending data immediately
after discovering that the client has additional window space. Because the
ARP table entry for the client is in the resolving state when the server
starts indicating data, TCP/IP cannot send the data to the client.
<P>
In accordance with RFC the ARP cache will only buffer one packet when the
destination IP address is in the resolving state. Windows NT buffers the
last packet only, so all sends, except for the last, are dropped until the
ARP entry has been resolved. When the ARP entry for the client is resolved
TCP/IP sends the last packet that was cached to the client; the packet is
out of sequence because the prior sends were dropped while the ARP entry
was resolving. The excessive delay that occurs is caused by the server's
taking 240 seconds to send the correct sequence number.
<P>
The reason the server takes 240 seconds to send the correct sequence number
is that a retransmit timer has started running. The retransmit timer
takes 240 seconds to complete before the packet with the correct sequence
number can be sent.
<P>
Note:  For additional information on the ARP cache please refer to
<PRE>       RFC 1122.

</PRE></OL><h2>MORE INFORMATION</h2>
 
<P>
Example Protocol Analyzer Trace:
<P>
<PRE>1  0.000   Client -&gt; Server
   TCP .A...., len:    0, seq:2192824888, ack: 578989364, win:    0

</PRE>2  153.452 Client -&gt; Server
<PRE>   TCP .AP..., len:  512, seq:2192824888, ack: 578989364, win:    0

3  0.008   Client -&gt; Server
   TCP .A...., len:    0, seq:2192825400, ack: 578989364, win:14336

4  0.002   Client -&gt; Server ARP Reply

5  0.001   Server -&gt; Client
   TCP .A...., len: 1460, seq: 578992284, ack:2192825400, win:48640

6  0.005   Client -&gt; Server
   TCP .A...., len:    0, seq:2192825400, ack: 578989364, win:14336

7  0.195   Client -&gt; Server
   TCP .A...., len:    0, seq:2192825400, ack: 578989364, win:14336

8  4.785   Server -&gt; Client
   TCP .A...., len:  357, seq: 578993744, ack:2192825400, win:48640

9  0.003   Client -&gt; Server
   TCP .A...., len:    0, seq:2192825400, ack: 578989364, win:14336

10 0.193   Client -&gt; Server
   TCP .A...., len:    0, seq:2192825400, ack: 578989364, win:14336

</PRE>11 235.180 Client -&gt; Server
<PRE>   ARP Reply

12 0.000   Server -&gt; Client
   TCP .A...., len: 1460, seq: 578989364, ack:2192825400, win:48640

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Windows NT version 3.51.
This problem was corrected in the latest Windows NT 3.51 U.S. Service
Pack. For information on obtaining the Service Pack, query on the
following word in the Microsoft Knowledge Base (without the spaces):
<P>
<PRE>   S E R V P A C K
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
KBCategory: kbnetwork<BR>
KBSubcategory: ntdriver<BR>
Additional reference words: 3.50 3.51 prodnt<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 7, 1996</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
