

<HTML>
<HEAD>
<TITLE>How to Restore a Corrupted DHCP Database File </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q173396">
<META NAME="KBModify" CONTENT="1998/02/25">
<META NAME="KBCreate" CONTENT="1997/09/03">
<META NAME="Keywords" CONTENT="nthowto ntnetserv NTSrv kbnetwork">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT="WARNING: Using Registry Editor incorrectly can cause serious problems that may require you to reinstall Windows 95. Microsoft cannot guarantee that problems resulting from the incorrect use of Registry Editor can be solved. Use Regiistry Editor at yo...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QDJG,QBWP,QDIU,QAZV,QDKY,QANE,QA1S,QA9N,QA3W,QAUR,QAFI,QAY2,QACI,QDIK,QALW V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>How to Restore a Corrupted DHCP Database File</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 25, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q173396</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Server versions 3.51 and 4.0
</UL> 
WARNING: Using Registry Editor incorrectly can cause serious problems that
may require you to reinstall Windows 95. Microsoft cannot guarantee that
problems resulting from the incorrect use of Registry Editor can be
solved. Use Regiistry Editor at your own risk
<P>
<P><h2>SUMMARY</h2>
 
<P>
This article discusses methods that may be used to recover a corrupted
Dynamic Host Configuration Protocol (DHCP) database.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The following event log messages appear on a computer running Windows NT
Server version 3.51 when the DHCP database has been corrupted:
<P>
<PRE>   Event ID: 1014
   Source: DhcpServer
   Description: The JET database returned the following Error: -510.

</PRE>-or-
<P>
<PRE>   Event ID: 1014
   Source: DhcpServer
   Description: The JET database returned the following Error: -1022.

</PRE>-or-
<P>
<PRE>   Event ID: 1014
   Source: DhcpServer
   Description: The JET database returned the following Error: -1850.

</PRE>Using Jet.exe to compact the DHCP database does not resolve the issue.
<P>
For additional information, please see the following article in the
Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../winnt/q153476.htm">Q153476</A></B>
   TITLE     : DHCP Stops Assigning IP Addresses to Clients

</PRE>The DHCP database is contained in the Dhcp.mdb file located in the
%SystemRoot%\System32\Dhcp folder. The DHCP server uses this file to
record and store information concerning active leases and reservations.
Most of this information is also contained in the following registry key:
<P>
<PRE>   HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services
   \DHCPServer\Configuration

</PRE>NOTE: The above registry key is one path; it has been wrapped for
readability.
<P>
Whenever the DHCP service shuts down correctly, it makes a backup copy of
both the database file (Dhcp.mdb) and the registry key. The backup
information from the registry is contained in the file Dhcpcfg. For
Windows NT 3.51, the file Dhcp.mdb is located in the
%SystemRoot%\System32\Dhcp\Backup\Jet folder. In Windows NT 4.0, the
file Dhcp.mdb is located in the %SystemRoot%\System32\Dhcp\Backup\Jet\New
folder. Both versions of Windows NT store the Dhcpcfg file in the
%SystemRoot%\System32\Dhcp\Backup folder.
<P>
WARNING: Using Registry Editor incorrectly can cause serious problems that
may require you to reinstall Windows 95. Microsoft cannot guarantee that
problems resulting from the incorrect use of Registry Editor can be
solved.
Use Registry Editor at your own risk.
<P>
For information about how to edit the registry, view the Changing Keys and
Values online Help topic in Registry Editor (Regedit.exe). Note that you
should make a backup copy of the registry files (System.dat and User.dat)
before you edit the registry.
<P>
To recover a corrupted DHCP database, use one of the following methods:

<UL><LI>Restore a backup copy of the database file, Dhcp.mdb
<P>
</UL>- or-

<UL><LI>Generate a new database file using the DHCP Configuration registry
   key.
<P>
</UL>Restoring a backup copy of the database file is the recommended method
because you will not lose information when you use it.
<P>
After you recover your database file using one of the methods above, you
will need to reconcile the information between the database file and the
registry information.
<P>
NOTE: The following steps assume that your DHCP server will not start
because of a corrupted DHCP database. If your DHCP server starts, but the
database is corrupted, you will then need to begin by stopping the
service.
To stop the DHCP server service, type the following at a command prompt:
<P>
<PRE>   net stop dhcpserver

</PRE><h3>Restoring a Backup Copy of the Database</h3>
 

<OL><P><LI>Move the files from your existing DHCP folder to a different location,
   being careful to keep the DHCP folder structure intact. For example,
   type the following at a command prompt and press ENTER after each line:
<P>
<P><PRE>      md c:\Olddhcp
      move %SystemRoot%\system32\DHCP\*.* C:\Olddhcp
</PRE>
<P><LI>Remove the corrupted database file.

<P><LI>Copy the backup database file into the DHCP folder by typing the
  following at a command prompt, and then pressing ENTER:
<P>
   Windows NT 3.51:
<P>
<P><PRE>      copy %SystemRoot%\system32\dhcp\backup\jet\dhcp.mdb
      %SystemRoot%\system32\dhcp\dhcp.mdb
</PRE><P>
   Windows NT 4.0:
<P>
<P><PRE>      copy %SystemRoot%\system32\dhcp\backup\jet\new\dhcp.mdb
      %SystemRoot%\system32\dhcp\dhcp.mdb
</PRE><P>
   NOTE: The above command lines are continuous lines; they have been
   wrapped for readability.
<P>
</OL>You may also choose to restore the Dhcp.mdb file to the
%SystemRoot%\System32\Dhcp folder from a tape backup or other backup
media.
<P>
Because you are using an existing database file, whether you restore it
from backup media or the backup folder, you should compress it using the
Jetpack utility.
<P>
For additional information, please see the following article in the
Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../winnt/q145881.htm">Q145881</A></B>
   TITLE     : How to Use Jetpack.exe to Compact a WINS or DHCP Database

</PRE></OL>The procedure above should allow the service to start, but if your scope
information is missing it may be necessary to use a backup copy of
the Dhcpcfg registry file to restore your scope and reservation
information. Refer to steps 5 through 11 in the "From the New DHCP Server"
section of the following article:
<P>
<PRE>   Article-ID: <B><A href="../winnt/q130642.htm">Q130642</A></B>
   Title     : How to Move a DHCP Database to Another Windows NT Server

</PRE><h3>Generating a New Database File</h3>
 

<OL><P><LI>Move the files in your existing DHCP folder to a different location,
   being careful to keep the DHCP folder structure intact. For example,
   type the following at a command prompt, pressing ENTER after each line:
<P>
<P><PRE>      md c:\olddhcp
      move %SystemRoot%\system32\dhcp\*.* c:\olddhcp
</PRE>
<P><LI>Select the next step from the following list, depending on which
   version of Windows NT Server you are using:
<P>
   Windows NT Server 3.51:
<P>
<P><PRE>      Expand a new copy of System.mdb from the original Windows NT Server
      source media by inserting your original Windows NT Server 3.51 CD
      into your CD-ROM drive, typing the following at a command prompt,
      and then pressing ENTER:
</PRE><P>
<PRE>         expand D:\I386\System.md_ %SystemRoot%\System32\Dhcp\System.mdb

      where D: is your CD-ROM drive and i386 is your platform.

   Windows NT Server 4.0:

      Restart the DHCP server with an empty DHCP folder. Windows NT 4.0
      does not use a System.mdb file.

</PRE></OL>The procedure above should allow the service to start, but if your scope
information is missing, it may be necessary to use a backup copy of the
Dhcpcfg registry file to restore your scope and reservation information.
Refer to steps 5 through 11 in the "From the New DHCP Server" section of
the following article:
<P>
<PRE>   ARTICLE-ID: <B><A href="../winnt/q130642.htm">Q130642</A></B>
   TITLE     : How to Move a DHCP Database to Another Windows NT Server

</PRE><h3>Reconciling DHCP Information</h3>
 
<P>
After you generate a new database file, you may notice that the scope
information is present, but no active leases are displayed. To regain the
active leases, you need to reconcile the database with the information in
the registry using the following steps:

<OL><P><LI>From DHCP Manager, click your scope, and then click Active Leases on
   the Scope menu.

<P><LI>In the Active Leases dialog box, click Reconcile.

<P><LI>Click OK. Your active leases will appear in the Active Leases dialog
   box.
<P>
</OL>NOTE: When you view the properties for a client lease, the computer name
will be listed as the IP address of the lease and an arbitrary hexadecimal
value will be listed as the client identifier. These will be replaced with
the appropriate information as the clients renew their leases.
<P>
Repeat the above procedure for each scope for which you need to reconcile
leases.
<P>
If your DHCP server is Windows NT Server 4.0 SP2 or later, you should
enable IP Conflict Detection as described in the following article:
<P>
<PRE>   ARTICLE-ID: <B><A href="../winnt/q161430.htm">Q161430</A></B>
   TITLE     : Detecting and Flagging Duplicate IP Addresses
</PRE></OL> 
<PRE>Keywords          : nthowto ntnetserv NTSrv kbnetwork
Version           : WinNT:3.51,4.0
Platform          : winnt
Issue type        : kbhowto</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 25, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
