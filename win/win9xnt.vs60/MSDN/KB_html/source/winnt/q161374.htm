

<HTML>
<HEAD>
<TITLE>Delayed-Write Buffers Lost When Impersonate Token Closed </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q161374">
<META NAME="KBModify" CONTENT="1997/09/12">
<META NAME="KBCreate" CONTENT="1996/12/20">
<META NAME="Keywords" CONTENT="ntnetserv NTSrvWkst">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT="  After a service or application goes through the following three steps:  1. The service (or application) has a thread that impersonates a user and logs on to a remote server as the impersonated user  2. Once logged on, the service (or application) o...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAGU,QBF0,QAB4,QAYY,QAW5,QAGI,QBWP,QAUQ,QANN,QALZ,QAH5,QAGB,QACK,QBWS,QAAP V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Delayed-Write Buffers Lost When Impersonate Token Closed</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 12, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q161374</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Workstation versions 3.51 and 4.0
<LI>Microsoft Windows NT Server versions 3.51 and 4.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
After a service or application goes through the following three steps:

<OL><P><LI>The service (or application) has a thread that impersonates a user and
</OL>logs on to a remote server as the impersonated user

<OL><P><LI>Once logged on, the service (or application) opens or creates a file on
</OL>the remote server using a UNC name

<OL><P><LI>Data is written to the file, the file is closed, and the thread then
</OL>logs off
<P>
then the following error message is displayed:
<P>
<PRE>   System Process: Lost Delayed-Write Data.

</PRE></OL><h2>CAUSE</h2>
 
<P>
When a file is opened, it will use write-back caching by default. This
means that when data is written to the file, it is written to the cache,
but not immediately to the file. The cache manager will flush the data to
the file at a later time. When the thread issues the logoff request, the
logoff request may be sent to the remote server before the cache manager
flushes the data to the file (opened with a UNC path name). When the user
log off completes, the file handle will no longer be valid. Later, when the
cache manager flushes the data to the file server, it receives the error
C0000008 (STATUS_INVALID_HANDLE) and then reports the error "System
Process: Lost Delayed-Write Data."
<P>
<P><h2>RESOLUTION</h2>
 
<P>
When opening or creating the file, use the FILE_FLAG_WRITE_THROUGH flag.
This will inform the redirector not to cache write data.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Windows NT versions 3.51
and 4.0. We are researching this problem and will post new information here
in the Microsoft Knowledge Base as it becomes available.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: NT redirector prodnt<BR>
Keywords          : ntnetserv NTSrvWkst<BR>
Version           : 3.51 4.0<BR>
Platform          : winnt<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 12, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
