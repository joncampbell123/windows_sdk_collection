

<HTML>
<HEAD>
<TITLE>WinNT TCP/IP May Reuse TIME-WAIT Connections Prior to 2MSL </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q151418">
<META NAME="KBModify" CONTENT="1997/09/23">
<META NAME="KBCreate" CONTENT="1996/05/22">
<META NAME="Keywords" CONTENT="NTSrvWkst nttcp kbnetwork">
<META NAME="KBArea" CONTENT="Support; KB; winnt, crossnet, iis">
<META NAME="Description" CONTENT="  Under sufficiently high TCP connection rates the Windows NT TCP/IP stack may reuse TCP Control Blocks that are in the TIME-WAIT (also called the 2MSL state) table. This can happen on a heavily loaded Web or FTP server when using graceful TCP closes...">
<META NAME="Product" CONTENT="Windows NT">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QAB5,QA7O,QAOE,QAMN,QDNT,QAI5,QAHC,QBG2,QAKD,QAKC,QABA,QDO3,QAA8,QAHV V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>WinNT TCP/IP May Reuse TIME-WAIT Connections Prior to 2MSL</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 23, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q151418</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Windows NT Workstation version 4.0
<LI>Microsoft Windows NT Server version 4.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Under sufficiently high TCP connection rates the Windows NT TCP/IP stack
may reuse TCP Control Blocks that are in the TIME-WAIT (also called the
2MSL state) table. This can happen on a heavily loaded Web or FTP server
when using graceful TCP closes. Reuse of the Control Blocks may terminate a
TCP connection in its TIME-WAIT state prior to the 2MSL time period
expiring.
<P>
There have been no reports of problems related to this symptom; however the
behavior is not RFC-compliant.
<P>
<P><h2>CAUSE</h2>
 
<P>
In Windows NT the system starts to reuse TCP Control Blocks in TIME-WAIT
when the number of active connections goes over 1000. Windows NT 4.0
Service Pack 3 increased this threshold to 2000.
<P>
For more information on configuring the TIME-WAIT period for Windows NT,
please see the following article(s) in the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../winnt/q149532.htm">Q149532</A></B>
   TITLE     : Windows NT Clients Run Out of Ports

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Windows NT version 4.0. A
supported fix is now available, but has not been fully regression-tested
and should be applied only to systems experiencing this specific problem.
Unless you are severely impacted by this specific problem, Microsoft
recommends that you wait for the next Service Pack that contains this fix.
Contact Microsoft Technical Support for more information.
<P>
This hotfix allows sites with heavy TCP connection rates to configure the
threshold of active TCP connections necessary before TCP control blocks are
reused.
<P>
There are two registry keys that control the use of the TIME-WAIT table:

<UL><LI>MaxFreeTcbs is the threshold number of active TCP connections required
   before TCP Control Blocks in the TIME-WAIT state are reused. Changing
   MaxFreeTcbs allows the system to avoid reusing TCP Control Blocks.
<P>
<P><PRE>      HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip
<PRE></PRE>         \Parameters\MaxFreeTcbs

      Value Type: REG_DWORD
      Valid Range: 0-0xFFFFFFFF
      Default: 1000 (Windows NT 4.0), 2000 (Windows NT 4.0 Service Pack 3)
      Description: Controls the number of active TCP connections required
                   before TCP control blocks in the TIME-WAIT state are
                   reused.

</PRE><LI>MaxHashTableSize controls the size of an internal system data structure
   that controls how fast the system can find a TCP Control Block. The hash
   table allows the system to access TCP Control Blocks faster and this
   table should grow if MaxFreeTcbs is configured higher than the default
   value.
<P>
<P><PRE>      HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip
<PRE></PRE>         \Parameters\MaxHashTableSize

      Value Type: REG_DWORD
      Valid Range: 64-65536 (0x40-0x10000)
      Default: 512
      Description: This value should be set to a power of 2 (e.g. 512,
                   1024, 2048, and so on.) If this value is not a power of
                   2, the system will configure the hash table to the next
                   power of 2 value (for example, a setting of 513 is
                   "rounded up" to 1024.) This value controls how fast the
                   system can find a TCP control block and should be
                   increased if MaxFreeTcbs is increased from the default.
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 4.00 prodnt<BR>
Keywords          : NTSrvWkst nttcp kbnetwork<BR>
Version           : 4.0<BR>
Platform          : winnt<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 23, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
