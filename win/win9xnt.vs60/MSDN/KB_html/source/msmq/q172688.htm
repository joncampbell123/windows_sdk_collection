

<HTML>
<HEAD>
<TITLE>INFO: Writing an MSMQ Application for Offline Operation </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q172688">
<META NAME="KBModify" CONTENT="1997/09/16">
<META NAME="KBCreate" CONTENT="1997/08/13">
<META NAME="Keywords" CONTENT="kbprg MQAPI MQProg MQQueue">
<META NAME="KBArea" CONTENT="Support; KB; msmq">
<META NAME="Description" CONTENT="  You may want to write a Microsoft Message Queue Server (MSMQ) application for a single computer to generate and queue messages while offline and then, when later connected to the network, forward the messages to a remote application or notify the r...">
<META NAME="Product" CONTENT="msmq">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAEV,QAJH,QAKG,QAYC,QAC2,QBW2,QDIO,QAH6,QDNG,QBXS,QBG2,QAZM,QAZL,QAY5,QAVZ V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>INFO: Writing an MSMQ Application for Offline Operation</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 16, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q172688</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Message Queue Server, version 1.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
You may want to write a Microsoft Message Queue Server (MSMQ) application
for a single computer to generate and queue messages while offline and
then, when later connected to the network, forward the messages to a remote
application or notify the remote application that the local queue of
messages is now available for it to open and read.
<P>
IMPORTANT: When writing an offline application using local queues, define
the queues to be Recoverable. Using Express queues may lead to loss of
messages.
<P>
The configuration targeted for individual offline operation is the
Independent Client. The Dependent Client is incapable of operating offline.
The Windows NT Server and SQL Server requirements of a Site controller
configuration, while simpler to code for, would probably be impractical for
a single offline user.
<P>
When the offline computer is an Independent client, you need to write the
offline portion of the application carefully to avoid using APIs that query
the Message Queue Server Information Store (MQIS). The MQIS is held only on
site controllers (PEC/PSC/BSC). Using any API, like MQLocate, that requires
consultation of the MQIS would attempt to generate network traffic, causing
an error or timeout in the application.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
To open a handle to a queue with no connection to a Falcon MQIS server you
can do either of the following:

<UL><LI>Use the DIRECT= format.
<P>
   -or-

<LI>Use the GUID of the queue ("PUBLIC=" format).
<P>
</UL>After the queue is open, all messages will be stored by the QM for the
application until connectivity is regained.
<P>
<P><h3>DIRECT= Format</h3>
 
<P>
This format includes the target computer's name, or the target computer's
network address, and local queue name of the target queue. This method can
only be used when the target computer is directly connectable (one MSMQ
hop) from the source computer.
<P>
Falcon routing will not take place with such addressing. The message is
sent directly to the remote computer's queue as soon as the sending client
regains connectivity with the remote computer. No access to the MQIS is
required.
<P>
To specify the format name, you can do either of the following:

<UL><LI>Use the computer name (for example, \\mymachine).
<P>
   -or-

<LI>Use the TCP/IP address (for example, 203.204.205.206).
<P>
</UL>This method forces the application to store the address information of the
target computer before disconnecting. If you choose to use the TCP/IP
address, this can be problematic if you are also using DHCP, because the
target computer may have changed network addresses since the source
computer stored the address. While the computer name may have been changed
while the source computer was disconnected, this is far less likely to have
occurred.
<P>
<P><h3>PUBLIC= Format</h3>
 
<P>
This format requires your application to cache this GUID before
disconnecting. The MQOpenQueue() will succeed offline, and then you can
send messages, and close the queue handle, and quit the application. All
messages will be stored by the QM for the application.
<P>
A connection to the MQIS server is eventually required using this method.
To actually transfer messages to the remote destination queue , MSMQ needs
to consult an MQIS server in order to resolve the GUID into a network
address. If the MQIS server is down when the sending computer regains
connectivity, the sending computer will not send the messages.
<P>
<P><h3>Sample Code</h3>
 
<P>
<PRE>   Private Sub OpenQueueOffline()
       Dim qinfo As MSMQQueueInfo
       Set qinfo = New MSMQQueueInfo
       Dim q As New MSMQQueue

       txtDirectFormatName = "DIRECT=TCP:157.57.12.62\wiley"

       qinfo.strPathName = ""
       qinfo.strFormatName = ""
       qinfo.strLabel = ""
       qinfo.strFormatName = txtDirectFormatName

       on error goto ErrorHandler
       Set q = qinfo.Open(MQ_SEND_ACCESS, MQ_DENY_NONE)

       If q.isOpen Then
          MsgBox "The queue " + qinfo.strPathName + " is open."
       Else
          MsgBox "The queue " + qinfo.strPathName + " is not open!"
       End If

       'Clean up
       qinfo.strPathName = ""
       Set qinfo = Nothing
       Set q = Nothing
       Exit Function

    ErrorHandler:
       msgbox "error while opening queue: " qinfo.strPathName
       Exit Function

   End Sub

</PRE><h2>REFERENCES</h2>
 
<P>
For more information, please see the MSMQ Offline Support section of the
MSMQ software development kit (SDK).
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: app machine<BR>
Keywords          : kbprg MQAPI MQProg MQQueue<BR>
Version           : WinNT:1.0<BR>
Platform          : winnt<BR>
Issue type        : kbhowto kbinfo<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 16, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
