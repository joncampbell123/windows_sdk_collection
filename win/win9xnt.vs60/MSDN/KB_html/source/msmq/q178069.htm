

<HTML>
<HEAD>
<TITLE>INFO: Storage of Private and Public Keys for MSMQ </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q178069">
<META NAME="KBModify" CONTENT="1997/12/22">
<META NAME="KBCreate" CONTENT="1997/12/14">
<META NAME="Keywords" CONTENT="MQProg MQSecurity">
<META NAME="KBArea" CONTENT="Support; KB; msmq">
<META NAME="Description" CONTENT="  This article describes the storage of private and public keys used by Microsoft Message Queue (MSMQ) for message authentication and encryption.  MORE INFORMATION  The key pairs (public-private) reside in Crypto API, a key container object. Applicat...">
<META NAME="Product" CONTENT="msmq">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAK7,QABG,QAW6,QA0K,QAYY,QAEV,QAB5,QAQT,QBVV,QAPN,QBWG,QBGF,QAJH,QDIT,QA2O V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>INFO: Storage of Private and Public Keys for MSMQ</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  December 22, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q178069</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Message Queue Server version 1.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
This article describes the storage of private and public keys used by
Microsoft Message Queue (MSMQ) for message authentication and encryption.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The key pairs (public-private) reside in Crypto API, a key container
object. Applications do not need to know where and how the key container is
implemented. The key container object should be an opaque object that
contains the keys and is accessed by published interfaces.
<P>
The base Cryptographic Service Provider (CSP) implements the key containers
in the registry. The CSP can reside in the HKEY_CURRENT_USER or
HKEY_LOCAL_MACHINE. The location is determined by passing a flag to
CryptAcquireContext. Other CSPs may implement the key container in a
different location, such as a smart card. MSMQ does not assume anything
about the location of the keys and always works with Crypto API, never
directly with the keys themselves.
<P>
MSMQ uses the base CSP to have data encrypted or decrypted. While the
current implementation for the CSP puts the private keys in
HKLM\Software\Microsoft\Cryptography\MachineKeys\MSMQ, this should not be
relevant information for any application.
<P>
As for authentication, it is a common mistake to think that the private and
public keys reside in the certificate. A certificate is a public piece of
information. It does not matter who receives the certificate. The private
key, however, is a most secret piece of information that should be kept in
a location that is as secure as possible.
<P>
For every certificate there should be some key container that is associated
with it. This key container contains the public and private keys that are
associated with the certificate. A copy of the public key is also placed in
the certificate together with many other pieces of information.
<P>
Crypto API also defines an object that is called a Certificate Store. A
Certificate Store contains certificates and additional information about
each certificate (for example, information about the keys that are
associated with the certificate). This information is an identification of
the specific CSP that is used with the certificate and identification of
the particular key container that is associated with the certificate.
<P>
A Certificate Store can reside in many places, the registry, a file,
memory, and more. MSMQ stores the internal certificate in a Certificate
Store under HKCU\Software\Microsoft\MSMQ\CertStore. The associated keys are
located in HKCU\Software\Microsoft\Cryptography\UserKeys\MSMQ. These
locations also should not be relevant to any application. MSMQ always works
with Crypto API, never directly with the keys themselves.
<P>
MSMQ also stores the public key of a Queue Manager (QM) in the Message
Queue Information Store (MQIS). Applications can retrieve this public key
by calling MQGetMachineProperties() with PROPID_QM_ENCRYPTION_PK. The
calling user should have "get security" permission granted on the computer
in order to successfully retrieve the public key of the computer.
PROPID_QM_ENCRYPTION_PK is unlike all other properties, where the user
should have the "get permissions" permission on the computer.
<P>
MSMQ uses this public key internally to encrypt messages. The QM retrieves
the public key of the destination computer from MQIS. Because in most cases
the QM runs under the local system account, the "get permissions" privilege
should be granted to everyone; otherwise, the QM fails to retrieve the
public key and thus fails to encrypt the messages.
<P>
<P><h2>REFERENCES</h2>
 
<P>
For more information on cryptography, public key encryption, and the
Microsoft CryptoAPI, see the Microsoft Crypto Application Programmer's
Guide, available on the Microsoft Web site at:
<P>
<B><A href="http://www.microsoft.com/intdev/security/">http://www.microsoft.com/intdev/security/</A></B>
<P>
For information on implementing encryption in an MSMQ-based application,
see the MSMQ Software Development Kit (SDK) and Administrators Guide
documentation.
<P>
 
<PRE>Keywords          : MQProg MQSecurity
Version           : WINNT:1.0
Platform          : winnt
Issue type        : kbinfo</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  December 22, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
