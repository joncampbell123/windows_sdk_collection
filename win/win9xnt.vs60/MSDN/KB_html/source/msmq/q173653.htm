

<HTML>
<HEAD>
<TITLE>HOWTO: Memory Handling Tips for MQ Asynchronous Application </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q173653">
<META NAME="KBModify" CONTENT="1997/09/22">
<META NAME="KBCreate" CONTENT="1997/09/09">
<META NAME="Keywords" CONTENT="kbcode MQQueue">
<META NAME="KBArea" CONTENT="Support; KB; msmq">
<META NAME="Description" CONTENT="  When you are using MQReceiveMessage with a callback function in Microsoft Message Queue Server (MSMQ), you should make sure to allocate the MQMSGPROPS structure properly and always close the queue before exiting your application. Improper allocatio...">
<META NAME="Product" CONTENT="msmq">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABI,QAGI,QAY5,QAGB,QAB4,QBV8,QAIF,QAIC,QAB9,QAEV,QAUD,QBW6,QACJ,QBVV,QAPN V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>HOWTO: Memory Handling Tips for MQ Asynchronous Application</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 22, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q173653</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Message Queue Server version 1.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
When you are using MQReceiveMessage with a callback function in Microsoft
Message Queue Server (MSMQ), you should make sure to allocate the
MQMSGPROPS structure properly and always close the queue before exiting
your application. Improper allocation of MQMSGPROPS can cause memory
corruption or error messages. Closing the queue causes any pending Receive
operations to fail and call your callback function, where you can delete
the MQMSGPROPS structure you've allocated.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
When you are using a callback function as an asynchronous mechanism for
MQReceiveMessage, you should be careful in how you allocate and later
deallocate the MQMSGPROPS structure used in the MQReceiveMessage call.
<P>
First, you need to make sure to allocate the structure memory on the heap
instead of the stack. For example, the following will not work:
<P>
<PRE>   HRESULT CallReceive()
   {
      MQMSGPROPS Props;
      ...  //Allocate the properties
      return MQReceiveMessage(..., &amp;Props, ...);
   };

</PRE>Since Props was allocated inside the function call, its memory will likely
be freed before the callback function is called. This can cause Access
Violations, General Protection Faults, or memory corruption when MSMQ or
your callback function attempts to use the structure. Them following shows
a more appropriate method:
<P>
<PRE>   HRESULT CallReceive()
   {
      MQMSGPROPS* pProps = malloc(sizeof(MQMSGPROPS));
      ... //Allocate the Properties
      HRESULT hr = MQReceiveMessage(..., pProps, ..., &amp;ReceiveCallback,
         ...);
      if (FAILED(hr))
         free(pProps);
      return hr;
   };

   void ReceiveCallback(HRESULT hrStatus, ...,MQMSGPROPS*
</PRE>pMessageProps,...)
<PRE>   {
      ... // Process the message
      free(pMessageProps);
   };

</PRE>You should free the MQMSGPROPS structure in your callback function. You
should also make sure that if the original MQReceiveMessage fails, the
structure is disposed of properly.
<P>
Second, you should make sure to always call MQCloseQueue prior to closing
your application. When you call MQCloseQueue all of the pending Receive
operations cause your callback function to be called with the hrStatus
member set to MQ_ERROR_OPERATION_CANCELLED. If you do not close the queue
before exiting, any MQMSGPROPS structures associated with a pending Receive
operation will not be freed.
<P>
<P><h2>REFERENCES</h2>
 
<P>
Microsoft Message Queue Server Help
 
<PRE>Keywords          : kbcode MQQueue
Version           : WinNT:1.0
Platform          : winnt
Issue type        : kbhowto</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 22, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
