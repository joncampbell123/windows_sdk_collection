

<HTML>
<HEAD>
<TITLE>BUG: Message Problems with MSMQ Connector Processing </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q182121">
<META NAME="KBModify" CONTENT="1998/03/09">
<META NAME="KBCreate" CONTENT="1998/03/05">
<META NAME="Keywords" CONTENT="MQQueue kbbug1.00">
<META NAME="KBArea" CONTENT="Support; KB; msmq">
<META NAME="Description" CONTENT="  After a restart of the Microsoft Message Queue Server (MSMQ) Queue Manager on a computer with a connector service, any of the following may occur:   - The connector may not see the messages that were left in the queue.   - The connector may not be ...">
<META NAME="Product" CONTENT="msmq">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Security" CONTENT="PUBLIC ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAEV,QAYC,QBG2,QAID,QACK,QASR,QAKP,QAGB,QBTX,QBVV,QAEF,QBWS,QBFN,QAXB,QAU3 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Message Problems with MSMQ Connector Processing</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  March 9, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q182121</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Message Queue Server version 1.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
After a restart of the Microsoft Message Queue Server (MSMQ) Queue Manager
on a computer with a connector service, any of the following may occur:

<UL><LI>The connector may not see the messages that were left in the queue.

<LI>The connector may not be able to read the messages in the queue,
   even though they appear in Windows NT Performance Monitor.

<LI>The connector receives messages out of order.
<P>
</UL><h2>CAUSE</h2>
 
<P>
The first problem described above occurs when the messages are not in the
connector queue after Queue Manager initialization. The messages are
returned to the temporary queue and moved back to the connector queue. The
recovery process may take a significant amount of time to determine the
connector queue and place the messages there, so that they can be read by
the application.
<P>
The second problem described above occurs if, after recovery, the message
cannot be read from the connector queue. The message can be seen in the
performance counter, but when the application tries to read it, it stops
responding. This is because Transactional messages are stored in two steps.
The first step is to store the message on the disk and update the logger.
The second step allows the application to read the message. There is a
problem in the logic of the first step that prevents the second step from
happening.
<P>
In the third case described above, you should understand that, during
recovery, the messages are ordered according to the packet allocation time.
For the connector, it is possible for packets to be out of order
chronologically.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
To work around these problems, obtain the hotfix mentioned in the STATUS
section of this article. With the hotfix installed, MSMQ returns the
message directly to the connector queue during recovery. To properly track
this, a field was added to the end of the packet containing the GUID of the
destination connector queue.
<P>
If the Foreign Connection Network (CN) is deleted (the connector queue is
no longer valid), MSMQ identifies this case during the validation process.
In such a case, MSMQ closes the queue and deletes all the messages.
However, MSMQ does not send any negative acknowledgment (nack), because the
connector queue is marked as a temporary queue in the driver. The sender
will receive Time To Reach Queue expiration nack.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in Microsoft Message Queue
Server version 1.0.
A supported fix is now available, but has not been fully regression-
tested and should be applied only to systems experiencing this specific
problem. Unless you are severely impacted by this specific problem,
Microsoft recommends that you wait for the next Service Pack that contains
this fix. Contact Microsoft Technical Support for more information.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
After obtaining the hotfix from Microsoft Technical Support, perform the
following steps to install it:

<OL><P><LI>Copy I0267.exe (for computers with an Intel processor) or A0267.exe
   (for computers with an Alpha processor) to an empty directory and then
   run it. The Readme.txt file contains these instructions, as well as
   descriptions of the problems corrected by the hotfix.
<P>
<P><PRE>      Hotfix files
      ------------
</PRE><P>
<P><PRE>      Mqqm.dll
      Readme.txt
</PRE>
<P><LI>Stop any applications that depend on the Microsoft Message Queue
   service.

<P><LI>To install the hotfix, you must stop the Microsoft Message Queue
   service. To do this, do either one of the following, depending on
   whether your computer is clustered:
<P>
<P><PRE>    - On a computer running Microsoft Cluster Server, use Cluster
      Administrator to take the Microsoft Message Queue resource offline.
</PRE><P>
<P><PRE>    - On a non-clustered computer, open Control Panel Services and stop the
      Microsoft Message Queue service.
</PRE>
<P><LI>Copy or rename the Mqqm.dll file in the %windir%\System32 directory, so
   you can restore it if there are problems with the hotfix on your
   computer.

<P><LI>Copy the Mqqm.dll file that was generated from the hotfix (in step 1 of
   this procedure) to the %windir%\System32 directory.

<P><LI>Restart the Microsoft Message Queue Service, using either of the
   following methods (depending on whether your computer is clustered):
<P>
<P><PRE>    - On a computer running Microsoft Cluster Server, use Cluster
      Administrator to bring the Microsoft Message Queue resource online.
</PRE><P>
<P><PRE>    - On a non-clustered computer, open Control Panel Services and start
      the Microsoft Message Queue service.
</PRE>
<P><LI>Restart any applications that depend on the Microsoft Message Queue
   service (that you had stopped in step 2 of this procedure).
<P></OL>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: perfmon hang hangs hung QM<BR>
Keywords          : MQQueue kbbug1.00<BR>
Version           : WINNT:1.0<BR>
Platform          : winnt<BR>
Hardware          : ALPHA x86<BR>
Issue type        : kbbug<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  March 9, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
