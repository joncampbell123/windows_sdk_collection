

<HTML>
<HEAD>
<TITLE>HOWTO: Programmatically Embedding a Message in Another Message </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q170226">
<META NAME="KBModify" CONTENT="1997/06/18">
<META NAME="KBCreate" CONTENT="1997/06/17">
<META NAME="Keywords" CONTENT="EMAPI">
<META NAME="KBArea" CONTENT="Support; KB; mapi">
<META NAME="Description" CONTENT="  This article shows the minimum code necessary to embed a message in a message.  MORE INFORMATION  The following function illustrates the code necessary to embed a source message object to an existing destination message object:      HRESULT AttachM...">
<META NAME="Product" CONTENT="mapi">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAEV,QAPN,QAYC,QAUR,QA5T,QAW6,QAGB,QAH4,QAGI,QAI4,QAU7,QALW,QA39,QAH7,QAH6 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>HOWTO: Programmatically Embedding a Message in Another Message</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  June 18, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q170226</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Extended Messaging Application Programming Interface (MAPI), version 1.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
This article shows the minimum code necessary to embed a message in a
message.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The following function illustrates the code necessary to embed a source
message object to an existing destination message object:
<P>
<PRE>    HRESULT AttachMessage ( LPMESSAGE pMsgDst, // The message to attach to
                     LPMESSAGE pMsgSrc, // The message to attach
                     ULONG ulProps,     // Count of properties to set
                                        // on attachment
                     LPSPropValue pAttachProps // Properties to set
                                               // on attachment
                          )
    {
    // Initialize local variables.
    HRESULT   hRes        = S_OK;      // Status code of MAPI calls
    ULONG     ulAttachNum = 0L;        // Number of attachments
    LPATTACH  pAttach     = NULL;      // Attachment object
    LPMESSAGE pmsgAttach  = NULL;      // Message interface for
                                       // attachment object

    LPSPropProblemArray pProb = NULL;   // Problem array

    SizedSPropTagArray(7, excludeTags);  // Properties excluded by
                                         // Exchange client.

    //  Create an attachment in the Destintation message that was passed
    //  in to this function - pMsgDst.
    if ( FAILED ( hRes = pMsgDst -&gt; CreateAttach ( NULL,
                                                   0L,
                                                   &amp;ulAttachNum,
                                                   &amp;pAttach ) ) )
         goto Quit;

    if ( FAILED ( hRes = pAttach -&gt; SetProps ( ulProps,
                                                 pAttachProps,
                                                 &amp;pProb ) ) )
         goto Quit;


    //  Need to open the data object property and get back an IMessage
    //  interface pointer so I can call CopyTo and pass it as the
    //  destination object.
    hRes = pAttach -&gt; OpenProperty ( PR_ATTACH_DATA_OBJ,
                                     &amp;IID_IMessage,
                                     0L,
                                     MAPI_CREATE|MAPI_MODIFY,
                                     (LPUNKNOWN *) &amp;pmsgAttach );

    //  Must set cValues otherwise we will most likely get
    //  MAPI_E_INVALID_PARAMETER. Other tags are excluded to save bits
    //  and time.
    excludeTags.cValues = 7;
    excludeTags.aulPropTag[0] = PR_ACCESS;
    excludeTags.aulPropTag[1] = PR_BODY;
    excludeTags.aulPropTag[2] = PR_RTF_SYNC_BODY_COUNT;
    excludeTags.aulPropTag[3] = PR_RTF_SYNC_BODY_CRC;
    excludeTags.aulPropTag[4] = PR_RTF_SYNC_BODY_TAG;
    excludeTags.aulPropTag[5] = PR_RTF_SYNC_PREFIX_COUNT;
    excludeTags.aulPropTag[6] = PR_RTF_SYNC_TRAILING_COUNT;

    //  Call CopyTo from the attached message to copy all the properties
    //  from it to the destination object except the ones we asked to be
    //  excluded.
    if ( FAILED ( hRes = pMsgSrc -&gt; CopyTo (0L,
                                            0L,
                                            (LPSPropTagArray)&amp;excludeTag,
                                            0L,
                                            0L,
                                            &amp;IID_IMessage,
                                            (LPVOID) pmsgAttach,
                                            0L,
                                            &amp;pProb ) ) )
          goto Quit;

    //  Save the changes to the destination object, the attachment, and
    //  the outer message. Order is important.
    if(FAILED(hRes = pmsgAttach-&gt;SaveChanges ( KEEP_OPEN_READWRITE ) ) )
    {
          MessageBox ( (ULONG *)m_hWnd,
                       "Cannot save changes to message attachment",
                       "Error", MB_OK | MB_ICONSTOP );
          goto Quit;
    }

    if ( FAILED (hRes = pAttach-&gt;SaveChanges ( KEEP_OPEN_READWRITE ) ) )
    {
          MessageBox ( (ULONG *)m_hWnd,
                       "Cannot save changes to attachment.",
                       "Error", MB_OK | MB_ICONSTOP );
          goto Quit;
    }

    if ( FAILED ( hRes = pMsgDst-&gt;SaveChanges ( KEEP_OPEN_READWRITE ) ) )
    {
          MessageBox ( (ULONG *)m_hWnd,
                       "Cannot save changes to message.",
                       "Error", MB_OK | MB_ICONSTOP );
          goto Quit;
    }


    Quit:

      pmsgAttach -&gt; Release ( );
      pAttach -&gt; Release ( );
      return hRes;
    }

 

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Keywords            : EMAPI<BR>
Version             : WINDOWS:1.0<BR>
Platform            : WINDOWS<BR>
Issue type          : kbhowto<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  June 18, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
