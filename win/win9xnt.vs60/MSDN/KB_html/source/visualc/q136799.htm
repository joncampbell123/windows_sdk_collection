

<HTML>
<HEAD>
<TITLE>BUG: Wrong Structure Member Modified with /Ox or /Oeg </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q136799">
<META NAME="KBModify" CONTENT="1997/08/08">
<META NAME="KBCreate" CONTENT="1995/09/14">
<META NAME="Keywords" CONTENT="CodeGen kb16bitonly">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  When the /Ox or /Oeg optimizations are used with the code listed in this article, the wrong structure member is modified when a huge pointer is incremented.  RESOLUTION  Remove the /Ox or /Oeg optimizations from the command line or use the optimize...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAH4,QBC9,QBC8,QANO,QAAP,QA6E,QAPF,QBV8,QBFY,QA26,QAY2,QALZ,QAKP,QAKC,QAI4 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Wrong Structure Member Modified with /Ox or /Oeg</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  August 8, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q136799</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>The Microsoft C/C++ Compiler (CL.EXE) included with:
   - Microsoft Visual C++ for Windows, versions 1.5, 1.51, 1.52
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When the /Ox or /Oeg optimizations are used with the code listed in this
article, the wrong structure member is modified when a huge pointer is
incremented.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Remove the /Ox or /Oeg optimizations from the command line or use the
optimize pragma to disable them from the function that is generating the
incorrect code as in this example:
<P>
<PRE>   #pragma optimize("eg",off)
     IncrementFunction(){...}
   #pragma optimize("eg",on)

</PRE>Another option is to modify the code slightly or change its location. For
example, in the following sample if the code from the IncrementFunction()
is moved to the calling function, it works correctly.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products
listed at the beginning of this article. We are researching this problem
and will post new information here in the Microsoft Knowledge Base as
it becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Sample Code to Reproduce Problem</h3>
 
<P>
<PRE>   /* Compile options needed: /AL and /Ox or /Oeg
   */
   #include &lt;malloc.h&gt;
   #include &lt;stdio.h&gt;

   typedef struct {
     long x;
     long y;
   } StructA, huge * pStructA;

   typedef struct {
     short points;
     pStructA pPoints;
   } StructB, huge * pStructB;

   #define   NumStructs   2 /* number of StructB structures */
   #define   NumPoints   5 /* number of points per StructB */

   void IncrementFunction( pStructB pStructBs, short numpoints) {
     short i=0;
     for (i = 0; i &lt; NumStructs; i++) {
       if (pStructBs[i].pPoints &gt; pStructBs-&gt;pPoints)
          // The points member is incorrectly modified on the next line.
       pStructBs[i].pPoints += numpoints;
     }
   }

   void main(void) {
     pStructB   StructBs = halloc(NumStructs, sizeof(StructB));
     pStructA   datapoints = halloc((NumStructs+1)*NumPoints,
                                     sizeof(StructA));
     short     i=0;
     for (i = 0; i &lt; (NumStructs+1)*NumPoints; i++) {
       datapoints[i].x = datapoints[i].y = (long)i;
     }
     for (i = 0; i &lt; NumStructs; i++) {
       StructBs[i].points = 10;
       StructBs[i].pPoints = &amp;datapoints[i*NumPoints];
     }
     IncrementFunction(StructBs, NumPoints);
     for (i = 0; i &lt; NumStructs; i++) {
       if (StructBs[i].points != 10)
         printf("Error: Value should be 10 and it is %d\n",
                 StructBs[i].points );
     }
   }
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: 8.00c<BR>
Keywords          : CodeGen kb16bitonly<BR>
Version           : 1.5 1.51 1.52<BR>
Issue type        : kbbug<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  August 8, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
