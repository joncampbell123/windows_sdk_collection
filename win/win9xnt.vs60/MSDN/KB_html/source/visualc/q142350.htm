

<HTML>
<HEAD>
<TITLE>FIX: MFCVBX with MODEL_fChildrenOk Set Causes GP Fault </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q142350">
<META NAME="KBModify" CONTENT="1997/09/19">
<META NAME="KBCreate" CONTENT="1996/01/10">
<META NAME="Keywords" CONTENT="kb16bitonly MfcVBX kbbuglist kbfixlist kbprg">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  There's a bug in the MFCVBX sample that's described in the following article in the Microsoft Knowledge Base:     ARTICLE-ID: Q123377    TITLE     : SAMPLE: MFCVBX Implements a VBX Control Using MFC  The MFCVBX sample shows how to create a VBX cont...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBKN,QAB5,QAPF,QA7O,QAOE,QAMN,QAR4,QAHE,QAEV,QAGI,QBS0,QABA,QBXS,QAY5,QAYC V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: MFCVBX with MODEL_fChildrenOk Set Causes GP Fault</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 19, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q142350</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
1.50 1.51 1.52
WINDOWS
kbprg kbbuglist kbfixlist
<P>
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
   Microsoft Visual C++ for Windows, versions 1.5, 1.51, and 1.52
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
There's a bug in the MFCVBX sample that's described in the following
article in the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../visualc/q123377.htm">Q123377</A></B>
   TITLE     : SAMPLE: MFCVBX Implements a VBX Control Using MFC

</PRE>The MFCVBX sample shows how to create a VBX control using MFC. If this
sample is used as an approach for creating a VBX control and the
MODEL_fChildrenOk flag is also used, then the VBX control causes a
general protection (GP) fault.
<P>
<P><h2>CAUSE</h2>
 
<P>
A GP fault could occur for a number of reasons, but in particular it will
happen if a combo box is placed on the VBX control.
<P>
The sample code does not correctly handle the case where a message handler
needs to call the default message procedure. It does not set MFC's internal
structure, which stores the previous message. Therefore, when the default
message handler is called, it is called with the incorrect message (and
parameters).
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Modify the CircleCtlProc function located in the Mfcvbx.cpp file in the
sample. Make the following changes:

<OL><P><LI>Add the following declaration before the CircleCtlProc function:
<P>
   extern MSG NEAR _afxLastMsg;

<P><LI>Make the following modifications to the CircleCtlProc function:
<P>
   Change this line:
<P>
<P><PRE>      LRESULT lResult = pCtl-&gt;WindowProc(msg,wp,lp);
</PRE><P>
   To this code:
<P>
<P><PRE>      MSG oldState = _afxLastMsg;
      _afxLastMsg.message = msg;
      _afxLastMsg.wParam = wp;
      _afxLastMsg.lParam = lp;
</PRE><P>
<P><PRE>      LRESULT lResult = pCtl-&gt;WindowProc(msg,wp,lp);
</PRE><P>
<P><PRE>      _afxLastMsg = oldState;
</PRE><P>
</OL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the MFCVBX sample. This problem
has been corrected. To obtain the latest version of the sample, please see
the following article in the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../visualc/q123377.htm">Q123377</A></B>
   TITLE     : SAMPLE: MFCVBX Implements a VBX Control Using MFC

</PRE></OL><h2>REFERENCES</h2>
 
<P>
For more information on the MODEL_fChildrenOk flag and what it is
used for, please see:
<P>
Visual Basic 3.0:
<PRE>   VB API Reference Help.Data Structures.MODEL Flags

</PRE>Visual Control Pack 1.0:
<PRE>   VCP CDK Help.Data Structures.MODEL Flags
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 1.50 1.51 1.52b 2.50 2.51 2.52 2.52b vb<BR>
CVBControl CDK<BR>
KBCategory: kbprg kbbuglist kbfixlist<BR>
KBSubcategory: MfcVBX<BR>
Keywords          : kb16bitonly MfcVBX kbbuglist kbfixlist kbprg<BR>
Technology        : kbMfc<BR>
Version           : 1.50 1.51 1.52<BR>
Platform          : WINDOWS<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 19, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
