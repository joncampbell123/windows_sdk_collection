

<HTML>
<HEAD>
<TITLE>FIX: /G3 Optimization Generates Bad Code for Struct Pointers </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q116137">
<META NAME="KBModify" CONTENT="1997/09/18">
<META NAME="KBCreate" CONTENT="1994/06/13">
<META NAME="Keywords" CONTENT="CLIss kbbuglist kbfixlist kbprg">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  The /G3 option, used to generate 386 instructions, may generate incorrect instructions when attempting to access fields within a structure.  RESOLUTION  There are two workarounds to this problem:   - Compile using the /G2 option.     - or -   - Dis...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAH4,QBFY,QAE8,QAR4,QAEB,QAKR,QAHE,QDL9,QBXT,QBWQ,QBWO,QBWN,QA5V,QAIB,QBWG V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: /G3 Optimization Generates Bad Code for Struct Pointers</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 18, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q116137</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
1.00
WINDOWS
kbprg kbfixlist kbbuglist
<P>
 
The information in this article applies to:

<UL><LI>The Microsoft C/C++ Compiler (CL.EXE) included with:
   Microsoft Visual C++ for Windows, version 1.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The /G3 option, used to generate 386 instructions, may generate
incorrect instructions when attempting to access fields within a
structure.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
There are two workarounds to this problem:

<UL><LI>Compile using the /G2 option.
<P>
   - or -

<LI>Disable optimization locally using the optimize pragma:
<P>
<PRE>         #pragma optimize("",off)

         void mycode(void)
         {
         }

         #pragma optimize("",on)

</PRE></UL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem with the C/C++ compiler,
version 8.0. The problem was corrected with C/C++, version 8.0c,
supplied with Microsoft Visual C++ for Windows, version 1.5. We are
researching this problem and will post new information in the
Microsoft Knowledge Base as soon as it becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The sample code below can be used to illustrate this problem. If
you use the /Fc option to generate mixed-source and assembly code,
the line commented below generates the following code:
<P>
<PRE>   ;|***    t2 = (lpDisp-&gt;right - lpDisp-&gt;left);
   ; Line 22
     *** 000027  c4 5e 0c         les bx,DWORD PTR [bp+12]          ;lpDisp
     *** 00002a  66 26 8b 47 0c   mov eax,DWORD PTR es:[bx+12]
     *** 00002f  66 26 2b 47 04   sub eax,DWORD PTR es:[bx+4]
     *** 000034  89 46 f8         mov WORD PTR [bp-8],ax        ;t2
     *** 000037  89 56 fa         mov WORD PTR [bp-6],dx

</PRE>NOTE: The first three lines of assembly code correctly perform the
arithmetic operations, but the last two lines do not use the extended
registers "EAX" and "EDX", but "AX" and "DX". Compiling using the /G2
switch instead of the /G3 switch generates correct register use.
<P>
<P><h3>Sample Code</h3>
 
<P>
<PRE>/* Compile options needed: /c /G3
*/

   #include &lt;windows.h&gt;

   struct displayinfo
   {
    long leftlim, left, rightlim, right;
   };

   void HorizScrollProc(HWND hWnd, WORD wParam, long lParam,
                        struct displayinfo far *lpDisp)
   {
    long t1,t2;

    switch (wParam)
    {
     case SB_LINEUP:
       t1 = (lpDisp-&gt;left + lpDisp-&gt;right) / 2;
       t2 = (lpDisp-&gt;right - lpDisp-&gt;left);        /* bad code here */
       if (lpDisp-&gt;leftlim + t2 / 8 &gt; lpDisp-&gt;left)
       {
        lpDisp-&gt;left = lpDisp-&gt;leftlim;
        lpDisp-&gt;right = lpDisp-&gt;leftlim + t2;
       }
       else
       {
        lpDisp-&gt;left -= t2 / 8;
        lpDisp-&gt;right -= t2 / 8;
       }
       break ;

     default:
       return;
       break;
    }
   }
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 1.00 8.00<BR>
KBCategory: kbprg kbfixlist kbbuglist<BR>
KBSubcategory: CLIss<BR>
Keywords          : CLIss kbbuglist kbfixlist kbprg<BR>
Version           : 1.00<BR>
Platform          : WINDOWS<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 18, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
