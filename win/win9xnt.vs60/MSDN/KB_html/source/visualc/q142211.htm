

<HTML>
<HEAD>
<TITLE>BUG: Blob Persistent Data Incorrect for Ported OLE Control </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q142211">
<META NAME="KBModify" CONTENT="1997/07/10">
<META NAME="KBCreate" CONTENT="1996/01/07">
<META NAME="Keywords" CONTENT="CDKIss MfcOLE kbbuglist kbole kbprg">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  An OLE control using PX_Blob(), created using the Control Developer's Kit (CDK) that shipped with Visual C++ 2.2 or earlier and saved in a Visual Basic 4.0 form, may give undefined behavior if the control is ported to Visual C++ 4.0 or 4.1 and the ...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAB5,QBS0,QBR4,QA7O,QAMN,QAOE,QA56,QA55,QBBS,QBVV,QBFY,QA9Q,QAYY,QASR,QAW6 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Blob Persistent Data Incorrect for Ported OLE Control</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 10, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q142211</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
4.00 4.10
WINDOWS NT
kbprg kbole kbbuglist
<P>
 
The information in this article applies to:
<UL><LI>The Microsoft Foundation Classes (MFC) included with:
   Microsoft Visual C++, 32-bit Edition, version 4.0 and 4.1
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
An OLE control using PX_Blob(), created using the Control Developer's Kit
(CDK) that shipped with Visual C++ 2.2 or earlier and saved in a Visual
Basic 4.0 form, may give undefined behavior if the control is ported to
Visual C++ 4.0 or 4.1 and the Visual Basic form containing the control is
reopened.
<P>
<P><h2>CAUSE</h2>
 
<P>
OLE Controls created using the CDK that shipped with Visual C++ 2.2 or
earlier did not implement the IPersistPropertyBag interface. Controls
created with Visual C++ 4.0 or 4.1 do implement IPersistPropertyBag.
<P>
The undefined behavior is due to Visual Basic's implementation of
IPropertyBag. Visual Basic is currently adding a 20-byte header to a blob
property's persistent data, and expecting that header to be in any blob
persistent data previously saved. In the case of controls created
previously to Visual C++ 4.0 or 4.1, IPersistPropertyBag, which corresponds
to the container's IPropertyBag was not implemented. Therefore, the
container used a different means to serialize the blob data which did not
attach a 20 byte header. The undefined behavior may behave a number of ways
including the blob data being reinitialized, blob data being initialized
incorrectly, or the control not being created altogether.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
To read in the blob data correctly, you must force the container to use an
interface other than IPropertyBag to serialize the data. In this case, a
20-byte header will not be expected and the blob data should be read in
properly. The technique demonstrated in the "Sample Code" section of this
article unexposes the control's IPersistPropertyBag interface thereby
forcing the container to use an interface other than IPropertyBag to read
in the blob data.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in Microsoft Visual Basic 4.0.
We are researching this problem and will post new information here in the
Microsoft Knowledge Base as it becomes available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Sample Code to Demonstrate Workaround</h3>
 
<P>
The following is a step by step process to unexpose the IPersistPropertyBag
interface in an OLE control generated with Visual C++ 4.0 or 4.1. This is
most easily done by implementing a new interface map, which does not expose
the IPersistPropertyBag interface.

<OL><P><LI>In the declaration of your COleControl derived class (in the header
   file), add a DECLARE_INTERFACE_MAP() macro if there isn't one already
   there.
<P>
   class CBlobTestCtrl : public COleControl
   {
   ...
<P><PRE>       DECLARE_INTERFACE_MAP()
</PRE>   };

<P><LI>In the .cpp file for the control, implement a new interface map
   specifying all but IID_IPersistPropertyBag.
<P>
   BEGIN_INTERFACE_MAP(CBlobTestCtrl, CWnd)  // use CWnd not COleControl
<P><PRE>       INTERFACE_PART(CBlobTestCtrl, IID_IOleObject, OleObject)
       INTERFACE_PART(CBlobTestCtrl, IID_IConnectionPointContainer,
<PRE></PRE>         ConnPtContainer)
       INTERFACE_PART(CBlobTestCtrl, IID_IOleControl, OleControl)
       INTERFACE_PART(CBlobTestCtrl, IID_IPersist, PersistStorage)
       INTERFACE_PART(CBlobTestCtrl, IID_IPersistMemory, PersistMemory)
       INTERFACE_PART(CBlobTestCtrl, IID_IPersistStreamInit,
         PersistStreamInit)
       INTERFACE_PART(CBlobTestCtrl, IID_IOleInPlaceObject,
         OleInPlaceObject)
       INTERFACE_PART(CBlobTestCtrl, IID_IOleInPlaceActiveObject,
         OleInPlaceActiveObject)
       INTERFACE_PART(CBlobTestCtrl, IID_IDispatch, Dispatch)
       INTERFACE_PART(CBlobTestCtrl, IID_IOleCache, OleCache)
       INTERFACE_PART(CBlobTestCtrl, IID_IViewObject, ViewObject)
       INTERFACE_PART(CBlobTestCtrl, IID_IViewObject2, ViewObject)
       INTERFACE_PART(CBlobTestCtrl, IID_IDataObject, DataObject)
       INTERFACE_PART(CBlobTestCtrl, IID_ISpecifyPropertyPages,
         SpecifyPropertyPages)
       INTERFACE_PART(CBlobTestCtrl, IID_IPerPropertyBrowsing,
         PerPropertyBrowsing)
       INTERFACE_PART(CBlobTestCtrl, IID_IProvideClassInfo,
         ProvideClassInfo)
       INTERFACE_PART(CBlobTestCtrl, IID_IProvideClassInfo2,
         ProvideClassInfo)
       INTERFACE_PART(CBlobTestCtrl, IID_IPersistStorage, PersistStorage)
   END_INTERFACE_MAP()

</PRE></OL><h2>REFERENCES</h2>
 
<P>
MFC Technical Note #38 about "MFC/OLE IUnknown implementation"
Inside Ole Second Edition by Kraig Brockschmidt
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 4.00 4.10<BR>
KBCategory: kbprg kbole kbbuglist<BR>
KBSubcategory: CDKIss MfcOLE<BR>
Keywords            : CDKIss MfcOLE kbbuglist kbole kbprg<BR>
Technology          : kbMfc<BR>
Version             : 4.00 4.10<BR>
Platform            : NT WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 10, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
