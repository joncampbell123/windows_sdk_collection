

<HTML>
<HEAD>
<TITLE>BUG: The "this" Pointer is Incorrect in Destructor of Base Class </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q168385">
<META NAME="KBModify" CONTENT="1997/05/12">
<META NAME="KBCreate" CONTENT="1997/05/09">
<META NAME="Keywords" CONTENT="CLIss kbtool vcbuglist500 kbbuglist">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  The  this  pointer is incorrectly setup in the destructor of a base class. This occurs when the array delete is called and there is a class that inherits from two base classes that have virtual functions and the second base class has a virtual dest...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABA,QA2O,QABO,QBFY,QAO2,QDH9,QA0K,QBCT,QAO3,QALZ,QAGC,QAGB,QAEF,QAAP,QAYY V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: The "this" Pointer is Incorrect in Destructor of Base Class</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 12, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q168385</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual C++, 32-bit Editions, version 5.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The "this" pointer is incorrectly setup in the destructor of a base class.
This occurs when the array delete is called and there is a class that
inherits from two base classes that have virtual functions and the second
base class has a virtual destructor.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
One workaround is to make the base classes virtual base classes. Another
option is to use something other than array new and array delete to
allocate and deallocate the memory. For example, declare the array
statically.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products listed
at the beginning of this article. We are researching this bug and will post
new information here in the Microsoft Knowledge Base as it becomes
available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Sample Code</h3>
 
<P>
<PRE>   #include &lt;iostream&gt;
       using namespace std;
       class A {
       public:
          A(){}
          ~A(){}
          virtual void A1() {}
       };

       class B {
       public:
          B();
          virtual ~B();
          int marker;
       };

       B::B() {
          marker = 10;
          cout &lt;&lt; "In constructor, this is " &lt;&lt; this &lt;&lt; endl;
       }

       B::~B() {
          cout &lt;&lt; "In destructor, this is " &lt;&lt; this &lt;&lt; endl;
          if ( this-&gt;marker != 10)
             cout &lt;&lt; "Data has been corrupted" &lt;&lt; endl;
       }

       class C: public A, public B
       // class C: public A, virtual public B // Workaround
       {public:
          C(){}
          ~C(){}
       };

       int main() {
          C * pC;
          pC = new C[2];
          delete [] pC;
               return 0 ;
       }

   /* Sample Program Output */
   In constructor, this is 00460DA8
   In constructor, this is 00460DB4
   In destructor, this is 00460DB0
   Data has been corrupted
   In destructor, this is 00460DA4
   Data has been corrupted
 

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Keywords            : CLIss kbtool vcbuglist500 kbbuglist<BR>
Version             : 5.0<BR>
Platform            : NT WINDOWS<BR>
Issue type          : kbbug<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 12, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
