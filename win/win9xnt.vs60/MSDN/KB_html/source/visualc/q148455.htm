

<HTML>
<HEAD>
<TITLE>BUG: CSharedFile::Detach() Does Not Call GlobalUnlock() </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q148455">
<META NAME="KBModify" CONTENT="1997/07/31">
<META NAME="KBCreate" CONTENT="1996/03/13">
<META NAME="Keywords" CONTENT="MfcMisc vcbuglist400 vcbuglist500 kbprg kbbuglist">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  Under the Checked build of Windows NT or a diagnostic utility you receive an error similar to this one:     BASE: GlobalFree called with a locked object.  The Checked build of Windows NT causes a Hard-Coded breakpoint to occur, which generates a me...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAGI,QAIF,QBWP,QAHC,QBCF,QAH4,QBXN,QAA8,QBW6,QA7H,QAW6,QAPN,QANG,QALZ,QABT V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: CSharedFile::Detach() Does Not Call GlobalUnlock()</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 31, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q148455</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
   - Microsoft Visual C++, 32-bit Edition, versions 2.0, 2.1, 2.2, 4.0,
<P><PRE>     4.1, 4.2, 5.0
</UL></PRE> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
Under the Checked build of Windows NT or a diagnostic utility you receive
an error similar to this one:
<P>
<PRE>   BASE: GlobalFree called with a locked object.

</PRE>The Checked build of Windows NT causes a Hard-Coded breakpoint to occur,
which generates a message similar to this one:
<P>
<PRE>   User Breakpoint called from code at: 0x77f2706f

</PRE><h2>CAUSE</h2>
 
<P>
The CSharedFile class maintains a global memory block. As soon as an
HGLOBAL is allocated by a CSharedFile object (or specified in a call to
SetHandle), it calls GlobalLock to lock this memory block.
<P>
If the CSharedFile object is destroyed, then a call to GlobalUnlock() and
GlobalFree() will correctly unlock and free the global memory block.
However, if a call to Detach() is made to retrieve the HGLOBAL, then the
handle returned is still locked. There is no call to GlobalUnlock() made to
match the call to GlobalLock().
<P>
The memory block referenced by the HGLOBAL cannot be moved because it has a
positive reference count. Also, if an attempt is made to free the HGLOBAL
by way of a call to GlobalFree(), the symptoms given in this article will
occur.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
After calling CSharedFile::Detach(), you can unlock the global memory block
by making a call yourself to GlobalUnlock(). Because this workaround is
dependent on the implementation of CSharedFile(), you should be sure to use
conditional compilation for this block of code as demonstrated here:
<P>
<PRE>   CSharedFile file;

   // Do stuff to fill in the CSharedFile

   HGLOBAL hGlob = file.Detach();
   #if _MFC_VER &lt;= 0x0421
     ::GlobalUnlock(hGlob);
   #endif

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products listed
at the beginning of this article. We are researching this problem and will
post new information here in the Microsoft Knowledge Base as it becomes
available.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 3.0 3.1 3.2<BR>
Keywords          : MfcMisc vcbuglist400 vcbuglist500 kbprg kbbuglist<BR>
Technology        : kbMfc<BR>
Version           : 2.0 2.1 2.2 4.0 4.1 4.2 5.0<BR>
Platform          : NT WINDOWS<BR>
Issue type        : kbbug<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 31, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
