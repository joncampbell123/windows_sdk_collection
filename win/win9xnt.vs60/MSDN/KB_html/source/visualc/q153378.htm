

<HTML>
<HEAD>
<TITLE>FIX: Syntax Error in MFC ODBC Recordset with SQL Server 6.5 </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q153378">
<META NAME="KBModify" CONTENT="1997/09/19">
<META NAME="KBCreate" CONTENT="1996/07/08">
<META NAME="Keywords" CONTENT="MfcDatabase vcbuglist400 vcfixlist420 kbbuglist kbfixlist">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  When you open a dynaset or dynamic recordset that contains an image field and that connects to a SQL Server datasource by way of the 2.65.0201 driver that ships with SQL Server 6.5, you may observe an exception thrown indicating:     Line 1: Incorr...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAXB,QAC1,QBD2,QAU9,QABM,QBVV,QAA5,QDIX,QBFY,QABI,QAAP,QA9E,QAPN,QAEF,QAB9 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Syntax Error in MFC ODBC Recordset with SQL Server 6.5</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 19, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q153378</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual C++ for Windows, versions 1.51, 1.52, 1.52b, 1.52c
<LI>Microsoft Visual C++, 32-bit Edition, versions 2.0, 2.1, 2.2, 4.0, 4.1
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you open a dynaset or dynamic recordset that contains an image field
and that connects to a SQL Server datasource by way of the 2.65.0201 driver
that ships with SQL Server 6.5, you may observe an exception thrown
indicating:
<P>
<PRE>   Line 1: Incorrect syntax near 'OF'.
   State:37000,Native:170,Origin:[Microsoft][ODBC SQL Server Driver]
   [SQL Server]

</PRE><h2>CAUSE</h2>
 
<P>
The MFC database classes are designed to adhere to the ODBC specification.
The grammar for the specification contains a error that indicates that all
compliant drivers must support the appearance of 'FOR UPDATE OF' in SELECT
statements. In reality, the specification grammar (available in the ODBC
Programmer's Reference in Visual C++ Books Online) should make support of
the 'OF' keyword optional:
<P>
<PRE>   select-for-update-statement ::=
        SELECT [ALL | DISTINCT] select-list
        FROM table-reference-list
        [WHERE search-condition]
        FOR UPDATE [OF column-name [, column-name]...]

</PRE>The MFC database classes, per the error in the specification, use the 'FOR
UPDATE OF' syntax. Generally, this does not cause a problem for the
following reasons:

<UL><LI>If you are using snapshots, the cursor library will intercept the SELECT
   statement and remove the 'FOR UPDATE OF' before forwarding the SQL
   statement on to the driver.

<LI>If you are using dynasets, the MFC database classes will usually use
   SQLSetPos instead of SQL UPDATE statements in which case the 'FOR UPDATE
   OF' is not appended to the initial SELECT statement.

<LI>If you are using dynasets that contain long binary fields and the driver
   that is in use does not support calling SQLGetData for bound columns,
   SQL UPDATE statements are used instead of SQLSetPos. However, a special
   function that checks if the driver is the SQL Server driver and if the
   version is 2.50 or earlier prevents the use of the 'FOR UPDATE OF'
   syntax. This check is performed to avoid a bug in earlier versions of
   the driver. It is implemented in the function:
<P>
<P><PRE>      inCRecordset::ValidateSelectForUpdateSupport().
</PRE><P>
</UL>The 2.65.0210 driver does not contain the bug in the earlier drivers that
CRecordset::ValidateSelectForUpdateSupport() checks for, so 'FOR UPDATE OF'
is used for dynaset and dynamic recordsets that contain long binary fields
and the exception is thrown because the 'OF' is not supported grammar.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
<P><h3>32 bit</h3>
 
<P>
While it might seem logical to simply override the function
CRecordset::ValidateSelectForUpdateSupport() so that it informs MFC
that the 2.65.0210 driver does not support FOR UPDATE OF, this is not
easily done because that function is not virtual.
<P>
Instead, you can override CRecordset::OnSetOptions() and, following the
call to the base class, reset the value of
m_dwDriverPositionedStatements to clear the bit that corresponds to
SQL_PS_SELECT_FOR_UPDATE:
<P>
<PRE>   void CDerivedSet::OnSetOptions(HSTMT hstmt)
   {
       CRecordset::OnSetOptions(hstmt);
       m_dwDriverPositionedStatements &amp;= ~SQL_PS_SELECT_FOR_UPDATE;
   }

</PRE>This causes MFC to not append the FOR UPDATE OF, which avoids the syntax
error without reducing the functionality of the recordset.
<P>
<P><h3>16 bit</h3>
 
<P>
If you are using dynasets by way of the DYNSET sample code in 16-bit Visual
C, your application actually contains the code that appends
the FOR UPDATE OF, so you can simply modify the Dynacore.cpp file to
remove the OF from the szForUpdateOf string.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products listed
at the beginning of this article. This problem was corrected in Visual C++
version 4.2.
<P>
<P><h2>REFERENCES</h2>
 
<P>
ODBC Programmer's Reference, Appendix C: SQL Grammar
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: BLOB CLongBinary
<P>

Keywords          : MfcDatabase vcbuglist400 vcfixlist420 kbbuglist kbfixlist<BR>
Technology        : kbMfc<BR>
Version           : 1.51 1.52 1.52b 1.52c 2.00 2.1<BR>
Platform          : NT WINDOWS<BR>
Issue type        : kbbug<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 19, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
