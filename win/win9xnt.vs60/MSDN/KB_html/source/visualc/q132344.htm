

<HTML>
<HEAD>
<TITLE>FIX: App Terminates Unexpectedly after Windows NT 3.51 Upgrade </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q132344">
<META NAME="KBModify" CONTENT="1997/09/18">
<META NAME="KBCreate" CONTENT="1995/07/06">
<META NAME="Keywords" CONTENT="CRTIss kbbuglist kberrmsg kbfixlist kbprg">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  After you upgrade to Windows NT version 3.51, malloc or other run-time memory allocation functions may fail when unable to grow the run-time library's heap.  Windows applications that are statically linked to the C run-time library and all console ...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QBFY,QAUD,QAB4,QAC1,QAKP,QAJH,QA56,QA55,QAR4,QAGB,QAAP,QDL9,QBWQ,QBWO V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: App Terminates Unexpectedly after Windows NT 3.51 Upgrade</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 18, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q132344</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
1.00 2.00 2.10 2.20
WINDOWS NT
kbprg kberrmsg kbbuglist kbfixlist
<P>
 
The information in this article applies to:

<UL><LI>The C Run-time (CRT) included with:
   Microsoft Visual C++, 32-bit Edition, versions 1.0, 2.0, 2.1, 2.2
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
After you upgrade to Windows NT version 3.51, malloc or other run-time
memory allocation functions may fail when unable to grow the run-time
library's heap.
<P>
Windows applications that are statically linked to the C run-time library
and all console applications issue the error, "R6018 - Unexpected heap
error," and terminate.
<P>
Windows-based applications which are linked to the DLL version of the C run-
time library, and MFC applications will unexpectedly terminate with no
error message. This termination may be preceded by a message saying that
the system is low on resources and to close down some applications.
<P>
<P><h2>CAUSE</h2>
 
<P>
This problem is caused by a change in the return code from the
VirtualAlloc() function. It formerly returned ERROR_NOT_ENOUGH_MEMORY when
it could not commit pages. Now it returns ERROR_COMMITMENT_LIMIT. The
problem occurs only on Windows NT version 3.51 and only when the
application hits its commit limit as chosen by Windows NT. This limit
varies depending on such things as the size of the installed memory and the
number of applications running. The sample code listed in this article
causes the R6018 error when run on Windows NT version 3.51 but runs to
completion under previous versions of Windows NT.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
The C Run-Time heap manager was changed in Visual C++ 4.0 to no longer use
VirtualAlloc(). Visual C++ version 4.0 correctly handles the
ERROR_COMMITMENT_LIMIT case.
<P>
This problem can be worked-around in Visual C++ 2.X by allocating large
blocks of memory using Win32 memory allocation APIs.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem when using malloc on Windows
NT version 3.51. This problem was corrected in Visual C++, 32-bit edition,
version 4.0.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Sample Code to Reproduce Problem</h3>
 
<P>
<PRE>/* Compile options needed: none
*/

#include &lt;stdlib.h&gt;
void main()
</PRE>{
<PRE>    void * p = malloc( 1024*1024*1024 ); // try to allocate 1GB
    if( p )
    {
        printf( "malloc returned non-NULL\r\n");
        free(p);
    }
    else
        printf( "malloc returned NULL\r\n");
}
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 1.00 2.00 2.10 2.20 fatal error die shut down<BR>
disappear<BR>
KBCategory: kbprg kberrmsg kbbuglist kbfixlist<BR>
KBSubcategory: CRTIss<BR>
Keywords          : CRTIss kbbuglist kberrmsg kbfixlist kbprg<BR>
Version           : 1.00 2.00 2.10 2.20<BR>
Platform          : NT WINDOWS<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 18, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
