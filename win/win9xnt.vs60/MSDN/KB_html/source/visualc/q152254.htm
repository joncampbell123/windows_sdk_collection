

<HTML>
<HEAD>
<TITLE>BUG: LNK2001 on Operator&gt;&gt; with Class from MFC Extension DLL </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q152254">
<META NAME="KBModify" CONTENT="1997/06/26">
<META NAME="KBCreate" CONTENT="1996/06/08">
<META NAME="Keywords" CONTENT="kbprg MfcDLL vcbuglist500">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  When attempting to build an application that uses classes from an MFC extension DLL, the linker reports an error of the form:     mainfrm.obj : error LNK2001: unresolved external symbol         class CArchive * __stdcall operator&gt;&gt;            (clas...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QABO,QANY,QAKM,QAH4,QAOG,QA3P,QAY2,QAW6,QAPN,QAB4,QAAP,QBXF,QAKP,QAY5,QDNN V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: LNK2001 on Operator&gt;&gt; with Class from MFC Extension DLL</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  June 26, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q152254</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
   - Microsoft Visual C++, 32-bit Edition, versions 4.0, 4.1, 4.2, 5.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When attempting to build an application that uses classes from an MFC
extension DLL, the linker reports an error of the form:
<P>
<PRE>   mainfrm.obj : error LNK2001: unresolved external symbol
       "class CArchive &amp; __stdcall operator&gt;&gt;
           (class CArchive &amp;,class CClassInExtDLL * &amp;)"
               (??5@YGAAVCArchive@@AAV0@AAPAVCDummyDoc@@@Z)

</PRE>Specifically, this problem occurs for code that attempts to use the &gt;&gt;
operator to serialize one of the extension DLL classes that use the
DECLARE_SERIAL macro.
<P>
<P><h2>CAUSE</h2>
 
<P>
If an exported class is declared in an extension DLL and is made
serializable by the use of the macros DECLARE_SERIAL and IMPLEMENT_SERIAL,
the global function:
<P>
<PRE>   friend CArchive&amp; AFXAPI operator&gt;&gt;(CArchive&amp; ar, CMyObject* &amp;pOb);

</PRE>is not automatically exported along with the class. Therefore, if an
application tries to serialize an object of that class type by the use of
the &gt;&gt; operator, a LNK2001 unresolved external error occurs on operator &gt;&gt;.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Create a new macro based on the DECLARE_SERIAL macro:
<P>
<PRE>   #define DECLARE_SERIAL_EXTDLL(class_name)   \
           _DECLARE_DYNCREATE(class_name)      \
           AFX_EXT_API friend CArchive&amp; AFXAPI \
           operator&gt;&gt;(CArchive&amp; ar, class_name* &amp;pOb);

</PRE>After defining this macro, use this new DECLARE_SERIAL_EXTDLL macro in
place of DECLARE_SERIAL in the class declaration. Rebuild the DLL and link
its new import library with the application.
<P>
In this resolution, the AFX_EXT_API prefix resolves the LNK2001 error by
explicitly exporting the function operator&gt;&gt; when building the extension
DLL.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products listed
at the beginning of this article. We are researching this problem and will
post new information here in the Microsoft Knowledge Base as it becomes
available.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
In order to make a class serializable by the use of a CArchive object, the
class must be derived from CObject and must implement the DECLARE_SERIAL
and IMPLEMENT_SERIAL macros. These macros are needed because they define an
overloaded function, operator&gt;&gt;, explicitly for that class. In a case where
that class is defined in an extension DLL and is exported by using the
AFX_EXT_CLASS macro, the overloaded function, operator&gt;&gt;, does not get
exported along with the class. Thus, if the main application instantiates
an object of that class type and tries to serialize that object by the use
of a CArchive object, a LNK2001 unresolved external error will occur.
<P>
<P><h3>Sample Code</h3>
 
<P>
Declare your class in the extension DLL this way:
<P>
In the header (.h) file for CMyObject:
<P>
<PRE>   #define DECLARE_SERIAL_EXTDLL(class_name)   \
           _DECLARE_DYNCREATE(class_name)      \
           AFX_EXT_API friend CArchive&amp; AFXAPI \
           operator&gt;&gt;(CArchive&amp; ar, class_name* &amp;pOb);

   class AFX_EXT_CLASS CMyObject : public CObject
   {
       DECLARE_SERIAL_EXTDLL(CMyObject)
       ...

   };

   In the implementation (.cpp) file for CMyObject:

   ...

   IMPLEMENT_SERIAL(CMyObject, CObject, YOUR_SCHEMA_NUMBER_HERE)

   ...

</PRE><h2>REFERENCES</h2>
 
<P>
For additional information on serialization and how to export classes from
extension DLL's, please see:

<UL><LI>MFC TechNote #2  in the Books Online
<LI>MFC TechNote #33 in the Books Online
<P>
</UL>For additional information, please see the following article in the
Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../visualc/q131946.htm">Q131946</A></B>
   TITLE     : PRB: Bad Pointer from RUNTIME_CLASS with Class from _AFXDLL
 

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Keywords            : kbprg MfcDLL vcbuglist500<BR>
Technology          : kbMfc<BR>
Version             : 4.0 4.1 4.2 5.0<BR>
Platform            : NT WINDOWS<BR>
Issue type          : kbbug<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  June 26, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
