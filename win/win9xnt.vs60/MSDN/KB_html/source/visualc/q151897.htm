

<HTML>
<HEAD>
<TITLE>FIX: CListCtrl::InsertColumn() Causes Column Data to Shift </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q151897">
<META NAME="KBModify" CONTENT="1997/09/19">
<META NAME="KBCreate" CONTENT="1996/05/30">
<META NAME="Keywords" CONTENT="MfcUI vcbuglist400 vcfixlist500 kbprg kbbuglist kbfixlist">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  After adding items to a CListCtrl, if you call InsertColumn() to add additional columns, column data starting from the second column will be shifted right. For example, if you initially create two columns and add your items, adding a third column w...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAE1,QDMN,QAGI,QBXS,QATX,QAMN,QAMB,QAPN,QBRJ,QAYY,QAR4,QACI,QAKJ,QBV9,QBCF V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: CListCtrl::InsertColumn() Causes Column Data to Shift</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 19, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q151897</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
   - Microsoft Visual C++, 32-bit Edition, versions 4.0, 4.1, 4.2
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
After adding items to a CListCtrl, if you call InsertColumn() to add
additional columns, column data starting from the second column will be
shifted right. For example, if you initially create two columns and add
your items, adding a third column will cause the data from the second
column to disappear and reappear in the third column. You may need to force
a repaint (minimize the window and restore it) to see the changes.
<P>
<P><h2>CAUSE</h2>
 
<P>
This is a bug in the Listview control. Sending an LVM_INSERTCOLUMN after
data has already been inserted, causes this problem.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
There are several ways to work around this problem:
<P>
<P><h3>Method #1</h3>
 
<P>
Use LPSTR_TEXTCALLBACK in the call to InsertItem(). This will cause a
notification LVN_GETDISPINFO to be sent to the parent of the CListCtrl each
time the text for each item is needed. The handler for this notification
will then fill in the appropriate text for each item.
<P>
<P><h3>Method #2</h3>
 
<P>
Create all the columns up front before adding any items. You can hide
columns by setting their initial width to zero in the call to
InsertColumn(). To show columns, you can call SetColumnWidth() or
SetColumn(). The only drawback to this method is that the user can still
resize the column by dragging in the header control.
<P>
<P><h3>Method #3</h3>
 
<P>
Reset the contents of the CListCtrl via DeleteAllItems() and add all column
data again after calling InsertColumn().
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a problem in the Microsoft products
listed at the beginning of this article. This bug has been fixed in
COMCTL32.DLL which as been released with Microsoft Windows NT 4.0 and
Microsoft Internet Explorer 3.01.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
<P><h3>Sample Code</h3>
 
<P>
<PRE>   Method #1
   ---------

   // m_pList is of type CListCtrl*
   BEGIN_MESSAGE_MAP(CTestView, CView)
        ON_NOTIFY (LVN_GETDISPINFO, IDC_LIST, OnGetDispInfo)
   END_MESSAGE_MAP()

      int CTestView::OnCreate(LPCREATESTRUCT lpCreateStruct)
      {
          // create CListCtrl and columns
      ...
          // insert item; text will be set in LVN_GETDISPINFO
          m_pList-&gt;InsertItem (iIndex, LPSTR_TEXTCALLBACK);
      ...
      }

      void CTestView::OnGetDispInfo (NMHDR* pnmhdr, LRESULT* pResult)
      {
          LV_DISPINFO* pdi = (LV_DISPINFO *) pnmhdr;

          // set text for column #1
          if (0 == pdi-&gt;item.iSubItem)
              pdi-&gt;item.pszText = "1st Column Data";
          // set text for column #2
          else if (1 == pdi-&gt;item.iSubItem)
              pdi-&gt;item.pszText = "2nd Column Data";
          // set text for column #3
          else if (2 == pdi-&gt;item.iSubItem)
              pdi-&gt;item.pszText = "3rd Column Data";
      }

   Method #2
   ---------

   int CTestView::OnCreate(LPCREATESTRUCT lpCreateStruct)
   {
       // create CListCtrl and columns
       ...
       // create 3rd column with zero width so it is not visible
       m_pList-&gt;InsertColumn (2, "", LVCFMT_LEFT, 0);
       // add items
       ...
       return 0;
   }

   // this function makes the 3rd column appear
   void CTestView::AddColumn()
   {
       LV_COLUMN lvc;

       lvc.mask = LVCF_TEXT | LVCF_WIDTH;
       lvc.cx = 100;
       lvc.pszText = "Column #3";
       // set the text and width of column #3
       m_pList-&gt;SetColumn (2, &amp;lvc);
   }

   /* Compile options needed: default
   */

</PRE> 
<PRE>Keywords          : MfcUI vcbuglist400 vcfixlist500 kbprg kbbuglist kbfixlist
Technology        : kbMfc
Version           : 4.0 4.1 4.2
Platform          : NT WINDOWS
Issue type        : kbbug
Solution Type     : kbfix</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 19, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
