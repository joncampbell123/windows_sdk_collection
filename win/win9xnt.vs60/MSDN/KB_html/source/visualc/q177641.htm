

<HTML>
<HEAD>
<TITLE>FIX: Assertion with an Insertable OLE Control </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q177641">
<META NAME="KBModify" CONTENT="1998/02/03">
<META NAME="KBCreate" CONTENT="1997/12/04">
<META NAME="Keywords" CONTENT="MfcOLE kbbuglist kbfixlist">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  If you try to handle a WM_LBUTTONDOWN message to get access to the IOleContainer interface for an insertable OLE Control, the following Assertion Error occurs:     Debug Assertion Failed!    Program: ...    File: wincore.cpp    Line: 871  CAUSE ===...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAB5,QA7O,QAOE,QAMN,QAR4,QA9Q,QAW6,QAAP,QABI,QBFM,QBC9,QBC8,QANO,QAH4,QAGI V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: Assertion with an Insertable OLE Control</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  February 3, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q177641</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual C++, 32-bit Editions, version 4.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
If you try to handle a WM_LBUTTONDOWN message to get access to the
IOleContainer interface for an insertable OLE Control, the following
Assertion Error occurs:
<P>
<PRE>   Debug Assertion Failed!
   Program: ...
   File: wincore.cpp
   Line: 871

</PRE><h2>CAUSE</h2>
 
<P>
This problem is cause by COleClientItem::XOleClientSite::GetContainer not
pushing the container's module state. As a result, the container attempts
to assert that the container's view window is present in the control
module's HWND map.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
To correct this problem, include the following in the call to
COleClientItem::XOleClientSite::GetContainer function:
<P>
<PRE>   STDMETHODIMP COleClientItem::XOleClientSite::GetContainer
     (LPOLECONTAINER **ppContainer)
   {
      #ifdef _DEBUG
          METHOD_PROLOGUE_EX(COleClientItem, OleClientSite)
      #else
          METHOD_PROLOGUE_EX_(COleClientItem, OleClientSite)
      #endif
   }

</PRE><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products listed
at the beginning of this article. This bug was corrected in Visual C++, 32-
bit Edition version 4.1.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The assertion error is caused by the following sequence:

<UL><LI>GetContainer calls GetDocument on the client item.

<LI>The client item asserts that it is valid.

<LI>The client item's AssertValid asserts that its document is valid.

<LI>The document's AssertValid asserts that its view is valid.

<LI>The view's AssertValid asserts that the window is valid.

<LI>The window asserts that its HWND is in the current module's HWND map.
<P>
</UL><h3>Steps To Reproduce the Problem</h3>
 

<OL><P><LI>Create a Control using the ControlWizard in Visual C++ 4.0. Make sure
   you set the "Available in InsertObject Dialog" option.

<P><LI>To this control, add a WM_LBUTTONDOWN handler as follows:
<P>
<P><PRE>      void CYourCtrl::OnLButtonDown(UINT nFlags, Cpoint point)
      {
<PRE></PRE>         LPOLECONTAINER pContainer;
         if(SUCCEEDED(GetClientSite()-&gt;GetContainer(&amp;pContainer)))
         {
            AfxMessageBox("We have access to IOleContainer interface");
         }
         if(pContainer)pContainer-&gt;Release();
            COleControl::OnLButtonDown(nFlags,point);
      }

</PRE><P><LI>Build the control.

<P><LI>Create a default MFC OLE Container application.

<P><LI>Build and run the container.

<P><LI>Click InsertObject on the Edit menu to insert your OLE Control.

<P><LI>Click on the control. The assertion error occurs.
<P></OL>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: 4.10<BR>
Keywords          : MfcOLE kbbuglist kbfixlist<BR>
Version           : WINNT:4.0<BR>
Platform          : winnt<BR>
Issue type        : kbbug<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  February 3, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
