

<HTML>
<HEAD>
<TITLE>FIX: MFC DAO or ODBC App Crashes on Exit </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q153897">
<META NAME="KBModify" CONTENT="1997/09/19">
<META NAME="KBCreate" CONTENT="1996/07/22">
<META NAME="Keywords" CONTENT="MfcDAO MfcDatabase vcfixlist500 kbinterop kbprg kbfixlist">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  An application intermittently crashes on exit and an error similar to the following appears:                   caused an invalid page fault in    module KERNEL32.DLL at 0137:bff9a07c.  This behavior occurs when the application is using the MFC DAO ...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAGI,QAR4,QAM1,QA1S,QAIF,QA9E,QAY5,QAJH,QAH4,QBFY,QA56,QA55,QABO,QBWP,QAGB V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: MFC DAO or ODBC App Crashes on Exit</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 19, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q153897</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual C++, 32-bit Edition, versions 4.0, 4.1, 4.2
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
An application intermittently crashes on exit and an error similar to the
following appears:
<P>
<PRE>   &lt;application&gt; caused an invalid page fault in
   module KERNEL32.DLL at 0137:bff9a07c.

</PRE>This behavior occurs when the application is using the MFC DAO classes,
the MFC ODBC classes, or the ODBC API to access a database using the Jet
Database Engine.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Call the LoadLibrary() function on the Jet Engine as shown in the
sample code below. This call needs to be done only once during execution
of the program. To minimize any adverse affect on performance, call
LoadLibrary() only after the database has been opened. Do not call
FreeLibrary() for this DLL. The DLL will be automatically unloaded when the
application exits.
<P>
This bug has been fixed in Jet 3.5 that is included with Visual C++ 5.0. If
you are using the ODBC, you can simply use the newer ODBC driver that is
available with Visual C++ 5.0. If you are using DAO, you need to build your
application using Visual C++ 5.0 to use DAO 3.5. The earlier MFC classes
use DAO/Jet 3.0 and do not recognize DAO 3.5.
<P>
<P><h2>STATUS</h2>
 
<P>
This bug has been fixed in Jet 3.5 that is included with Visual C++ 5.0.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
This problem occurs only if a dialog resource is loaded. This includes
applications that use CFormView-derived classes, such as CRecordView
and CDaoRecordView, as well as dialog-based applications.
<P>
The following sample code shows the workaround for a default MFC
AppWizard application using the MFC DAO classes. The call to LoadLibrary()
is added to the Open() function of the CDaoRecordset-derived class named
CMySet. Similar logic can be used for the MFC ODBC classes.
<P>
To fix the DAOEnrol sample, add the LoadLibrary() call in the sample code
below to the CDaoEnrolDoc::OnNewDocument() function, before the call to
the base class CDocument::OnNewDocument() function.
<P>
To fix the Enroll tutorial, add the LoadLibrary() call in the sample code
below to the CEnrollDoc::GetDatabase() function, after the call to
m_database.Open().
<P>
<P><h3>Sample Code</h3>
 
<P>
<PRE>   void CMySet::Open(int nOpenType, LPCTSTR lpszSql, int nOptions)
   {
       CDaoRecordset::Open(nOpenType, lpszSql, nOptions);

       // Load the Jet Engine to ensure that it remains in memory
       // during the shutdown process.
       LoadLibrary( "MSJT3032.DLL" );
   }
</PRE> 
<PRE>Keywords          : MfcDAO MfcDatabase vcfixlist500 kbinterop kbprg kbfixlist
Technology        : kbMfc
Version           : WINDOWS NT:4.0,4.1,4.2
Platform          : NT Win95 WINDOWS
Issue type        : kbprb
Solution Type     : kbfix</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 19, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
