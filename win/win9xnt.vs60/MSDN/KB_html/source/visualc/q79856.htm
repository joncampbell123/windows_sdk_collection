

<HTML>
<HEAD>
<TITLE>Preventing Code Removal During Optimization in an ISR </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q79856 ">
<META NAME="KBModify" CONTENT="1997/07/17">
<META NAME="KBCreate" CONTENT="1992/01/08">
<META NAME="Keywords" CONTENT="kb16bitonly">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  With Microsoft C version 6.0 and later, the optimizer may not generate code for statements in an interrupt service routine (ISR) that modifies variables that the optimizer cannot tell are used later on.  Use of the keyword  volatile  can prevent th...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAH4,QBFY,QAHE,QBVV,QAYL,QAY5,QADN,QAHC,QAEF,QBV8,QABG,QAB9,QAA1,QA4P,QAMB V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>Preventing Code Removal During Optimization in an ISR</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 17, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q79856 </B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
6.00 6.00a 6.00ax 7.00 | 6.00 6.00a | 1.00 1.50
<PRE>MS-DOS                 | OS/2       | WINDOWS
</PRE>kbprg
<P>
 
The information in this article applies to:

<UL><LI>The Microsoft C/C++ Compiler (CL.EXE) included with:
<P>
<P><PRE>    - Microsoft C for MS-DOS, versions 6.0, 6.0a, and 6.0ax
    - Microsoft C for OS/2, versions 6.0 and 6.0a
    - Microsoft C/C++ for MS-DOS, version 7.0
    - Microsoft Visual C++ for Windows, versions 1.0 and 1.5
</UL></PRE> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
With Microsoft C version 6.0 and later, the optimizer may not generate
code for statements in an interrupt service routine (ISR) that
modifies variables that the optimizer cannot tell are used later on.
<P>
Use of the keyword "volatile" can prevent this unwanted optimization
from occurring.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The parameters for function ISR below are not passed on the stack as
the C code seems to indicate. They are set up with code that the
keyword _interrupt causes to be generated: a pusha on startup and a
popa on exit if 286 code is generated; the equivalent pushes and pops
otherwise. The parameters are placed in the function declaration to
provide a convenient way to access the register values that have been
placed on the stack.
<P>
However, as far as the C function is concerned, these parameters are
passed by value and their values will not be used outside of this
function. Therefore, the optimizer won't generate any code for the
example below because it does not know that the register values will
be restored.
<P>
The volatile keyword tells the compiler that the variable may be used
outside of a function in ways that it cannot know about. Therefore,
the optimizer will leave the code that involves the variable alone. To
generate code for the variable modifications in the example, specify
the two parameters used in the function as volatile unsigned _di and
volatile unsigned flags in the parameter list.
<P>
For a similar example involving a variable that is not part of the
parameter list, query on the following words:
<P>
<PRE>   ISRs and side effects and signal handlers and optimizer

</PRE>Compiling the sample code below with the options shown in the comment
will produce a .COD file. This file will show what assembly code is
generated for certain lines in the file.
<P>
<P><h3>Sample Code</h3>
 
<P>
<PRE>/* Compile options needed: /c /Ox /G2 /Fc
*/

/* Remove comments on the keyword volatile to prevent unwanted
   code removal. */

void _interrupt _far ISR( unsigned _es, unsigned _ds,
                          /* volatile */ unsigned _di,
                          unsigned _si, unsigned _bp, unsigned _sp,
                          unsigned _bx, unsigned _dx, unsigned _cx,
                          unsigned _ax, unsigned _ip, unsigned _cs,
                          unsigned /* volatile */ flags )
{
   _di = 1;

   flags = flags &amp; 0xfffe;
</PRE>}
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: kbinf 1.00 1.50 6.00 6.00a 6.00ax 7.00 8.00<BR>
8.00c<BR>
KBCategory: kbprg<BR>
KBSubcategory: CLIss<BR>
Keywords            : kb16bitonly<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 17, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
