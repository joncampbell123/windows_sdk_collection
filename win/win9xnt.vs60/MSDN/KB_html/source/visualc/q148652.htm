

<HTML>
<HEAD>
<TITLE>PRB: LNK2005 Errors When Link C Run-Time Libs Before MFC Libs </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q148652">
<META NAME="KBModify" CONTENT="1997/10/03">
<META NAME="KBCreate" CONTENT="1996/03/18">
<META NAME="Keywords" CONTENT="VCGenIss kberrmsg">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  When the C Run-Time (CRT) library and MFC libraries are linked in the wrong order, LNK2005 errors like the following may occur:     nafxcwd.lib(afxmem.obj) : error LNK2005:     void * __cdecl operator new(unsigned int) (??2@YAPAXI@Z) already    def...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBHQ,QAAP,QAR4,QAB4,QAE2,QABA,QBV4,QBWS,QBFY,QBAO,QA5V,QAKP,QA63,QAG2,QAHP V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: LNK2005 Errors When Link C Run-Time Libs Before MFC Libs</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  October 3, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q148652</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Visual C++, 32-bit Edition, versions 4.0, 4.1, 5.0
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When the C Run-Time (CRT) library and MFC libraries are linked in the wrong
order, LNK2005 errors like the following may occur:
<P>
<PRE>   nafxcwd.lib(afxmem.obj) : error LNK2005:
   "void * __cdecl operator new(unsigned int)"(??2@YAPAXI@Z) already
   defined in LIBCMTD.lib(new.obj)

   nafxcwd.lib(afxmem.obj) : error LNK2005:
   "void __cdecl operator delete(void *)"(??3@YAXPAX@Z) already defined
   in LIBCMTD.lib(dbgnew.obj)

   nafxcwd.lib(afxmem.obj) : error LNK2005:
   "void * __cdecl operator new(unsigned int,int,char const *,int)"
   (??2@YAPAXIHPBDH@Z) already defined in LIBCMTD.lib(dbgnew.obj)

   mfcs40d.lib(dllmodul.obj): error LNK2005: _DllMain@12 already defined in
   MSVCRTD.LIB (dllmain.obj)

   mfcs42d.lib(dllmodul.obj): error LNK2005: _DllMain@12 already defined in
   msvcrtd.lib(dllmain.obj)

</PRE><h2>CAUSE</h2>
 
<P>
The CRT libraries use weak external linkage for the new, delete, and
DllMain functions. The MFC libraries also contain new, delete, and DllMain
functions, requiring MFC to be linked before the CRT libraries.
<P>
For additional information on weak externals, please see the following
article in the Microsoft Knowledge Base:
<P>
<PRE>   ARTICLE-ID: <B><A href="../utilities/q72651.htm">Q72651</A></B>
   TITLE     : "Weak External" Records: Description, Use, and Errors

</PRE><h2>RESOLUTION</h2>
 
<P>
There are two ways to resolve this problem. The first solution involves
forcing the linker to link the libraries in the correct order. The second
solution allows you to find the module that's causing the problem and
correct it.
<P>
<P><h3>Solution One - Force Linker to Link Libraries in Correct Order</h3>
 

<OL><P><LI>Open the Project Settings dialog box by clicking Settings on the Build
   menu.

<P><LI>in the Settings For view, select (highlight) the project configuration
   that's getting the link errors.

<P><LI>Click the Link tab.

<P><LI>Select INPUT in the Category combo box.

<P><LI>In the Libraries to Ignore edit box, insert the library names (for
   example, Nafxcwd.lib Libcmtd.lib)
<P>
   NOTE: The linker command line equivalent in /NOD:&lt;library name&gt;

<P><LI>In the Object/library Modules edit box, insert the library names. You
   must ensure that these are listed in order and as the first two
   libraries in the line (for example, Nafxcwd.lib Libcmtd.lib).
<P>
</OL><h3>Solution Two - Find the Problem Module and Correct It</h3>
 
<P>
Perform the following steps to see the current library link order:

<OL><P><LI>Open the Project Settings dialog box by clicking Settings on the Build
   menu.

<P><LI>In the Settings For view, Select (highlight) the project configuration
   that's getting the link errors .

<P><LI>Click the Link tab.

<P><LI>Type the following in the Project Options dialog box:
<P>
   /verbose:lib

<P><LI>Rebuild your project. The libraries will now be listed in the output
   window during the linking process.
<P>
</OL><h2>STATUS</h2>
 
<P>
This behavior is by design.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
When using MFC libraries, you must make sure they are linked before the CRT
library. This can be done by ensuring every file in your project includes
..\Msdev\Mfc\Include\Afx.h first, either directly (#include &lt;Afx.h&gt;) or
indirectly (#include &lt;Stdafx.h&gt;). The Afx.h include file forces the correct
order of the libraries, by using the #pragma comment (lib,"&lt;libname&gt;")
directive.
<P>
If the source file has a .c extension, or the file has a .cpp extension but
does not use MFC, you can create and include a small header file
(Forcelib.h) at the top of the module. This new header will ensure the
correct library search order.
<P>
Visual C++ does not contain this header file, but you can easily create
this file by performing the following steps:

<OL><P><LI>Open ..\Msdev\Mfc\Include\Afx.h.

<P><LI>Select line 29 (#ifndef _AFX_NOFORCE_LIBS) through line 204
   (#endif //!_AFX_NOFORCE_LIBS).

<P><LI>Copy the selection to the Windows Clipboard.

<P><LI>Create a new text file.

<P><LI>Paste the contents of the Clipboard into this new file.

<P><LI>Save the file as ..\Msdev\Mfc\Include\Forcelib.h.
</OL> 
<PRE>Keywords          : VCGenIss kberrmsg
Version           : WINNT:4.0,4.1,5.0;
Platform          : NT WINDOWS
Issue type        : kbprb</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  October 3, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
