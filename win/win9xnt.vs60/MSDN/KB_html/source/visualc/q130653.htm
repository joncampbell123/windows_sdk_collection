

<HTML>
<HEAD>
<TITLE>FIX: MFC Sockets Application Causes GP Fault on Exit </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q130653">
<META NAME="KBModify" CONTENT="1997/09/18">
<META NAME="KBCreate" CONTENT="1995/05/24">
<META NAME="Keywords" CONTENT="kb16bitonly MfcSockets kbbuglist kbfixlist kbprg">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  An MFC application that uses MFC's socket classes (CSocket and CAsyncSocket) and statically links with MFC causes a general protection (GP) fault on exit. The GP fault occurs on the following line in SOCKCORE.CPP:  SOCKCORE.CPP(32):    if (_afxSock...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBKN,QAGI,QAR4,QAJH,QAKP,QAYL,QAO4,QAIF,QBHQ,QBXT,QBVV,QA5V,QAM1,QAIB,QAGB V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: MFC Sockets Application Causes GP Fault on Exit</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 18, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q130653</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
1.52
WINDOWS
kbprg kbfixlist kbbuglist
<P>
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
   Microsoft Visual C++ for Windows, version 1.52
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
An MFC application that uses MFC's socket classes (CSocket and
CAsyncSocket) and statically links with MFC causes a general protection
(GP) fault on exit. The GP fault occurs on the following line in
SOCKCORE.CPP:
<P>
SOCKCORE.CPP(32):
<PRE>   if (_afxSockState-&gt;lpfnSockCleanup != NULL)

</PRE>This error occurs if the application contains a call to AfxSocketInit but
for some reason terminates without ever actually calling that function. It
will also occur if the call to AfxSocketInit fails.
<P>
<P><h2>CAUSE</h2>
 
<P>
The MFC socket implementation maintains a static pointer to a structure
that maintains socket state information. This variable is defined in
SOCKCORE.CPP as:
<P>
<PRE>   static AFX_SOCKSTATE* _afxSockState;

</PRE>_afxSockState is initialized when an application calls AfxSocketInit.
However if an application does not call AfxSocketInit or the call to
AfxSocketInit fails, the variable is not initialized, and the 'if'
statement shown above attempts to remove the reference to a NULL pointer,
which causes the GP fault.
<P>
<P><h2>RESOLUTION</h2>
 

<OL><P><LI>This problem occurs only if your application statically links with MFC.
   If your application uses the DLL version of MFC (MFC250(D).DLL), this
   problem does not occur. To learn how to use the DLL version of MFC,
   please see MFC TechNote #33. In particular, examine the section titled:
<P>
<P><PRE>      "Writing An Application that Uses the DLL Version"
</PRE><P>
   NOTE: In order to use the DLL version of MFC with a sockets app, you
   also need to link with MFCN250(D), which contains the definitions for
   the CSocket and CAsyncSocket members.

<P><LI>Force the application to call AfxSocketInit. This causes the variable to
   be properly initialized when socket support is available. However the
   problem still occurs if AfxSocketInit fails.

<P><LI>If your application links statically to MFC, you can rebuild the static
   MFC library with a fix to the problem. To fix the problem, change the
   following code located on line 32 of SOCKCORE.CPP in the MFC\SRC
   directory:
<P>
   Change this line:
<P>
<P><PRE>      if (_afxSockState-&gt;lpfnSockCleanup != NULL)
</PRE><P>
   To this line:
<P>
<P><PRE>      if((_afxSockState!=NULL) &amp;&amp; (_afxSockState-&gt;lpfnSockCleanup!=NULL))
</PRE><P>
   Once the change has been made, you can rebuild the MFC static library to
   incorporate the change. For details on how to rebuild the MFC static
   library, please see the README.TXT file in the MFC\SRC directory and
   Appendix B of the Class Library User's Guide.
<P>
   IMPORTANT: Remember that the problem only exists in the static library,
   so you should not rebuild the MFC DLL (MFC250(D).DLL).
<P>
</OL><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the Microsoft products
listed at the beginning of this article. This problem was corrected in
MFC version 2.53 included with Microsoft Visual C++ version 1.52b for
Windows.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 1.52 2.52 GPF<BR>
KBCategory: kbprg kbfixlist kbbuglist<BR>
KBSubcategory: MfcSockets<BR>
Keywords          : kb16bitonly MfcSockets kbbuglist kbfixlist kbprg<BR>
Technology        : kbMfc<BR>
Version           : 1.52<BR>
Platform          : WINDOWS<BR>
Solution Type     : kbfix<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 18, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
