

<HTML>
<HEAD>
<TITLE>BUG: Incorrect Cast from Near to Far Function Pointer </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q116243">
<META NAME="KBModify" CONTENT="1997/07/22">
<META NAME="KBCreate" CONTENT="1994/06/14">
<META NAME="Keywords" CONTENT="kb16bitonly">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  The code listed below should cause the compiler to return error message C2187:  Cast of near function pointer to far function pointer.  Instead, incorrect code is generated that loads the segment of the far function pointer with DS, the data segmen...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAUD,QBFY,QAY5,QAH4,QAO3,QAO2,QBV8,QAB9,QAAP,QAOT,QAA1,QAAW,QALW,QDI2,QBF9 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>BUG: Incorrect Cast from Near to Far Function Pointer</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 22, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q116243</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
7.00   | 1.00 1.50
MS-DOS | WINDOWS
kbtool kbbuglist
<P>
 
The information in this article applies to:

<UL><LI>The Microsoft C/C++ Compiler (CL.EXE) included with:
<P>
<P><PRE>    - Microsoft C/C++ for MS-DOS, version 7.0
    - Microsoft Visual C++ for Windows, versions 1.0 and 1.5
</UL></PRE> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The code listed below should cause the compiler to return error message
C2187: "Cast of near function pointer to far function pointer." Instead,
incorrect code is generated that loads the segment of the far function
pointer with DS, the data segment, rather than with the correct code
segment.
<P>
<P><h2>CAUSE</h2>
 
<P>
This condition is not correctly caught in the initial stage and code
generation continues, where the far function pointer is treated as a
data address and the address is extended using the data segment.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
There is no direct workaround, so assignments that convert near and far
pointers to functions (function addresses) should be avoided. In addition,
because the function is near, the return instruction generated is also
near. If the function pointer is correctly cast to be far, both CS and IP
are pushed on the stack during a function call. The near return only pops
IP, causing stack corruption and causing execution to continue in an
incorrect location.
<P>
<P><h2>STATUS</h2>
 
<P>
Microsoft has confirmed this to be a bug in the C/C++ compiler for
MS-DOS, versions 7.0, 8.0, and 8.0c. We are researching this problem and
will post new information here in the Microsoft Knowledge Base as it
becomes available.
<P>
This problem does not occur in the 32-bit C/C++ compiler, because there are
no near and far pointers in flat addressing.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The following sample code can be used to demonstrate this problem:
<P>
<P><h3>Sample Code</h3>
 
<P>
<PRE>/* Compile options needed: /c /Gs /f- /Fc
*/

   #include &lt;stdio.h&gt;
   #include &lt;dos.h&gt;

   typedef void (__far *FARFUNCPTR)(void) ;
   typedef void (__near *NEARFUNCPTR)(void) ;

   void hfunc (void) { return; }
   FARFUNCPTR install (NEARFUNCPTR) ;

   FARFUNCPTR install (NEARFUNCPTR handler)  {
      return (FARFUNCPTR)handler;
   }

   int main (void) {

       FARFUNCPTR fptr ;

       printf("CS= %04x\nDS= %04x\n", __segname("_CODE"),
   __segname("_DATA"));
       fptr= install(hfunc);
       printf("Install %Fp\n", fptr);
       fptr= (FARFUNCPTR) hfunc ;
       printf("Direct %Fp\n",fptr);

       return (0);
   }

//This is the portion of the /Fc compiler listing that illustrates the
//incorrect use of DS as the segment of the far function pointer:

   ;|***      return (FARFUNCPTR)handler;
   ; Line 20
   *** 00001b     8b 46 04           mov     ax,WORD PTR
    [bp+4]     ;handler
   *** 00001e     8c da                mov     dx,ds
   *** 000020     e9 00 00           jmp     $EX221
</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 1.00 1.50 7.00 8.00 8.00c<BR>
KBCategory: kbtool kbbuglist<BR>
KBSubCategory: CodeGen<BR>
Keywords            : kb16bitonly<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 22, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
