

<HTML>
<HEAD>
<TITLE>FIX: No Print Dialog Box Using Foundation Class Library </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q101130">
<META NAME="KBModify" CONTENT="1997/09/16">
<META NAME="KBCreate" CONTENT="1993/07/06">
<META NAME="Keywords" CONTENT="kb16bitonly MfcPrinting kberrmsg kbprint">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  When an application uses the default printing implementation provided by the Microsoft Foundation Class Library, an attempt to perform the following steps generates an error in the Microsoft Windows debugging kernel:  1. Choose Print from the File ...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAOX,QA01,QBXS,QAR4,QANX,QDL9,QBWO,QBWN,QABO,QAGB,QAAP,QBJZ,QBFY,QAUD,QAKP V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>FIX: No Print Dialog Box Using Foundation Class Library</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  September 16, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q101130</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
<P><PRE>    - Microsoft Visual C++ for Windows, version 1.0
</UL></PRE> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When an application uses the default printing implementation provided by
the Microsoft Foundation Class Library, an attempt to perform the following
steps generates an error in the Microsoft Windows debugging kernel:

<OL><P><LI>Choose Print from the File menu to open the Print dialog box.

<P><LI>Choose the Setup button.

<P><LI>Change the orientation from portrait to landscape.

<P><LI>Choose OK to close the Setup dialog box.

<P><LI>Choose Cancel to close the Print dialog box.

<P><LI>Choose Print from the File menu to open the Print dialog box.
<P>
</OL>At this point, the application does not display the Print dialog box and
the debugging kernel displays the following message:
<P>
<PRE>   err &lt;appname&gt;-&gt;COMMDLG GLOBALLOCK+C: Invalid global handle

</PRE></OL>The retail (nondebugging) Windows kernel does not display the Print dialog
box; no other error occurs.
<P>
In step 3 above, if the user chooses to change the printer to another
printer rather than changing the orientation, another symptom occurs for
the same reasons as discussed in the Cause section below. Rather than the
print dialog box not appearing, an assertion occurs. The assertion occurs
in the APPPRNT.CPP source file on line 52.
<P>
<P><h2>CAUSE</h2>
 
<P>
The CWinApp class contains two member variables, m_hDevMode and
m_hDevNames, that contain handles to memory that describes the current
printer selection.
<P>
When the Print dialog box invokes the Setup dialog box, changes some
settings and chooses OK, the internal hDevMode and hDevNames that describe
the printer change as well. However, at this point, the Print dialog box
remains active. When the user chooses Cancel in the Print dialog box, the
Foundation Class Library executes its error handling logic which does not
properly update the m_hDevMode and m_hDevNames variables in this case.
<P>
Therefore, the next time the user invokes the Print dialog box, these
handles refer to invalid memory and the debugging kernel generates an
error.
<P>
<P><h2>RESOLUTION</h2>
 
<P>
This problem has been fixed in version 2.5 of the Microsoft Foundation
Classes. So the workaround below is only necessary if you are using the
Microsoft Foundation Classes version 2.0.
<P>
Add the following four functions to your application class derived from
CWinApp:
<P>
<PRE>   void SetDevNames(HANDLE hDevNames) {m_hDevNames = hDevNames;}
   void SetDevMode(HANDLE hDevMode) {m_hDevMode = hDevMode;}
   HANDLE GetDevNames() {return m_hDevNames;}
   HANDLE GetDevMode() {return m_hDevMode;}

</PRE>Then, modify the OnPreparePrinting() function to correct this problem. In
step 5 of the SCRIBBLE sample, modify the function as follows:
<P>
<PRE>   BOOL CScribView::OnPreparePrinting(CPrintInfo* pInfo)
   {
      BOOL bRetValue;
      HANDLE hDevMode = ((CScribbleApp*)AfxGetApp())-&gt;GetDevMode();
      HANDLE hDevNames = ((CScribbleApp*)AfxGetApp())-&gt;GetDevNames();

      pInfo-&gt;SetMaxPage(2);   // the document is two pages long:
                              // the first page is the title page
                              // the second is the drawing
      pInfo-&gt;m_nNumPreviewPages = 2;  // preview 2 pages at a time
      // default preparation
      bRetValue = DoPreparePrinting(pInfo);

      if (!bRetValue) // User canceled dialog box or an error
                      // occurred. In either case, if hDevMode or
                      // hDevNames changed, update the member
                      // variables.
         {
         if (hDevMode != pInfo-&gt;m_pPD-&gt;m_pd.hDevMode)
            ((CScribbleApp*)AfxGetApp())-&gt;
                         SetDevMode(pInfo-&gt;m_pPD-&gt;m_pd.hDevMode);
         if (hDevNames != pInfo-&gt;m_pPD-&gt;m_pd.hDevNames)
            ((CScribbleApp*)AfxGetApp())-&gt;
                         SetDevNames(pInfo-&gt;m_pPD-&gt;m_pd.hDevNames);
         }

      return bRetValue;
   }

</PRE><h2>STATUS</h2>
 
<P>
Microsoft confirmed this to be a problem in version 2.0 of the Microsoft
Foundation classes. This problem was corrected in version 2.5 of the
Microsoft Foundation classes and in version 1.5 of Visual C/C++ for
Windows. In addition, this is not a problem in Visual C/C++ 1.0 for Windows
NT with Microsoft Foundation Classes, version 2.1.
 
<PRE>Keywords          : kb16bitonly MfcPrinting kberrmsg kbprint
Technology        : kbMfc
Version           : 1.0
Platform          : WINDOWS
Issue type        : kbbug
Solution Type     : kbfix</PRE>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
================================================================================<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  September 16, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
