

<HTML>
<HEAD>
<TITLE>PRB: Bad Code Generated for "a+b == a" FP Comparison Expression </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q68559 ">
<META NAME="KBModify" CONTENT="1997/07/17">
<META NAME="KBCreate" CONTENT="1991/01/22">
<META NAME="Keywords" CONTENT="kb16bitonly">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  The compiler optimizes expressions of the form  a+b == a  if a and b are floating-point variables (double or float type).  RESOLUTION  This is expected behavior for the compiler. The proper code is generated by compiling with the /Op option, which ...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QAH4,QBFY,QAG7,QAB9,QAYL,QAOT,QAHH,QAEF,QBXT,QA5V,QAIB,QDKW,QBV8,QDL9,QBXH V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: Bad Code Generated for "a+b == a" FP Comparison Expression</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  July 17, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q68559 </B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
6.00 6.00a 6.00ax 7.00 | 6.00 6.00a | 1.00 1.50
<PRE>MS-DOS                 | OS/2       | WINDOWS
</PRE>kbtool kbprb
<P>
<P>
 
The information in this article applies to:

<UL><LI>The Microsoft C/C++ Compiler (CL.EXE) included with:
<P>
<P><PRE>    - Microsoft C for MS-DOS, versions 6.0, 6.0a, and 6.0ax
    - Microsoft C for OS/2, versions 6.0 and 6.0a
    - Microsoft C/C++ for MS-DOS, version 7.0
    - Microsoft Visual C++ for Windows, versions 1.0 and 1.5
</UL></PRE> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
The compiler optimizes expressions of the form "a+b == a" if a and b are
floating-point variables (double or float type).
<P>
<P><h2>RESOLUTION</h2>
 
<P>
This is expected behavior for the compiler. The proper code is
generated by compiling with the /Op option, which directs the
compiler to use consistent floating-point calculations. If this is
not a viable option, one of the following will work around the
situation:

<UL><LI>Enclose the expression "a+b" in parentheses.

<LI>Make the variables a and b integers, if applicable.

<LI>Compile with the quick compile (/qc) or fast compile (/f) options.
<P>
</UL><h2>MORE INFORMATION</h2>
 
<P>
Sample code with floating-point expressions of the form "a+b == a" was
compiled with optimization disabled (/Od) and the first few lines of
the resulting assembly listing follows:
<P>
; double a,b;
; if (a+b == a) ;
<PRE>    *** 00000b  9b d9 ee                fldz
    *** 00000e  9b dc 16 00 00          fcom    QWORD PTR _b
    *** 000013  9b dd d8                fstp    ST(0)
    *** (lines deleted)

</PRE>; if ((a+b) == a) ;
<PRE>    *** 000025  9b dd 06 00 00          fld     QWORD PTR _b
    *** 00002a  9b dc 06 00 00          fadd    QWORD PTR _a
    *** 00002f  9b dc 16 00 00          fcom    QWORD PTR _a
    *** 000034  9b dd d8                fstp    ST(0)
    *** (lines deleted)

</PRE>Note that the first expression gets optimized to compare variable b to
zero, rather than comparing a+b to a. In the second expression, a+b is
correctly compared to a.
<P>
Compiling with the /Op option generates the correct code in both
cases. The expression (a+b == a) might be used with floating point
numbers to detect when b is negligibly small in relation to a.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional reference words: 1.00 1.50 6.00 6.00a 6.00ax 7.00 8.00 8.00c<BR>
conditional<BR>
KBCategory: kbtool kbprb<BR>
KBSubcategory: CodeGen<BR>
Keywords            : kb16bitonly<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  July 17, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
