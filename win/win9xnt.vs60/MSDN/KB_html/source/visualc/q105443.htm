

<HTML>
<HEAD>
<TITLE>PRB: MetaFile Displays Incorrectly in Print Preview </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q105443">
<META NAME="KBModify" CONTENT="1997/05/28">
<META NAME="KBCreate" CONTENT="1993/10/20">
<META NAME="Keywords" CONTENT="kbprint MfcPrinting kbprb">
<META NAME="KBArea" CONTENT="Support; KB; visualc">
<META NAME="Description" CONTENT="  When displaying a metafile within the Microsoft Foundation Classes (MFC) Print and Print Preview architecture, the metafile prints correctly but is only partially or incorrectly displayed in the Print Preview window.  CAUSE =====  To simulate a pri...">
<META NAME="Product" CONTENT="Visual C++">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBRM,QAH2,QAGI,QAOX,QAY5,QAL3,QA5W,QAB9,QA5V,QA5A,QBV8,QAHE,QAGX,QABH,QAJQ V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PRB: MetaFile Displays Incorrectly in Print Preview</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  May 28, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q105443</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



<P><h3> </h3>
 
The information in this article applies to:

<UL><LI>The Microsoft Foundation Classes (MFC) included with:
<P><PRE>    - Microsoft Visual C++ for Windows, versions 1.0, 1.5, 1.51 1.52
    - Microsoft Visual C++, 32-bit Edition, versions 1.0, 2.0, 2.1, 2.2,
      4.0
</UL></PRE> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When displaying a metafile within the Microsoft Foundation Classes
(MFC) Print and Print Preview architecture, the metafile prints
correctly but is only partially or incorrectly displayed in the Print
Preview window.
<P>
<P><h2>CAUSE</h2>
 
<P>
To simulate a printed page in a window, CPreviewDC modifies the mapping
mode for the Print Preview window by changing the parameters for such calls
as SetWindowExt() and SetMapMode() before passing them
on to the attribute and output device contexts (DCs).
<P>
However, CPreviewDC does not override CDC::PlayMetaFile(), which maps to
the Windows application programming interface (API) ::PlayMetaFile(). If
the metafile contains records for functions that affect the mapping mode,
the CPreviewDC versions of these functions will not be called while the
metafile is playing, causing the mapping mode in the Print Preview window
to be set incorrectly (the attribute and output DCs lose synchronization).
<P>
<P><h2>RESOLUTION</h2>
 
<P>
Rather than PlayMetaFile(), use SaveDC(), ::EnumMetaFile(), and RestoreDC()
to play the metafile. In the metafile enumeration callback procedure, trap
the following functions and call the equivalent CDC functions:
<P>
<PRE>   SetMapMode
   SetWindowExt, ScaleWindowExt
   SetViewportExt, ScaleViewportExt
   SetViewportOrg, OffsetViewportOrg

</PRE>(Of these, SetWindowExt occurs in metafiles more often than the rest. It is
generally not recommended that metafiles contain records for SetMapMode or
any of the Viewport functions, but it is common to find SetMapMode records
in metafiles anyway.)
<P>
Bracket the call to ::EnumMetaFile() between calls to SaveDC() and
RestoreDC() to ensure that the output and attribute DCs are correctly
synchronized after playing the metafile.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
The enumeration callback procedure should handle the above functions by
calling the (virtual) CDC version of the function while passing everything
else to PlayMetaFileRecord(). This allows CPreviewDC to keep the output DC
and the attribute DC correctly synchronized with respect to mapping mode.
For example:
<P>
<P><h3>Sample Code</h3>
 
<P>
<PRE>   int CALLBACK __export EnumMFProc(HDC hdc,
                                    HANDLETABLE FAR *lpht,
                                    METARECORD  FAR *lpmr,
                                    int cObj,
                                    LPARAM lParam)
   {
     // lParam is available for passing application-specific data to the
     // enum proc (via the last parameter to EnumMetaFile). Let's make
     // things easier by passing in a pointer to the CDC object.
   
     CDC *pDC = (CDC *)lParam;
   
     switch(lpmr-&gt;rdFunction)
       {
       // SetWindowExt and SetMapMode are the most important ones to
       // look for.
   
       case META_SETWINDOWEXT:
           pDC-&gt;SetWindowExt(lpmr-&gt;rdParm[1], lpmr-&gt;rdParm[0]);
           break;
   
       case META_SETMAPMODE:
           pDC-&gt;SetMapMode(lpmr-&gt;rdParm[0]);
           break;
   
       case META_SETVIEWPORTEXT:
           pDC-&gt;SetViewportExt(lpmr-&gt;rdParm[1], lpmr-&gt;rdParm[0]);
           break;
   
       case META_SETVIEWPORTORG:
           pDC-&gt;SetViewportOrg(lpmr-&gt;rdParm[1], lpmr-&gt;rdParm[0]);
           break;
   
       // Add cases for the others if desired...
   
       default:
           PlayMetaFileRecord(hdc, lpht, lpmr, cObj);
       }
     return 1;
   }

</PRE>In addition to the functions listed above, there are other functions that
will not affect the appearance of the metafile in the Print Preview window,
but may affect the synchronization of the output and attribute DCs used by
CPreviewDC. This can affect subsequent drawing. Consider that the metafile
may select different fonts and other objects into the output DC, may change
the foreground/background colors, the text alignment flags, and so forth.
<P>
Also, it is common for applications to set a different mapping mode before
playing a metafile (depending on the metafile) and this mapping mode may
conflict with the mapping mode used by the rest of the view class.
<P>
For these reasons, if any drawing will take place after playing the
metafile (including playing another metafile, or even the same metafile
again), the DC must be restored to the state it was in prior to playing the
metafile. This can be accomplished by using SaveDC/RestoreDC, as in the
following example:
<P>
<PRE>   pDC-&gt;SaveDC();                     // Save current state of DC
   pDC-&gt;SetMapMode(MM_ANISOTROPIC);   // Scalable metafile
   pDC-&gt;SetViewportExt(xExt, yExt);   // Size of picture
   pDC-&gt;SetViewportOrg(x, y);         // Location of picture

   ::EnumMetaFile(pDC-&gt;GetSafeHdc(), hmf, EnumMFProc, (LPARAM)(LPSTR)pDC);

   pDC-&gt;RestoreDC(-1);                // Restore to previous saved state
                                      // Continue with other drawing...
 

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Keywords            : kbprint MfcPrinting kbprb<BR>
Technology          : kbmfc<BR>
Version             : 1.0 1.5 1.51 1.52 2.0 2.1 2.2 4.<BR>
Platform            : NT WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  May 28, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
