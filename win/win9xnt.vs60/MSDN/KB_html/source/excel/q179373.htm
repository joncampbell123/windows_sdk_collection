

<HTML>
<HEAD>
<TITLE>XL: File Is Damaged After It Is Cleaned by Antivirus Software </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q179373">
<META NAME="KBModify" CONTENT="1998/01/15">
<META NAME="KBCreate" CONTENT="1998/01/15">
<META NAME="Keywords" CONTENT="xlgpf xlloadsave kberrmsg">
<META NAME="KBArea" CONTENT="Support; KB; excel, convert, crossnet, odbc, winprint, setup">
<META NAME="Description" CONTENT="  When you try to open, close, or save a workbook, the following error message may appear:     This program has performed an illegal operation and will be shut down.    If the problem persists, contact the program vendor.  If you click Details, an er...">
<META NAME="Product" CONTENT="Excel">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBVP,QBWS,QAH4,QDNM,QAEF,QBJZ,QA9N,QAU7,QAUR,QAB4,QAVZ,QAPN,QDO5,QAGB,QAFF P2 T2 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>XL: File Is Damaged After It Is Cleaned by Antivirus Software</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  January 15, 1998</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q179373</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Excel 97 for Windows
<LI>Microsoft Excel for Windows 95, version 7.0
<LI>Microsoft Excel for Windows, versions 5.0, 5.0c
</UL> 
<P>
<P><h2>SYMPTOMS</h2>
 
<P>
When you try to open, close, or save a workbook, the following error
message may appear:
<P>
<PRE>   This program has performed an illegal operation and will be shut down.
   If the problem persists, contact the program vendor.

</PRE>If you click Details, an error message similar to one of the following
appears:
<P>
<PRE>   EXCEL caused an invalid page fault in module EXCEL.EXE at 0137:3001b963.

   -or-

   EXCEL caused an invalid page fault in module KERNEL32.DLL at
   0137:3001b693.

</PRE>When you click Close, Microsoft Excel quits.
<P>
In addition, if you can open the workbook, it contains two worksheets named
***** (five asterisks) for which the visible property is set to
xlveryhidden.
<P>
<P><h2>CAUSE</h2>
 
<P>
This problem occurs after you scan and clean Microsoft Excel workbooks with
an antivirus software program. The problem occurs when the file becomes
damaged while you are cleaning the workbook.
<P>
<P><h2>WORKAROUND</h2>
 
<P>
If you cannot open the workbook, please see the following article in the
Microsoft Knowledge Base:
<P>
<PRE>   Article-ID: <B><A href="../excel/q142117.htm">Q142117</A></B>
   TITLE     : Excel: Summary of Methods to Recover Data from Corrupted
               Files

</PRE>If you can open the workbook, use either of the following methods to repair
the damaged workbook.
<P>
<P><h3>Method 1: Copy Data to a New Workbook</h3>
 
<P>
Open the damaged workbook and follow these steps to recover the data:

<OL><P><LI>Open a new workbook.

<P><LI>In the first worksheet in the damaged workbook, select the cells
   that contain data and click Copy.

<P><LI>In the new workbook, paste the data into a worksheet.
<P>
   Repeat steps 1 through 3 for each worksheet in the damaged workbook.

<P><LI>Save the new workbook as a new file.
<P>
</OL><h3>Method 2: Remove the Damaged Worksheets</h3>
 
<P>
You can remove the problematic worksheets from your workbook by running the
following Visual Basic for Applications procedure. The damaged sheets are
hidden and named *****. Note that you cannot unhide and delete these
manually without causing an invalid page fault.
<P>
IMPORTANT: Because Excel 97 cannot remove the corrupt files, you must run
this procedure in either Excel version 5.0 or 7.0.
<P>
Microsoft provides programming examples for illustration only, without
warranty either expressed or implied, including, but not limited to, the
implied warranties of merchantability and/or fitness for a particular
purpose. This article assumes that you are familiar with the programming
language being demonstrated and the tools used to create and debug
procedures. Microsoft support engineers can help explain the functionality
of a particular procedure, but they will not modify these examples to
provide added functionality or construct procedures to meet your specific
needs. If you have limited programming experience, you may want to contact
the Microsoft fee-based consulting line at (800) 936-5200. For more
information about the support options available from Microsoft, please see
the following page on the World Wide Web:
<P>
<PRE>   <B><A href="http://www.microsoft.com/supportnet/refguide/">http://www.microsoft.com/supportnet/refguide/</A></B>

</PRE></OL>To use this macro, follow these steps:

<OL><P><LI>Start Excel 5.0 or 7.0 and open the damaged workbook. Point to Macro on
   the Insert menu, and click Module. Type the following macro:
<P>
<PRE>      Sub CleanBook()
      Dim iCtr As Integer
      iCtr = 0
      For Each Sh In ActiveWorkbook.Sheets
          If Sh.Visible = xlVeryHidden Then
              Sh.Visible = True
              If InStr(Sh.Name, "*") &gt; 0 Then
                  iCtr = iCtr + 1
                  Sh.Name = "NewSheet" &amp; iCtr
              End If
          End If
      Next Sh
      Call BadSheet
      MsgBox "Number of damaged sheets = " &amp; iCtr
      Application.Dialogs(xlDialogSaveAs).Show
      End Sub
   
      Sub BadSheet()
      Application.DisplayAlerts = False
      For Each Sh In ActiveWorkbook.Sheets
          If InStr(Sh.Name, "NewSheet") &gt; 0 Then
              Sh.Delete
          End If
      Next Sh
      End Sub

</PRE><P><LI>To run the macro, click Macro on the Tools menu. Click CleanBook and
   click Run.

<P><LI>Save the recovered workbook as a new file.
<P></OL>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: XL97 XL7 XL5 asterisk PLDT97 PLDT Laroux E<BR>
corrupted corrupt<BR>
Keywords          : xlgpf xlloadsave kberrmsg<BR>
Version           : WINDOWS:5.0,5.0c,7.0,97<BR>
Platform          : WINDOWS<BR>
Issue type        : kbtshoot<BR>
Solution Type     : kbworkaround<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  January 15, 1998</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
