

<HTML>
<HEAD>
<TITLE>PC Ext: Explanation of Opportunistic Locking on Windows NT </TITLE>

<!--STYLE_BEGIN-->
<style>@import url(../../msdn_ie4.css);</style>
	<link disabled rel="stylesheet" href="../../msdn_ie3.css">
<!--STYLE_END-->

<META HTTP-EQUIV="CONTENT-Type" CONTENT="text/html; charset=us-ascii">
<META NAME="ms.locale" CONTENT="EN-US">
<META NAME="Category" CONTENT="Support; KB Article">
<META NAME="KBID" CONTENT="Q129202">
<META NAME="KBModify" CONTENT="1997/11/12">
<META NAME="KBCreate" CONTENT="1995/04/20">
<META NAME="Keywords" CONTENT="MailPCExt ntgeneral kbusage kbusage">
<META NAME="KBArea" CONTENT="Support; KB; crossnet">
<META NAME="Description" CONTENT="  With Exclusive Oplock, if a file is opened in a non-exclusive (deny none) mode, the redirector requests an opportunistic lock of the entire file. As long as no other process has the file open, the server will grant this oplock, giving the redirecto...">
<META NAME="Product" CONTENT="Networking Issues">
<META NAME="Platform" CONTENT="Windows">
<META NAME="Technology" CONTENT=" ">
<META NAME="Premium" CONTENT="support">

<META NAME="nyms" CONTENT="QBWP,QAGI,QBWS,QABA,QAA3,QBBI,QAI5,QABT,QAJ6,QBXS,QBW7,QBC9,QBC8,QA4P,QAU3 V02180118">
</HEAD>

<BODY BGCOLOR="#FFFFFF" LEFTMARGIN="0" RIGHTMARGIN="0" TOPMARGIN="0">


<!--DOCBODY_START-->
<BR>
<CENTER>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="0" VALIGN="top" WIDTH="90%">
	<TR>
		<TD VALIGN="top">
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<H1>PC Ext: Explanation of Opportunistic Locking on Windows NT</H1>
			</FONT>
			<FONT FACE="verdana,arial,helvetica" SIZE="1">
			Last reviewed:  November 12, 1997</FONT><BR>
			<FONT FACE="verdana,arial,helvetica" SIZE="2">
			<B>Article ID: Q129202</B>
			</FONT>
		</TD>
	</TR>
	<TR>
	<TD>
	<FONT FACE="Verdana, Arial, Helvetica" SIZE=2>



 
 
The information in this article applies to:

<UL><LI>Microsoft Mail for PC Networks versions 3.0, 3.2, and 3.2a
<LI>Microsoft Windows NT Workstation version 3.5, 3.51, and 4.0
<LI>Microsoft Windows NT Server version 3.5, 3.51, and 4.0
</UL> 
<P>
<P><h2>SUMMARY</h2>
 
<P>
With Exclusive Oplock, if a file is opened in a non-exclusive (deny none)
mode, the redirector requests an opportunistic lock of the entire file. As
long as no other process has the file open, the server will grant this
oplock, giving the redirector exclusive access to the specified file. This
will allow the redirector to perform read-ahead, write-behind, and lock
caching, as long as no other process tries to open the file.
<P>
When a second process attempts to open the file, the original owner will be
asked to Break Oplock or Break to Level II Oplock. At that point, the
redirector must invalidate cached data, flush writes and locks, and release
the oplock, or close the file.
<P>
Opportunistic Locking level II, provides a method for granting read access
to a file by more than one workstation, and these workstations can cache
read data locally (read-ahead). As long as no station writes to the file,
multiple stations can have the file open with level II oplock.
<P>
<P><h2>MORE INFORMATION</h2>
 
<P>
An illustration of how level II oplocks work:

<OL><P><LI>Station 1 opens the file, requesting oplock.

<P><LI>Since no other station has the file open, the server grants
   station 1 exclusive oplock.

<P><LI>Station 2 opens the file, requesting oplock.

<P><LI>Since station 1 has not yet written to the file, the server asks
   station 1 to Break to Level II Oplock.

<P><LI>Station 1 complies by flushing locally buffered lock information to
   the server.

<P><LI>Station 1 informs the server that it has Broken to Level II Oplock
   (alternatively, station 1 could have closed the file).

<P><LI>The server responds to station 2's open request, granting it level II
   oplock. Other stations can likewise open the file and obtain level II
   oplock.

<P><LI>Station 2 (or any station that has the file open) sends a write request
   SMB. The server returns the write response.

<P><LI>The server asks all stations that have the file open to Break to None,
   meaning no station holds any oplock on the file. Because the
   workstations can have no cached writes or locks at this point, they
   need not respond to the break-to-none advisory; all they need do is
   invalidate locally cashed read-ahead data.
<P>
</OL>The following registry entries are used to enable or disable oplocks for
Windows NT workstation or server. These registry keys may not exist by
default. To access the registry run REGEDT32.EXE from the File menu, choose
Run in Program Manager or File Manager.
<P>
WARNING: Using Registry Editor incorrectly can cause serious, system-wide
problems that may require you to reinstall Windows NT to correct them.
Microsoft cannot guarantee that any problems resulting from the use of
Registry Editor can be solved. Use this tool at your own risk.
<P>
<P><h3>Workstation Service Entries</h3>
 
<P>
\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet
<PRE>   \Services\LanmanWorkstation\Parameters

UseOpportunisticLocking   REG_DWORD   0 or 1
</PRE></OL>Default: 1 (true)
<P>
Indicates whether the redirector should use opportunistic-locking (oplock)
performance enhancement. This parameter should be disabled only to isolate
problems.
<P>
<P><h3>Server Service Entries</h3>
 
<P>
\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet
<PRE>   \Services\LanmanServer\Parameters

EnableOplocks   REG_DWORD   0 or 1
</PRE>Default: 1 (true)
<P>
Specifies whether the server allows clients to use oplocks on files.
Oplocks are a significant performance enhancement, but have the potential
to cause lost cached data on some networks, particularly wide-area
networks.
<P>
<PRE>MinLinkThroughput   REG_DWORD   0 to infinite bytes per second
</PRE>Default: 0
<P>
Specifies the minimum link throughput allowed by the server before it
disables raw and opportunistic locks for this connection.
<P>
<PRE>MaxLinkDelay   REG_DWORD   0 to 100,000 seconds
</PRE>Default: 60
<P>
Specifies the maximum time allowed for a link delay. If delays exceed this
number, the server disables raw I/O and opportunistic locking for this
connection.
<P>
<PRE>OplockBreakWait   REG_DWORD   10 to 180 seconds
</PRE>Default: 35
<P>
Specifies the time that the server waits for a client to respond to an
oplock break request. Smaller values can allow detection of crashed clients
more quickly but can potentially cause loss of cached data.
<P>

	</FONT>
	</TD>
	</TR>
</TABLE>
<P>


<!--DOCBODY_END-->

<!--FOOTER_START-->
<table cellpadding=5 border=0 width="90%">
<tr>
<td>
	<HR WIDTH="90%">

<BLOCKQUOTE>
<FONT FACE="Verdana, Arial, Helvetica" SIZE="1">
<SPAN STYLE="font-family:verdana,arial,helvetica; font-size:8pt">
Additional query words: prodnt<BR>
Keywords          : MailPCExt ntgeneral kbusage kbusage<BR>
Version           : 3.0 3.2 3.2a 3.50 3.51 4.00<BR>
Platform          : WINDOWS<BR>

</SPAN>
</FONT>
<BR>
<BR>
THE INFORMATION PROVIDED IN THE MICROSOFT KNOWLEDGE BASE IS
PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND.  MICROSOFT DISCLAIMS
ALL WARRANTIES, EITHER EXPRESS OR IMPLIED, INCLUDING THE WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  IN NO
EVENT SHALL MICROSOFT CORPORATION OR ITS SUPPLIERS BE LIABLE FOR
ANY DAMAGES WHATSOEVER INCLUDING DIRECT, INDIRECT, INCIDENTAL,
CONSEQUENTIAL, LOSS OF BUSINESS PROFITS OR SPECIAL DAMAGES, EVEN IF
MICROSOFT CORPORATION OR ITS SUPPLIERS HAVE BEEN ADVISED OF THE
POSSIBILITY OF SUCH DAMAGES.  SOME STATES DO NOT ALLOW THE EXCLUSION
OR LIMITATION OF LIABILITY FOR CONSEQUENTIAL OR INCIDENTAL DAMAGES
SO THE FOREGOING LIMITATION MAY NOT APPLY.
</BLOCKQUOTE>
<P>
<center>
	<FONT FACE="Verdana,Arial,Helvetica" SIZE="1">
	Last reviewed:  November 12, 1997</FONT>
	<BR>
	<A href="../cpyright.htm" STYLE="font: bold 7pt Verdana,Arial,Helvetica">&copy; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A><BR>
	
</center>
</td>
</tr>
</table>

<!--FOOTER_END-->
</FONT>
</BODY>
</HTML>
