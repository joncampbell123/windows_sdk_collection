Windows NT 用ダイアログ エディタ (DlgEdit.Exe) での
カスタム コントロール サポートの仕様

既存の Windows 3.x 方式では NT 用に不十分である理由がいくつかあります。

1. DlgEdit は、ユーザーの操作によっては簡単にクラッシュします。
   DlgEdit の実行では、カスタム コントロール DLL が Win 3.x 用に
   記述された方法に準じて、ハードコーディングされた 3 つの序数 
   (2、3、および 4) に対応する 3 つの関数をエクスポートしなければ
   なりません。ユーザーは、[ファイルを開く] ダイアログを呼び出す
   メニュー オプションを選択し、DLL の名前を入力し、[OK] をクリックして
   この「カスタム コントロール DLL」をロードするようダイアログ 
   エディタに指示します。エディタは、指定されたモジュールをロードし、
   上記序数のアドレスをチェックおよび取得し、パラメータをスタック
   の上から入れ、呼び出しを開始します。ユーザーが選択した DLL が
   本当にカスタム コントロール DLLであることをエディタで確証する
   方法はありません。エディタは 3 つの序数の有無をチェックしますが、
   ほとんどの DLL には 4 つ以上のエクスポートがあり、その始まりは
   通常 1 なので、このチェックはあまり役に立ちません。つまり、ユー
   ザーは、USERSRV.DLL などのランダム DLL をロードしようとして、
   エディタをクラッシュさせることがおおいにに有り得るわけです。

2. Unicode は想定されていません。序数エクスポートの現在の方式では、
   API の xxxA および xxxW バージョンを想定していません。また、
   xxxW 構造体の集合を定義するときは、Unicode 文字列分の領域を
   確保しておく必要があります。

3. 受け渡しに使用される構造体には、使われなくなったフィールドがあり、
   そのいくつかは DWORD 境界になっていません。このインターフェイ
   スは、元来 Win 3.0 ダイアログ エディタ (dialog.exe) 用に作成されて
   おり、Win 3.1 および NT ダイアログ エディタ (DlgEdit.Exe) には不要
   なフィールドがあります。

4. NLS 言語値およびサブ言語値、さらにコントロール用の拡張スタイル
   など、Win 32 リソース ファイル形式の新しい機能のいくつかはサポー
   トされていません。

5. テキストに合わせてサイズ変更することや、コントロールがテキスト
   を取り込まないようにプロパティ バー上のテキスト入力フィールド
   を無効にしてテキストのコントロールへの入力を禁止することなど、
   新しいダイアログ エディタの一部の機能はサポートされていません。

6. カスタム コントロールは、DLL 当たり 1 つのクラスに制限されてい
   ます。これは、使用構造体により偶発的に発生する制約であって、
   これに対処するために、Pen Windows などの開発グループで各種の
   処置をとる必要がありました。

カスタム コントロール サポートを導入した主な理由は、上記の 2. で述べた 
Unicode サポートの欠落です。これも含めて上記に問題に対処するため、
Win32 (NT) ダイアログ エディタでのカスタム サポートを以下のように定め
ます。詳細は、CUSTCNTL.H ヘッダー ファイルを参照してください。


-- カスタム コントロールの初期化 ------------------------------------

カスタム コントロール DLL は、次の関数の 1 つまたは両方をその名前によ
りエクスポートします (エクスポートに使った序数は問いません)。

    UINT CALLBACK CustomControlInfoA(LPCCINFOA acci)
    UINT CALLBACK CustomControlInfoW(LPCCINFOW acci)

これらの関数のパラメータは、NULL または以下で定義する CCINFOA もしくは 
CCINFOW 構造体の配列へのポインタです。

typedef struct tagCCINFOA {
    CHAR    szClass[CCHCCCLASS];     // コントロールのクラス名
    DWORD   flOptions;               // オプション フラグ (CCF_* で定義)
    CHAR    szDesc[CCHCCDESC];       // コントロールの短い説明テキスト
    UINT    cxDefault;               // デフォルトの幅 (ダイアログ単位)
    UINT    cyDefault;               // デフォルトの高さ (ダイアログ単位)
    DWORD   flStyleDefault;          // デフォルトのスタイル (WS_CHILD | WS_VISIBLE)
    DWORD   flExtStyleDefault;       // デフォルトの拡張スタイル
    DWORD   flCtrlTypeMask;          // コントロール タイプのスタイル用マスク
    CHAR    szTextDefault[CCHCCTEXT];// デフォルトのテキスト
    INT     cStyleFlags;             // 後続するスタイル テーブルのエントリ
    LPCCSTYLEFLAGA aStyleFlags;      // スタイル フラグ テーブルへのポインタ
    LPFNCCSTYLEA lpfnStyle;          // Styles 関数へのポインタ
    LPFNCCSIZETOTEXTA lpfnSizeToText;// SizeToText 関数へのポインタ
    DWORD   dwReserved1;             // 予約。0 とすること。
    DWORD   dwReserved2;             // 予約。0 とすること。
} CCINFOA, *LPCCINFOA;

typedef struct tagCCINFOW {
    WCHAR   szClass[CCHCCCLASS];     // コントロールのクラス名
    DWORD   flOptions;               // オプション フラグ (CCF_* で定義)
    WCHAR   szDesc[CCHCCDESC];       // コントロールの短い説明テキスト
    UINT    cxDefault;               // デフォルトの幅 (ダイアログ単位)
    UINT    cyDefault;               // デフォルトの高さ (ダイアログ単位)
    DWORD   flStyleDefault;          // デフォルトのスタイル (WS_CHILD | WS_VISIBLE)
    DWORD   flExtStyleDefault;       // デフォルトの拡張スタイル
    DWORD   flCtrlTypeMask;          // コントロール タイプのスタイル用マスク
    INT     cStyleFlags;             // 後続するスタイル テーブルのエントリ
    LPCCSTYLEFLAGW aStyleFlags;      // スタイル フラグ テーブルへのポインタ
    WCHAR   szTextDefault[CCHCCTEXT];// デフォルトのテキスト
    LPFNCCSTYLEW lpfnStyle;          // Styles 関数へのポインタ
    LPFNCCSIZETOTEXTW lpfnSizeToText;// SizeToText 関数へのポインタ
    DWORD   dwReserved1;             // 予約。0 とすること。
    DWORD   dwReserved2;             // 予約。0 とすること。
} CCINFOW, *LPCCINFOW;

    szClass           - コントロール タイプのクラス名。このクラスは、
                        DLL により RegisterClass 呼び出しに登録しなけ
                        ればなりません。

    flOptions         - 次のオプション フラグです。

                          CCF_NOTEXT - このコントロールはテキストを持
                                       ちません。ダイアログ エディタの
                                       プロパティ バーにあるテキスト
                                       入力フィールドから、テキストを
                                       このコントロールに入力すること
                                       はできません。

    szDesc            - コントロール タイプの短い説明。長さが 0 の文字
                        列でも差し支えありません。

    cxDefault         - このタイプの新しいコントロールの幅の推奨値。
                        値は、ダイアログ単位です (ピクセル単位ではあり
                        ません)。

    cyDefault         - このタイプの新しいコントロールの高さの推奨値。
                        値は、ダイアログ単位です (ピクセル単位ではあり
                        ません)。

    flStyleDefault    - このタイプの新しいコントロールの初期スタイル。
                        最小スタイルでも、WS_VISIBLE と WS_CHILD を含
                        みます。

    flExtStyleDefault - このタイプの新しいコントロールの初期拡張スタイル。

    flCtrlTypeMask    - このマスクによって、このクラスに属する異なった
                        コントロール タイプを区別する flStyleDefault 
                        ビットが識別されます。このクラスに定義された
                        コントロール タイプが 1 つだけの場合は、この
                        マスクは 0 になります。詳細は、下記を参照して
                        ください。

    cStyleFlags       - 後続する配列内の要素 (スタイル) 数

    aStyleFlags       - コントロール用のスタイル情報を保持している 1 
                        つまたは複数の LPCCSTYLEFLAGA(W) 構造体への
                        ポインタ。

    szTextDefault     - このタイプの新しいコントロールの初期テキスト。
                        初期テキストがない場合は、長さが 0 の文字列に
                        なります。

    lpfnStyle         - このコントロール タイプに関連するカスタム コン
                        トロール Styles 関数へのポインタ。カスタム コン
                        トロールに、そのために作成されたプライベート 
                        スタイル ダイアログがないときは、NULL となり
                        ます。このポインタに NULL が指定され、ユーザー
                        がコントロールのスタイルの編集をする場合は、
                        ダイアログ エディタで汎用スタイル ダイアログを
                        使います。下記を参照してください。

    lpfnSizeToText    - このコントロール タイプに関連する SizeToText 
                        関数へのポインタ。コントロールがそのテキストに
                        合わせてサイズ変更できないときは、NULL となり
                        ます。また、flOptions に CCF_NOTEXT が指定され
                        ると、このポインタは無視されます。下記を参照し
                        てください。

    dwReserved1       - 予約値。0 にします。

    dwReserved2       - 予約値。0 にします。

CustomControlInfoW 関数が利用可能ならばこれを使い、利用可能でないときは 
CustomControlInfoA 関数を使います。この関数は、DLL がサポートしている
コントロールの数を戻します。ただし、エラーが発生すると、0 を戻します。

CustomControlInfoA(W) 関数は、最初 NULL をパラメータとして呼び出し、
サポートされているコントロールの数を取得します。次に、CCINFOA(W) 構造
体の配列へのポインタを指定して呼び出します。関数は、サポートされている
各コントロール タイプに関する情報を配列に入れます。

lpfnStyle および lpfnSizeToText フィールドは、NULL でないときは CCINFOW 
構造体に Unicode 文字列または構造体が入ることを想定している関数、CCINFOA 
構造体の中にあるときは ANSI 文字列を想定している関数を指すので、注意し
てください。

flCtrlTypeMask フィールドは、クラス内の各コントロール「タイプ」を定義
するのに、flStyleDefault フィールドのどのビットを使っているかを指定し
ます。例えば、標準の「ボタン」クラスには、オプション ボタン、プッシュ 
ボタン、チェック ボックスなど複数のタイプがあります。「ボタン」クラス
の各スタイルは、スタイルの下位 4 ビットですべて区別されます。この場合、
flCtrlTypeMask は 0x000F となります。複数のボタン タイプで使える 
BS_LEFTTEXT (0x0020) など別のスタイルもあり、ここでのマスクは、このス
タイルと一致するスタイルを見つけるため、このスタイルを切り分けるのに
使います。ダイアログ エディタは、このマスク値を使って次のような照合を
行います。すなわち、あるクラスについて定義されたと考えられる各種のコン
トロール タイプの中から、編集中のダイアログにあるカスタム コントロール
とタイプが正確に一致するカスタム コントロール クラスを見つけます。クラ
ス内の各コントロール タイプには、固有の Styles 関数および SizeToText 
関数が指定されているため、状況によってはコントロールをカスタム コント
ロール DLL 内の適切なコントロール タイプと照合することが重要となります。

カスタム コントロール DLL において、各クラスにつきコントロール タイプ
が 1 つだけのとき、または各クラス内のコントロール タイプそれぞれについ
て同じ Styles および SizeToText 関数を使っているとき、flCtrlTypeMask 
の値は 0 にできます。コントロール タイプを、その当初の作成元の DLL に
ある正確なコントロール タイプと照合することが重要ではないからです。
ただしどのような場合でも、同じクラス名に属するコントロール タイプには、
同じマスクを指定しなければなりません。


-- カスタム コントロールのスタイルの変更 ----------------------------

DlgEdit のユーザーがカスタム コントロールのスタイルの編集を要求すると、
エディタは CCINFOA(W) 構造体の lpfnStyle フィールドに指定された関数を
呼び出します。この関数によって起動され処理されるダイアログ ボックスを
使って、ユーザーはカスタム コントロールのスタイルを編集します。このよ
うな機能を実行するように、関数は作成されていなければなりません。また、
このダイアログのデザインは、ダイアログ エディタの既存のスタイル ダイア
ログの一般スタイル ガイドラインにしたがっていなければなりません。この
関数には次のプロトタイプがあります。

BOOL CALLBACK XxxxStyleA (HWND hwndParent,  LPCCSTYLEA pccs)

BOOL CALLBACK XxxxStyleW (HWND hwndParent,  LPCCSTYLEW pccs)

関数名 XxxxStyleA(W) は、プログラマが関数に与えた実際の名前を入れる
プレースホルダです。実際の名前は問いません。次のパラメータと共に呼び
出されます。

    hwndParent        - 表示されるダイアログの親ウィンドウ。Styles 
                        関数は、このウィンドウをこの関数が表示する
                        スタイル ダイアログの親として使います。

    pccs              - CCSTYLEA(W) 構造体へのポインタ。この構造体には、
                        コントロールの初期スタイルが格納されています。
                        スタイル ダイアログを介して入力されたユーザー
                        の指示に従って、このスタイルは変更されます。

CCSTYLEA(W) 構造体は次のように定義されます。

typedef struct tagCCSTYLEA {
    DWORD   flStyle;                 // コントロールのスタイル
    DWORD   flExtStyle;              // コントロールの拡張スタイル
    CHAR    szText[CCHCCTEXT];       // コントロールのテキスト
    LANGID  lgid;                    // コントロールのダイアログの言語 ID
    WORD    wReserved1;              // 予約値。変更はしないこと。
} CCSTYLEA, *LPCCSTYLEA;


typedef struct tagCCSTYLEW {
    DWORD   flStyle;                 // コントロールのスタイル
    DWORD   flExtStyle;              // コントロールの拡張スタイル
    WCHAR   szText[CCHCCTEXT];       // コントロールのテキスト
    LANGID  lgid;                    // コントロールのダイアログの言語 ID
    WORD    wReserved1;              // 予約値。変更はしないこと。
} CCSTYLEW, *LPCCSTYLEW;

    flStyle           - コントロールの現在のスタイルが入ります。関数が
                        戻る前に、ユーザーが選んだスタイルに設定されます。

    flExtStyle        - コントロールの現在の拡張スタイルが入ります。
                        関数が戻る前に、ユーザーが選んだ拡張スタイルに
                        設定されます。

    szText            - コントロールの現在のテキストが入ります。この
                        テキストは変更できますが、変更はお勧めしません。
                        DlgEdit 内のプロパティ バーによりテキストを変
                        更できますが、カスタム コントロールのスタイル 
                        ダイアログではこの機能は通常必要ではありません。
                        ただし、コントロールのテキストに特殊な情報や制
                        御コードが含まれていて、そのカスタム コントロー
                        ルによる解釈が通常と異なる場合などに変更が必要
                        となる可能性があります。

    lgid              - ダイアログの言語 ID はコントロールの中にあります。
                        表示目的だけです。変更はしないでください。

    wReserved1        - 予約値です。変更はしないでください。

この関数は、ユーザーがコントロールのスタイルを変更するときに使います。
新しい値により CCSTYLEA(W) 構造体が更新され、TRUE が戻ります。ユーザー
がダイアログを取り消すか、エラーが発生すると、FALSE が戻ります。

CCINFOA(W) 構造体の lpfnStyle フィールドが NULL のとき、ダイアログ 
エディタはデフォルトのスタイル ダイアログを使います。このダイアログに
よりスタイルのすべてのビットを設定できますが、各ビットに意味のある名前
は付きません。また、カスタム コントロールにとって無効なビット設定もあ
ります。カスタム コントロールに固有のダイアログを与える方が賢明です。


-- テキストに合わせたサイズ変更のサポート ---------------------------

ほかの標準的コントロール (オプション ボタン、プッシュ ボタンなど) と同様
に、カスタム コントロールもテキストに合わせたサイズ変更ができればたい
へん便利です。しかし、ダイアログ エディタは、カスタム コントロールの
マージン サイズなどを認識できず、テキストが納まるように自動的にサイズ
を変更することはできません。CCINFOA(W) 構造体には、必要に応じて 
lpfnSizeToText フィールドを指定できます。このフィールドでカスタム コン
トロール用の関数を指定し、ユーザーがカスタム コントロールをそのテキスト
に合わせてサイズ変更するよう指定すると、この関数が呼び出され、カスタム 
コントロールのサイズを変更します。この関数には次のプロトタイプがあります。

INT CALLBACK XxxxSizeToTextA (DWORD flStyle, DWORD flExtStyle,
                              HFONT hfont,   LPSTR pszText)

INT CALLBACK XxxxSizeToTextW (DWORD flStyle, DWORD flExtStyle,
                              HFONT hfont,   LPWSTR pszText)

    flStyle           - コントロールのスタイル。サイズ変更の方法を決定
                        するのに必要なときがあります。

    flExtStyle        - コントロールの拡張スタイル。サイズ変更の方法を
                        決定するのに必要なときがあります。

    hfont             - 現在編集中のダイアログのために選択されたフォン
                        トまたは NULL。このフォントにしたがってコント
                        ロールのサイズを決定します。関数が戻るとき、こ
                        のフォントは削除されず、どの DC でも選択状態に
                        なっていません。

    pszText           - カスタム コントロールのサイズ変更の際に基準と
                        なるテキスト。

XxxxSizeToTextA(W) 関数では、指定されたスタイル、フォント、およびテキ
スト列を使って、カスタム コントロールの最小サイズを決定し、この値を戻
します。この値は、ダイアログ単位ではなく、ピクセル単位です。エラーが
発生すると、この関数から -1 が戻ります。

