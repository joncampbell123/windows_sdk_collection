タイトル: 16 ビット コード (WOW と Win32s) から Win32 DLL ルーチンの呼び出し

INTEROP サンプルは、16 ビット コードであるサンクおよび SendMessage() から 
Win32 DLL のルーチンを呼び出す 2 つの一般的な方法をデモします。おのおのの
プラットフォーム用に、2 つの異なるサンクの方法があります。Windows NT の
汎用サンクと Win32s のユニバーサル サンクです。使われるメッセージは、
Windows NT および Win32s で導入された新しいメッセージの WM_COPYDATA です。
これら 3 つの方法は、プロセスですべてのポインタを変換して 16-32 の境界を
越えて関数を呼び出し、データを渡すための方法を提供します。サンクによる 
WM_COPYDATA の利点は、まったく同じコードがどちらのプラットフォーム (使われ
るサンクはプラットフォームに依存する) で実行されても高速であることです。
WM_COPYDATA の不利な点は、呼び出したアプリケーションに返される関数の戻り値 
(TRUE または FALSE 以外) を取得するための方法を工夫しなければならないこと
です。

サンプルは次のソース ファイルから構成されています:

   app16.c    -  Win16 アプリケーション
   dll16.c    -  ユニバーサル サンクと汎用サンクの 16 ビット側
   stub32.c   -  Win32s の 32 ビット DLL をロードする 32 ビット スタブ
   utdll32.c  -  ユニバーサル サンクの 32 ビット側
   disp32.c   -  WM_COPYDATA を介して送られたディスパッチ呼び出し
   
   dll32.c    -  Win32 DLL

汎用サンク
----------

Windows NT のもとで、汎用サンクを呼び出すインターフェイスを使って Win16 ア
プリケーションから Win32 DLL のルーチンを呼び出すことが可能です。SDK ファイル 
doc\sdk\misc\genthunk.txt はこのインターフェイスを詳しく説明しています。

次の図に INTEROP の方法をまとめて説明します。

                             dll32
                           ---------
                          |  Win32  |
    32-bit                |   DLL   |
                           ---------
                              /|\      
             ------------------|-------
                               |       
                ---------     ------------
               | Win 3.1 |<->| 16-bit DLL |
    16-bit     |   app.  |   |   (GT)     |
                ---------     ------------
                  app16           dll16

DLL16 は APP16 がロードされたときにロードされます。もしも、WOW の存在が
検出された場合は DLL32 をロードします。

WOW は、いくつかの新しい 16 ビット アプリケーション プログラミング イン
ターフェイス (API) を提供します。この API により、アプリケーションは Win32 
DLL をロードし、DLL ルーチンのアドレスを取得し、ルーチンを呼び出し (最大 
32 個までの 32 ビット引数を渡せる) 、16:16 (WOW) アドレスを 0:32 アドレス 
(ポインタを含み、ポインタを渡す構造体を作成する場合は便利です) に変換し、
さらに Win32 DLL を解放することができます。この関数を以下に示します。

   DWORD FAR PASCAL LoadLibraryEx32W( LPCSTR, DWORD, DWORD );
   DWORD FAR PASCAL GetProcAddress32W( DWORD, LPCSTR );
   DWORD FAR PASCAL CallProc32W( DWORD, ..., LPVOID, DWORD, DWORD );
   DWORD FAR PASCAL GetVDMPointer32W( LPVOID, UINT );
   BOOL FAR PASCAL FreeLibrary32W( DWORD );

Win16 アプリケーションをリンクする場合は、関数が WOW カーネルから
インポートされることを示す次の文を .DEF ファイルに入れる必要があり
ます。

   IMPORTS
      kernel.LoadLibraryEx32W
      kernel.FreeLibrary32W
      kernel.GetProcAddress32W
      kernel.GetVDMPointer32W
      kernel.CallProc32W

16 ビット コードはこれらの関数を呼び出しますが、関数には 32 ビット 
ハンドルを渡す必要があり、また関数からは 32 ビット ハンドルを返す
ことに注意してください。

さらに、_stdcall 規則に従って Win32 DLL エントリ ポイントが宣言され
ていることを確認してください。そうでないと、アクセス違反となります。


ユニバーサル サンク
-------------------

Win32s のもとで、ユニバーサル サンクと呼ばれるインターフェイスを使って Win16
アプリケーションから Win32 DLL のルーチンを呼び出すことができます。
このインターフェイスについては、Win32 プログラマ リファレンスに詳しく説明され
ています。サンプル UTSAMPLE は反対の (より典型的な) 場合である、16 ビット
ルーチンを呼び出す Win32 アプリケーションを示しています。

以下に、INTEROP のモジュールの関係をまとめて説明します。

                         stub           utdll32         dll32     
                      -----------     -----------     ---------
                     |   Win32   |-->| Win32 DLL |<->|  Win32  |
    32-bit           |    EXE    |   |    (UT)   |   |   DLL   |
                      -----------     -----------     ---------
                              /|\      /|\
             ------------------|--------|-------------------------
                               |       \|/
                ---------     ------------
               | Win 3.1 |<->| 16-bit DLL |
    16-bit     |   app.  |   |   (UT)     |
                ---------     ------------
                  app16           dll16

ロードの順序は次のとおりです。 Windows 3.1 アプリケーションが 16 ビット 
DLL をロードします。16 ビット DLL は 32 ビット側が初期化されたかどうか
を検査します。初期化されていない場合、DLL は 32 ビット EXE (スタブ) を
生成し、それが16 ビット DLL でユニバーサル サンクをセットアップする 
32 ビット DLL をロードします。すべての構成要素がロードされ初期化された
後で、Windows 3.x アプリケーションが 16 ビット DLL のエントリ ポイントを
呼び出した場合、16 ビット DLL は 32 ビット側にデータを渡すために 32 
ビット ユニバーサル サンクのコールバックを使います。ひとたび、32 ビット
側が呼び出しを受けると、適切なWin32 DLL のエントリ ポイントが呼び出され
ます。

WM_COPYDATA
-----------

このメッセージのための wParam と lParam は次のとおりです。

   wParam = (WPARAM) (HWND) hwndFrom;   /* 送り側のウィンドウのハンドル */
   lParam = (LPARAM) (PCOPYDATASTRUCT) pcds;

ここで、 hwndFrom は送り側のウィンドウのハンドルです。COPYDATASTRUCT は
次のように定義されます。

   typedef struct tagCOPYDATASTRUCT {
       DWORD dwData;
       DWORD cbData;
       PVOID lpData;
   } COPYDATASTRUCT;

INTEROP サンプルは、どの Win32 DLL エントリ ポイントを呼び出すべきかを示す
関数コードとして dwData を使います。また関数に渡される構造体にポインタを含
めるために lpData を使います。

以下に、INTEROP のモジュールの関係をまとめて説明します。

                         disp           dll32     
                      -----------     ---------
                     |   Win32   |-->|  Win32  |
    32-bit           |    EXE    |   |   DLL   |
                      -----------     ---------
                              /|\      
             ------------------|----------------------------------
                               |       
                ---------     ------------
               | Win 3.1 |<->| 16-bit DLL |
    16-bit     |   app.  |   |  (THUNK)   |
                ---------     ------------
                  app16           dll16

DLL16 は APP16 がロードされたときにロードされます。DISP はプラットフォームに
関係なく、WM_COPYDATA メッセージを処理するために生成されます。DISP は引数を
整理して、DLL32 への呼び出しをディスパッチします。

