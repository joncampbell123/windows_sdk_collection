サンプル:　名前付きパイプ クライアント サーバーのデモ

要約:

NPCLIENT と NPSERVER は、名前付きパイプの使い方のデモを行い
ます。基本的な構成として、サーバー アプリケーションが複数の
クライアント アプリケーションにサービスを提供します。ユーザー
は、クライアント アプリケーションをインターフェースとして使い、
サーバーを経由して他の全クライアントにアクセスできます。結果
として、ネットワーク上で、複数のクライアント間で簡単な会話を
行うことができます。

詳細:

実際のプログラミングは、NPSERVER アプリケーションが
新しいスレッドを開始して、名前付きパイプのサーバー側の
新しいインスタンスを開始します。このインスタンスは、
クライアントが接続する度に 1 つずつ作成されます。NPSERVER 
アプリケーションのインスタンスを 1 つ起動するだけで、
NPCLIENT アプリケーションの 100 個までのインスタンスに
サービスを提供できます。(注:  100 個の制限は、サンプル
にハード コードされている値であり、名前付きパイプは
ほとんど無限に作成できます。)

使用法:

NPSERVER を起動します。ウィンドウが現れます。

NPCLIENT を起動します。2 つのダイアログボックスが現れます。
トップ レベルのダイアログ ボックスは、共有名と、クライアント
名またはユーザー名の入力を要求します。NPCLIENT が、NPSERVER 
に対してローカル（同じマシン上）であるなら、共有名には '.' 
を入力してください。もしそうでなければ、NPSERVER が起動され
ているサーバーのマシン名を入力してください (例えば、
'FoobarServer' など)。クライアント名またはユーザー名には、
使用するユーザーを識別する任意の名前を入力してください。
Enter キーを押すか、[OK] ボタンをクリックしてください。

上にあったダイアログ ボックスが消えて、NPCLIENT のクライア
ント ダイアログ ボックスが残ります。このダイアログ ボックス
は、2 つのエディット フィールドと [送信] ボタンで構成され
ています。大きい、上にあるエディット フィールドで、他の
クライアント (または自分) からのメッセージを読む事ができます。
（注:  メッセージが混ざってしまうようなら、エディット 
フィールドのカーソルをフィールドの左下角に移動してくだ
さい。）小さいエディット フィールドは、メッセージを入力する
ために使います。メッセージを送信するには、この下にある
小さいエディット フィールド内に入力して、Enter キーを押すか、
[送信] ボタンをクリックしてください。NPSERVER に接続してい
るすべてのクライアントの大きなエディット フィールドに、この
メッセージが現れます。NPCLIENT のキャプション バーに、選択
したユーザー名が表示されていることに注目してください。これ
により、同じマシン上で複数の NPCLIENT を実行しているときに、
追跡が容易になります。

NPCLIENT からトップ レベルのダイアログ ボックスが消える
のと同時に、NPSERVER ウィンドウに、ユーザー名の付いた赤
い糸巻の絵が表示されます。この赤い糸巻は、NPSERVER と
現在接続されているクライアント スレッドを示します。糸巻
は、薄い青線によって他の糸巻と接続されています (ファイル 
マネージャのディレクトリやファイルが接続されている線と
似た表示です)。クライアントが NPSERVER から接続解除された
時は、糸巻が灰色になります。

設計:

基本的に、NPSERVER アプリケーションは複数のサーバー 
スレッドを作成します。アプリケーションが起動されると、
最初のスレッドが作成されます。このスレッドは、サーバー
側の名前付きパイプを作成し、クライアントとの接続を待ち
ます。クライアントが接続されると、別のスレッドが起動さ
れ、これもブロック待ち状態になってクライアントを待ちま
す。その間に、最初のスレッドは、この固有のクライアント
情報でクライアント情報のグローバル配列を更新します。
スレッドは、このクライアントから読み取るためのループに
入ります。このクライアントがメッセージを送信すると、
このサーバー スレッドは、グローバル配列にリストされた
すべてのクライアントへメッセージを書き込む関数（TellAll）
を呼び出します。

クライアント側では、NPCLIENT が、CreateFile を呼び出して
名前付きパイプとの接続を試みます。接続されると、ループして
サーバー側からメッセージを読むスレッドを作成します。
メッセージを読んだら、大きなエディット フィールドに出力し
ます。ユーザーが [送信] ボタンを押したときは、メイン 
スレッドが下のエディット フィールドからテキストを読み取り、
サーバーへ書き込みます。

NPSERVER と NPCLIENT 間のやりとりを以下に示します。

   NPSERVER                          NPCLIENT
   --------                          --------

   CreateNamedPipe()
   ConnectPipe()   // ブロック
                                      CreateFile()  //パイプと接続
                                      パイプを読み取る別のスレッドを作成する
   ブロックから戻る
　 クライアントの配列を更新
　 別のサーバー スレッドを作成
   Loop
     ReadFile() // オーバラップ上のブロック
                                      WriteFile() // [送信] キーが押される

     ブロックから戻る
     WriteFile() // クライアントへ同報通信
   End loop      // クライアントがパイプを切ったとき


                                      ReadPipe スレッド:
                                        Loop
                                          ReadFile()
                                            サーバーの同報通信をブロック待ち

                                            ブロックから戻る
                                            エディット フィールドに文字列を出力

                                         End loop // サーバーが切ったとき

パイプが読み書きにどれだけ時間がかかるかわからない場合は、
オーバラップ構造を使ってください。これにより、スレッドは
読み書きからすぐに戻り、アプリケーションの他の部分を実行
できます。名前付きパイプで同時に読み書きを行いたい場合も、
オーバラップ構造を使います。

