 Microsoft(R) Windows NT(R) 4.0 Device Driver Kit

=================================================================
Additional Information for Far East Edition User
 (Japanese, Traditional Chinese, Simplified Chinese, and Korean)
=================================================================

November 1996


-----------------
Table of Contents
-----------------

1. Introduction
2. Installation
3. Development Environment
4. Additional Features for Far East Language Editions
5. Installation of Windows NT 4.0 Checked Build (Japanese-specific)
6. Notification for This Release (Japanese-Specific)


----------------
1.  Introduction
----------------

This document provides the additional information for using Microsoft(R) Windows NT(R) 4.0 Device Driver Kit to develop device drivers for Windows NT 4.0 Japanese, Traditional Chinese, Simplified Chinese, and Korean Edition.

This release of DDK provides an integrated development environment for the Far East language editions.  The GUI setup program installs corresponding components automatically for the default language of Windows NT 4.0 on your machine.


----------------
2.  Installation
----------------

To use DDK for developing device drivers for Windows NT Far East language edition, you need the following software before installing DDK:
 - Windows NT 4.0 Japanese, Traditional Chinese, Simplified Chinese, or Korean edition
 - Win32 SDK
 - Microsoft Visual C++ 4.x or compatible 32-bit compiler

To install DDK on Windows NT Far East language edition, the following amount of additional disk space is required. To know the total necessary disk space to install DDK, please see DDKSTART.HLP.

	Platform:	MAX	MIN
	---------------------------
	x86		2MB	1MB
	MIPS		2MB	1MB
	Alpha		2MB	1MB
	PPC		2MB	1MB

The GUI setup program will detect the default language of the system currently running, and then install the necessary components.


---------------------------
3.  Development Environment
---------------------------

This section describes the difference in the development environment of DDK between English and Far East language editions.

To build a driver for Far East language edition, please choose [Free Build Environment] or [Checked Build Environment] from [Start] - [Program] - [Windows NT DDK].
You can also use setenv.bat in \DDK\BIN directory with the following syntax:

setenv <installed DDK path> [free|checked]

Note: DDK provides several kinds of setenv.bat for English, Japanese, Traditional Chinese, Simplified Chinese, and Korean editions.

For example, Japanese edition includes the following additional compile flags:

set C_DEFINES=

 DDBCS
 DJAPAN
 DKKBUGFIX
 DDBCS_VERT
 DFE_SB

set LANGUAGE=JPN

3.1  Headers (Japanese-specific)
--------------------------------

The following headers are provided for Japanese-specific features.
<changed> means that the file is changed to support additional features.
<added> means that the file is added to support additional features.

NTDDDISK.H
<changed> Japanese additional media types are added.

3.2 Libs
--------

The following free and checked version libs are provided for the Far East common features.
<changed> means that the file is changed to support additional features.
<added> means that the file is added to support additional features.

GDI32.LIB
<changed> This file is necessary to support EUDC API.

USER32.LIB
<changed> This file is necessary to support old 32-bit IME API.

COMDLG32.LIB
<changed> CHT/CHS IME sample uses.

IMM32.LIB
<changed> CHT/CHS IME sample uses.

UNIIME.LIB
<added> CHT/CHS IME sample uses.

3.3  UniTool, Ctt2rle.exe, and Pfm2ifi.exe
------------------------------------------

UniTool 3.x
<changed> Far East version UniTool 3.x can create a mini-driver that can share its resources with Windows 95 Far East edition.  This UniTool can open any version of mini-drivers, however it cannot create a mini-driver that is compatible with Windows 3.1 Japanese edition.  When you edit the mini-driver made by UniTool 1.11 (provided for Windows 3.1 Japanese edition), the data may become corrupt.  Of course, it does not become corrupt just by opening it with Far East version UniTool 3.x.
If you create a new mini-driver, use this new version of UniTool. This UniTool will be copied on the default path (\DDK\BIN) when you install DDK.

Note: You can check the mini-driver version using [MiniDriverData] command in [Printer Data] menu.

Ctt2rle.exe and Pfm2ifi.exe
<changed> You need to use Far East version Ctt2rle.exe and Pfm2ifi.exe to develop a mini-driver for a Far East language.

3.4 Extended Value of GetKeyboardType()
------------------------------------------

The GetKeyboardType function retrieves information about the current keyboard. Some retune value have been extended for the Japanese and Korean edition.

	int GetKeyboardType(
     		int nTypeFlag 	// type of information to retrieve  
 	     );	
 
	Parameters
	nTypeFlag
	Specifies the type of keyboard information to be retrieved. This parameter can be one of the following values: 

	 Value	Meaning
  	 0	Keyboard type
 	 1	Keyboard subtype
 	 2	Number of function keys on the keyboard
 
	Return Values
	If the function succeeds, the return value specifies the requested information. 
	If the function fails, the return value is zero. 

	Remarks
	The type may be one of the following values:
 
 	 Value	Meaning
 	 1	IBM(R) PC/XT(R) ( ) or compatible (83-key) keyboard
 	 2	Olivetti(R) "ICO" (102-key) keyboard
  	 3	IBM PC/AT(R) (84-key) or similar keyboard
  	 4	IBM enhanced (101- or 102-key) keyboard
  	 5	Nokia(R) 1050 and similar keyboards
  	 6	Nokia 9140 and similar keyboards
  	 7	Japanese keyboard
 	 8	Korean keyboard

	The subtype is an original equipment manufacturer (OEM)-dependent value. but if the keyboard type is 7 (Japanese keyboard) or 8 (Korean 	keyboard), hibyte of subtype contains its driver manufacturer indentifier. And, lobyte of subtype contains its keyboard hardware subtype which may be one of follows.

	Value Meaning
		[ Japanese Keyboard Types ]
		Driver manufacturer indentifier	Keyboard hardware subtype	Description
		0									Microsoft
				 			0				PC/AT 101 Enhanced keyboard
				 			1				AX compatible keyboard
				 			2				PC/AT 106 Japanese keyboard
				 			3				IBM 5576-002 keyboard
				 			4				IBM 5576-001 keyboard

		1									AX consortium
							1				AX keyboard

		5									Fujitsu
							0				FMR JIS Keyboard
							1				FMR OASYS Keyboard
							2				PC/AT OASYS Keyboard
	
		13									NEC
							1				PC-9800 standard keyboard
							4				PC-9800 note/laptop keyboard
							5				PC-9800 106 Japanese keyboard

		18									Toshiba
							1				Toshiba desktop type keyboard
							2				Toshiba laptop type keyboard

		[ Korean Keyboard types ]
		Driver manufacturer indentifier Description
		0				  Microsoft				
	
		Keyboard hardware subtype	Description
		3				PC/AT 101 Enhanced keyboard (A)
		4				PC/AT 101 Enhanced keyboard (B)
		5				PC/AT 101 Enhanced keyboard (C)
		6				PC/AT 103 Korean keyboard
	 
	The application can also determine the number of function keys on a keyboard from the keyboard type. Following are the number of function keys for 	each keyboard type.

	  Type	Number of function keys
  	1	10
  	2	12 (sometimes 18)
  	3	10
  	4	12
  	5	10
  	6	24
  	7,8	Hardware dependent and specified by the OEM


------------------------------------------------------
4.  Additional Features for Far East Language Editions
------------------------------------------------------

The additional sample codes and on-line documents are provided for Windows NT 4.0 Far East edition .

Note: The Font Driver sample code is no longer provided, because it does not work on Windows NT 4.0.

4.1  Security consideration of IME/IMM and New Sample Program of IME/IMM
---------------------------------------------------------------------------------------------------

Additional documentation for the developers of IME/IMM programs which work on Windows NT 4.0 Far East edition is provided under \ddk\doc\spec\ime directory. A simple sample code is also available in \sample sub directory.

And the new sample programs of IME/IMM for each language, Japanese (\jpn), Traditional Chinese (\cht), and Simplified Chines (\chs) are available under \ddk\src\input\ime. To know more detail for those each language IME sample, please see README.TXT in each sub directory.

4.2  Japanese "3-mode" floppy disk driver (Japanese-specific)
---------------------------------------------------------------
Japanese "3 mode" floppy driver sample is available in this release:

4.2.1. Overview

The Japanese modification allows floppy.sys make access to the following floppy media track formats which are popular in Japanese market. These are not supported by the core (English) floppy.sys code.

    5" 1.2M 1024 byte x 8 sector (PC98 1.2M)
    5" 720k 512byte x 9 sector
    5" 640k 512byte x 8 sector (PC98 640K)
    
    3.5" 1.2M 1024 byte x 8 sector (PC98 1.2M)
    3.5" 1.2M 512 byte x 15 sector (Toshiba 1.2M)
    3.5" 720k 512byte x 9 sector
    3.5" 640k 512byte x 8 sector (PC98 640K)

The Japanese floppy devices which support these media in addition to the ordinal (PC/AT compatible) floppy media are generally called "3 mode" floppy devices. In addition to PC/AT media, it can support Japanese (PC98) double sided hi-density and double-sided double density floppy media.

4.2.2. Motor speed definition for media

In order to make access to the above media, Japanese floppy drive controllers have functionality to change motor speed, so that the device can make access to the media with various track formats.

In floppy.sys Japanese modification, following member is added to DriveMedicaConstant table information so that the driver can know in which motor speed the device should make access to the media. Also, DriveMediaConstants table includes the entries for the above mentioned Japan specific floppy media type definitions.

    typedef struct _DRIVE_MEDIA_CONSTANTS {
        ...
    #ifdef JAPAN
        USHORT     MotorSpeed;
    #endif // JAPAN
    } DRIVE_MEDIA_CONSTANTS, *PDRIVE_MEDIA_CONSTANTS;
    
    Possible MotorSpeed values:
    0      - Default.  Take no action
    Others - Expected motor speed (rpm).  If necessary the motor speed should be changed within the device specific FlChangeMotorSpeed() function.

4.2.3. Motor speed function

The below function is the only place where a device specific code should be added to support Japanese "3 mode" floppy devices.

    BOOLEAN
    FlChangeMotorSpeed(
        IN DDISKETTE_EXTENSION DisketteExtension,
        IN BOOLEAN Context );

    Context tells FlChangeMotorSpeed() in which context it has been called.

    FALSE - floppy.sys has not issued the SPECIFY/CONFIGURE command yet.
    TRUE -  floppy.sys has already issued the SPECIFY/CONFIGURE command.

Unfortunately how to switch floppy device motor speed varies from system to system.  On some implementation change motor speed operation should be done before SPECIFY/CONFIGURE command is issued by floppy.sys. On other systems it should be done after SPECIFY/CONFIGURE.  Hence this context flag.

Within FlChangeMotorSpeed(), the expected motor speed can be obtained by the following.

    DisketteExtension->DriveMediaConstants.MotorSpeed

FlChangeMotorSpeed() is called twice each time FLOPPY.SYS tries to set the floppy drive controller so that proper media parameter is set.
FlChangeMotorSpeed() should try to set motor speed when absolutely needed  e.g. in case the device is not 3 mode 3.5" floppy device.

4.3 Keyboard driver sample 
----------------------------------------------

The sample keyboard driver of i8042prt for Far East common is available. That is useful for the common portion of the Intel i8042 port driver which applies to both the keyboard and the auxiliary (PS/2 mouse) device.

The keyboard layout driver has been changed from previous version. The samples for 101 English keyboard and 106 Japanese keyboard are provided in this release.

4.4  Printer driver sample
--------------------------

Sample codes for Far East common PostScript Printer driver and language-specific mini-drivers are provided in this release.

PostScript Printer

This sample code demonstrates how to implement Far East Character Set Function in PostScript Printer driver for Windows NT 4.0. For general information about Win32 device drivers and PostScript Language, please see also "Win32 Subsystem Driver Design Guide" and "PostScript Reference Manual revision 2."

Mini-Driver

[Japanese]
The following mini-driver sample code is available in this release:
- Canon BJ-10v Printer
- ESC/Page Printer
- NEC PC-PR201 Printer

[Traditional Chinese]
The following mini-driver samples are available in this release:
- Epson24c
- Nec24c
- Pansn24c
- Star24ec

4.5  Localizing resources (Japanese-specific)
---------------------------------------------

The .RC and .MC files in the sample codes include only English strings. You can localize the resources using RLMAN.EXE included in Win32 SDK, after you have built these codes. Some of the sample codes include Japanese-language token files (.tok) for use with RLMAN.EXE.
To replace the resource tables in the built binary for Japanese edition, run the following command:

rlman  -p 932  -n 17 1 -r  source_file  token_file  target_file

When you use the identical path name for source_file and target_file, the source binary will be overwritten.  If you want to keep the original built binary, please back it up yourself.

To know more detail about RLMAN.EXE, please see RLMAN.HLP in Win32 SDK.

4.6 Setup sample (Japanese-specific)
------------------------------------

The Localized INF samples are available in this release.


--------------------------------------------------------------------
5.  Installation of Windows NT 4.0 Checked Build (Japanese-specific)
--------------------------------------------------------------------

Basically, the installation method of checked version Windows NT 4.0 Japanese edition is the same as that described in DDKSTART.HLP.

To debug the device driver, you need to install checked version Windows NT on a second machine.

Important: Before you start the installation of checked version Windows NT 4.0 Japanese edition, you need to connect the debugging machine and the target machine with the serial cable.  If you fail to boot the target machine during installation, please edit boot.ini in the boot partition and add "/DEBUG" option to the end of the line of the system that you are trying to boot.

When you install a checked version, you should install only the necessary components to save disk space.

There are 3 methods to install a checked version of Windows NT 4.0 Japanese edition:

 - Use a CD-ROM drive supported by Windows NT, which is attached to the system.

 - (x86 only) Use winnt.exe at <CD_DRIVE>:\i386 or <CD_DRIVE>:\pc98.  This allows you to install Windows NT from MS-DOS using a  CD-ROM drive or a shared directory on the network that can be accessed from MS-DOS.

 - Use winnt32.exe at <CD_DRIVE>:\{platform}.  Winnt32.exe allows you to install Windows NT from Windows NT 3.x using a CD-ROM drive or a shared directory on the network that can be accessed from Windows NT 3.x.

Important: In case of the first method, please use the setup floppy disks for a free version.  You cannot make setup floppy disks from a checked version.  When you make the setup floppy disks from free version Windows NT CD-ROM, please run "winnt /ox" from \i386 or \pc98 directory.

Note: When you use the setup floppy disks for a free version, the setup program will check the available hard disk space with the value for the free version.  This may cause an error of "insufficient disk space" during the installation, even if the setup program did not alert.  If you encounter this error, please make more free disk space, or exit setup and try another hard disk drive with enough free disk space.

Note: Even though you can install the checked system with any of the methods above, we recommend the fist method which is the fastest and requires the least amount of free disk space.


-----------------------------------------------------
6.  Notification for This Release (Japanese-Specific)
-----------------------------------------------------

This section provides the notification for this release.

6.1  Restrictions for PC-9800 series
------------------------------------

This release of checked version Windows NT 4.0 Japanese edition for PC-9800 series has the following restrictions:

- To install checked version on PC-9800, please follow the instruction below.
(1) run winnt32.exe/winnt.exe
(2) modified as txtsetup.sif that is located at root of target drive such as below:

[SetupData]
OsLoadOptions = "/debug /baudrate=38400"          updated
OsLoadOptionsVar = "/debug /baudrate=38400"       added

- Do not use the partition that is equal to or less than 128MB. If the machine has such a partition, please disconnect it from the machine.

- You cannot use the second RS-232C port implemented in the machine.

- Some drivers may cause assertion errors.
