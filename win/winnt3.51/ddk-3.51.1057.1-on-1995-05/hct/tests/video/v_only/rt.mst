'*********************************************************************
'
'   Title:       Automation for the hct resview test.
'
'   Name:       rt.mst
'   Creator:    Dieter Achtelstetter
'
'   Paramiter1   : /c  Will create screan file
'   Paramiter2   : /CU:  If given will test curser tests
'   Paramiter2   : /B:   If given will test bitmap tests
'   Paramiter2   : /i:   If given will test icon tests
'   Returns      :
'   Globals used :
'*********************************************************************
'---- Includes
'$define testdlgs
'$define TESTSCRN
'$define TESTCTRL

'$INCLUDE   'f:\vt\INC\MSTEST32.INC'
'$INCLUDE   'f:\vtcom\pars3.mst'
'$INCLUDE   'f:\vtcom\loging.mst'
'$INCLUDE   'f:\vt\INC\winapi.INC'
'====== Globel veriables
    '---- Command line arg stuf
        dim   pars_found(6) as  tpars
        dim   leagel_pars(6) as string
        leagel_pars(0) = "/C:"  '---- Will create screen file
        leagel_pars(1) = "/CU:" '---- Will do curser stuff
        leagel_pars(2) = "/B:"  '---- Will Do bitmap stuff
        leagel_pars(3) = "/I:"  '---- Will do icon stuff
        leagel_pars(4) = "/S:"  '---- Will do strech stuff
        leagel_pars(5) = ""
    '---- Flag if to create the screan file or compare window to it. This is set with the /c:  command line switch
    global create_screen_file   as integer

    global TempScreenFileName as string '----- Will hold current name of temp scn file name.
    global ScreenFileName as string     '----- Name of screen file to create or use
    global Curser  as integer           '----- If to test curser option this is set with the  /CU: command line switch
    global Bitmap   as integer          '----- If to test bitmap option this is set with the  /B: command line switch
    global Icon  as integer             '----- If to test icon option this is set with the  /I: command line switch
    global Stretch  as integer          '----- If to test stretch option
    global Xres ,Yres as integer        '----- Will hold screen resolution
    global BitmapString(100) as string  '----- Holds key sequences to get to all bitmap screens
    global IconString(25) as string     '----- Holds key sequences to get to all Icon screens
    global CurserString(25) as string   '----- Holds key sequences to get to all Curser screens
    global StretchString(25) as string  '----- Holds key sequences to get to all Stretch Menues

    '---- Ini BitmapStrin array
    '---- Bitmap stiff
    BitmapString(0) = "%(b)a"
    BitmapString(1) = "ALT_B_A"
    BitmapString(2) = "%(b)b"
    BitmapString(3) = "ALT_B_B"
    BitmapString(4) = "%(b)c"
    BitmapString(5) = "ALT_B_C"
    BitmapString(6) = "%(b)d"
    BitmapString(7) = "ALT_B_D"
    BitmapString(8) = "%(b)e"
    BitmapString(9) = "ALT_B_E"
    BitmapString(10) = "%(b)f"
    BitmapString(11) = "ALT_B_F"
    BitmapString(12) = "%(b)g"
    BitmapString(13) = "ALT_B_G"
    BitmapString(14) = "%(b)h"
    BitmapString(15) = "ALT_B_H"
    BitmapString(16) = "%(b)i"
    BitmapString(17) = "ALT_B_I"
    BitmapString(18) = "%(b)j"
    BitmapString(19) = "ALT_B_J"
    BitmapString(20) = "%(b)k"
    BitmapString(21) = "ALT_B_K"
    BitmapString(22) = "%(b)l1"
    BitmapString(23) = "ALT_B_L1"
    BitmapString(24) = "%(b)l2"
    BitmapString(25) = "ALT_B_L2"
    BitmapString(26) = "%(b)l3"
    BitmapString(27) = "ALT_B_L3"
    BitmapString(28) = "%(b)l4"
    BitmapString(29) = "ALT_B_L4"
    BitmapString(30) = "%(b)l5"
    BitmapString(31) = "ALT_B_L5"
    BitmapString(32) = "%(b)l6"
    BitmapString(33) = "ALT_B_L6"
    BitmapString(34) = "%(b)l7"
    BitmapString(35) = "ALT_B_L7"
    BitmapString(36) = "%(b)l8"
    BitmapString(37) = "ALT_B_L8"
    BitmapString(38) = "%(b)m"
    BitmapString(39) = "ALT_B_M"
    BitmapString(40) = "%(b)n"
    BitmapString(41) = "ALT_B_N"
    BitmapString(42) = "%(b)o"
    BitmapString(43) = "ALT_B_O"
    BitmapString(44) = "%(b)p"
    BitmapString(45) = "ALT_B_P"
    BitmapString(46) = "%(b)q"
    BitmapString(47) = "ALT_B_Q"
    BitmapString(48) = "%(b)r"
    BitmapString(49) = "ALT_B_R"
    BitmapString(50) = "%(b)s"
    BitmapString(51) = "ALT_B_S"
    BitmapString(52) = "%(b)t"
    BitmapString(53) = "ALT_B_T"
    BitmapString(54) = "%(b)u"
    BitmapString(55) = "ALT_B_U"
    BitmapString(56) = "%(b)v"
    BitmapString(57) = "ALT_B_V"
    BitmapString(58) = "%(b)w"
    BitmapString(59) = "ALT_B_W"
    BitmapString(60) = "" '---- Inicats end
    BitmapString(61) = ""
    '---- Icon stuff
    IconString(0)    = "%(i)1"
    IconString(1)    = "ALT_I_1"
    IconString(2)    = "%(i)2"
    IconString(3)    = "ALT_I_2"
    IconString(4)    = "%(i)3"
    IconString(5)    = "ALT_I_3"
    IconString(6)    = "%(i)4"
    IconString(7)    = "ALT_I_4"
    IconString(8)    = "%(i)5"
    IconString(9)    = "ALT_I_5"
    IconString(10)   = "" '---- Inicats end
    IconString(11)   = ""
    '---- Curser stuff
    CurserString(0)  = "%(c)1"
    CurserString(1)  = "ALT_C_1"
    CurserString(3)  = "%(c)2"
    CurserString(4)  = "ALT_C_2"
    CurserString(5)  = "%(c)3"
    CurserString(6)  = "ALT_C_3"
    CurserString(7)  = "%(c)4"
    CurserString(8)  = "ALT_C_4"
    CurserString(9)  = "%(c)5"
    CurserString(10)  = "ALT_C_5"
    CurserString(11)  = "%(c)6"
    CurserString(12)  = "ALT_C_6"
    CurserString(13)  = "%(c)7"
    CurserString(14)  = "ALT_C_7"
    CurserString(15)  = "%(c)8"
    CurserString(16)  = "ALT_C_8"
    CurserString(17)  = "%(c)9"
    CurserString(18)  = "ALT_C_9"
    CurserString(19)  = "%(c)a"
    CurserString(20)  = "ALT_C_A"
    CurserString(21)  = ""
    CurserString(22)  = ""
    '---- Stretch suff
    StretchString(0)  = "%(s)1"
    StretchString(1)  = "ALT_S_1"
    StretchString(2)  = "%(s)2"
    StretchString(3)  = "ALT_S_2"
    StretchString(4)  = "%(s)3"
    StretchString(5)  = "ALT_S_3"
    StretchString(6)  = "%(s)4"
    StretchString(7)  = "ALT_S_4"
    StretchString(8)  = "%(s)5"
    StretchString(9)  = "ALT_S_5"
    StretchString(10)  = "%(s)6"
    StretchString(11)  = "ALT_S_6"
    StretchString(12)  = "%(s)7"
    StretchString(13)  = "ALT_S_7"
    StretchString(14)  = "%(s)8"
    StretchString(15)  = "ALT_S_8"
    StretchString(16)  = ""
    StretchString(17)  = ""

'---- Function/Sub Definitions
declare function togle(sec as integer)
declare function compwindowed(scnfile as string  , scn$, hWnd&) as integer
declare function compnonwindowed(scnfile$ , scn$) as integer
declare function test_screans(number_of_screens as integer, number_of_togles_per_screan as integer)   as integer
declare function next_screen()
declare function help(s as string)
declare function read_ini(ini_file as string) as string
declare sub getscreenres (x as integer, y as integer)
'declare function logr(text as string, s as integer, t as integer)
''$define START_DISPTEST_USING_RUN
'---- Main
'---- Function bodys
'*********************************************************************
'
'   Function:
'
'   Paramiter1   :
'   Returns      :
'   Globals used :
'   Description  :
'*********************************************************************
'======== Ini Stuff
    TogleWait = -1  '---- IF this value will not change after i get arguments i will use TogelDefaultValue
    create_screen_file = false  '----- I default to no to creat the screan file
    Curser = FALSE
    Bitmap = FALSE
    Icon   = FALSE
'======== Handle command line arguments
    ret =  get_paramiters(command$, leagel_pars , pars_found)
    if ret = -100 then '---- Invallid paramiter given
        help("Invalid prameter")
    elseif ret = 0 then '---- no paramiters given
        help("No Parameters given")
    else '---- We have paramiters
        for i = 0 to ret -1
            if   pars_found(i).switch =   "/?"  then      ' help switch
                help("HELP")
            elseif  pars_found(i).switch =   "/C:"  then   ' Create screen file
                create_screen_file = true
                'ScreenFileName =  pars_found(i).par

            elseif  pars_found(i).switch =   "/CU:"  then   ' Create screen file
                Curser = true
            elseif  pars_found(i).switch =   "/B:"  then   ' Number of screans to test
                Bitmap = TRUE
            elseif  pars_found(i).switch =   "/I:"  then   ' Number of screans to test
                Icon = TRUE
            elseif  pars_found(i).switch =   "/S:"  then   ' Number of screans to test
                Stretch = TRUE
            endif
        next i
    endif

  ScreenFileName =  "rt.scn"
'======= start progrum and get window handle

    Run "resview.exe", nowait , SW_SHOWNORMAL
    hWnd& = WFndWndWait ("Display Driver Resource Viewer", FW_PART, 5)
    if hWnd = 0 then   '---- iF DispTest vindow was not found try VT. If started in VT this what it would be
        ErrMsg$ = "ERROR: Resview window could not be found!"
        msgbox ErrMsg$, MB_OK + MB_ICONSTOP, "ERROR"
        end
    endif


'---- Open loging
loging "OPEN", "rt.log"

'----- Get screan resolution
'    getscreenres Xres, Yres
'----- Set screen file depending of resolution

'if Xres = 640 and Yres = 480 then
    'ScreenFileName = "dt64.scn"
'elseif Xres = 800 and Yres = 600 then
    'ScreenFileName = "dt86.scn"
'elseif Xres = 1024 and Yres = 768 then
 '   ScreenFileName = "dt17.scn"
''elseif Xres = 1280 and Yres = 1024 then
    'ScreenFileName = "dt17.scn"
'else
  'msgbox "Unsupported resolution" , MB_OK + MB_ICONSTOP, "ERROR"
  'end
'endif

'loging ScreenFileName,""

'----- Determin current temp screen file.
 its = 1
 do while TRUE
    TempScreenFileName = "temp" + ltrim$(str$(its)) + ".scn"
    if not exists(TempScreenFileName) = TRUE then
        exit do
    endif
    its = its + 1
 loop

 '---- If we are going to creat a scren file lets delete the old one
 if create_screen_file = TRUE then
    if exists(ScreenFileName) = TRUE then
        kill ScreenFileName
    endif
 endif


'---- Set window to Top Left most corner.
    WsetWndPos hWnd , 0 , 0

loging "Testing started: " + time$,""
i = test_screans(screens, togles)
loging "Testing finished: " + time$,""

'----- Close window
    DoKeysHwnd hWnd , "%( )"
    DoKeysHwnd hWnd , "c"

loging "CLOSE",""
end


'*********************************************************************
'
'   Function:    compwindowed(scnfile$ , scn$) as integer
'
'   Paramiter1   : screen file to use for comp
'   Paramiter2   : screen  to use for comp in screanfile given in paramiter1
'   Paramiter3   : Handle to window to comp
'   Returns      :0 if not compared or  the number of comp it took to make it pass
'   Globals used : NON
'   Description  :
'*********************************************************************
function   compwindowed(scnfile as string , scn$, hWnd&) as integer
dim pf as integer '----- Pass/Faile boolean
dim t as integer  '----- Try counter


'----- This flag is true if the /c command line paramiter was given
if  create_screen_file = true  then
    pf = ScnCaptureWindow(scnfile,scn,hWnd,FALSE)
endif
'-----
pf = 1   '----- Default to Faile

'------ We will try to compare the screan a maximum of 30 times.
'------ I am doing this is because of the courser or maybe it failed because it is still redrawing itself
for t = 1  to 30
    '----- Capture window to temp scn file
    pf = ScnCaptureWindow(TempScreenFileName,scn,hWnd,FALSE)
    '---- Comp the 2 files
    pf = ScnCompFiles(scnfile,scn,TempScreenFileName,scn, TRUE)

    '---- Are they the same
    if pf = 0 then
        compwindowed = t
        exit function
    end if
next t
compwindowed = 0  '----- We failed
end function

'*********************************************************************
'
'   Function:    test_screens
'
'   Paramiter1   : The number of screens to test. The apps has 57 as max
'   Paramiter2   : Number of ties to togle between mode for each screen
'   Returns      :void
'   Globals used : NON
'   Description  :
'*********************************************************************
function test_screans(number_of_screens as integer, number_of_togles_per_screan as integer)

dim bi,si as integer
bi = 0    '---- Will start at 0
si = 0    '---- Will start at 0

'---- print log file header
loging "--------------------------------------------------------------------------",""
loging "Starting resview test",""
loging "",""
loging "--------------------------------------------------------------------------",""


if  Bitmap = true then
  loging "Starting bitmap resources",""
  while(1) '----- Loop threw all the bitmaps
       DoKeysHwnd hWnd ,BitmapString(bi) '---- Display nex bitmap
       bi=bi+1          '----- Will now point to bitmap text
       si=0             '----- Set to first stretch value
       while(1) '---- Loop threw all the stretch values
            DoKeysHwnd hWnd ,StretchString(si) '---- Set to next stretch value
            si = si +1  '----- Will now point to next stretch test
            i =  compwindowed(ScreenFileName , BitmapString(bi)+"_" + ltrim$(str$(si)), hWnd)
            if i = 0 then
                '----- Bepp if screen comp failed
                beep
                loging "FAILED after comp:" + ltrim$(str$(i))+ " Bitmap test:" + BitmapString(bi)+" Stretch#" + ltrim$(str$(si)) + "  Time: " + time$,""
            else
                loging "PASSED after comp:" + ltrim$(str$(i))+ " Bitmap test:" + BitmapString(bi)+" Stretch#" + ltrim$(str$(si)) + "  Time: " + time$ ,""
            endif
            si = si +1  '----- Will now point to next stretch menu screen
            if StretchString(si) = "" then  '---- Is this the end
               exit while
            endif
       wend
       bi =bi + 1  '----- Will now point to screen menu string
       if BitmapString(bi) = "" then     '---- Is this the end
         exit while
       endif
  wend
endif

if Icon   = true then
  dim ii as integer
  ii = 0
  loging "Starting icon resources",""
  while(1) '----- Loop threw all the icons
       DoKeysHwnd hWnd ,IconString(ii) '---- Display next icon
       ii=ii+1          '----- Will now point to icon text
       si=0             '----- Set to first stretch value
       while(1) '---- Loop threw all the stretch values
            DoKeysHwnd hWnd ,StretchString(si) '---- Set to next stretch value
            si = si +1  '----- Will now point to next stretch test
            i =  compwindowed(ScreenFileName , IconString(ii)+"_" + ltrim$(str$(si)), hWnd)
            if i = 0 then
                '----- Bepp if screen comp failed
                beep
                loging "FAILED after comp:" + ltrim$(str$(i))+ " Icon test:" + IconString(ii)+" Stretch#" + ltrim$(str$(si)) ,""
            else
                loging "PASSED after comp:" + ltrim$(str$(i))+ " Icon test:" + IconString(ii)+" Stretch#" + ltrim$(str$(si)) ,""
            endif
            si = si +1  '----- Will now point to next stretch menu screen
            if StretchString(si) = "" then  '---- Is this the end
               exit while
            endif
       wend
       ii =ii + 1  '----- Will now point to screen menu string
       if IconString(ii) = "" then     '---- Is this the end
         exit while
       endif
  wend
endif

if Curser = TRUE then
    '----- Do cursser stuff
    ret = msgbox( "Do cursor tests manualy and then click  YES if they passed or NO if they did not pass", MB_YESNO + MB_ICONEXCLAMATION ,"Error Selecting Drive" )
    if ret = 6 then ' ---- yes button was selected
        loging "PASSED: Cursor tests." , ""
    else            '------ NO buttin was selected
        loging "FAILED: Cursor tests." , ""
    endif
endif



end function
'*********************************************************************
'
'   Function:   next_screen()
'
'   Paramiter1   :void
'   Returns      :void
'   Globals used : NON
'   Description  : Sets disptest to next video screen mode
'*********************************************************************
function next_screen()
    QueKeyDn "{ENTER}"
    QueKeyUp "{ENTER}"
    QueFlush 1
    sleep 5
end function

'*********************************************************************
'
'   Function:   help()
'
'   Paramiter1   : string foe header of help popup
'   Returns      :void
'   Globals used : NON
'   Description  : Displase usage of this script
'*********************************************************************
function help( s as string)
'----dispaly syntex of switches
dim s1$, s2$ , s3$ , s4$

s1 = "    /C:     Create screen file"
s2 = "    /B:     Do bitmap tests  "
s3 = "    /CU:    Do cursor tests "
s4 = "    /I:     Do icon tests"
msgbox "Switches for RT.pcd" + chr$(10) + s1 + chr$(10) + s2 + chr$(10)  + s3 + chr$(10) , MB_OK, s
end
end function


'*********************************************************************
'
'   Function:   read_ini(ini_file as string)
'
'   Paramiter1   : file_name   of ini file
'   Returns      :void
'   Globals used : NON
'   Description  :
'*********************************************************************
function read_ini(ini_file as string)  as string
dim infile, ret, i   as integer
infile = freefile
ret = exists( ini_file, "-d-v-h-s-r?a")
if ret <> -1 then
    msgbox "INI file doesn't exist" + ini_file , MB_OK + MB_ICONSTOP, "ERROR"
    end
endif

OPEN ini_file for input as #infile
line input #infile, read_ini
end function



'*********************************************************************
'
'   Function:  screenres(x as integer, y as integer)
'
'   Paramiter1   :a structure of lrect
'   Returns      :filles the structure passed in paramiter1 with current full screen corodinates.
'   Globals used : NON
'   Description  : retuns resolution of screen
'*********************************************************************
sub getscreenres(x as integer, y as integer)
dim MyDC as integer
    MyDC% = GetDC(0)

    x =  GetDeviceCaps(MyDC%, HORZRES)
    y =  GetDeviceCaps(MyDC%, VERTRES)
end sub