<!-- DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN" -->
<HTML>
<HEAD><TITLE>Implementation Guide</TITLE>
<SCRIPT LANGUAGE="JavaScript"> var sRelPath = '../' </SCRIPT>

<META NAME="KEYWORDS" CONTENT="DirectX Transform Implementation Guide">
<META NAME="PRODUCT" CONTENT="DirectX Transform Implementation Guide">
<META NAME="CATEGORY" CONTENT="Technical documentation; download">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; CHARSET=iso8859-1">
<META NAME="MS.LOCALE" CONTENT="EN-US">
<META NAME="ROBOTS" CONTENT="all">

<!-- SNIFF_START -->
<SCRIPT LANGUAGE="JAVASCRIPT">
//<!--
var g_isIE = false, g_isNav = false, g_iMaj = 0, g_sPlat = "";
// -->
</SCRIPT>
<SCRIPT SRC="../ver.js"></SCRIPT>
<SCRIPT SRC="../gloss.js"></SCRIPT>
<!-- SNIFF_END -->

<SCRIPT DEFER SRC="../common.js"></SCRIPT>
<SCRIPT DEFER>
//<!--
function InitPage()
{
	if (g_isIE && g_iMaj >= 4)	
	{

		SetTOC();
	}
}
//-->
</SCRIPT>

<!-- STYLE_START -->
<SCRIPT LANGUAGE="JAVASCRIPT">
//<!--
   var sVR = '../'	// Set root for the style sheet
   var sCSS = '<LINK REL="stylesheet" HREF="' + sVR;

   if(g_isIE)
   {
	   if (g_iMaj >= 4) // For MSIE 4.0 or later
	   {
		   sCSS += 'dxm_basicSDKIE4';
		   if (g_sPlat == "Win") // Windows only for now
		   {
			   document.createStyleSheet(sVR + 'dxm_advSDKIE4.css');
		   }
	   }
	   else // For MSIE 3.0 or earlier
	   {
		   sCSS += 'dxm_basicSDKIE3';
	   }
   }
   else if (g_isNav) // For all Nav versions
   {
	   sCSS += 'dxm_basicSDKNAV';
   }
   else
   {
	   sCSS += 'dxm_basicSDKIE3'; // default to IE3 sheet
   }

   sCSS += (sCSS == '' ? '' : '.css" TYPE="text/css">');

   document.write(sCSS);
//-->
</SCRIPT>
<!-- STYLE_END -->

</HEAD>
<BODY onload="InitPage(); if (g_isIE && g_iMaj >= 4){HdgrphControl()}" BGCOLOR="#FFFFFF">
<A NAME="pagetop"></A><A NAME="implementation_guide"></A>
<!--TOOLBAR_START-->
<!--TOOLBAR_EXEMPT-->
<!--TOOLBAR_END-->

<!-- HEADGRAPH_START -->
<TABLE CLASS="main" BORDER=0 CELLSPACING="0" CELLPADDING="0" WIDTH="*">
<TR>
<TD ROWSPAN="3" VALIGN="TOP" WIDTH="*">
<IMG SRC="../art/header1.gif" WIDTH="107" HEIGHT="110" BORDER=0 ALT="DirectX Transform Animated Header -- Microsoft DirectX Transform SDK"></TD>
<TD ROWSPAN="2" VALIGN="TOP" WIDTH="217"><IMG SRC="../art/hdrdtrns.gif" WIDTH="217" HEIGHT="110" BORDER=0 ALT="Microsoft DirectX Transform SDK"></TD>
<TD VALIGN="TOP" WIDTH="383">
<IMG SRC="../art/header3.gif" WIDTH="383" HEIGHT="95" BORDER=0 ALT="DirectX Transform Animated Header">
</TD>
<TD VALIGN="TOP" WIDTH="100%">
<IMG SRC="../art/spacer1.gif" WIDTH="100%" HEIGHT="94" BORDER=0 ALT="Microsoft DirectX Transform SDK">
</TD>
</TR>
<!-- HEADGRAPH_END -->
<!-- NAV_LINKS_START -->
<TR><TD VALIGN="TOP"><PRE><IMG ID="TOC_" SRC="../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><A STYLE="color:black;font-weight:bold" ID="TOC" HREF="../contents.htm">Contents</A>  <IMG SRC="../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><A STYLE="color:black;font-weight:bold" HREF="../index.htm">Index</A>  <IMG SRC="../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><A STYLE="color:black;font-weight:bold" HREF="writingtransforms.htm">Topic Contents</A>
</PRE></TD></TR>

<TR><TD COLSPAN="2" VALIGN="TOP"><PRE><IMG SRC="../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><B>Previous Topic:</B> <A STYLE="color:black" HREF="DXTAuthorGuide.htm">Author's Guide to Transforms</A>
<IMG SRC="../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><B>Next Topic:</B> <A STYLE="color:black" HREF="baseclass_basics.htm">How to Use the CDXBaseNTo1 Base Class</A>
</PRE></TD></TR></TABLE>

<!-- NAV_LINKS_END -->

<BLOCKQUOTE class="body">
<!-- CONTENTS_START -->

<H1>Implementation Guide</H1>

<P>This section steps you through building an image or mesh transform dynamic-link library (DLL) using Microsoft&reg; Visual C++&reg; and the Microsoft DirectX&reg; Transform interfaces.

<oL>
<LI>Create a new Microsoft Active Template Library (ATL) project from Visual C++ by opening the <B>File</B> menu and choosing the <B>New</B> command. Select the <B>Projects</B> tab, and then &quot;ATL COM AppWizard&quot;.
<LI>Enter the new project name and choose <B>OK</B>.
<LI>Set the server type to &quot;Dynamic Link Library&quot; and choose <B>Finish</B>.
<LI>Open Stdafx.h and insert the following immediately after the include statement for Atlcom.h.
<PRE>
#include &lt;Dxtrans.h&gt;
#include &lt;Dtbase.h&gt;
#include &lt;Dxatlpb.h&gt;
</PRE>

<LI>Open Stdafx.cpp and insert the following include statements as the last lines of the file immediately after the include of Atlimpl.cpp.

<PRE>
#include &lt;Dtbase.cpp&gt;
#include &lt;Dxtguid.c&gt;
#include &lt;Atlctl.cpp&gt;
</PRE>

<LI>Open the project's .idl file and add the following line after the import of Ocidl.idl.
<PRE>import &quot;Dxtrans.idl&quot;;
</PRE>

<LI>Build the project. If the compiler cannot find one or more of the files, you have not yet added the Microsoft DirectX Transform file directory to your path. You can do one of the following:

<uL>
<LI>To change your global settings to always use the DirectX Transform directory, open the <B>Tools</B> menu, and choose the <B>Options</B> command. Select the <B>Directories</B> tab, and add the DirectX Transform SDK <b>include</b> and <b>lib</b> directories to the corresponding categories, respectively. Make sure each is the first entry in its list.

<LI>To set the DirectX Transform directory for only this project, select <B>Project</B>, then <B>Settings</B> from the main menu bar. In the <B>Settings For</B> drop-down list box, select &quot;All Configurations&quot;. Select the <B>C/C++</B> tab, select &quot;Category of Preprocessor&quot;, add the directory to the <B>Additional Include Directories</B> control, and choose <B>OK</B>.  
</uL>

<LI>Add a new ATL object to the project after you have confirmed that the project builds and links. 
<uL>
<li>Select <B>Insert</B>, then <B>New ATL Object</B>.
<li>Select &quot;Simple Object&quot; and choose <B>Next</B>.
<li>Name the object (named &quot;MyEffect&quot; in the following example).
<li>Select the <B>Attributes</B> tab.
<LI>Change the threading model to &quot;both&quot;.
<LI>Check &quot;Free Threaded Marshaler&quot;.
<LI>Set &quot;Aggregation&quot; to &quot;Yes&quot;.
<LI>Set &quot;Interface&quot; to &quot;Dual&quot;.
<LI>Choose <B>OK</B>.
</uL>


<LI>Find the definition of your class's interface in the .idl file and change the inheritance from <B>IDispatch</B> to <A HREF="../reference/Ifaces/idxeffect.htm">IDXEffect</A>.

<LI>If your transform will use custom properties, you will need to add a property page to the project. 
<uL>
<li>Select <B>Insert</B>, then <B>New ATL Object</B>.
<li>On the dialog box that appears, select &quot;Controls&quot; in the left window, select &quot;Property Page&quot; in the right window, and choose <B>Next</B>.
<li>Name the object (usually &quot;MyEffectPP&quot;).
<li>Select the <B>Attributes</B> tab.
<LI>Change the threading model to &quot;both&quot;.
<LI>Check the &quot;Free Threaded Marshaler&quot;.
<LI>Set &quot;Aggregation&quot; to &quot;Yes&quot;.
<LI>Set &quot;Interface&quot; to &quot;Dual&quot;.
<LI>Choose <B>OK</B>.
</uL>

<LI>Open the &quot;MyEffect.h&quot; file and make the following changes.
<uL>
<LI>Make your class inherit from the base class by replacing the following:
<PRE>
public CComObjectRootEx&lt;CComMultiThreadModel&gt;,
</PRE>
<P>with the line:
<PRE>public CDXBaseNTo1,</PRE>

<LI>Inherit from the following additional items.
<PRE>
public CComPropertySupport&lt;CMyEffect&gt;,
public IObjectSafetyImpl2&lt;CMyEffect&gt;,
public IPersistStorageImpl&lt;CMyEffect&gt;,
public ISpecifyPropertyPagesImpl&lt;CMyEffect&gt;,
public IPersistPropertyBagImpl&lt;CMyEffect&gt;
</PRE>

<LI>Add the following lines of code immediately before END_COM_MAP in the COM_MAP.
<PRE>
COM_INTERFACE_ENTRY(IDXEffect)
COM_INTERFACE_ENTRY_IID(IID_IObjectSafety,
IObjectSafetyImpl2&lt;CMyEffect&gt;)
COM_INTERFACE_ENTRY_IMPL(IPersistStorage)
COM_INTERFACE_ENTRY_IMPL(ISpecifyPropertyPages)
COM_INTERFACE_ENTRY_IMPL(IPersistPropertyBag)
COM_INTERFACE_ENTRY_CHAIN(CDXBaseNTo1)
</PRE>

<LI>Change the registration entry from:

<pre>DECLARE_REGISTRY_RESOURCEID(IDR_MyEffect)</pre>

<P>to:

<PRE>DECLARE_REGISTER_DX_TRANSFORM(IDR_MyEffect,
CATID_propercategory)</PRE>

<P>For a three-dimensional (3-D) transform, the category ID would be CATID_DX3DTransform. For a two-dimensional (2-D) transform, the category ID would be CATID_DXImageTransform.

<LI>Declare the object as aggregatable by adding the following line.
<PRE>DECLARE_POLY_AGGREGATABLE(CMyEffect)</PRE>

<LI>Add the following in the class declaration.
<PRE>DECLARE_IDXEFFECT_METHODS(Caps)</PRE>

<p><i>Caps</i> specifies the value you want to have your transform return from the <a href="../reference/ifaces/idxeffect.htm#get_Capabilities">IDXEffect::get_Capabilities</a> method. This can be a combination of the flags in the <a href="../reference/enums/dxeffecttype_enum.htm">DXEFFECTTYPE</a> enumeration, or zero. In the case of the sample, it is not a morph (DXTET_MORPH, two input transforms), and it is not periodic (DXTET_PERIODIC, where the result at one is not the same as the result at zero), so the <i>Caps</i> value is zero.

<LI>Add a property map for the object by inserting the following within the class definition body.
<PRE>
BEGIN_PROPERTY_MAP( CMyEffect )
    PROP_ENTRY("Description", DISPID_MyProperty,
    CLSID_MyEffectPP )
    PROP_PAGE( CLSID_MyEffectPP )
END_PROPERTY_MAP()
</PRE>

<P>There must be a PROP_ENTRY for each custom property you want your transform to support. You can fill these items in later, when you have defined these properties for your transform. The <i>PropPageClsid</i> is located at the top of your MyEffectPP.h header file. If your transform has no custom properties, the property map should be omitted.
</ul>


<li>Add the core of the program. There are three main steps to add: Creation, Setup, and Execution.

<P><b>Creation</b>
<BLOCKQUOTE>
<P>In the body of the constructor for your object, you will need to set data members in the base class to configure your transform. The following table describes these data members.
<TABLE>
<TR><TD><B>m_ulMaxInputs</B></TD>
<TD>Maximum number of input objects allowed. Default value is 1.</TD>
</TR>
<TR><TD><B>m_ulNumInRequired</B></TD>
<TD>Number of input objects required. Default value is 1.</TD>
</TR>
<TR><TD><B>m_dwOptionFlags</B></TD>
<TD>Used to indicate the type of inputs and outputs for the transform. The default option assumes that <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_d.htm#gloss_dxsurface')">DXSurface</A> objects are used for both input and output. If your transform is using 3-D meshes for input, you should set the DXBOF_INPUTS_MESHBUILDER flag for this member. If your transform is using 3-D meshes for output, you should set the DXBOF_OUTPUT_MESHBUILDER flag for this member.</TD>
</TR>
<TR><TD><B>m_dwMiscFlags</B></TD>
<TD>A combination of flags that will tell users of any special features supported by your transform. These are listed in the <a href="../reference/enums/dxtmiscflags_enum.htm">DXTMISCFLAGS</a> enumeration. Supported options include:
<ul>
	<li>DXTMF_BLEND_SUPPORTED
	<li>DXTMF_DITHER_SUPPORTED
	<li>DXTMF_INPLACE_OPERATION
	<li>DXTMF_BOUNDS_SUPPORTED
	<li>DXTMF_PLACEMENT_SUPPORTED
	<li>DXTMF_QUALITY_SUPPORTED
</ul>
<P>If your transform supports none of these options, it should be set to 0.
</TD>
</TR>
</TABLE>

<P>For example, a 3-D transform constructor might look like this:
<PRE>
CMyEffect()
{
    m_dwOptionFlags =
    DXBOF_INPUTS_MESHBUILDER | DXBOF_OUTPUTS_MESHBUILDER
    m_dwMiscFlags = 0;
}
</PRE>
</BLOCKQUOTE>

<P><B>Setup</B>
<BLOCKQUOTE>
<P>Set up the transform by overriding the virtual method <B>OnSetup</B> in the file MyEffect.cpp.
 The sample transform's <B>OnSetup</B> code looks like the following:

<PRE>
HRESULT CMyEffect::OnSetup(DWORD dwFlags)
{
    return OutputMeshBuilder()-&gt;AddMeshBuilder(
    InputMeshBuilder(),0);
}
</PRE>

<P>In the previous example code, note that when <B>OnSetup</B> is called, the transform can access the <a href="../reference/cdxbasento1/cdxbasento1_helpers.htm#OutputMeshBuilder">OutputMeshBuilder</a> and <a href="../reference/cdxbasento1/cdxbasento1_helpers.htm#InputMeshBuilder">InputMeshBuilder</a> member functions. <B>OnSetup</B> will only be called for a nonempty call to the <A HREF="../reference/Ifaces/idxtransform.htm#setup">IDXTransform::Setup</A> method after all objects have been validated. In the case of a 3-D transform, the base class checks that the appropriate number of inputs are provided and that the input and output are mesh builder objects. During the <B>OnSetup</B> call, the transform should perform any one-time setup that does not need to happen every time <a href="../reference/cdxbasento1/cdxbasento1_virtuals.htm#OnExecute">OnExecute</a> is called.
</BLOCKQUOTE>

<P><B>Execution</B>
<BLOCKQUOTE>
<P>To implement the work procedure of a 3-D transform, you override the base class <B>OnExecute</B> method. Image transforms override the base class <B>WorkProc</B> method. When these methods are called, the base class has already ensured that the caller has not passed any unsupported parameters and also checked that the transform has been properly set up. See the sample code for the <a href="writing_2dtransforms.htm#CombiningTheImages">Wipe example</a>'s <B>WorkProc</B> method. The reason there are two methods is because images are automatically broken up into bands by the base class and executed in parallel on the available processors.
</BLOCKQUOTE>

<li>Add support code for the transform property page. 
  <ul>
	<li>For each private data member of your transform that represents a custom property, you need to implement <b>put_</b> and <b>get_</b> access functions. These are often declared in your MyEffect.h header file in the following manner.
<pre>
    STDMETHOD( get_MyProperty )( float *pVal );
    STDMETHOD( put_MyProperty )( float newVal );
</pre>

	<li>Add dispatch interface support for the MyEffect interface. Create an enumeration for the dispatcher identifiers, with each property an element of the enumeration. Place it just before the entry for MyEffect in the project's .idl file.
<pre>
typedef enum MyEffectDISPID
{
    DISPID_MyEffect_MyProperty1 = DISPID_DXE_NEXT_ID,
    DISPID_MyEffect_MyProperty2,
} MyEffectDISPID;
</pre>

<P>Add dispatcher methods to the MyEffect interface, as shown in the following code.
<pre>
interface MyEffect : IDXEffect
{
    [propget, id(DISPID_MyEffect_MyProperty1), helpstring(
    "property MyProperty1")] HRESULT MyProperty1
    ([out, retval] float *pVal);
    [propput, id(DISPID_MyEffect_MyProperty1), helpstring(
    "property MyProperty1")] HRESULT MyProperty1
    ([in] float newVal);
    [propget, id(DISPID_MyEffect_MyProperty2), helpstring(
    "property MyProperty2")] HRESULT MyProperty2
    ([out, retval] float *pVal);
    [propput, id(DISPID_MyEffect_MyProperty2), helpstring(
    "property MyProperty2")] HRESULT MyProperty2
    ([in] float newVal);
};
</pre>

<P>You should then fill out the PROPERY_MAP in the MyEffect.h file.

	<li>Inside the resource file for the project, there should be a dialog box entry for your property page. You need to edit this to reflect the custom properties that people can change on your transform.
	<li>In the MyEffectPP.cpp file, override the <b>OnInitDialog</b> method. It should use the <b>get_MyProperty</b> method for each property to set the initial values of the dialog box.
	<li>In the MyEffectPP.cpp file, override the <b>Apply</b> method. It should read each of the values from the dialog box and use the <b>put_MyProperty</b> method to set the values in the transform.
  </ul>
  
<li>Implement surface picking. For image transforms with more than one input, you need to override the <a href="../reference/cdxbasento1/cdxbasento1_virtuals.htm#OnGetSurfacePickOrder">CDXBaseNTo1::OnGetSurfacePickOrder</a> function with a function that chooses one of the input surfaces based on a selected point on the output surface. In special cases, you might need to override the <a href="../reference/cdxbasento1/cdxbasento1_virtuals.htm#OnSurfacePick">CDXBaseNTo1::OnSurfacePick</a> method.
<p>If your output is a 3-D mesh, you need to use tools in Direct3D Retained Mode to implement mesh picking. For more information, see <a href="dxtauthorguide.htm#meshpick">Author's Guide to Transforms</a>.
</ol>

<P>You can use the DXETool.exe application to test and debug your transform. It is included with the SDK in the DXMedia\bin\ directory. For more information, see <a href="dxetool_writers.htm">DXETool for Writers</a>.

<!-- CONTENTS_END -->
<!-- START_PAGE_FOOTER -->


<H6><HR size=1></H6>
<P><A CLASS="line" HREF="#pagetop"><IMG src="../art/arrowup1.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="Top of Page">&nbsp;Top of Page</A>
<BR><A CLASS="line" HREF="../../cpyright.htm">&#169; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A>
<!-- END_PAGE_FOOTER -->
</BLOCKQUOTE>
<!-- START POP-UP GLOSSARY -->
<SCRIPT LANGUAGE="JAVASCRIPT">if((g_isIE == true) && (g_iMaj > 3)) {window.self.document.writeln('<SCR' + 'IPT SRC="../tip2.js"></SCR' + 'IPT><IFRAME ID="G_L_S" NAME="SecretBuffer" STYLE="display: none" SRC=""></IFRAME>')}</SCRIPT>
<!-- END POP-UP GLOSSARY -->

<!-- DACONTROL_START -->
	<DIV ID="HeadGraphAnim"></DIV>
	<SCRIPT LANGUAGE="JAVASCRIPT">if((g_isIE == true) && (g_iMaj > 3)) {window.self.document.writeln('<SCR' + 'IPT SRC="../anim.js"></SCR' + 'IPT>')}</SCRIPT>
<!-- DACONTROL_END -->
</BODY></HTML>
