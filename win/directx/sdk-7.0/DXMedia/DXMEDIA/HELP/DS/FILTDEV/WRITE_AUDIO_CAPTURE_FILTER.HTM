<!-- DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN" -->

<HTML>
<HEAD><TITLE>Write an Audio Capture Filter</TITLE>
<SCRIPT> var sRelPath = '../' </SCRIPT>


<META NAME="Description" CONTENT="Write an Audio Capture Filter">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; CHARSET=iso8859-1">
<META NAME="MS.LOCALE" CONTENT="EN-US">
<META NAME="ROBOTS" CONTENT="all">

<!-- SNIFF_START -->

<SCRIPT>
//<!--
var g_isIE = false, g_isNav = false, g_iMaj = 0, g_sPlat = "";
// -->

</SCRIPT>
<SCRIPT SRC="../ver.js"></SCRIPT>
<SCRIPT SRC="../gloss.js"></SCRIPT>

<!-- SNIFF_END -->


<SCRIPT DEFER SRC="../common.js"></SCRIPT>
<SCRIPT DEFER>
//<!--
function InitPage()
{
	if (g_isIE && g_iMaj >= 4)	
	{

		SetTOC();
	}
}
//-->

</SCRIPT>

<!-- SNIFF_END -->


<!-- STYLE_START -->

<SCRIPT>
//<!--
   var sVR = '../'	// Set root for the style sheet
   var sCSS = '<LINK REL="stylesheet" HREF="' + sVR;

   if(g_isIE)
   {
	   if (g_iMaj >= 4) // For MSIE 4.0 or later
	   {
		   sCSS += 'dxm_basicsdkIE4';
		   if (g_sPlat == "Win") // Windows only for now
		   {
			   document.createStyleSheet(sVR + 'dxm_advSDKIE4.css');
		   }
	   }
	   else // For MSIE 3.0 or earlier
	   {
		   sCSS += 'dxm_basicsdkIE3';
	   }
   }
   else if (g_isNav) // For all Nav versions
   {
	   sCSS += 'dxm_basicsdkNAV';
   }
   else
   {
	   sCSS += 'dxm_basicsdkIE3'; // default to IE3 sheet
   }

   sCSS += (sCSS == '' ? '' : '.css" TYPE="text/css">');

   document.write(sCSS);
//-->

</SCRIPT>
<!-- STYLE_END -->


</HEAD>
<BODY onload="InitPage(); if (g_isIE && g_iMaj >= 4){HdgrphControl()}" BGCOLOR="#FFFFFF">
<A NAME="pagetop"></A><A NAME="audcap"></A>

<!-- HEADGRAPH_START -->

<TABLE CLASS="main" BORDER=0 CELLSPACING="0" CELLPADDING="0" WIDTH="*">
<TR>
<TD ROWSPAN="3" VALIGN="TOP" WIDTH="*">
<IMG SRC="../art/header1.gif" WIDTH="107" HEIGHT="110" BORDER=0 ALT="DirectShow Animated Header -- Write an Audio Capture Filter"></TD>
<TD ROWSPAN="2" VALIGN="TOP" WIDTH="217"><IMG SRC="../art/hdrdshow.gif" WIDTH="217" HEIGHT="110" BORDER=0 ALT="DirectShow Animated Header -- Write an Audio Capture Filter"></TD>
<TD VALIGN="TOP" WIDTH="383">
<IMG SRC="../art/header3.gif" WIDTH="383" HEIGHT="95" BORDER=0 ALT="DirectShow Animated Header">
</TD>
<TD VALIGN="TOP" WIDTH="100%">
<IMG SRC="../art/spacer1.gif" WIDTH="100%" HEIGHT="94" BORDER=0 ALT="Microsoft DirectShow SDK">
</TD>
</TR>
<!-- HEADGRAPH_END -->

<!-- NAV_LINKS_START -->

<TR><TD VALIGN="TOP"><PRE><IMG ID="TOC_" SRC="../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><A STYLE="color:black;font-weight:bold" ID="TOC" HREF="../contents.htm">Contents</A>  <IMG SRC="../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><A STYLE="color:black;font-weight:bold" HREF="../index.htm">Index</A>  <IMG SRC="../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><A STYLE="color:black;font-weight:bold" HREF="How_to_FiltDev.htm">Topic Contents</A>
</PRE></TD></TR>
<TR><TD COLSPAN="2" VALIGN="TOP"><PRE><IMG SRC="../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><B>Previous Topic:</B> <A STYLE="color:black" HREF="Write_Video_Capture_Filter.htm">Write a Video Capture Filter</A>
<IMG SRC="../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><B>Next Topic:</B> <A  STYLE="color:black" HREF="Write_Transform_Filter_C_C++.htm">Write a Transform Filter in C/C++</A>
</PRE></TD></TR></TABLE>
<!-- NAV_LINKS_END -->


<BLOCKQUOTE CLASS="body">


<!-- CONTENTS_START -->

<H1>Write an Audio Capture Filter</H1>

<P>This article outlines important points to consider when writing an audio capture <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_f.htm#filter')">filter</A>. The Microsoft&#174; DirectShow&#153; SDK includes a standard <A HREF="../filtsamp/Audio_Capture.htm#Audio_Capture">Audio Capture</A> filter. 

<P>This article contains the following topics:
<UL><LI><A HREF="Write_Audio_Capture_Filter.htm#audcap_1">Audio Capture Pin Requirements</A>
<LI><A HREF="Write_Audio_Capture_Filter.htm#audcap_2">Registering an Audio Capture Filter</A>
<LI><A HREF="Write_Audio_Capture_Filter.htm#audcap_3">Producing Data</A>
<LI><A HREF="Write_Audio_Capture_Filter.htm#audcap_4">Controlling Individual Streams</A>
<LI><A HREF="Write_Audio_Capture_Filter.htm#audcap_5">Time Stamping</A>
<LI><A HREF="Write_Audio_Capture_Filter.htm#audcap_6">Necessary Interfaces</A>
</UL>
<h2><A NAME="audcap_1"></A>Audio Capture Pin Requirements</h2>
<P>The capture filter's capture <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_P.htm#pin')">pin</A> and preview pin (if there is one) must support the <A HREF="../ref/iface/IKsPropertySet.htm#IKsPropertySet">IKsPropertySet</A> interface. See <A HREF="Write_Video_Capture_Filter.htm#caprules_1">Capture and Preview Pin Requirements</A> for more details and sample code for implementing <B>IKsPropertySet</B> on your capture pin.

<P>You must have one <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_I.htm#input_pin')">input pin</A> for every sound source the capture card can mix before it digitizes the audio. For instance, if your sound card has a line in, microphone in, and CD-ROM input, you would have three input pins. You don't typically connect these input pins to any other filters - you just support the <A HREF="../ref/iface/IAMAudioInputMixer.htm#IAMAudioInputMixer">IAMAudioInputMixer</A> interface on each pin and an application will set recording levels, balance, treble, and so on, on each pin using that interface.

<h2><A NAME="audcap_2"></A>Registering an Audio Capture Filter</h2>
<P>You must register your filter in the audio capture filter category. See the <A HREF="../ref/utilfunct/DLL_Setup_functs.htm#AMovieDllRegisterServer2">AMovieDllRegisterServer2</A> function for more information. 



<h2><A NAME="audcap_3"></A>Producing Data</h2>
<P>Produce data on the capture pin only when the <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_F.htm#filter_graph')">filter graph</A> is in a running state. Do not send data from your pins when the filter graph is paused. This will confuse the filter graph unless you return <A HREF="../ref/Error_Success_Codes.htm#VFW_S_CANT_CUE">VFW_S_CANT_CUE</A> from the <A HREF="../ref/class/CBaseFilter.htm#GetState">CBaseFilter::GetState</A> function, which warns the filter graph that you do not send data when paused. The following code sample shows how to do this.

<PRE>
CMyVidcapFilter::GetState(DWORD dw, FILTER_STATE *State)
{
&#009;*State = m_State;
&#009;if (m_State == State_Paused)
&#009;&#009;return VFW_S_CANT_CUE;
&#009;else
&#009;&#009;return S_OK;
}
</PRE>
<h2><A NAME="audcap_4"></A>Controlling Individual Streams</h2>
<P>All <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_O.htm#output_pin')">output pins</A> should support the <A HREF="../ref/iface/IAMStreamControl.htm#IAMStreamControl">IAMStreamControl</A> interface, so an application can turn each pin on or off individually (for instance, to preview without capturing). <B>IAMStreamControl</B> enables you to switch between preview and capture without rebuilding a different graph. See the source code for the <A HREF="../filtsamp/Source_Filters.htm#VidCap">VidCap Sample (Video Capture Filter)</A> sample for details.

<h2><A NAME="audcap_5"></A>Time Stamping</h2>
<P>When you send captured audio samples, the starting <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_T.htm#time_stamp')">time stamp</A> for each group equals the start time of the graph's clock when the first sample in the packet was captured. The ending time stamp equals the start time plus the duration that the audio packet represents. If your audio capture filter is not providing the clock, the time stamps won't match up exactly (where the end of one package is the same as the beginning time stamp of the next package), but that's okay. See <A HREF="Write_Video_Capture_Filter.htm">Write a Video Capture Filter</A> and the source code for the <A HREF="../filtsamp/Source_Filters.htm#VidCap">VidCap Sample (Video Capture Filter)</A> sample for time stamping examples.

<P>You should also set the <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_M.htm#media_time')">media time</A>
 of the sample you deliver, as well as the regular time stamp. The media time is the sample number in the packet. So if you are sending one-second packets of 44.1 kilohertz (kHz) audio, you would set media time values of (0, 44100) (44100, 88200), and so on. This enables the <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_D.htm#downstream_filter')">downstream filters</A> to know if any audio samples were dropped, even when the regular time stamps are a little random because the clock being used is not the audio digitizing clock.

<P>One other thing: If the filter graph is in a running state, and then paused, and then run again, you must not produce a sample with a time stamp less than the last one you produced before pausing. Time stamps can never go back in time, not even back to before a pause occurred.

<h2><A NAME="audcap_6"></A>Necessary Interfaces</h2>
<P>Read about the following interfaces and consider implementing them. You should implement these interfaces to provide functionality that applications might rely on, so these interfaces are strongly recommended.

<UL><LI>Implement <A HREF="../ref/iface/IAMDroppedFrames.htm#IAMDroppedFrames">IAMDroppedFrames</A> on your filter or on each output pin that sends data.
<LI>Implement <A HREF="../ref/iface/IAMStreamConfig.htm#IAMStreamConfig">IAMStreamConfig</A> on each output pin that sends data.
<LI>Implement <A HREF="../ref/iface/IAMStreamControl.htm#IAMStreamControl">IAMStreamControl</A> on each output pin that sends data.
<LI>Implement <A HREF="../ref/iface/IAMAudioInputMixer.htm#IAMAudioInputMixer">IAMAudioInputMixer</A> on your filter and on each input pin.
</UL>

<!-- CONTENTS_END -->

<!-- START_PAGE_FOOTER -->


<H6><HR size=1></H6>
<P><A Class="line" HREF="#pagetop"><IMG src="../art/arrowup1.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="Top of Page">&nbsp;Top of Page</A>
<BR><A HREF="../../cpyright.htm">&#169; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A>
<!-- END_PAGE_FOOTER -->

</BLOCKQUOTE>

<SCRIPT>if((g_isIE == true) && (g_iMaj > 3)) {window.self.document.writeln('<SCR' + 'IPT SRC="../tip2.js"></SCR' + 'IPT><IFRAME ID="G_L_S" NAME="SecretBuffer" STYLE="display: none" SRC=""></IFRAME>')}</SCRIPT>

<!-- DACONTROL_START -->

	<DIV ID="HeadGraphAnim"></DIV>
	<SCRIPT>if((g_isIE == true) && (g_iMaj > 3)) {window.self.document.writeln('<SCR' + 'IPT SRC="../anim.js"></SCR' + 'IPT>')}</SCRIPT>
<!-- DACONTROL_END -->

</BODY>
</HTML>
