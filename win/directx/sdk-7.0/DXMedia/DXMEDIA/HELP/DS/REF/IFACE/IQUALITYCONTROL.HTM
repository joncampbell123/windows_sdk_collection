<!-- DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN" -->

<HTML>
<HEAD><TITLE>IQualityControl Interface</TITLE>
<SCRIPT> var sRelPath = '../../' </SCRIPT>


<META NAME="Description" CONTENT="IQualityControl Interface">
<META NAME="Description" CONTENT="IQualityControl::Notify">
<META NAME="Description" CONTENT="IQualityControl::SetSink">
<META NAME="Description" CONTENT="Notify (IQualityControl)">
<META NAME="Description" CONTENT="SetSink (IQualityControl)">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; CHARSET=iso8859-1">
<META NAME="MS.LOCALE" CONTENT="EN-US">
<META NAME="ROBOTS" CONTENT="all">

<!-- SNIFF_START -->

<SCRIPT>
//<!--
var g_isIE = false, g_isNav = false, g_iMaj = 0, g_sPlat = "";
// -->

</SCRIPT>
<SCRIPT SRC="../../ver.js"></SCRIPT>
<SCRIPT SRC="../../gloss.js"></SCRIPT>

<!-- SNIFF_END -->


<SCRIPT DEFER SRC="../../common.js"></SCRIPT>
<SCRIPT DEFER>
//<!--
function InitPage()
{
	if (g_isIE && g_iMaj >= 4)	
	{

		SetTOC();
	}
}
//-->

</SCRIPT>

<!-- SNIFF_END -->


<!-- STYLE_START -->

<SCRIPT>
//<!--
   var sVR = '../../'	// Set root for the style sheet
   var sCSS = '<LINK REL="stylesheet" HREF="' + sVR;

   if(g_isIE)
   {
	   if (g_iMaj >= 4) // For MSIE 4.0 or later
	   {
		   sCSS += 'dxm_basicsdkIE4';
		   if (g_sPlat == "Win") // Windows only for now
		   {
			   document.createStyleSheet(sVR + 'dxm_advSDKIE4.css');
		   }
	   }
	   else // For MSIE 3.0 or earlier
	   {
		   sCSS += 'dxm_basicsdkIE3';
	   }
   }
   else if (g_isNav) // For all Nav versions
   {
	   sCSS += 'dxm_basicsdkNAV';
   }
   else
   {
	   sCSS += 'dxm_basicsdkIE3'; // default to IE3 sheet
   }

   sCSS += (sCSS == '' ? '' : '.css" TYPE="text/css">');

   document.write(sCSS);
//-->

</SCRIPT>
<!-- STYLE_END -->


</HEAD>
<BODY onload="InitPage(); if (g_isIE && g_iMaj >= 4){HdgrphControl()}" BGCOLOR="#FFFFFF">
<A NAME="pagetop"></A><A NAME="IQualityControl"></A>

<!-- HEADGRAPH_START -->

<TABLE CLASS="main" BORDER=0 CELLSPACING="0" CELLPADDING="0" WIDTH="*">
<TR>
<TD ROWSPAN="3" VALIGN="TOP" WIDTH="*">
<IMG SRC="../../art/header1.gif" WIDTH="107" HEIGHT="110" BORDER=0 ALT="DirectShow Animated Header"></TD>
<TD ROWSPAN="2" VALIGN="TOP" WIDTH="217"><IMG SRC="../../art/hdrdshow.gif" WIDTH="217" HEIGHT="110" BORDER=0 ALT="DirectShow Animated Header"></TD>
<TD VALIGN="TOP" WIDTH="383">
<IMG SRC="../../art/header3.gif" WIDTH="383" HEIGHT="95" BORDER=0 ALT="DirectShow Animated Header">
</TD>
<TD VALIGN="TOP" WIDTH="100%">
<IMG SRC="../../art/spacer1.gif" WIDTH="100%" HEIGHT="94" BORDER=0 ALT="Microsoft DirectShow SDK">
</TD>
</TR>
<!-- HEADGRAPH_END -->

<!-- NAV_LINKS_START -->

<TR><TD VALIGN="TOP"><PRE><IMG ID="TOC_" SRC="../../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><A STYLE="color:black;font-weight:bold" ID="TOC" HREF="../../contents.htm">Contents</A>  <IMG SRC="../../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><A STYLE="color:black;font-weight:bold" HREF="../../index.htm">Index</A>  <IMG SRC="../../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><A STYLE="color:black;font-weight:bold" HREF="ifaces_intro.htm">Topic Contents</A>
</PRE></TD></TR>
<TR><TD COLSPAN="2" VALIGN="TOP"><PRE><IMG SRC="../../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><B>Previous Topic:</B> <A STYLE="color:black" HREF="IPinInfo.htm">IPinInfo Interface</A>
<IMG SRC="../../art/yelbtn.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="*"><B>Next Topic:</B> <A  STYLE="color:black" HREF="IQualProp.htm">IQualProp Interface</A>
</PRE></TD></TR></TABLE>
<!-- NAV_LINKS_END -->


<BLOCKQUOTE CLASS="body">


<!-- CONTENTS_START -->

<H1>IQualityControl Interface</H1>

<P>The <B>IQualityControl</B> interface defines quality messages and allows a quality manager
to install itself as the sink for these messages. The following structures are defined for quality management.

<UL><LI><A HREF="../dtypes.htm#QualityMessageType">QualityMessageType</A>
<LI><A HREF="../structs.htm#Quality">Quality</A>
</UL>
<P>The <A HREF="IQualityControl.htm#Notify">IQualityControl::Notify</A> <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_M.htm#method')">method</A> receives a Quality message.
A <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_f.htm#filter')">filter</A> may call <B>IQualityControl::Notify</B> to send a Quality message to another filter
to ask for help in managing the graph quality (typically to achieve graceful degradation on a
processor that is not powerful enough to handle all the data). Quality messages usually flow
upstream.



<P>The <A HREF="IQualityControl.htm#SetSink">IQualityControl::SetSink</A> method tells a filter where to send it.
If no sink has been explicitly set or if the last <A HREF="IQualityControl.htm#SetSink">SetSink</A> set the sink to NULL,
the message should go upstream. The filter sends a message upstream by calling
<A HREF="IUnknown.htm#QueryInterface">QueryInterface</A> on the <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_O.htm#output_pin')">output pin</A> to which its <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_I.htm#input_pin')">input pin</A> is connected, in order to
retrieve an <B>IQualityControl</B> interface. Filters export the <B>IQualityControl</B>
interface through their pins.

<P>Messages start with rendering filters, because these must run in real time. Other filters
must run to keep the <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_R.htm#renderer')">renderers</A> supplied; these do not originate messages, but
they can pass them on.

<P>If a filter receives a quality message, it returns S_OK if it agrees to act
on the quality message to handle the situation, or S_FALSE if it cannot handle it.
For example, if the video renderer receives S_FALSE (or failure codes), it will readily
drop frames to try to maintain synchronization. If it receives S_OK, it will trust the
<A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_U.htm#upstream_filter')">upstream filter</A>; it also will allow frames to be played much earlier than their due time and
will allow frames to be played much later without dropping them. Usually, the video renderer
causes early frames to be blocked until their due time. But if this is the first frame after
a dropped frame, the video renderer will play the frame as soon as possible so as not to lose time.

<P>A reasonable implementation for a filter that cannot handle a message
is to pass the message upstream and to pass on the result. For example:

<PRE>HRESULT Notify(IBaseFilter * pSelf, QualityMessage qm)
{
    if (m_QualitySink!=NULL)
        // Note how pSelf has changed into pMyself
        return m_QualitySink-&gt;ChangeQuality(pMyself, qm);
    else
        return  m_Upstream-&gt;Notify(pMyself, qm);
}
</PRE>

<P>A quality managing component would typically set the sink for all filters to itself.
It can identify filters by their <A HREF="IBaseFilter.htm">IBaseFilter</A> interface pointers in the <I>Self</I> parameters.
A filter must always supply the same value for its <B>IBaseFilter</B> interface. (The official
COM way of determining if two filters are the same is to use
<A HREF="IUnknown.htm#QueryInterface">QueryInterface</A> on them both for their <A HREF="IUnknown.htm">IUnknown</A> interfaces and
compare those. However, because Microsoft&reg; DirectShow&#153; is a real-time system, and because
these calls are made during streaming, it is implemented this way for efficiency.)

<P>A quality managing component (for example, an application)
typically returns S_OK when called upon to help. However, it should be prepared to
find that when it sends a message to a filter requesting help from that filter, it immediately gets
a request from that filter for help, and that whatever return code it gives to that filter in response to
the request immediately comes back from the filter as the reply to its original message.
This happens if the filter uses the suggested default implementation of passing
the messages upstream, but with the <A HREF="../structs.htm#Quality">Quality</A> managing component intercepting all the traffic.

<P> The <A HREF="../structs.htm#Quality">Quality</A> message structure is:

<PRE>typedef enum {
    Famine,
    Flood
} QualityMessageType;

typedef struct {
    QualityMessageType Type;
    long               Proportion;
    REFERENCE_TIME     Late;
} Quality;
</PRE>

<P>The <A HREF="../structs.htm#Type_member">Type</A> member of the structure indicates which filter appears to have the
problem. If set to Famine, it indicates that the renderer is not getting enough samples and the receiver of the message should speed up by any means possible. If set to Flood, the sender of the message cannot keep up with the data being sent and the receiver must send less data. Other methods of degradation are not appropriate.

<P>The <A HREF="../structs.htm#Proportion">Proportion</A> member gives a rate (expressed in parts per thousand) to be
used by a recipient that cannot seek (dropping frames is equivalent to seeking) but
can only control its rate. For example, a proportion of 823 means that it should
degrade enough to go faster by a factor of 1000/823. Likewise, a proportion of
1200 means that it can improve its quality by 20 percent, even if this results in going slower.
The numbers are not cumulative. In particular, if a filter can degrade only in steps of,
say, 20 percent, and if it receives a series of <A HREF="../structs.htm#Quality">Quality</A> messages all with <B>Proportion</B> equal to
990, it should ignore them all. It should not multiply them (for example, it should not deduce that a
20 percent reduction is called for after the twenty-third message in this case).

<P>The <A HREF="../structs.htm#Late">Late</A> member says how late the application is running at the moment.
Negative values mean that there is some slack (probably the renderer is waiting for this time before
rendering the samples). A positive value from an audio renderer does not necessarily mean that
there is an audio break; it means that the audio renderer's buffer queue is running low
and is heading for a break.


<P CLASS="ref"><A NAME="When_to_Implement">When to Implement</A></P>
<P>Pins that are required to pass quality control messages upstream must implement this
interface. The <A HREF="../class/CBasePin.htm#CBasePin">CBasePin</A> class inherits <A HREF="IQualityControl.htm">IQualityControl</A> and provides a
pass-through implementation for output pins. Any filter that can act on a quality control
message to adjust the rate of data flow should implement this interface.
Any quality management component external to the <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_F.htm#filter_graph')">filter graph</A> should implement this
interface to receive quality control messages.

<P CLASS="ref"><A NAME="When_to_Use">When to Use</A></P>
<P>The rendering filter (usually the video renderer) is the primary user of this
interface because it originates the quality control messages. Because the messages
pass from one filter to another upstream, each <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_D.htm#downstream_filter')">downstream filter</A> calls the
<A HREF="IQualityControl.htm#Notify">IQualityControl::Notify</A> method on the upstream output <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_P.htm#pin')">pin</A> and so is a user.

<P CLASS="ref"><A NAME="Methods_in_Vtable_Or">Methods in Vtable Order</A></P>
<TABLE>
<TR><TH>IUnknown methods</TH><TH>Description</TH></TR><TR><TD><A HREF="IUnknown.htm#QueryInterface">QueryInterface</A> </TD><TD>Returns pointers to supported interfaces.
</TD></TR><TR><TD><A HREF="IUnknown.htm#AddRef">AddRef</A> </TD><TD>Increments the reference count.
</TD></TR><TR><TD><A HREF="IUnknown.htm#Release">Release</A> </TD><TD>Decrements the reference count.
</TD></TR><TR></TR>
<TR><TH>IQualityControl methods</TH><TH>Description</TH></TR><TR><TD><A HREF="IQualityControl.htm#Notify">Notify</A>
</TD><TD>Notifies the recipient that a quality change is requested.
</TD></TR><TR><TD><A HREF="IQualityControl.htm#SetSink">SetSink</A>
</TD><TD>Sets the <A HREF="IQualityControl.htm">IQualityControl</A> object that will receive quality messages.
</TD></TR></TABLE>



<H1><A NAME="Notify">IQualityControl::Notify</A><HR size=1></H1>
<A HREF="IQualityControl.htm">IQualityControl Interface</A>
<P>Receives a notification that a quality change is requested.

<P CLASS="ref">Syntax</P><BLOCKQUOTE><PRE>
<P><B>HRESULT</B> <B>Notify</B><B>(</B><BR>&nbsp;&nbsp;<B>IBaseFilter</B> <B>*</B> <I>pSelf</I><B>,</B><BR>&nbsp;&nbsp;<B>Quality</B> <I>q</I><BR>&nbsp;&nbsp;<B>)</B><B>;</B></PRE></BLOCKQUOTE>

<P CLASS="ref">Parameters</P>
<BLOCKQUOTE>
<DL><DT><I>pSelf</I>
 </DT><DD>[in] Pointer to the filter that is sending the quality notification.
</DD><DT><I>q</I>
 </DT><DD>[in] Quality notification structure.
</DD></DL>

</BLOCKQUOTE>
<P CLASS="ref">Return Value</P>
<BLOCKQUOTE>
<P>Returns an <A HREF="../Error_Success_Codes.htm#HRESULT">HRESULT</A> value that depends on the implementation. <B>HRESULT</B> can be one of the following standard constants, or other values not listed.
<TABLE>
<TR><TD>E_FAIL </TD><TD>Failure.
</TD></TR><TR><TD>E_POINTER </TD><TD>Null pointer argument.
</TD></TR><TR><TD>E_INVALIDARG </TD><TD>Invalid argument.
</TD></TR><TR><TD>E_NOTIMPL </TD><TD>Method isn't supported.
</TD></TR><TR><TD>S_OK or NOERROR </TD><TD>Success.
</TD></TR></TABLE>

</BLOCKQUOTE>


<H1><A NAME="SetSink">IQualityControl::SetSink</A><HR size=1></H1>
<A HREF="IQualityControl.htm">IQualityControl Interface</A>
<P>Sets the <A HREF="IQualityControl.htm">IQualityControl</A> object that will receive quality messages.

<P CLASS="ref">Syntax</P><BLOCKQUOTE><PRE>
<P><B>HRESULT</B> <B>SetSink</B><B>(</B><BR>&nbsp;&nbsp;<B>IQualityControl</B> <I>*piqc</I><BR>&nbsp;&nbsp;<B>)</B><B>;</B></PRE></BLOCKQUOTE>

<P CLASS="ref">Parameters</P>
<BLOCKQUOTE>
<DL><DT><I>piqc</I>
</DT><DD>Pointer to the <A HREF="IQualityControl.htm">IQualityControl</A> object to which the notifications should be sent.
</DD></DL>

</BLOCKQUOTE>
<P CLASS="ref">Return Value</P>
<BLOCKQUOTE>
<P>Returns an <A HREF="../Error_Success_Codes.htm#HRESULT">HRESULT</A> value that depends on the implementation. <B>HRESULT</B> can be one of the following standard constants, or other values not listed.
<TABLE>
<TR><TD>E_FAIL </TD><TD>Failure.
</TD></TR><TR><TD>E_POINTER </TD><TD>Null pointer argument.
</TD></TR><TR><TD>E_INVALIDARG </TD><TD>Invalid argument.
</TD></TR><TR><TD>E_NOTIMPL </TD><TD>Method isn't supported.
</TD></TR><TR><TD>S_OK or NOERROR </TD><TD>Success.
</TD></TR></TABLE>


</BLOCKQUOTE>
<P CLASS="ref">Remarks</P>


<BLOCKQUOTE>

<P>The filter that receives a call to this method should record the
<I>piqc</I> but should not add a reference count to it. The object pointed to
will be a quality manager and will be a part of the filter graph (for example,
a <A CLASS="Glossary" HREF="javascript:Glossary(sRelPath + 'gloss/gloss_P.htm#plug_in_distributor')">plug-in distributor</A>). Adding a reference count to this could cause
circular reference problems.

<P>The reference to the object specified in <I>piqc</I> is guaranteed to be
valid until this method is called with a null value.

</BLOCKQUOTE>
<!-- CONTENTS_END -->

<!-- START_PAGE_FOOTER -->


<H6><HR size=1></H6>
<P><A Class="line" HREF="#pagetop"><IMG src="../../art/arrowup1.gif" WIDTH="11" HEIGHT="11" ALIGN="MIDDLE" BORDER=0 ALT="Top of Page">&nbsp;Top of Page</A>
<BR><A Class="line" HREF="../../../cpyright.htm">&#169; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A>
<!-- END_PAGE_FOOTER -->

</BLOCKQUOTE>

<SCRIPT>if((g_isIE == true) && (g_iMaj > 3)) {window.self.document.writeln('<SCR' + 'IPT SRC="../../tip2.js"></SCR' + 'IPT><IFRAME ID="G_L_S" NAME="SecretBuffer" STYLE="display: none" SRC=""></IFRAME>')}</SCRIPT>

<!-- DACONTROL_START -->

	<DIV ID="HeadGraphAnim"></DIV>
	<SCRIPT>if((g_isIE == true) && (g_iMaj > 3)) {window.self.document.writeln('<SCR' + 'IPT SRC="../../anim.js"></SCR' + 'IPT>')}</SCRIPT>
<!-- DACONTROL_END -->

</BODY>
</HTML>
