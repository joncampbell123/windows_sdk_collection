<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<HTML>
<HEAD><TITLE>Recompress an AVI File</TITLE>
<STYLE>
<!--
.tctop {color: blue}
.cpslug {color: blue; text-decoration: none}
-->
</STYLE>
<SCRIPT LANGUAGE="JAVASCRIPT">
//<!--
function ShowButtons() {
    if (window.top.frames.length!=0 && window.top.frames[0].ShowButtons!=null)
	window.top.frames[0].ShowButtons('/dssd0056.htm','/dssd0000.htm','/dssd0049.htm','/index.htm','/dssd0058.htm');
}
ShowButtons();
//-->
</SCRIPT>
</HEAD>
<BODY onLoad="ShowButtons()" TOPMARGIN=10 BGPROPERTIES="FIXED" BGCOLOR="#FFFFFF" LINK="#000000" VLINK="#808080" ALINK="#000000">
<FONT FACE="VERDANA,ARIAL,HELVETICA" SIZE="2">
<H2><A NAME="capbuild_0001040108000000">Recompress an AVI File</A></H2>
<BR CLEAR=ALL>
<P>The following sample code shows how to recompress the file c:\Foo.avi to c:\Bar.avi, where the output file will use Cinepak compression and will include CD-quality audio. Recompression is useful to change the format of a file from one compression scheme to another. The exact benefits of recompression depend on the different compressors used to compress the source and output files and often include producing a smaller output file. In this example the source file, Foo.avi, might be in a format such as uncompressed RGB with 22 kilohertz (kHz) sound. 

<P>The <A CLASS=TCTOP HREF="dssd0370.htm#samples_0001070208010000" TARGET="TEXT">AMCap Sample (DirectShow Capture Application)</A> sample demonstrates a capture application and uses many of the same concepts as the following code. 

<P><B>Note</B>  This sample code fragment introduces concepts only and is not designed to compile. See the <A CLASS=TCTOP HREF="dssd0370.htm#samples_0001070208010000" TARGET="TEXT">AMCap Sample (DirectShow Capture Application)</A> sample for actual code. The code fragment does not perform error checking for the sake of brevity.<PRE><FONT FACE="Courier" SIZE="2">
    // Create a graph builder object.
    hr = CoCreateInstance((REFCLSID)CLSID_CaptureGraphBuilder,
                  NULL, CLSCTX_INPROC, (REFIID)IID_ICaptureGraphBuilder,
                  (void **)&amp;pBuild);

    // Create a filter graph, and tell the builder what it is.
    hr = CoCreateInstance((REFCLSID)CLSID_FilterGraph,
                  NULL, CLSCTX_INPROC, (REFIID)IID_IGraphBuilder,
                  (void **)&amp;pFg);
    hr = pBuild-&gt;SetFiltergraph(pFg);

    // Obtain a source for c:\foo.avi.
    hr = CoCreateInstance((REFCLSID)CLSID_AsyncReader,
                  NULL, CLSCTX_INPROC, (REFIID)IID_IBaseFilter,
                  (void **)&amp;pSrc);
    hr = pSrc-&gt;QueryInterface(IID_IFileSourceFilter, (void **)&amp;pI);
    hr = pI-&gt;Load(L"c:\\foo.avi", NULL);
    pI-&gt;Release();
    hr = pFg-&gt;AddFilter(pSrc, NULL);

    // Create a rendering section to create the c:\bar.avi output file.
    hr = pBuild-&gt;SetOutputFileName(&amp;MEDIASUBTYPE_Avi, L"c:\\bar.avi", &amp;pRender,
                                   NULL);

// [...Enumerate the audio compressors with the category CLSID_AudioCompressorCategory 
// and pick one. See the Amcap.cpp file in the capture sample directory for an example of 
// how to enumerate a category...]

    // Render the recompressed audio stream
    hr = pBuild-&gt;RenderStream(NULL, pSrc, pCAud, pRender);

// [...Enumerate a video compressor using the CLSID_VideoCompressorCategory enum, 
// as seen in Amcap.cpp...]

    pCVid = [...IBaseFilter pointer of the chosen Cinepak compressor...]
    hr = pFg-&gt;AddFilter(pCVid, NULL);

    // Tell it to compress at 100k/second data rate.
    // Use the current format to set the data rate, but change the data
    // rate item in the media type.
    hr = pBuild-&gt;FindInterface(NULL, pCVid, IID_IAMStreamConfig,
                               (void **)&amp;pVSC);
    hr = pVSC-&gt;GetFormat(&amp;cmt);
    ((VIDEOINFOHEADER)(cmt.Format()))-&gt;dwBitRate = 100000;
    hr = pVSC-&gt;SetFormat(&amp;cmt);
    pVSC-&gt;Release();

    // Request key frames every 4 frames.
    hr = pBuild-&gt;FindInterface(NULL, pCVid, IID_IAMVideoCompression,
                               (void **)&amp;pVC);
    hr = pVC-&gt;put_KeyFrameRate(4);
    pVC-&gt;Release();

    // Render the recompressed video stream.
    hr = pBuild-&gt;RenderStream(NULL, pSrc, pCVid, pRender);

    // All done with these objects now.
    pSrc-&gt;Release();
    pRender-&gt;Release();
    pCAud-&gt;Release();
    pCVid-&gt;Release();

    // Run the graph.
    hr = FG-&gt;QueryInterface(IID_IMediaControl, &amp;MC);
    MC-&gt;Run();

    // Wait for EC_COMPLETE, and it's all done!
    // [...wait for EC_COMPLETE event... see AMCap sample...]

 pGraphBuilder-&gt;FindInterface(pRender, IID_IMediaSeeking, pMS);
// [...While waiting for complete, use IMediaSeeking methods to get 
// the percentage complete... IMediaSeeking-&gt;GetCurrentPosition divided by 
// GetDuration * 100 will tell you the percent complete at any time...]

    pFg-&gt;Release();
    pBuild-&gt;Release();
</FONT></PRE>
<P><P><FONT FACE="MS SANS SERIF" SIZE="1" COLOR="BLACK">
<A CLASS=cpslug HREF="copyrite.htm" TARGET="TEXT">&#169; 1998 Microsoft Corporation. All rights reserved. Terms of Use.</A>
</FONT>
<BR CLEAR=ALL><P>
</FONT><P>
</BODY></HTML>
