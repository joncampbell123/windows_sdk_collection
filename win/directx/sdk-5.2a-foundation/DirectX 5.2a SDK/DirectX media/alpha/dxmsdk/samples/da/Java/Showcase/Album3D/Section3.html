<HTML>
<HEAD>
<TITLE>DirectX Media SDK DirectAnimation Tutorial</TITLE>
<LINK REL=STYLESHEET HREF="../../../../../webcd/da/tutorial.css">
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; CHARSET=iso8859-1">
<META NAME="MS.LOCALE" CONTENT="EN-US">
<META NAME="ROBOTS" CONTENT="noindex">
</HEAD>
<BODY BGCOLOR="WHITE" LINK=#0033CC TOPMARGIN=0 LEFTMARGIN=20>
<!--TOOLBAR_START-->
<!--TOOLBAR_EXEMPT-->
<!--TOOLBAR_END-->

<DIV CLASS="flush">
<TABLE WIDTH=100% BORDER=0 BGCOLOR=#000000>
<TR ALIGN=RIGHT><TD VALIGN=TOP><FONT CLASS=desc1 SIZE=2>
<A HREF="Section2.html" TARGET="_top">
<IMG SRC="../../../../../media/image/u_prev.gif"
 WIDTH=71 HEIGHT=16 BORDER=0 ALT="Previous Topic">
</A><A HREF="../../../../../webcd/da/tutorial_main.htm" TARGET="_top">
<IMG SRC="../../../../../media/image/d_home.gif" WIDTH=48 HEIGHT=16 BORDER=0 ALT="Tutorial Home Page"></A>
<A HREF="Section4.html" TARGET="_top">
<IMG SRC="../../../../../media/image/u_next.gif" WIDTH=48 HEIGHT=16 BORDER=0 ALT="Next Topic">
</A></FONT></TD><TD WIDTH=30></TD></TR></TABLE></DIV>
<FONT CLASS=title><CENTER>The State Machine</CENTER></FONT>
<BR>
<BR>
<FONT CLASS=desc1>
  The state machine has five states controlled by two events, one for left page flips  
  and one for right flips. The machine controls and coordinates the pages of
  the album and the sound effects of the album. The sample uses notification
  objects because of the cyclic dependency in the finite state machine
  (not because of event data, which is the second purpose for using notification
  objects). Notification objects, by providing a delayed execution construct, 
  make it possible to construct cyclic calling dependencies without infinite looping.
  The sample also uses the until2 method instead of untilNotify since it allows the
  aggregatation of two notification events each with a different notification method; 
  see the opened state below. 
  
<BR><BR>  Note that both cyclic dependency and branching from one
  state into two or more states upon different events are commonly
  occuring patterns in general state machines. Hence the example below
  has the building blocks that are needed for typical state machines.
</FONT><BR>
<BR>
<TABLE><TR><TD WIDTH=500><FONT CLASS=desc1> This state is the entry point into the state machine
 and is also returned to upon flipping the
 front page back (effectively going back to the start state).
 It sets the left page to blank, the right page to
 the front page of the album, and it emits the page-flip completion sound
 through the right speaker.
 The state waits on the leftEventNotify event upon which it
 invokes the transLeft notification object which implements the
 "transition left" state.</TD></TR></FONT></TABLE>
<FONT CLASS=code><DIV STYLE="margin-left: 0.125in">public static TupleBvr frontState () {<BR>
</DIV><DIV STYLE="margin-left: 0.25in">NumberBvr leftInd = toBvr(0);<BR>
Behavior newBvrs[] = { leftInd, add(leftInd, toBvr(1)),<BR>
</DIV><DIV STYLE="margin-left: 1.625in">emptyGeometry,  endSnd.pan(+1)};<BR>
</DIV><DIV STYLE="margin-left: 0.25in">TupleBvr tuple =  new TupleBvr(newBvrs);<BR>
return (TupleBvr)untilEx(tuple, leftEventNotify);<BR>
</DIV><DIV STYLE="margin-left: 0.125in">}<BR>
</DIV><DIV STYLE="margin-left: 0.5in"></FONT>
<BR>
</DIV><TABLE><TR><TD WIDTH=500><FONT CLASS=desc1> This state is entered upon the end of a page flip
 that causes the album to be properly opened
 (i.e., not in a boundary condition). It waits on either a left or a right
 event, at which point it invokes the transLeft or transRight
 notification objects, respectively, which carry it through either
 the left transition or to right
 transition state. It accepts an index to the
 left page plus the side to which the previous page was flipped to,
 in order to emit the page flip termination sound.</TD></TR></FONT></TABLE>
<FONT CLASS=code><DIV STYLE="margin-left: 0.125in">public static TupleBvr opened (NumberBvr leftInd, int side) {<BR>
</DIV><DIV STYLE="margin-left: 0.25in">Behavior newBvrs[] = {leftInd , add(leftInd, toBvr(1)),<BR>
</DIV><DIV STYLE="margin-left: 1.625in">emptyGeometry, endSnd.pan(toBvr(side))};<BR>
</DIV><DIV STYLE="margin-left: 0.25in">TupleBvr tuple =  new TupleBvr(newBvrs);<BR>
return (TupleBvr)untilEx(tuple, orEvent(rightEventNotify,<BR>
</DIV><DIV STYLE="margin-left: 1.6875in">leftEventNotify));<BR>
</DIV><DIV STYLE="margin-left: 0.125in">}<BR>
</DIV><DIV STYLE="margin-left: 0.0625in"></FONT>
<BR>
</DIV><TABLE><TR><TD WIDTH=500><FONT CLASS=desc1> symmetric to frontState</TD></TR></FONT></TABLE>
<FONT CLASS=code><DIV STYLE="margin-left: 0.125in">public static  TupleBvr backState () {<BR>
</DIV><DIV STYLE="margin-left: 0.25in">NumberBvr leftInd = toBvr(A3DM.numPics);<BR>
Behavior newBvrs[] = {leftInd, add(leftInd, toBvr(1)),<BR>
</DIV><DIV STYLE="margin-left: 1.625in">emptyGeometry, endSnd.pan(-1)};<BR>
</DIV><DIV STYLE="margin-left: 0.25in">TupleBvr tuple =  new TupleBvr(newBvrs);<BR>
return (TupleBvr)untilEx(tuple, rightEventNotify);<BR>
</DIV><DIV STYLE="margin-left: 0.125in">}<BR>
</DIV><BR>
</FONT>
<BR>
<TABLE><TR><TD WIDTH=500><FONT CLASS=desc1> This notifier object flips the center page to the left side until the
 completion of the page flip. At that point if we've flipped
 the last page then we go to the back state, else we go to
 the opened state, which is the nominal one.
 Notice how we extract the present left page index from the "previous"
 parameter of the "notify" method.</TD></TR></FONT></TABLE>
<FONT CLASS=code>class TransLeft extends Statics implements UntilNotifier {<BR>
<DIV STYLE="margin-left: 0.125in">public Behavior notify(Object eventData, Behavior previous, BvrsToRun blst) {<BR>
</DIV><DIV STYLE="margin-left: 0.25in">NumberBvr leftInd = (NumberBvr)((TupleBvr)previous).nth(0);<BR>
Behavior newBvrs[] = {leftInd, add(leftInd, toBvr(2)),<BR>
</DIV><DIV STYLE="margin-left: 1.625in">A3DM.flip(add(leftInd, toBvr(1)), -1), A3DM.flippingSnd(-1)};<BR>
</DIV><DIV STYLE="margin-left: 0.25in">return (TupleBvr) until(new TupleBvr(newBvrs), A3DM.endFlip,<BR>
</DIV><DIV STYLE="margin-left: 1.5in">cond(eq(leftInd, toBvr(A3DM.numPics - 1)),<BR>
</DIV><DIV STYLE="margin-left: 1.9375in">A3DM.backState(),<BR>
A3DM.opened(add(leftInd, toBvr(1)), -1)));<BR>
</DIV><DIV STYLE="margin-left: 0.125in">}<BR>
</DIV>}<BR>
</FONT>
<BR>
<TABLE><TR><TD WIDTH=500><FONT CLASS=desc1> symmetric to TransLeft</TD></TR></FONT></TABLE>
<FONT CLASS=code>class TransRight extends Statics implements UntilNotifier {<BR>
<DIV STYLE="margin-left: 0.125in">public  Behavior notify(Object eventData, Behavior previous, BvrsToRun blst) {<BR>
</DIV><DIV STYLE="margin-left: 0.25in">NumberBvr leftInd = sub((NumberBvr)((TupleBvr)previous).nth(0), toBvr(1));<BR>
Behavior newBvrs[] = {leftInd, add(leftInd, toBvr(2)),<BR>
</DIV><DIV STYLE="margin-left: 1.625in">A3DM.flip(add(leftInd, toBvr(1)), +1), A3DM.flippingSnd(+1)};<BR>
</DIV><DIV STYLE="margin-left: 0.25in">return (TupleBvr) until(new TupleBvr(newBvrs), A3DM.endFlip,<BR>
</DIV><DIV STYLE="margin-left: 1.5in">cond(eq(leftInd, toBvr(0)),<BR>
</DIV><DIV STYLE="margin-left: 1.9375in">A3DM.frontState(),<BR>
A3DM.opened(leftInd, +1)));<BR>
</DIV><DIV STYLE="margin-left: 0.125in">}<BR>
</DIV>}<BR>
</FONT>
<BR>
<TABLE><TR><TD WIDTH=500><FONT CLASS=desc1> interaction events
 Right and left arrows to flip pages.</TD></TR></FONT></TABLE>
<FONT CLASS=code><DIV STYLE="margin-left: 0.125in">static final DXMEvent rightEvent = keyDown(Event.RIGHT);<BR>
static final DXMEvent leftEvent = keyDown(Event.LEFT);</FONT>
<BR>
</DIV><TABLE><TR><TD WIDTH=500><FONT CLASS=desc1> signals the conclusion of a page flip animation</TD></TR></FONT></TABLE>
<FONT CLASS=code><DIV STYLE="margin-left: 0.125in">static final DXMEvent endFlip = timer(toBvr(period));</FONT>
<BR>
</DIV><TABLE><TR><TD WIDTH=500><FONT CLASS=desc1> instantiate the notifier objects</TD></TR></FONT></TABLE>
<FONT CLASS=code><DIV STYLE="margin-left: 0.125in">static final TransRight transRight = new TransRight();<BR>
static final TransLeft transLeft = new TransLeft();</FONT>
<BR>
</DIV><TABLE><TR><TD WIDTH=500><FONT CLASS=desc1> Define notify events based on the previous objects,
 these events get used in the state machine.</TD></TR></FONT></TABLE>
<FONT CLASS=code><DIV STYLE="margin-left: 0.125in">static final DXMEvent rightEventNotify = rightEvent.notifyEvent(transRight);<BR>
static final DXMEvent leftEventNotify = leftEvent.notifyEvent(transLeft);<BR>
</DIV><BR>
<BR>
</FONT><FONT CLASS=link><A ID=cpslug HREF="../../../../../help/da/dalegal.htm" TARGET="_top">&#169; 1997 Microsoft Corporation. All rights reserved. Terms of Use.</A></FONT>

<BR>
<BR>
<DIV CLASS="flush">
<TABLE WIDTH=100% BORDER=0 BGCOLOR=#000000>
<TR ALIGN=RIGHT><TD VALIGN=TOP><FONT CLASS=desc1 SIZE=2>
<A HREF="Section2.html" TARGET="_top">
<IMG SRC="../../../../../media/image/u_prev.gif"
 WIDTH=71 HEIGHT=16 BORDER=0 ALT="Previous Topic">
</A><A HREF="../../../../../webcd/da/tutorial_main.htm" TARGET="_top">
<IMG SRC="../../../../../media/image/d_home.gif" WIDTH=48 HEIGHT=16 BORDER=0 ALT="Tutorial Home Page"></A>
<A HREF="Section4.html" TARGET="_top">
<IMG SRC="../../../../../media/image/u_next.gif" WIDTH=48 HEIGHT=16 BORDER=0 ALT="Next Topic">
</A></FONT></TD><TR><TD WIDTH=30></TD></TR></TABLE></DIV>

</BODY>
</HTML>
