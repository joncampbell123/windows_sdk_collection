'*****************************************************************************
' Copyright (c) 1991 Microsoft Corporation
'
' Module Name:
'   regen.mst
'
' Abstract:
'   Uses windisk.exe to regenerate a previously orphaned swp.
'
' Revision History:
'
'   Kenieth Peery (t-kenpe) 12-9-92
'   steveko - May 93 - cut and paste mania
'
'*****************************************************************************

'$DEFINE TESTEVNT
'$DEFINE TESTCTRL
'$DEFINE W_WINDOW

'$INCLUDE 'MSTEST.INC'

'$INCLUDE 'common.inc'


DIM ftType$         '*** the type of ft componet to create
DIM fileSystem$     '*** the desire file system type of the created partition
DIM szMB$           '*** the desire space of the created partition
DIM driveLet$       '*** the desire drive letter to be assigned to the partition
DIM numRegions%     '*** the number of sected regions

DIM winTitle$       '*** The title of the active window
DIM winHandle%      '*** The handle to the main window
DIM limit%          '*** The limit on certain timing loops

GetConfig "create.dat",ftType,fileSystem,szMB,driveLet,numRegions

'*** Here we go
RUN "windisk.exe", NOWAIT
WndWait "Disk Administrator"          '*** wait for windisk to come up

winTitle$=GetText(WGetActWnd(0))

OpenLog "foo.log",LOG_DISK

AvoidLeadingPopups
                                '*** should now be just Disk Manager
winHandle = WGetActWnd(0)       '*** this gets the handle to Parent Window
WMaxWnd winHandle               '*** maximize the main window

IF ftType=STRWP THEN
  SelectRegion disk(0), pos(0)
  QueFlush 1
  QuePause 1000
  QueKeys "%(){RIGHT}{ENTER}{UP}{ENTER}"   '*** select regenerate
  QuePause 1000
  QueFlush 1
END IF

QueFlush 1

IF ftType=MIRROR THEN
  SelectRegion disk(0), pos(0)       '*** reslect prim region
  SelectRegion disk(1), pos(1)       '*** select shdw
  QueKeys "%(){RIGHT}{ENTER}{ENTER}" '*** establish mirror
END IF
QueFlush 1

CloseLog

QueKeys "%(){ENTER}{UP}{ENTER}" '*** Exit stage right
QuePause 1000
QueKeys "{ENTER}"               '*** save changes
QuePause 1000
QueKeys "{ENTER}"               '*** Disks Updated succesfully
                                '*** need something conditional
                                '*** here if not
'
' This code is commented out to prevent windisk from sending the
' shutdown request.  We are doing it ourselves with the force
' flag below to workaround these shutdown problems.
'
'QueKeys "{ENTER}"               '*** Reboot
'

QuePause 1000
QueFlush 1

WHILE 1
    SHELL "shutdown -f -r -t 0"
WEND

WaitForShutdown

END
'*** end of Main program
