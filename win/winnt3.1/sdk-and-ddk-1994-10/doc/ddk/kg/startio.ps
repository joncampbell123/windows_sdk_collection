%!PS-Adobe-2.0 
PSp 15840 SFL 
1920 2440 P 8 18 F B (Chapter) S 100 J ( 7) S E 
1920 2840 P B (StartIo) S 100 J ( or) S 100 J ( Queue) S 100 J ( Management) S 100 J ( Routines) S E 
1920 3600 P 0 12 F 24 12 F (This) S 60 J ( chapter) S 60 J ( summarizes) S 60 J ( the) S 60 J ( required) S 60 J ( functionality) S 60 J ( of) S 60 J ( NT) S 60 J ( device) S 60 J ( drivers') S 60 J ( standard) S 60 J ( StartIo) S 
1920 3860 P (routines.) S 60 J ( For) S 60 J ( driver) S 60 J ( designers) S 60 J ( who) S 60 J ( need) S 60 J ( to) S 60 J ( set) S 60 J ( up) S 60 J ( internal) S 60 J ( queues) S 60 J ( for) S 60 J ( IRPs) S 60 J ( in) S 60 J ( their) S 60 J ( drivers,) S 60 J ( it) S 
1920 4120 P (also) S 60 J ( summarizes) S 60 J ( the) S 60 J ( support) S 60 J ( NT) S 60 J ( provides) S 60 J ( for) S 60 J ( doing) S 60 J ( this) S 60 J ( and) S 60 J ( for) S 60 J ( managing) S 60 J ( driver-created) S 
1920 4380 P (internal) S 60 J ( queues.) S 
1920 5180 P 0 12 F 8 14 F B (7.1) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Queueing) S 78 J ( IRPs) S E 
1920 5800 P 0 12 F 24 12 F (Because) S 60 J ( the) S 60 J ( NT) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( supports) S 60 J ( asynchronous) S 60 J ( I/O) S 60 J ( in) S 60 J ( a) S 60 J ( multitasking,) S 60 J ( multiprocessor) S 
1920 6060 P (system,) S 60 J ( I/O) S 60 J ( requests) S 60 J ( to) S 60 J ( a) S 60 J ( device) S 60 J ( can) S 60 J ( come) S 60 J ( in) S 60 J ( faster) S 60 J ( than) S 60 J ( its) S 60 J ( driver) S 60 J ( can) S 60 J ( process) S 60 J ( them) S 60 J ( to) S 
1920 6320 P (completion.) S 60 J ( Consequently,) S 60 J ( IRPs) S 60 J ( must) S 60 J ( be) S 60 J ( queued) S 60 J ( when) S 60 J ( a) S 60 J ( particular) S 60 J ( device) S 60 J ( driver) S 60 J ( is) S 60 J ( already) S 
1920 6580 P (busy) S 60 J ( processing) S 60 J ( another) S 60 J ( IRP.) S 
1920 6960 P (If) S 60 J ( a) S 60 J ( device) S 60 J ( can) S 60 J ( carry) S 60 J ( out) S 60 J ( only) S 60 J ( one) S 60 J ( operation) S 60 J ( at) S 60 J ( any) S 60 J ( given) S 60 J ( moment) S 60 J ( and) S 60 J ( the) S 60 J ( driver) S 60 J ( has) S 60 J ( a) S 60 J ( StartIo) S 
1920 7220 P (routine,) S 60 J ( the) S 60 J ( NT) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( provides) S 60 J ( support) S 60 J ( for) S 60 J ( the) S 60 J ( necessary) S 60 J ( queueing,) S 60 J ( as) S 60 J ( explained) S 60 J ( in) S 
1920 7480 P (Chapter) S 60 J ( 4.) S 60 J ( Most) S 60 J ( NT) S 60 J ( device) S 60 J ( drivers) S 60 J ( have) S 60 J ( StartIo) S 60 J ( routines) S 60 J ( because) S 60 J ( most) S 60 J ( PC) S 60 J ( peripheral) S 60 J ( devices) S 
1920 7740 P (are) S 60 J ( capable) S 60 J ( of) S 60 J ( handling) S 60 J ( only) S 60 J ( one) S 60 J ( device) S 60 J ( I/O) S 60 J ( operation) S 60 J ( at) S 60 J ( a) S 60 J ( time.) S 
1920 8120 P (If) S 60 J ( an) S 60 J ( underlying) S 60 J ( device) S 60 J ( can) S 60 J ( support) S 60 J ( more) S 60 J ( than) S 60 J ( one) S 60 J ( concurrent) S 60 J ( I/O) S 60 J ( operation,) S 60 J ( an) S 60 J ( NT) S 60 J ( device) S 
1920 8380 P (driver) S 60 J ( must) S 60 J ( set) S 60 J ( up) S 60 J ( internal) S 60 J ( request) S 60 J ( queues) S 60 J ( and) S 60 J ( manage) S 60 J ( its) S 60 J ( own) S 60 J ( queueing) S 60 J ( of) S 60 J ( IRPs.) S 60 J ( For) S 60 J ( example,) S 
1920 8640 P (the) S 60 J ( system-supplied) S 60 J ( serial) S 60 J ( driver) S 60 J ( maintains) S 60 J ( separate) S 60 J ( queues) S 60 J ( for) S 60 J ( read,) S 60 J ( write,) S 60 J ( purge,) S 60 J ( and) S 60 J ( wait) S 
1920 8900 P (operations) S 60 J ( on) S 60 J ( its) S 60 J ( device\(s\)) S 60 J ( because) S 60 J ( it) S 60 J ( supports) S 60 J ( full-duplex) S 60 J ( serial) S 60 J ( device\(s\).) S 
1920 9280 P (A) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( that) S 60 J ( sends) S 60 J ( requests) S 60 J ( to) S 60 J ( some) S 60 J ( number) S 60 J ( of) S 60 J ( underlying) S 60 J ( device) S 60 J ( drivers) S 60 J ( also) S 
1920 9540 P (might) S 60 J ( maintain) S 60 J ( internal) S 60 J ( queues) S 60 J ( of) S 60 J ( IRPs.) S 60 J ( For) S 60 J ( example,) S 60 J ( file) S 60 J ( system) S 60 J ( drivers) S 60 J ( usually) S 60 J ( have) S 60 J ( internal) S 
1920 9800 P (queues) S 60 J ( for) S 60 J ( IRPs.) S 
1920 10180 P (A) S 60 J ( driver) S 60 J ( that) S 60 J ( manages) S 60 J ( its) S 60 J ( own) S 60 J ( internal) S 60 J ( queues) S 60 J ( can) S 60 J ( have) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( at) S 60 J ( the) S 60 J ( discretion) S 60 J ( of) S 
1920 10440 P (the) S 60 J ( driver) S 60 J ( designer.) S 60 J ( However,) S 60 J ( higher-level) S 60 J ( NT) S 60 J ( drivers) S 60 J ( generally) S 60 J ( do) S 60 J ( not) S 60 J ( have) S 60 J ( StartIo) S 60 J ( routines.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (2) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (The) S 60 J ( NT-supplied) S 60 J ( SCSI) S 60 J ( port) S 60 J ( driver) S 60 J ( both) S 60 J ( has) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( and) S 60 J ( manages) S 60 J ( internal) S 60 J ( queues) S 60 J ( of) S 
1200 2320 P (IRPs.) S 60 J ( IRPs) S 60 J ( are) S 60 J ( queued) S 60 J ( to) S 60 J ( its) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( associated) S 60 J ( with) S 60 J ( the) S 60 J ( driver-) S 
1200 2580 P (created) S 60 J ( device) S 60 J ( object) S 60 J ( that) S 60 J ( represents) S 60 J ( the) S 60 J ( HBA.) S 60 J ( This) S 60 J ( driver) S 60 J ( also) S 60 J ( sets) S 60 J ( up) S 60 J ( separate) S 60 J ( device) S 60 J ( queue) S 
1200 2840 P (objects) S 60 J ( for) S 60 J ( and) S 60 J ( manages) S 60 J ( the) S 60 J ( queueing) S 60 J ( of) S 60 J ( IRPs) S 60 J ( to) S 60 J ( each) S 60 J ( target) S 60 J ( device) S 60 J ( \(corresponding) S 60 J ( to) S 60 J ( a) S 60 J ( SCSI) S 
1200 3100 P (logical) S 60 J ( unit\)) S 60 J ( on) S 60 J ( any) S 60 J ( HBA-driven) S 60 J ( SCSI) S 60 J ( bus) S 60 J ( in) S 60 J ( the) S 60 J ( machine.) S 60 J ( The) S 60 J ( SCSI) S 60 J ( port) S 60 J ( driver) S 60 J ( uses) S 60 J ( its) S 
1200 3360 P (supplemental) S 60 J ( device) S 60 J ( queues) S 60 J ( to) S 60 J ( hold) S 60 J ( IRPs) S 60 J ( sent) S 60 J ( down) S 60 J ( from) S 60 J ( the) S 60 J ( SCSI) S 60 J ( class) S 60 J ( drivers) S 60 J ( in) S 60 J ( LU-) S 
1200 3620 P (specific) S 60 J ( queues) S 60 J ( whenever) S 60 J ( any) S 60 J ( device) S 60 J ( on) S 60 J ( a) S 60 J ( SCSI) S 60 J ( bus) S 60 J ( is) S 60 J ( particularly) S 60 J ( busy.) S 60 J ( In) S 60 J ( effect,) S 60 J ( this) S 60 J ( driver's) S 
1200 3880 P (supplemental,) S 60 J ( LU-specific) S 60 J ( device) S 60 J ( queues) S 60 J ( allow) S 60 J ( the) S 60 J ( SCSI) S 60 J ( port) S 60 J ( driver) S 60 J ( to) S 60 J ( serialize) S 60 J ( operations) S 60 J ( for) S 
1200 4140 P (heterogeneous) S 60 J ( SCSI) S 60 J ( devices) S 60 J ( through) S 60 J ( the) S 60 J ( HBA) S 60 J ( while) S 60 J ( keeping) S 60 J ( each) S 60 J ( device) S 60 J ( on) S 60 J ( the) S 60 J ( bus) S 60 J ( as) S 60 J ( busy) S 
1200 4400 P (as) S 60 J ( possible.) S 
1200 4780 P (NT) S 60 J ( drivers) S 60 J ( with) S 60 J ( device-dedicated) S 60 J ( threads) S 60 J ( and) S 60 J ( those) S 60 J ( that) S 60 J ( use) S 60 J ( executive) S 60 J ( worker) S 60 J ( threads,) S 
1200 5040 P (including) S 60 J ( most) S 60 J ( NT) S 60 J ( file) S 60 J ( system) S 60 J ( drivers,) S 60 J ( usually) S 60 J ( set) S 60 J ( up) S 60 J ( an) S 60 J ( interlocked) S 60 J ( queue) S 60 J ( for) S 60 J ( IRPs) S 60 J ( in) S 60 J ( the) S 
1200 5300 P (device) S 60 J ( extensions) S 60 J ( of) S 60 J ( their) S 60 J ( device) S 60 J ( objects.) S 60 J ( Such) S 60 J ( a) S 60 J ( queue) S 60 J ( is) S 60 J ( shared) S 60 J ( by) S 60 J ( the) S 60 J ( driver) S 60 J ( thread) S 60 J ( \(or) S 
1200 5560 P (driver-supplied) S 60 J ( worker) S 60 J ( thread) S 60 J ( callback\)) S 60 J ( and) S 60 J ( by) S 60 J ( other) S 60 J ( driver) S 60 J ( routines) S 60 J ( that) S 60 J ( process) S 60 J ( IRPs.) S 60 J ( The) S 
1200 5820 P (driver's) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( inserts) S 60 J ( IRPs) S 60 J ( into) S 60 J ( the) S 60 J ( queue) S 60 J ( and) S 60 J ( a) S 60 J ( driver-created) S 60 J ( thread) S 60 J ( or) S 60 J ( the) S 60 J ( driver's) S 
1200 6080 P (worker-thread) S 60 J ( callback) S 60 J ( removes) S 60 J ( them) S 60 J ( by) S 60 J ( calling) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (ExInterlocked..List) S E 0 12 F 24 12 F () S 60 J ( routines.) S 
1200 6460 P (For) S 60 J ( example,) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( floppy) S 60 J ( driver) S 60 J ( uses) S 60 J ( such) S 60 J ( an) S 60 J ( interlocked) S 60 J ( queue.) S 60 J ( Its) S 60 J ( device-) S 
1200 6720 P (dedicated) S 60 J ( thread) S 60 J ( handles) S 60 J ( the) S 60 J ( same) S 60 J ( processing) S 60 J ( of) S 60 J ( IRPs) S 60 J ( that) S 60 J ( is) S 60 J ( done) S 60 J ( by) S 60 J ( other) S 60 J ( device) S 60 J ( drivers') S 
1200 6980 P (StartIo) S 60 J ( routines) S 60 J ( and) S 60 J ( some) S 60 J ( of) S 60 J ( the) S 60 J ( same) S 60 J ( processing) S 60 J ( of) S 60 J ( IRPs) S 60 J ( that) S 60 J ( is) S 60 J ( done) S 60 J ( by) S 60 J ( other) S 60 J ( device) S 60 J ( drivers') S 
1200 7240 P (DpcForIsr) S 60 J ( routines.) S 
1200 8040 P 0 12 F 8 14 F B (7.2) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( StartIo) S 78 J ( Routine) S 78 J ( Requirements) S E 
1200 8660 P 0 12 F 24 12 F (As) S 60 J ( its) S 60 J ( name) S 60 J ( suggests,) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( in) S 60 J ( a) S 60 J ( lowest-level) S 60 J ( driver) S 60 J ( is) S 60 J ( responsible) S 60 J ( for) S 60 J ( starting) S 60 J ( an) S 
1200 8920 P (I/O) S 60 J ( operation) S 60 J ( on) S 60 J ( the) S 60 J ( physical) S 60 J ( device.) S 60 J ( A) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( is) S 60 J ( run) S 60 J ( in) S 60 J ( an) S 60 J ( arbitrary) S 60 J ( thread) S 60 J ( context) S 60 J ( at) S 
1200 9180 P (IRQL) S 60 J ( DISPATCH_LEVEL.) S 60 J ( Running) S 60 J ( at) S 60 J ( IRQL) S 60 J ( DISPATCH_LEVEL) S 60 J ( restricts) S 60 J ( the) S 60 J ( set) S 60 J ( of) S 
1200 9440 P (support) S 60 J ( routines) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( can) S 60 J ( call.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( managing) S 60 J ( IRQLs,) S 60 J ( see) S 
1200 9700 P (Chapter) S 60 J ( 16.) S 60 J ( For) S 60 J ( specific) S 60 J ( information) S 60 J ( about) S 60 J ( the) S 60 J ( IRQL\(s\)) S 60 J ( at) S 60 J ( which) S 60 J ( any) S 60 J ( particular) S 60 J ( support) S 
1200 9960 P (routine) S 60 J ( can) S 60 J ( be) S 60 J ( called,) S 60 J ( see) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F I (Kernel-mode) S 60 J ( Driver) S E 0 12 F 24 12 F () S 60 J ( ) S 0 12 F 24 12 F I (Reference) S E 0 12 F 24 12 F (.) S 
1200 10340 P (When) S 60 J ( a) S 60 J ( lowest-level) S 60 J ( driver's) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( is) S 60 J ( called,) S 60 J ( it) S 60 J ( can) S 60 J ( assume) S 60 J ( that) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 
1200 10600 P (represented) S 60 J ( by) S 60 J ( the) S 60 J ( input) S 60 J ( device) S 60 J ( object) S 60 J ( is) S 60 J ( not) S 60 J ( busy:) S 60 J ( either) S 60 J ( a) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( has) S 60 J ( just) S 60 J ( called) S 
1200 10860 P 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F () S 60 J ( \(see) S 60 J ( Chapter) S 60 J ( 4\)) S 60 J ( and) S 60 J ( the) S 60 J ( IRP) S 60 J ( was) S 60 J ( not) S 60 J ( inserted) S 60 J ( into) S 60 J ( the) S 60 J ( associated) S 60 J ( device) S 60 J ( queue,) S 
1200 11120 P (or) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( is) S 60 J ( completing) S 60 J ( another) S 60 J ( request) S 60 J ( and) S 60 J ( has) S 60 J ( just) S 60 J ( called) S 60 J ( ) S 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F (.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 916 J ( 7-) S E B (3) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (The) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( is) S 60 J ( responsible) S 60 J ( for) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoGetCurrentIrpStackLocation) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( input) S 
1920 2320 P (IRP) S 60 J ( and,) S 60 J ( then,) S 60 J ( doing) S 60 J ( whatever) S 60 J ( request-specific) S 60 J ( processing) S 60 J ( is) S 60 J ( necessary) S 60 J ( to) S 60 J ( start) S 60 J ( the) S 60 J ( I/O) S 
1920 2580 P (operation) S 60 J ( on) S 60 J ( the) S 60 J ( device,) S 60 J ( which) S 60 J ( can) S 60 J ( include) S 60 J ( the) S 60 J ( following:) S 
1920 2900 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Setting) S 60 J ( up) S 60 J ( or) S 60 J ( updating) S 60 J ( any) S 60 J ( state) S 60 J ( information) S 60 J ( about) S 60 J ( the) S 60 J ( current) S 60 J ( request) S 60 J ( that) S 60 J ( the) S 60 J ( driver) S 
2400 3160 P (maintains) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( extension) S 60 J ( of) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 60 J ( \(or) S 60 J ( elsewhere) S 60 J ( in) S 60 J ( nonpaged) S 
2400 3420 P (pool) S 60 J ( allocated) S 60 J ( by) S 60 J ( the) S 60 J ( driver\)) S 
2400 3740 P (For) S 60 J ( example,) S 60 J ( if) S 60 J ( the) S 60 J ( driver) S 60 J ( maintains) S 60 J ( an) S 60 J ( InterruptExpected) S 60 J ( Boolean) S 60 J ( about) S 60 J ( the) S 60 J ( current) S 
2400 4000 P (transfer) S 60 J ( operation,) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( might) S 60 J ( set) S 60 J ( this) S 60 J ( variable) S 60 J ( to) S 60 J ( TRUE.) S 60 J ( If) S 60 J ( the) S 60 J ( driver) S 
2400 4260 P (maintains) S 60 J ( a) S 60 J ( time-out) S 60 J ( counter) S 60 J ( for) S 60 J ( the) S 60 J ( current) S 60 J ( operation,) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( might) S 60 J ( set) S 60 J ( up) S 
2400 4520 P (this) S 60 J ( value,) S 60 J ( or) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( might) S 60 J ( queue) S 60 J ( the) S 60 J ( driver's) S 60 J ( CustomTimerDpc,) S 60 J ( described) S 60 J ( in) S 
2400 4780 P (Chapter) S 60 J ( 14.) S 
1920 5100 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( necessary,) S 60 J ( translating) S 60 J ( the) S 60 J ( IRP's) S 60 J ( arguments) S 60 J ( into) S 60 J ( device-specific) S 60 J ( values) S 
2400 5420 P (For) S 60 J ( example,) S 60 J ( a) S 60 J ( disk) S 60 J ( driver) S 60 J ( might) S 60 J ( need) S 60 J ( to) S 60 J ( calculate) S 60 J ( the) S 60 J ( starting) S 60 J ( sector) S 60 J ( for) S 60 J ( a) S 60 J ( transfer) S 
2400 5680 P (operation) S 60 J ( and) S 60 J ( whether) S 60 J ( the) S 60 J ( requested) S 60 J ( length) S 60 J ( of) S 60 J ( the) S 60 J ( transfer) S 60 J ( will) S 60 J ( cross) S 60 J ( a) S 60 J ( particular) S 60 J ( sector) S 
2400 5940 P (boundary) S 60 J ( or) S 60 J ( exceed) S 60 J ( the) S 60 J ( transfer) S 60 J ( capacity) S 60 J ( of) S 60 J ( its) S 60 J ( device.) S 
1920 6260 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( device) S 60 J ( uses) S 60 J ( DMA,) S 60 J ( checking) S 60 J ( whether) S 60 J ( the) S 60 J ( requested) S 60 J ( ) S 0 12 F 24 12 F B (Length) S E 0 12 F 24 12 F () S 60 J ( \(number) S 60 J ( of) S 60 J ( bytes) S 60 J ( to) S 60 J ( be) S 
2400 6520 P (transferred,) S 60 J ( found) S 60 J ( in) S 60 J ( the) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( of) S 60 J ( the) S 60 J ( IRP\)) S 60 J ( should) S 60 J ( be) S 60 J ( split) S 60 J ( into) S 
2400 6780 P (smaller) S 60 J ( transfer) S 60 J ( requests,) S 60 J ( as) S 60 J ( explained) S 60 J ( in) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( adapter) S 60 J ( objects) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 3) S 
2400 7100 P (The) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( also) S 60 J ( can) S 60 J ( be) S 60 J ( responsible) S 60 J ( for) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (KeFlushIoBuffers) S E 0 12 F 24 12 F () S 60 J ( and,) S 60 J ( if) S 60 J ( the) S 
2400 7360 P (driver) S 60 J ( uses) S 60 J ( packet-based) S 60 J ( DMA,) S 60 J ( for) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoAllocateAdapterChannel) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( driver's) S 
2400 7620 P (AdapterControl) S 60 J ( routine,) S 60 J ( described) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 11.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
2400 7880 P (maintaining) S 60 J ( cache) S 60 J ( coherency) S 60 J ( during) S 60 J ( DMA,) S 60 J ( see) S 60 J ( also) S 60 J ( Chapter) S 60 J ( 16.) S 
1920 8200 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( device) S 60 J ( uses) S 60 J ( PIO,) S 60 J ( mapping) S 60 J ( the) S 60 J ( user-buffer) S 60 J ( pointer) S 60 J ( passed) S 60 J ( in) S 60 J ( the) S 60 J ( IRP) S 60 J ( to) S 60 J ( a) S 60 J ( system-) S 
2400 8460 P (space) S 60 J ( pointer) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (MmGetSystemAddressForMdl) S E 0 12 F 24 12 F (,) S 60 J ( as) S 60 J ( explained) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 3) S 
2400 8780 P (For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( maintaining) S 60 J ( cache) S 60 J ( coherency) S 60 J ( during) S 60 J ( PIO,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 
1920 9100 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( driver) S 60 J ( uses) S 60 J ( a) S 60 J ( controller) S 60 J ( object,) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoAllocateController) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( its) S 
2400 9360 P (ControllerControl) S 60 J ( routine,) S 60 J ( described) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 11) S 
1920 9680 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( driver) S 60 J ( handles) S 60 J ( cancelable) S 60 J ( IRPs,) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoAcquireCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( and) S 60 J ( checking) S 
2400 9940 P (whether) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( has) S 60 J ( already) S 60 J ( been) S 60 J ( cancelled) S 
2400 10260 P (If) S 60 J ( the) S 60 J ( IRP) S 60 J ( could) S 60 J ( be) S 60 J ( cancelled) S 60 J ( before) S 60 J ( it) S 60 J ( is) S 60 J ( processed) S 60 J ( to) S 60 J ( completion,) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 
2400 10520 P (calls) S 60 J ( ) S 0 12 F 24 12 F B (IoSetCancelRoutine) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( IRP) S 60 J ( and) S 60 J ( its) S 60 J ( Cancel) S 60 J ( routine,) S 60 J ( described) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 12.) S 
2400 10780 P (The) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( also) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F (.) S 
1920 11160 P (Usually,) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( of) S 60 J ( a) S 60 J ( lowest-level) S 60 J ( NT) S 60 J ( driver) S 60 J ( must) S 60 J ( synchronize) S 60 J ( access) S 60 J ( to) S 60 J ( any) S 
1920 11420 P (memory) S 60 J ( or) S 60 J ( device) S 60 J ( registers) S 60 J ( it) S 60 J ( shares) S 60 J ( with) S 60 J ( the) S 60 J ( driver's) S 60 J ( ISR) S 60 J ( by) S 60 J ( calling) S 
1920 11680 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( SynchCritSection) S 60 J ( routine,) S 60 J ( described) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 10.) S 60 J ( In) S 60 J ( other) S 
1920 11940 P (words,) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( causes) S 60 J ( the) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( to) S 60 J ( actually) S 60 J ( program) S 60 J ( the) S 
1920 12200 P (physical) S 60 J ( device) S 60 J ( for) S 60 J ( I/O) S 60 J ( at) S 60 J ( DIRQL.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( how) S 60 J ( driver) S 60 J ( routines) S 60 J ( share) S 
1920 12460 P (memory) S 60 J ( with) S 60 J ( an) S 60 J ( ISR) S 60 J ( or) S 60 J ( share) S 60 J ( memory) S 60 J ( among) S 60 J ( routines) S 60 J ( other) S 60 J ( than) S 60 J ( the) S 60 J ( ISR) S 60 J ( in) S 60 J ( a) S 60 J ( multiprocessor-) S 
1920 12720 P (safe) S 60 J ( way,) S 60 J ( see) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( using) S 60 J ( spin) S 60 J ( locks) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 16.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (4) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2180 P 0 12 F 24 12 F (A) S 60 J ( higher-level) S 60 J ( NT) S 60 J ( driver) S 60 J ( can) S 60 J ( have) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( at) S 60 J ( the) S 60 J ( driver) S 60 J ( writer's) S 60 J ( discretion.) S 60 J ( In) S 60 J ( a) S 
1200 2440 P (higher-level) S 60 J ( driver,) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( has) S 60 J ( the) S 60 J ( following) S 60 J ( effects:) S 
1200 2760 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Incoming) S 60 J ( IRPs) S 60 J ( can) S 60 J ( be) S 60 J ( queued) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F () S 60 J ( from) S 60 J ( the) S 60 J ( driver's) S 60 J ( Dispatch) S 
1680 3020 P (routine\(s\)) S 60 J ( and) S 60 J ( ) S 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F () S 60 J ( from) S 60 J ( its) S 60 J ( IoCompletion) S 60 J ( routine\(s\),) S 60 J ( thereby) S 60 J ( having) S 60 J ( IRPs) S 
1680 3280 P (be) S 60 J ( processed) S 60 J ( one) S 60 J ( at) S 60 J ( a) S 60 J ( time) S 60 J ( through) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine.) S 
1200 3600 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( throughput) S 60 J ( could) S 60 J ( be) S 60 J ( slower) S 60 J ( during) S 60 J ( periods) S 60 J ( of) S 60 J ( heavy) S 60 J ( I/O) S 60 J ( demand,) S 
1680 3860 P (because) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( can) S 60 J ( become) S 60 J ( a) S 60 J ( bottleneck.) S 
1200 4180 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Such) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( reduces) S 60 J ( overall) S 60 J ( system) S 60 J ( throughput) S 60 J ( because) S 60 J ( any) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( is) S 
1680 4440 P (run) S 60 J ( at) S 60 J ( raised) S 60 J ( IRQL.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( the) S 60 J ( IRQLs) S 60 J ( at) S 60 J ( which) S 60 J ( standard) S 60 J ( driver) S 
1680 4700 P (routines) S 60 J ( are) S 60 J ( run,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 60 J ( For) S 60 J ( specific) S 60 J ( information) S 60 J ( about) S 60 J ( any) S 60 J ( particular) S 60 J ( standard) S 
1680 4960 P (routine,) S 60 J ( see) S 60 J ( the) S 60 J ( pertinent) S 60 J ( chapter) S 60 J ( among) S 60 J ( Chapters) S 60 J ( 5) S 60 J ( through) S 60 J ( 15.) S 
1200 5340 P (Few) S 60 J ( higher-level) S 60 J ( NT) S 60 J ( drivers) S 60 J ( have) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( because) S 60 J ( it) S 60 J ( can) S 60 J ( slow) S 60 J ( IRP) S 60 J ( processing) S 60 J ( both) S 
1200 5600 P (for) S 60 J ( the) S 60 J ( driver) S 60 J ( itself) S 60 J ( and) S 60 J ( for) S 60 J ( all) S 60 J ( drivers) S 60 J ( above) S 60 J ( and) S 60 J ( below) S 60 J ( it.) S 60 J ( For) S 60 J ( an) S 60 J ( exception) S 60 J ( to) S 60 J ( this) S 60 J ( general) S 60 J ( rule,) S 
1200 5860 P (see) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 12.) S 60 J ( Because) S 60 J ( this) S 60 J ( driver) S 60 J ( might) S 60 J ( already) S 
1200 6120 P (have) S 60 J ( buffered) S 60 J ( keystrokes) S 60 J ( from) S 60 J ( its) S 60 J ( device) S 60 J ( when) S 60 J ( it) S 60 J ( receives) S 60 J ( a) S 60 J ( read) S 60 J ( request,) S 60 J ( its) S 60 J ( DispatchRead) S 
1200 6380 P (routine,) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 6,) S 60 J ( queues) S 60 J ( these) S 60 J ( requests) S 60 J ( to) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 60 J ( StartIo) S 
1200 6640 P (routine.) S 
1200 7020 P (However,) S 60 J ( most) S 60 J ( higher-level) S 60 J ( NT) S 60 J ( drivers) S 60 J ( simply) S 60 J ( send) S 60 J ( IRPs) S 60 J ( to) S 60 J ( the) S 60 J ( underlying) S 60 J ( device) S 60 J ( driver\(s\)) S 
1200 7280 P (from) S 60 J ( their) S 60 J ( Dispatch) S 60 J ( routines) S 60 J ( \(see) S 60 J ( Chapter) S 60 J ( 6\)) S 60 J ( and) S 60 J ( do) S 60 J ( any) S 60 J ( necessary) S 60 J ( clean-up) S 60 J ( processing) S 60 J ( in) S 60 J ( their) S 
1200 7540 P (IoCompletion) S 60 J ( routines) S 60 J ( \(see) S 60 J ( Chapter) S 60 J ( 13\).) S 60 J ( Other) S 60 J ( higher-level) S 60 J ( NT) S 60 J ( drivers) S 60 J ( set) S 60 J ( up) S 60 J ( internal) S 60 J ( queues) S 
1200 7800 P (for) S 60 J ( IRPs) S 60 J ( that) S 60 J ( request) S 60 J ( particular) S 60 J ( kinds) S 60 J ( of) S 60 J ( operations.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 916 J ( 7-) S E B (5) S E B () S 720 J ( ) S E 
1920 2120 P 0 12 F 8 14 F B (7.3) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Requirements) S 78 J ( for) S 78 J ( Using) S 78 J ( Interlocked) S 78 J ( Queues) S 78 J ( or) S 78 J ( Device) S 78 J ( Queues) S E 
1920 2740 P 0 12 F 24 12 F (A) S 60 J ( lowest-level) S 60 J ( NT) S 60 J ( device) S 60 J ( driver) S 60 J ( either) S 60 J ( must) S 60 J ( have) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( or) S 60 J ( must) S 60 J ( set) S 60 J ( up) S 60 J ( and) S 60 J ( manage) S 
1920 3000 P (its) S 60 J ( own) S 60 J ( internal) S 60 J ( queue\(s\)) S 60 J ( of) S 60 J ( IRPs.) S 60 J ( A) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( can) S 60 J ( have) S 60 J ( its) S 60 J ( own) S 60 J ( internal) S 60 J ( queues) S 60 J ( of) S 
1920 3260 P (IRPs) S 60 J ( \(or) S 60 J ( even) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine\)) S 60 J ( at) S 60 J ( the) S 60 J ( discretion) S 60 J ( of) S 60 J ( the) S 60 J ( driver) S 60 J ( designer.) S 60 J ( Depending) S 60 J ( on) S 60 J ( the) S 
1920 3520 P (functionality) S 60 J ( required) S 60 J ( and) S 60 J ( the) S 60 J ( nature) S 60 J ( of) S 60 J ( the) S 60 J ( underlying) S 60 J ( device,) S 60 J ( the) S 60 J ( driver) S 60 J ( writer) S 60 J ( might) S 
1920 3780 P (implement) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( and) S 60 J ( set) S 60 J ( up) S 60 J ( one) S 60 J ( or) S 60 J ( more) S 60 J ( driver-managed) S 60 J ( supplemental) S 60 J ( queues) S 60 J ( for) S 
1920 4040 P (IRPs.) S 
1920 4420 P (The) S 60 J ( system) S 60 J ( provides) S 60 J ( support) S 60 J ( for) S 60 J ( the) S 60 J ( following) S 60 J ( kinds) S 60 J ( of) S 60 J ( internal) S 60 J ( queues) S 60 J ( that) S 60 J ( NT) S 60 J ( drivers) S 60 J ( can) S 
1920 4680 P (use:) S 
1920 5000 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( doubly) S 60 J ( linked) S 60 J ( interlocked) S 60 J ( queue) S 60 J ( into) S 60 J ( which) S 60 J ( the) S 60 J ( driver) S 60 J ( inserts) S 60 J ( IRPs) S 60 J ( by) S 60 J ( calling) S 
2400 5260 P 0 12 F 24 12 F B (ExInterlockedInsertTailList) S E 0 12 F 24 12 F () S 60 J ( or) S 60 J ( ) S 0 12 F 24 12 F B (ExInterlockedInsertHeadList) S E 0 12 F 24 12 F (,) S 60 J ( and) S 60 J ( from) S 60 J ( which) S 60 J ( a) S 
2400 5520 P (device-dedicated) S 60 J ( thread,) S 60 J ( worker-thread) S 60 J ( callback,) S 60 J ( or) S 60 J ( another) S 60 J ( driver) S 60 J ( routine) S 60 J ( removes) S 60 J ( IRPs) S 
2400 5780 P (by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (ExInterlockedRemoveHeadList) S E 
1920 6100 P 0 12 F 24 12 F () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( singly) S 60 J ( linked) S 60 J ( interlocked) S 60 J ( queue) S 60 J ( into) S 60 J ( which) S 60 J ( the) S 60 J ( driver) S 60 J ( inserts) S 60 J ( IRPs) S 60 J ( by) S 60 J ( calling) S 
2400 6360 P 0 12 F 24 12 F B (ExInterlockedPushEntryList) S E 0 12 F 24 12 F (,) S 60 J ( and) S 60 J ( from) S 60 J ( which) S 60 J ( a) S 60 J ( device-dedicated) S 60 J ( thread,) S 60 J ( worker-thread) S 
2400 6620 P (callback,) S 60 J ( or) S 60 J ( another) S 60 J ( driver) S 60 J ( routine) S 60 J ( removes) S 60 J ( IRPs) S 60 J ( by) S 60 J ( calling) S 
2400 6880 P 0 12 F 24 12 F B (ExInterlockedPopEntryList) S E 0 12 F 24 12 F (,) S 60 J ( provided) S 60 J ( that) S 60 J ( the) S 60 J ( driver) S 60 J ( never) S 60 J ( retries) S 60 J ( operations) S 
1920 7200 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( device) S 60 J ( queue) S 60 J ( associated) S 60 J ( with) S 60 J ( a) S 60 J ( device) S 60 J ( object) S 60 J ( into) S 60 J ( which) S 60 J ( the) S 60 J ( driver) S 60 J ( can) S 60 J ( insert) S 60 J ( IRPs) S 60 J ( by) S 
2400 7460 P (calling) S 60 J ( ) S 0 12 F 24 12 F B (KeInsertDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( or) S 60 J ( ) S 0 12 F 24 12 F B (KeInsertByKeyDeviceQueue) S E 0 12 F 24 12 F (,) S 60 J ( and) S 60 J ( from) S 60 J ( which) S 60 J ( it) S 60 J ( can) S 
2400 7720 P (remove) S 60 J ( IRPs) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveDeviceQueue) S E 0 12 F 24 12 F (,) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveByKeyDeviceQueue) S E 0 12 F 24 12 F (,) S 60 J ( or) S 
2400 7980 P 0 12 F 24 12 F B (KeRemoveEntryDeviceQueue) S E 
2400 8300 P 0 12 F 24 12 F (If) S 60 J ( the) S 60 J ( driver) S 60 J ( has) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine,) S 60 J ( it) S 60 J ( can) S 60 J ( remove) S 60 J ( IRPs) S 60 J ( from) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( by) S 60 J ( calling) S 
2400 8560 P 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F () S 60 J ( or) S 60 J ( ) S 0 12 F 24 12 F B (IoStartNextPacketByKey) S E 0 12 F 24 12 F (,) S 60 J ( as) S 60 J ( described) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 4.) S 
1920 8940 P (An) S 60 J ( interlocked) S 60 J ( queue) S 60 J ( is) S 60 J ( simpler) S 60 J ( to) S 60 J ( manage,) S 60 J ( particularly) S 60 J ( for) S 60 J ( drivers) S 60 J ( with) S 60 J ( device-dedicated) S 
1920 9200 P (threads.) S 60 J ( On) S 60 J ( the) S 60 J ( other) S 60 J ( hand,) S 60 J ( device) S 60 J ( queues) S 60 J ( give) S 60 J ( the) S 60 J ( driver) S 60 J ( more) S 60 J ( control) S 60 J ( over) S 60 J ( whether) S 60 J ( a) S 60 J ( given) S 
1920 9460 P (IRP) S 60 J ( is) S 60 J ( placed) S 60 J ( in) S 60 J ( the) S 60 J ( queue) S 60 J ( and) S 60 J ( over) S 60 J ( the) S 60 J ( ordering) S 60 J ( of) S 60 J ( entries) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( queue.) S 
1920 9840 P (The) S 60 J ( ) S 0 12 F 24 12 F B (KeInsert..DeviceQueue) S E 0 12 F 24 12 F () S 60 J ( routines) S 60 J ( return) S 60 J ( a) S 60 J ( Boolean) S 60 J ( value,) S 60 J ( indicating) S 60 J ( whether) S 60 J ( the) S 60 J ( input) S 
1920 10100 P (IRP) S 60 J ( was) S 60 J ( inserted) S 60 J ( into) S 60 J ( the) S 60 J ( device) S 60 J ( queue.) S 60 J ( As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 3,) S 60 J ( ) S 0 12 F 24 12 F B (KeInsertDeviceQueue) S E 
1920 10360 P 0 12 F 24 12 F (either) S 60 J ( inserts) S 60 J ( an) S 60 J ( entry) S 60 J ( at) S 60 J ( the) S 60 J ( tail) S 60 J ( of) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( and) S 60 J ( sets) S 60 J ( the) S 60 J ( state) S 60 J ( of) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 
1920 10620 P (object) S 60 J ( to) S 60 J ( Busy,) S 60 J ( or) S 60 J ( it) S 60 J ( simply) S 60 J ( sets) S 60 J ( the) S 60 J ( state) S 60 J ( to) S 60 J ( Busy) S 60 J ( and) S 60 J ( returns) S 60 J ( FALSE) S 60 J ( to) S 60 J ( indicate) S 60 J ( that) S 60 J ( the) S 60 J ( IRP) S 
1920 10880 P (was) S 60 J ( not) S 60 J ( queued.) S 60 J ( If) S 60 J ( the) S 60 J ( return) S 60 J ( value) S 60 J ( is) S 60 J ( FALSE,) S 60 J ( the) S 60 J ( caller) S 60 J ( must) S 60 J ( pass) S 60 J ( the) S 60 J ( IRP) S 60 J ( on) S 60 J ( for) S 60 J ( further) S 
1920 11140 P (processing) S 60 J ( by) S 60 J ( another) S 60 J ( driver) S 60 J ( routine.) S 60 J ( In) S 60 J ( addition,) S 60 J ( a) S 60 J ( driver) S 60 J ( can) S 60 J ( impose) S 60 J ( a) S 60 J ( driver-determined) S 
1920 11400 P (order) S 60 J ( on) S 60 J ( the) S 60 J ( processing) S 60 J ( of) S 60 J ( IRPs) S 60 J ( in) S 60 J ( a) S 60 J ( device) S 60 J ( queue) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (KeInsertByKeyDeviceQueue) S E 0 12 F 24 12 F (.) S 
1920 11780 P (A) S 60 J ( driver) S 60 J ( can) S 60 J ( remove) S 60 J ( an) S 60 J ( IRP) S 60 J ( \(or) S 60 J ( reset) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( state) S 60 J ( to) S 60 J ( Not-Busy\)) S 60 J ( by) S 60 J ( calling) S 
1920 12040 P 0 12 F 24 12 F B (KeRemoveDeviceQueue) S E 0 12 F 24 12 F (.) S 60 J ( The) S 60 J ( driver) S 60 J ( also) S 60 J ( can) S 60 J ( remove) S 60 J ( a) S 60 J ( particular) S 60 J ( entry) S 60 J ( \(or) S 60 J ( determine) S 60 J ( whether) S 
1920 12300 P (it) S 60 J ( is) S 60 J ( currently) S 60 J ( queued\)) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveEntryDeviceQueue) S E 0 12 F 24 12 F (.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (6) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( any) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( either) S 60 J ( kind) S 60 J ( of) S 60 J ( queue) S 60 J ( must) S 60 J ( provide) S 60 J ( storage) S 60 J ( for) S 60 J ( the) S 60 J ( necessary) S 60 J ( NT) S 
1200 2320 P (objects) S 60 J ( and) S 60 J ( resources.) S 60 J ( NT) S 60 J ( drivers) S 60 J ( usually) S 60 J ( provide) S 60 J ( this) S 60 J ( storage) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( extensions) S 60 J ( of) S 60 J ( their) S 
1200 2580 P (device) S 60 J ( objects,) S 60 J ( but) S 60 J ( they) S 60 J ( can) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (ExAllocatePool) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F I (PoolType) S E 0 12 F 24 12 F () S 60 J ( ) S 0 12 F 24 12 F B (NonPagedPool) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( allocate) S 
1200 2840 P (the) S 60 J ( storage) S 60 J ( or) S 60 J ( can) S 60 J ( provide) S 60 J ( storage) S 60 J ( in) S 60 J ( a) S 60 J ( controller) S 60 J ( extension) S 60 J ( if) S 60 J ( they) S 60 J ( use) S 60 J ( controller) S 60 J ( objects.) S 60 J ( For) S 
1200 3100 P (more) S 60 J ( information) S 60 J ( about) S 60 J ( allocating) S 60 J ( pool) S 60 J ( memory,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 
1200 3480 P (If) S 60 J ( it) S 60 J ( uses) S 60 J ( either) S 60 J ( kind) S 60 J ( of) S 60 J ( queue,) S 60 J ( an) S 60 J ( NT) S 60 J ( driver) S 60 J ( must) S 60 J ( provide) S 60 J ( storage) S 60 J ( for) S 60 J ( the) S 60 J ( following:) S 
1200 3800 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( For) S 60 J ( an) S 60 J ( interlocked) S 60 J ( queue,) S 60 J ( storage) S 60 J ( both) S 60 J ( for) S 60 J ( an) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock,) S 60 J ( required) S 60 J ( as) S 60 J ( an) S 
1680 4060 P (argument) S 60 J ( to) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (ExInterlocked..List) S E 0 12 F 24 12 F () S 60 J ( routines,) S 60 J ( and) S 60 J ( for) S 60 J ( the) S 60 J ( queue) S 60 J ( header) S 
1680 4380 P (For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( using) S 60 J ( spin) S 60 J ( locks,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 
1200 4700 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( For) S 60 J ( a) S 60 J ( device) S 60 J ( queue,) S 60 J ( storage) S 60 J ( for) S 60 J ( a) S 60 J ( Kernel-defined) S 60 J ( device) S 60 J ( queue) S 60 J ( object) S 
1680 5020 P (While) S 60 J ( each) S 60 J ( device) S 60 J ( queue) S 60 J ( object) S 60 J ( has) S 60 J ( an) S 60 J ( associated) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock) S 60 J ( and) S 60 J ( a) S 60 J ( queue) S 
1680 5280 P (header,) S 60 J ( storage) S 60 J ( for) S 60 J ( these) S 60 J ( resources) S 60 J ( is) S 60 J ( allocated) S 60 J ( automatically) S 60 J ( when) S 60 J ( the) S 60 J ( driver) S 60 J ( provides) S 
1680 5540 P (storage) S 60 J ( for) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( object.) S 
1200 5920 P (The) S 60 J ( DriverEntry) S 60 J ( routine) S 60 J ( must) S 60 J ( set) S 60 J ( up) S 60 J ( either) S 60 J ( kind) S 60 J ( of) S 60 J ( queue,) S 60 J ( as) S 60 J ( follows:) S 
1200 6240 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( For) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( an) S 60 J ( interlocked) S 60 J ( queue,) S 60 J ( the) S 60 J ( DriverEntry) S 60 J ( routine) S 60 J ( must) S 60 J ( initialize) S 60 J ( the) S 
1680 6500 P (queue) S 60 J ( header) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (InitializeListHead) S E 0 12 F 24 12 F (,) S 60 J ( which) S 60 J ( is) S 60 J ( an) S 60 J ( NT-supplied) S 60 J ( kernel-mode) S 
1680 6760 P (runtime) S 60 J ( library) S 60 J ( routine.) S 60 J ( It) S 60 J ( also) S 60 J ( must) S 60 J ( initialize) S 60 J ( the) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock) S 60 J ( by) S 60 J ( calling) S 
1680 7020 P 0 12 F 24 12 F B (KeInitializeSpinLock) S E 0 12 F 24 12 F (.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( setting) S 60 J ( up) S 60 J ( an) S 60 J ( interlocked) S 60 J ( queue,) S 60 J ( see) S 
1680 7280 P (Chapter) S 60 J ( 3.) S 
1200 7600 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( For) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( a) S 60 J ( device) S 60 J ( queue,) S 60 J ( the) S 60 J ( DriverEntry) S 60 J ( routine) S 60 J ( must) S 60 J ( call) S 
1680 7860 P 0 12 F 24 12 F B (KeInitializeDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( initialize) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( object.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 
1680 8120 P (about) S 60 J ( setting) S 60 J ( up) S 60 J ( a) S 60 J ( device) S 60 J ( queue) S 60 J ( object,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 3.) S 
1200 8500 P (IRPs) S 60 J ( can) S 60 J ( be) S 60 J ( inserted) S 60 J ( into) S 60 J ( or) S 60 J ( removed) S 60 J ( from) S 60 J ( either) S 60 J ( kind) S 60 J ( of) S 60 J ( queue) S 60 J ( by) S 60 J ( calling) S 60 J ( the) S 60 J ( appropriate) S 
1200 8760 P 0 12 F 24 12 F B (ExInterlocked..List) S E 0 12 F 24 12 F () S 60 J ( or) S 60 J ( ) S 0 12 F 24 12 F B (Ke..DeviceQueue) S E 0 12 F 24 12 F () S 60 J ( support) S 60 J ( routine) S 60 J ( with) S 60 J ( the) S 60 J ( corresponding) S 60 J ( IRP-) S 
1200 9020 P (specific) S 60 J ( argument:) S 
1200 9340 P () S 664 J ( ) S 296 J ( ) S 0 12 F 24 12 F B (&Irp->Tail.Overlay.ListEntry) S E 
1200 9660 P 0 12 F 24 12 F () S 224 J ( ) S 256 J ( or) S 
1200 9980 P () S 664 J ( ) S 296 J ( ) S 0 12 F 24 12 F B (&Irp->Tail.Overlay.DeviceQueueEntry) S E 
1200 10360 P 0 12 F 24 12 F (NT) S 60 J ( drivers) S 60 J ( also) S 60 J ( can) S 60 J ( set) S 60 J ( up) S 60 J ( internal) S 60 J ( queues) S 60 J ( or) S 60 J ( buffers) S 60 J ( for) S 60 J ( driver-defined) S 60 J ( data) S 60 J ( structures.) S 60 J ( For) S 
1200 10620 P (example,) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( sets) S 60 J ( up) S 60 J ( a) S 60 J ( ring) S 60 J ( buffer) S 60 J ( for) S 60 J ( data) S 60 J ( coming) S 60 J ( in) S 
1200 10880 P (from) S 60 J ( the) S 60 J ( physical) S 60 J ( device.) S 60 J ( The) S 60 J ( closely) S 60 J ( coupled) S 60 J ( i8042) S 60 J ( port) S 60 J ( driver,) S 60 J ( described) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 2,) S 60 J ( calls) S 
1200 11140 P (the) S 60 J ( class) S 60 J ( driver) S 60 J ( from) S 60 J ( the) S 60 J ( i8042) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( to) S 60 J ( move) S 60 J ( keyboard) S 60 J ( scan) S 60 J ( codes) S 60 J ( from) S 
1200 11400 P (the) S 60 J ( port) S 60 J ( driver's) S 60 J ( input) S 60 J ( data) S 60 J ( queue) S 60 J ( into) S 60 J ( this) S 60 J ( ring) S 60 J ( buffer.) S 
1200 11780 P (If) S 60 J ( a) S 60 J ( new) S 60 J ( NT) S 60 J ( driver) S 60 J ( needs) S 60 J ( an) S 60 J ( internal) S 60 J ( queue) S 60 J ( for) S 60 J ( an) S 60 J ( indefinite) S 60 J ( \(but) S 60 J ( limited) S 60 J ( at) S 60 J ( any) S 60 J ( given) S 60 J ( moment\)) S 
1200 12040 P (number) S 60 J ( of) S 60 J ( fixed-size) S 60 J ( entries,) S 60 J ( a) S 60 J ( zone) S 60 J ( buffer) S 60 J ( can) S 60 J ( be) S 60 J ( useful.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( using) S 
1200 12300 P (zones,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 60 J ( For) S 60 J ( specific) S 60 J ( information) S 60 J ( about) S 60 J ( calling) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Ex...Zone) S E 0 12 F 24 12 F () S 60 J ( routines,) S 60 J ( see) S 60 J ( the) S 
1200 12560 P 0 12 F 24 12 F I (Kernel-mode) S 60 J ( Driver) S 60 J ( Reference) S E 0 12 F 24 12 F (.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 916 J ( 7-) S E B (7) S E B () S 720 J ( ) S E 
1920 2120 P 0 12 F 8 14 F B (7.4) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Implementing) S 78 J ( a) S 78 J ( StartIo) S 78 J ( Routine) S E 
1920 2740 P 0 12 F 24 12 F (As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 6,) S 60 J ( IRPs) S 60 J ( coming) S 60 J ( in) S 60 J ( to) S 60 J ( a) S 60 J ( device) S 60 J ( driver's) S 60 J ( Dispatch) S 60 J ( routines) S 60 J ( do) S 60 J ( not) S 
1920 3000 P (necessarily) S 60 J ( require) S 60 J ( the) S 60 J ( driver) S 60 J ( to) S 60 J ( do) S 60 J ( I/O) S 60 J ( processing) S 60 J ( on) S 60 J ( its) S 60 J ( device.) S 60 J ( Usually,) S 60 J ( each) S 60 J ( driver's) S 
1920 3260 P (Dispatch) S 60 J ( routine\(s\)) S 60 J ( complete) S 60 J ( a) S 60 J ( subset) S 60 J ( of) S 60 J ( required) S 60 J ( requests,) S 60 J ( as) S 60 J ( well) S 60 J ( as) S 60 J ( those) S 60 J ( that) S 60 J ( have) S 
1920 3520 P (parameter) S 60 J ( errors) S 60 J ( in) S 60 J ( the) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( of) S 60 J ( the) S 60 J ( input) S 60 J ( IRP.) S 60 J ( However,) S 60 J ( every) S 60 J ( device) S 
1920 3780 P (driver) S 60 J ( with) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( is) S 60 J ( likely) S 60 J ( to) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( IRPs) S 60 J ( for) S 60 J ( IRP_MJ_READ) S 
1920 4040 P (and/or) S 60 J ( IRP_MJ_WRITE) S 60 J ( requests,) S 60 J ( as) S 60 J ( well) S 60 J ( as) S 60 J ( for) S 60 J ( at) S 60 J ( least) S 60 J ( a) S 60 J ( subset) S 60 J ( of) S 60 J ( the) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( it) S 
1920 4300 P (supports) S 60 J ( for) S 60 J ( IRP_MJ_DEVICE_CONTROL) S 60 J ( requests.) S 
1920 4680 P (A) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( is) S 60 J ( the) S 60 J ( second) S 60 J ( stage) S 60 J ( in) S 60 J ( satisfying) S 60 J ( a) S 60 J ( device) S 60 J ( I/O) S 60 J ( request.) S 60 J ( When) S 60 J ( a) S 60 J ( Dispatch) S 
1920 4940 P (routine) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( such) S 60 J ( an) S 60 J ( IRP,) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( either) S 60 J ( passes) S 60 J ( the) S 60 J ( IRP) S 60 J ( directly) S 
1920 5200 P (to) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( for) S 60 J ( further) S 60 J ( processing) S 60 J ( or) S 60 J ( inserts) S 60 J ( the) S 60 J ( packet) S 60 J ( into) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 
1920 5460 P (associated) S 60 J ( with) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 60 J ( when) S 60 J ( it) S 60 J ( was) S 60 J ( created.) S 
1920 5840 P (As) S 60 J ( a) S 60 J ( general) S 60 J ( rule,) S 60 J ( a) S 60 J ( device) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( buffered) S 60 J ( I/O) S 60 J ( has) S 60 J ( a) S 60 J ( simpler) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( than) S 60 J ( one) S 
1920 6100 P (that) S 60 J ( uses) S 60 J ( direct) S 60 J ( I/O.) S 60 J ( Drivers) S 60 J ( that) S 60 J ( use) S 60 J ( buffered) S 60 J ( I/O) S 60 J ( generally) S 60 J ( transfer) S 60 J ( small) S 60 J ( amounts) S 60 J ( of) S 60 J ( data) S 60 J ( for) S 
1920 6360 P (each) S 60 J ( transfer) S 60 J ( request,) S 60 J ( while) S 60 J ( those) S 60 J ( that) S 60 J ( use) S 60 J ( direct) S 60 J ( I/O) S 60 J ( \(whether) S 60 J ( DMA) S 60 J ( or) S 60 J ( PIO\)) S 60 J ( transfer) S 60 J ( large) S 
1920 6620 P (amounts) S 60 J ( of) S 60 J ( data) S 60 J ( from) S 60 J ( locked-down) S 60 J ( user) S 60 J ( buffers) S 60 J ( that) S 60 J ( can) S 60 J ( span) S 60 J ( physical) S 60 J ( page) S 60 J ( boundaries.) S 60 J ( For) S 
1920 6880 P (more) S 60 J ( information) S 60 J ( about) S 60 J ( using) S 60 J ( buffered) S 60 J ( and) S 60 J ( direct) S 60 J ( I/O,) S 60 J ( see) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( device) S 60 J ( objects) S 60 J ( in) S 
1920 7140 P (Chapter) S 60 J ( 3.) S 
1920 7780 P 0 12 F 8 12 F B (7.4.1) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( StartIo) S 67 J ( Routines) S 67 J ( in) S 67 J ( Drivers) S 67 J ( Using) S 67 J ( Buffered) S 67 J ( I/O) S E 
1920 8400 P 0 12 F 24 12 F (A) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( buffered) S 60 J ( I/O) S 60 J ( either) S 60 J ( transfers) S 60 J ( data) S 60 J ( into) S 60 J ( \(reads\)) S 60 J ( or) S 60 J ( from) S 60 J ( \(writes\)) S 60 J ( a) S 60 J ( system-) S 
1920 8660 P (space) S 60 J ( buffer,) S 60 J ( allocated) S 60 J ( by) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager,) S 60 J ( that) S 60 J ( the) S 60 J ( driver) S 60 J ( finds) S 60 J ( in) S 60 J ( each) S 60 J ( IRP) S 60 J ( at) S 
1920 8920 P 0 12 F 24 12 F B (Irp->AssociatedIrp.SystemBuffer) S E 0 12 F 24 12 F (.) S 60 J ( Assuming) S 60 J ( its) S 60 J ( DispatchRead,) S 60 J ( DispatchWrite,) S 60 J ( or) S 
1920 9180 P (DispatchDeviceControl) S 60 J ( routine) S 60 J ( determined) S 60 J ( that) S 60 J ( a) S 60 J ( request) S 60 J ( was) S 60 J ( valid) S 60 J ( and) S 60 J ( called) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F (,) S 
1920 9440 P (its) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( to) S 60 J ( process) S 60 J ( the) S 60 J ( packet) S 60 J ( next.) S 
1920 9820 P (The) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( determines) S 60 J ( which) S 60 J ( operation) S 60 J ( must) S 60 J ( be) S 60 J ( performed) S 60 J ( to) S 60 J ( satisfy) S 60 J ( the) S 60 J ( request) S 60 J ( and) S 60 J ( is) S 
1920 10080 P (responsible) S 60 J ( for) S 60 J ( programming) S 60 J ( the) S 60 J ( physical) S 60 J ( device) S 60 J ( for) S 60 J ( that) S 60 J ( operation.) S 60 J ( Note) S 60 J ( that) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 
1920 10340 P (must) S 60 J ( call) S 60 J ( a) S 60 J ( device) S 60 J ( driver's) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( to) S 60 J ( perform) S 60 J ( the) S 60 J ( necessary) S 60 J ( programming) S 60 J ( if) S 
1920 10600 P (access) S 60 J ( to) S 60 J ( the) S 60 J ( physical) S 60 J ( device) S 60 J ( \(and/or) S 60 J ( the) S 60 J ( device) S 60 J ( extension\)) S 60 J ( must) S 60 J ( be) S 60 J ( synchronized) S 60 J ( with) S 60 J ( the) S 
1920 10860 P (driver's) S 60 J ( ISR.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (8) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (For) S 60 J ( example,) S 60 J ( a) S 60 J ( parallel) S 60 J ( driver's) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( could) S 60 J ( queue) S 60 J ( IRPs) S 60 J ( with) S 60 J ( valid) S 60 J ( parameters) S 60 J ( in) S 
1200 2320 P (the) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( to) S 60 J ( its) S 60 J ( ParStartIo) S 60 J ( routine) S 60 J ( for) S 60 J ( further) S 60 J ( processing.) S 60 J ( Such) S 60 J ( a) S 60 J ( ParStartIo) S 
1200 2580 P (routine) S 60 J ( first) S 60 J ( would) S 60 J ( determine) S 60 J ( whether) S 60 J ( to) S 60 J ( write) S 60 J ( data) S 60 J ( through) S 60 J ( the) S 60 J ( parallel) S 60 J ( port) S 60 J ( or) S 60 J ( to) S 60 J ( perform) S 60 J ( the) S 
1200 2840 P (requested) S 60 J ( I/O) S 60 J ( control) S 60 J ( operation,) S 60 J ( as) S 60 J ( follows:) S 
1680 3360 P 0 12 F 0 12 F ({) S 
1680 3620 P () S 480 J ( PPAR_DEVICE_EXTENSION) S 144 J ( extension) S 144 J ( =) S 
1680 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
1680 4140 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
1680 4660 P (//) S 
1680 4920 P (//) S 144 J ( Increment) S 144 J ( the) S 144 J ( following) S 144 J ( to) S 144 J ( get) S 144 J ( a) S 144 J ( unique) S 144 J ( value) S 144 J ( to) S 144 J ( give) S 
1680 5180 P (//) S 144 J ( to) S 144 J ( the) S 144 J ( error) S 144 J ( log) S 144 J ( routine,) S 144 J ( if) S 144 J ( necessary.) S 
1680 5440 P (//) S 
1680 5700 P () S 480 J ( extension->IrpSequence++;) S 
1680 5960 P () S 480 J ( if) S 144 J ( \(irpSp->MajorFunction) S 144 J ( ==) S 144 J ( IRP_MJ_WRITE\)) S 144 J ( {) S 
1680 6220 P () S 480 J ( ) S 480 J ( ParSynchronizeExecution\() S 
1680 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension,) S 
1680 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ParStartCriticalFunctions,) S 
1680 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject\);) S 
1680 7260 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 7520 P (//) S 
1680 7780 P (//) S 144 J ( MajorFunction) S 144 J ( is) S 144 J ( IRP_MJ_DEVICE_CONTROL.) S 
1680 8040 P (//) S 
1680 8300 P () S 480 J ( ) S 480 J ( CONTROL_AREA) S 144 J ( ioControlArea;) S 
1680 8560 P () S 480 J ( ) S 480 J ( ioControlArea.Extension) S 144 J ( =) S 144 J ( extension;) S 
1680 8820 P () S 480 J ( ) S 480 J ( ioControlArea.Irp) S 144 J ( =) S 144 J ( Irp;) S 
1680 9080 P () S 480 J ( ) S 480 J ( ParSynchronizeExecution\() S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension,) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ParManageIoDevice,) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &ioControlArea\);) S 
1680 10120 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(irpSp->Parameters.DeviceIoControl.) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoControlCode) S 144 J ( ==) S 
1680 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IOCTL_PAR_QUERY_INFORMATION\)) S 144 J ( {) S 
1680 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( PPAR_QUERY_INFORMATION) S 144 J ( irpBuffer) S 144 J ( =) S 
1680 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->AssociatedIrp.SystemBuffer;) S 
1680 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 916 J ( 7-) S E B (9) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Interpreting) S 144 J ( Status) S 144 J ( and) S 144 J ( Control.) S 
2400 2580 P (//) S 
2400 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( irpBuffer->Status) S 144 J ( =) S 144 J ( 0x0;) S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(PAR_POWERED_OFF\(ioControlArea.Status\)) S 144 J ( ||) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( PAR_NO_CABLE\(ioControlArea.Status\)\)) S 144 J ( {) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpBuffer->) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Status) S 144 J ( =) S 144 J ( \(UCHAR\)\(irpBuffer->) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Status) S 144 J ( |) S 144 J ( PARALLEL_POWER_OFF\);) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( if) S 144 J ( \(PAR_PAPER_EMPTY\() S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ioControlArea.Status\)\)) S 144 J ( {) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( query) S 144 J ( device) S 144 J ( status) S 144 J ( values) S 
2400 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 
2400 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sizeof\(PAR_QUERY_INFORMATION\);) S 
2400 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoStartNextPacket\() S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject,) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( TRUE\);) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoCompleteRequest\() S 
2400 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp,) S 
2400 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IO_NO_INCREMENT\);) S 
2400 7520 P () S 480 J ( ) S 480 J ( }) S 
2400 7780 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( else) S 144 J ( IRP_MJ_DEVICE_CONTROL) S 
2400 8040 P (}) S 
1920 8420 P 0 12 F 24 12 F (Depending) S 60 J ( on) S 60 J ( the) S 60 J ( requested) S 60 J ( operation,) S 60 J ( the) S 60 J ( preceding) S 60 J ( ParStartIo) S 60 J ( routine) S 60 J ( calls) S 60 J ( the) S 
1920 8680 P (ParSynchronizeExecution) S 60 J ( routine) S 60 J ( with) S 60 J ( either) S 60 J ( of) S 60 J ( two) S 60 J ( SynchCritSection) S 60 J ( routines:) S 
1920 8940 P (ParStartCriticalFunctions) S 60 J ( to) S 60 J ( set) S 60 J ( up) S 60 J ( the) S 60 J ( port) S 60 J ( controller) S 60 J ( to) S 60 J ( write) S 60 J ( characters) S 60 J ( from) S 60 J ( the) S 60 J ( buffer) S 60 J ( at) S 
1920 9200 P 0 12 F 24 12 F B (Irp->AssociatedIrp.SystemBuffer) S E 0 12 F 24 12 F (,) S 60 J ( or) S 60 J ( ParManageIoDevice) S 60 J ( for) S 60 J ( device) S 60 J ( control) S 60 J ( requests) S 60 J ( with) S 
1920 9460 P (the) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( IOCTL_PAR_QUERY_DEVICE) S 60 J ( and) S 60 J ( IOCTL_PAR_SET_DEVICE.) S 
1920 9840 P (If) S 60 J ( such) S 60 J ( a) S 60 J ( parallel) S 60 J ( driver) S 60 J ( schedules) S 60 J ( work) S 60 J ( for) S 60 J ( the) S 60 J ( parallel) S 60 J ( port) S 60 J ( controller) S 60 J ( using) S 60 J ( an) S 60 J ( interrupt) S 
1920 10100 P (object,) S 60 J ( the) S 60 J ( ParSynchronizeExecution) S 60 J ( routine) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( given) S 
1920 10360 P (SynchCritSection) S 60 J ( routine,) S 60 J ( which) S 60 J ( is) S 60 J ( run) S 60 J ( at) S 60 J ( DIRQL.) S 60 J ( Otherwise,) S 60 J ( this) S 60 J ( driver) S 60 J ( schedules) S 60 J ( work) S 60 J ( using) S 
1920 10620 P (a) S 60 J ( timer) S 60 J ( object) S 60 J ( with) S 60 J ( a) S 60 J ( CustomTimerDpc) S 60 J ( routine) S 60 J ( either) S 60 J ( because) S 60 J ( it) S 60 J ( could) S 60 J ( not) S 60 J ( claim) S 60 J ( an) S 60 J ( interrupt) S 
1920 10880 P (vector) S 60 J ( when) S 60 J ( it) S 60 J ( initialized,) S 60 J ( or) S 60 J ( because) S 60 J ( the) S 60 J ( driver) S 60 J ( has) S 60 J ( disabled) S 60 J ( device) S 60 J ( interrupts) S 60 J ( due) S 60 J ( to) S 60 J ( interrupt) S 
1920 11140 P (storms.) S 60 J ( If) S 60 J ( this) S 60 J ( parallel) S 60 J ( driver) S 60 J ( is) S 60 J ( using) S 60 J ( a) S 60 J ( timer,) S 60 J ( ParSynchronizeExecution) S 60 J ( is) S 60 J ( run) S 60 J ( at) S 60 J ( IRQL) S 
1920 11400 P (DISPATCH_LEVEL) S 60 J ( instead) S 60 J ( of) S 60 J ( DIRQL,) S 60 J ( and) S 60 J ( ParSynchronizeExecution) S 60 J ( uses) S 60 J ( a) S 60 J ( spin) S 60 J ( lock) S 60 J ( to) S 
1920 11660 P (protect) S 60 J ( the) S 60 J ( driver's) S 60 J ( device) S 60 J ( extension) S 60 J ( from) S 60 J ( simultaneous) S 60 J ( access) S 60 J ( by) S 60 J ( the) S 60 J ( driver-supplied) S 
1920 11920 P (CustomTimerDpc.) S 
1920 12300 P (For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( SynchCritSection) S 60 J ( and) S 60 J ( CustomTimerDpc) S 60 J ( routines,) S 60 J ( see) S 60 J ( Chapters) S 60 J ( 10) S 
1920 12560 P (and) S 60 J ( 14,) S 60 J ( respectively.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( using) S 60 J ( interrupt) S 60 J ( and) S 60 J ( executive) S 60 J ( spin) S 60 J ( locks,) S 60 J ( see) S 
1920 12820 P (Chapter) S 60 J ( 16.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (10) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2080 P 0 12 F 8 12 F B (7.4.2) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( StartIo) S 67 J ( Routines) S 67 J ( in) S 67 J ( Drivers) S 67 J ( Using) S 67 J ( Direct) S 67 J ( I/O) S E 
1200 2700 P 0 12 F 24 12 F (A) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( direct) S 60 J ( I/O) S 60 J ( either) S 60 J ( reads) S 60 J ( data) S 60 J ( into) S 60 J ( or) S 60 J ( writes) S 60 J ( data) S 60 J ( from) S 60 J ( a) S 60 J ( locked-down) S 60 J ( user) S 
1200 2960 P (buffer,) S 60 J ( described) S 60 J ( by) S 60 J ( a) S 60 J ( memory) S 60 J ( descriptor) S 60 J ( list) S 60 J ( \(MDL\),) S 60 J ( that) S 60 J ( the) S 60 J ( driver) S 60 J ( finds) S 60 J ( in) S 60 J ( the) S 60 J ( IRP) S 60 J ( at) S 
1200 3220 P 0 12 F 24 12 F B (Irp->MdlAddress) S E 0 12 F 24 12 F (.) S 
1200 3600 P (As) S 60 J ( a) S 60 J ( type) S 60 J ( defined) S 60 J ( by,) S 60 J ( used) S 60 J ( exclusively) S 60 J ( by,) S 60 J ( and) S 60 J ( \(possibly,) S 60 J ( for) S 60 J ( new) S 60 J ( platforms\)) S 60 J ( changable) S 60 J ( by) S 60 J ( the) S 
1200 3860 P (NT) S 60 J ( Memory) S 60 J ( Manager,) S 60 J ( all) S 60 J ( MDLs) S 60 J ( are) S 60 J ( opaque) S 60 J ( to) S 60 J ( drivers.) S 60 J ( Consequently,) S 60 J ( NT) S 60 J ( drivers) S 60 J ( ) S 0 12 F 24 12 F I (cannot) S E 0 12 F 24 12 F () S 60 J ( use) S 
1200 4120 P (the) S 60 J ( address) S 60 J ( mappings) S 60 J ( contained) S 60 J ( in) S 60 J ( an) S 60 J ( MDL) S 60 J ( directly.) S 60 J ( Instead,) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( PIO) S 60 J ( remap) S 60 J ( user-) S 
1200 4380 P (space) S 60 J ( buffers) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (MmGetSystemAddressForMdl) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Irp->MdlAddress) S E 0 12 F 24 12 F (,) S 60 J ( and) S 
1200 4640 P (drivers) S 60 J ( that) S 60 J ( use) S 60 J ( DMA) S 60 J ( also) S 60 J ( pass) S 60 J ( this) S 60 J ( pointer) S 60 J ( to) S 60 J ( support) S 60 J ( routines) S 60 J ( during) S 60 J ( their) S 60 J ( transfer) S 60 J ( operations) S 
1200 4900 P (\(see) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( adapter) S 60 J ( objects) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 3) S 60 J ( for) S 60 J ( more) S 60 J ( information\).) S 
1200 5280 P (Since) S 60 J ( the) S 60 J ( system) S 60 J ( defines) S 60 J ( the) S 60 J ( required) S 60 J ( device-type-specific) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( for) S 
1200 5540 P (IRP_MJ_DEVICE_CONTROL) S 60 J ( requests) S 60 J ( as) S 60 J ( buffered,) S 60 J ( every) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( direct) S 60 J ( I/O) S 60 J ( makes) S 
1200 5800 P (data) S 60 J ( transfers) S 60 J ( into) S 60 J ( or) S 60 J ( from) S 60 J ( a) S 60 J ( system-space) S 60 J ( buffer) S 60 J ( that) S 60 J ( each) S 60 J ( driver) S 60 J ( finds) S 60 J ( in) S 60 J ( the) S 60 J ( IRP) S 60 J ( at) S 
1200 6060 P 0 12 F 24 12 F B (Irp->AssociatedIrp.SystemBuffer) S E 0 12 F 24 12 F () S 60 J ( for) S 60 J ( device) S 60 J ( control) S 60 J ( requests.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
1200 6320 P (the) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( that) S 60 J ( a) S 60 J ( new) S 60 J ( driver) S 60 J ( for) S 60 J ( any) S 60 J ( common) S 60 J ( type) S 60 J ( of) S 60 J ( PC) S 60 J ( device) S 60 J ( must) S 60 J ( support,) S 60 J ( see) S 
1200 6580 P (the) S 60 J ( ) S 0 12 F 24 12 F I (Kernel-mode) S 60 J ( Driver) S 60 J ( Reference) S E 0 12 F 24 12 F (.) S 
1200 6960 P (Assuming) S 60 J ( its) S 60 J ( DispatchRead,) S 60 J ( DispatchWrite,) S 60 J ( or) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( determined) S 
1200 7220 P (that) S 60 J ( a) S 60 J ( request) S 60 J ( was) S 60 J ( valid) S 60 J ( and) S 60 J ( called) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F (,) S 60 J ( a) S 60 J ( device) S 60 J ( driver's) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( to) S 
1200 7480 P (process) S 60 J ( the) S 60 J ( packet) S 60 J ( next.) S 
1200 7860 P (The) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( determines) S 60 J ( which) S 60 J ( operation) S 60 J ( must) S 60 J ( be) S 60 J ( performed) S 60 J ( to) S 60 J ( satisfy) S 60 J ( the) S 60 J ( request) S 60 J ( and) S 60 J ( is) S 
1200 8120 P (responsible) S 60 J ( for) S 60 J ( programming) S 60 J ( the) S 60 J ( physical) S 60 J ( device) S 60 J ( for) S 60 J ( that) S 60 J ( operation.) S 60 J ( Note) S 60 J ( that) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 
1200 8380 P (must) S 60 J ( use) S 60 J ( a) S 60 J ( device) S 60 J ( driver's) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( to) S 60 J ( perform) S 60 J ( the) S 60 J ( necessary) S 60 J ( programming) S 60 J ( if) S 
1200 8640 P (access) S 60 J ( to) S 60 J ( the) S 60 J ( physical) S 60 J ( device) S 60 J ( \(and/or) S 60 J ( the) S 60 J ( device) S 60 J ( extension\)) S 60 J ( must) S 60 J ( be) S 60 J ( synchronized) S 60 J ( with) S 60 J ( the) S 
1200 8900 P (driver's) S 60 J ( ISR.) S 
1200 9280 P (If) S 60 J ( the) S 60 J ( device) S 60 J ( is) S 60 J ( a) S 60 J ( slave) S 60 J ( DMA) S 60 J ( device,) S 60 J ( its) S 60 J ( driver) S 60 J ( must) S 60 J ( synchronize) S 60 J ( transfers) S 60 J ( through) S 60 J ( a) S 60 J ( system) S 
1200 9540 P (DMA) S 60 J ( controller) S 60 J ( with) S 60 J ( a) S 60 J ( driver-allocated) S 60 J ( adapter) S 60 J ( object,) S 60 J ( representing) S 60 J ( the) S 60 J ( DMA) S 60 J ( channel,) S 60 J ( and) S 60 J ( a) S 
1200 9800 P (driver-supplied) S 60 J ( AdapterControl) S 60 J ( routine.) S 60 J ( The) S 60 J ( driver) S 60 J ( of) S 60 J ( a) S 60 J ( busmaster) S 60 J ( DMA) S 60 J ( device) S 60 J ( also) S 60 J ( must) S 60 J ( use) S 
1200 10060 P (a) S 60 J ( driver-allocated) S 60 J ( adapter) S 60 J ( object) S 60 J ( to) S 60 J ( synchronize) S 60 J ( its) S 60 J ( transfers) S 60 J ( and) S 60 J ( must) S 60 J ( supply) S 60 J ( an) S 
1200 10320 P (AdapterControl) S 60 J ( routine) S 60 J ( if) S 60 J ( it) S 60 J ( uses) S 60 J ( the) S 60 J ( system's) S 60 J ( packet-based) S 60 J ( DMA) S 60 J ( support.) S 
1200 10700 P (Depending) S 60 J ( on) S 60 J ( a) S 60 J ( driver's) S 60 J ( design,) S 60 J ( it) S 60 J ( might) S 60 J ( synchronize) S 60 J ( transfer) S 60 J ( \(and) S 60 J ( device) S 60 J ( control\)) S 60 J ( operations) S 
1200 10960 P (on) S 60 J ( a) S 60 J ( physical) S 60 J ( device) S 60 J ( with) S 60 J ( a) S 60 J ( controller) S 60 J ( object) S 60 J ( and) S 60 J ( supply) S 60 J ( a) S 60 J ( ControllerControl) S 60 J ( routine.) S 60 J ( For) S 60 J ( more) S 
1200 11220 P (information) S 60 J ( about) S 60 J ( adapter) S 60 J ( and) S 60 J ( controller) S 60 J ( objects,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 3.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
1200 11480 P (driver-supplied) S 60 J ( AdapterControl) S 60 J ( and) S 60 J ( ControllerControl) S 60 J ( routines,) S 60 J ( see) S 60 J ( also) S 60 J ( Chapter) S 60 J ( 11.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 807 J ( 7-) S E B (11) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (For) S 60 J ( example,) S 60 J ( a) S 60 J ( monolithic) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( PIO) S 60 J ( could) S 60 J ( synchronize) S 60 J ( operations) S 60 J ( on) S 60 J ( the) S 
1920 2320 P (disk) S 60 J ( controller) S 60 J ( hardware) S 60 J ( for) S 60 J ( the) S 60 J ( attached) S 60 J ( physical) S 60 J ( disks) S 60 J ( with) S 60 J ( a) S 60 J ( controller) S 60 J ( object.) S 60 J ( When) S 60 J ( such) S 60 J ( a) S 
1920 2580 P (driver's) S 60 J ( AtStartIo) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 60 J ( an) S 60 J ( IRP,) S 60 J ( it) S 60 J ( begins) S 60 J ( device) S 60 J ( processing) S 60 J ( of) S 60 J ( the) S 60 J ( request) S 60 J ( as) S 
1920 2840 P (follows:) S 
2400 3360 P 0 12 F 0 12 F ({) S 
2400 3620 P () S 480 J ( PDISK_EXTENSION) S 144 J ( diskExtension) S 144 J ( =) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
2400 4140 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
2400 4660 P (//) S 
2400 4920 P (//) S 144 J ( Increment) S 144 J ( the) S 144 J ( following) S 144 J ( to) S 144 J ( get) S 144 J ( a) S 144 J ( unique) S 144 J ( value) S 144 J ( to) S 144 J ( give) S 
2400 5180 P (//) S 144 J ( to) S 144 J ( the) S 144 J ( error) S 144 J ( log) S 144 J ( routine,) S 144 J ( if) S 144 J ( necessary.) S 
2400 5440 P (//) S 
2400 5700 P () S 480 J ( diskExtension->SequenceNumber++;) S 
2400 5960 P (//) S 
2400 6220 P (//) S 144 J ( Copy) S 144 J ( the) S 144 J ( operation) S 144 J ( requested) S 144 J ( \(READ,) S 144 J ( WRITE,) S 144 J ( or) S 144 J ( IOCTL,) S 
2400 6480 P (//) S 144 J ( which) S 144 J ( means) S 144 J ( VERIFY\)) S 144 J ( and) S 144 J ( the) S 144 J ( total) S 144 J ( length) S 144 J ( of) S 144 J ( the) S 144 J ( operation) S 
2400 6740 P (//) S 144 J ( from) S 144 J ( the) S 144 J ( IRP) S 144 J ( stack) S 144 J ( location) S 144 J ( to) S 144 J ( the) S 144 J ( device) S 144 J ( extension.) S 
2400 7000 P (//) S 144 J ( Copy) S 144 J ( the) S 144 J ( requested) S 144 J ( Length) S 144 J ( too,) S 144 J ( since) S 144 J ( the) S 144 J ( read) S 
2400 7260 P (//) S 144 J ( or) S 144 J ( write) S 144 J ( Length) S 144 J ( parameter) S 144 J ( overlays) S 144 J ( the) S 144 J ( VERIFY) S 144 J ( IOCTL's.) S 
2400 7520 P (//) S 
2400 7780 P () S 480 J ( diskExtension->OperationType) S 144 J ( =) S 144 J ( irpSp->MajorFunction;) S 
2400 8040 P () S 480 J ( diskExtension->RemainingRequestLength) S 144 J ( =) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.Length;) S 
2400 8560 P (//) S 
2400 8820 P (//) S 144 J ( Calculate) S 144 J ( the) S 144 J ( starting) S 144 J ( sector) S 144 J ( for) S 144 J ( the) S 144 J ( transfer.) S 
2400 9080 P (//) S 
2400 9340 P () S 480 J ( diskExtension->FirstSectorOfTransfer) S 144 J ( =) S 
2400 9600 P () S 480 J ( ) S 480 J ( RtlLargeIntegerShiftRight\() S 
2400 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.ByteOffset,) S 
2400 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->ByteShiftToSector\).LowPart;) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (12) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( The) S 144 J ( first) S 144 J ( sector) S 144 J ( of) S 144 J ( each) S 144 J ( transfer) S 144 J ( for) S 144 J ( a) S 144 J ( request) S 144 J ( is) S 
1680 2580 P (//) S 144 J ( greater) S 144 J ( than) S 144 J ( the) S 144 J ( previous) S 144 J ( one,) S 144 J ( so) S 144 J ( the) S 144 J ( following) S 144 J ( test) S 
1680 2840 P (//) S 144 J ( happens) S 144 J ( once) S 144 J ( per) S 144 J ( transfer) S 144 J ( since) S 144 J ( FirstSectorOfRequest) S 
1680 3100 P (//) S 144 J ( is) S 144 J ( set) S 144 J ( to) S 144 J ( MAXULONG) S 144 J ( when) S 144 J ( completing) S 144 J ( each) S 144 J ( IRP.) S 
1680 3360 P (//) S 144 J ( Also,) S 144 J ( save) S 144 J ( the) S 144 J ( first) S 144 J ( sector) S 144 J ( of) S 144 J ( each) S 144 J ( incoming) S 144 J ( request) S 
1680 3620 P (//) S 144 J ( so) S 144 J ( that) S 144 J ( IoStartNextPacketByKey) S 144 J ( will) S 144 J ( get) S 144 J ( packets) S 
1680 3880 P (//) S 144 J ( in) S 144 J ( C-SCAN) S 144 J ( order.) S 
1680 4140 P (//) S 
1680 4400 P () S 480 J ( if) S 144 J ( \(diskExtension->FirstSectorOfTransfer) S 144 J ( <) S 
1680 4660 P () S 480 J ( ) S 480 J ( diskExtension->FirstSectorOfRequest\)) S 144 J ( {) S 
1680 4920 P () S 480 J ( ) S 480 J ( diskExtension->FirstSectorOfRequest) S 144 J ( =) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->FirstSectorOfTransfer;) S 
1680 5440 P () S 480 J ( }) S 
1680 5700 P (//) S 
1680 5960 P (//) S 144 J ( If) S 144 J ( possible,) S 144 J ( this) S 144 J ( transfer) S 144 J ( should) S 144 J ( be) S 144 J ( the) S 144 J ( same) S 144 J ( length) S 
1680 6220 P (//) S 144 J ( as) S 144 J ( the) S 144 J ( request.) S 144 J ( However,) S 144 J ( it) S 144 J ( must) S 144 J ( be) S 144 J ( limited) S 
1680 6480 P (//) S 144 J ( to) S 144 J ( 256) S 144 J ( sectors.) S 
1680 6740 P (//) S 
1680 7000 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( calculate) S 144 J ( whether) S 144 J ( transfer) S 144 J ( must) S 144 J ( be) S 144 J ( split.) S 
1680 7260 P () S 480 J ( diskExtention->RemainingTransferLength) S 144 J ( =) S 
1680 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->TotalTransferLength;) S 
1680 7780 P (//) S 
1680 8040 P (//) S 144 J ( Usually,) S 144 J ( the) S 144 J ( controller) S 144 J ( it) S 144 J ( not) S 144 J ( being) S 144 J ( reset) S 144 J ( so) S 144 J ( the) S 144 J ( retry) S 
1680 8300 P (//) S 144 J ( count) S 144 J ( is) S 144 J ( initialized) S 144 J ( to) S 144 J ( zero.) S 144 J ( However,) S 144 J ( if) S 144 J ( the) S 144 J ( controller) S 
1680 8560 P (//) S 144 J ( IS) S 144 J ( being) S 144 J ( reset) S 144 J ( because) S 144 J ( of) S 144 J ( a) S 144 J ( failure) S 144 J ( on) S 144 J ( this) S 144 J ( disk,) S 
1680 8820 P (//) S 144 J ( must) S 144 J ( increment) S 144 J ( the) S 144 J ( retry) S 144 J ( count) S 144 J ( for) S 144 J ( this) S 144 J ( disk.) S 
1680 9080 P (//) S 
1680 9340 P () S 480 J ( if) S 144 J ( \(diskExtention->PacketIsBeingRetried\)) S 144 J ( {) S 
1680 9600 P () S 480 J ( ) S 480 J ( diskExtension->PacketIsBeingRetried) S 144 J ( =) S 144 J ( FALSE;) S 
1680 9860 P () S 480 J ( ) S 480 J ( diskExtension->IrpRetryCount++;) S 
1680 10120 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 10380 P () S 480 J ( ) S 480 J ( diskExtension->IrpRetryCount) S 144 J ( =) S 144 J ( 0;) S 
1680 10640 P () S 480 J ( }) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 807 J ( 7-) S E B (13) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Get) S 144 J ( a) S 144 J ( system-space) S 144 J ( pointer) S 144 J ( to) S 144 J ( the) S 144 J ( user's) S 144 J ( buffer.) S 
2400 2580 P (//) S 144 J ( Must) S 144 J ( use) S 144 J ( a) S 144 J ( system-space) S 144 J ( address) S 144 J ( because) S 144 J ( might) S 
2400 2840 P (//) S 144 J ( have) S 144 J ( left) S 144 J ( the) S 144 J ( original) S 144 J ( caller's) S 144 J ( address) S 144 J ( space) S 144 J ( already.) S 
2400 3100 P (//) S 
2400 3360 P () S 480 J ( if) S 144 J ( \(Irp->MdlAddress) S 144 J ( !=) S 144 J ( NULL\)) S 144 J ( {) S 
2400 3620 P () S 480 J ( ) S 480 J ( diskExtension->CurrentAddress) S 144 J ( =) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( MmGetSystemAddressForMdl\() S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->MdlAddress\);) S 
2400 4400 P () S 480 J ( }) S 
2400 4660 P () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( \(debugging) S 144 J ( code\)) S 
2400 4920 P (//) S 
2400 5180 P (//) S 144 J ( Allocate) S 144 J ( the) S 144 J ( controller) S 144 J ( and) S 144 J ( then) S 144 J ( program) S 144 J ( it) S 144 J ( to) S 144 J ( do) S 
2400 5440 P (//) S 144 J ( the) S 144 J ( operation.) S 
2400 5700 P (//) S 
2400 5960 P () S 480 J ( IoAllocateController\() S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->ControllerExtension->) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerObject,) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject,) S 
2400 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AtInitiate,) S 
2400 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( NULL\);) S 
2400 7520 P () S 480 J ( return;) S 
2400 7780 P (}) S 
1920 8160 P 0 12 F 24 12 F (This) S 60 J ( driver's) S 60 J ( AtStartIo) S 60 J ( routine) S 60 J ( synchronizes) S 60 J ( operations) S 60 J ( through) S 60 J ( the) S 60 J ( physical) S 60 J ( disk) S 60 J ( controller) S 60 J ( to) S 
1920 8420 P (the) S 60 J ( attached) S 60 J ( disks) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoAllocateController) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( ControllerControl) S 
1920 8680 P (routine.) S 60 J ( The) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( calls) S 60 J ( AtInitiate) S 60 J ( when) S 60 J ( the) S 60 J ( driver-created) S 60 J ( controller) S 60 J ( object) S 60 J ( is) S 60 J ( free:) S 60 J ( that) S 
1920 8940 P (is,) S 60 J ( another) S 60 J ( driver) S 60 J ( routine) S 60 J ( has) S 60 J ( called) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseController) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( indicate) S 60 J ( it) S 60 J ( is) S 60 J ( finished) S 60 J ( using) S 60 J ( the) S 
1920 9200 P (disk) S 60 J ( controller) S 60 J ( to) S 60 J ( process) S 60 J ( request\(s\)) S 60 J ( for) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object,) S 60 J ( representing) S 60 J ( one) S 60 J ( of) S 60 J ( the) S 
1920 9460 P (physical) S 60 J ( disks.) S 
1920 9840 P (However,) S 60 J ( AtInitiate) S 60 J ( actually) S 60 J ( calls) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( to) S 60 J ( program) S 60 J ( the) S 
1920 10100 P (physical) S 60 J ( controller) S 60 J ( for) S 60 J ( the) S 60 J ( requested) S 60 J ( operation.) S 60 J ( AtInitiate) S 60 J ( does) S 60 J ( this) S 60 J ( in) S 60 J ( order) S 60 J ( to) S 60 J ( synchronize) S 
1920 10360 P (access) S 60 J ( to) S 60 J ( the) S 60 J ( hardware) S 60 J ( with) S 60 J ( the) S 60 J ( driver's) S 60 J ( ISR) S 60 J ( and) S 60 J ( DpcForIsr) S 60 J ( routines.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 
1920 10620 P (about) S 60 J ( such) S 60 J ( an) S 60 J ( AtInitiate) S 60 J ( routine,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 11.) S 
1920 11000 P (Note) S 60 J ( also) S 60 J ( that) S 60 J ( the) S 60 J ( preceding) S 60 J ( AtStartIo) S 60 J ( routine) S 60 J ( must) S 60 J ( split) S 60 J ( up) S 60 J ( a) S 60 J ( transfer) S 60 J ( request) S 60 J ( if) S 60 J ( it) S 60 J ( is) S 60 J ( larger) S 
1920 11260 P (than) S 60 J ( the) S 60 J ( physical) S 60 J ( disk) S 60 J ( controller) S 60 J ( can) S 60 J ( manage) S 60 J ( in) S 60 J ( a) S 60 J ( single) S 60 J ( operation,) S 60 J ( even) S 60 J ( though) S 60 J ( the) S 60 J ( driver) S 60 J ( uses) S 
1920 11520 P (PIO) S 60 J ( rather) S 60 J ( than) S 60 J ( DMA.) S 60 J ( NT) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( system) S 60 J ( DMA) S 60 J ( are) S 60 J ( required) S 60 J ( to) S 60 J ( split) S 60 J ( transfer) S 60 J ( requests) S 
1920 11780 P (that) S 60 J ( are) S 60 J ( too) S 60 J ( large) S 60 J ( for) S 60 J ( the) S 60 J ( system) S 60 J ( DMA) S 60 J ( controller) S 60 J ( or) S 60 J ( for) S 60 J ( their) S 60 J ( device\(s\)) S 60 J ( to) S 60 J ( handle) S 60 J ( in) S 60 J ( a) S 60 J ( single) S 
1920 12040 P (operation.) S 60 J ( See) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( adapter) S 60 J ( objects) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 3) S 60 J ( for) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( this) S 
1920 12300 P (requirement.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (14) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2080 P 0 12 F 8 12 F B (7.4.3) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( Points) S 67 J ( to) S 67 J ( Consider) S 67 J ( in) S 67 J ( Implementing) S 67 J ( StartIo) S E 
1200 2700 P 0 12 F 24 12 F (Keep) S 60 J ( the) S 60 J ( following) S 60 J ( points) S 60 J ( in) S 60 J ( mind) S 60 J ( when) S 60 J ( implementing) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine:) S 
1200 3020 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( must) S 60 J ( synchronize) S 60 J ( its) S 60 J ( access) S 60 J ( to) S 60 J ( a) S 60 J ( physical) S 60 J ( device) S 60 J ( and) S 60 J ( to) S 60 J ( any) S 60 J ( shared) S 60 J ( state) S 
1680 3280 P (information) S 60 J ( that) S 60 J ( the) S 60 J ( driver) S 60 J ( maintains) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( extension) S 60 J ( with) S 60 J ( the) S 60 J ( driver's) S 60 J ( other) S 
1680 3540 P (routines) S 60 J ( that) S 60 J ( access) S 60 J ( the) S 60 J ( same) S 60 J ( device) S 60 J ( or) S 60 J ( memory) S 60 J ( location.) S 
1680 3860 P (If) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( shares) S 60 J ( the) S 60 J ( device) S 60 J ( or) S 60 J ( state) S 60 J ( with) S 60 J ( the) S 60 J ( ISR,) S 60 J ( it) S 60 J ( must) S 60 J ( call) S 
1680 4120 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( to) S 60 J ( program) S 
1680 4380 P (the) S 60 J ( device) S 60 J ( or) S 60 J ( to) S 60 J ( access) S 60 J ( the) S 60 J ( shared) S 60 J ( state.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( SynchCritSection) S 
1680 4640 P (routines,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 10.) S 
1680 4960 P (If) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( shares) S 60 J ( state) S 60 J ( with) S 60 J ( routines) S 60 J ( other) S 60 J ( than) S 60 J ( the) S 60 J ( ISR,) S 60 J ( it) S 60 J ( must) S 60 J ( protect) S 60 J ( the) S 
1680 5220 P (shared) S 60 J ( state) S 60 J ( with) S 60 J ( a) S 60 J ( driver-initialized) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock) S 60 J ( for) S 60 J ( which) S 60 J ( the) S 60 J ( driver) S 60 J ( provided) S 60 J ( the) S 
1680 5480 P (storage.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( using) S 60 J ( executive) S 60 J ( spin) S 60 J ( locks,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 
1200 5800 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( a) S 60 J ( monolithic) S 60 J ( driver) S 60 J ( set) S 60 J ( up) S 60 J ( a) S 60 J ( controller) S 60 J ( object) S 60 J ( in) S 60 J ( its) S 60 J ( DriverEntry) S 60 J ( routine,) S 60 J ( its) S 60 J ( StartIo) S 
1680 6060 P (routine) S 60 J ( can) S 60 J ( use) S 60 J ( the) S 60 J ( controller) S 60 J ( object) S 60 J ( to) S 60 J ( synchronize) S 60 J ( operations) S 60 J ( through) S 60 J ( a) S 60 J ( shared) S 60 J ( physical) S 
1680 6320 P (device) S 60 J ( with) S 60 J ( attached) S 60 J ( \(similar\)) S 60 J ( devices.) S 
1200 6640 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( of) S 60 J ( a) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( DMA) S 60 J ( must) S 60 J ( synchronize) S 60 J ( transfers) S 60 J ( using) S 60 J ( an) S 
1680 6900 P (adapter) S 60 J ( object.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( adapter) S 60 J ( objects,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 3.) S 
1200 7220 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( is) S 60 J ( run) S 60 J ( at) S 60 J ( IRQL) S 60 J ( DISPATCH_LEVEL,) S 60 J ( which) S 60 J ( restricts) S 60 J ( the) S 60 J ( set) S 60 J ( of) S 60 J ( support) S 
1680 7480 P (routines) S 60 J ( it) S 60 J ( can) S 60 J ( call.) S 
1680 7800 P (For) S 60 J ( example,) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( can) S 60 J ( neither) S 60 J ( access) S 60 J ( nor) S 60 J ( allocate) S 60 J ( pageable) S 60 J ( memory,) S 60 J ( and) S 60 J ( it) S 
1680 8060 P (cannot) S 60 J ( wait) S 60 J ( on) S 60 J ( a) S 60 J ( dispatcher) S 60 J ( object.) S 60 J ( On) S 60 J ( the) S 60 J ( other) S 60 J ( hand,) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( can) S 60 J ( acquire) S 60 J ( and) S 
1680 8320 P (release) S 60 J ( a) S 60 J ( driver-allocated) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (KeAcquireSpinLockAtDpcLevel) S E 0 12 F 24 12 F () S 60 J ( and) S 
1680 8580 P 0 12 F 24 12 F B (KeReleaseSpinLockFromDpcLevel) S E 0 12 F 24 12 F (,) S 60 J ( which) S 60 J ( run) S 60 J ( faster) S 60 J ( than) S 60 J ( ) S 0 12 F 24 12 F B (KeAcquireSpinLock) S E 0 12 F 24 12 F () S 60 J ( and) S 
1680 8840 P 0 12 F 24 12 F B (KeReleaseSpinLock) S E 0 12 F 24 12 F (.) S 
1200 9160 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( driver) S 60 J ( handles) S 60 J ( cancelable) S 60 J ( IRPs,) S 60 J ( its) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( must) S 60 J ( check) S 60 J ( whether) S 60 J ( the) S 60 J ( input) S 
1680 9420 P (IRP) S 60 J ( has) S 60 J ( already) S 60 J ( been) S 60 J ( cancelled) S 60 J ( before) S 60 J ( it) S 60 J ( begins) S 60 J ( processing) S 60 J ( the) S 60 J ( request.) S 60 J ( For) S 60 J ( more) S 
1680 9680 P (information) S 60 J ( about) S 60 J ( managing) S 60 J ( cancelable) S 60 J ( IRPs,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 12.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 807 J ( 7-) S E B (15) S E B () S 720 J ( ) S E 
1920 2120 P 0 12 F 8 14 F B (7.5) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Managing) S 78 J ( Interlocked) S 78 J ( Queues) S E 
1920 2740 P 0 12 F 24 12 F (As) S 60 J ( already) S 60 J ( shown) S 60 J ( in) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( DispatchDeviceControl) S 60 J ( routines) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 6,) S 60 J ( a) S 60 J ( floppy) S 
1920 3000 P (device) S 60 J ( driver) S 60 J ( with) S 60 J ( a) S 60 J ( device-dedicated) S 60 J ( thread,) S 60 J ( rather) S 60 J ( than) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine,) S 60 J ( would) S 60 J ( manage) S 60 J ( its) S 
1920 3260 P (own) S 60 J ( queueing) S 60 J ( of) S 60 J ( IRPs) S 60 J ( in) S 60 J ( an) S 60 J ( interlocked) S 60 J ( queue.) S 60 J ( Such) S 60 J ( a) S 60 J ( driver's) S 60 J ( thread) S 60 J ( pulls) S 60 J ( IRPs) S 60 J ( from) S 60 J ( its) S 
1920 3520 P (interlocked) S 60 J ( queue) S 60 J ( when) S 60 J ( there) S 60 J ( is) S 60 J ( work) S 60 J ( to) S 60 J ( be) S 60 J ( done) S 60 J ( on) S 60 J ( the) S 60 J ( device.) S 
1920 3900 P (Like) S 60 J ( every) S 60 J ( other) S 60 J ( NT) S 60 J ( mass-storage) S 60 J ( device) S 60 J ( driver,) S 60 J ( a) S 60 J ( floppy) S 60 J ( driver) S 60 J ( uses) S 60 J ( direct) S 60 J ( I/O.) S 60 J ( Like) S 60 J ( every) S 
1920 4160 P (other) S 60 J ( NT) S 60 J ( driver) S 60 J ( of) S 60 J ( a) S 60 J ( slave) S 60 J ( DMA) S 60 J ( device,) S 60 J ( such) S 60 J ( a) S 60 J ( floppy) S 60 J ( driver) S 60 J ( must) S 60 J ( synchronize) S 60 J ( its) S 60 J ( transfers) S 
1920 4420 P (through) S 60 J ( a) S 60 J ( system) S 60 J ( DMA) S 60 J ( controller) S 60 J ( with) S 60 J ( a) S 60 J ( driver-allocated) S 60 J ( adapter) S 60 J ( object) S 60 J ( and) S 60 J ( driver-supplied) S 
1920 4680 P (AdapterControl) S 60 J ( routine.) S 
1920 5060 P (When) S 60 J ( this) S 60 J ( driver's) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( is) S 60 J ( called,) S 60 J ( it) S 60 J ( checks) S 60 J ( the) S 60 J ( parameters) S 60 J ( in) S 60 J ( the) S 60 J ( I/O) S 
1920 5320 P (stack) S 60 J ( location) S 60 J ( of) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( and,) S 60 J ( if) S 60 J ( they) S 60 J ( are) S 60 J ( valid,) S 60 J ( queues) S 60 J ( the) S 60 J ( request) S 60 J ( for) S 60 J ( further) S 60 J ( processing.) S 
1920 5580 P (Like) S 60 J ( the) S 60 J ( floppy) S 60 J ( driver's) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 6,) S 60 J ( its) S 
1920 5840 P (DispatchReadWrite) S 60 J ( routine) S 60 J ( sets) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( device) S 60 J ( extension) S 60 J ( in) S 60 J ( its) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 
1920 6100 P (before) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (ExInterlockedInsertTailList) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( an) S 60 J ( IRP.) S 60 J ( Then,) S 60 J ( it) S 60 J ( calls) S 
1920 6360 P 0 12 F 24 12 F B (KeReleaseSemaphore) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( wake) S 60 J ( up) S 60 J ( the) S 60 J ( floppy) S 60 J ( thread) S 60 J ( \(in) S 60 J ( case) S 60 J ( it) S 60 J ( was) S 60 J ( waiting) S 60 J ( on) S 60 J ( the) S 60 J ( driver-) S 
1920 6620 P (allocated) S 60 J ( semaphore\)) S 60 J ( to) S 60 J ( begin) S 60 J ( the) S 60 J ( device) S 60 J ( I/O) S 60 J ( operation.) S 
1920 7000 P (Such) S 60 J ( a) S 60 J ( floppy) S 60 J ( driver's) S 60 J ( device-dedicated) S 60 J ( thread) S 60 J ( serves) S 60 J ( as) S 60 J ( the) S 60 J ( driver's) S 60 J ( StartIo) S 60 J ( \(and) S 60 J ( functionally) S 
1920 7260 P (as) S 60 J ( part) S 60 J ( of) S 60 J ( its) S 60 J ( DpcForIsr\)) S 60 J ( routine,) S 60 J ( as) S 60 J ( follows:) S 
2400 7780 P 0 12 F 0 12 F ({) S 
2400 8040 P () S 480 J ( PCONTROLLER_DATA) S 144 J ( controllerData) S 144 J ( =) S 144 J ( Context;) S 
2400 8300 P () S 480 J ( PIRP) S 144 J ( irp;) S 
2400 8560 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp;) S 
2400 8820 P () S 480 J ( PLIST_ENTRY) S 144 J ( request;) S 
2400 9080 P () S 480 J ( PDISKETTE_EXTENSION) S 144 J ( disketteExtension;) S 
2400 9340 P () S 480 J ( KIRQL) S 144 J ( oldIrql;) S 
2400 9600 P () S 480 J ( NTSTATUS) S 144 J ( ntStatus;) S 
2400 9860 P () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
2400 10120 P (//) S 
2400 10380 P (//) S 144 J ( Set) S 144 J ( thread) S 144 J ( priority) S 144 J ( to) S 144 J ( lowest) S 144 J ( realtime) S 144 J ( level.) S 
2400 10640 P (//) S 
2400 10900 P () S 480 J ( KeSetPriorityThread\() S 
2400 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeGetCurrentThread\(\),) S 
2400 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( LOW_REALTIME_PRIORITY\);) S 
2400 11680 P () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (16) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F () S 480 J ( do) S 144 J ( {) S 
1680 2580 P (//) S 
1680 2840 P (//) S 144 J ( Wait) S 144 J ( for) S 144 J ( a) S 144 J ( request) S 144 J ( from) S 144 J ( the) S 144 J ( Dispatch) S 144 J ( routines.) S 
1680 3100 P (//) S 144 J ( KeWaitForSingleObject) S 144 J ( cannot) S 144 J ( return) S 144 J ( an) S 144 J ( error) S 144 J ( here:) S 
1680 3360 P (//) S 144 J ( this) S 144 J ( system) S 144 J ( thread) S 144 J ( isn't) S 144 J ( alertable,) S 144 J ( won't) S 144 J ( take) S 144 J ( APCs,) S 
1680 3620 P (//) S 144 J ( and) S 144 J ( it's) S 144 J ( not) S 144 J ( passing) S 144 J ( in) S 144 J ( a) S 144 J ( timeout.) S 
1680 3880 P (//) S 
1680 4140 P () S 480 J ( ) S 480 J ( \(VOID\)KeWaitForSingleObject\() S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PVOID\)) S 144 J ( &ControllerData->RequestSemaphore,) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( UserRequest,) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KernelMode,) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( FALSE,) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PLARGE_INTEGER\)) S 144 J ( NULL\);) S 
1680 5700 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(ControllerData->UnloadingDriver\)) S 144 J ( {) S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( PsTerminateSystemThread\(STATUS_SUCCESS\);) S 
1680 6220 P () S 480 J ( ) S 480 J ( }) S 
1680 6480 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( time-out) S 144 J ( requests) S 144 J ( if) S 144 J ( controller) S 144 J ( busy) S 
1680 6740 P () S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( controllerData->CurrentInterrupt) S 144 J ( =) S 144 J ( TRUE;) S 
1680 7260 P (//) S 
1680 7520 P (//) S 144 J ( Since) S 144 J ( this) S 144 J ( is) S 144 J ( the) S 144 J ( only) S 144 J ( thread) S 144 J ( touching) S 144 J ( the) S 144 J ( interlocked) S 
1680 7780 P (//) S 144 J ( queue,) S 144 J ( it's) S 144 J ( safe) S 144 J ( to) S 144 J ( test) S 144 J ( whether) S 144 J ( the) S 144 J ( queue) S 144 J ( is) S 144 J ( empty) S 
1680 8040 P (//) S 144 J ( without) S 144 J ( acquiring) S 144 J ( the) S 144 J ( ListSpinLock) S 144 J ( first.) S 144 J ( The) S 144 J ( worst) S 144 J ( that) S 
1680 8300 P (//) S 144 J ( can) S 144 J ( happen) S 144 J ( is) S 144 J ( that) S 144 J ( an) S 144 J ( IRP) S 144 J ( will) S 144 J ( be) S 144 J ( inserted) S 144 J ( just) S 144 J ( after) S 
1680 8560 P (//) S 144 J ( the) S 144 J ( following) S 144 J ( test) S 144 J ( and) S 144 J ( the) S 144 J ( thread'll) S 144 J ( go) S 144 J ( back) S 144 J ( to) S 144 J ( waiting) S 
1680 8820 P (//) S 144 J ( on) S 144 J ( RequestSemaphore,) S 144 J ( which) S 144 J ( would) S 144 J ( already) S 144 J ( be) S 144 J ( set) S 144 J ( to) S 144 J ( the) S 
1680 9080 P (//) S 144 J ( Signaled) S 144 J ( state) S 144 J ( so) S 144 J ( this) S 144 J ( thread) S 144 J ( wouldn't) S 144 J ( wait) S 144 J ( for) S 144 J ( long.) S 
1680 9340 P (//) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( while) S 144 J ( \(!IsListEmpty\() S 144 J ( &\(ControllerData->) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ListEntry\)\)\)) S 144 J ( {) S 
1680 10120 P (//) S 
1680 10380 P (//) S 144 J ( Get) S 144 J ( the) S 144 J ( next) S 144 J ( request) S 144 J ( from) S 144 J ( the) S 144 J ( queue.) S 
1680 10640 P (//) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 807 J ( 7-) S E B (17) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( request) S 144 J ( =) S 144 J ( ExInterlockedRemoveHeadList\() S 
2400 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &ControllerData->ListEntry,) S 
2400 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &ControllerData->ListSpinLock\);) S 
2400 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerData->HardwareFailed) S 144 J ( =) S 144 J ( FALSE;) S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irp) S 144 J ( =) S 144 J ( CONTAINING_RECORD\() S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( request,) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IRP,) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Tail.Overlay.ListEntry\);) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp) S 144 J ( =) S 144 J ( IoGetCurrentIrpStackLocation\(irp\);) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( switch) S 144 J ( \(irpSp->MajorFunction\)) S 144 J ( {) S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_READ:) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_WRITE:) S 144 J ( {) S 
2400 5180 P (//) S 
2400 5440 P (//) S 144 J ( Get) S 144 J ( the) S 144 J ( disketteExtension) S 144 J ( from) S 144 J ( where) S 144 J ( the) S 144 J ( Dispatch) S 144 J ( routine) S 
2400 5700 P (//) S 144 J ( put) S 144 J ( it) S 144 J ( in) S 144 J ( the) S 144 J ( IRP.) S 
2400 5960 P (//) S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( disketteExtension) S 144 J ( =) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PDISKETTE_EXTENSION\)) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.Key;) S 
2400 7000 P (//) S 
2400 7260 P (//) S 144 J ( Until) S 144 J ( the) S 144 J ( file) S 144 J ( system) S 144 J ( clears) S 144 J ( the) S 144 J ( DO_VERIFY_VOLUME) S 144 J ( bit) S 
2400 7520 P (//) S 144 J ( in) S 144 J ( the) S 144 J ( device) S 144 J ( object) S 144 J ( Flags,) S 144 J ( return) S 144 J ( all) S 144 J ( requests) S 144 J ( with) S 
2400 7780 P (//) S 144 J ( an) S 144 J ( error.) S 
2400 8040 P (//) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(\(disketteExtension->) S 
2400 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->Flags) S 144 J ( &) S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DO_VERIFY_VOLUME\)) S 144 J ( &&) S 
2400 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( !\(irpSp->Flags) S 144 J ( &) S 
2400 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( SL_OVERRIDE_VERIFY_VOLUME\)\)) S 144 J ( {) S 
2400 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ntStatus) S 144 J ( =) S 144 J ( STATUS_VERIFY_REQUIRED;) S 
2400 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
2400 10120 P (//) S 
2400 10380 P (//) S 144 J ( Need) S 144 J ( to) S 144 J ( wait) S 144 J ( for) S 144 J ( the) S 144 J ( system) S 144 J ( DMA) S 144 J ( controller.) S 
2400 10640 P (//) S 
2400 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeResetEvent\() S 
2400 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &ControllerData->) S 
2400 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AllocateAdapterChannelEvent\);) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (18) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( Must) S 144 J ( call) S 144 J ( IoAllocateAdapter) S 144 J ( at) S 144 J ( IRQL) S 144 J ( DISPATCH_LEVEL,) S 
1680 2580 P (//) S 144 J ( but) S 144 J ( this) S 144 J ( thread's) S 144 J ( running) S 144 J ( at) S 144 J ( PASSIVE_LEVEL.) S 
1680 2840 P (//) S 
1680 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeRaiseIrql\() S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DISPATCH_LEVEL,) S 
1680 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &oldIrql\);) S 
1680 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoAllocateAdapterChannel\() S 
1680 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerData->) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AdapterObject,) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( disketteExtension->) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject,) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerData->) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( NumberOfMapRegisters,) S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( FloppyAllocateAdapterChannel,) S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerData\);) S 
1680 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeLowerIrql\(oldIrql\);) S 
1680 6480 P (//) S 
1680 6740 P (//) S 144 J ( Wait) S 144 J ( for) S 144 J ( the) S 144 J ( adapter) S 144 J ( to) S 144 J ( be) S 144 J ( allocated.) S 144 J ( No) S 144 J ( timeout.) S 
1680 7000 P (//) S 144 J ( Trust) S 144 J ( the) S 144 J ( system) S 144 J ( to) S 144 J ( do) S 144 J ( it) S 144 J ( properly,) S 144 J ( so) S 
1680 7260 P (//) S 144 J ( KeWaitForSingleObject) S 144 J ( cannot) S 144 J ( return) S 144 J ( an) S 144 J ( error) S 144 J ( here.) S 
1680 7520 P (//) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeWaitForSingleObject\() S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &ControllerData->) S 
1680 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AllocateAdapterChannelEvent,) S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Executive,) S 
1680 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KernelMode,) S 
1680 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( FALSE,) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PLARGE_INTEGER\)) S 144 J ( NULL\);) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ntStatus) S 144 J ( =) S 144 J ( FlReadWrite\() S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( disketteExtension,) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irp\);) S 
1680 10380 P (//) S 
1680 10640 P (//) S 144 J ( Deallocate) S 144 J ( the) S 144 J ( adapter) S 144 J ( object) S 144 J ( that) S 144 J ( was) S 144 J ( just) S 144 J ( used) S 
1680 10900 P (//) S 144 J ( for) S 144 J ( slave) S 144 J ( DMA.) S 
1680 11160 P (//) S 
1680 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeRaiseIrql\() S 
1680 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DISPATCH_LEVEL,) S 
1680 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &oldIrql\);) S 
1680 12200 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoFreeAdapterChannel\() S 
1680 12460 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerData->) S 
1680 12720 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AdapterObject\);) S 
1680 12980 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeLowerIrql\(oldIrql\);) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 807 J ( 7-) S E B (19) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( else) S 144 J ( read/write) S 144 J ( to) S 144 J ( device) S 
2400 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( case) S 144 J ( IRP_MJ_READ) S 144 J ( or) S 144 J ( IRP_MJ_WRITE) S 
2400 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_DEVICE_CONTROL:) S 144 J ( {) S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( switch) S 144 J ( on) S 144 J ( major) S 144 J ( function) S 144 J ( code) S 
2400 3880 P (//) S 
2400 4140 P (//) S 144 J ( All) S 144 J ( operations) S 144 J ( leave) S 144 J ( a) S 144 J ( final) S 144 J ( status) S 144 J ( in) S 144 J ( ntStatus.) S 
2400 4400 P (//) S 144 J ( Copy) S 144 J ( it) S 144 J ( to) S 144 J ( the) S 144 J ( IRP) S 144 J ( and,) S 144 J ( then,) S 144 J ( complete) S 144 J ( the) S 144 J ( operation.) S 
2400 4660 P (//) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( irp->IoStatus.Status) S 144 J ( =) S 144 J ( ntStatus;) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( FlFinishOperation\(irp,) S 144 J ( disketteExtension\);) S 
2400 5440 P () S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( while) S 144 J ( packets) S 144 J ( to) S 144 J ( process) S 
2400 5700 P () S 480 J ( ) S 480 J ( controllerData->CurrentInterrupt) S 144 J ( =) S 144 J ( FALSE;) S 
2400 5960 P () S 480 J ( ) S 480 J ( \(VOID\)) S 144 J ( KeSetEvent\() S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerData->ControllerEvent,) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(KPRIORITY\)) S 144 J ( 0,) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( FALSE\);) S 
2400 7000 P () S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( else) S 144 J ( not) S 144 J ( terminating) S 144 J ( thread) S 
2400 7260 P () S 480 J ( }) S 144 J ( while\(TRUE\);) S 144 J ( //) S 144 J ( end) S 144 J ( do) S 
2400 7520 P (}) S 
1920 7900 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( this) S 60 J ( driver) S 60 J ( thread) S 60 J ( must) S 60 J ( manage) S 60 J ( the) S 60 J ( IRQLs) S 60 J ( at) S 60 J ( which) S 60 J ( it) S 60 J ( runs) S 60 J ( carefully.) S 60 J ( Because) S 60 J ( system) S 
1920 8160 P (threads) S 60 J ( generally) S 60 J ( run) S 60 J ( at) S 60 J ( IRQL) S 60 J ( PASSIVE_LEVEL,) S 60 J ( it) S 60 J ( is) S 60 J ( possible) S 60 J ( for) S 60 J ( the) S 60 J ( thread) S 60 J ( to) S 60 J ( wait) S 60 J ( on) S 
1920 8420 P (kernel-defined) S 60 J ( dispatcher) S 60 J ( objects:) S 60 J ( here,) S 60 J ( a) S 60 J ( semaphore) S 60 J ( and) S 60 J ( an) S 60 J ( event.) S 60 J ( The) S 60 J ( preceding) S 60 J ( thread's) S 60 J ( call) S 
1920 8680 P (to) S 60 J ( ) S 0 12 F 24 12 F B (ExInterlockedRemoveHeadList) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( its) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock) S 60 J ( temporarily) S 60 J ( raises) S 60 J ( IRQL) S 60 J ( to) S 
1920 8940 P (DISPATCH_LEVEL) S 60 J ( while) S 60 J ( the) S 60 J ( IRP) S 60 J ( is) S 60 J ( being) S 60 J ( removed) S 60 J ( from) S 60 J ( its) S 60 J ( internal) S 60 J ( queue,) S 60 J ( and) S 60 J ( the) S 60 J ( IRQL) S 60 J ( is) S 
1920 9200 P (restored) S 60 J ( to) S 60 J ( PASSIVE_LEVEL) S 60 J ( on) S 60 J ( return) S 60 J ( from) S 60 J ( this) S 60 J ( call.) S 
1920 9580 P (However,) S 60 J ( the) S 60 J ( floppy) S 60 J ( thread) S 60 J ( must) S 60 J ( nest) S 60 J ( its) S 60 J ( calls) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (IoAllocateAdapterChannel) S E 0 12 F 24 12 F () S 60 J ( and) S 
1920 9840 P 0 12 F 24 12 F B (IoFreeAdapterChannel) S E 0 12 F 24 12 F () S 60 J ( between) S 60 J ( calls) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (KeRaiseIrql) S E 0 12 F 24 12 F () S 60 J ( and) S 60 J ( ) S 0 12 F 24 12 F B (KeLowerIrql) S E 0 12 F 24 12 F (,) S 60 J ( because) S 60 J ( the) S 
1920 10100 P 0 12 F 24 12 F B (Io..Adapter) S E 0 12 F 24 12 F I (Xxx) S E 0 12 F 24 12 F () S 60 J ( routines) S 60 J ( and) S 60 J ( other) S 60 J ( support) S 60 J ( routines) S 60 J ( for) S 60 J ( DMA) S 60 J ( operations) S 60 J ( must) S 60 J ( be) S 60 J ( called) S 60 J ( from) S 
1920 10360 P (IRQL) S 60 J ( DISPATCH_LEVEL.) S 60 J ( Note) S 60 J ( also) S 60 J ( that) S 60 J ( StartIo) S 60 J ( routines) S 60 J ( are) S 60 J ( run) S 60 J ( at) S 60 J ( DISPATCH_LEVEL,) S 60 J ( so) S 
1920 10620 P (NT) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( DMA) S 60 J ( need) S 60 J ( not) S 60 J ( make) S 60 J ( calls) S 60 J ( to) S 60 J ( the) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Ke..Irql) S E 0 12 F 24 12 F () S 60 J ( routines) S 60 J ( from) S 60 J ( their) S 60 J ( StartIo) S 
1920 10880 P (routines.) S 
1920 11260 P (Like) S 60 J ( any) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( system) S 60 J ( DMA,) S 60 J ( such) S 60 J ( a) S 60 J ( floppy) S 60 J ( driver) S 60 J ( passes) S 60 J ( its) S 60 J ( AdapterControl) S 60 J ( routine) S 
1920 11520 P (in) S 60 J ( the) S 60 J ( call) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (IoAllocateAdapterChannel) S E 0 12 F 24 12 F (.) S 60 J ( This) S 60 J ( routine) S 60 J ( sets) S 60 J ( up) S 60 J ( the) S 60 J ( map) S 60 J ( register) S 60 J ( base) S 60 J ( address) S 
1920 11780 P (for) S 60 J ( the) S 60 J ( device-dedicated) S 60 J ( thread's) S 60 J ( call) S 60 J ( to) S 60 J ( the) S 60 J ( internal) S 60 J ( routine) S 60 J ( FlReadWrite,) S 60 J ( which) S 60 J ( might) S 60 J ( have) S 60 J ( to) S 
1920 12040 P (split) S 60 J ( the) S 60 J ( requested) S 60 J ( length) S 60 J ( of) S 60 J ( the) S 60 J ( transfer) S 60 J ( \(in) S 60 J ( the) S 60 J ( IRP) S 60 J ( stack) S 60 J ( location) S 60 J ( at) S 
1920 12300 P 0 12 F 24 12 F B (Parameters.Read.Length) S E 0 12 F 24 12 F (\)) S 60 J ( into) S 60 J ( several) S 60 J ( transfer) S 60 J ( operations) S 60 J ( in) S 60 J ( order) S 60 J ( to) S 60 J ( satisfy) S 60 J ( the) S 60 J ( request.) S 
1920 12680 P (For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( AdapterControl) S 60 J ( routines,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 11.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 
1920 12940 P (about) S 60 J ( managing) S 60 J ( IRQLs,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (20) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2120 P 0 12 F 8 14 F B (7.6) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Managing) S 78 J ( Device) S 78 J ( Queues) S E 
1200 2740 P 0 12 F 24 12 F (As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 3,) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( usually) S 60 J ( creates) S 60 J ( an) S 60 J ( associated) S 60 J ( device) S 60 J ( queue) S 60 J ( object) S 
1200 3000 P (when) S 60 J ( a) S 60 J ( device) S 60 J ( driver) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCreateDevice) S E 0 12 F 24 12 F (.) S 60 J ( It) S 60 J ( also) S 60 J ( provides) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F () S 60 J ( and) S 
1200 3260 P 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F (,) S 60 J ( which) S 60 J ( drivers) S 60 J ( can) S 60 J ( call) S 60 J ( to) S 60 J ( have) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( insert) S 60 J ( IRPs) S 60 J ( into) S 60 J ( the) S 
1200 3520 P (associated) S 60 J ( device) S 60 J ( queue) S 60 J ( or) S 60 J ( call) S 60 J ( their) S 60 J ( StartIo) S 60 J ( routines) S 60 J ( \(see) S 60 J ( Section) S 60 J ( 7.4\)) S 60 J ( with) S 60 J ( an) S 60 J ( IRP.) S 
1200 3780 P (Consequently,) S 60 J ( very) S 60 J ( few) S 60 J ( NT) S 60 J ( driver) S 60 J ( designers) S 60 J ( find) S 60 J ( it) S 60 J ( necessary) S 60 J ( \(or) S 60 J ( particularly) S 60 J ( useful\)) S 60 J ( to) S 60 J ( set) S 60 J ( up) S 
1200 4040 P (their) S 60 J ( own) S 60 J ( device) S 60 J ( queue) S 60 J ( objects) S 60 J ( for) S 60 J ( IRPs.) S 
1200 4420 P (Likely) S 60 J ( candidates) S 60 J ( are) S 60 J ( drivers,) S 60 J ( such) S 60 J ( as) S 60 J ( the) S 60 J ( NT) S 60 J ( SCSI) S 60 J ( port) S 60 J ( driver,) S 60 J ( that) S 60 J ( must) S 60 J ( coordinate) S 60 J ( incoming) S 
1200 4680 P (IRPs) S 60 J ( from) S 60 J ( some) S 60 J ( number) S 60 J ( of) S 60 J ( closely) S 60 J ( coupled) S 60 J ( class) S 60 J ( drivers) S 60 J ( for) S 60 J ( heterogeneous) S 60 J ( devices) S 60 J ( that) S 60 J ( are) S 
1200 4940 P (serviced) S 60 J ( through) S 60 J ( a) S 60 J ( single) S 60 J ( controller.) S 60 J ( In) S 60 J ( other) S 60 J ( words,) S 60 J ( the) S 60 J ( designer) S 60 J ( of) S 60 J ( a) S 60 J ( driver) S 60 J ( for) S 60 J ( a) S 60 J ( disk) S 60 J ( array) S 
1200 5200 P (controller) S 60 J ( is) S 60 J ( more) S 60 J ( likely) S 60 J ( to) S 60 J ( use) S 60 J ( a) S 60 J ( driver-created) S 60 J ( controller) S 60 J ( object) S 60 J ( than) S 60 J ( to) S 60 J ( set) S 60 J ( up) S 60 J ( device) S 60 J ( queue) S 
1200 5460 P (object\(s\),) S 60 J ( while) S 60 J ( the) S 60 J ( designer) S 60 J ( of) S 60 J ( a) S 60 J ( driver) S 60 J ( for) S 60 J ( an) S 60 J ( add-on) S 60 J ( bus) S 60 J ( controller) S 60 J ( and) S 60 J ( of) S 60 J ( a) S 60 J ( set) S 60 J ( of) S 60 J ( class) S 
1200 5720 P (drivers) S 60 J ( is) S 60 J ( slightly) S 60 J ( more) S 60 J ( likely) S 60 J ( to) S 60 J ( use) S 60 J ( device) S 60 J ( queue) S 60 J ( objects.) S 
1200 6100 P (Such) S 60 J ( a) S 60 J ( driver's) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( might) S 60 J ( use) S 60 J ( device) S 60 J ( queue) S 60 J ( objects) S 60 J ( to) S 60 J ( manage) S 60 J ( the) S 
1200 6360 P (processing) S 60 J ( of) S 60 J ( IRPs) S 60 J ( bound) S 60 J ( for) S 60 J ( heterogeneous) S 60 J ( target) S 60 J ( devices) S 60 J ( by) S 60 J ( doing) S 60 J ( something) S 60 J ( like) S 60 J ( the) S 
1200 6620 P (following:) S 
1680 7140 P 0 12 F 0 12 F ({) S 
1680 7400 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
1680 7660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
1680 7920 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
1680 8180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
1680 8440 P () S 480 J ( PATTACHED_DEVICE_CODE) S 144 J ( code) S 144 J ( =) S 
1680 8700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.Key;) S 
1680 8960 P () S 480 J ( PKDEVICE_QUEUE_ENTRY) S 144 J ( packet;) S 
1680 9220 P () S 480 J ( PIRP) S 144 J ( nextIrp;) S 
1680 9480 P () S 480 J ( PIRP) S 144 J ( listIrp;) S 
1680 9740 P () S 480 J ( PATTACHED_DEVICE_STATE) S 144 J ( attachedDevice;) S 
1680 10000 P () S 480 J ( KIRQL) S 144 J ( currentIrql;) S 
1680 10260 P (//) S 
1680 10520 P (//) S 144 J ( Get) S 144 J ( which) S 144 J ( device) S 144 J ( this) S 144 J ( request) S 144 J ( is) S 144 J ( for.) S 
1680 10780 P (//) S 
1680 11040 P () S 480 J ( attachedDevice) S 144 J ( =) S 144 J ( GetAttachedDeviceState\() S 
1680 11300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension,) S 
1680 11560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( code\);) S 
1680 11820 P () S 480 J ( if) S 144 J ( \(attachedDevice) S 144 J ( ==) S 144 J ( NULL\)) S 144 J ( {) S 
1680 12080 P () S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( STATUS_NO_SUCH_DEVICE;) S 
1680 12340 P () S 480 J ( ) S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
1680 12600 P () S 480 J ( ) S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_NO_INCREMENT\);) S 
1680 12860 P () S 480 J ( ) S 480 J ( return\(STATUS_NO_SUCH_DEVICE\);) S 
1680 13120 P () S 480 J ( }) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 807 J ( 7-) S E B (21) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( switch) S 144 J ( \(irpSp->MajorFunction\)) S 144 J ( {) S 
2400 2320 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_READ:) S 
2400 2580 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_WRITE:) S 
2400 2840 P (//) S 
2400 3100 P (//) S 144 J ( Set) S 144 J ( IRP) S 144 J ( status) S 144 J ( to) S 144 J ( pending) S 144 J ( and) S 144 J ( queue) S 144 J ( the) S 144 J ( IRP) S 
2400 3360 P (//) S 144 J ( to) S 144 J ( this) S 144 J ( device) S 144 J ( or) S 144 J ( to) S 144 J ( our) S 144 J ( shared) S 144 J ( device) S 144 J ( controller.) S 
2400 3620 P (//) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoMarkIrpPending\(Irp\);) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( KeRaiseIrql\(DISPATCH_LEVEL,) S 144 J ( &currentIrql\);) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(!KeInsertDeviceQueue\() S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &attachedDevice->RequestQueue,) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &Irp->Tail.Overlay.DeviceQueueEntry\)\)) S 144 J ( {) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( attachedDevice->RetryCount) S 144 J ( =) S 144 J ( 0;) S 
2400 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoStartPacket\() S 
2400 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject,) S 
2400 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp,) S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PULONG\)) S 144 J ( NULL,) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( NULL\);) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
2400 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( KeLowerIrql\(currentIrql\);) S 
2400 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( return\(STATUS_PENDING\);) S 
2400 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
2400 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( other) S 144 J ( case\(s\)) S 
2400 8040 P () S 480 J ( }) S 144 J ( //end) S 144 J ( switch) S 
2400 8300 P (}) S 
1920 8680 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( a) S 60 J ( call) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (KeInsertDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( \(or) S 60 J ( ) S 0 12 F 24 12 F B (KeInsertByKeyDeviceQueue) S E 0 12 F 24 12 F (\)) S 60 J ( sets) S 60 J ( the) S 60 J ( state) S 60 J ( of) S 
1920 8940 P (the) S 60 J ( device) S 60 J ( queue) S 60 J ( object) S 60 J ( to) S 60 J ( Busy,) S 60 J ( even) S 60 J ( if) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( is) S 60 J ( not) S 60 J ( inserted) S 60 J ( into) S 60 J ( the) S 60 J ( queue.) S 60 J ( A) S 
1920 9200 P (reciprocal) S 60 J ( call) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (KeRemove..DeviceQueue) S E 0 12 F 24 12 F () S 60 J ( resets) S 60 J ( the) S 60 J ( state) S 60 J ( of) S 60 J ( an) S 60 J ( empty) S 60 J ( device) S 60 J ( queue) S 60 J ( object) S 
1920 9460 P (to) S 60 J ( Not-Busy.) S 
1920 9840 P (By) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F (,) S 60 J ( such) S 60 J ( a) S 60 J ( driver's) S 60 J ( Dispatch) S 60 J ( routines) S 60 J ( synchronize) S 60 J ( calls) S 60 J ( to) S 60 J ( its) S 60 J ( StartIo) S 
1920 10100 P (routine) S 60 J ( using) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( that) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( created) S 60 J ( when) S 60 J ( this) S 60 J ( driver) S 60 J ( created) S 60 J ( its) S 60 J ( own) S 
1920 10360 P (device) S 60 J ( object) S 60 J ( \(for) S 60 J ( the) S 60 J ( shared) S 60 J ( device) S 60 J ( controller\).) S 60 J ( However,) S 60 J ( the) S 60 J ( driver's) S 60 J ( closely) S 60 J ( coupled) S 60 J ( class) S 
1920 10620 P (drivers) S 60 J ( must) S 60 J ( identify) S 60 J ( their) S 60 J ( devices) S 60 J ( in) S 60 J ( the) S 60 J ( IRPs) S 60 J ( they) S 60 J ( send) S 60 J ( down) S 60 J ( to) S 60 J ( this) S 60 J ( port) S 60 J ( driver) S 60 J ( so) S 60 J ( that) S 60 J ( it) S 60 J ( can) S 
1920 10880 P (attempt) S 60 J ( to) S 60 J ( insert) S 60 J ( each) S 60 J ( IRP) S 60 J ( into) S 60 J ( the) S 60 J ( appropriate) S 60 J ( driver-managed) S 60 J ( device) S 60 J ( queue) S 60 J ( first.) S 
1920 11260 P (Note) S 60 J ( also) S 60 J ( that) S 60 J ( incoming) S 60 J ( requests) S 60 J ( for) S 60 J ( all) S 60 J ( devices) S 60 J ( are) S 60 J ( effectively) S 60 J ( processed) S 60 J ( on) S 60 J ( a) S 60 J ( first-come,) S 
1920 11520 P (first-served) S 60 J ( basis) S 60 J ( until) S 60 J ( a) S 60 J ( call) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (KeInsertDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( puts) S 60 J ( an) S 60 J ( IRP) S 60 J ( into) S 60 J ( this) S 60 J ( driver's) S 60 J ( device) S 
1920 11780 P (queue) S 60 J ( for) S 60 J ( a) S 60 J ( particular) S 60 J ( device.) S 60 J ( By) S 60 J ( using) S 60 J ( its) S 60 J ( own) S 60 J ( device) S 60 J ( queue) S 60 J ( for) S 60 J ( all) S 60 J ( IRPs) S 60 J ( to) S 60 J ( be) S 60 J ( processed) S 
1920 12040 P (through) S 60 J ( its) S 60 J ( StartIo) S 60 J ( routine,) S 60 J ( this) S 60 J ( driver) S 60 J ( serializes) S 60 J ( operations) S 60 J ( through) S 60 J ( the) S 60 J ( shared) S 60 J ( device) S 60 J ( \(or) S 60 J ( bus\)) S 
1920 12300 P (controller) S 60 J ( to) S 60 J ( all) S 60 J ( attached) S 60 J ( devices.) S 60 J ( By) S 60 J ( sometimes) S 60 J ( holding) S 60 J ( IRPs) S 60 J ( for) S 60 J ( each) S 60 J ( supported) S 60 J ( device) S 60 J ( in) S 60 J ( a) S 
1920 12560 P (separate) S 60 J ( device) S 60 J ( queue,) S 60 J ( this) S 60 J ( driver) S 60 J ( inhibits) S 60 J ( the) S 60 J ( processing) S 60 J ( of) S 60 J ( IRPs) S 60 J ( for) S 60 J ( an) S 60 J ( already) S 60 J ( busy) S 60 J ( device) S 
1920 12820 P (while) S 60 J ( increasing) S 60 J ( I/O) S 60 J ( throughput) S 60 J ( for) S 60 J ( every) S 60 J ( other) S 60 J ( attached) S 60 J ( device.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (22) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (At) S 60 J ( the) S 60 J ( call) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F () S 60 J ( from) S 60 J ( the) S 60 J ( preceding) S 60 J ( Dispatch) S 60 J ( routine,) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( either) S 60 J ( calls) S 
1200 2320 P (the) S 60 J ( driver's) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( immediately) S 60 J ( or) S 60 J ( puts) S 60 J ( the) S 60 J ( IRP) S 60 J ( into) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( associated) S 60 J ( with) S 
1200 2580 P (the) S 60 J ( device) S 60 J ( object) S 60 J ( for) S 60 J ( the) S 60 J ( shared) S 60 J ( controller.) S 60 J ( Its) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( might) S 60 J ( do) S 60 J ( something) S 60 J ( like) S 60 J ( the) S 
1200 2840 P (following:) S 
1680 3360 P 0 12 F 0 12 F ({) S 
1680 3620 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
1680 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
1680 4140 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
1680 4660 P () S 480 J ( PATTACHED_DEVICE_CODE) S 144 J ( code;) S 
1680 4920 P () S 480 J ( PATTACHED_DEVICE_STATE) S 144 J ( attachedDevice;) S 
1680 5180 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 5440 P (//) S 
1680 5700 P (//) S 144 J ( Switch) S 144 J ( on) S 144 J ( MajorFunction) S 144 J ( code) S 144 J ( in) S 144 J ( IRP.) S 
1680 5960 P (//) S 
1680 6220 P () S 480 J ( switch) S 144 J ( \(irpSp->MajorFunction\)) S 144 J ( {) S 
1680 6480 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_READ:) S 
1680 6740 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_WRITE:) S 
1680 7000 P (//) S 
1680 7260 P (//) S 144 J ( Get) S 144 J ( which) S 144 J ( device) S 144 J ( this) S 144 J ( request) S 144 J ( is) S 144 J ( for.) S 
1680 7520 P (//) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( code) S 144 J ( =) S 144 J ( irpSp->Parameters.Read.Key;) S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( attachedDevice) S 144 J ( =) S 144 J ( GetAttachedDeviceState\() S 
1680 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension,) S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( code\);) S 
1680 8820 P (//) S 
1680 9080 P (//) S 144 J ( Increment) S 144 J ( the) S 144 J ( following) S 144 J ( to) S 144 J ( get) S 144 J ( a) S 144 J ( unique) S 144 J ( value) S 
1680 9340 P (//) S 144 J ( to) S 144 J ( give) S 144 J ( the) S 144 J ( error) S 144 J ( log) S 144 J ( routine,) S 144 J ( if) S 144 J ( necessary.) S 
1680 9600 P (//) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( attachedDevice->SequenceNumber++;) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 10640 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_DEVICE_CONTROL:) S 
1680 10900 P (//) S 
1680 11160 P (//) S 144 J ( Get) S 144 J ( which) S 144 J ( device) S 144 J ( this) S 144 J ( request) S 144 J ( is) S 144 J ( for.) S 
1680 11420 P (//) S 
1680 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( code) S 144 J ( =) S 144 J ( irpSp->Parameters.DeviceIoControl.) S 
1680 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Type3InputBuffer;) S 
1680 12200 P () S 480 J ( ) S 480 J ( ) S 480 J ( attachedDevice) S 144 J ( =) S 144 J ( GetAttachedDeviceState\() S 
1680 12460 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension,) S 
1680 12720 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( code\);) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2097 J ( StartIo) S 55 J ( Routine) S 55 J ( or) S 55 J ( Queue-management) S 55 J ( Routines) S 807 J ( 7-) S E B (23) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Increment) S 144 J ( the) S 144 J ( following) S 144 J ( to) S 144 J ( get) S 144 J ( a) S 144 J ( unique) S 144 J ( value) S 
2400 2580 P (//) S 144 J ( to) S 144 J ( give) S 144 J ( the) S 144 J ( error) S 144 J ( log) S 144 J ( routine,) S 144 J ( if) S 144 J ( necessary.) S 
2400 2840 P (//) S 
2400 3100 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
2400 3360 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( switch) S 
2400 3620 P (}) S 
1920 4000 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( the) S 60 J ( preceding) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( also) S 60 J ( must) S 60 J ( check) S 60 J ( information,) S 60 J ( which) S 60 J ( each) S 60 J ( class) S 60 J ( driver) S 
1920 4260 P (set) S 60 J ( in) S 60 J ( the) S 60 J ( port) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( of) S 60 J ( the) S 60 J ( IRP,) S 60 J ( to) S 60 J ( determine) S 60 J ( the) S 60 J ( \(attached\)) S 60 J ( target) S 60 J ( device) S 
1920 4520 P (for) S 60 J ( the) S 60 J ( given) S 60 J ( request.) S 60 J ( The) S 60 J ( device) S 60 J ( object) S 60 J ( pointer) S 60 J ( input) S 60 J ( to) S 60 J ( its) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( gives) S 60 J ( the) S 60 J ( port) S 60 J ( driver) S 
1920 4780 P (access) S 60 J ( to) S 60 J ( its) S 60 J ( own) S 60 J ( device) S 60 J ( object) S 60 J ( \(representing) S 60 J ( the) S 60 J ( device) S 60 J ( controller\).) S 60 J ( It) S 60 J ( does) S 60 J ( ) S 0 12 F 24 12 F I (not) S E 0 12 F 24 12 F () S 60 J ( give) S 60 J ( this) S 60 J ( driver) S 
1920 5040 P (access) S 60 J ( to) S 60 J ( the) S 60 J ( class) S 60 J ( driver's) S 60 J ( device) S 60 J ( object) S 60 J ( for) S 60 J ( the) S 60 J ( target) S 60 J ( device.) S 60 J ( Such) S 60 J ( a) S 60 J ( port) S 60 J ( driver) S 60 J ( must) S 60 J ( maintain) S 
1920 5300 P (its) S 60 J ( own) S 60 J ( state) S 60 J ( information) S 60 J ( about) S 60 J ( each) S 60 J ( of) S 60 J ( the) S 60 J ( heterogeneous) S 60 J ( devices) S 60 J ( that) S 60 J ( it) S 60 J ( services) S 60 J ( through) S 60 J ( the) S 
1920 5560 P (shared) S 60 J ( device) S 60 J ( controller.) S 
1920 5940 P (In) S 60 J ( fact,) S 60 J ( an) S 60 J ( NT) S 60 J ( driver) S 60 J ( ) S 0 12 F 24 12 F I (cannot) S E 0 12 F 24 12 F () S 60 J ( get) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( device) S 60 J ( object) S 60 J ( of) S 60 J ( any) S 60 J ( driver) S 60 J ( layered) S 60 J ( above) S 
1920 6200 P (itself) S 60 J ( easily.) S 60 J ( By) S 60 J ( design,) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( does) S 60 J ( not) S 60 J ( provide) S 60 J ( a) S 60 J ( support) S 60 J ( routine) S 60 J ( for) S 60 J ( getting) S 60 J ( such) S 60 J ( a) S 
1920 6460 P (pointer.) S 60 J ( Moreover,) S 60 J ( the) S 60 J ( order) S 60 J ( in) S 60 J ( which) S 60 J ( NT) S 60 J ( drivers) S 60 J ( are) S 60 J ( loaded) S 60 J ( makes) S 60 J ( it) S 60 J ( impossible) S 60 J ( for) S 60 J ( lower) S 
1920 6720 P (drivers) S 60 J ( to) S 60 J ( get) S 60 J ( pointers) S 60 J ( for) S 60 J ( higher) S 60 J ( drivers') S 60 J ( device) S 60 J ( objects,) S 60 J ( which) S 60 J ( have) S 60 J ( not) S 60 J ( yet) S 60 J ( been) S 60 J ( created) S 60 J ( when) S 
1920 6980 P (any) S 60 J ( lower-level) S 60 J ( driver) S 60 J ( is) S 60 J ( initializing) S 60 J ( itself.) S 
1920 7360 P (An) S 60 J ( NT) S 60 J ( driver) S 60 J ( ) S 0 12 F 24 12 F I (cannot) S 60 J ( use) S E 0 12 F 24 12 F () S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( device) S 60 J ( object) S 60 J ( of) S 60 J ( any) S 60 J ( driver) S 60 J ( layered) S 60 J ( above) S 60 J ( itself) S 
1920 7620 P (because) S 60 J ( there) S 60 J ( is) S 60 J ( no) S 60 J ( way) S 60 J ( to) S 60 J ( synchronize) S 60 J ( access) S 60 J ( to) S 60 J ( a) S 60 J ( single) S 60 J ( device) S 60 J ( object) S 60 J ( \(and) S 60 J ( its) S 60 J ( device) S 
1920 7880 P (extension\)) S 60 J ( between) S 60 J ( two) S 60 J ( drivers) S 60 J ( in) S 60 J ( a) S 60 J ( multiprocessor-safe) S 60 J ( manner) S 60 J ( and) S 60 J ( because) S 60 J ( neither) S 60 J ( driver) S 
1920 8140 P (can) S 60 J ( make) S 60 J ( any) S 60 J ( assumptions) S 60 J ( about) S 60 J ( what) S 60 J ( I/O) S 60 J ( processing) S 60 J ( the) S 60 J ( other) S 60 J ( driver) S 60 J ( is) S 60 J ( currently) S 60 J ( doing.) S 60 J ( Even) S 
1920 8400 P (for) S 60 J ( closely) S 60 J ( coupled) S 60 J ( class/port) S 60 J ( drivers,) S 60 J ( each) S 60 J ( class) S 60 J ( driver) S 60 J ( should) S 60 J ( use) S 60 J ( the) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( port) S 
1920 8660 P (driver's) S 60 J ( device) S 60 J ( object\(s\)) S 60 J ( only) S 60 J ( to) S 60 J ( pass) S 60 J ( on) S 60 J ( IRPs) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F (.) S 60 J ( The) S 60 J ( underlying) S 60 J ( port) S 60 J ( driver) S 
1920 8920 P (must) S 60 J ( maintain) S 60 J ( its) S 60 J ( own) S 60 J ( state,) S 60 J ( probably) S 60 J ( in) S 60 J ( the) S 60 J ( port) S 60 J ( driver's) S 60 J ( device) S 60 J ( and/or) S 60 J ( controller) S 60 J ( extensions,) S 
1920 9180 P (about) S 60 J ( requests) S 60 J ( that) S 60 J ( it) S 60 J ( processes) S 60 J ( for) S 60 J ( any) S 60 J ( closely) S 60 J ( coupled) S 60 J ( class) S 60 J ( driver\(s\)') S 60 J ( device\(s\).) S 
1920 9560 P (A) S 60 J ( port) S 60 J ( driver) S 60 J ( that) S 60 J ( queues) S 60 J ( IRPs) S 60 J ( as) S 60 J ( shown) S 60 J ( in) S 60 J ( the) S 60 J ( preceding) S 60 J ( code) S 60 J ( fragments) S 60 J ( also) S 60 J ( must) S 60 J ( handle) S 60 J ( the) S 
1920 9820 P (following) S 60 J ( situation) S 60 J ( efficiently:) S 
1920 10140 P () S 104 J ( 1) S 256 J ( Its) S 60 J ( Dispatch) S 60 J ( routines) S 60 J ( have) S 60 J ( inserted) S 60 J ( IRPs) S 60 J ( for) S 60 J ( a) S 60 J ( particular) S 60 J ( device) S 60 J ( in) S 60 J ( the) S 60 J ( driver-created) S 
2400 10400 P (device) S 60 J ( queue) S 60 J ( for) S 60 J ( that) S 60 J ( device.) S 
1920 10720 P () S 104 J ( 2) S 256 J ( IRPs) S 60 J ( for) S 60 J ( other) S 60 J ( devices) S 60 J ( continue) S 60 J ( to) S 60 J ( come) S 60 J ( in,) S 60 J ( be) S 60 J ( queued) S 60 J ( to) S 60 J ( the) S 60 J ( driver's) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( with) S 
2400 10980 P 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F (,) S 60 J ( and) S 60 J ( be) S 60 J ( processed) S 60 J ( through) S 60 J ( the) S 60 J ( shared) S 60 J ( device) S 60 J ( controller.) S 
1920 11300 P () S 104 J ( 3) S 256 J ( The) S 60 J ( device) S 60 J ( controller) S 60 J ( does) S 60 J ( not) S 60 J ( become) S 60 J ( idle,) S 60 J ( but) S 60 J ( each) S 60 J ( IRP) S 60 J ( held) S 60 J ( in) S 60 J ( the) S 60 J ( driver-created) S 
2400 11560 P (device) S 60 J ( queue) S 60 J ( also) S 60 J ( must) S 60 J ( be) S 60 J ( queued) S 60 J ( to) S 60 J ( the) S 60 J ( driver's) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( as) S 60 J ( soon) S 60 J ( as) S 60 J ( possible.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (7-) S E B (24) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (Consequently,) S 60 J ( such) S 60 J ( a) S 60 J ( port) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( must) S 60 J ( attempt) S 60 J ( to) S 60 J ( transfer) S 60 J ( an) S 60 J ( IRP) S 60 J ( from) S 60 J ( the) S 60 J ( driver's) S 
1200 2320 P (internal) S 60 J ( device) S 60 J ( queue) S 60 J ( for) S 60 J ( a) S 60 J ( particular) S 60 J ( device) S 60 J ( into) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( for) S 60 J ( the) S 60 J ( shared) S 60 J ( controller) S 
1200 2580 P (whenever) S 60 J ( it) S 60 J ( completes) S 60 J ( an) S 60 J ( IRP,) S 60 J ( as) S 60 J ( follows:) S 
1200 2900 P () S 104 J ( 1) S 256 J ( The) S 60 J ( DpcForIsr) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( have) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( begin) S 60 J ( processing) S 60 J ( the) S 
1680 3160 P (next) S 60 J ( IRP) S 60 J ( queued) S 60 J ( to) S 60 J ( the) S 60 J ( shared) S 60 J ( device) S 60 J ( controller.) S 
1200 3480 P () S 104 J ( 2) S 256 J ( The) S 60 J ( DpcForIsr) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( dequeue) S 60 J ( the) S 60 J ( next) S 60 J ( IRP) S 60 J ( \(if) S 60 J ( any\)) S 60 J ( that) S 60 J ( it) S 60 J ( is) S 
1680 3740 P (holding) S 60 J ( in) S 60 J ( its) S 60 J ( internal) S 60 J ( device) S 60 J ( queue) S 60 J ( for) S 60 J ( the) S 60 J ( device) S 60 J ( on) S 60 J ( whose) S 60 J ( behalf) S 60 J ( it) S 60 J ( is) S 60 J ( about) S 60 J ( to) S 60 J ( complete) S 
1680 4000 P (an) S 60 J ( IRP.) S 
1200 4320 P () S 104 J ( 3) S 256 J ( If) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( returns) S 60 J ( a) S 60 J ( nonNULL) S 60 J ( pointer,) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( calls) S 
1680 4580 P 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( just) S 60 J ( dequeued) S 60 J ( IRP) S 60 J ( to) S 60 J ( have) S 60 J ( it) S 60 J ( queued) S 60 J ( to) S 60 J ( the) S 60 J ( shared) S 60 J ( device) S 
1680 4840 P (controller.) S 60 J ( Otherwise,) S 60 J ( the) S 60 J ( call) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( simply) S 60 J ( resets) S 60 J ( the) S 60 J ( state) S 60 J ( of) S 60 J ( the) S 
1680 5100 P (device) S 60 J ( queue) S 60 J ( object) S 60 J ( to) S 60 J ( Not-Busy,) S 60 J ( and) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( omits) S 60 J ( the) S 60 J ( call) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F (.) S 
1200 5420 P () S 104 J ( 4) S 256 J ( Then,) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( for) S 60 J ( which) S 60 J ( the) S 60 J ( port) S 
1680 5680 P (driver) S 60 J ( has) S 60 J ( just) S 60 J ( completed) S 60 J ( I/O) S 60 J ( processing,) S 60 J ( either) S 60 J ( by) S 60 J ( setting) S 60 J ( the) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( with) S 60 J ( an) S 
1680 5940 P (error) S 60 J ( or) S 60 J ( by) S 60 J ( satisfying) S 60 J ( the) S 60 J ( I/O) S 60 J ( request.) S 
1200 6320 P (Note) S 60 J ( that) S 60 J ( the) S 60 J ( preceding) S 60 J ( guidelines) S 60 J ( imply) S 60 J ( that) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( also) S 60 J ( must) S 60 J ( call) S 60 J ( the) S 60 J ( internal) S 
1200 6580 P (GetAttachedDeviceState) S 60 J ( routine) S 60 J ( shown) S 60 J ( in) S 60 J ( the) S 60 J ( preceding) S 60 J ( code) S 60 J ( fragments.) S 60 J ( That) S 60 J ( is,) S 60 J ( the) S 
1200 6840 P (DpcForIsr) S 60 J ( must) S 60 J ( determine) S 60 J ( the) S 60 J ( device) S 60 J ( for) S 60 J ( which) S 60 J ( it) S 60 J ( is) S 60 J ( completing) S 60 J ( the) S 60 J ( current) S 60 J ( \(input\)) S 60 J ( IRP) S 60 J ( in) S 
1200 7100 P (order) S 60 J ( to) S 60 J ( manage) S 60 J ( the) S 60 J ( internal) S 60 J ( queueing) S 60 J ( of) S 60 J ( IRPs) S 60 J ( efficiently.) S 60 J ( If) S 60 J ( such) S 60 J ( a) S 60 J ( port) S 60 J ( driver) S 60 J ( attempted) S 60 J ( to) S 
1200 7360 P (wait) S 60 J ( until) S 60 J ( the) S 60 J ( shared) S 60 J ( controller) S 60 J ( was) S 60 J ( idle) S 60 J ( before) S 60 J ( dequeueing) S 60 J ( IRPs) S 60 J ( held) S 60 J ( in) S 60 J ( its) S 60 J ( internal) S 60 J ( queues,) S 60 J ( the) S 
1200 7620 P (driver) S 60 J ( might) S 60 J ( starve) S 60 J ( a) S 60 J ( device) S 60 J ( for) S 60 J ( which) S 60 J ( there) S 60 J ( was) S 60 J ( a) S 60 J ( heavy) S 60 J ( I/O) S 60 J ( demand) S 60 J ( while) S 60 J ( it) S 60 J ( promptly) S 
1200 7880 P (serviced) S 60 J ( every) S 60 J ( other) S 60 J ( device) S 60 J ( for) S 60 J ( which) S 60 J ( the) S 60 J ( current) S 60 J ( I/O) S 60 J ( demand) S 60 J ( was) S 60 J ( actually) S 60 J ( much) S 60 J ( lighter.) S 0 12 F 
PE PSe
