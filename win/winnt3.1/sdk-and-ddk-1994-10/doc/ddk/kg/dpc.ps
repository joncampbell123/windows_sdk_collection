%!PS-Adobe-2.0 
PSp 15840 SFL 
1920 2440 P 8 18 F B (Chapter) S 100 J ( 9) S E 
1920 2840 P B (DpcForIsr) S 100 J ( Routine) S 100 J ( and) S 100 J ( CustomDpc) S 100 J ( Routines) S E 
1920 3600 P 0 12 F 24 12 F (This) S 60 J ( chapter) S 60 J ( summarizes) S 60 J ( the) S 60 J ( required) S 60 J ( functionality) S 60 J ( of) S 60 J ( an) S 60 J ( NT) S 60 J ( device) S 60 J ( driver's) S 60 J ( standard) S 
1920 3860 P (DpcForIsr) S 60 J ( routine) S 60 J ( and/or) S 60 J ( CustomDpc) S 60 J ( routines.) S 
1920 4660 P 0 12 F 8 14 F B (9.1) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( DpcForIsr) S 78 J ( and) S 78 J ( CustomDpc) S 78 J ( Routine) S 78 J ( Requirements) S E 
1920 5280 P 0 12 F 24 12 F (If) S 60 J ( an) S 60 J ( NT) S 60 J ( driver) S 60 J ( has) S 60 J ( an) S 60 J ( ISR,) S 60 J ( it) S 60 J ( must) S 60 J ( also) S 60 J ( have) S 60 J ( a) S 60 J ( DpcForIsr) S 60 J ( or) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( to) S 60 J ( complete) S 
1920 5540 P (its) S 60 J ( processing) S 60 J ( of) S 60 J ( interrupt-driven) S 60 J ( I/O) S 60 J ( operations.) S 60 J ( A) S 60 J ( DpcForIsr) S 60 J ( or) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( is) S 60 J ( run) S 60 J ( in) S 
1920 5800 P (an) S 60 J ( arbitrary) S 60 J ( thread) S 60 J ( context) S 60 J ( at) S 60 J ( DISPATCH_LEVEL) S 60 J ( IRQL.) S 60 J ( Running) S 60 J ( at) S 60 J ( IRQL) S 
1920 6060 P (DISPATCH_LEVEL) S 60 J ( restricts) S 60 J ( the) S 60 J ( set) S 60 J ( of) S 60 J ( support) S 60 J ( routines) S 60 J ( a) S 60 J ( DpcForIsr) S 60 J ( or) S 60 J ( CustomDpc) S 60 J ( routine) S 
1920 6320 P (can) S 60 J ( call.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( managing) S 60 J ( IRQLs,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 60 J ( For) S 60 J ( specific) S 
1920 6580 P (information) S 60 J ( about) S 60 J ( the) S 60 J ( IRQL\(s\)) S 60 J ( at) S 60 J ( which) S 60 J ( any) S 60 J ( particular) S 60 J ( support) S 60 J ( routine) S 60 J ( can) S 60 J ( be) S 60 J ( called,) S 60 J ( see) S 60 J ( the) S 
1920 6840 P 0 12 F 24 12 F I (Kernel-mode) S 60 J ( Driver) S 60 J ( Reference) S E 0 12 F 24 12 F (.) S 
1920 7220 P (Depending) S 60 J ( on) S 60 J ( the) S 60 J ( driver's) S 60 J ( design,) S 60 J ( it) S 60 J ( can) S 60 J ( have) S 60 J ( a) S 60 J ( single) S 60 J ( DpcForIsr) S 60 J ( to) S 60 J ( complete) S 60 J ( all) S 60 J ( interrupt-) S 
1920 7480 P (driven) S 60 J ( I/O) S 60 J ( operations,) S 60 J ( have) S 60 J ( both) S 60 J ( a) S 60 J ( DpcForIsr) S 60 J ( and) S 60 J ( a) S 60 J ( set) S 60 J ( of) S 60 J ( operation-specific) S 60 J ( CustomDpc) S 
1920 7740 P (routines) S 60 J ( to) S 60 J ( be) S 60 J ( queued) S 60 J ( from) S 60 J ( its) S 60 J ( ISR,) S 60 J ( or) S 60 J ( have) S 60 J ( a) S 60 J ( set) S 60 J ( of) S 60 J ( CustomDpc) S 60 J ( routines.) S 60 J ( For) S 60 J ( example,) S 60 J ( the) S 
1920 8000 P (NT-supplied) S 60 J ( serial) S 60 J ( driver) S 60 J ( has) S 60 J ( no) S 60 J ( DpcForIsr,) S 60 J ( but) S 60 J ( has) S 60 J ( several) S 60 J ( CustomDpc) S 60 J ( routines,) S 60 J ( among) S 60 J ( them) S 
1920 8260 P (two) S 60 J ( that) S 60 J ( handle) S 60 J ( completion) S 60 J ( processing) S 60 J ( for) S 60 J ( read) S 60 J ( and) S 60 J ( write) S 60 J ( requests) S 60 J ( and) S 60 J ( another) S 60 J ( that) S 60 J ( is) S 60 J ( queued) S 
1920 8520 P (when) S 60 J ( the) S 60 J ( ISR) S 60 J ( detects) S 60 J ( a) S 60 J ( device-error) S 60 J ( condition.) S 
1920 8900 P (However,) S 60 J ( most) S 60 J ( NT) S 60 J ( drivers) S 60 J ( of) S 60 J ( devices) S 60 J ( that) S 60 J ( do) S 60 J ( only) S 60 J ( one) S 60 J ( I/O) S 60 J ( operation) S 60 J ( at) S 60 J ( a) S 60 J ( time) S 60 J ( have) S 60 J ( only) S 60 J ( a) S 
1920 9160 P (DpcForIsr) S 60 J ( routine) S 60 J ( for) S 60 J ( simplicity.) S 60 J ( On) S 60 J ( entry,) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( is) S 60 J ( usually) S 60 J ( given) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 
1920 9420 P (current) S 60 J ( IRP,) S 60 J ( target) S 60 J ( device) S 60 J ( object,) S 60 J ( and) S 60 J ( context) S 60 J ( information) S 60 J ( passed) S 60 J ( in) S 60 J ( the) S 60 J ( ISR's) S 60 J ( call) S 60 J ( to) S 
1920 9680 P 0 12 F 24 12 F B (IoRequestDpc) S E 0 12 F 24 12 F (.) S 60 J ( Any) S 60 J ( context) S 60 J ( information) S 60 J ( passed) S 60 J ( to) S 60 J ( a) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( is) S 60 J ( driver-determined.) S 
1920 10060 P (A) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( is) S 60 J ( generally) S 60 J ( responsible) S 60 J ( for) S 60 J ( the) S 60 J ( following:) S 
1920 10380 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Completing) S 60 J ( the) S 60 J ( I/O) S 60 J ( processing) S 60 J ( requested) S 60 J ( by) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( for) S 60 J ( the) S 60 J ( input) S 60 J ( target) S 60 J ( device) S 
2400 10640 P (object) S 
1920 10960 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Seeing) S 60 J ( that) S 60 J ( the) S 60 J ( next) S 60 J ( IRP) S 60 J ( is) S 60 J ( processed) S 60 J ( as) S 60 J ( soon) S 60 J ( as) S 60 J ( possible,) S 60 J ( usually) S 60 J ( by) S 60 J ( calling) S 
2400 11220 P 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F () S 60 J ( \(see) S 60 J ( Chapter) S 60 J ( 4\)) S 60 J ( or) S 60 J ( ) S 0 12 F 24 12 F B (IoStartNextPacketByKey) S E 0 12 F 24 12 F () S 60 J ( so) S 60 J ( the) S 60 J ( driver's) S 60 J ( StartIo) S 
2400 11480 P (routine) S 60 J ( will) S 60 J ( start) S 60 J ( the) S 60 J ( next) S 60 J ( requested) S 60 J ( operation) S 60 J ( on) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 
1920 11800 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Setting) S 60 J ( the) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( in) S 60 J ( the) S 60 J ( IRP) S 60 J ( and) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (2) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (Depending) S 60 J ( on) S 60 J ( the) S 60 J ( driver,) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( or) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( can) S 60 J ( do) S 60 J ( any) S 60 J ( of) S 60 J ( the) S 60 J ( following) S 60 J ( in) S 
1200 2320 P (order) S 60 J ( to) S 60 J ( complete) S 60 J ( an) S 60 J ( interrupt-driven) S 60 J ( I/O) S 60 J ( operation:) S 
1200 2640 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Retry) S 60 J ( an) S 60 J ( operation) S 60 J ( that) S 60 J ( has) S 60 J ( timed) S 60 J ( out) S 60 J ( or) S 60 J ( failed) S 60 J ( and/or) S 60 J ( log) S 60 J ( an) S 60 J ( error) S 
1680 2960 P (\(For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( handling) S 60 J ( I/O) S 60 J ( errors,) S 60 J ( see) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( error) S 60 J ( logging) S 60 J ( in) S 
1680 3220 P (Chapter) S 60 J ( 16.\)) S 
1200 3540 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( driver) S 60 J ( uses) S 60 J ( buffered) S 60 J ( I/O,) S 60 J ( as) S 60 J ( described) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 3,) S 60 J ( transfer) S 60 J ( data) S 60 J ( read) S 60 J ( in) S 60 J ( from) S 60 J ( the) S 
1680 3800 P (device) S 60 J ( to) S 60 J ( the) S 60 J ( system) S 60 J ( buffer) S 60 J ( \(found) S 60 J ( in) S 60 J ( the) S 60 J ( IRP) S 60 J ( at) S 60 J ( ) S 0 12 F 24 12 F B (Irp->AssociatedIrp.SystemBuffer) S E 0 12 F 24 12 F (\)) S 
1200 4120 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( driver) S 60 J ( uses) S 60 J ( packet-based) S 60 J ( DMA,) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoFlushAdapterBuffers) S E 0 12 F 24 12 F () S 60 J ( after) S 60 J ( each) S 60 J ( transfer) S 
1680 4380 P (operation,) S 60 J ( and) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoFreeAdapterChannel) S E 0 12 F 24 12 F () S 60 J ( or) S 60 J ( ) S 0 12 F 24 12 F B (IoFreeMapRegisters) S E 0 12 F 24 12 F () S 60 J ( when) S 60 J ( a) S 60 J ( requested) S 
1680 4640 P (transfer) S 60 J ( is) S 60 J ( complete) S 
1680 4960 P (If) S 60 J ( a) S 60 J ( requested) S 60 J ( transfer) S 60 J ( is) S 60 J ( only) S 60 J ( partly) S 60 J ( satisfied) S 60 J ( by) S 60 J ( a) S 60 J ( single) S 60 J ( DMA) S 60 J ( operation,) S 60 J ( the) S 60 J ( DpcForIsr) S 
1680 5220 P (is) S 60 J ( usually) S 60 J ( responsible) S 60 J ( for) S 60 J ( setting) S 60 J ( up) S 60 J ( one) S 60 J ( or) S 60 J ( more) S 60 J ( DMA) S 60 J ( operations) S 60 J ( until) S 60 J ( the) S 60 J ( current) S 60 J ( IRP's) S 
1680 5480 P (requested) S 60 J ( ) S 0 12 F 24 12 F B (Length) S E 0 12 F 24 12 F () S 60 J ( \(number) S 60 J ( of) S 60 J ( bytes\)) S 60 J ( has) S 60 J ( been) S 60 J ( fully) S 60 J ( transferred.) S 60 J ( \(For) S 60 J ( more) S 60 J ( information) S 
1680 5740 P (about) S 60 J ( using) S 60 J ( DMA,) S 60 J ( see) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( adapter) S 60 J ( objects) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 3.) S 60 J ( See) S 60 J ( also) S 60 J ( Chapter) S 60 J ( 11) S 
1680 6000 P (for) S 60 J ( more) S 60 J ( information) S 60 J ( on) S 60 J ( AdapterControl) S 60 J ( routines) S 60 J ( and) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( maintaining) S 60 J ( cache) S 
1680 6260 P (coherency) S 60 J ( during) S 60 J ( DMA) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 16.\)) S 
1200 6580 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( driver) S 60 J ( has) S 60 J ( a) S 60 J ( ControllerControl) S 60 J ( routine,) S 60 J ( described) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 11,) S 60 J ( call) S 
1680 6840 P 0 12 F 24 12 F B (IoFreeController) S E 0 12 F 24 12 F () S 60 J ( when) S 60 J ( a) S 60 J ( requested) S 60 J ( operation) S 60 J ( is) S 60 J ( complete) S 
1200 7220 P (Usually,) S 60 J ( the) S 60 J ( driver's) S 60 J ( ISR) S 60 J ( saves) S 60 J ( context) S 60 J ( information) S 60 J ( for) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( and/or) S 60 J ( CustomDpc) S 
1200 7480 P (routines.) S 60 J ( As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( the) S 60 J ( preceding) S 60 J ( list,) S 60 J ( sometimes) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( or) S 60 J ( CustomDpc) S 60 J ( routine) S 
1200 7740 P (is) S 60 J ( responsible) S 60 J ( for) S 60 J ( retrying) S 60 J ( operations,) S 60 J ( setting) S 60 J ( up) S 60 J ( another) S 60 J ( DMA) S 60 J ( transfer) S 60 J ( operation) S 60 J ( to) S 60 J ( satisfy) S 60 J ( a) S 
1200 8000 P (given) S 60 J ( request,) S 60 J ( or) S 60 J ( otherwise) S 60 J ( accessing) S 60 J ( the) S 60 J ( same) S 60 J ( device) S 60 J ( registers) S 60 J ( or) S 60 J ( context) S 60 J ( area) S 60 J ( as) S 60 J ( the) S 60 J ( ISR) S 
1200 8260 P (does.) S 60 J ( If) S 60 J ( any) S 60 J ( driver) S 60 J ( routine) S 60 J ( shares) S 60 J ( context) S 60 J ( information) S 60 J ( or) S 60 J ( device) S 60 J ( registers) S 60 J ( with) S 60 J ( the) S 60 J ( ISR,) S 60 J ( that) S 
1200 8520 P (routine) S 60 J ( must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( in) S 60 J ( order) S 60 J ( to) S 
1200 8780 P (access) S 60 J ( the) S 60 J ( shared) S 60 J ( context) S 60 J ( safely.) S 
1200 9160 P (Unless) S 60 J ( a) S 60 J ( device) S 60 J ( driver) S 60 J ( serializes) S 60 J ( its) S 60 J ( IRP) S 60 J ( processing) S 60 J ( by) S 60 J ( completing) S 60 J ( each) S 60 J ( request) S 60 J ( before) S 60 J ( it) S 60 J ( starts) S 
1200 9420 P (device) S 60 J ( operations) S 60 J ( for) S 60 J ( the) S 60 J ( next) S 60 J ( IRP,) S 60 J ( an) S 60 J ( NT) S 60 J ( device) S 60 J ( driver) S 60 J ( must) S 60 J ( have) S 60 J ( at) S 60 J ( least) S 60 J ( one) S 
1200 9680 P (SynchCritSection) S 60 J ( routine,) S 60 J ( described) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 10,) S 60 J ( next.) S 60 J ( While) S 60 J ( it) S 60 J ( is) S 60 J ( impossible) S 60 J ( for) S 60 J ( the) S 60 J ( ISR) S 
1200 9940 P (and) S 60 J ( another) S 60 J ( routine) S 60 J ( to) S 60 J ( access) S 60 J ( shared) S 60 J ( state) S 60 J ( concurrently) S 60 J ( if) S 60 J ( a) S 60 J ( driver) S 60 J ( serializes) S 60 J ( IRP) S 60 J ( processing,) S 
1200 10200 P (handling) S 60 J ( IRPs) S 60 J ( in) S 60 J ( this) S 60 J ( manner) S 60 J ( prevents) S 60 J ( the) S 60 J ( driver) S 60 J ( from) S 60 J ( achieving) S 60 J ( the) S 60 J ( best) S 60 J ( possible) S 60 J ( I/O) S 
1200 10460 P (throughput) S 60 J ( for) S 60 J ( its) S 60 J ( device.) S 
1200 10840 P (If) S 60 J ( the) S 60 J ( driver) S 60 J ( has) S 60 J ( a) S 60 J ( CustomDpc) S 60 J ( routine,) S 60 J ( it) S 60 J ( must) S 60 J ( provide) S 60 J ( storage) S 60 J ( for) S 60 J ( a) S 60 J ( Kernel-defined) S 60 J ( DPC) S 
1200 11100 P (object.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( DPC) S 60 J ( objects,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 3.) S 
1200 11480 P (The) S 60 J ( DriverEntry) S 60 J ( routine) S 60 J ( must) S 60 J ( register) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( and) S 60 J ( each) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( the) S 60 J ( driver) S 
1200 11740 P (has) S 60 J ( as) S 60 J ( follows:) S 
1200 12060 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Call) S 60 J ( ) S 0 12 F 24 12 F B (IoInitializeDpcRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( entry) S 60 J ( point) S 60 J ( for) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( and) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 
1680 12320 P (device) S 60 J ( object) S 60 J ( representing) S 60 J ( a) S 60 J ( device) S 60 J ( from) S 60 J ( which) S 60 J ( an) S 60 J ( interrupt) S 60 J ( can) S 60 J ( occur.) S 
1200 12640 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( Call) S 60 J ( ) S 0 12 F 24 12 F B (KeInitializeDpc) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( driver's) S 60 J ( storage) S 60 J ( for) S 60 J ( the) S 60 J ( DPC) S 60 J ( object,) S 60 J ( the) S 60 J ( entry) S 
1680 12900 P (point) S 60 J ( for) S 60 J ( the) S 60 J ( CustomDpc) S 60 J ( routine,) S 60 J ( and) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( a) S 60 J ( context) S 60 J ( area) S 60 J ( \(to) S 60 J ( be) S 60 J ( passed) S 60 J ( to) S 60 J ( the) S 
1680 13160 P (CustomDpc) S 60 J ( routine) S 60 J ( when) S 60 J ( it) S 60 J ( is) S 60 J ( run\).) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 916 J ( 9-) S E B (3) S E B () S 720 J ( ) S E 
1920 2120 P 0 12 F 8 14 F B (9.2) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Implementing) S 78 J ( a) S 78 J ( DpcForIsr) S 78 J ( Routine) S E 
1920 2740 P 0 12 F 24 12 F (As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 7,) S 60 J ( NT) S 60 J ( device) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( buffered) S 60 J ( I/O) S 60 J ( usually) S 60 J ( have) S 60 J ( simpler) S 
1920 3000 P (StartIo) S 60 J ( routines) S 60 J ( than) S 60 J ( those) S 60 J ( that) S 60 J ( use) S 60 J ( direct) S 60 J ( I/O) S 60 J ( because) S 60 J ( the) S 60 J ( former) S 60 J ( transfer) S 60 J ( relatively) S 60 J ( small) S 
1920 3260 P (amounts) S 60 J ( of) S 60 J ( data) S 60 J ( per) S 60 J ( interrupt) S 60 J ( into) S 60 J ( or) S 60 J ( from) S 60 J ( a) S 60 J ( system-space) S 60 J ( buffer) S 60 J ( allocated) S 60 J ( by) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager.) S 
1920 3520 P (Most) S 60 J ( device) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( buffered) S 60 J ( I/O) S 60 J ( also) S 60 J ( have) S 60 J ( simpler) S 60 J ( DpcForIsr) S 60 J ( routines) S 60 J ( than) S 60 J ( those) S 60 J ( that) S 
1920 3780 P (use) S 60 J ( direct) S 60 J ( I/O.) S 
1920 4160 P (Any) S 60 J ( device) S 60 J ( driver) S 60 J ( that) S 60 J ( transfers) S 60 J ( data) S 60 J ( using) S 60 J ( direct) S 60 J ( I/O) S 60 J ( might) S 60 J ( have) S 60 J ( to) S 60 J ( split) S 60 J ( up) S 60 J ( a) S 60 J ( large) S 60 J ( transfer) S 
1920 4420 P (request) S 60 J ( into) S 60 J ( several) S 60 J ( transfer) S 60 J ( operations) S 60 J ( to) S 60 J ( suit) S 60 J ( the) S 60 J ( capabilities) S 60 J ( of) S 60 J ( its) S 60 J ( device:) S 60 J ( that) S 60 J ( is,) S 60 J ( such) S 60 J ( a) S 
1920 4680 P (driver's) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( might) S 60 J ( have) S 60 J ( to) S 60 J ( reprogram) S 60 J ( the) S 60 J ( device) S 60 J ( for) S 60 J ( more) S 60 J ( than) S 60 J ( one) S 60 J ( transfer) S 
1920 4940 P (operation) S 60 J ( in) S 60 J ( order) S 60 J ( to) S 60 J ( satisfy) S 60 J ( a) S 60 J ( given) S 60 J ( read/write) S 60 J ( request) S 60 J ( and) S 60 J ( complete) S 60 J ( that) S 60 J ( IRP.) S 
1920 5320 P (However,) S 60 J ( even) S 60 J ( a) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( buffered) S 60 J ( I/O) S 60 J ( might) S 60 J ( have) S 60 J ( to) S 60 J ( split) S 60 J ( up) S 60 J ( a) S 60 J ( transfer) S 60 J ( if) S 60 J ( its) S 60 J ( device) S 60 J ( has) S 
1920 5580 P (very) S 60 J ( limited) S 60 J ( transfer) S 60 J ( capabilities.) S 
1920 5960 P (Note) S 60 J ( that) S 60 J ( an) S 60 J ( NT) S 60 J ( device) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( usually) S 60 J ( does) S 60 J ( most) S 60 J ( of) S 60 J ( the) S 60 J ( driver's) S 60 J ( device) S 60 J ( I/O) S 
1920 6220 P (processing) S 60 J ( to) S 60 J ( satisfy) S 60 J ( IRPs.) S 60 J ( The) S 60 J ( following) S 60 J ( subsections) S 60 J ( describe) S 60 J ( a) S 60 J ( representative) S 60 J ( set) S 60 J ( of) S 
1920 6480 P (DpcForIsr) S 60 J ( routines) S 60 J ( for) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( buffered) S 60 J ( or) S 60 J ( direct) S 60 J ( I/O.) S 
1920 7120 P 0 12 F 8 12 F B (9.2.1) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( DpcForIsr) S 67 J ( Routines) S 67 J ( in) S 67 J ( Drivers) S 67 J ( Using) S 67 J ( Buffered) S 67 J ( I/O) S E 
1920 7740 P 0 12 F 24 12 F (As) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 8,) S 60 J ( the) S 60 J ( parallel) S 60 J ( driver's) S 60 J ( ISR) S 60 J ( called) S 60 J ( ) S 0 12 F 24 12 F B (IoRequestDpc) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( pointers) S 60 J ( to) S 60 J ( the) S 
1920 8000 P (device) S 60 J ( object) S 60 J ( representing) S 60 J ( the) S 60 J ( parallel) S 60 J ( port) S 60 J ( and) S 60 J ( the) S 60 J ( current) S 60 J ( IRP) S 60 J ( for) S 60 J ( that) S 60 J ( port.) S 60 J ( Since) S 60 J ( this) S 60 J ( driver) S 
1920 8260 P (is) S 60 J ( implemented) S 60 J ( as) S 60 J ( a) S 60 J ( state) S 60 J ( machine) S 60 J ( driven) S 60 J ( by) S 60 J ( interrupts) S 60 J ( \(or) S 60 J ( by) S 60 J ( a) S 60 J ( CustomTimerDpc) S 60 J ( that) S 60 J ( calls) S 60 J ( the) S 
1920 8520 P (ISR\),) S 60 J ( its) S 60 J ( DpcForIsr) S 60 J ( routine,) S 60 J ( ParCompleteWrite,) S 60 J ( has) S 60 J ( very) S 60 J ( little) S 60 J ( work) S 60 J ( to) S 60 J ( do) S 60 J ( except) S 60 J ( to) S 60 J ( complete) S 
1920 8780 P (an) S 60 J ( IRP,) S 60 J ( and) S 60 J ( possibly,) S 60 J ( to) S 60 J ( log) S 60 J ( an) S 60 J ( error,) S 60 J ( as) S 60 J ( follows:) S 
2400 9300 P 0 12 F 0 12 F ({) S 
2400 9820 P () S 480 J ( if) S 144 J ( \(Irp\)) S 144 J ( {) S 
2400 10080 P () S 480 J ( ) S 480 J ( PAR_DEVICE_EXTENSION) S 144 J ( extension) S 144 J ( =) S 
2400 10340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
2400 10600 P () S 480 J ( ) S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
2400 10860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
2400 11120 P () S 480 J ( ) S 480 J ( PAR_DPC_ACTION) S 144 J ( action) S 144 J ( =) S 
2400 11380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PAR_DPC_ACTION\)) S 144 J ( DeferredContext;) S 
2400 11640 P () S 480 J ( ) S 480 J ( PAR_SYNCH_COUNT) S 144 J ( synchCount;) S 
2400 11900 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( remove) S 144 J ( IRP) S 144 J ( from) S 144 J ( cancelable) S 144 J ( state) S 
2400 12160 P () S 480 J ( ) S 480 J ( synchCount.Extension) S 144 J ( =) S 144 J ( extension;) S 
2400 12420 P () S 480 J ( ) S 480 J ( synchCount.OldCount) S 144 J ( =) S 144 J ( 0;) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (4) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( Save) S 144 J ( the) S 144 J ( current) S 144 J ( CountBuffer) S 144 J ( value) S 144 J ( in) S 
1680 2580 P (//) S 144 J ( synchCount->OldCount) S 144 J ( and) S 144 J ( zero) S 144 J ( the) S 144 J ( CountBuffer) S 
1680 2840 P (//) S 144 J ( in) S 144 J ( the) S 144 J ( DeviceExtension.) S 144 J ( This) S 144 J ( must) S 144 J ( be) S 144 J ( done) S 144 J ( with) S 
1680 3100 P (//) S 144 J ( KeSynchronizeExecution) S 144 J ( at) S 144 J ( DIRQL) S 144 J ( in) S 144 J ( case) S 144 J ( the) S 144 J ( ISR) S 
1680 3360 P (//) S 144 J ( is) S 144 J ( currently) S 144 J ( updating) S 144 J ( the) S 144 J ( CountBuffer) S 
1680 3620 P (//) S 
1680 3880 P () S 480 J ( ) S 480 J ( ParSynchronizeExecution\() S 
1680 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension,) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ParSynchCount,) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &synchCount\);) S 
1680 4920 P () S 480 J ( ) S 480 J ( switch) S 144 J ( \(action\)) S 144 J ( {) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( case) S 144 J ( ParCompleteWrite:) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_SUCCESS;) S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 
1680 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Write.Length) S 144 J ( -) S 
1680 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( synchCount.OldCount;) S 
1680 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
1680 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( case) S 144 J ( ParCompleteSetIoctl:) S 
1680 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 
1680 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_SUCCESS;) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( case) S 144 J ( ParPoweredOff:) S 
1680 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_DEVICE_POWERED_OFF;) S 
1680 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
1680 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( cases) S 144 J ( ParNotConnected,) S 144 J ( ParOffline,) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( and) S 144 J ( ParPaperEmpty) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( case) S 144 J ( ParUnknownError:) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_DEVICE_NOT_CONNECTED;) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ParLogError\() S 
1680 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DriverObject,) S 
1680 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject,) S 
1680 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension->OriginalController,) S 
1680 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ParPhysicalZero,) S 
1680 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension->IrpSequence,) S 
1680 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->MajorFunction,) S 
1680 12200 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 0,) S 
1680 12460 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 38,) S 
1680 12720 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Status,) S 
1680 12980 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IO_ERR_NOT_READY\);) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 916 J ( 9-) S E B (5) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( case) S 144 J ( ParBusy:) S 
2400 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 
2400 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_DEVICE_BUSY;) S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Write.Length) S 144 J ( -) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( synchCount.OldCount;) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( case) S 144 J ( ParCancel:) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_CANCELLED;) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( default:) S 
2400 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 
2400 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_DEVICE_DATA_ERROR;) S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ParLogError\() S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DriverObject,) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject,) S 
2400 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension->OriginalController,) S 
2400 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ParPhysicalZero,) S 
2400 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension->IrpSequence,) S 
2400 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->MajorFunction,) S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 0,) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 39,) S 
2400 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Status,) S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IO_ERR_NOT_READY\);) S 
2400 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 9340 P () S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( switch) S 
2400 9600 P () S 480 J ( ) S 480 J ( IoStartNextPacket\() S 
2400 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject,) S 
2400 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( TRUE\);) S 
2400 10380 P () S 480 J ( ) S 480 J ( IoCompleteRequest\() S 
2400 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp,) S 
2400 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IO_PARALLEL_INCREMENT\);) S 
2400 11160 P () S 480 J ( }) S 
2400 11420 P (}) S 
1920 11800 P 0 12 F 24 12 F (Before) S 60 J ( ParCompleteWrite) S 60 J ( completes) S 60 J ( an) S 60 J ( input) S 60 J ( IRP,) S 60 J ( it) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F () S 60 J ( so) S 60 J ( that) S 60 J ( the) S 
1920 12060 P (ParStartIo) S 60 J ( routine) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 7) S 60 J ( can) S 60 J ( start) S 60 J ( processing) S 60 J ( the) S 60 J ( next) S 60 J ( request,) S 60 J ( if) S 60 J ( any,) S 60 J ( as) S 60 J ( soon) S 60 J ( as) S 
1920 12320 P (possible.) S 60 J ( Note) S 60 J ( that) S 60 J ( ParCompleteWrite) S 60 J ( simply) S 60 J ( returns) S 60 J ( if) S 60 J ( it) S 60 J ( is) S 60 J ( called) S 60 J ( without) S 60 J ( an) S 60 J ( IRP) S 60 J ( to) S 60 J ( be) S 
1920 12580 P (completed.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (6) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (For) S 60 J ( the) S 60 J ( driver) S 60 J ( of) S 60 J ( an) S 60 J ( interrupt-driven) S 60 J ( input) S 60 J ( device,) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( is) S 60 J ( also) S 60 J ( fairly) S 60 J ( simple) S 60 J ( if) S 
1200 2320 P (the) S 60 J ( driver) S 60 J ( uses) S 60 J ( buffered) S 60 J ( I/O.) S 60 J ( Consider) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( in) S 60 J ( the) S 60 J ( i8042) S 60 J ( port) S 60 J ( driver) S 60 J ( whose) S 
1200 2580 P (DispatchInternalDeviceControl) S 60 J ( routine) S 60 J ( was) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 6.) S 60 J ( The) S 60 J ( closely) S 60 J ( coupled) S 
1200 2840 P (keyboard) S 60 J ( and) S 60 J ( mouse) S 60 J ( class) S 60 J ( drivers) S 60 J ( layered) S 60 J ( over) S 60 J ( the) S 60 J ( i8042) S 60 J ( port) S 60 J ( driver) S 60 J ( are) S 60 J ( actually) S 60 J ( responsible) S 
1200 3100 P (for) S 60 J ( completing) S 60 J ( transfer) S 60 J ( \(read\)) S 60 J ( requests) S 60 J ( that) S 60 J ( originate) S 60 J ( in) S 60 J ( the) S 60 J ( Win32) S 60 J ( user) S 60 J ( input) S 60 J ( thread,) S 60 J ( so) S 60 J ( the) S 
1200 3360 P (port) S 60 J ( driver's) S 60 J ( I8042KeyboardIsrDpc) S 60 J ( routine) S 60 J ( need) S 60 J ( not) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F () S 60 J ( nor) S 
1200 3620 P 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F (.) S 
1200 4000 P (Instead,) S 60 J ( I8042KeyboardIsrDpc) S 60 J ( finishes) S 60 J ( the) S 60 J ( ISR's) S 60 J ( processing) S 60 J ( of) S 60 J ( keyboard) S 60 J ( interrupts) S 60 J ( in) S 
1200 4260 P (conjunction) S 60 J ( with) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 60 J ( DPC) S 60 J ( callback) S 60 J ( to) S 60 J ( transfer) S 60 J ( keyboard) S 60 J ( scan) S 60 J ( codes) S 
1200 4520 P (from) S 60 J ( the) S 60 J ( port) S 60 J ( driver's) S 60 J ( input) S 60 J ( data) S 60 J ( queue) S 60 J ( into) S 60 J ( the) S 60 J ( class) S 60 J ( driver's) S 60 J ( internal) S 60 J ( ring) S 60 J ( buffer,) S 60 J ( as) S 60 J ( follows:) S 
1680 5040 P 0 12 F 0 12 F ({) S 
1680 5300 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
1680 5560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 144 J ( DeviceObject->DeviceExtension;) S 
1680 5820 P () S 480 J ( GET_DATA_POINTER_CONTEXT) S 144 J ( getPointerContext;) S 
1680 6080 P () S 480 J ( SET_DATA_POINTER_CONTEXT) S 144 J ( setPointerContext;) S 
1680 6340 P () S 480 J ( VARIABLE_OPERATION_CONTEXT) S 144 J ( operationContext;) S 
1680 6600 P () S 480 J ( PVOID) S 144 J ( classService;) S 
1680 6860 P () S 480 J ( PVOID) S 144 J ( classDeviceObject;) S 
1680 7120 P () S 480 J ( INTERLOCKED_RESULT) S 144 J ( interlockedResult;) S 
1680 7380 P () S 480 J ( BOOLEAN) S 144 J ( moreDpcProcessing;) S 
1680 7640 P () S 480 J ( ULONG) S 144 J ( dataNotConsumed) S 144 J ( =) S 144 J ( 0;) S 
1680 7900 P () S 480 J ( ULONG) S 144 J ( inputDataConsumed) S 144 J ( =) S 144 J ( 0;) S 
1680 8160 P () S 480 J ( LARGE_INTEGER) S 144 J ( deltaTime;) S 
1680 8420 P (//) S 
1680 8680 P (//) S 144 J ( Use) S 144 J ( DpcInterlockKeyboard) S 144 J ( to) S 144 J ( determine) S 144 J ( whether) S 144 J ( this) S 144 J ( DPC) S 
1680 8940 P (//) S 144 J ( is) S 144 J ( running) S 144 J ( concurrently) S 144 J ( on) S 144 J ( another) S 144 J ( processor.) S 
1680 9200 P (//) S 144 J ( Only) S 144 J ( one) S 144 J ( instantiation) S 144 J ( of) S 144 J ( the) S 144 J ( DPC) S 144 J ( should) S 144 J ( actually) S 
1680 9460 P (//) S 144 J ( do) S 144 J ( any) S 144 J ( work) S 144 J ( at) S 144 J ( any) S 144 J ( given) S 144 J ( moment.) S 144 J ( DpcInterlockKeyboard) S 
1680 9720 P (//) S 144 J ( is) S 144 J ( -1) S 144 J ( when) S 144 J ( no) S 144 J ( DPC) S 144 J ( is) S 144 J ( running,) S 144 J ( so) S 144 J ( increment) S 144 J ( it) S 144 J ( and,) S 
1680 9980 P (//) S 144 J ( if) S 144 J ( the) S 144 J ( result) S 144 J ( is) S 144 J ( zero,) S 144 J ( then) S 144 J ( the) S 144 J ( current) S 144 J ( instantiation) S 
1680 10240 P (//) S 144 J ( is) S 144 J ( the) S 144 J ( only) S 144 J ( one) S 144 J ( running,) S 144 J ( so) S 144 J ( it) S 144 J ( is) S 144 J ( OK) S 144 J ( to) S 144 J ( proceed.) S 
1680 10500 P (//) S 144 J ( Otherwise,) S 144 J ( just) S 144 J ( return.) S 
1680 10760 P (//) S 
1680 11020 P () S 480 J ( operationContext.VariableAddress) S 144 J ( =) S 
1680 11280 P () S 480 J ( ) S 480 J ( &deviceExtension->DpcInterlockKeyboard;) S 
1680 11540 P () S 480 J ( operationContext.Operation) S 144 J ( =) S 144 J ( IncrementOperation;) S 
1680 11800 P () S 480 J ( operationContext.NewValue) S 144 J ( =) S 144 J ( &interlockedResult;) S 
1680 12060 P () S 480 J ( KeSynchronizeExecution\() S 
1680 12320 P () S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->KeyboardInterruptObject,) S 
1680 12580 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(PKSYNCHRONIZE_ROUTINE\)) S 144 J ( I8xDpcVariableOperation,) S 
1680 12840 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(PVOID\)) S 144 J ( &operationContext\);) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 916 J ( 9-) S E B (7) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( moreDpcProcessing) S 144 J ( =) S 
2400 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(interlockedResult) S 144 J ( ==) S 144 J ( 0\)?) S 144 J ( TRUE:FALSE;) S 
2400 2580 P () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( warning) S 144 J ( if) S 144 J ( concurrent) S 144 J ( execution) S 144 J ( of) S 144 J ( DPC) S 
2400 2840 P () S 480 J ( while) S 144 J ( \(moreDpcProcessing\)) S 144 J ( {) S 
2400 3100 P () S 480 J ( ) S 480 J ( dataNotConsumed) S 144 J ( =) S 144 J ( 0;) S 
2400 3360 P () S 480 J ( ) S 480 J ( inputDataConsumed) S 144 J ( =) S 144 J ( 0;) S 
2400 3620 P (//) S 
2400 3880 P (//) S 144 J ( Get) S 144 J ( the) S 144 J ( port) S 144 J ( InputData) S 144 J ( queue) S 144 J ( pointers) S 144 J ( synchronously.) S 
2400 4140 P (//) S 
2400 4400 P () S 480 J ( ) S 480 J ( getPointerContext.DeviceExtension) S 144 J ( =) S 144 J ( deviceExtension;) S 
2400 4660 P () S 480 J ( ) S 480 J ( setPointerContext.DeviceExtension) S 144 J ( =) S 144 J ( deviceExtension;) S 
2400 4920 P () S 480 J ( ) S 480 J ( getPointerContext.DeviceType) S 144 J ( =) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(CCHAR\)) S 144 J ( KeyboardDeviceType;) S 
2400 5440 P () S 480 J ( ) S 480 J ( setPointerContext.DeviceType) S 144 J ( =) S 
2400 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(CCHAR\)) S 144 J ( KeyboardDeviceType;) S 
2400 5960 P () S 480 J ( ) S 480 J ( setPointerContext.InputCount) S 144 J ( =) S 144 J ( 0;) S 
2400 6220 P (//) S 
2400 6480 P (//) S 144 J ( Call) S 144 J ( I8xGetDataQueuePointer) S 144 J ( at) S 144 J ( DIRQL) S 144 J ( in) S 144 J ( case) S 
2400 6740 P (//) S 144 J ( our) S 144 J ( ISR) S 144 J ( is) S 144 J ( currently) S 144 J ( reading) S 144 J ( data) S 144 J ( from) S 144 J ( the) S 144 J ( device) S 
2400 7000 P (//) S 144 J ( into) S 144 J ( the) S 144 J ( InputData) S 144 J ( queue.) S 
2400 7260 P (//) S 
2400 7520 P () S 480 J ( ) S 480 J ( KeSynchronizeExecution\() S 
2400 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->KeyboardInterruptObject,) S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(PKSYNCHRONIZE_ROUTINE\)) S 144 J ( I8xGetDataQueuePointer,) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(PVOID\)) S 144 J ( &getPointerContext\);) S 
2400 8560 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(getPointerContext.InputCount) S 144 J ( !=) S 144 J ( 0\)) S 144 J ( {) S 
2400 8820 P (//) S 
2400 9080 P (//) S 144 J ( Call) S 144 J ( the) S 144 J ( connected) S 144 J ( class) S 144 J ( driver's) S 144 J ( callback) S 144 J ( with) S 144 J ( the) S 144 J ( port) S 
2400 9340 P (//) S 144 J ( InputData) S 144 J ( queue) S 144 J ( pointers.) S 
2400 9600 P (//) S 
2400 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( classDeviceObject) S 144 J ( =) S 
2400 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->) S 
2400 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeyboardExtension.ConnectData.) S 
2400 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ClassDeviceObject;) S 
2400 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( classService) S 144 J ( =) S 
2400 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->) S 
2400 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeyboardExtension.ConnectData.) S 
2400 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ClassService;) S 
2400 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ASSERT\(classService) S 144 J ( !=) S 144 J ( NULL\);) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (8) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(getPointerContext.DataOut) S 144 J ( >=) S 
1680 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( getPointerContext.DataIn\)) S 144 J ( {) S 
1680 2580 P (//) S 
1680 2840 P (//) S 144 J ( Have) S 144 J ( to) S 144 J ( wrap) S 144 J ( the) S 144 J ( queue,) S 144 J ( break) S 144 J ( the) S 144 J ( operation) S 
1680 3100 P (//) S 144 J ( into) S 144 J ( two) S 144 J ( pieces,) S 144 J ( and) S 144 J ( call) S 144 J ( the) S 144 J ( class) S 144 J ( driver's) S 
1680 3360 P (//) S 144 J ( callback) S 144 J ( routine) S 144 J ( separately) S 144 J ( for) S 144 J ( each) S 144 J ( piece.) S 
1680 3620 P (//) S 144 J ( First,) S 144 J ( call) S 144 J ( it) S 144 J ( with) S 144 J ( the) S 144 J ( chunk) S 144 J ( of) S 144 J ( data) S 144 J ( starting) S 
1680 3880 P (//) S 144 J ( at) S 144 J ( DataOut) S 144 J ( and) S 144 J ( ending) S 144 J ( at) S 144 J ( the) S 144 J ( end) S 144 J ( of) S 144 J ( the) S 144 J ( queue.) S 
1680 4140 P (//) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(*\(PSERVICE_CALLBACK_ROUTINE\)) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( classService\)\() S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( classDeviceObject,) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( getPointerContext.DataOut,) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->) S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeyboardExtension.DataEnd,) S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &inputDataConsumed\);) S 
1680 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( dataNotConsumed) S 144 J ( =) S 
1680 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(\(\(PUCHAR\)) S 144 J ( deviceExtension->) S 
1680 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeyboardExtension.DataEnd) S 144 J ( -) S 
1680 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PUCHAR\)) S 144 J ( getPointerContext.DataOut\)) S 
1680 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( /) S 144 J ( sizeof\(KEYBOARD_INPUT_DATA\)\)) S 144 J ( -) S 
1680 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( inputDataConsumed;) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( setPointerContext.InputCount) S 144 J ( +=) S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( inputDataConsumed;) S 
1680 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(dataNotConsumed\)) S 144 J ( {) S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( setPointerContext.DataOut) S 144 J ( =) S 
1680 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(\(PUCHAR\)) S 144 J ( getPointerContext.DataOut\)) S 
1680 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( +) S 144 J ( \(inputDataConsumed) S 144 J ( *) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sizeof\(KEYBOARD_INPUT_DATA\)\);) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( setPointerContext.DataOut) S 144 J ( =) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeyboardExtension.InputData;) S 
1680 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( getPointerContext.DataOut) S 144 J ( =) S 
1680 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( setPointerContext.DataOut;) S 
1680 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
1680 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
1680 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(\(dataNotConsumed) S 144 J ( ==) S 144 J ( 0) S 144 J ( &&) S 144 J ( \(inputDataConsumed) S 144 J ( <) S 
1680 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( getPointerContext.InputCount\)\)) S 144 J ( {) S 
1680 12200 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( call) S 144 J ( class) S 144 J ( driver) S 144 J ( callback) S 144 J ( again) S 
1680 12460 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 916 J ( 9-) S E B (9) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Update) S 144 J ( the) S 144 J ( port) S 144 J ( InputData) S 144 J ( queue) S 144 J ( DataOut) S 144 J ( pointer) S 144 J ( and) S 
2400 2580 P (//) S 144 J ( InputCount) S 144 J ( synchronously.) S 
2400 2840 P (//) S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( KeSynchronizeExecution\() S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->KeyboardInterruptObject,) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PKSYNCHRONIZE_ROUTINE\)) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( I8xSetDataQueuePointer,) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PVOID\)) S 144 J ( &setPointerContext\);) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
2400 4660 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(dataNotConsumed\)) S 144 J ( {) S 
2400 4920 P (//) S 
2400 5180 P (//) S 144 J ( The) S 144 J ( class) S 144 J ( driver) S 144 J ( was) S 144 J ( unable) S 144 J ( to) S 144 J ( transfer) S 144 J ( all) S 144 J ( the) S 144 J ( data.) S 
2400 5440 P (//) S 144 J ( Reset) S 144 J ( the) S 144 J ( interlocked) S 144 J ( variable) S 144 J ( to) S 144 J ( -1,) S 144 J ( so) S 144 J ( there'll) S 144 J ( be) S 
2400 5700 P (//) S 144 J ( no) S 144 J ( attempt) S 144 J ( to) S 144 J ( move) S 144 J ( data) S 144 J ( to) S 144 J ( the) S 144 J ( class) S 144 J ( driver) S 144 J ( now) S 
2400 5960 P (//) S 144 J ( \(it) S 144 J ( is) S 144 J ( already) S 144 J ( overloaded\).) S 144 J ( Need) S 144 J ( to) S 144 J ( wait) S 144 J ( a) S 144 J ( while) S 
2400 6220 P (//) S 144 J ( to) S 144 J ( give) S 144 J ( the) S 144 J ( class) S 144 J ( driver) S 144 J ( a) S 144 J ( chance) S 144 J ( to) S 144 J ( transfer) S 144 J ( data) S 
2400 6480 P (//) S 144 J ( out) S 144 J ( of) S 144 J ( its) S 144 J ( ring) S 144 J ( buffer) S 144 J ( to) S 144 J ( the) S 144 J ( Win32) S 144 J ( user) S 144 J ( input) S 144 J ( thread.) S 
2400 6740 P (//) S 144 J ( So,) S 144 J ( wait) S 144 J ( on) S 144 J ( a) S 144 J ( timer) S 144 J ( here.) S 
2400 7000 P (//) S 
2400 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( operationContext.Operation) S 144 J ( =) S 144 J ( WriteOperation;) S 
2400 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( interlockedResult) S 144 J ( =) S 144 J ( -1;) S 
2400 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( operationContext.NewValue) S 144 J ( =) S 144 J ( &interlockedResult;) S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( KeSynchronizeExecution\() S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->KeyboardInterruptObject,) S 
2400 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PKSYNCHRONIZE_ROUTINE\)) S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( I8xDpcVariableOperation,) S 
2400 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PVOID\)) S 144 J ( &operationContext\);) S 
2400 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( deltaTime.LowPart) S 144 J ( =) S 144 J ( \(ULONG\)) S 144 J ( \(-10) S 144 J ( *) S 144 J ( 1000) S 144 J ( *) S 144 J ( 1000\);) S 
2400 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( deltaTime.HighPart) S 144 J ( =) S 144 J ( -1;) S 
2400 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(VOID\)) S 144 J ( KeSetTimer\() S 
2400 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->) S 
2400 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeyboardExtension.DataConsumptionTimer,) S 
2400 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deltaTime,) S 
2400 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->KeyboardIsrDpc\);) S 
2400 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( moreDpcProcessing) S 144 J ( =) S 144 J ( FALSE;) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (10) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 2320 P (//) S 
1680 2580 P (//) S 144 J ( Decrement) S 144 J ( DpcInterlockedKeyboard.) S 144 J ( If) S 144 J ( the) S 144 J ( result) S 144 J ( is) S 
1680 2840 P (//) S 144 J ( negative,) S 144 J ( processing) S 144 J ( is) S 144 J ( finished.) S 144 J ( Otherwise,) S 
1680 3100 P (//) S 144 J ( this) S 144 J ( DPC) S 144 J ( is) S 144 J ( running) S 144 J ( concurrently) S 144 J ( with) S 144 J ( another) S 
1680 3360 P (//) S 144 J ( instantiation) S 144 J ( on) S 144 J ( another) S 144 J ( processor.) S 144 J ( The) S 144 J ( other) S 
1680 3620 P (//) S 144 J ( instantiation) S 144 J ( didn't) S 144 J ( do) S 144 J ( any) S 144 J ( work,) S 144 J ( so) S 144 J ( make) S 144 J ( sure) S 144 J ( this) S 
1680 3880 P (//) S 144 J ( one) S 144 J ( does) S 144 J ( the) S 144 J ( processing) S 144 J ( \(if) S 144 J ( there's) S 144 J ( any) S 144 J ( left) S 144 J ( to) S 144 J ( do\).) S 
1680 4140 P (//) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( operationContext.Operation) S 144 J ( =) S 144 J ( DecrementOperation;) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( operationContext.NewValue) S 144 J ( =) S 144 J ( &interlockedResult;) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( KeSynchronizeExecution\() S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->KeyboardInterruptObject,) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PKSYNCHRONIZE_ROUTINE\)) S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( I8xDpcVariableOperation,) S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PVOID\)) S 144 J ( &operationContext\);) S 
1680 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(interlockedResult) S 144 J ( !=) S 144 J ( -1\)) S 144 J ( {) S 
1680 6480 P (//) S 
1680 6740 P (//) S 144 J ( Reset) S 144 J ( the) S 144 J ( DpcInterlockKeyboard) S 144 J ( to) S 144 J ( zero) S 144 J ( so) S 144 J ( this) S 144 J ( DPC) S 
1680 7000 P (//) S 144 J ( loops) S 144 J ( once) S 144 J ( more) S 144 J ( \(assuming) S 144 J ( no) S 144 J ( more) S 144 J ( DPCs) S 144 J ( get) S 144 J ( called) S 
1680 7260 P (//) S 144 J ( on) S 144 J ( another) S 144 J ( processor) S 144 J ( and) S 144 J ( bump) S 144 J ( the) S 144 J ( count) S 144 J ( again\).) S 
1680 7520 P (//) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( operationContext.Operation) S 144 J ( =) S 144 J ( WriteOperation;) S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( interlockedResult) S 144 J ( =) S 144 J ( 0;) S 
1680 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( operationContext.NewValue) S 144 J ( =) S 144 J ( &interlockedResult;) S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( KeSynchronizeExecution\() S 
1680 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->KeyboardInterruptObject,) S 
1680 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PKSYNCHRONIZE_ROUTINE\)) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( I8xDpcVariableOperation,) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PVOID\)) S 144 J ( &operationContext\);) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->DpcInterlockKeyboard) S 144 J ( =) S 144 J ( 0;) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( moreDpcProcessing) S 144 J ( =) S 144 J ( FALSE;) S 
1680 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
1680 10900 P () S 480 J ( ) S 480 J ( }) S 
1680 11160 P () S 480 J ( }) S 
1680 11420 P (}) S 
1200 11800 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( I8042KeyboardIsrDpc) S 60 J ( runs) S 60 J ( at) S 60 J ( IRQL) S 60 J ( DISPATCH_LEVEL) S 60 J ( and) S 60 J ( calls) S 
1200 12060 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( to) S 60 J ( update) S 60 J ( state) S 60 J ( that) S 60 J ( is) S 60 J ( shared) S 60 J ( with) S 
1200 12320 P (this) S 60 J ( driver's) S 60 J ( ISR.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (11) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (The) S 60 J ( closely) S 60 J ( coupled) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 60 J ( KeyboardClassServiceCallback) S 60 J ( routine) S 60 J ( can) S 60 J ( be) S 
1920 2320 P (considered) S 60 J ( part) S 60 J ( of) S 60 J ( the) S 60 J ( i8042) S 60 J ( port) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( routine.) S 60 J ( As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 6,) S 60 J ( the) S 
1920 2580 P (keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( is) S 60 J ( responsible) S 60 J ( for) S 60 J ( satisfying) S 60 J ( read) S 60 J ( requests) S 60 J ( originating) S 60 J ( in) S 60 J ( the) S 60 J ( Win32) S 60 J ( user) S 
1920 2840 P (input) S 60 J ( thread.) S 
1920 3220 P (Because) S 60 J ( the) S 60 J ( preceding) S 60 J ( I8042KeyboardIsrDpc) S 60 J ( manages) S 60 J ( all) S 60 J ( necessary) S 60 J ( synchronization) S 60 J ( with) S 60 J ( the) S 
1920 3480 P (port) S 60 J ( driver's) S 60 J ( ISR,) S 60 J ( KeyboardClassServiceCallback) S 60 J ( is) S 60 J ( run) S 60 J ( wholly) S 60 J ( at) S 60 J ( IRQL) S 60 J ( DISPATCH_LEVEL,) S 
1920 3740 P (as) S 60 J ( follows:) S 
2400 4260 P 0 12 F 0 12 F ({) S 
2400 4520 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
2400 4780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
2400 5040 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp;) S 
2400 5300 P () S 480 J ( PIRP) S 144 J ( irp;) S 
2400 5560 P () S 480 J ( KIRQL) S 144 J ( cancelIrql;) S 
2400 5820 P () S 480 J ( ULONG) S 144 J ( bytesInQueue;) S 
2400 6080 P () S 480 J ( ULONG) S 144 J ( bytesToMove;) S 
2400 6340 P () S 480 J ( ULONG) S 144 J ( moveSize) S 144 J ( =) S 144 J ( 0;) S 
2400 6600 P () S 480 J ( BOOLEAN) S 144 J ( satisfiedPendingReadRequest) S 144 J ( =) S 144 J ( FALSE;) S 
2400 6860 P () S 480 J ( PIO_ERROR_LOG_PACKET) S 144 J ( errorLogEntry;) S 
2400 7380 P () S 480 J ( bytesInQueue) S 144 J ( =) S 144 J ( \(PUCHAR\)) S 144 J ( InputDataEnd) S 144 J ( -) S 
2400 7640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PUCHAR\)) S 144 J ( InputDataStart;) S 
2400 7900 P () S 480 J ( *InputDataConsumed) S 144 J ( =) S 144 J ( 0;) S 
2400 8160 P (//) S 
2400 8420 P (//) S 144 J ( Acquire) S 144 J ( the) S 144 J ( spin) S 144 J ( lock) S 144 J ( that) S 144 J ( protects) S 144 J ( the) S 144 J ( device) S 144 J ( extension) S 
2400 8680 P (//) S 144 J ( to) S 144 J ( look) S 144 J ( at) S 144 J ( RequestIsPending.) S 144 J ( If) S 144 J ( there) S 144 J ( is) S 144 J ( a) S 144 J ( pending) S 
2400 8940 P (//) S 144 J ( read) S 144 J ( request,) S 144 J ( satisfy) S 144 J ( it.) S 
2400 9200 P (//) S 
2400 9460 P () S 480 J ( KeAcquireSpinLockAtDpcLevel\() S 
2400 9720 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock\);) S 
2400 9980 P () S 480 J ( if) S 144 J ( \(deviceExtension->RequestIsPending\)) S 144 J ( {) S 
2400 10240 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( remove) S 144 J ( IRP) S 144 J ( from) S 144 J ( cancelable) S 144 J ( state,) S 
2400 10500 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( setting) S 144 J ( irp) S 144 J ( =) S 144 J ( DeviceObject->CurrentIrp) S 
2400 10760 P () S 480 J ( ) S 480 J ( deviceExtension->RequestIsPending) S 144 J ( =) S 144 J ( FALSE;) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (12) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( Copy) S 144 J ( as) S 144 J ( much) S 144 J ( data) S 144 J ( as) S 144 J ( possible) S 144 J ( from) S 144 J ( the) S 144 J ( port) S 144 J ( driver's) S 
1680 2580 P (//) S 144 J ( input) S 144 J ( data) S 144 J ( queue) S 144 J ( to) S 144 J ( the) S 144 J ( SystemBuffer) S 144 J ( to) S 144 J ( satisfy) S 
1680 2840 P (//) S 144 J ( the) S 144 J ( read) S 144 J ( request.) S 
1680 3100 P (//) S 
1680 3360 P () S 480 J ( ) S 480 J ( irpSp) S 144 J ( =) S 144 J ( IoGetCurrentIrpStackLocation\(irp\);) S 
1680 3620 P () S 480 J ( ) S 480 J ( bytesToMove) S 144 J ( =) S 144 J ( irpSp->Parameters.Read.Length;) S 
1680 3880 P () S 480 J ( ) S 480 J ( moveSize) S 144 J ( =) S 144 J ( \(bytesInQueue) S 144 J ( <) S 144 J ( bytesToMove\)) S 144 J ( ?) S 
1680 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( bytesInQueue:bytesToMove;) S 
1680 4400 P () S 480 J ( ) S 480 J ( *InputDataConsumed) S 144 J ( +=) S 144 J ( \(moveSize) S 144 J ( /) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sizeof\(KEYBOARD_INPUT_DATA\)\);) S 
1680 4920 P () S 480 J ( ) S 480 J ( RtlMoveMemory\() S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irp->AssociatedIrp.SystemBuffer,) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PUCHAR\)) S 144 J ( InputDataStart,) S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( moveSize\);) S 
1680 5960 P (//) S 
1680 6220 P (//) S 144 J ( Set) S 144 J ( satisfiedPendingReadRequest) S 144 J ( so) S 144 J ( this) S 144 J ( routine) S 144 J ( starts) S 
1680 6480 P (//) S 144 J ( the) S 144 J ( next) S 144 J ( packet) S 144 J ( and) S 144 J ( completes) S 144 J ( this) S 144 J ( read) S 144 J ( request) S 
1680 6740 P (//) S 144 J ( with) S 144 J ( STATUS_SUCCESS.) S 
1680 7000 P (//) S 
1680 7260 P () S 480 J ( ) S 480 J ( irp->IoStatus.Status) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 
1680 7520 P () S 480 J ( ) S 480 J ( irp->IoStatus.Informaton) S 144 J ( =) S 144 J ( moveSize;) S 
1680 7780 P () S 480 J ( ) S 480 J ( irpSp->Parameters.Read.Length) S 144 J ( =) S 144 J ( moveSize;) S 
1680 8040 P () S 480 J ( ) S 480 J ( satisfiedPendingReadRequest) S 144 J ( =) S 144 J ( TRUE;) S 
1680 8300 P () S 480 J ( }) S 
1680 8560 P (//) S 
1680 8820 P (//) S 144 J ( If) S 144 J ( there) S 144 J ( is) S 144 J ( still) S 144 J ( data) S 144 J ( remaining) S 144 J ( in) S 144 J ( the) S 144 J ( port) S 144 J ( input) S 144 J ( data) S 
1680 9080 P (//) S 144 J ( queue,) S 144 J ( attempt) S 144 J ( to) S 144 J ( move) S 144 J ( it) S 144 J ( into) S 144 J ( the) S 144 J ( ring) S 144 J ( buffer.) S 
1680 9340 P (//) S 
1680 9600 P () S 480 J ( InputDataStart) S 144 J ( =) S 144 J ( \(PKEYBOARD_INPUT_DATA\)) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(\(PUCHAR\)) S 144 J ( InputDataStart) S 144 J ( +) S 144 J ( moveSize\);) S 
1680 10120 P () S 480 J ( moveSize) S 144 J ( =) S 144 J ( bytesInQueue) S 144 J ( -) S 144 J ( moveSize;) S 
1680 10380 P () S 480 J ( if) S 144 J ( \(moveSize) S 144 J ( >) S 144 J ( 0\)) S 144 J ( {) S 
1680 10640 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( move) S 144 J ( data) S 144 J ( into) S 144 J ( ring) S 144 J ( buffer) S 
1680 10900 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(bytesInQueue) S 144 J ( ==) S 144 J ( 0\)) S 144 J ( {) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (13) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Refuse) S 144 J ( to) S 144 J ( move) S 144 J ( bytes) S 144 J ( that) S 144 J ( would) S 144 J ( cause) S 144 J ( an) S 144 J ( overflow.) S 
2400 2580 P (//) S 144 J ( Just) S 144 J ( drop) S 144 J ( the) S 144 J ( bytes) S 144 J ( and,) S 144 J ( maybe,) S 144 J ( log) S 144 J ( an) S 144 J ( overrun) S 144 J ( error.) S 
2400 2840 P (//) S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(deviceExtension->OkToLogOverflow\)) S 144 J ( {) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorLogEntry) S 144 J ( =) S 144 J ( \(PIO_ERROR_LOG_PACKET\)) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoAllocateErrorLogEntry\() S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject,) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sizeof\(IO_ERROR_LOG_PACKET\)) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( +) S 144 J ( \(2) S 144 J ( *) S 144 J ( sizeof\(ULONG\)\)\);) S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(errorLogEntry) S 144 J ( !=) S 144 J ( NULL\)) S 144 J ( {) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorLogEntry->ErrorCode) S 144 J ( =) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KBDCLASS_KBD_BUFFER_OVERFLOW;) S 
2400 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorLogEntry->DumpDataSize) S 144 J ( =) S 
2400 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 2) S 144 J ( *) S 144 J ( sizeof\(ULONG\);) S 
2400 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorLogEntry->SequenceNumber) S 144 J ( =) S 144 J ( 0;) S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorLogEntry->MajorFunctionCode) S 144 J ( =) S 144 J ( 0;) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorLogEntry->IoControlCode) S 144 J ( =) S 144 J ( 0;) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorLogEntry->UniqueErrorValue) S 144 J ( =) S 
2400 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KEYBOARD_ERROR_VALUE_BASE) S 144 J ( +) S 144 J ( 210;) S 
2400 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorLogEntry->FinalStatus) S 144 J ( =) S 144 J ( 0;) S 
2400 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorLogEntry->DumpData[0]) S 144 J ( =) S 144 J ( bytesToMove;) S 
2400 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorLogEntry->DumpData[1]) S 144 J ( =) S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Keyboard.Attributes.) S 
2400 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( InputDataQueueLength;) S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoWriteErrorLogEntry\(errorLogEntry\);) S 
2400 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
2400 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->OkToLogOverflow) S 144 J ( =) S 144 J ( FALSE;) S 
2400 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
2400 9860 P () S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
2400 10120 P (//) S 
2400 10380 P (//) S 144 J ( There's) S 144 J ( room) S 144 J ( in) S 144 J ( the) S 144 J ( ring) S 144 J ( buffer) S 144 J ( for) S 144 J ( the) S 144 J ( keystrokes) S 144 J ( in) S 144 J ( the) S 
2400 10640 P (//) S 144 J ( port) S 144 J ( input) S 144 J ( data) S 144 J ( queue,) S 144 J ( so) S 144 J ( move) S 144 J ( 'em.) S 144 J ( Set) S 144 J ( bytesToMove) S 
2400 10900 P (//) S 144 J ( to) S 144 J ( the) S 144 J ( minimum) S 144 J ( of) S 144 J ( bytesInQueue) S 144 J ( \(remaining) S 144 J ( space) S 
2400 11160 P (//) S 144 J ( in) S 144 J ( the) S 144 J ( ring) S 144 J ( buffer\)) S 144 J ( and) S 144 J ( bytesToMove) S 144 J ( \(bytes) S 144 J ( remaining) S 
2400 11420 P (//) S 144 J ( in) S 144 J ( the) S 144 J ( port) S 144 J ( driver's) S 144 J ( input) S 144 J ( data) S 144 J ( queue\).) S 
2400 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
2400 11940 P () S 480 J ( ) S 480 J ( }) S 
2400 12200 P () S 480 J ( }) S 
2400 12460 P () S 480 J ( KeReleaseSpinLockFromDpcLevel\() S 
2400 12720 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock\);) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (14) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( If) S 144 J ( an) S 144 J ( outstanding) S 144 J ( read) S 144 J ( request) S 144 J ( was) S 144 J ( satisfied,) S 
1680 2580 P (//) S 144 J ( start) S 144 J ( the) S 144 J ( next) S 144 J ( packet) S 144 J ( and) S 144 J ( complete) S 144 J ( the) S 144 J ( IRP.) S 
1680 2840 P (//) S 
1680 3100 P () S 480 J ( if) S 144 J ( \(satisfiedPendingReadRequest\)) S 144 J ( {) S 
1680 3360 P () S 480 J ( ) S 480 J ( IoStartNextPacket\(DeviceObject,) S 144 J ( TRUE\);) S 
1680 3620 P () S 480 J ( ) S 480 J ( IoCompleteRequest\(irp,) S 144 J ( IO_KEYBOARD_INCREMENT\);) S 
1680 3880 P () S 480 J ( }) S 
1680 4140 P () S 480 J ( return;) S 
1680 4400 P (}) S 
1200 4780 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( a) S 60 J ( new,) S 60 J ( monolithic) S 60 J ( keyboard) S 60 J ( device) S 60 J ( driver) S 60 J ( would) S 60 J ( combine) S 60 J ( some) S 60 J ( of) S 60 J ( the) S 60 J ( features) S 60 J ( of) S 60 J ( the) S 
1200 5040 P (i8042) S 60 J ( port) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( and) S 60 J ( of) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 
1200 5300 P (KeyboardClassServiceCallback) S 60 J ( routines) S 60 J ( into) S 60 J ( a) S 60 J ( single) S 60 J ( DpcForIsr) S 60 J ( routine.) S 60 J ( Such) S 60 J ( a) S 60 J ( driver's) S 
1200 5560 P (DpcForIsr) S 60 J ( routine) S 60 J ( would) S 60 J ( be) S 60 J ( responsible) S 60 J ( for) S 60 J ( all) S 60 J ( of) S 60 J ( the) S 60 J ( following:) S 
1200 5880 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Like) S 60 J ( I8042KeyboardDpcIsr,) S 60 J ( for) S 60 J ( transferring) S 60 J ( keystrokes) S 60 J ( received) S 60 J ( by) S 60 J ( the) S 60 J ( ISR) S 60 J ( from) S 60 J ( the) S 
1680 6140 P (physical) S 60 J ( device) S 60 J ( and) S 60 J ( synchronizing) S 60 J ( its) S 60 J ( access) S 60 J ( to) S 60 J ( the) S 60 J ( hardware) S 60 J ( with) S 60 J ( the) S 60 J ( ISR's) S 60 J ( by) S 60 J ( calling) S 
1680 6400 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( one) S 60 J ( or) S 60 J ( more) S 60 J ( driver-supplied) S 60 J ( SynchCritSection) S 60 J ( routines) S 
1200 6720 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Like) S 60 J ( the) S 60 J ( KeyboardClassServiceCallback,) S 60 J ( for) S 60 J ( buffering) S 60 J ( incoming) S 60 J ( keystrokes) S 60 J ( in) S 
1680 6980 P (anticipation) S 60 J ( of) S 60 J ( a) S 60 J ( read) S 60 J ( request,) S 60 J ( for) S 60 J ( packaging) S 60 J ( data) S 60 J ( from) S 60 J ( the) S 60 J ( device) S 60 J ( into) S 
1680 7240 P (KEYBOARD_INPUT_DATA-type) S 60 J ( packets,) S 60 J ( for) S 60 J ( satisfying) S 60 J ( pending) S 60 J ( read) S 60 J ( requests) S 60 J ( by) S 
1680 7500 P (copying) S 60 J ( keyboard) S 60 J ( input) S 60 J ( packets) S 60 J ( to) S 60 J ( the) S 60 J ( buffer) S 60 J ( at) S 60 J ( ) S 0 12 F 24 12 F B (Irp->AssociatedIrp.SystemBuffer) S E 0 12 F 24 12 F (,) S 60 J ( and) S 
1680 7760 P (for) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F () S 60 J ( and) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( when) S 60 J ( it) S 60 J ( completes) S 60 J ( an) S 60 J ( IRP) S 
1200 8140 P (In) S 60 J ( other) S 60 J ( words,) S 60 J ( the) S 60 J ( designer) S 60 J ( of) S 60 J ( a) S 60 J ( new) S 60 J ( keyboard) S 60 J ( device) S 60 J ( driver) S 60 J ( that) S 60 J ( will) S 60 J ( interoperate) S 60 J ( with) S 60 J ( the) S 
1200 8400 P (system-supplied) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( can) S 60 J ( pattern) S 60 J ( its) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( solely) S 60 J ( on) S 60 J ( the) S 60 J ( i8042) S 
1200 8660 P (driver's) S 60 J ( DpcForIsr.) S 60 J ( Otherwise,) S 60 J ( the) S 60 J ( designer) S 60 J ( must) S 60 J ( combine) S 60 J ( the) S 60 J ( functionality) S 60 J ( of) S 60 J ( these) S 60 J ( closely) S 
1200 8920 P (coupled) S 60 J ( class/port) S 60 J ( drivers) S 60 J ( in) S 60 J ( the) S 60 J ( new) S 60 J ( driver.) S 
1200 9560 P 0 12 F 8 12 F B (9.2.2) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( DpcForIsr) S 67 J ( Routines) S 67 J ( in) S 67 J ( Drivers) S 67 J ( Using) S 67 J ( Direct) S 67 J ( I/O) S E 
1200 10180 P 0 12 F 24 12 F (As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( the) S 60 J ( introduction) S 60 J ( to) S 60 J ( Section) S 60 J ( 9.2,) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( direct) S 60 J ( I/O) S 60 J ( can) S 60 J ( be) S 60 J ( requested) S 60 J ( to) S 
1200 10440 P (transfer) S 60 J ( large) S 60 J ( amounts) S 60 J ( of) S 60 J ( data.) S 60 J ( The) S 60 J ( locked-down) S 60 J ( buffer) S 60 J ( described) S 60 J ( by) S 60 J ( the) S 60 J ( MDL) S 60 J ( in) S 60 J ( IRPs) S 60 J ( passed) S 
1200 10700 P (to) S 60 J ( such) S 60 J ( a) S 60 J ( driver's) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( can) S 60 J ( be) S 60 J ( larger) S 60 J ( than) S 60 J ( the) S 60 J ( system-defined) S 
1200 10960 P (PAGE_SIZE) S 60 J ( and/or) S 60 J ( the) S 60 J ( MDL) S 60 J ( can) S 60 J ( describe) S 60 J ( a) S 60 J ( buffer) S 60 J ( backed) S 60 J ( by) S 60 J ( several) S 60 J ( discontiguous) S 60 J ( physical) S 
1200 11220 P (pages) S 60 J ( in) S 60 J ( system) S 60 J ( memory.) S 
1200 11600 P (In) S 60 J ( addition,) S 60 J ( the) S 60 J ( device) S 60 J ( through) S 60 J ( which) S 60 J ( a) S 60 J ( driver) S 60 J ( transfers) S 60 J ( the) S 60 J ( requested) S 60 J ( data) S 60 J ( can) S 60 J ( have) S 60 J ( limitations) S 
1200 11860 P (of) S 60 J ( its) S 60 J ( own.) S 60 J ( For) S 60 J ( example,) S 60 J ( the) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver,) S 60 J ( whose) S 60 J ( DispatchReadWrite,) S 60 J ( StartIo,) S 60 J ( and) S 
1200 12120 P (interrupt) S 60 J ( service) S 60 J ( routines) S 60 J ( were) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapters) S 60 J ( 6) S 60 J ( through) S 60 J ( 8,) S 60 J ( must) S 60 J ( split) S 60 J ( up) S 60 J ( any) S 60 J ( transfer) S 
1200 12380 P (request) S 60 J ( for) S 60 J ( more) S 60 J ( than) S 60 J ( 256) S 60 J ( sectors) S 60 J ( due) S 60 J ( to) S 60 J ( the) S 60 J ( disk) S 60 J ( controller's) S 60 J ( limitations.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (15) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (When) S 60 J ( this) S 60 J ( driver's) S 60 J ( ControllerControl) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 60 J ( a) S 60 J ( larger) S 60 J ( request,) S 60 J ( it) S 60 J ( sets) S 60 J ( up) S 60 J ( the) S 
1920 2320 P (controller) S 60 J ( to) S 60 J ( transfer) S 60 J ( as) S 60 J ( much) S 60 J ( data) S 60 J ( as) S 60 J ( possible.) S 60 J ( After) S 60 J ( the) S 60 J ( ISR) S 60 J ( has) S 60 J ( handled) S 60 J ( the) S 60 J ( interrupt\(s\)) S 60 J ( for) S 60 J ( a) S 
1920 2580 P (maximum) S 60 J ( transfer,) S 60 J ( the) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( must) S 60 J ( set) S 60 J ( up) S 60 J ( the) S 60 J ( controller) S 60 J ( again) S 60 J ( to) S 
1920 2840 P (transfer) S 60 J ( the) S 60 J ( remaining) S 60 J ( data) S 60 J ( necessary) S 60 J ( to) S 60 J ( satisfy) S 60 J ( the) S 60 J ( IRP.) S 60 J ( In) S 60 J ( addition,) S 60 J ( the) S 60 J ( driver's) S 60 J ( DpcForIsr) S 
1920 3100 P (routine,) S 60 J ( AtDiskDeferredProcedure,) S 60 J ( is) S 60 J ( responsible) S 60 J ( for) S 60 J ( handling) S 60 J ( controller) S 60 J ( errors) S 60 J ( and) S 60 J ( for) S 
1920 3360 P (releasing) S 60 J ( the) S 60 J ( controller) S 60 J ( object,) S 60 J ( as) S 60 J ( follows:) S 
2400 3880 P 0 12 F 0 12 F ({) S 
2400 4140 P () S 480 J ( PDEVICE_OBJECT) S 144 J ( deviceObject;) S 
2400 4400 P () S 480 J ( PDISK_EXTENSION) S 144 J ( diskExtension;) S 
2400 4660 P () S 480 J ( PCONTROLLER_EXTENSION) S 144 J ( controllerExtension;) S 
2400 4920 P () S 480 J ( PIRP) S 144 J ( irp;) S 
2400 5180 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp;) S 
2400 5440 P () S 480 J ( NTSTATUS) S 144 J ( returnStatus;) S 
2400 5700 P () S 480 J ( CCHAR) S 144 J ( controllerStatus;) S 
2400 5960 P (//) S 144 J ( Set) S 144 J ( the) S 144 J ( next) S 144 J ( to) S 144 J ( TRUE) S 144 J ( iff) S 144 J ( fill/empty) S 144 J ( the) S 144 J ( controller) S 144 J ( cache.) S 
2400 6220 P () S 480 J ( BOOLEAN) S 144 J ( expectingAnInterrupt) S 144 J ( =) S 144 J ( FALSE;) S 
2400 6480 P (//) S 
2400 6740 P (//) S 144 J ( Capture) S 144 J ( the) S 144 J ( following) S 144 J ( controller) S 144 J ( values) S 144 J ( for) S 144 J ( logging) S 144 J ( if) S 
2400 7000 P (//) S 144 J ( there's) S 144 J ( an) S 144 J ( error.) S 
2400 7260 P (//) S 
2400 7520 P () S 480 J ( CCHAR) S 144 J ( errorReg;) S 
2400 7780 P () S 480 J ( CCHAR) S 144 J ( driveHead;) S 
2400 8040 P () S 480 J ( CCHAR) S 144 J ( cylHigh;) S 
2400 8300 P () S 480 J ( CCHAR) S 144 J ( cylLow;) S 
2400 8560 P () S 480 J ( CCHAR) S 144 J ( sectorNumber;) S 
2400 8820 P () S 480 J ( CCHAR) S 144 J ( altStatus;) S 
2400 9340 P () S 480 J ( deviceObject) S 144 J ( =) S 144 J ( DeferredContext;) S 
2400 9600 P () S 480 J ( diskExtension) S 144 J ( =) S 144 J ( deviceObject->DeviceExtension;) S 
2400 9860 P () S 480 J ( controllerExtension) S 144 J ( =) S 
2400 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->ControllerExtension;) S 
2400 10380 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( test) S 144 J ( whether) S 144 J ( power) S 144 J ( failed) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (16) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( Should) S 144 J ( start) S 144 J ( another) S 144 J ( IRP) S 144 J ( before) S 144 J ( completing) S 144 J ( the) S 144 J ( current) S 
1680 2580 P (//) S 144 J ( one) S 144 J ( to) S 144 J ( maximize) S 144 J ( throughput.) S 144 J ( The) S 144 J ( input) S 144 J ( device) S 144 J ( object) S 
1680 2840 P (//) S 144 J ( determines) S 144 J ( which) S 144 J ( disk) S 144 J ( this) S 144 J ( request) S 144 J ( is) S 144 J ( for,) S 144 J ( so) S 144 J ( get) S 
1680 3100 P (//) S 144 J ( a) S 144 J ( pointer) S 144 J ( to) S 144 J ( the) S 144 J ( current) S 144 J ( IRP.) S 144 J ( Note) S 144 J ( that) S 144 J ( this) S 144 J ( pointer) S 
1680 3360 P (//) S 144 J ( will) S 144 J ( be) S 144 J ( NULL) S 144 J ( if) S 144 J ( the) S 144 J ( controller) S 144 J ( is) S 144 J ( being) S 144 J ( reset.) S 
1680 3620 P (//) S 
1680 3880 P () S 480 J ( controllerStatus) S 144 J ( =) S 144 J ( \(CCHAR\)) S 144 J ( SystemArgument2;) S 
1680 4140 P () S 480 J ( irp) S 144 J ( =) S 144 J ( deviceObject->CurrentIrp;) S 
1680 4400 P () S 480 J ( if) S 144 J ( \(irp) S 144 J ( !=) S 144 J ( NULL\)) S 144 J ( {) S 
1680 4660 P () S 480 J ( ) S 480 J ( irpSp) S 144 J ( =) S 144 J ( IoGetCurrentIrpStackLocation\(irp\);) S 
1680 4920 P () S 480 J ( }) S 
1680 5180 P (//) S 
1680 5440 P (//) S 144 J ( If) S 144 J ( a) S 144 J ( timer) S 144 J ( expired,) S 144 J ( the) S 144 J ( controller) S 144 J ( was) S 144 J ( reset,) S 144 J ( so) S 
1680 5700 P (//) S 144 J ( might) S 144 J ( have) S 144 J ( to) S 144 J ( set) S 144 J ( drive) S 144 J ( parameters) S 144 J ( for) S 144 J ( a) S 144 J ( second) S 144 J ( drive) S 
1680 5960 P (//) S 144 J ( and/or) S 144 J ( restart) S 144 J ( an) S 144 J ( IRP,) S 144 J ( log) S 144 J ( an) S 144 J ( error,) S 
1680 6220 P (//) S 144 J ( or) S 144 J ( mark) S 144 J ( a) S 144 J ( bad) S 144 J ( sector.) S 
1680 6480 P (//) S 
1680 6740 P () S 480 J ( switch) S 144 J ( \(controllerExtension->ResettingController\)) S 144 J ( {) S 
1680 7000 P () S 480 J ( ) S 480 J ( case) S 144 J ( RESET_NOT_RESETTING:) S 144 J ( {) S 
1680 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
1680 7520 P () S 480 J ( ) S 480 J ( }) S 
1680 7780 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 8040 P () S 480 J ( ) S 480 J ( //) S 
1680 8300 P () S 480 J ( ) S 480 J ( //) S 144 J ( Other) S 144 J ( cases) S 144 J ( to) S 144 J ( recalibrate) S 144 J ( failing) S 144 J ( drive\(s\),) S 
1680 8560 P () S 480 J ( ) S 480 J ( //) S 144 J ( retry) S 144 J ( IRP,) S 144 J ( or) S 144 J ( complete) S 144 J ( IRP) S 144 J ( if) S 144 J ( the) S 144 J ( retry) S 144 J ( limit) S 
1680 8820 P () S 480 J ( ) S 480 J ( //) S 144 J ( is) S 144 J ( reached.) S 144 J ( If) S 144 J ( the) S 144 J ( drive\(s\)) S 144 J ( cannot) S 144 J ( be) S 144 J ( recalibrated) S 
1680 9080 P () S 480 J ( ) S 480 J ( //) S 144 J ( or) S 144 J ( the) S 144 J ( retry) S 144 J ( limit) S 144 J ( is) S 144 J ( reached,) S 144 J ( fail) S 144 J ( the) S 144 J ( IRP) S 
1680 9340 P () S 480 J ( ) S 480 J ( //) S 144 J ( and) S 144 J ( release) S 144 J ( the) S 144 J ( controller.) S 
1680 9600 P () S 480 J ( ) S 480 J ( //) S 
1680 9860 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AtFinishPacket\() S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension,) S 
1680 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_DISK_RECALIBRATE_FAILED\);) S 
1680 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( if) S 144 J ( recalibration) S 144 J ( drives) S 
1680 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( reset) S 144 J ( controller) S 144 J ( and) S 144 J ( retry) S 144 J ( IRP) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (17) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->) S 
2400 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerExtension->ResettingController) S 144 J ( =) S 
2400 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( RESET_NOT_RESETTING;) S 
2400 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoFreeController\() S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->ControllerObject\);) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( return;) S 
2400 3620 P () S 480 J ( ) S 480 J ( }) S 
2400 3880 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( switch) S 144 J ( on) S 144 J ( time-out) S 
2400 4140 P (//) S 
2400 4400 P (//) S 144 J ( Update) S 144 J ( the) S 144 J ( remaining) S 144 J ( length) S 144 J ( and) S 144 J ( fill/empty) S 144 J ( the) S 144 J ( cache.) S 
2400 4660 P (//) S 144 J ( However,) S 144 J ( if) S 144 J ( there) S 144 J ( was) S 144 J ( an) S 144 J ( error,) S 144 J ( don't) S 144 J ( update) S 144 J ( the) S 
2400 4920 P (//) S 144 J ( remaining) S 144 J ( length,) S 144 J ( even) S 144 J ( though) S 144 J ( the) S 144 J ( cache) S 144 J ( must) S 144 J ( be) S 
2400 5180 P (//) S 144 J ( filled) S 144 J ( or) S 144 J ( emptied.) S 
2400 5440 P (//) S 
2400 5700 P () S 480 J ( if) S 144 J ( \() S 144 J ( !\(controllerStatus) S 144 J ( &) S 144 J ( ERROR_STATUS\)\)) S 144 J ( {) S 
2400 5960 P () S 480 J ( ) S 480 J ( ASSERT\(diskExtension->BytesPerInterrupt) S 144 J ( ==) S 144 J ( 512\);) S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( debugging) S 
2400 6480 P () S 480 J ( ) S 480 J ( diskExtension->RemainingTransferLength) S 144 J ( -=) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->BytesPerInterrupt;) S 
2400 7000 P () S 480 J ( ) S 480 J ( diskExtension->RemainingRequestLength) S 144 J ( -=) S 
2400 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->BytesPerInterrupt;) S 
2400 7520 P (//) S 
2400 7780 P (//) S 144 J ( If) S 144 J ( there's) S 144 J ( more) S 144 J ( for) S 144 J ( the) S 144 J ( current) S 144 J ( transfer,) S 144 J ( servicing) S 144 J ( the) S 
2400 8040 P (//) S 144 J ( controller) S 144 J ( cache) S 144 J ( will) S 144 J ( cause) S 144 J ( the) S 144 J ( controller) S 144 J ( to) S 144 J ( start) S 144 J ( the) S 
2400 8300 P (//) S 144 J ( next) S 144 J ( piece) S 144 J ( and) S 144 J ( cause) S 144 J ( an) S 144 J ( interrupt.) S 
2400 8560 P (//) S 
2400 8820 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(diskExtension->RemainingTransferLength) S 144 J ( >) S 144 J ( 0\)) S 144 J ( {) S 
2400 9080 P (//) S 
2400 9340 P (//) S 144 J ( It's) S 144 J ( safe) S 144 J ( to) S 144 J ( alter) S 144 J ( the) S 144 J ( following) S 144 J ( state) S 144 J ( because) S 
2400 9600 P (//) S 144 J ( no) S 144 J ( interrupts) S 144 J ( are) S 144 J ( currently) S 144 J ( expected) S 144 J ( until) S 144 J ( the) S 144 J ( cache) S 
2400 9860 P (//) S 144 J ( is) S 144 J ( filled/emptied) S 144 J ( later,) S 144 J ( so) S 144 J ( the) S 144 J ( ISR) S 144 J ( won't) S 144 J ( run) S 
2400 10120 P (//) S 144 J ( and) S 144 J ( AtCheckTimerSynch) S 144 J ( won't) S 144 J ( be) S 144 J ( decrementing) S 144 J ( the) S 
2400 10380 P (//) S 144 J ( InterruptTimer) S 144 J ( because) S 144 J ( the) S 144 J ( ISR) S 144 J ( cleared) S 144 J ( this) S 144 J ( counter.) S 
2400 10640 P (//) S 
2400 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->InterruptRequiresDpc) S 144 J ( =) S 144 J ( TRUE;) S 
2400 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->WhichDeviceObject) S 144 J ( =) S 
2400 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->DeviceObject;) S 
2400 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->InterruptTimer) S 144 J ( =) S 144 J ( START_TIMER;) S 
2400 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( expectingAnInterrupt) S 144 J ( =) S 144 J ( TRUE;) S 
2400 12200 P () S 480 J ( ) S 480 J ( }) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (18) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 2320 P (//) S 
1680 2580 P (//) S 144 J ( There) S 144 J ( is) S 144 J ( some) S 144 J ( kind) S 144 J ( of) S 144 J ( error) S 144 J ( on) S 144 J ( the) S 144 J ( controller.) S 
1680 2840 P (//) S 144 J ( Capture) S 144 J ( the) S 144 J ( controller) S 144 J ( values) S 144 J ( here) S 144 J ( \(before) S 144 J ( changing) S 
1680 3100 P (//) S 144 J ( them\)) S 144 J ( to) S 144 J ( log) S 144 J ( an) S 144 J ( error) S 144 J ( later.) S 
1680 3360 P (//) S 
1680 3620 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 3880 P () S 480 J ( }) S 
1680 4140 P (//) S 
1680 4400 P (//) S 144 J ( If) S 144 J ( this) S 144 J ( is) S 144 J ( a) S 144 J ( READ) S 144 J ( or) S 144 J ( a) S 144 J ( WRITE) S 144 J ( with) S 144 J ( more) S 144 J ( work) S 144 J ( to) S 144 J ( do,) S 
1680 4660 P (//) S 144 J ( the) S 144 J ( cache) S 144 J ( must) S 144 J ( be) S 144 J ( emptied/filled) S 144 J ( whether) S 144 J ( there) S 144 J ( was) S 
1680 4920 P (//) S 144 J ( an) S 144 J ( error) S 144 J ( or) S 144 J ( not.) S 144 J ( It) S 144 J ( is) S 144 J ( safe) S 144 J ( to) S 144 J ( touch) S 144 J ( the) S 144 J ( hardware) S 
1680 5180 P (//) S 144 J ( here) S 144 J ( since) S 144 J ( the) S 144 J ( controller) S 144 J ( can't) S 144 J ( interrupt) S 144 J ( until) S 
1680 5440 P (//) S 144 J ( the) S 144 J ( cache) S 144 J ( has) S 144 J ( been) S 144 J ( emptied) S 144 J ( or) S 144 J ( filled,) S 144 J ( and) S 144 J ( the) S 144 J ( timer) S 
1680 5700 P (//) S 144 J ( routine) S 144 J ( won't) S 144 J ( touch) S 144 J ( InterruptTimer) S 144 J ( for) S 144 J ( at) S 144 J ( least) S 
1680 5960 P (//) S 144 J ( another) S 144 J ( second) S 144 J ( \(when) S 144 J ( the) S 144 J ( timer) S 144 J ( expires\).) S 
1680 6220 P (//) S 
1680 6480 P () S 480 J ( switch) S 144 J ( \(diskExtension->OperationType\)) S 144 J ( {) S 
1680 6740 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_READ:) S 144 J ( {) S 
1680 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( PVOID) S 144 J ( bufferToReadTo;) S 
1680 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( BOOLEAN) S 144 J ( checkDrq) S 144 J ( =) S 144 J ( FALSE;) S 
1680 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \() S 144 J ( !diskExtension->RemainingTransferLength\)) S 144 J ( {) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( checkDrq) S 144 J ( =) S 144 J ( TRUE;) S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
1680 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ASSERT\(diskExtension->BytesPerInterrupt) S 144 J ( ==) S 144 J ( 512\);) S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \() S 144 J ( !\(controllerStatus) S 144 J ( &) S 144 J ( ERROR_STATUS\)\)) S 144 J ( {) S 
1680 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( bufferToReadTo) S 144 J ( =) S 144 J ( diskExtension->) S 
1680 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( CurrentAddress;) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->CurrentAddress) S 144 J ( +=) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->BytesPerInterrupt;) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( bufferToReadTo) S 144 J ( =) S 144 J ( &controllerExtension->) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( GarbageCan[0];) S 
1680 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
1680 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( wait) S 144 J ( for) S 144 J ( DRQ) S 144 J ( assertion) S 
1680 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( READ_CONTROLLER_BUFFER\() S 
1680 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->) S 
1680 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerAddress) S 144 J ( +) S 
1680 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DATA_REGISTER,) S 
1680 12200 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( bufferToReadTo,) S 
1680 12460 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->) S 
1680 12720 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( BytesPerInterrupt\);) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (19) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(checkDrq\)) S 144 J ( {) S 
2400 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( debugging) S 
2400 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
2400 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 3100 P () S 480 J ( ) S 480 J ( }) S 
2400 3360 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_WRITE:) S 144 J ( {) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( similar) S 144 J ( to) S 144 J ( read) S 
2400 3880 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_DEVICE_CONTROL:) S 144 J ( {) S 
2400 4140 P (//) S 
2400 4400 P (//) S 144 J ( This) S 144 J ( is) S 144 J ( a) S 144 J ( VERIFY) S 144 J ( IOCTL.) S 144 J ( There's) S 144 J ( nothing) S 144 J ( to) S 144 J ( do.) S 
2400 4660 P (//) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 5180 P () S 480 J ( ) S 480 J ( }) S 
2400 5440 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( switch) S 144 J ( on) S 144 J ( IRP_MJ_xxx) S 
2400 5700 P (//) S 
2400 5960 P (//) S 144 J ( If) S 144 J ( there's) S 144 J ( a) S 144 J ( correctable) S 144 J ( error,) S 144 J ( log) S 144 J ( it,) S 
2400 6220 P (//) S 144 J ( and) S 144 J ( continue) S 144 J ( operations) S 144 J ( normally.) S 
2400 6480 P (//) S 
2400 6740 P () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
2400 7000 P (//) S 
2400 7260 P (//) S 144 J ( If) S 144 J ( there's) S 144 J ( an) S 144 J ( uncorrectable) S 144 J ( error,) S 144 J ( log) S 144 J ( it,) S 
2400 7520 P (//) S 144 J ( reset) S 144 J ( the) S 144 J ( controller,) S 144 J ( and) S 144 J ( possibly) S 144 J ( retry) S 144 J ( the) S 144 J ( request.) S 
2400 7780 P (//) S 
2400 8040 P () S 480 J ( returnStatus) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 
2400 8300 P () S 480 J ( if) S 144 J ( \(controllerStatus) S 144 J ( &) S 144 J ( ERROR_STATUS\)) S 144 J ( {) S 
2400 8560 P () S 480 J ( ) S 480 J ( AtLogError\() S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceObject,) S 
2400 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(\(irp\)?\(diskExtension->SequenceNumber\):\(0\),) S 
2400 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(UCHAR\)\(\(irp\)?\(irpSp->MajorFunction\):\(0\),) S 
2400 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->IrpRetryCount,) S 
2400 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 3,) S 
2400 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_SUCCESS,) S 
2400 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IO_ERR_RETRY_SUCCEEDED,) S 
2400 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ERROR_LOG_TYPE_ERROR,) S 
2400 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorReg,) S 
2400 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( driveHead,) S 
2400 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( cylHigh,) S 
2400 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( cylLow,) S 
2400 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sectorNumber,) S 
2400 12200 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( altStatus\);) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (20) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( If) S 144 J ( the) S 144 J ( retry) S 144 J ( count) S 144 J ( for) S 144 J ( this) S 144 J ( IRP) S 144 J ( isn't) S 144 J ( exceeded,) S 
1680 2580 P (//) S 144 J ( retry) S 144 J ( it.) S 144 J ( Otherwise,) S 144 J ( fail) S 144 J ( the) S 144 J ( request.) S 
1680 2840 P (//) S 
1680 3100 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(diskExtension->RetryCount) S 144 J ( <) S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( RETRY_IRP_MAXIMUM_COUNT\)) S 144 J ( {) S 
1680 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( AtLogError\() S 
1680 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceObject,) S 
1680 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(\(irp\)?\(diskExtension->SequenceNumber\):\(0\),) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(UCHAR\)\(\(irp\)?\(irpSp->MajorFunction\):\(0\),) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->IrpRetryCount,) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 4,) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_SUCCESS,) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IO_ERR_CONTROLLER_ERROR,) S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ERROR_LOG_TYPE_ERROR,) S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorReg,) S 
1680 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( driveHead,) S 
1680 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( cylHigh,) S 
1680 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( cylLow,) S 
1680 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sectorNumber,) S 
1680 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( altStatus\);) S 
1680 7520 P (//) S 
1680 7780 P (//) S 144 J ( Might) S 144 J ( as) S 144 J ( well) S 144 J ( reset) S 144 J ( the) S 144 J ( controller.) S 144 J ( This) S 144 J ( will) S 144 J ( increase) S 
1680 8040 P (//) S 144 J ( the) S 144 J ( chances) S 144 J ( that) S 144 J ( the) S 144 J ( I/O) S 144 J ( will) S 144 J ( succeed) S 144 J ( this) S 144 J ( time.) S 
1680 8300 P (//) S 144 J ( The) S 144 J ( next) S 144 J ( call) S 144 J ( will) S 144 J ( almost) S 144 J ( certainly) S 144 J ( cause) S 144 J ( an) S 144 J ( interrupt,) S 
1680 8560 P (//) S 144 J ( so) S 144 J ( this) S 144 J ( routine'll) S 144 J ( be) S 144 J ( reentered,) S 144 J ( but) S 144 J ( it's) S 144 J ( not) S 144 J ( doing) S 
1680 8820 P (//) S 144 J ( much) S 144 J ( after) S 144 J ( the) S 144 J ( call) S 144 J ( to) S 144 J ( AtDiskStartReset) S 144 J ( anyway.) S 
1680 9080 P (//) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( KeSynchronizeExecution\() S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->InterruptObject,) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AtDiskStartReset,) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension\);) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( return;) S 
1680 10640 P () S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (21) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Retries) S 144 J ( exhausted) S 144 J ( for) S 144 J ( this) S 144 J ( IRP.) S 
2400 2580 P (//) S 
2400 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( AtLogError\() S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceObject,) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(\(irp\)?\(diskExtension->SequenceNumber\):\(0\),) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(UCHAR\)\(\(irp\)?\(irpSp->MajorFunction\):\(0\),) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->IrpRetryCount,) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 5,) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_DISK_OPERATION_FAILED,) S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IO_ERR_CONTROLLER_ERROR,) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ERROR_LOG_TYPE_ERROR,) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( errorReg,) S 
2400 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( driveHead,) S 
2400 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( cylHigh,) S 
2400 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( cylLow,) S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sectorNumber,) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( altStatus\);) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( returnStatus) S 144 J ( =) S 144 J ( STATUS_DISK_OPERATION_FAILED;) S 
2400 7000 P () S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( else) S 
2400 7260 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( if) S 144 J ( controller) S 144 J ( error) S 
2400 7520 P (//) S 
2400 7780 P (//) S 144 J ( If) S 144 J ( the) S 144 J ( current) S 144 J ( transfer's) S 144 J ( finished) S 144 J ( but) S 144 J ( there's) S 144 J ( more) S 144 J ( to) S 
2400 8040 P (//) S 144 J ( transfer) S 144 J ( for) S 144 J ( the) S 144 J ( current) S 144 J ( IRP,) S 144 J ( program) S 144 J ( the) S 144 J ( controller) S 144 J ( for) S 
2400 8300 P (//) S 144 J ( the) S 144 J ( next) S 144 J ( transfer) S 144 J ( operation.) S 144 J ( This) S 144 J ( code) S 144 J ( runs) S 144 J ( only) S 144 J ( if) S 144 J ( an) S 
2400 8560 P (//) S 144 J ( interrupt) S 144 J ( is) S 144 J ( NOT) S 144 J ( expected) S 144 J ( from) S 144 J ( emptying/filling) S 144 J ( the) S 
2400 8820 P (//) S 144 J ( cache,) S 144 J ( so) S 144 J ( contention) S 144 J ( with) S 144 J ( the) S 144 J ( ISR) S 144 J ( or) S 144 J ( reentry) S 144 J ( to) S 144 J ( this) S 
2400 9080 P (//) S 144 J ( routine) S 144 J ( is) S 144 J ( impossible.) S 
2400 9340 P (//) S 
2400 9600 P () S 480 J ( if) S 144 J ( \(\(returnStatus) S 144 J ( ==) S 144 J ( STATUS_SUCCESS\)) S 144 J ( &&) S 
2400 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(!expectingAnInterrupt\)) S 144 J ( &&) S 
2400 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(diskExtension->) S 
2400 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( RemainingRequestLength) S 144 J ( !=) S 144 J ( 0\)\)) S 144 J ( {) S 
2400 10640 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( recalculate) S 144 J ( starting) S 144 J ( sector,) S 
2400 10900 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( transfer) S 144 J ( length,) S 144 J ( etc.) S 
2400 11160 P () S 480 J ( ) S 480 J ( KeSynchronizeExecution\() S 
2400 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->) S 
2400 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( InterruptObject,) S 
2400 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AtStartDevice,) S 
2400 12200 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension\);) S 
2400 12460 P () S 480 J ( ) S 480 J ( return;) S 
2400 12720 P () S 480 J ( }) S 144 J ( //) S 144 J ( transfer) S 144 J ( done,) S 144 J ( but) S 144 J ( request) S 144 J ( isn't) S 144 J ( necessarily) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (22) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( If) S 144 J ( there) S 144 J ( was) S 144 J ( a) S 144 J ( controller) S 144 J ( error) S 144 J ( and) S 144 J ( retries) S 144 J ( exceeded,) S 
1680 2580 P (//) S 144 J ( or) S 144 J ( if) S 144 J ( transfer) S 144 J ( is) S 144 J ( done,) S 144 J ( complete) S 144 J ( the) S 144 J ( IRP.) S 
1680 2840 P (//) S 
1680 3100 P () S 480 J ( if) S 144 J ( \(\(returnStatus) S 144 J ( ==) S 144 J ( STATUS_DISK_OPERATION_FAILED\)) S 144 J ( ||) S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \() S 144 J ( !expectingAnInterrupt\)) S 144 J ( &&) S 
1680 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(diskExtension->) S 
1680 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( RemainingRequestLength) S 144 J ( ==) S 144 J ( 0\)) S 144 J ( {) S 
1680 4140 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(returnStatus) S 144 J ( ==) S 144 J ( STATUS_SUCCESS\)) S 144 J ( {) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( deviceObject->CurrentIrp->) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoStatus.Information) S 144 J ( =) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.Length;) S 
1680 5180 P () S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 5440 P (//) S 
1680 5700 P (//) S 144 J ( Not) S 144 J ( all) S 144 J ( the) S 144 J ( data) S 144 J ( was) S 144 J ( transferred.) S 144 J ( Let) S 144 J ( the) S 144 J ( user) S 144 J ( know) S 
1680 5960 P (//) S 144 J ( how) S 144 J ( much) S 144 J ( was.) S 144 J ( Variables) S 144 J ( like) S 144 J ( RemainingTransferLength) S 
1680 6220 P (//) S 144 J ( might) S 144 J ( be) S 144 J ( incorrect,) S 144 J ( since) S 144 J ( an) S 144 J ( error) S 144 J ( on) S 144 J ( sector) S 144 J ( N) S 144 J ( might) S 
1680 6480 P (//) S 144 J ( not) S 144 J ( show) S 144 J ( up) S 144 J ( until) S 144 J ( long) S 144 J ( after) S 144 J ( the) S 144 J ( data) S 144 J ( for) S 144 J ( sector) S 144 J ( N) S 
1680 6740 P (//) S 144 J ( was) S 144 J ( put) S 144 J ( into) S 144 J ( the) S 144 J ( controller) S 144 J ( cache.) S 144 J ( Instead,) S 144 J ( add) S 144 J ( the) S 
1680 7000 P (//) S 144 J ( amount) S 144 J ( moved) S 144 J ( in) S 144 J ( previous) S 144 J ( transfers) S 144 J ( for) S 144 J ( this) S 144 J ( IRP) S 
1680 7260 P (//) S 144 J ( to) S 144 J ( the) S 144 J ( amount) S 144 J ( moved) S 144 J ( in) S 144 J ( the) S 144 J ( current) S 144 J ( transfer.) S 
1680 7520 P (//) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( deviceObject->CurrentIrp->IoStatus.Information) S 144 J ( =) S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(\(diskExtension->FirstSectorOfTransfer) S 144 J ( -) S 
1680 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( RtlLargeIntegerShiftRight\() S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.ByteOffset,) S 
1680 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->) S 
1680 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ByteShiftToSector\).LowPart\)) S 144 J ( >>) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->ByteShiftToSector\)) S 144 J ( +) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(diskExtension->TotalTransferLength) S 144 J ( -) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(READ_CONTROLLER\() S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->ControllerAddress) S 144 J ( +) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( SECTOR_COUNT_REGISTER\)) S 144 J ( <<) S 
1680 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->) S 
1680 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ByteShiftToSector\)\);) S 
1680 11160 P () S 480 J ( ) S 480 J ( }) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (23) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Since) S 144 J ( this) S 144 J ( operation) S 144 J ( is) S 144 J ( done,) S 144 J ( release) S 144 J ( the) S 144 J ( controller) S 
2400 2580 P (//) S 144 J ( object) S 144 J ( and) S 144 J ( start) S 144 J ( the) S 144 J ( next) S 144 J ( request.) S 
2400 2840 P (//) S 
2400 3100 P () S 480 J ( ) S 480 J ( IoFreeController\() S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerObject\);) S 
2400 3880 P () S 480 J ( ) S 480 J ( AtFinishPacket\() S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension,) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( returnStatus\);) S 
2400 4660 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( request) S 144 J ( done) S 144 J ( or) S 144 J ( controller) S 144 J ( error) S 
2400 4920 P (}) S 
1920 5300 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( this) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( does) S 60 J ( not) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoFreeController) S E 0 12 F 24 12 F () S 60 J ( until) S 60 J ( it) S 60 J ( does) S 60 J ( one) S 60 J ( of) S 
1920 5560 P (the) S 60 J ( following:) S 
1920 5880 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Completes) S 60 J ( the) S 60 J ( IRP) S 60 J ( with) S 60 J ( an) S 60 J ( error) S 
1920 6200 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Possibly) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( AtDiskStartReset,) S 60 J ( which) S 60 J ( is) S 60 J ( a) S 60 J ( driver-) S 
2400 6460 P (supplied) S 60 J ( SynchCritSection) S 60 J ( routine,) S 60 J ( to) S 60 J ( reset) S 60 J ( the) S 60 J ( disk) S 60 J ( controller) S 60 J ( so) S 60 J ( the) S 60 J ( driver) S 60 J ( can) S 60 J ( retry) S 60 J ( an) S 
2400 6720 P (I/O) S 60 J ( operation) S 60 J ( for) S 60 J ( the) S 60 J ( given) S 60 J ( request) S 60 J ( and) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 
1920 7040 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Satisfies) S 60 J ( the) S 60 J ( transfer) S 60 J ( request) S 60 J ( in) S 60 J ( full) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 
2400 7300 P (SynchCritSection) S 60 J ( routine) S 60 J ( AtStartDevice) S 60 J ( as) S 60 J ( many) S 60 J ( times) S 60 J ( as) S 60 J ( necessary) S 
1920 7680 P (See) S 60 J ( Chapter) S 60 J ( 11) S 60 J ( for) S 60 J ( a) S 60 J ( discussion) S 60 J ( of) S 60 J ( this) S 60 J ( driver's) S 60 J ( ControllerControl) S 60 J ( routine.) S 60 J ( For) S 60 J ( more) S 
1920 7940 P (information) S 60 J ( about) S 60 J ( SynchCritSection) S 60 J ( routines,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 10.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (24) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (This) S 60 J ( driver's) S 60 J ( internal) S 60 J ( AtFinishPacket) S 60 J ( routine) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoStartNextPacketByKey) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( call) S 60 J ( the) S 
1200 2320 P (driver's) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( with) S 60 J ( the) S 60 J ( next) S 60 J ( request,) S 60 J ( if) S 60 J ( any.) S 60 J ( AtFinishPacket) S 60 J ( also) S 60 J ( completes) S 60 J ( the) S 60 J ( current) S 
1200 2580 P (IRP) S 60 J ( as) S 60 J ( follows:) S 
1680 3100 P 0 12 F 0 12 F ({) S 
1680 3360 P () S 480 J ( PIRP) S 144 J ( irp) S 144 J ( =) S 144 J ( DiskExtension->DeviceObject->CurrentIrp;) S 
1680 3620 P () S 480 J ( ULONG) S 144 J ( firstSectorOfRequest;) S 
1680 3880 P (//) S 
1680 4140 P (//) S 144 J ( Need) S 144 J ( to) S 144 J ( pass) S 144 J ( current) S 144 J ( cylinder) S 144 J ( so) S 144 J ( next) S 144 J ( packet) S 144 J ( started) S 
1680 4400 P (//) S 144 J ( in) S 144 J ( C-SCAN) S 144 J ( order.) S 
1680 4660 P (//) S 
1680 4920 P () S 480 J ( firstSectorOfRequest) S 144 J ( =) S 144 J ( DiskExtension->) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( FirstSectorOfRequest;) S 
1680 5440 P () S 480 J ( DiskExtension->FirstSectorOfRequest) S 144 J ( =) S 144 J ( MAXULONG;) S 
1680 5700 P () S 480 J ( IoStartNextPacketByKey\() S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DiskExtension->DeviceObject,) S 
1680 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( FALSE,) S 
1680 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( firstSectorOfRequest\);) S 
1680 6740 P () S 480 J ( irp->IoStatus.Status) S 144 J ( =) S 144 J ( NtStatus;) S 
1680 7000 P (//) S 
1680 7260 P (//) S 144 J ( Before) S 144 J ( completing) S 144 J ( read) S 144 J ( requests,) S 144 J ( flush) S 144 J ( the) S 144 J ( processor) S 144 J ( data) S 
1680 7520 P (//) S 144 J ( cache) S 144 J ( to) S 144 J ( be) S 144 J ( sure) S 144 J ( all) S 144 J ( data) S 144 J ( was) S 144 J ( transferred) S 
1680 7780 P (//) S 144 J ( to) S 144 J ( system) S 144 J ( memory.) S 
1680 8040 P (//) S 
1680 8300 P () S 480 J ( if) S 144 J ( \(IoGetCurrentIrpStackLocation\(irp\)->) S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( MajorFunction) S 144 J ( ==) S 144 J ( IRP_MJ_READ\)) S 144 J ( {) S 
1680 8820 P () S 480 J ( ) S 480 J ( KeFlushIoBuffers\() S 
1680 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irp->MdlAddress,) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( TRUE,) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( FALSE\);) S 
1680 9860 P () S 480 J ( }) S 
1680 10120 P () S 480 J ( IoCompleteRequest\(irp,) S 144 J ( IO_DISK_INCREMENT\);) S 
1680 10380 P (}) S 
1200 10760 P 0 12 F 24 12 F (For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( maintaining) S 60 J ( cache) S 60 J ( coherency) S 60 J ( during) S 60 J ( PIO) S 60 J ( read) S 60 J ( operations,) S 60 J ( see) S 60 J ( also) S 
1200 11020 P (Chapter) S 60 J ( 16.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (25) S E B () S 720 J ( ) S E 
1920 2080 P 0 12 F 8 12 F B (9.2.3) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( Points) S 67 J ( to) S 67 J ( Consider) S 67 J ( in) S 67 J ( Implementing) S 67 J ( a) S 67 J ( DpcForIsr) S 67 J ( Routine) S E 
1920 2700 P 0 12 F 24 12 F (Keep) S 60 J ( the) S 60 J ( following) S 60 J ( points) S 60 J ( in) S 60 J ( mind) S 60 J ( when) S 60 J ( implementing) S 60 J ( a) S 60 J ( DpcForIsr) S 60 J ( routine:) S 
1920 3020 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( must) S 60 J ( synchronize) S 60 J ( its) S 60 J ( access) S 60 J ( to) S 60 J ( a) S 60 J ( physical) S 60 J ( device) S 60 J ( and) S 60 J ( to) S 60 J ( any) S 60 J ( shared) S 
2400 3280 P (state) S 60 J ( information) S 60 J ( that) S 60 J ( the) S 60 J ( driver) S 60 J ( maintains) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( extension) S 60 J ( with) S 60 J ( the) S 60 J ( driver's) S 60 J ( other) S 
2400 3540 P (routines) S 60 J ( that) S 60 J ( access) S 60 J ( the) S 60 J ( same) S 60 J ( device) S 60 J ( or) S 60 J ( memory) S 60 J ( location.) S 
2400 3860 P (If) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( shares) S 60 J ( the) S 60 J ( device) S 60 J ( or) S 60 J ( state) S 60 J ( with) S 60 J ( the) S 60 J ( ISR,) S 60 J ( it) S 60 J ( must) S 60 J ( call) S 
2400 4120 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( to) S 60 J ( program) S 
2400 4380 P (the) S 60 J ( device) S 60 J ( or) S 60 J ( to) S 60 J ( access) S 60 J ( the) S 60 J ( shared) S 60 J ( state.) S 
2400 4700 P (If) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( shares) S 60 J ( state) S 60 J ( with) S 60 J ( routines) S 60 J ( other) S 60 J ( than) S 60 J ( the) S 60 J ( ISR,) S 60 J ( it) S 60 J ( must) S 60 J ( protect) S 60 J ( the) S 60 J ( shared) S 
2400 4960 P (state) S 60 J ( with) S 60 J ( a) S 60 J ( driver-initialized) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock) S 60 J ( for) S 60 J ( which) S 60 J ( the) S 60 J ( driver) S 60 J ( provided) S 60 J ( the) S 
2400 5220 P (storage.) S 
1920 5540 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( runs) S 60 J ( at) S 60 J ( IRQL) S 60 J ( DISPATCH_LEVEL,) S 60 J ( which) S 60 J ( restricts) S 60 J ( the) S 60 J ( set) S 60 J ( of) S 
2400 5800 P (support) S 60 J ( routines) S 60 J ( it) S 60 J ( can) S 60 J ( call.) S 
2400 6120 P (For) S 60 J ( example,) S 60 J ( a) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( can) S 60 J ( neither) S 60 J ( access) S 60 J ( nor) S 60 J ( allocate) S 60 J ( pageable) S 60 J ( memory,) S 60 J ( and) S 
2400 6380 P (it) S 60 J ( cannot) S 60 J ( wait) S 60 J ( on) S 60 J ( a) S 60 J ( dispatcher) S 60 J ( object.) S 60 J ( On) S 60 J ( the) S 60 J ( other) S 60 J ( hand,) S 60 J ( a) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( can) S 60 J ( acquire) S 
2400 6640 P (and) S 60 J ( release) S 60 J ( a) S 60 J ( driver-allocated) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (KeAcquireSpinLockAtDpcLevel) S E 
2400 6900 P 0 12 F 24 12 F (and) S 60 J ( ) S 0 12 F 24 12 F B (KeReleaseSpinLockFromDpcLevel) S E 0 12 F 24 12 F (,) S 60 J ( which) S 60 J ( run) S 60 J ( faster) S 60 J ( than) S 60 J ( ) S 0 12 F 24 12 F B (KeAcquireSpinLock) S E 
2400 7160 P 0 12 F 24 12 F (and) S 60 J ( ) S 0 12 F 24 12 F B (KeReleaseSpinLock) S E 0 12 F 24 12 F (.) S 
1920 7480 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( DpcForIsr) S 60 J ( is) S 60 J ( responsible) S 60 J ( for) S 60 J ( starting) S 60 J ( the) S 60 J ( next) S 60 J ( I/O) S 60 J ( operation) S 60 J ( on) S 60 J ( the) S 60 J ( device.) S 
2400 7800 P (For) S 60 J ( device) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( direct) S 60 J ( I/O,) S 60 J ( this) S 60 J ( responsibility) S 60 J ( can) S 60 J ( include) S 60 J ( reprogramming) S 60 J ( the) S 
2400 8060 P (device) S 60 J ( to) S 60 J ( transfer) S 60 J ( more) S 60 J ( data) S 60 J ( in) S 60 J ( order) S 60 J ( to) S 60 J ( satisfy) S 60 J ( the) S 60 J ( current) S 60 J ( IRP) S 60 J ( before) S 60 J ( the) S 60 J ( driver) S 60 J ( calls) S 
2400 8320 P 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F (.) S 
1920 8640 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( a) S 60 J ( monolithic) S 60 J ( driver) S 60 J ( set) S 60 J ( up) S 60 J ( a) S 60 J ( controller) S 60 J ( object) S 60 J ( in) S 60 J ( its) S 60 J ( DriverEntry) S 60 J ( routine) S 60 J ( to) S 60 J ( synchronize) S 
2400 8900 P (I/O) S 60 J ( operations) S 60 J ( through) S 60 J ( the) S 60 J ( controller) S 60 J ( to) S 60 J ( attached) S 60 J ( devices,) S 60 J ( its) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( is) S 
2400 9160 P (responsible) S 60 J ( for) S 60 J ( releasing) S 60 J ( the) S 60 J ( controller) S 60 J ( object) S 60 J ( \(with) S 60 J ( ) S 0 12 F 24 12 F B (IoFreeController) S E 0 12 F 24 12 F (\)) S 60 J ( before) S 60 J ( it) S 
2400 9420 P (completes) S 60 J ( an) S 60 J ( IRP.) S 
1920 9740 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( driver) S 60 J ( uses) S 60 J ( DMA) S 60 J ( and) S 60 J ( its) S 60 J ( AdapterControl) S 60 J ( routine) S 60 J ( returns) S 60 J ( ) S 0 12 F 24 12 F B (KeepObject) S E 0 12 F 24 12 F () S 60 J ( or) S 
2400 10000 P 0 12 F 24 12 F B (DeallocateObjectKeepRegisters) S E 0 12 F 24 12 F () S 60 J ( \(thereby) S 60 J ( retaining) S 60 J ( the) S 60 J ( system) S 60 J ( DMA) S 60 J ( controller) S 60 J ( channel) S 
2400 10260 P (or) S 60 J ( busmaster) S 60 J ( adapter) S 60 J ( for) S 60 J ( additional) S 60 J ( transfer) S 60 J ( operations\),) S 60 J ( the) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( routine) S 60 J ( is) S 
2400 10520 P (responsible) S 60 J ( for) S 60 J ( releasing) S 60 J ( the) S 60 J ( adapter) S 60 J ( object) S 60 J ( or) S 60 J ( map) S 60 J ( registers) S 60 J ( before) S 60 J ( it) S 60 J ( completes) S 60 J ( the) S 
2400 10780 P (current) S 60 J ( IRP) S 60 J ( and) S 60 J ( returns) S 60 J ( control.) S 
1920 11100 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( DpcForIsr) S 60 J ( is) S 60 J ( generally) S 60 J ( responsible) S 60 J ( for) S 60 J ( logging) S 60 J ( any) S 60 J ( device) S 60 J ( errors) S 60 J ( that) S 60 J ( occurred) S 60 J ( during) S 
2400 11360 P (the) S 60 J ( processing) S 60 J ( of) S 60 J ( a) S 60 J ( given) S 60 J ( request,) S 60 J ( retrying) S 60 J ( the) S 60 J ( current) S 60 J ( request) S 60 J ( if) S 60 J ( necessary) S 60 J ( \(and) S 60 J ( also) S 
2400 11620 P (possible\),) S 60 J ( and) S 60 J ( for) S 60 J ( setting) S 60 J ( the) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( and) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 
2400 11880 P (current) S 60 J ( IRP.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (26) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( DpcForIsr) S 60 J ( of) S 60 J ( a) S 60 J ( driver) S 60 J ( that) S 60 J ( overlaps) S 60 J ( operations) S 60 J ( on) S 60 J ( its) S 60 J ( device) S 60 J ( cannot) S 60 J ( rely) S 60 J ( on) S 60 J ( a) S 60 J ( one-to-) S 
1680 2320 P (one) S 60 J ( correspondence) S 60 J ( between) S 60 J ( requests) S 60 J ( input) S 60 J ( to) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( and) S 60 J ( the) S 60 J ( ISR's) S 60 J ( calls) S 60 J ( to) S 
1680 2580 P 0 12 F 24 12 F B (IoRequestDpc) S E 0 12 F 24 12 F (.) S 60 J ( In) S 60 J ( other) S 60 J ( words,) S 60 J ( such) S 60 J ( a) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( cannot) S 60 J ( necessarily) S 60 J ( use) S 60 J ( the) S 60 J ( input) S 
1680 2840 P (pointers) S 60 J ( to) S 60 J ( the) S 60 J ( IRP) S 60 J ( and) S 60 J ( ISR-supplied) S 60 J ( context) S 60 J ( \(nor) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (CurrentIrp) S E 0 12 F 24 12 F () S 60 J ( in) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 
1680 3100 P (object\)) S 60 J ( to) S 60 J ( complete) S 60 J ( only) S 60 J ( that) S 60 J ( IRP.) S 
1680 3420 P (If) S 60 J ( the) S 60 J ( ISR) S 60 J ( of) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoRequestDpc) S E 0 12 F 24 12 F () S 60 J ( \(or) S 60 J ( ) S 0 12 F 24 12 F B (KeInsertQueueDpc) S E 0 12 F 24 12 F (\)) S 60 J ( more) S 60 J ( than) S 60 J ( once) S 
1680 3680 P (before) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( \(or) S 60 J ( CustomDpc\)) S 60 J ( executes,) S 60 J ( only) S 60 J ( one) S 60 J ( instantiation) S 60 J ( of) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( is) S 
1680 3940 P (run) S 60 J ( as) S 60 J ( soon) S 60 J ( as) S 60 J ( the) S 60 J ( IRQL) S 60 J ( on) S 60 J ( a) S 60 J ( processor) S 60 J ( falls) S 60 J ( below) S 60 J ( DISPATCH_LEVEL.) S 60 J ( Therefore,) S 60 J ( any) S 
1680 4200 P (driver) S 60 J ( that) S 60 J ( overlaps) S 60 J ( interrupt-driven) S 60 J ( I/O) S 60 J ( operations) S 60 J ( on) S 60 J ( its) S 60 J ( device) S 60 J ( must) S 60 J ( have) S 60 J ( the) S 60 J ( following) S 
1680 4460 P (functionality:) S 
1200 4780 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( A) S 60 J ( DpcForIsr) S 60 J ( \(or) S 60 J ( CustomDpc\)) S 60 J ( that) S 60 J ( can) S 60 J ( complete) S 60 J ( some) S 60 J ( driver-maintained) S 60 J ( count) S 60 J ( of) S 
2160 5040 P (outstanding) S 60 J ( requests) S 60 J ( when) S 60 J ( it) S 60 J ( is) S 60 J ( called) S 
1200 5360 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( An) S 60 J ( ISR) S 60 J ( that) S 60 J ( never) S 60 J ( overwrites) S 60 J ( its) S 60 J ( saved) S 60 J ( context) S 60 J ( for) S 60 J ( an) S 60 J ( interrupt-driven) S 60 J ( I/O) S 60 J ( operation) S 
2160 5620 P (until) S 60 J ( the) S 60 J ( DpcForIsr) S 60 J ( \(or) S 60 J ( CustomDpc\)) S 60 J ( has) S 60 J ( consumed) S 60 J ( that) S 60 J ( context) S 60 J ( information) S 60 J ( and) S 
2160 5880 P (completed) S 60 J ( the) S 60 J ( IRP) S 60 J ( for) S 60 J ( which) S 60 J ( the) S 60 J ( context) S 60 J ( was) S 60 J ( saved) S 
1200 6200 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( A) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( that) S 60 J ( accesses) S 60 J ( the) S 60 J ( ISR's) S 60 J ( context) S 60 J ( area) S 60 J ( on) S 60 J ( behalf) S 60 J ( of) S 60 J ( the) S 
2160 6460 P (DpcForIsr) S 60 J ( \(or) S 60 J ( CustomDpc\)) S 60 J ( routine) S 
1200 6840 P (For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( CustomDpc) S 60 J ( routines,) S 60 J ( see) S 60 J ( Section) S 60 J ( 9.3,) S 60 J ( next.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 
1200 7100 P (about) S 60 J ( SynchCritSection) S 60 J ( routines,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 10,) S 60 J ( next.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
1200 7360 P (ControllerControl) S 60 J ( and) S 60 J ( AdapterControl) S 60 J ( routines,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 11.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
1200 7620 P (any) S 60 J ( particular) S 60 J ( support) S 60 J ( routine) S 60 J ( mentioned) S 60 J ( in) S 60 J ( the) S 60 J ( preceding) S 60 J ( list,) S 60 J ( see) S 60 J ( also) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F I (Kernel-mode) S E 
1200 7880 P I (Driver) S 60 J ( Reference) S E 0 12 F 24 12 F (.) S 
1200 8680 P 0 12 F 8 14 F B (9.3) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Implementing) S 78 J ( CustomDpc) S 78 J ( Routines) S E 
1200 9300 P 0 12 F 24 12 F (As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( the) S 60 J ( introduction) S 60 J ( to) S 60 J ( this) S 60 J ( chapter,) S 60 J ( most) S 60 J ( NT) S 60 J ( device) S 60 J ( drivers) S 60 J ( have) S 60 J ( a) S 60 J ( single) S 
1200 9560 P (DpcForIsr) S 60 J ( routine) S 60 J ( to) S 60 J ( complete) S 60 J ( I/O) S 60 J ( processing) S 60 J ( for) S 60 J ( each) S 60 J ( IRP) S 60 J ( that) S 60 J ( requires) S 60 J ( one) S 60 J ( or) S 60 J ( more) S 
1200 9820 P (operations) S 60 J ( on) S 60 J ( their) S 60 J ( respective) S 60 J ( devices.) S 60 J ( Using) S 60 J ( a) S 60 J ( single) S 60 J ( DpcForIsr) S 60 J ( to) S 60 J ( complete) S 60 J ( per-request,) S 
1200 10080 P (interrupt-driven) S 60 J ( I/O) S 60 J ( operations) S 60 J ( on) S 60 J ( a) S 60 J ( device) S 60 J ( that) S 60 J ( does) S 60 J ( one) S 60 J ( operation) S 60 J ( at) S 60 J ( a) S 60 J ( time) S 60 J ( is) S 60 J ( relatively) S 60 J ( easy:) S 
1200 10340 P (that) S 60 J ( is,) S 60 J ( such) S 60 J ( a) S 60 J ( driver's) S 60 J ( ISR) S 60 J ( need) S 60 J ( only) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoRequestDpc) S E 0 12 F 24 12 F () S 60 J ( for) S 60 J ( each) S 60 J ( interrupt-driven) S 60 J ( I/O) S 
1200 10600 P (operation.) S 
1200 10980 P (However,) S 60 J ( using) S 60 J ( a) S 60 J ( single) S 60 J ( DpcForIsr) S 60 J ( to) S 60 J ( complete) S 60 J ( overlapped,) S 60 J ( interrupt-driven) S 60 J ( I/O) S 60 J ( operations) S 60 J ( on) S 
1200 11240 P (a) S 60 J ( device) S 60 J ( that) S 60 J ( can) S 60 J ( do) S 60 J ( concurrent) S 60 J ( operations) S 60 J ( is) S 60 J ( possible) S 60 J ( with) S 60 J ( careful) S 60 J ( design) S 60 J ( but) S 60 J ( can) S 60 J ( be) S 60 J ( relatively) S 
1200 11500 P (difficult.) S 60 J ( In) S 60 J ( addition) S 60 J ( to) S 60 J ( or) S 60 J ( instead) S 60 J ( of) S 60 J ( queueing) S 60 J ( a) S 60 J ( DpcForIsr,) S 60 J ( an) S 60 J ( NT) S 60 J ( device) S 60 J ( driver's) S 60 J ( ISR) S 60 J ( can) S 
1200 11760 P (queue) S 60 J ( a) S 60 J ( set) S 60 J ( of) S 60 J ( operation-specific,) S 60 J ( driver-supplied) S 60 J ( CustomDpc) S 60 J ( routines) S 60 J ( by) S 60 J ( calling) S 
1200 12020 P 0 12 F 24 12 F B (KeInsertQueueDpc) S E 0 12 F 24 12 F () S 60 J ( at) S 60 J ( the) S 60 J ( discretion) S 60 J ( of) S 60 J ( the) S 60 J ( driver) S 60 J ( designer.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (27) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (For) S 60 J ( example,) S 60 J ( consider) S 60 J ( some) S 60 J ( of) S 60 J ( the) S 60 J ( design) S 60 J ( challenges) S 60 J ( for) S 60 J ( an) S 60 J ( NT) S 60 J ( serial) S 60 J ( driver.) S 60 J ( As) S 60 J ( the) S 60 J ( driver) S 60 J ( of) S 60 J ( a) S 
1920 2320 P (full-duplex) S 60 J ( device,) S 60 J ( an) S 60 J ( NT) S 60 J ( serial) S 60 J ( driver) S 60 J ( cannot) S 60 J ( rely) S 60 J ( on) S 60 J ( a) S 60 J ( one-to-one) S 60 J ( correspondence) S 60 J ( between) S 
1920 2580 P (the) S 60 J ( order) S 60 J ( in) S 60 J ( which) S 60 J ( IRPs) S 60 J ( are) S 60 J ( queued) S 60 J ( to) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( and) S 60 J ( the) S 60 J ( sequence) S 60 J ( of) S 60 J ( interrupts) S 60 J ( from) S 60 J ( its) S 
1920 2840 P (device) S 60 J ( in) S 60 J ( a) S 60 J ( multitasking,) S 60 J ( multiprocessor) S 60 J ( system.) S 60 J ( Furthermore,) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( must) S 60 J ( handle) S 
1920 3100 P (timing) S 60 J ( out) S 60 J ( requests) S 60 J ( and) S 60 J ( asynchronous) S 60 J ( user-generated) S 60 J ( requests) S 60 J ( to) S 60 J ( cancel) S 60 J ( previously) S 60 J ( requested) S 
1920 3360 P (operations,) S 60 J ( to) S 60 J ( purge) S 60 J ( buffered) S 60 J ( data,) S 60 J ( and) S 60 J ( so) S 60 J ( forth.) S 
1920 3740 P (Consequently,) S 60 J ( an) S 60 J ( NT) S 60 J ( serial) S 60 J ( driver) S 60 J ( might) S 60 J ( maintain) S 60 J ( internal) S 60 J ( queues) S 60 J ( for) S 60 J ( the) S 60 J ( read,) S 60 J ( write,) S 60 J ( purge,) S 
1920 4000 P (and) S 60 J ( wait) S 60 J ( operations) S 60 J ( that) S 60 J ( user-mode) S 60 J ( comm) S 60 J ( applications) S 60 J ( can) S 60 J ( request.) S 60 J ( It) S 60 J ( also) S 60 J ( could) S 60 J ( maintain) S 
1920 4260 P (reference) S 60 J ( counts) S 60 J ( or) S 60 J ( use) S 60 J ( some) S 60 J ( other) S 60 J ( tracking) S 60 J ( mechanism,) S 60 J ( such) S 60 J ( as) S 60 J ( a) S 60 J ( set) S 60 J ( of) S 60 J ( flags,) S 60 J ( for) S 60 J ( the) S 60 J ( IRPs) S 60 J ( in) S 
1920 4520 P (its) S 60 J ( internal) S 60 J ( queues.) S 60 J ( Its) S 60 J ( ISR) S 60 J ( would) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (KeInsertQueueDpc) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( number) S 60 J ( of) S 60 J ( driver-allocated) S 
1920 4780 P (and) S 60 J ( initialized) S 60 J ( DPC) S 60 J ( objects,) S 60 J ( each) S 60 J ( associated) S 60 J ( with) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( CustomDpc) S 60 J ( routine.) S 60 J ( For) S 
1920 5040 P (example,) S 60 J ( one) S 60 J ( of) S 60 J ( the) S 60 J ( DPC) S 60 J ( objects) S 60 J ( that) S 60 J ( such) S 60 J ( a) S 60 J ( driver's) S 60 J ( ISR) S 60 J ( queues) S 60 J ( is) S 60 J ( shown) S 60 J ( in) S 60 J ( the) S 60 J ( following) S 
1920 5300 P (code) S 60 J ( fragment:) S 
2400 5820 P 0 12 F 0 12 F () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
2400 6080 P () S 480 J ( Extension->HoldingEmpty) S 144 J ( =) S 144 J ( FALSE;) S 
2400 6340 P () S 480 J ( Extension->WriteCurrentChar++;) S 
2400 6600 P () S 480 J ( Extension->WriteLength--;) S 
2400 6860 P () S 480 J ( if) S 144 J ( \(!Extension->WriteLength\)) S 144 J ( {) S 
2400 7120 P () S 480 J ( ) S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp;) S 
2400 7380 P (//) S 
2400 7640 P (//) S 144 J ( No) S 144 J ( more) S 144 J ( characters) S 144 J ( left.) S 144 J ( This) S 144 J ( write) S 144 J ( is) S 144 J ( complete.) S 
2400 7900 P (//) S 144 J ( Take) S 144 J ( care) S 144 J ( updating) S 144 J ( the) S 144 J ( information) S 144 J ( field) S 144 J ( because) S 
2400 8160 P (//) S 144 J ( there) S 144 J ( might) S 144 J ( be) S 144 J ( an) S 144 J ( xoff) S 144 J ( counter) S 144 J ( masquerading) S 
2400 8420 P (//) S 144 J ( as) S 144 J ( a) S 144 J ( write) S 144 J ( IRP.) S 
2400 8680 P (//) S 
2400 8940 P () S 480 J ( ) S 480 J ( irpSp) S 144 J ( =) S 
2400 9200 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\() S 
2400 9460 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Extension->) S 
2400 9720 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( CurrentWriteIrp\);) S 
2400 9980 P () S 480 J ( ) S 480 J ( Extension->CurrentWriteIrp->) S 
2400 10240 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoStatus.Information) S 144 J ( =) S 
2400 10500 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(irpSp->MajorFunction) S 144 J ( ==) S 144 J ( IRP_MJ_WRITE\)?) S 
2400 10760 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(irpSp->Parameters.Write.Length\):) S 
2400 11020 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(1\);) S 
2400 11280 P () S 480 J ( ) S 480 J ( KeInsertQueueDpc\() S 
2400 11540 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &Extension->CompleteWriteDpc,) S 
2400 11800 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( NULL,) S 
2400 12060 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( NULL\);) S 
2400 12320 P () S 480 J ( }) S 
2400 12580 P () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( end) S 144 J ( case) S 144 J ( SERIAL_IIR_THR) S 
2400 12840 P () S 480 J ( break;) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (28) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2180 P 0 12 F 24 12 F (The) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( associated) S 60 J ( with) S 60 J ( the) S 60 J ( DPC) S 60 J ( object,) S 60 J ( CompleteWriteDpc,) S 60 J ( would) S 60 J ( be) S 60 J ( very) S 
1200 2440 P (similar) S 60 J ( to) S 60 J ( the) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( associated) S 60 J ( with) S 60 J ( this) S 60 J ( driver's) S 60 J ( CompleteReadDpc.) S 60 J ( Each) S 60 J ( of) S 
1200 2700 P (these) S 60 J ( routines) S 60 J ( is) S 60 J ( responsible) S 60 J ( for) S 60 J ( setting) S 60 J ( up) S 60 J ( parameters) S 60 J ( and) S 60 J ( calling) S 
1200 2960 P (SerialTryToCompleteCurrent.) S 60 J ( For) S 60 J ( example,) S 60 J ( the) S 60 J ( SerialCompleteWrite) S 60 J ( routine) S 60 J ( has) S 60 J ( code) S 
1200 3220 P (something) S 60 J ( like) S 60 J ( the) S 60 J ( following:) S 
1680 3740 P 0 12 F 0 12 F ({) S 
1680 4000 P () S 480 J ( PSERIAL_DEVICE_EXTENSION) S 144 J ( extension) S 144 J ( =) S 144 J ( DeferredContext;) S 
1680 4260 P () S 480 J ( KIRQL) S 144 J ( oldIrql;) S 
1680 4780 P () S 480 J ( IoAcquireCancelSpinLock\(&oldIrql\);) S 
1680 5040 P () S 480 J ( SerialTryToCompleteCurrent\() S 
1680 5300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension,) S 
1680 5560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( NULL,) S 
1680 5820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( oldIrql,) S 
1680 6080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_SUCCESS,) S 
1680 6340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &extension->CurrentWriteIrp,) S 
1680 6600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &extension->WriteQueue,) S 
1680 6860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( NULL,) S 
1680 7120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &extension->WriteRequestTotalTimer,) S 
1680 7380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( SerialStartWrite,) S 
1680 7640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( SerialGetNextWrite\);) S 
1680 7900 P (}) S 
1200 8280 P 0 12 F 24 12 F (Assuming) S 60 J ( it) S 60 J ( was) S 60 J ( the) S 60 J ( SerialCompleteWrite) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( that) S 60 J ( called) S 
1200 8540 P (SerialTryToCompleteCurrent,) S 60 J ( this) S 60 J ( internal) S 60 J ( routine) S 60 J ( does) S 60 J ( the) S 60 J ( following:) S 
1680 9060 P 0 12 F 0 12 F ({) S 
1680 9320 P (//) S 
1680 9580 P (//) S 144 J ( Decrement) S 144 J ( the) S 144 J ( reference) S 144 J ( to) S 144 J ( "remove") S 144 J ( the) S 144 J ( fact) S 144 J ( that) S 
1680 9840 P (//) S 144 J ( that) S 144 J ( the) S 144 J ( caller) S 144 J ( no) S 144 J ( longer) S 144 J ( will) S 144 J ( be) S 144 J ( accessing) S 144 J ( this) S 144 J ( IRP.) S 
1680 10100 P (//) S 
1680 10360 P () S 480 J ( SERIAL_DEC_REFERENCE\(*CurrentOpIrp\);) S 
1680 10880 P (//////////////////////////////////////////////////////////) S 
1680 11140 P (//) S 144 J ( SerialCompleteWrite) S 144 J ( passed) S 144 J ( a) S 144 J ( NULL) S 144 J ( pointer) S 144 J ( for) S 144 J ( the) S 
1680 11400 P (//) S 144 J ( \(optional\)) S 144 J ( second) S 144 J ( parameter) S 144 J ( \(a) S 144 J ( SynchCritSection) S 
1680 11660 P (//) S 144 J ( entry) S 144 J ( point\)) S 144 J ( to) S 144 J ( SerialTryToCompleteCurrent,) S 
1680 11920 P (//) S 144 J ( so) S 144 J ( the) S 144 J ( next) S 144 J ( code) S 144 J ( path) S 144 J ( is) S 144 J ( not) S 144 J ( entered.) S 
1680 12180 P (//////////////////////////////////////////////////////////) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (29) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( if) S 144 J ( \(SynchRoutine\)) S 144 J ( {) S 
2400 2320 P () S 480 J ( ) S 480 J ( KeSynchronizeExecution\() S 
2400 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Extension->Interrupt,) S 
2400 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( SynchRoutine,) S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Extension\);) S 
2400 3360 P () S 480 J ( }) S 
2400 3620 P (//) S 
2400 3880 P (//) S 144 J ( Try) S 144 J ( to) S 144 J ( run) S 144 J ( down) S 144 J ( all) S 144 J ( other) S 144 J ( references) S 144 J ( to) S 144 J ( this) S 144 J ( IRP.) S 
2400 4140 P (//) S 
2400 4400 P () S 480 J ( SerialRundownIrpRefs\() S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( CurrentOpIrp,) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IntervalTimer,) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( TotalTimer\);) S 
2400 5440 P (//) S 
2400 5700 P (//) S 144 J ( See) S 144 J ( if) S 144 J ( the) S 144 J ( reference) S 144 J ( count) S 144 J ( is) S 144 J ( zero) S 144 J ( after) S 144 J ( resetting) S 144 J ( any) S 
2400 5960 P (//) S 144 J ( of) S 144 J ( the) S 144 J ( timers) S 144 J ( that) S 144 J ( might) S 144 J ( have) S 144 J ( references) S 144 J ( to) S 144 J ( this) S 144 J ( IRP.) S 
2400 6220 P (//) S 
2400 6480 P () S 480 J ( if) S 144 J ( \(!SERIAL_REFERENCE_COUNT\(*CurrentOpIrp\)\)) S 144 J ( {) S 
2400 6740 P () S 480 J ( ) S 480 J ( PIRP) S 144 J ( newIrp;) S 
2400 7000 P (//) S 
2400 7260 P (//) S 144 J ( The) S 144 J ( reference) S 144 J ( count) S 144 J ( was) S 144 J ( zero,) S 144 J ( so) S 144 J ( complete) S 144 J ( this) S 144 J ( request.) S 
2400 7520 P (//) S 144 J ( The) S 144 J ( following) S 144 J ( will) S 144 J ( also) S 144 J ( cause) S 144 J ( the) S 144 J ( current) S 144 J ( IRP) S 
2400 7780 P (//) S 144 J ( to) S 144 J ( be) S 144 J ( completed.) S 
2400 8040 P (//) S 
2400 8300 P () S 480 J ( ) S 480 J ( \(*CurrentOpIrp\)->IoStatus.Status) S 144 J ( =) S 144 J ( StatusToUse;) S 
2400 8560 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(StatusToUse) S 144 J ( ==) S 144 J ( STATUS_CANCELLED\)) S 144 J ( {) S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(*CurrentOpIrp\)->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
2400 9080 P () S 480 J ( ) S 480 J ( }) S 
2400 9600 P (//////////////////////////////////////////////////////////) S 
2400 9860 P (//) S 144 J ( For) S 144 J ( a) S 144 J ( call) S 144 J ( from) S 144 J ( SerialCompleteWrite,) S 144 J ( the) S 144 J ( following) S 
2400 10120 P (//) S 144 J ( code) S 144 J ( calls) S 144 J ( the) S 144 J ( input) S 144 J ( SerialGetNextWrite) S 144 J ( routine.) S 
2400 10380 P (//////////////////////////////////////////////////////////) S 
2400 10900 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(GetNextIrp\)) S 144 J ( {) S 
2400 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoReleaseCancelSpinLock\(IrqlForRelease\);) S 
2400 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( GetNextIrp\() S 
2400 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( CurrentOpIrp,) S 
2400 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( QueueToProcess,) S 
2400 12200 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &newIrp,) S 
2400 12460 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( TRUE\);) S 144 J ( //) S 144 J ( Boolean) S 144 J ( CompleteCurrent) S 0 12 F 
PE 
1200 1220 P 10 12 F B (9-) S E B (30) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//////////////////////////////////////////////////////////) S 
1680 2320 P (//) S 144 J ( For) S 144 J ( a) S 144 J ( call) S 144 J ( from) S 144 J ( SerialCompleteWrite,) S 144 J ( the) S 144 J ( following) S 
1680 2580 P (//) S 144 J ( code) S 144 J ( calls) S 144 J ( the) S 144 J ( input) S 144 J ( SerialStartWrite) S 144 J ( routine.) S 
1680 2840 P (//////////////////////////////////////////////////////////) S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(newIrp\)) S 144 J ( {) S 
1680 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Starter\(Extension\);) S 
1680 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
1680 4400 P (//////////////////////////////////////////////////////////) S 
1680 4660 P (//) S 144 J ( For) S 144 J ( a) S 144 J ( call) S 144 J ( from) S 144 J ( SerialCompleteWrite,) S 144 J ( the) S 144 J ( following) S 
1680 4920 P (//) S 144 J ( code) S 144 J ( path) S 144 J ( is) S 144 J ( not) S 144 J ( entered.) S 
1680 5180 P (/////////////////////////////////////////////////////////) S 
1680 5700 P () S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 5960 P (//) S 
1680 6220 P (//) S 144 J ( There) S 144 J ( was) S 144 J ( no) S 144 J ( GetNextIrp) S 144 J ( passed) S 144 J ( in,) S 144 J ( so) S 144 J ( simply) S 144 J ( complete) S 
1680 6480 P (//) S 144 J ( the) S 144 J ( IRP,) S 144 J ( after) S 144 J ( first) S 144 J ( nulling) S 144 J ( out) S 144 J ( the) S 144 J ( pointer) S 144 J ( to) S 144 J ( the) S 
1680 6740 P (//) S 144 J ( pointer) S 144 J ( to) S 144 J ( this) S 144 J ( IRP.) S 
1680 7000 P (//) S 
1680 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( PIRP) S 144 J ( oldIrp) S 144 J ( =) S 144 J ( *CurrentOpIrp;) S 
1680 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( *CurrentOpIrp) S 144 J ( =) S 144 J ( NULL;) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoReleaseCancelSpinLock\(IrqlForRelease\);) S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoCompleteRequest\() S 
1680 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( oldIrp;) S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IO_SERIAL_INCREMENT\);) S 
1680 8820 P () S 480 J ( ) S 480 J ( }) S 
1680 9080 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 9340 P (//) S 
1680 9600 P (//) S 144 J ( Reference) S 144 J ( count) S 144 J ( still) S 144 J ( nonzero.) S 
1680 9860 P (//) S 144 J ( Release) S 144 J ( the) S 144 J ( cancel) S 144 J ( spin) S 144 J ( lock.) S 
1680 10120 P (//) S 
1680 10380 P () S 480 J ( ) S 480 J ( IoReleaseCancelSpinLock\(IrqlForRelease\);) S 
1680 10640 P () S 480 J ( }) S 
1680 10900 P (}) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 2426 J ( DpcForIsr) S 55 J ( Routine) S 55 J ( and) S 55 J ( CustomDpc) S 55 J ( Routines) S 807 J ( 9-) S E B (31) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( the) S 60 J ( SerialTryToCompleteCurrent) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 60 J ( the) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( already) S 
1920 2320 P (held) S 60 J ( because) S 60 J ( it) S 60 J ( must) S 60 J ( access) S 60 J ( a) S 60 J ( queue) S 60 J ( of) S 60 J ( cancelable) S 60 J ( IRPs,) S 60 J ( and) S 60 J ( with) S 60 J ( the) S 60 J ( entry) S 60 J ( points) S 60 J ( for) S 60 J ( two) S 60 J ( other) S 
1920 2580 P (routines:) S 
1920 2900 P () S 104 J ( 1) S 256 J ( SerialGetNextWrite,) S 60 J ( which) S 60 J ( completes) S 60 J ( the) S 60 J ( IRP) S 60 J ( when) S 60 J ( a) S 60 J ( write) S 60 J ( request) S 60 J ( is) S 60 J ( satisfied) S 60 J ( and) S 60 J ( gets) S 60 J ( a) S 
2400 3160 P (pointer) S 60 J ( to) S 60 J ( the) S 60 J ( next) S 60 J ( request) S 60 J ( in) S 60 J ( this) S 60 J ( driver's) S 60 J ( write) S 60 J ( queue) S 
1920 3480 P () S 104 J ( 2) S 256 J ( SerialStartWrite) S 60 J ( either) S 60 J ( to) S 60 J ( initialize) S 60 J ( the) S 60 J ( next) S 60 J ( IRP's) S 60 J ( I/O) S 60 J ( status) S 60 J ( block,) S 60 J ( set) S 60 J ( up) S 60 J ( timers) S 60 J ( for) S 60 J ( the) S 
2400 3740 P (write,) S 60 J ( and) S 60 J ( mark) S 60 J ( the) S 60 J ( IRP) S 60 J ( as) S 60 J ( pending,) S 60 J ( or) S 60 J ( to) S 60 J ( handle) S 60 J ( special) S 60 J ( cases,) S 60 J ( such) S 60 J ( as) S 60 J ( an) S 60 J ( xoff) S 60 J ( "write") S 
2400 4000 P (IRP) S 60 J ( or) S 60 J ( the) S 60 J ( next) S 60 J ( request) S 60 J ( being) S 60 J ( cancelled) S 60 J ( before) S 60 J ( any) S 60 J ( operations) S 60 J ( to) S 60 J ( satisfy) S 60 J ( it) S 60 J ( were) S 60 J ( started) S 60 J ( on) S 
2400 4260 P (the) S 60 J ( device) S 
1920 4640 P (In) S 60 J ( effect,) S 60 J ( the) S 60 J ( SerialTryToCompleteCurrent) S 60 J ( routine) S 60 J ( is) S 60 J ( the) S 60 J ( center) S 60 J ( of) S 60 J ( this) S 60 J ( driver's) S 60 J ( completions) S 60 J ( of) S 
1920 4900 P (most) S 60 J ( IRPs.) S 60 J ( Unless) S 60 J ( an) S 60 J ( IRP) S 60 J ( is) S 60 J ( completed) S 60 J ( in) S 60 J ( one) S 60 J ( of) S 60 J ( the) S 60 J ( serial) S 60 J ( driver's) S 60 J ( Dispatch) S 60 J ( routines,) S 
1920 5160 P (SerialTryToCompleteCurrent) S 60 J ( is) S 60 J ( called) S 60 J ( in) S 60 J ( the) S 60 J ( completion) S 60 J ( path) S 60 J ( for) S 60 J ( just) S 60 J ( about) S 60 J ( every) S 60 J ( request) S 60 J ( this) S 
1920 5420 P (driver) S 60 J ( handles.) S 
1920 5800 P (Any) S 60 J ( device) S 60 J ( driver's) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( has) S 60 J ( the) S 60 J ( same) S 60 J ( general) S 60 J ( requirements) S 60 J ( as) S 60 J ( a) S 60 J ( DpcForIsr) S 
1920 6060 P (routine.) S 60 J ( A) S 60 J ( driver) S 60 J ( writer) S 60 J ( who) S 60 J ( implements) S 60 J ( a) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( also) S 60 J ( should) S 60 J ( follow) S 60 J ( the) S 
1920 6320 P (guidelines) S 60 J ( in) S 60 J ( Section) S 60 J ( 9.2.3.) S 0 12 F 
PE PSe
