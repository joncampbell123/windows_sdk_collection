%!PS-Adobe-2.0 
PSp 15840 SFL 
1920 2440 P 8 18 F B (Chapter) S 100 J ( 6) S E 
1920 2840 P B (Dispatch) S 100 J ( Routines) S E 
1920 3600 P 0 12 F 24 12 F (This) S 60 J ( chapter) S 60 J ( summarizes) S 60 J ( the) S 60 J ( required) S 60 J ( functionality) S 60 J ( of) S 60 J ( NT) S 60 J ( drivers') S 60 J ( standard) S 60 J ( Dispatch) S 60 J ( routines) S 
1920 3860 P (and) S 60 J ( discusses) S 60 J ( implementation) S 60 J ( strategies) S 60 J ( for) S 60 J ( the) S 60 J ( most) S 60 J ( common) S 60 J ( types) S 60 J ( of) S 60 J ( Dispatch) S 60 J ( routines.) S 
1920 4660 P 0 12 F 8 14 F B (6.1) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Dispatch) S 78 J ( Routine) S 78 J ( Requirements) S E 
1920 5280 P 0 12 F 24 12 F (The) S 60 J ( driver) S 60 J ( writer) S 60 J ( determines) S 60 J ( how) S 60 J ( many) S 60 J ( Dispatch) S 60 J ( routines) S 60 J ( the) S 60 J ( driver) S 60 J ( has.) S 60 J ( An) S 60 J ( NT) S 60 J ( driver) S 60 J ( can) S 
1920 5540 P (have) S 60 J ( as) S 60 J ( many) S 60 J ( Dispatch) S 60 J ( routines) S 60 J ( as) S 60 J ( the) S 60 J ( IRP_MJ_) S 0 12 F 24 12 F I (xxx) S E 0 12 F 24 12 F () S 60 J ( function) S 60 J ( codes) S 60 J ( the) S 60 J ( driver) S 60 J ( handles.) S 60 J ( In) S 
1920 5800 P (general,) S 60 J ( most) S 60 J ( NT) S 60 J ( drivers) S 60 J ( must) S 60 J ( handle) S 60 J ( some) S 60 J ( or) S 60 J ( all) S 60 J ( of) S 60 J ( the) S 60 J ( following) S 60 J ( requests:) S 
1920 6120 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( IRP_MJ_CREATE) S 60 J ( indicates) S 60 J ( that) S 60 J ( a) S 60 J ( user-mode) S 60 J ( protected) S 60 J ( subsystem) S 60 J ( \(possibly) S 60 J ( on) S 60 J ( behalf) S 60 J ( of) S 
2400 6380 P (an) S 60 J ( application) S 60 J ( or) S 60 J ( subsystem-specific,) S 60 J ( user-mode) S 60 J ( driver\)) S 60 J ( has) S 60 J ( requested) S 60 J ( a) S 60 J ( handle) S 60 J ( for) S 60 J ( the) S 
2400 6640 P (file) S 60 J ( object) S 60 J ( that) S 60 J ( represents) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object,) S 60 J ( or) S 60 J ( that) S 60 J ( a) S 60 J ( higher-level) S 60 J ( NT) S 60 J ( driver) S 60 J ( is) S 
2400 6900 P (connecting) S 60 J ( or) S 60 J ( attaching) S 60 J ( its) S 60 J ( device) S 60 J ( object) S 60 J ( to) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object.) S 
1920 7220 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( IRP_MJ_CLEANUP) S 60 J ( indicates) S 60 J ( that) S 60 J ( the) S 60 J ( handle) S 60 J ( for) S 60 J ( the) S 60 J ( file) S 60 J ( object,) S 60 J ( representing) S 60 J ( the) S 60 J ( target) S 
2400 7480 P (device) S 60 J ( object,) S 60 J ( is) S 60 J ( being) S 60 J ( released,) S 60 J ( so) S 60 J ( any) S 60 J ( IRPs) S 60 J ( currently) S 60 J ( queued) S 60 J ( to) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( should) S 
2400 7740 P (be) S 60 J ( cancelled.) S 60 J ( \(Only) S 60 J ( certain) S 60 J ( types) S 60 J ( of) S 60 J ( drivers) S 60 J ( cancel) S 60 J ( IRPs.) S 60 J ( See) S 60 J ( Chapter) S 60 J ( 12) S 60 J ( for) S 60 J ( more) S 
2400 8000 P (information.\)) S 
1920 8320 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( IRP_MJ_CLOSE) S 60 J ( indicates) S 60 J ( that) S 60 J ( the) S 60 J ( handle) S 60 J ( of) S 60 J ( the) S 60 J ( file) S 60 J ( object) S 60 J ( that) S 60 J ( represents) S 60 J ( the) S 60 J ( target) S 
2400 8580 P (device) S 60 J ( object) S 60 J ( or) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 60 J ( has) S 60 J ( been) S 60 J ( released,) S 60 J ( and) S 60 J ( that) S 60 J ( there) S 60 J ( are) S 
2400 8840 P (no) S 60 J ( outstanding) S 60 J ( references) S 60 J ( to) S 60 J ( the) S 60 J ( file) S 60 J ( object) S 60 J ( handle) S 60 J ( or) S 60 J ( device) S 60 J ( object) S 60 J ( pointer.) S 
1920 9160 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( IRP_MJ_READ) S 60 J ( indicates) S 60 J ( an) S 60 J ( I/O) S 60 J ( request) S 60 J ( to) S 60 J ( transfer) S 60 J ( data) S 60 J ( from) S 60 J ( the) S 60 J ( underlying) S 60 J ( physical) S 
2400 9420 P (device) S 60 J ( to) S 60 J ( the) S 60 J ( system.) S 
1920 9740 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( IRP_MJ_WRITE) S 60 J ( indicates) S 60 J ( an) S 60 J ( I/O) S 60 J ( request) S 60 J ( to) S 60 J ( transfer) S 60 J ( data) S 60 J ( from) S 60 J ( the) S 60 J ( system) S 60 J ( to) S 60 J ( the) S 
2400 10000 P (underlying) S 60 J ( physical) S 60 J ( device.) S 
1920 10320 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( IRP_MJ_DEVICE_CONTROL) S 60 J ( indicates) S 60 J ( a) S 60 J ( request) S 60 J ( sent) S 60 J ( to) S 60 J ( the) S 60 J ( device) S 60 J ( driver,) S 60 J ( with) S 60 J ( a) S 
2400 10580 P (publicly) S 60 J ( defined,) S 60 J ( device-type-specific) S 60 J ( I/O) S 60 J ( control) S 60 J ( code) S 60 J ( requesting) S 60 J ( a) S 60 J ( device-type-specific) S 
2400 10840 P (operation.) S 
1920 11160 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( IRP_MJ_INTERNAL_DEVICE_CONTROL) S 60 J ( indicates) S 60 J ( a) S 60 J ( request) S 60 J ( sent) S 60 J ( to) S 60 J ( the) S 60 J ( device) S 60 J ( driver) S 
2400 11420 P (from) S 60 J ( a) S 60 J ( closely) S 60 J ( coupled) S 60 J ( higher-level) S 60 J ( driver,) S 60 J ( usually) S 60 J ( with) S 60 J ( a) S 60 J ( privately) S 60 J ( defined,) S 60 J ( driver-) S 60 J ( and) S 
2400 11680 P (device-type-specific) S 60 J ( I/O) S 60 J ( control) S 60 J ( code) S 60 J ( requesting) S 60 J ( a) S 60 J ( device-type-specific) S 60 J ( operation.) S 60 J ( \(Only) S 
2400 11940 P (certain) S 60 J ( types) S 60 J ( of) S 60 J ( NT) S 60 J ( drivers) S 60 J ( are) S 60 J ( required) S 60 J ( to) S 60 J ( handle) S 60 J ( publicly) S 60 J ( defined) S 60 J ( internal) S 60 J ( device) S 60 J ( control) S 
2400 12200 P (requests,) S 60 J ( including) S 60 J ( certain) S 60 J ( SCSI) S 60 J ( drivers) S 60 J ( and) S 60 J ( keyboard) S 60 J ( or) S 60 J ( mouse) S 60 J ( device) S 60 J ( drivers) S 60 J ( that) S 
2400 12460 P (interoperate) S 60 J ( with) S 60 J ( system-supplied) S 60 J ( drivers.\)) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (2) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (Other) S 60 J ( requests) S 60 J ( that) S 60 J ( NT) S 60 J ( device) S 60 J ( and) S 60 J ( intermediate) S 60 J ( drivers) S 60 J ( might) S 60 J ( handle) S 60 J ( include) S 60 J ( the) S 60 J ( following:) S 
1200 2380 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( IRP_MJ_QUERY_INFORMATION) S 60 J ( and) S 60 J ( IRP_MJ_SET_INFORMATION) S 60 J ( in) S 60 J ( certain) S 
1680 2640 P (highest-level) S 60 J ( device) S 60 J ( drivers) S 
1680 2960 P (Such) S 60 J ( a) S 60 J ( request) S 60 J ( indicates) S 60 J ( that) S 60 J ( a) S 60 J ( user-mode) S 60 J ( application) S 60 J ( has) S 60 J ( requested) S 60 J ( information) S 60 J ( about) S 60 J ( the) S 
1680 3220 P (length) S 60 J ( of) S 60 J ( the) S 60 J ( file) S 60 J ( object) S 60 J ( \(representing) S 60 J ( the) S 60 J ( driver's) S 60 J ( device) S 60 J ( object\)) S 60 J ( for) S 60 J ( which) S 60 J ( the) S 60 J ( application) S 
1680 3480 P (has) S 60 J ( a) S 60 J ( handle) S 60 J ( or) S 60 J ( that) S 60 J ( the) S 60 J ( application) S 60 J ( is) S 60 J ( attempting) S 60 J ( to) S 60 J ( set) S 60 J ( an) S 60 J ( end-of-file.) S 60 J ( NT) S 60 J ( parallel) S 60 J ( and) S 
1680 3740 P (serial) S 60 J ( device) S 60 J ( drivers) S 60 J ( handle) S 60 J ( these) S 60 J ( requests) S 60 J ( by) S 60 J ( setting) S 60 J ( the) S 
1680 4000 P (FILE_STANDARD_INFORMATION) S 60 J ( or) S 60 J ( FILE_POSITION_INFORMATION) S 
1680 4260 P (length/position) S 60 J ( to) S 60 J ( zero.) S 60 J ( However,) S 60 J ( other) S 60 J ( NT) S 60 J ( device) S 60 J ( drivers) S 60 J ( are) S 60 J ( not) S 60 J ( required) S 60 J ( to) S 60 J ( support) S 
1680 4520 P (these) S 60 J ( requests.) S 
1200 4840 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( IRP_MJ_FLUSH_BUFFERS) S 60 J ( by) S 60 J ( any) S 60 J ( device) S 60 J ( driver) S 60 J ( that) S 60 J ( caches) S 60 J ( data) S 60 J ( in) S 60 J ( a) S 60 J ( device) S 60 J ( or) S 60 J ( buffers) S 
1680 5100 P (data) S 60 J ( in) S 60 J ( driver-allocated) S 60 J ( memory) S 
1680 5420 P (Receipt) S 60 J ( of) S 60 J ( this) S 60 J ( request) S 60 J ( indicates) S 60 J ( that) S 60 J ( the) S 60 J ( driver) S 60 J ( should) S 60 J ( write) S 60 J ( its) S 60 J ( buffered) S 60 J ( data) S 60 J ( or) S 60 J ( flush) S 60 J ( the) S 
1680 5680 P (cached) S 60 J ( data) S 60 J ( out) S 60 J ( to) S 60 J ( the) S 60 J ( device,) S 60 J ( or) S 60 J ( should) S 60 J ( discard) S 60 J ( buffered) S 60 J ( or) S 60 J ( cached) S 60 J ( data) S 60 J ( that) S 60 J ( was) S 60 J ( read) S 
1680 5940 P (from) S 60 J ( the) S 60 J ( device.) S 60 J ( For) S 60 J ( example,) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( keyboard) S 60 J ( and) S 60 J ( mouse) S 60 J ( class) S 60 J ( drivers,) S 
1680 6200 P (which) S 60 J ( have) S 60 J ( internal) S 60 J ( ring) S 60 J ( buffers) S 60 J ( for) S 60 J ( input) S 60 J ( data) S 60 J ( from) S 60 J ( their) S 60 J ( devices,) S 60 J ( support) S 60 J ( the) S 60 J ( flush) S 
1680 6460 P (request.) S 
1200 6780 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( IRP_MJ_SHUTDOWN) S 60 J ( if) S 60 J ( a) S 60 J ( driver) S 60 J ( should) S 60 J ( be) S 60 J ( called) S 60 J ( before) S 60 J ( the) S 60 J ( system) S 60 J ( itself) S 60 J ( is) S 60 J ( shut) S 60 J ( down) S 
1680 7100 P (The) S 60 J ( driver) S 60 J ( of) S 60 J ( a) S 60 J ( mass-storage) S 60 J ( device) S 60 J ( that) S 60 J ( caches) S 60 J ( data) S 60 J ( internally) S 60 J ( should) S 60 J ( set) S 60 J ( the) S 60 J ( entry) S 60 J ( points) S 
1680 7360 P (in) S 60 J ( the) S 60 J ( driver) S 60 J ( object) S 60 J ( for) S 60 J ( its) S 60 J ( DispatchShutdown) S 60 J ( and) S 60 J ( DispatchFlush) S 60 J ( routines) S 60 J ( when) S 60 J ( it) S 
1680 7620 P (initializes.) S 60 J ( If) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( \(or) S 60 J ( a) S 60 J ( driver) S 60 J ( layered) S 60 J ( above) S 60 J ( it\)) S 60 J ( buffers) S 60 J ( data) S 60 J ( in) S 60 J ( memory,) S 60 J ( it) S 60 J ( should) S 
1680 7880 P (also) S 60 J ( set) S 60 J ( DispatchShutdown) S 60 J ( and) S 60 J ( DispatchFlush) S 60 J ( entry) S 60 J ( points) S 60 J ( in) S 60 J ( the) S 60 J ( driver) S 60 J ( object) S 60 J ( when) S 60 J ( it) S 
1680 8140 P (initializes.) S 
1680 8460 P (NT) S 60 J ( drivers) S 60 J ( for) S 60 J ( mass-storage) S 60 J ( devices) S 60 J ( and) S 60 J ( drivers) S 60 J ( layered) S 60 J ( over) S 60 J ( them) S 60 J ( can) S 60 J ( rely) S 60 J ( on) S 60 J ( a) S 60 J ( highest-) S 
1680 8720 P (level) S 60 J ( file) S 60 J ( system) S 60 J ( driver) S 60 J ( to) S 60 J ( send) S 60 J ( shutdown) S 60 J ( notifications) S 60 J ( when) S 60 J ( the) S 60 J ( system) S 60 J ( is) S 60 J ( shut) S 60 J ( down.) S 
1680 8980 P (That) S 60 J ( is,) S 60 J ( the) S 60 J ( FSD) S 60 J ( is) S 60 J ( responsible) S 60 J ( for) S 60 J ( making) S 60 J ( sure) S 60 J ( that) S 60 J ( any) S 60 J ( cached) S 60 J ( file) S 60 J ( data) S 60 J ( is) S 60 J ( written) S 60 J ( out) S 60 J ( to) S 
1680 9240 P (peripheral) S 60 J ( devices,) S 60 J ( calling) S 60 J ( underlying) S 60 J ( drivers) S 60 J ( to) S 60 J ( flush) S 60 J ( data) S 60 J ( from) S 60 J ( their) S 60 J ( device) S 60 J ( caches) S 60 J ( or) S 
1680 9500 P (buffers) S 60 J ( \(if) S 60 J ( any\),) S 60 J ( and) S 60 J ( so) S 60 J ( forth) S 60 J ( before) S 60 J ( the) S 60 J ( system) S 60 J ( is) S 60 J ( shut) S 60 J ( down.) S 
1680 9820 P (If) S 60 J ( the) S 60 J ( underlying) S 60 J ( device) S 60 J ( is) S 60 J ( not) S 60 J ( a) S 60 J ( mass-storage) S 60 J ( device,) S 60 J ( a) S 60 J ( driver) S 60 J ( can) S 60 J ( set) S 60 J ( a) S 
1680 10080 P (DispatchShutdown) S 60 J ( entry) S 60 J ( point) S 60 J ( in) S 60 J ( the) S 60 J ( driver) S 60 J ( object) S 60 J ( when) S 60 J ( it) S 60 J ( initializes) S 60 J ( at) S 60 J ( the) S 60 J ( discretion) S 60 J ( of) S 
1680 10340 P (the) S 60 J ( driver) S 60 J ( designer.) S 60 J ( For) S 60 J ( such) S 60 J ( a) S 60 J ( driver,) S 60 J ( the) S 60 J ( DriverEntry) S 60 J ( routine) S 60 J ( must) S 60 J ( call) S 
1680 10600 P 0 12 F 24 12 F B (IoRegisterShutdownNotification) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( device) S 60 J ( object) S 60 J ( for) S 60 J ( which) S 60 J ( its) S 
1680 10860 P (DispatchShutdown) S 60 J ( routine) S 60 J ( will) S 60 J ( do) S 60 J ( whatever) S 60 J ( driver-determined) S 60 J ( cleanup) S 60 J ( is) S 60 J ( necessary) S 
1680 11120 P (before) S 60 J ( the) S 60 J ( system) S 60 J ( is) S 60 J ( shut) S 60 J ( down.) S 60 J ( For) S 60 J ( example,) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( sound) S 60 J ( driver) S 60 J ( has) S 60 J ( a) S 
1680 11380 P (DispatchShutdown) S 60 J ( routine) S 60 J ( that) S 60 J ( saves) S 60 J ( the) S 60 J ( current) S 60 J ( volume) S 60 J ( setting) S 60 J ( of) S 60 J ( its) S 60 J ( wave-in) S 60 J ( device) S 
1680 11640 P (object) S 60 J ( in) S 60 J ( the) S 60 J ( configuration) S 60 J ( registry) S 60 J ( when) S 60 J ( the) S 60 J ( system) S 60 J ( is) S 60 J ( shut) S 60 J ( down.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 916 J ( 6-) S E B (3) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (The) S 60 J ( required) S 60 J ( functionality) S 60 J ( of) S 60 J ( a) S 60 J ( particular) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( varies,) S 60 J ( depending) S 60 J ( on) S 60 J ( the) S 
1920 2320 P (IRP_MJ_) S 0 12 F 24 12 F I (xxx) S E 0 12 F 24 12 F () S 60 J ( it) S 60 J ( handles,) S 60 J ( on) S 60 J ( the) S 60 J ( individual) S 60 J ( driver's) S 60 J ( level) S 60 J ( in) S 60 J ( a) S 60 J ( chain) S 60 J ( of) S 60 J ( layered) S 60 J ( drivers,) S 60 J ( and) S 60 J ( on) S 
1920 2580 P (the) S 60 J ( type) S 60 J ( of) S 60 J ( underlying) S 60 J ( physical) S 60 J ( device.) S 60 J ( The) S 60 J ( set) S 60 J ( of) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( entry) S 60 J ( points) S 60 J ( a) S 60 J ( given) S 60 J ( driver) S 
1920 2840 P (must) S 60 J ( supply) S 60 J ( also) S 60 J ( varies) S 60 J ( according) S 60 J ( to) S 60 J ( the) S 60 J ( type) S 60 J ( and) S 60 J ( functionality) S 60 J ( of) S 60 J ( the) S 60 J ( underlying) S 60 J ( physical) S 
1920 3100 P (device.) S 60 J ( For) S 60 J ( device-type-specific) S 60 J ( information) S 60 J ( about) S 60 J ( IRP) S 60 J ( function) S 60 J ( codes) S 60 J ( that) S 60 J ( NT) S 60 J ( drivers) S 60 J ( must) S 
1920 3360 P (handle,) S 60 J ( see) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F I (Kernel-mode) S 60 J ( Driver) S 60 J ( Reference) S E 0 12 F 24 12 F (.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( video) S 60 J ( miniport) S 
1920 3620 P (and) S 60 J ( SCSI) S 60 J ( drivers,) S 60 J ( see) S 60 J ( also) S 60 J ( Appendixes) S 60 J ( A) S 60 J ( and) S 60 J ( B,) S 60 J ( respectively.) S 
1920 4000 P (Processing) S 60 J ( any) S 60 J ( IRP) S 60 J ( begins) S 60 J ( in) S 60 J ( the) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( that) S 60 J ( the) S 60 J ( DriverEntry) S 60 J ( routine) S 60 J ( set) S 60 J ( up) S 60 J ( for) S 60 J ( the) S 
1920 4260 P (given) S 60 J ( IRP_MJ_) S 0 12 F 24 12 F I (xxx) S E 0 12 F 24 12 F (.) S 60 J ( A) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( is) S 60 J ( run) S 60 J ( in) S 60 J ( an) S 60 J ( arbitrary) S 60 J ( thread) S 60 J ( context) S 60 J ( at) S 
1920 4520 P (PASSIVE_LEVEL) S 60 J ( IRQL.) S 
1920 4900 P (The) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( must) S 60 J ( first) S 60 J ( check) S 60 J ( what) S 60 J ( to) S 60 J ( do) S 60 J ( if) S 60 J ( any) S 60 J ( of) S 60 J ( the) S 60 J ( following) S 60 J ( conditions) S 60 J ( hold:) S 
1920 5220 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( It) S 60 J ( handles) S 60 J ( more) S 60 J ( than) S 60 J ( one) S 60 J ( major) S 60 J ( function) S 60 J ( code.) S 
1920 5540 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( It) S 60 J ( must) S 60 J ( handle) S 60 J ( a) S 60 J ( set) S 60 J ( of) S 60 J ( minor) S 60 J ( function) S 60 J ( codes) S 60 J ( for) S 60 J ( certain) S 60 J ( major) S 60 J ( function) S 60 J ( codes) S 
2400 5800 P (\(IRP_MN_) S 0 12 F 24 12 F I (xxx) S E 0 12 F 24 12 F (,) S 60 J ( as) S 60 J ( the) S 60 J ( NT-supplied) S 60 J ( SCSI) S 60 J ( port) S 60 J ( driver) S 60 J ( and) S 60 J ( NT) S 60 J ( file) S 60 J ( system) S 60 J ( drivers) S 60 J ( do\).) S 
1920 6120 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( It) S 60 J ( handles) S 60 J ( IRP_MJ_DEVICE_CONTROL) S 60 J ( or) S 
2400 6380 P (IRP_MJ_INTERNAL_DEVICE_CONTROL) S 60 J ( requests,) S 60 J ( which) S 60 J ( have) S 60 J ( a) S 60 J ( set) S 60 J ( of) S 60 J ( device-type-) S 
2400 6640 P (specific) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes.) S 
1920 7020 P (To) S 60 J ( determine) S 60 J ( which) S 60 J ( operation) S 60 J ( is) S 60 J ( requested) S 60 J ( and) S 60 J ( what) S 60 J ( arguments) S 60 J ( \(if) S 60 J ( any\)) S 60 J ( it) S 60 J ( must) S 60 J ( use,) S 60 J ( the) S 
1920 7280 P (Dispatch) S 60 J ( routine) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoGetCurrentIrpStackLocation) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( get) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( its) S 60 J ( own) S 60 J ( I/O) S 60 J ( stack) S 
1920 7540 P (location) S 60 J ( in) S 60 J ( the) S 60 J ( input) S 60 J ( IRP.) S 60 J ( Higher-level) S 60 J ( drivers') S 60 J ( Dispatch) S 60 J ( routines) S 60 J ( also) S 60 J ( call) S 
1920 7800 P 0 12 F 24 12 F B (IoGetNextIrpStackLocation) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( get) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( next-lower) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( in) S 
1920 8060 P (the) S 60 J ( IRP,) S 60 J ( which) S 60 J ( they) S 60 J ( set) S 60 J ( up) S 60 J ( for) S 60 J ( the) S 60 J ( next-lower) S 60 J ( driver) S 60 J ( as) S 60 J ( explained) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 4.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (4) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (Depending) S 60 J ( on) S 60 J ( the) S 60 J ( nature) S 60 J ( of) S 60 J ( the) S 60 J ( request,) S 60 J ( the) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( then) S 60 J ( does) S 60 J ( one) S 60 J ( of) S 60 J ( the) S 60 J ( following:) S 
1200 2380 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( requested) S 60 J ( operation) S 60 J ( can) S 60 J ( be) S 60 J ( completed) S 60 J ( immediately,) S 60 J ( the) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( sets) S 60 J ( the) S 
1680 2640 P 0 12 F 24 12 F B (Status) S E 0 12 F 24 12 F () S 60 J ( and) S 60 J ( ) S 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( fields) S 60 J ( in) S 60 J ( the) S 60 J ( IRP's) S 60 J ( I/O) S 60 J ( status) S 60 J ( block.) S 60 J ( Then,) S 60 J ( the) S 60 J ( Dispatch) S 60 J ( routine) S 
1680 2900 P (calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( IRP,) S 60 J ( and) S 60 J ( returns) S 60 J ( the) S 60 J ( appropriate) S 60 J ( value) S 60 J ( for) S 
1680 3160 P (NTSTATUS.) S 
1200 3480 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( requested) S 60 J ( operation) S 60 J ( requires) S 60 J ( further) S 60 J ( processing,) S 60 J ( the) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( usually) S 60 J ( checks) S 
1680 3740 P (the) S 60 J ( validity) S 60 J ( of) S 60 J ( any) S 60 J ( parameters) S 60 J ( passed) S 60 J ( in) S 60 J ( the) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( of) S 60 J ( the) S 60 J ( IRP.) S 
1680 4000 P (Generally,) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( \(if) S 60 J ( any\)) S 60 J ( has) S 60 J ( already) S 60 J ( checked) S 60 J ( the) S 60 J ( parameters) S 60 J ( for) S 60 J ( a) S 
1680 4260 P (requested) S 60 J ( operation,) S 60 J ( but) S 60 J ( lower-level) S 60 J ( drivers) S 60 J ( can) S 60 J ( perform) S 60 J ( their) S 60 J ( own) S 60 J ( "sanity) S 60 J ( checks") S 60 J ( on) S 
1680 4520 P (parameters) S 60 J ( as) S 60 J ( well.) S 60 J ( If) S 60 J ( a) S 60 J ( driver) S 60 J ( discovers) S 60 J ( an) S 60 J ( invalid) S 60 J ( parameter,) S 60 J ( its) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( sets) S 60 J ( an) S 
1680 4780 P (appropriate) S 60 J ( error) S 60 J ( value) S 60 J ( in) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Status) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( of) S 60 J ( the) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( \(and) S 60 J ( resets) S 60 J ( the) S 
1680 5040 P 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( to) S 60 J ( zero\)) S 60 J ( and) S 60 J ( completes) S 60 J ( the) S 60 J ( IRP) S 60 J ( immediately) S 60 J ( as) S 60 J ( described) S 60 J ( in) S 60 J ( the) S 
1680 5300 P (preceding) S 60 J ( paragraph,) S 60 J ( returning) S 60 J ( an) S 60 J ( appropriate) S 60 J ( error) S 60 J ( value) S 60 J ( for) S 60 J ( NTSTATUS.) S 
1200 5620 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( all) S 60 J ( parameters) S 60 J ( are) S 60 J ( valid) S 60 J ( for) S 60 J ( the) S 60 J ( given) S 60 J ( request,) S 60 J ( a) S 60 J ( lowest-level) S 60 J ( driver's) S 60 J ( Dispatch) S 60 J ( routine) S 
1680 5880 P (calls) S 60 J ( ) S 0 12 F 24 12 F B (IoMarkIrpPending) S E 0 12 F 24 12 F () S 60 J ( and) S 60 J ( queues) S 60 J ( the) S 60 J ( IRP) S 60 J ( for) S 60 J ( further) S 60 J ( processing) S 60 J ( by) S 60 J ( calling) S 
1680 6140 P 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F (,) S 60 J ( unless) S 60 J ( the) S 60 J ( driver) S 60 J ( manages) S 60 J ( its) S 60 J ( own) S 60 J ( internal) S 60 J ( IRP) S 60 J ( queueing.) S 60 J ( \(See) S 60 J ( Chapter) S 60 J ( 7) S 
1680 6400 P (for) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( driver-managed) S 60 J ( queues.\)) S 60 J ( If) S 60 J ( the) S 60 J ( driver) S 60 J ( does) S 60 J ( not) S 60 J ( have) S 60 J ( a) S 60 J ( StartIo) S 
1680 6660 P (routine) S 60 J ( but) S 60 J ( handles) S 60 J ( cancelable) S 60 J ( IRPs,) S 60 J ( it) S 60 J ( must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoAcquireCancelSpinLock) S E 0 12 F 24 12 F (,) S 
1680 6920 P 0 12 F 24 12 F B (IoSetCancelRoutine) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( entry) S 60 J ( point) S 60 J ( for) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( and) S 60 J ( the) S 60 J ( IRP,) S 60 J ( and) S 
1680 7180 P 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( before) S 60 J ( queueing) S 60 J ( the) S 60 J ( IRP) S 60 J ( for) S 60 J ( further) S 60 J ( processing.) S 60 J ( \(See) S 60 J ( Chapter) S 
1680 7440 P (12) S 60 J ( for) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( Cancel) S 60 J ( routines.\)) S 60 J ( Then,) S 60 J ( the) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( returns) S 
1680 7700 P (STATUS_PENDING.) S 
1200 8020 P () S 224 J ( ) S 256 J ( If) S 60 J ( the) S 60 J ( IRP) S 60 J ( contains) S 60 J ( the) S 60 J ( function) S 60 J ( code) S 60 J ( IRP_MJ_CLEANUP,) S 60 J ( the) S 60 J ( DispatchCleanup) S 60 J ( routine) S 
1680 8280 P (is) S 60 J ( responsible) S 60 J ( for) S 60 J ( resetting) S 60 J ( the) S 60 J ( entry) S 60 J ( point) S 60 J ( for) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( \(to) S 60 J ( NULL\)) S 60 J ( in) S 60 J ( and) S 60 J ( for) S 
1680 8540 P (cancelling) S 60 J ( all) S 60 J ( IRPs) S 60 J ( currently) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( for) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object.) S 60 J ( \(A) S 60 J ( cleanup) S 
1680 8800 P (request) S 60 J ( indicates) S 60 J ( that) S 60 J ( an) S 60 J ( application) S 60 J ( is) S 60 J ( being) S 60 J ( terminated) S 60 J ( or) S 60 J ( has) S 60 J ( closed) S 60 J ( a) S 60 J ( file) S 60 J ( handle) S 60 J ( for) S 60 J ( the) S 
1680 9060 P (file) S 60 J ( object) S 60 J ( that) S 60 J ( represents) S 60 J ( the) S 60 J ( driver's) S 60 J ( device) S 60 J ( object.) S 60 J ( When) S 60 J ( the) S 60 J ( DispatchCleanup) S 60 J ( routine) S 
1680 9320 P (returns,) S 60 J ( usually) S 60 J ( the) S 60 J ( driver's) S 60 J ( DispatchClose) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( next.\)) S 
1200 9640 P () S 224 J ( ) S 256 J ( For) S 60 J ( most) S 60 J ( requests,) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver's) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( sets) S 60 J ( up) S 60 J ( the) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 
1680 9900 P (for) S 60 J ( the) S 60 J ( next-lower) S 60 J ( driver,) S 60 J ( whether) S 60 J ( in) S 60 J ( the) S 60 J ( current) S 60 J ( IRP) S 60 J ( or) S 60 J ( by) S 60 J ( creating) S 60 J ( one) S 60 J ( or) S 60 J ( more) S 
1680 10160 P (additional) S 60 J ( IRPs,) S 60 J ( possibly) S 60 J ( for) S 60 J ( an) S 60 J ( additional) S 60 J ( set) S 60 J ( of) S 60 J ( lower) S 60 J ( drivers,) S 60 J ( as) S 60 J ( already) S 60 J ( described) S 60 J ( in) S 
1680 10420 P (Chapter) S 60 J ( 4.) S 60 J ( When) S 60 J ( the) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( has) S 60 J ( set) S 60 J ( up) S 60 J ( the) S 60 J ( next-lower) S 60 J ( driver's) S 60 J ( \(or) S 60 J ( drivers'\)) S 60 J ( I/O) S 
1680 10680 P (stack) S 60 J ( location\(s\),) S 60 J ( it) S 60 J ( sets) S 60 J ( its) S 60 J ( own) S 60 J ( IoCompletion) S 60 J ( routine) S 60 J ( in) S 60 J ( the) S 60 J ( IRP\(s\)) S 60 J ( by) S 60 J ( calling) S 
1680 10940 P 0 12 F 24 12 F B (IoSetCompletionRoutine) S E 0 12 F 24 12 F () S 60 J ( if) S 60 J ( the) S 60 J ( driver) S 60 J ( created) S 60 J ( an) S 60 J ( IRP,) S 60 J ( which) S 60 J ( the) S 60 J ( IoCompletion) S 60 J ( routine) S 
1680 11200 P (must) S 60 J ( free,) S 60 J ( or) S 60 J ( if) S 60 J ( the) S 60 J ( driver) S 60 J ( needs) S 60 J ( to) S 60 J ( check) S 60 J ( on) S 60 J ( how) S 60 J ( lower) S 60 J ( drivers) S 60 J ( complete) S 60 J ( the) S 60 J ( IRP.) S 60 J ( Then,) S 
1680 11460 P (the) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( pass) S 60 J ( the) S 60 J ( IRP\(s\)) S 60 J ( on) S 60 J ( to) S 60 J ( the) S 60 J ( next-lower) S 60 J ( driver\(s\)) S 
1680 11720 P (and,) S 60 J ( ultimately,) S 60 J ( to) S 60 J ( the) S 60 J ( underlying) S 60 J ( physical) S 60 J ( device\(s\).) S 60 J ( The) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( returns) S 
1680 11980 P (NTSTATUS) S 60 J ( \(frequently,) S 60 J ( the) S 60 J ( result) S 60 J ( of) S 60 J ( the) S 60 J ( call) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F (\).) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 916 J ( 6-) S E B (5) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( an) S 60 J ( NT) S 60 J ( intermediate) S 60 J ( driver) S 60 J ( ) S 0 12 F 24 12 F I (cannot) S E 0 12 F 24 12 F () S 60 J ( create) S 60 J ( IRPs) S 60 J ( for) S 60 J ( lower-level) S 60 J ( drivers) S 60 J ( by) S 60 J ( calling) S 
1920 2320 P 0 12 F 24 12 F B (IoMakeAssociatedIrp) S E 0 12 F 24 12 F (.) S 60 J ( If) S 60 J ( an) S 60 J ( intermediate) S 60 J ( driver) S 60 J ( needs) S 60 J ( to) S 60 J ( create) S 60 J ( IRPs) S 60 J ( for) S 60 J ( lower) S 60 J ( drivers,) S 60 J ( it) S 
1920 2580 P (should) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoAllocateIrp) S E 0 12 F 24 12 F (,) S 60 J ( ) S 0 12 F 24 12 F B (IoBuildDeviceIoControlRequest) S E 0 12 F 24 12 F (,) S 
1920 2840 P 0 12 F 24 12 F B (IoBuildSynchronousFsdRequest) S E 0 12 F 24 12 F (,) S 60 J ( or) S 60 J ( ) S 0 12 F 24 12 F B (IoBuildAsynchronousFsdRequest) S E 0 12 F 24 12 F (.) S 
1920 3100 P 0 12 F 24 12 F B (IoBuildSynchronousFsdRequest) S E 0 12 F 24 12 F () S 60 J ( can) S 60 J ( be) S 60 J ( called) S 60 J ( only) S 60 J ( in) S 60 J ( the) S 60 J ( following) S 60 J ( circumstances:) S 
1920 3420 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( By) S 60 J ( a) S 60 J ( driver-created) S 60 J ( thread) S 60 J ( to) S 60 J ( build) S 60 J ( IRPs) S 60 J ( for) S 60 J ( read) S 60 J ( or) S 60 J ( write) S 60 J ( requests) S 
1920 3740 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( In) S 60 J ( the) S 60 J ( system) S 60 J ( thread) S 60 J ( context) S 60 J ( during) S 60 J ( initialization) S 
1920 4060 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( To) S 60 J ( build) S 60 J ( IRPs) S 60 J ( for) S 60 J ( inherently) S 60 J ( synchronous) S 60 J ( operations,) S 60 J ( such) S 60 J ( as) S 60 J ( create,) S 60 J ( device) S 60 J ( control,) S 
2400 4320 P (flush,) S 60 J ( shutdown,) S 60 J ( and) S 60 J ( close) S 60 J ( requests) S 
1920 4700 P (Note) S 60 J ( that) S 60 J ( transfer) S 60 J ( \(read/write\)) S 60 J ( requests) S 60 J ( must) S 60 J ( be) S 60 J ( handled) S 60 J ( asynchronously) S 60 J ( and) S 60 J ( that) S 60 J ( large) S 60 J ( transfer) S 
1920 4960 P (requests) S 60 J ( can) S 60 J ( require) S 60 J ( a) S 60 J ( driver) S 60 J ( to) S 60 J ( split) S 60 J ( the) S 60 J ( data) S 60 J ( into) S 60 J ( more) S 60 J ( than) S 60 J ( one) S 60 J ( partial) S 60 J ( transfer) S 60 J ( before) S 
1920 5220 P (completing) S 60 J ( a) S 60 J ( read/write) S 60 J ( IRP.) S 60 J ( For) S 60 J ( example,) S 60 J ( an) S 60 J ( NT) S 60 J ( SCSI) S 60 J ( class) S 60 J ( driver's) S 60 J ( DispatchReadWrite) S 
1920 5480 P (routine) S 60 J ( is) S 60 J ( responsible) S 60 J ( for) S 60 J ( splitting) S 60 J ( large) S 60 J ( transfer) S 60 J ( requests,) S 60 J ( if) S 60 J ( necessary,) S 60 J ( into) S 60 J ( smaller) S 60 J ( requests) S 
1920 5740 P (that) S 60 J ( the) S 60 J ( NT) S 60 J ( SCSI) S 60 J ( port) S 60 J ( driver) S 60 J ( \(and) S 60 J ( HBA-specific) S 60 J ( miniport) S 60 J ( driver\)) S 60 J ( can) S 60 J ( handle) S 60 J ( in) S 60 J ( a) S 60 J ( single) S 60 J ( DMA) S 
1920 6000 P (operation.) S 60 J ( Other) S 60 J ( device) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( DMA) S 60 J ( or) S 60 J ( PIO) S 60 J ( also) S 60 J ( might) S 60 J ( need) S 60 J ( to) S 60 J ( split) S 60 J ( up) S 60 J ( large) S 60 J ( transfer) S 
1920 6260 P (requests.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( using) S 60 J ( DMA,) S 60 J ( see) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( adapter) S 60 J ( objects) S 60 J ( in) S 
1920 6520 P (Chapter) S 60 J ( 3.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( SCSI) S 60 J ( class) S 60 J ( driver) S 60 J ( requirements,) S 60 J ( see) S 60 J ( also) S 60 J ( Appendix) S 60 J ( B.) S 
1920 7320 P 0 12 F 8 14 F B (6.2) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Implementing) S 78 J ( DispatchCreate) S 78 J ( and) S 78 J ( DispatchClose) S 78 J ( Routines) S E 
1920 7940 P 0 12 F 24 12 F (As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 4,) S 60 J ( an) S 60 J ( NT) S 60 J ( driver's) S 60 J ( Dispatch) S 60 J ( routine\(s\)) S 60 J ( for) S 60 J ( IRP_MJ_CREATE) S 60 J ( and) S 
1920 8200 P (IRP_MJ_CLOSE) S 60 J ( requests) S 60 J ( might) S 60 J ( do) S 60 J ( nothing) S 60 J ( more) S 60 J ( than) S 60 J ( complete) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( with) S 
1920 8460 P (STATUS_SUCCESS.) S 60 J ( A) S 60 J ( create) S 60 J ( request) S 60 J ( can) S 60 J ( originate) S 60 J ( either) S 60 J ( in) S 60 J ( a) S 60 J ( user-mode) S 60 J ( subsystem's) S 
1920 8720 P (attempt) S 60 J ( to) S 60 J ( get) S 60 J ( a) S 60 J ( handle) S 60 J ( for) S 60 J ( the) S 60 J ( file) S 60 J ( object) S 60 J ( representing) S 60 J ( the) S 60 J ( device) S 60 J ( \(possibly) S 60 J ( on) S 60 J ( behalf) S 60 J ( of) S 60 J ( an) S 
1920 8980 P (application\)) S 60 J ( or) S 60 J ( in) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver's) S 60 J ( call) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (IoGetDeviceObjectPointer) S E 0 12 F 24 12 F () S 60 J ( or) S 
1920 9240 P 0 12 F 24 12 F B (IoAttachDevice) S E 0 12 F 24 12 F (.) S 60 J ( The) S 60 J ( reciprocal) S 60 J ( close) S 60 J ( request) S 60 J ( can) S 60 J ( originate) S 60 J ( in) S 60 J ( a) S 60 J ( user-mode) S 60 J ( subsystem's) S 
1920 9500 P (release) S 60 J ( of) S 60 J ( the) S 60 J ( file) S 60 J ( object) S 60 J ( handle) S 60 J ( for) S 60 J ( the) S 60 J ( device) S 60 J ( or) S 60 J ( in) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver's) S 60 J ( call) S 60 J ( to) S 
1920 9760 P 0 12 F 24 12 F B (IoDetachDevice) S E 0 12 F 24 12 F (.) S 
1920 10140 P (Another) S 60 J ( NT) S 60 J ( driver's) S 60 J ( Dispatch) S 60 J ( routine\(s\)) S 60 J ( for) S 60 J ( IRP_MJ_CREATE) S 60 J ( and) S 60 J ( IRP_MJ_CLOSE) S 60 J ( requests) S 
1920 10400 P (might) S 60 J ( do) S 60 J ( more) S 60 J ( work,) S 60 J ( depending) S 60 J ( on) S 60 J ( the) S 60 J ( underlying) S 60 J ( device) S 60 J ( driver) S 60 J ( or) S 60 J ( on) S 60 J ( the) S 60 J ( underlying) S 60 J ( device.) S 
1920 10660 P (For) S 60 J ( example,) S 60 J ( the) S 60 J ( class) S 60 J ( driver) S 60 J ( of) S 60 J ( a) S 60 J ( class/port) S 60 J ( driver) S 60 J ( pair) S 60 J ( might) S 60 J ( initialize) S 60 J ( an) S 60 J ( internal) S 60 J ( queue) S 60 J ( and) S 
1920 10920 P (send) S 60 J ( an) S 60 J ( IRP_MJ_INTERNAL_DEVICE_CONTROL) S 60 J ( request) S 60 J ( to) S 60 J ( its) S 60 J ( port) S 60 J ( driver) S 60 J ( on) S 60 J ( receipt) S 60 J ( of) S 60 J ( a) S 
1920 11180 P (create) S 60 J ( request,) S 60 J ( while) S 60 J ( a) S 60 J ( highest-level) S 60 J ( device) S 60 J ( driver) S 60 J ( might) S 60 J ( need) S 60 J ( to) S 60 J ( delay) S 60 J ( until) S 60 J ( the) S 60 J ( processing) S 60 J ( of) S 
1920 11440 P (its) S 60 J ( outstanding) S 60 J ( requests) S 60 J ( was) S 60 J ( complete) S 60 J ( on) S 60 J ( receipt) S 60 J ( of) S 60 J ( a) S 60 J ( close) S 60 J ( request.) S 
1920 11820 P (Although) S 60 J ( most) S 60 J ( NT) S 60 J ( drivers) S 60 J ( have) S 60 J ( a) S 60 J ( single) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( for) S 60 J ( create/close) S 60 J ( requests,) S 60 J ( a) S 60 J ( driver) S 
1920 12080 P (designer) S 60 J ( can) S 60 J ( implement) S 60 J ( separate) S 60 J ( DispatchCreate) S 60 J ( and) S 60 J ( DispatchClose) S 60 J ( routines) S 60 J ( if) S 60 J ( the) S 60 J ( driver's) S 
1920 12340 P (response) S 60 J ( to) S 60 J ( each) S 60 J ( of) S 60 J ( these) S 60 J ( requests) S 60 J ( must) S 60 J ( be) S 60 J ( quite) S 60 J ( different.) S 60 J ( Some) S 60 J ( NT) S 60 J ( drivers) S 60 J ( handle) S 
1920 12600 P (IRP_MJ_CLOSE) S 60 J ( requests) S 60 J ( only) S 60 J ( for) S 60 J ( symmetry,) S 60 J ( because) S 60 J ( after) S 60 J ( their) S 60 J ( device) S 60 J ( objects) S 60 J ( have) S 60 J ( been) S 
1920 12860 P (opened) S 60 J ( by) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver,) S 60 J ( the) S 60 J ( lower-level) S 60 J ( drivers') S 60 J ( device) S 60 J ( objects) S 60 J ( are) S 60 J ( not) S 60 J ( closed) S 60 J ( until) S 60 J ( the) S 
1920 13120 P (system) S 60 J ( itself) S 60 J ( is) S 60 J ( shut) S 60 J ( down.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (6) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (The) S 60 J ( following) S 60 J ( subsections) S 60 J ( describe) S 60 J ( how) S 60 J ( a) S 60 J ( representative) S 60 J ( set) S 60 J ( of) S 60 J ( NT) S 60 J ( drivers) S 60 J ( might) S 60 J ( implement) S 
1200 2320 P (DispatchCreateClose) S 60 J ( routines) S 60 J ( as) S 60 J ( a) S 60 J ( guide) S 60 J ( to) S 60 J ( implementing) S 60 J ( this) S 60 J ( routine) S 60 J ( in) S 60 J ( new) S 60 J ( drivers.) S 60 J ( Section) S 
1200 2580 P (6.2.3) S 60 J ( summarizes) S 60 J ( points) S 60 J ( to) S 60 J ( consider) S 60 J ( in) S 60 J ( implementing) S 60 J ( a) S 60 J ( new) S 60 J ( DispatchCreateClose) S 60 J ( routine.) S 
1200 3220 P 0 12 F 8 12 F B (6.2.1) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( Basic) S 67 J ( DispatchCreateClose) S 67 J ( Routines) S E 
1200 3840 P 0 12 F 24 12 F (Many) S 60 J ( NT) S 60 J ( drivers) S 60 J ( merely) S 60 J ( need) S 60 J ( to) S 60 J ( establish) S 60 J ( their) S 60 J ( existence) S 60 J ( on) S 60 J ( receipt) S 60 J ( of) S 60 J ( a) S 60 J ( create) S 60 J ( request) S 60 J ( and) S 
1200 4100 P (merely) S 60 J ( need) S 60 J ( to) S 60 J ( acknowledge) S 60 J ( the) S 60 J ( receipt) S 60 J ( of) S 60 J ( a) S 60 J ( close) S 60 J ( request,) S 60 J ( particularly) S 60 J ( lower-level) S 60 J ( drivers) S 60 J ( in) S 60 J ( a) S 
1200 4360 P (chain) S 60 J ( of) S 60 J ( layered) S 60 J ( NT) S 60 J ( drivers.) S 
1200 4740 P (For) S 60 J ( example,) S 60 J ( a) S 60 J ( port) S 60 J ( driver) S 60 J ( for) S 60 J ( the) S 60 J ( i8042) S 60 J ( keyboard) S 60 J ( and) S 60 J ( auxiliary) S 60 J ( device) S 60 J ( controller,) S 60 J ( described) S 60 J ( in) S 
1200 5000 P (Chapter) S 60 J ( 2,) S 60 J ( is) S 60 J ( such) S 60 J ( a) S 60 J ( driver.) S 60 J ( Its) S 60 J ( DispatchCreateClose) S 60 J ( routine) S 60 J ( need) S 60 J ( do) S 60 J ( nothing) S 60 J ( more) S 60 J ( than) S 
1200 5260 P (complete) S 60 J ( the) S 60 J ( IRP) S 60 J ( as) S 60 J ( follows:) S 
1680 5780 P 0 12 F 0 12 F () S 480 J ( :) S 336 J ( :) S 
1680 6040 P ({) S 
1680 6300 P () S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 
1680 6560 P () S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
1680 6820 P () S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_NO_INCREMENT\);) S 
1680 7080 P () S 480 J ( return\(STATUS_SUCCESS\);) S 
1680 7340 P (}) S 
1200 7720 P 0 12 F 24 12 F (Such) S 60 J ( a) S 60 J ( driver) S 60 J ( neither) S 60 J ( reads) S 60 J ( nor) S 60 J ( updates) S 60 J ( state) S 60 J ( in) S 60 J ( its) S 60 J ( device) S 60 J ( extension.) S 60 J ( Consequently,) S 60 J ( the) S 60 J ( pointer) S 
1200 7980 P (to) S 60 J ( its) S 60 J ( device) S 60 J ( object,) S 60 J ( which) S 60 J ( is) S 60 J ( input) S 60 J ( to) S 60 J ( every) S 60 J ( Dispatch) S 60 J ( routine,) S 60 J ( is) S 60 J ( not) S 60 J ( referenced) S 60 J ( by) S 60 J ( this) S 60 J ( driver's) S 
1200 8240 P (DispatchCreateClose) S 60 J ( routine.) S 60 J ( The) S 60 J ( DispatchCreateClose) S 60 J ( routine) S 60 J ( sets) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( of) S 
1200 8500 P (the) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( to) S 60 J ( zero) S 60 J ( because) S 60 J ( no) S 60 J ( data) S 60 J ( is) S 60 J ( transferred.) S 
1200 8880 P (Note) S 60 J ( that) S 60 J ( a) S 60 J ( create/close) S 60 J ( request) S 60 J ( is) S 60 J ( completed) S 60 J ( without) S 60 J ( boosting) S 60 J ( the) S 60 J ( priority) S 60 J ( of) S 60 J ( the) S 60 J ( original) S 60 J ( caller) S 
1200 9140 P (\(IO_NO_INCREMENT\)) S 60 J ( because) S 60 J ( the) S 60 J ( originator) S 60 J ( \(here,) S 60 J ( the) S 60 J ( keyboard) S 60 J ( or) S 60 J ( mouse) S 60 J ( class) S 60 J ( driver\)) S 60 J ( is) S 
1200 9400 P (assumed) S 60 J ( to) S 60 J ( wait) S 60 J ( for) S 60 J ( an) S 60 J ( indeterminate) S 60 J ( but) S 60 J ( very) S 60 J ( small) S 60 J ( interval) S 60 J ( on) S 60 J ( the) S 60 J ( completion) S 60 J ( of) S 60 J ( the) S 60 J ( request.) S 
1200 9780 P (Whether) S 60 J ( a) S 60 J ( DispatchCreateClose) S 60 J ( routine) S 60 J ( does) S 60 J ( more) S 60 J ( work) S 60 J ( depends) S 60 J ( on) S 60 J ( the) S 60 J ( nature) S 60 J ( of) S 60 J ( the) S 60 J ( device) S 
1200 10040 P (or) S 60 J ( on) S 60 J ( the) S 60 J ( design) S 60 J ( of) S 60 J ( the) S 60 J ( driver\(s\).) S 60 J ( However,) S 60 J ( every) S 60 J ( DispatchCreateClose) S 60 J ( routine) S 60 J ( must) S 60 J ( set) S 60 J ( the) S 
1200 10300 P 0 12 F 24 12 F B (Status) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( of) S 60 J ( the) S 60 J ( I/O) S 60 J ( status) S 60 J ( block,) S 60 J ( complete) S 60 J ( the) S 60 J ( IRP,) S 60 J ( and) S 60 J ( return) S 60 J ( NTSTATUS) S 60 J ( as) S 60 J ( the) S 60 J ( i8042) S 
1200 10560 P (port) S 60 J ( driver) S 60 J ( does.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 916 J ( 6-) S E B (7) S E B () S 720 J ( ) S E 
1920 2080 P 0 12 F 8 12 F B (6.2.2) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( Working) S 67 J ( DispatchCreateClose) S 67 J ( Routines) S E 
1920 2700 P 0 12 F 24 12 F (Other) S 60 J ( NT) S 60 J ( drivers) S 60 J ( can) S 60 J ( handle) S 60 J ( create) S 60 J ( and) S 60 J ( close) S 60 J ( requests) S 60 J ( separately) S 60 J ( when) S 60 J ( the) S 60 J ( driver) S 60 J ( must) S 
1920 2960 P (perform) S 60 J ( different) S 60 J ( operations) S 60 J ( for) S 60 J ( each) S 60 J ( request.) S 
1920 3340 P (For) S 60 J ( example,) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver,) S 60 J ( which) S 60 J ( is) S 60 J ( layered) S 60 J ( over) S 60 J ( the) S 60 J ( port) S 60 J ( driver) S 
1920 3600 P (described) S 60 J ( in) S 60 J ( Section) S 60 J ( 6.2.1,) S 60 J ( has) S 60 J ( a) S 60 J ( DispatchCreateClose) S 60 J ( routine) S 60 J ( that) S 60 J ( handles) S 60 J ( these) S 60 J ( requests) S 60 J ( as) S 
1920 3860 P (follows:) S 
2400 4380 P 0 12 F 0 12 F ({) S 
2400 4640 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
2400 4900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
2400 5160 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
2400 5420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 144 J ( DeviceObject->DeviceExtension;) S 
2400 5680 P () S 480 J ( KIRQL) S 144 J ( oldIrql;) S 
2400 5940 P () S 480 J ( BOOLEAN) S 144 J ( enableFlag;) S 
2400 6200 P () S 480 J ( NTSTATUS) S 144 J ( status;) S 
2400 6460 P () S 480 J ( PIO_ERROR_LOG_PACKET) S 144 J ( errorLogEntry;) S 
2400 6720 P () S 480 J ( BOOLEAN) S 144 J ( SomeEnableDisableSucceeded) S 144 J ( =) S 144 J ( FALSE;) S 
2400 6980 P () S 480 J ( ULONG) S 144 J ( i;) S 
2400 7240 P (//) S 
2400 7500 P (//) S 144 J ( Case) S 144 J ( on) S 144 J ( the) S 144 J ( IRP) S 144 J ( major) S 144 J ( function) S 144 J ( code.) S 
2400 7760 P (//) S 
2400 8020 P () S 480 J ( switch) S 144 J ( \(irpSp->MajorFunction\)) S 144 J ( {) S 
2400 8280 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_CREATE:) S 
2400 8540 P (//) S 
2400 8800 P (//) S 144 J ( If) S 144 J ( the) S 144 J ( requestor) S 144 J ( is) S 144 J ( the) S 144 J ( trusted) S 144 J ( subsystem) S 144 J ( opening) S 144 J ( the) S 
2400 9060 P (//) S 144 J ( device,) S 144 J ( set) S 144 J ( associated) S 144 J ( file) S 144 J ( object's) S 144 J ( FsContext) S 
2400 9320 P (//) S 144 J ( to) S 144 J ( nonzero) S 144 J ( so) S 144 J ( KeyboardClassRead) S 144 J ( can) S 144 J ( use) S 144 J ( FsContext) S 
2400 9580 P (//) S 144 J ( to) S 144 J ( check) S 144 J ( whether) S 144 J ( a) S 144 J ( requestor) S 144 J ( has) S 144 J ( enough) S 144 J ( privilege) S 
2400 9840 P (//) S 144 J ( to) S 144 J ( read) S 144 J ( keyboard) S 144 J ( input.) S 144 J ( Then,) S 144 J ( reset) S 144 J ( the) S 144 J ( cleanup) S 144 J ( indicator) S 
2400 10100 P (//) S 144 J ( and) S 144 J ( set) S 144 J ( the) S 144 J ( enableFlag) S 144 J ( for) S 144 J ( the) S 144 J ( KEYBOARD_ENABLE) S 
2400 10360 P (//) S 144 J ( internal) S 144 J ( device) S 144 J ( control) S 144 J ( request) S 144 J ( to) S 144 J ( the) S 144 J ( port) S 144 J ( driver.) S 
2400 10620 P (//) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (8) S E B () S 1036 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( ) S 480 J ( if\(SeSinglePrivilegeCheck\() S 
1680 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( RtlConvertLongToLargeInteger\() S 
1680 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( SE_TCB_PRIVILEGE\),) S 
1680 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->RequestorMode\)\)) S 144 J ( {) S 
1680 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeAcquireSpinLock\() S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock,) S 
1680 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &oldIrql\);) S 
1680 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->CleanupWasInitiated) S 144 J ( =) S 144 J ( FALSE;) S 
1680 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->FileObject->FsContext) S 144 J ( =) S 144 J ( \(PVOID\)) S 144 J ( 1;) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeReleaseSpinLock\() S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->Spinlock,) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( oldIrql\);) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( enableFlag) S 144 J ( =) S 144 J ( TRUE;) S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
1680 5960 P (//) S 
1680 6220 P (//) S 144 J ( For) S 144 J ( the) S 144 J ( close) S 144 J ( operation,) S 144 J ( send) S 144 J ( a) S 144 J ( KEYBOARD_DISABLE) S 144 J ( internal) S 
1680 6480 P (//) S 144 J ( device) S 144 J ( control) S 144 J ( request) S 144 J ( to) S 144 J ( the) S 144 J ( port) S 144 J ( driver.) S 
1680 6740 P (//) S 
1680 7000 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_CLOSE:) S 
1680 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
1680 7520 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 7780 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( switch) S 
1680 8040 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 8300 P (//) S 
1680 8560 P (//) S 144 J ( Enable/disable) S 144 J ( interrupts) S 144 J ( via) S 144 J ( port) S 144 J ( driver.) S 
1680 8820 P (//) S 
1680 9080 P () S 480 J ( for) S 144 J ( \(i) S 144 J ( =) S 144 J ( 0;) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( i) S 144 J ( <) S 144 J ( deviceExtension->MaxPortsServiced;) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( i++\)) S 144 J ( {) S 
1680 9860 P () S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( KbdEnableDisablePort\() S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject,) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( enableFlag) S 
1680 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( i\);) S 
1680 10900 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(status) S 144 J ( !=) S 144 J ( STATUS_SUCCESS\)) S 144 J ( {) S 
1680 11160 P (//) S 
1680 11420 P (//) S 144 J ( Log) S 144 J ( an) S 144 J ( error.) S 
1680 11680 P (//) S 
1680 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 12200 P () S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 12460 P () S 480 J ( ) S 480 J ( ) S 480 J ( SomeEnableDisableSucceeded) S 144 J ( =) S 144 J ( TRUE;) S 
1680 12720 P () S 480 J ( ) S 480 J ( }) S 
1680 12980 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( for) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 916 J ( 6-) S E B (9) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Complete) S 144 J ( the) S 144 J ( request) S 144 J ( and) S 144 J ( return) S 144 J ( status.) S 
2400 2580 P (//) S 
2400 2840 P () S 480 J ( if\(SomeEnableDisableSucceeded\)) S 144 J ( {) S 
2400 3100 P () S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 
2400 3360 P () S 480 J ( }) S 
2400 3620 P () S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( status;) S 
2400 3880 P () S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
2400 4140 P () S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_NO_INCREMENT\);) S 
2400 4400 P () S 480 J ( return\(status\);) S 
2400 4660 P (}) S 
1920 5040 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( logs) S 60 J ( an) S 60 J ( error) S 60 J ( if) S 60 J ( the) S 60 J ( underlying) S 60 J ( device) S 60 J ( driver) S 60 J ( does) S 60 J ( not) S 
1920 5300 P (respond) S 60 J ( as) S 60 J ( expected) S 60 J ( to) S 60 J ( the) S 60 J ( KbdEnableDisablePort) S 60 J ( routine,) S 60 J ( which) S 60 J ( sets) S 60 J ( up) S 60 J ( an) S 60 J ( IRP) S 60 J ( for) S 60 J ( an) S 
1920 5560 P (internal) S 60 J ( device) S 60 J ( control) S 60 J ( request) S 60 J ( and) S 60 J ( calls) S 60 J ( the) S 60 J ( port) S 60 J ( driver.) S 60 J ( The) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( logs) S 60 J ( such) S 60 J ( an) S 
1920 5820 P (error) S 60 J ( because) S 60 J ( the) S 60 J ( user) S 60 J ( is) S 60 J ( likely) S 60 J ( to) S 60 J ( reboot) S 60 J ( the) S 60 J ( system) S 60 J ( if) S 60 J ( the) S 60 J ( keyboard) S 60 J ( device) S 60 J ( is) S 60 J ( unresponsive) S 60 J ( \(or) S 
1920 6080 P (if) S 60 J ( it) S 60 J ( generates) S 60 J ( random) S 60 J ( interrupts\).) S 60 J ( If) S 60 J ( necessary,) S 60 J ( the) S 60 J ( user) S 60 J ( or) S 60 J ( a) S 60 J ( system) S 60 J ( administrator) S 60 J ( can) S 60 J ( log) S 60 J ( on) S 60 J ( to) S 
1920 6340 P (another) S 60 J ( machine,) S 60 J ( connect) S 60 J ( to) S 60 J ( the) S 60 J ( machine) S 60 J ( with) S 60 J ( the) S 60 J ( unresponsive) S 60 J ( keyboard,) S 60 J ( and) S 60 J ( examine) S 60 J ( its) S 
1920 6600 P (error) S 60 J ( log) S 60 J ( file) S 60 J ( to) S 60 J ( debug) S 60 J ( the) S 60 J ( configuration) S 60 J ( error) S 60 J ( that) S 60 J ( caused) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( to) S 60 J ( fail) S 60 J ( a) S 
1920 6860 P (create) S 60 J ( request.) S 
1920 7240 P (Note) S 60 J ( also) S 60 J ( that) S 60 J ( the) S 60 J ( IRP) S 60 J ( set) S 60 J ( up) S 60 J ( by) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 60 J ( KbdEnableDisablePort) S 60 J ( routine) S 60 J ( is) S 
1920 7500 P (sent) S 60 J ( to) S 60 J ( the) S 60 J ( port) S 60 J ( driver's) S 60 J ( DispatchInternalDeviceControl) S 60 J ( routine,) S 60 J ( not) S 60 J ( to) S 60 J ( the) S 
1920 7760 P (DispatchCreateClose) S 60 J ( routine) S 60 J ( described) S 60 J ( in) S 60 J ( Section) S 60 J ( 6.2.1.) S 
1920 8140 P (Only) S 60 J ( the) S 60 J ( Win32) S 60 J ( subsystem's) S 60 J ( user) S 60 J ( input) S 60 J ( thread) S 60 J ( is) S 60 J ( allowed) S 60 J ( to) S 60 J ( make) S 60 J ( read) S 60 J ( requests) S 60 J ( for) S 60 J ( keyboard) S 
1920 8400 P (input) S 60 J ( data,) S 60 J ( so) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( checks) S 60 J ( whether) S 60 J ( the) S 60 J ( subsystem) S 60 J ( has) S 60 J ( opened) S 60 J ( the) S 60 J ( device.) S 
1920 8660 P (Only) S 60 J ( IRP_MJ_READ) S 60 J ( requests) S 60 J ( are) S 60 J ( queued) S 60 J ( to) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 60 J ( device) S 60 J ( object.) S 
1920 8920 P (However,) S 60 J ( other) S 60 J ( Win32) S 60 J ( user-mode) S 60 J ( applications) S 60 J ( can) S 60 J ( open) S 60 J ( the) S 60 J ( file) S 60 J ( object) S 60 J ( that) S 60 J ( represents) S 60 J ( the) S 
1920 9180 P (keyboard) S 60 J ( device) S 60 J ( and) S 60 J ( can) S 60 J ( make) S 60 J ( device) S 60 J ( I/O) S 60 J ( control) S 60 J ( requests.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (10) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (As) S 60 J ( another) S 60 J ( example,) S 60 J ( a) S 60 J ( parallel) S 60 J ( driver's) S 60 J ( Dispatch) S 60 J ( routine) S 60 J ( might) S 60 J ( handle) S 60 J ( the) S 60 J ( receipt) S 60 J ( of) S 60 J ( a) S 60 J ( close) S 
1200 2320 P (request) S 60 J ( as) S 60 J ( follows:) S 
1680 2840 P 0 12 F 0 12 F () S 480 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 3100 P () S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0L;) S 
1680 3360 P () S 480 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 3620 P (case) S 144 J ( IRP_MJ_CLOSE:) S 
1680 3880 P (//) S 
1680 4140 P (//) S 144 J ( Before) S 144 J ( closing,) S 144 J ( need) S 144 J ( to) S 144 J ( wait) S 144 J ( until) S 144 J ( the) S 144 J ( busy) S 144 J ( path) S 
1680 4400 P (//) S 144 J ( is) S 144 J ( FALSE.) S 144 J ( Can't) S 144 J ( have) S 144 J ( any) S 144 J ( paths) S 144 J ( of) S 144 J ( execution) S 
1680 4660 P (//) S 144 J ( running) S 144 J ( around) S 144 J ( while) S 144 J ( the) S 144 J ( port) S 144 J ( is) S 144 J ( closed.) S 
1680 4920 P (//) S 
1680 5180 P () S 480 J ( while) S 144 J ( \(deviceExtension->BusyPath\)) S 144 J ( {) S 
1680 5440 P () S 480 J ( ) S 480 J ( KeDelayExecutionThread\() S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KernelMode,) S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( FALSE,) S 
1680 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->BusyDelayAmount\);) S 
1680 6480 P () S 480 J ( }) S 
1680 6740 P () S 480 J ( break;) S 
1680 7000 P () S 480 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 7260 P () S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( status;) S 
1680 7520 P () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 7780 P () S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_NO_INCREMENT\);) S 
1680 8040 P () S 480 J ( return) S 144 J ( status;) S 
1680 8300 P (}) S 144 J ( //) S 144 J ( end) S 144 J ( switch) S 
1200 8680 P 0 12 F 24 12 F (A) S 60 J ( parallel) S 60 J ( driver) S 60 J ( cannot) S 60 J ( complete) S 60 J ( the) S 60 J ( IRP) S 60 J ( for) S 60 J ( a) S 60 J ( close) S 60 J ( request) S 60 J ( until) S 60 J ( all) S 60 J ( outstanding) S 60 J ( operations) S 
1200 8940 P (for) S 60 J ( an) S 60 J ( open) S 60 J ( parallel) S 60 J ( port) S 60 J ( have) S 60 J ( completed) S 60 J ( or) S 60 J ( been) S 60 J ( cancelled.) S 60 J ( Consequently,) S 60 J ( this) S 60 J ( driver) S 60 J ( would) S 
1200 9200 P (maintain) S 60 J ( a) S 60 J ( Boolean,) S 60 J ( such) S 60 J ( as) S 60 J ( ) S 0 12 F 0 12 F (BusyPath) S 0 12 F 24 12 F (,) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( extension) S 60 J ( of) S 60 J ( its) S 60 J ( device) S 60 J ( object) S 60 J ( for) S 60 J ( each) S 
1200 9460 P (port.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (11) S E B () S 720 J ( ) S E 
1920 2080 P 0 12 F 8 12 F B (6.2.3) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( Points) S 67 J ( to) S 67 J ( Consider) S 67 J ( in) S 67 J ( Implementing) S 67 J ( DispatchCreateClose) S E 
1920 2700 P 0 12 F 24 12 F (Keep) S 60 J ( the) S 60 J ( following) S 60 J ( points) S 60 J ( in) S 60 J ( mind) S 60 J ( when) S 60 J ( implementing) S 60 J ( a) S 60 J ( DispatchCreateClose) S 60 J ( routine:) S 
1920 3020 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( At) S 60 J ( a) S 60 J ( minimum,) S 60 J ( this) S 60 J ( routine) S 60 J ( must) S 60 J ( do) S 60 J ( the) S 60 J ( following:) S 
1920 3340 P () S 544 J ( 1) S 296 J ( Set) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Status) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( of) S 60 J ( the) S 60 J ( input) S 60 J ( IRP's) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( with) S 60 J ( an) S 60 J ( appropriate) S 
2880 3600 P (NTSTATUS-type) S 60 J ( value,) S 60 J ( usually) S 60 J ( STATUS_SUCCESS.) S 
1920 3920 P () S 544 J ( 2) S 296 J ( Set) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( of) S 60 J ( the) S 60 J ( input) S 60 J ( IRP's) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( to) S 60 J ( zero,) S 60 J ( indicating) S 60 J ( that) S 
2880 4180 P (no) S 60 J ( data) S 60 J ( was) S 60 J ( transferred.) S 
1920 4500 P () S 544 J ( 3) S 296 J ( Call) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( IRP) S 60 J ( and) S 60 J ( a) S 60 J ( ) S 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( of) S 
2880 4760 P (IO_NO_INCREMENT.) S 
1920 5080 P () S 544 J ( 4) S 296 J ( Return) S 60 J ( the) S 60 J ( NTSTATUS-type) S 60 J ( value) S 60 J ( that) S 60 J ( it) S 60 J ( set) S 60 J ( in) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Status) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( of) S 60 J ( the) S 60 J ( IRP's) S 60 J ( I/O) S 
2880 5340 P (status) S 60 J ( block.) S 
1920 5660 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( In) S 60 J ( a) S 60 J ( highest-level) S 60 J ( NT) S 60 J ( driver,) S 60 J ( this) S 60 J ( routine) S 60 J ( might) S 60 J ( need) S 60 J ( to) S 60 J ( do) S 60 J ( additional) S 60 J ( work) S 60 J ( to) S 60 J ( process) S 60 J ( a) S 
2400 5920 P (create) S 60 J ( and/or) S 60 J ( close) S 60 J ( request,) S 60 J ( depending) S 60 J ( on) S 60 J ( the) S 60 J ( nature) S 60 J ( of) S 60 J ( the) S 60 J ( device) S 60 J ( or) S 60 J ( on) S 60 J ( the) S 60 J ( design) S 60 J ( of) S 60 J ( the) S 
2400 6180 P (driver.) S 60 J ( However,) S 60 J ( a) S 60 J ( lower-level) S 60 J ( NT) S 60 J ( driver's) S 60 J ( DispatchCreateClose) S 60 J ( routine) S 60 J ( usually) S 60 J ( is) S 60 J ( called) S 
2400 6440 P (only) S 60 J ( when) S 60 J ( the) S 60 J ( next-higher) S 60 J ( level) S 60 J ( driver) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoGetDeviceObjectPointer) S E 0 12 F 24 12 F (,) S 
2400 6700 P 0 12 F 24 12 F B (IoAttachDevice) S E 0 12 F 24 12 F (,) S 60 J ( or) S 60 J ( ) S 0 12 F 24 12 F B (IoDetachDevice) S E 0 12 F 24 12 F (.) S 60 J ( Consequently,) S 60 J ( a) S 60 J ( lower-level) S 60 J ( driver) S 60 J ( in) S 60 J ( a) S 60 J ( chain) S 60 J ( of) S 
2400 6960 P (layered) S 60 J ( drivers) S 60 J ( can) S 60 J ( do) S 60 J ( only) S 60 J ( the) S 60 J ( minimum) S 60 J ( required) S 60 J ( processing) S 60 J ( of) S 60 J ( a) S 60 J ( create) S 60 J ( or) S 60 J ( close) S 60 J ( request.) S 
1920 7760 P 0 12 F 8 14 F B (6.3) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Implementing) S 78 J ( a) S 78 J ( DispatchCleanup) S 78 J ( Routine) S E 
1920 8380 P 0 12 F 24 12 F (Any) S 60 J ( NT) S 60 J ( driver) S 60 J ( that) S 60 J ( handles) S 60 J ( the) S 60 J ( cancelation) S 60 J ( of) S 60 J ( IRPs) S 60 J ( also) S 60 J ( must) S 60 J ( have) S 60 J ( a) S 60 J ( DispatchCleanup) S 60 J ( routine) S 
1920 8640 P (if) S 60 J ( IRPs) S 60 J ( might) S 60 J ( be) S 60 J ( queued) S 60 J ( when) S 60 J ( the) S 60 J ( handle) S 60 J ( for) S 60 J ( the) S 60 J ( file) S 60 J ( object) S 60 J ( that) S 60 J ( represents) S 60 J ( the) S 60 J ( device) S 60 J ( is) S 
1920 8900 P (closed.) S 60 J ( Depending) S 60 J ( on) S 60 J ( the) S 60 J ( current) S 60 J ( state) S 60 J ( of) S 60 J ( IRPs) S 60 J ( in) S 60 J ( the) S 60 J ( driver,) S 60 J ( its) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( might) S 60 J ( be) S 60 J ( called) S 
1920 9160 P (first) S 60 J ( for) S 60 J ( the) S 60 J ( current) S 60 J ( IRP,) S 60 J ( or) S 60 J ( its) S 60 J ( DispatchCleanup) S 60 J ( routine) S 60 J ( might) S 60 J ( be) S 60 J ( called) S 60 J ( for) S 60 J ( all) S 60 J ( IRPs) S 60 J ( currently) S 
1920 9420 P (queued) S 60 J ( to) S 60 J ( the) S 60 J ( file) S 60 J ( object) S 60 J ( that) S 60 J ( represents) S 60 J ( the) S 60 J ( driver's) S 60 J ( device) S 60 J ( object) S 60 J ( in) S 60 J ( user) S 60 J ( mode.) S 
1920 9800 P (Note) S 60 J ( that) S 60 J ( a) S 60 J ( driver's) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( for) S 60 J ( a) S 60 J ( single) S 60 J ( IRP,) S 60 J ( while) S 60 J ( the) S 60 J ( DispatchCleanup) S 
1920 10060 P (routine) S 60 J ( is) S 60 J ( called) S 60 J ( for) S 60 J ( all) S 60 J ( IRPs) S 60 J ( currently) S 60 J ( queued) S 60 J ( to) S 60 J ( a) S 60 J ( target) S 60 J ( device) S 60 J ( object.) S 
1920 10440 P (The) S 60 J ( following) S 60 J ( subsections) S 60 J ( describe) S 60 J ( how) S 60 J ( a) S 60 J ( typical) S 60 J ( NT) S 60 J ( driver) S 60 J ( handles) S 60 J ( the) S 60 J ( receipt) S 60 J ( of) S 60 J ( a) S 60 J ( cleanup) S 
1920 10700 P (request) S 60 J ( and) S 60 J ( summarizes) S 60 J ( points) S 60 J ( to) S 60 J ( consider) S 60 J ( in) S 60 J ( implementing) S 60 J ( a) S 60 J ( new) S 60 J ( DispatchCleanup) S 60 J ( routine.) S 
1920 11340 P 0 12 F 8 12 F B (6.3.1) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( Working) S 67 J ( DispatchCleanup) S 67 J ( Routines) S E 
1920 11960 P 0 12 F 24 12 F (As) S 60 J ( for) S 60 J ( any) S 60 J ( cancelable) S 60 J ( IRP,) S 60 J ( the) S 60 J ( DispatchCleanup) S 60 J ( routine) S 60 J ( must) S 60 J ( acquire) S 60 J ( the) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 
1920 12220 P (before) S 60 J ( it) S 60 J ( completes) S 60 J ( the) S 60 J ( queued) S 60 J ( IRPs) S 60 J ( \(if) S 60 J ( any\)) S 60 J ( with) S 60 J ( STATUS_CANCELLED.) S 60 J ( If) S 60 J ( another) S 60 J ( driver) S 
1920 12480 P (routine) S 60 J ( also) S 60 J ( accesses) S 60 J ( the) S 60 J ( device) S 60 J ( extension,) S 60 J ( the) S 60 J ( driver) S 60 J ( might) S 60 J ( use) S 60 J ( another) S 60 J ( spin) S 60 J ( lock) S 60 J ( to) S 60 J ( protect) S 
1920 12740 P (that) S 60 J ( part) S 60 J ( of) S 60 J ( the) S 60 J ( device) S 60 J ( extension) S 60 J ( shared) S 60 J ( with) S 60 J ( its) S 60 J ( DispatchCleanup) S 60 J ( routine.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (12) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2180 P 0 12 F 24 12 F (A) S 60 J ( new) S 60 J ( DispatchCleanup) S 60 J ( routine) S 60 J ( should) S 60 J ( have) S 60 J ( code) S 60 J ( similar) S 60 J ( to) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( keyboard) S 
1200 2440 P (class) S 60 J ( driver's,) S 60 J ( as) S 60 J ( follows:) S 
1680 2960 P 0 12 F 0 12 F ({) S 
1680 3220 P () S 480 J ( KIRQL) S 144 J ( spinLockIrql;) S 
1680 3480 P () S 480 J ( KIRQL) S 144 J ( cancelIrql;) S 
1680 3740 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
1680 4000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
1680 4260 P () S 480 J ( PKDEVICE_QUEUE_ENTRY) S 144 J ( packet;) S 
1680 4520 P () S 480 J ( PIRP) S 144 J ( currentIrp) S 144 J ( =) S 144 J ( NULL;) S 
1680 4780 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp;) S 
1680 5040 P (//) S 
1680 5300 P (//) S 144 J ( First,) S 144 J ( acquire) S 144 J ( the) S 144 J ( device) S 144 J ( extension) S 144 J ( spin) S 144 J ( lock) S 
1680 5560 P (//) S 144 J ( and,) S 144 J ( then,) S 144 J ( the) S 144 J ( cancel) S 144 J ( spin) S 144 J ( lock.) S 
1680 5820 P (//) S 
1680 6080 P () S 480 J ( KeAcquireSpinLock\() S 
1680 6340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock,) S 
1680 6600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &spinLockIrql\);) S 
1680 6860 P () S 480 J ( IoAcquireCancelSpinLock\(&cancelIrql\);) S 
1680 7120 P () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 7380 P (//) S 
1680 7640 P (//) S 144 J ( Indicate) S 144 J ( that) S 144 J ( cleanup) S 144 J ( routine) S 144 J ( was) S 144 J ( called.) S 
1680 7900 P (//) S 144 J ( \(StartIo) S 144 J ( cares) S 144 J ( about) S 144 J ( this.\)) S 
1680 8160 P (//) S 
1680 8420 P () S 480 J ( ) S 480 J ( deviceExtension->CleanupWasInitiated) S 144 J ( =) S 144 J ( TRUE;) S 
1680 8680 P (//) S 
1680 8940 P (//) S 144 J ( Complete) S 144 J ( all) S 144 J ( queued) S 144 J ( requests) S 144 J ( with) S 144 J ( STATUS_CANCELLED,) S 
1680 9200 P (//) S 144 J ( starting) S 144 J ( with) S 144 J ( the) S 144 J ( Device) S 144 J ( Object's) S 144 J ( CurrentIrp,) S 
1680 9460 P (//) S 144 J ( and) S 144 J ( running) S 144 J ( down) S 144 J ( requests) S 144 J ( in) S 144 J ( the) S 144 J ( device) S 144 J ( queue.) S 
1680 9720 P (//) S 144 J ( Set) S 144 J ( the) S 144 J ( CurrentIrp) S 144 J ( to) S 144 J ( NULL) S 144 J ( and) S 144 J ( RequestIsPending) S 
1680 9980 P (//) S 144 J ( to) S 144 J ( FALSE,) S 144 J ( so) S 144 J ( that) S 144 J ( the) S 144 J ( DPC) S 144 J ( callback) S 144 J ( routine) S 144 J ( won't) S 
1680 10240 P (//) S 144 J ( attempt) S 144 J ( to) S 144 J ( complete) S 144 J ( the) S 144 J ( CurrentIrp.) S 
1680 10500 P (//) S 
1680 10760 P () S 480 J ( ) S 480 J ( currentIrp) S 144 J ( =) S 144 J ( DeviceObject->CurrentIrp;) S 
1680 11020 P () S 480 J ( ) S 480 J ( DeviceObject->CurrentIrp) S 144 J ( =) S 144 J ( NULL;) S 
1680 11280 P () S 480 J ( ) S 480 J ( deviceExtension->RequestIsPending) S 144 J ( =) S 144 J ( FALSE;) S 
1680 11540 P () S 480 J ( ) S 480 J ( while) S 144 J ( \(currentIrp) S 144 J ( !=) S 144 J ( NULL\)) S 144 J ( {) S 
1680 11800 P (//) S 
1680 12060 P (//) S 144 J ( Remove) S 144 J ( currentIrp) S 144 J ( from) S 144 J ( cancelable) S 144 J ( state.) S 
1680 12320 P (//) S 
1680 12580 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoSetCancelRoutine\(currentIrp,) S 144 J ( NULL\);) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (13) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Set) S 144 J ( IRP) S 144 J ( status,) S 144 J ( release) S 144 J ( the) S 144 J ( cancel) S 144 J ( spin) S 144 J ( lock,) S 
2400 2580 P (//) S 144 J ( then) S 144 J ( the) S 144 J ( device) S 144 J ( extension) S 144 J ( spin) S 144 J ( lock,) S 
2400 2840 P (//) S 144 J ( and) S 144 J ( complete) S 144 J ( the) S 144 J ( IRP.) S 
2400 3100 P (//) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( currentIrp->IoStatus.Status) S 144 J ( =) S 144 J ( STATUS_CANCELLED;) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( currentIrp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoReleaseCancelSpinLock\(cancelIrql\);) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( KeReleaseSpinLock\() S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension,) S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( spinLockIrql\);) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoCompleteRequest\(currentIrp,) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IO_KEYBOARD_INCREMENT\);) S 
2400 5440 P (//) S 
2400 5700 P (//) S 144 J ( Reacquire) S 144 J ( the) S 144 J ( spin) S 144 J ( locks) S 144 J ( to) S 144 J ( walk) S 144 J ( the) S 144 J ( device) S 144 J ( queue) S 
2400 5960 P (//) S 144 J ( and) S 144 J ( cancel) S 144 J ( any) S 144 J ( queued) S 144 J ( IRPs.) S 
2400 6220 P (//) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( KeAcquireSpinLock\() S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension,) S 
2400 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &spinLockIrql\);) S 
2400 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoAcquireCancelSpinLock\(&cancelIrql\);) S 
2400 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( packet) S 144 J ( =) S 144 J ( KeRemoveDeviceQueue\() S 
2400 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &DeviceObject->DeviceQueue\);) S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(packet) S 144 J ( !=) S 144 J ( NULL\)) S 144 J ( {) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( currentIrp) S 144 J ( =) S 
2400 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( CONTAINING_RECORD\() S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( packet,) S 
2400 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IRP,) S 
2400 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Tail.Overlay.DeviceQueueEntry\);) S 
2400 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
2400 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( currentIrp) S 144 J ( =) S 144 J ( \(PIRP\)) S 144 J ( NULL;) S 
2400 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
2400 10380 P () S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( while) S 
2400 10640 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( if) S 144 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (14) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( Release) S 144 J ( the) S 144 J ( spin) S 144 J ( locks) S 144 J ( and) S 144 J ( complete) S 144 J ( the) S 144 J ( cleanup) S 144 J ( request.) S 
1680 2580 P (//) S 
1680 2840 P () S 480 J ( IoReleaseCancelSpinLock\(cancelIrql\);) S 
1680 3100 P () S 480 J ( KeReleaseSpinLock\() S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension,) S 
1680 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( spinLockIrql\);) S 
1680 3880 P () S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 
1680 4140 P () S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
1680 4400 P () S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_NO_INCREMENT\);) S 
1680 4660 P () S 480 J ( return\(STATUS_SUCCESS\);) S 
1680 4920 P (}) S 
1200 5300 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( KeyboardClassDispatchCleanup) S 60 J ( acquires) S 60 J ( the) S 60 J ( driver's) S 60 J ( device) S 60 J ( extension) S 60 J ( spin) S 60 J ( lock) S 
1200 5560 P (first,) S 60 J ( then) S 60 J ( the) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock,) S 60 J ( and) S 60 J ( releases) S 60 J ( both) S 60 J ( spin) S 60 J ( locks) S 60 J ( in) S 60 J ( inverse) S 60 J ( order,) S 60 J ( thereby) S 60 J ( restoring) S 
1200 5820 P (the) S 60 J ( original) S 60 J ( IRQL) S 60 J ( \(probably) S 60 J ( to) S 60 J ( PASSIVE_LEVEL\),) S 60 J ( before) S 60 J ( it) S 60 J ( completes) S 60 J ( an) S 60 J ( IRP.) S 60 J ( Every) S 60 J ( NT) S 
1200 6080 P (driver) S 60 J ( should) S 60 J ( do) S 60 J ( likewise:) S 
1200 6400 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Release) S 60 J ( every) S 60 J ( spin) S 60 J ( lock) S 60 J ( the) S 60 J ( driver) S 60 J ( is) S 60 J ( holding) S 60 J ( before) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( an) S 
1680 6660 P (IRP.) S 
1200 7040 P (It) S 60 J ( takes) S 60 J ( an) S 60 J ( indeterminate) S 60 J ( amount) S 60 J ( of) S 60 J ( time) S 60 J ( to) S 60 J ( complete) S 60 J ( an) S 60 J ( IRP,) S 60 J ( particularly) S 60 J ( in) S 60 J ( a) S 60 J ( chain) S 60 J ( of) S 60 J ( layered) S 
1200 7300 P (drivers.) S 60 J ( Moreover,) S 60 J ( a) S 60 J ( deadlock) S 60 J ( can) S 60 J ( occur) S 60 J ( if) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver's) S 60 J ( IoCompletion) S 60 J ( routine) S 60 J ( re-) S 
1200 7560 P (sends) S 60 J ( a) S 60 J ( just) S 60 J ( completed) S 60 J ( IRP) S 60 J ( down) S 60 J ( to) S 60 J ( a) S 60 J ( lower) S 60 J ( driver) S 60 J ( that) S 60 J ( is) S 60 J ( holding) S 60 J ( a) S 60 J ( spin) S 60 J ( lock.) S 
1200 7940 P (Note) S 60 J ( also) S 60 J ( that) S 60 J ( this) S 60 J ( DispatchCleanup) S 60 J ( routine) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( device-type-) S 
1200 8200 P (specific) S 60 J ( ) S 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( value) S 60 J ( for) S 60 J ( all) S 60 J ( queued) S 60 J ( IRPs.) S 60 J ( The) S 60 J ( protected) S 60 J ( subsystem) S 60 J ( in) S 60 J ( which) S 
1200 8460 P (applications) S 60 J ( run) S 60 J ( is) S 60 J ( assumed) S 60 J ( to) S 60 J ( wait) S 60 J ( on) S 60 J ( the) S 60 J ( completion) S 60 J ( of) S 60 J ( outstanding) S 60 J ( requests) S 60 J ( when) S 60 J ( the) S 
1200 8720 P (KeyboardClassDispatchCleanup) S 60 J ( routine) S 60 J ( is) S 60 J ( called.) S 
1200 9100 P (For) S 60 J ( another) S 60 J ( type) S 60 J ( of) S 60 J ( device,) S 60 J ( the) S 60 J ( originator) S 60 J ( of) S 60 J ( the) S 60 J ( cleanup) S 60 J ( \(and) S 60 J ( cancel\)) S 60 J ( requests) S 60 J ( might) S 60 J ( not) S 60 J ( wait,) S 
1200 9360 P (particularly) S 60 J ( if) S 60 J ( the) S 60 J ( the) S 60 J ( device) S 60 J ( might) S 60 J ( not) S 60 J ( be) S 60 J ( opened) S 60 J ( by) S 60 J ( another) S 60 J ( application) S 60 J ( for) S 60 J ( some) S 60 J ( time.) S 60 J ( The) S 
1200 9620 P (driver) S 60 J ( of) S 60 J ( such) S 60 J ( a) S 60 J ( device) S 60 J ( would) S 60 J ( complete) S 60 J ( all) S 60 J ( queued) S 60 J ( IRPS) S 60 J ( with) S 60 J ( STATUS_CANCELLED) S 60 J ( but) S 
1200 9880 P (apply) S 60 J ( a) S 60 J ( ) S 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( of) S 60 J ( IO_NO_INCREMENT) S 60 J ( when) S 60 J ( it) S 60 J ( called) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F (.) S 
1200 10260 P (If) S 60 J ( a) S 60 J ( driver) S 60 J ( manages) S 60 J ( its) S 60 J ( own) S 60 J ( internal) S 60 J ( queue) S 60 J ( of) S 60 J ( IRPs,) S 60 J ( rather) S 60 J ( than) S 60 J ( using) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 
1200 10520 P (associated) S 60 J ( with) S 60 J ( its) S 60 J ( device) S 60 J ( object,) S 60 J ( the) S 60 J ( driver) S 60 J ( must) S 60 J ( set) S 60 J ( up) S 60 J ( an) S 60 J ( interlocked) S 60 J ( queue) S 60 J ( that) S 60 J ( is) S 60 J ( protected) S 
1200 10780 P (with) S 60 J ( an) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock.) S 60 J ( Otherwise,) S 60 J ( another) S 60 J ( driver) S 60 J ( routine) S 60 J ( \(running) S 60 J ( on) S 60 J ( another) S 60 J ( processor) S 
1200 11040 P (in) S 60 J ( an) S 60 J ( SMP) S 60 J ( machine\)) S 60 J ( might) S 60 J ( dequeue) S 60 J ( an) S 60 J ( IRP) S 60 J ( that) S 60 J ( should) S 60 J ( be) S 60 J ( cancelled) S 60 J ( by) S 60 J ( the) S 60 J ( DispatchCleanup) S 
1200 11300 P (routine.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (15) S E B () S 720 J ( ) S E 
1920 2080 P 0 12 F 8 12 F B (6.3.2) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( Points) S 67 J ( to) S 67 J ( Consider) S 67 J ( in) S 67 J ( Implementing) S 67 J ( DispatchCleanup) S E 
1920 2700 P 0 12 F 24 12 F (Keep) S 60 J ( the) S 60 J ( following) S 60 J ( points) S 60 J ( in) S 60 J ( mind) S 60 J ( when) S 60 J ( implementing) S 60 J ( a) S 60 J ( DispatchCleanup) S 60 J ( routine:) S 
1920 3020 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( This) S 60 J ( routine) S 60 J ( must) S 60 J ( walk) S 60 J ( the) S 60 J ( queue) S 60 J ( of) S 60 J ( IRPs) S 60 J ( for) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 60 J ( and) S 60 J ( cancel) S 60 J ( every) S 
2400 3280 P (outstanding) S 60 J ( request) S 60 J ( before) S 60 J ( it) S 60 J ( completes) S 60 J ( the) S 60 J ( input) S 60 J ( cleanup) S 60 J ( IRP,) S 60 J ( which) S 60 J ( is) S 60 J ( sent) S 60 J ( when) S 60 J ( the) S 
2400 3540 P (handle) S 60 J ( for) S 60 J ( the) S 60 J ( file) S 60 J ( object) S 60 J ( that) S 60 J ( represents) S 60 J ( the) S 60 J ( device) S 60 J ( in) S 60 J ( user) S 60 J ( mode) S 60 J ( is) S 60 J ( released.) S 
1920 3860 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( queue) S 60 J ( should) S 60 J ( be) S 60 J ( protected) S 60 J ( by) S 60 J ( a) S 60 J ( spin) S 60 J ( lock) S 60 J ( to) S 60 J ( prevent) S 60 J ( IRPs) S 60 J ( that) S 60 J ( should) S 60 J ( be) S 60 J ( cancelled) S 
2400 4120 P (from) S 60 J ( being) S 60 J ( dequeued) S 60 J ( by) S 60 J ( any) S 60 J ( other) S 60 J ( driver) S 60 J ( routine.) S 60 J ( The) S 60 J ( device) S 60 J ( queue) S 60 J ( associated) S 60 J ( with) S 60 J ( a) S 
2400 4380 P (device) S 60 J ( object) S 60 J ( comes) S 60 J ( with) S 60 J ( a) S 60 J ( spin) S 60 J ( lock.) S 60 J ( If) S 60 J ( a) S 60 J ( driver) S 60 J ( sets) S 60 J ( up) S 60 J ( its) S 60 J ( own) S 60 J ( queue) S 60 J ( for) S 60 J ( IRPs,) S 60 J ( it) S 60 J ( should) S 
2400 4640 P (set) S 60 J ( up) S 60 J ( an) S 60 J ( interlocked) S 60 J ( queue.) S 
1920 4960 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( This) S 60 J ( routine) S 60 J ( must) S 60 J ( acquire) S 60 J ( the) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( before) S 60 J ( it) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoSetCancelRoutine) S E 0 12 F 24 12 F () S 60 J ( to) S 
2400 5220 P (reset) S 60 J ( its) S 60 J ( Cancel) S 60 J ( entry) S 60 J ( point) S 60 J ( to) S 60 J ( NULL) S 60 J ( in) S 60 J ( each) S 60 J ( IRP.) S 
1920 5540 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( This) S 60 J ( routine) S 60 J ( must) S 60 J ( set) S 60 J ( each) S 60 J ( queued) S 60 J ( IRP's) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (Status) S E 0 12 F 24 12 F () S 60 J ( set) S 60 J ( to) S 
2400 5800 P (STATUS_CANCELLED) S 60 J ( and) S 60 J ( ) S 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( set) S 60 J ( to) S 60 J ( zero) S 60 J ( before) S 60 J ( it) S 60 J ( completes) S 60 J ( an) S 60 J ( IRP.) S 
1920 6120 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( This) S 60 J ( routine) S 60 J ( must) S 60 J ( release) S 60 J ( any) S 60 J ( \(and) S 60 J ( all\)) S 60 J ( spin) S 60 J ( locks) S 60 J ( it) S 60 J ( is) S 60 J ( holding) S 60 J ( before) S 60 J ( calling) S 
2400 6380 P 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( an) S 60 J ( IRP.) S 
1920 6700 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Whether) S 60 J ( this) S 60 J ( routine) S 60 J ( boosts) S 60 J ( the) S 60 J ( priority) S 60 J ( of) S 60 J ( the) S 60 J ( originator) S 60 J ( when) S 60 J ( it) S 60 J ( completes) S 60 J ( queued) S 60 J ( IRPs) S 
2400 6960 P (depends) S 60 J ( on) S 60 J ( whether) S 60 J ( the) S 60 J ( originator) S 60 J ( is) S 60 J ( likely) S 60 J ( to) S 60 J ( wait) S 60 J ( on) S 60 J ( the) S 60 J ( IRPs.) S 
1920 7280 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( This) S 60 J ( routine) S 60 J ( should) S 60 J ( set) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( IO_NO_INCREMENT) S 60 J ( when) S 60 J ( it) S 60 J ( completes) S 60 J ( the) S 
2400 7540 P (cleanup) S 60 J ( IRP.) S 
1920 8340 P 0 12 F 8 14 F B (6.4) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Implementing) S 78 J ( a) S 78 J ( DispatchRead) S 78 J ( and/or) S 78 J ( DispatchWrite) S 78 J ( Routine) S E 
1920 8960 P 0 12 F 24 12 F (Every) S 60 J ( driver) S 60 J ( of) S 60 J ( a) S 60 J ( device) S 60 J ( from) S 60 J ( which) S 60 J ( data) S 60 J ( can) S 60 J ( be) S 60 J ( transferred) S 60 J ( to) S 60 J ( the) S 60 J ( system) S 60 J ( must) S 60 J ( have) S 60 J ( a) S 
1920 9220 P (DispatchRead) S 60 J ( routine.) S 60 J ( Every) S 60 J ( driver) S 60 J ( of) S 60 J ( a) S 60 J ( device) S 60 J ( to) S 60 J ( which) S 60 J ( data) S 60 J ( can) S 60 J ( be) S 60 J ( transferred) S 60 J ( from) S 60 J ( the) S 
1920 9480 P (system) S 60 J ( must) S 60 J ( have) S 60 J ( a) S 60 J ( DispatchWrite) S 60 J ( routine.) S 60 J ( Any) S 60 J ( driver) S 60 J ( that) S 60 J ( transfers) S 60 J ( data) S 60 J ( in) S 60 J ( both) S 60 J ( directions) S 
1920 9740 P (can) S 60 J ( have) S 60 J ( a) S 60 J ( combined) S 60 J ( DispatchReadWrite) S 60 J ( routine.) S 
1920 10120 P (As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 3,) S 60 J ( whether) S 60 J ( a) S 60 J ( driver) S 60 J ( uses) S 60 J ( buffered) S 60 J ( or) S 60 J ( direct) S 60 J ( I/O) S 60 J ( can) S 60 J ( affect) S 60 J ( how) S 60 J ( it) S 
1920 10380 P (handles) S 60 J ( transfer) S 60 J ( requests.) S 60 J ( In) S 60 J ( particular,) S 60 J ( a) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( direct) S 60 J ( I/O) S 60 J ( to) S 60 J ( do) S 60 J ( DMA) S 60 J ( operations) S 
1920 10640 P (might) S 60 J ( need) S 60 J ( to) S 60 J ( split) S 60 J ( up) S 60 J ( large) S 60 J ( transfer) S 60 J ( requests) S 60 J ( into) S 60 J ( a) S 60 J ( sequence) S 60 J ( of) S 60 J ( smaller) S 60 J ( transfer) S 60 J ( operations) S 60 J ( in) S 
1920 10900 P (order) S 60 J ( to) S 60 J ( satisfy) S 60 J ( an) S 60 J ( IRP_MJ_READ) S 60 J ( or) S 60 J ( IRP_MJ_WRITE) S 60 J ( request.) S 
1920 11280 P (The) S 60 J ( following) S 60 J ( subsections) S 60 J ( show) S 60 J ( how) S 60 J ( a) S 60 J ( representative) S 60 J ( set) S 60 J ( of) S 60 J ( NT) S 60 J ( drivers) S 60 J ( would) S 60 J ( implement) S 
1920 11540 P (DispatchReadWrite) S 60 J ( routines) S 60 J ( as) S 60 J ( a) S 60 J ( guide) S 60 J ( to) S 60 J ( implementing) S 60 J ( these) S 60 J ( routine\(s\)) S 60 J ( in) S 60 J ( new) S 60 J ( drivers.) S 
1920 11800 P (Section) S 60 J ( 6.4.4) S 60 J ( summarizes) S 60 J ( points) S 60 J ( to) S 60 J ( consider) S 60 J ( in) S 60 J ( implementing) S 60 J ( a) S 60 J ( new) S 60 J ( DispatchRead,) S 
1920 12060 P (DispatchWrite,) S 60 J ( or) S 60 J ( combined) S 60 J ( DispatchReadWrite) S 60 J ( routine.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (16) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2080 P 0 12 F 8 12 F B (6.4.1) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( DispatchReadWrite) S 67 J ( Using) S 67 J ( Buffered) S 67 J ( I/O) S E 
1200 2700 P 0 12 F 24 12 F (As) S 60 J ( already) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Section) S 60 J ( 6.3.1,) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( processes) S 
1200 2960 P (read) S 60 J ( requests) S 60 J ( that) S 60 J ( come) S 60 J ( only) S 60 J ( from) S 60 J ( the) S 60 J ( Win32) S 60 J ( user) S 60 J ( input) S 60 J ( thread.) S 60 J ( This) S 60 J ( driver) S 60 J ( defines) S 60 J ( a) S 60 J ( structure,) S 
1200 3220 P (KEYBOARD_INPUT_DATA,) S 60 J ( in) S 60 J ( which) S 60 J ( to) S 60 J ( store) S 60 J ( keystrokes) S 60 J ( from) S 60 J ( the) S 60 J ( device) S 60 J ( and,) S 60 J ( at) S 60 J ( any) S 60 J ( given) S 
1200 3480 P (moment,) S 60 J ( holds) S 60 J ( some) S 60 J ( number) S 60 J ( of) S 60 J ( these) S 60 J ( structures) S 60 J ( in) S 60 J ( an) S 60 J ( internal) S 60 J ( ring) S 60 J ( buffer) S 60 J ( in) S 60 J ( order) S 60 J ( to) S 60 J ( satisfy) S 
1200 3740 P (read) S 60 J ( requests) S 60 J ( as) S 60 J ( they) S 60 J ( come) S 60 J ( in.) S 
1200 4120 P (The) S 60 J ( driver) S 60 J ( of) S 60 J ( another) S 60 J ( input) S 60 J ( device) S 60 J ( might) S 60 J ( not) S 60 J ( be) S 60 J ( required) S 60 J ( to) S 60 J ( check) S 60 J ( whether) S 60 J ( a) S 60 J ( read) S 60 J ( or) S 60 J ( write) S 
1200 4380 P (request) S 60 J ( came) S 60 J ( from) S 60 J ( a) S 60 J ( particular) S 60 J ( caller.) S 60 J ( However,) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( buffered) S 60 J ( I/O) S 60 J ( probably) S 60 J ( would) S 
1200 4640 P (need) S 60 J ( to) S 60 J ( satisfy) S 60 J ( a) S 60 J ( transfer) S 60 J ( request) S 60 J ( with) S 60 J ( some) S 60 J ( discrete) S 60 J ( amount) S 60 J ( of) S 60 J ( data,) S 60 J ( greater) S 60 J ( than) S 60 J ( a) S 60 J ( single) S 60 J ( byte,) S 
1200 4900 P (that) S 60 J ( the) S 60 J ( originator) S 60 J ( of) S 60 J ( the) S 60 J ( request) S 60 J ( can) S 60 J ( use) S 60 J ( or) S 60 J ( set) S 60 J ( up.) S 60 J ( Such) S 60 J ( a) S 60 J ( driver) S 60 J ( is) S 60 J ( likely) S 60 J ( to) S 60 J ( to) S 60 J ( define) S 60 J ( a) S 
1200 5160 P (structure) S 60 J ( for) S 60 J ( data) S 60 J ( coming) S 60 J ( in) S 60 J ( from) S 60 J ( or) S 60 J ( being) S 60 J ( sent) S 60 J ( to) S 60 J ( its) S 60 J ( device) S 60 J ( and) S 60 J ( is) S 60 J ( likely) S 60 J ( to) S 60 J ( buffer) S 60 J ( structured) S 
1200 5420 P (data) S 60 J ( internally) S 60 J ( as) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( does.) S 
1200 5800 P (Drivers) S 60 J ( that) S 60 J ( buffer) S 60 J ( data) S 60 J ( internally) S 60 J ( should) S 60 J ( support) S 60 J ( IRP_MJ_FLUSH_BUFFERS) S 60 J ( requests,) S 60 J ( and) S 
1200 6060 P (drivers) S 60 J ( for) S 60 J ( other) S 60 J ( than) S 60 J ( an) S 60 J ( underlying) S 60 J ( mass-storage) S 60 J ( device) S 60 J ( can) S 60 J ( also) S 60 J ( support) S 
1200 6320 P (IRP_MJ_SHUTDOWN) S 60 J ( requests) S 60 J ( \(see) S 60 J ( Section) S 60 J ( 6.1\).) S 
1200 6700 P (The) S 60 J ( DispatchRead,) S 60 J ( DispatchWrite,) S 60 J ( or) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( for) S 60 J ( a) S 60 J ( new) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 
1200 6960 P (buffered) S 60 J ( I/O) S 60 J ( should) S 60 J ( be) S 60 J ( something) S 60 J ( like) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 60 J ( DispatchRead) S 60 J ( routine,) S 60 J ( as) S 
1200 7220 P (follows:) S 
1680 7740 P 0 12 F 0 12 F ({) S 
1680 8000 P () S 480 J ( NTSTATUS) S 144 J ( status;) S 
1680 8260 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
1680 8520 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
1680 8780 P (//) S 
1680 9040 P (//) S 144 J ( Validate) S 144 J ( the) S 144 J ( read) S 144 J ( request's) S 144 J ( parameters.) S 
1680 9300 P (//) S 144 J ( The) S 144 J ( length) S 144 J ( should) S 144 J ( be) S 144 J ( an) S 144 J ( integral) S 144 J ( multiple) S 144 J ( of) S 
1680 9560 P (//) S 144 J ( KEYBOARD_INPUT_DATA) S 144 J ( structures.) S 
1680 9820 P (//) S 
1680 10080 P () S 480 J ( if) S 144 J ( \(irpSp->Parameters.Read.Length) S 144 J ( ==) S 144 J ( 0\)) S 144 J ( {) S 
1680 10340 P () S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 
1680 10600 P () S 480 J ( }) S 
1680 10860 P () S 480 J ( else) S 144 J ( if) S 144 J ( \(irpSp->Parameters.Read.Length) S 144 J ( %) S 
1680 11120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sizeof\(KEYBOARD_INPUT_DATA\)\)) S 144 J ( {) S 
1680 11380 P () S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_BUFFER_TOO_SMALL;) S 
1680 11640 P () S 480 J ( }) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (17) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Make) S 144 J ( sure) S 144 J ( the) S 144 J ( caller) S 144 J ( is) S 144 J ( the) S 144 J ( Win32) S 144 J ( input) S 144 J ( thread,) S 144 J ( who's) S 
2400 2580 P (//) S 144 J ( the) S 144 J ( only) S 144 J ( caller) S 144 J ( allowed) S 144 J ( to) S 144 J ( read) S 144 J ( data) S 144 J ( from) S 144 J ( the) S 144 J ( device.) S 
2400 2840 P (//) S 
2400 3100 P () S 480 J ( else) S 144 J ( if) S 144 J ( \(irpSp->FileObject->FsContext\)) S 144 J ( {) S 
2400 3360 P () S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_PENDING;) S 
2400 3620 P () S 480 J ( }) S 
2400 3880 P () S 480 J ( else) S 144 J ( {) S 
2400 4140 P (//) S 
2400 4400 P (//) S 144 J ( Only) S 144 J ( the) S 144 J ( trusted) S 144 J ( subsystem) S 144 J ( with) S 144 J ( the) S 144 J ( correct) S 
2400 4660 P (//) S 144 J ( privilege) S 144 J ( level) S 144 J ( can) S 144 J ( request) S 144 J ( a) S 144 J ( read) S 144 J ( operation.) S 
2400 4920 P (//) S 
2400 5180 P () S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_PRIVILEGE_NOT_HELD;) S 
2400 5440 P () S 480 J ( }) S 
2400 5700 P (//) S 
2400 5960 P (//) S 144 J ( If) S 144 J ( status) S 144 J ( is) S 144 J ( PENDING,) S 144 J ( mark) S 144 J ( the) S 144 J ( IRP) S 144 J ( and) S 144 J ( start) S 144 J ( the) S 144 J ( packet) S 
2400 6220 P (//) S 144 J ( in) S 144 J ( a) S 144 J ( cancelable) S 144 J ( state.) S 144 J ( Otherwise,) S 144 J ( complete) S 144 J ( the) S 144 J ( request.) S 
2400 6480 P (//) S 
2400 6740 P () S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( status;) S 
2400 7000 P () S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
2400 7260 P () S 480 J ( if) S 144 J ( \(status) S 144 J ( ==) S 144 J ( STATUS_PENDING\)) S 144 J ( {) S 
2400 7520 P () S 480 J ( ) S 480 J ( IoMarkIrpPending\(Irp\);) S 
2400 7780 P () S 480 J ( ) S 480 J ( IoStartPacket\() S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject,) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp,) S 
2400 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PULONG\)) S 144 J ( NULL,) S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeyboardClassCancel\);) S 
2400 9080 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
2400 9340 P () S 480 J ( ) S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_NO_INCREMENT\);) S 
2400 9600 P () S 480 J ( }) S 
2400 9860 P () S 480 J ( return\(status\);) S 
2400 10120 P (}) S 
1920 10500 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( is) S 60 J ( a) S 60 J ( highest-level) S 60 J ( NT) S 60 J ( driver) S 60 J ( and) S 60 J ( that) S 60 J ( its) S 60 J ( DispatchRead) S 
1920 10760 P (routine) S 60 J ( checks) S 60 J ( the) S 60 J ( parameters) S 60 J ( supplied) S 60 J ( in) S 60 J ( the) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( of) S 60 J ( the) S 60 J ( IRP.) S 60 J ( It) S 60 J ( is) S 
1920 11020 P (usually) S 60 J ( the) S 60 J ( responsibility) S 60 J ( of) S 60 J ( the) S 60 J ( highest-level) S 60 J ( driver) S 60 J ( in) S 60 J ( a) S 60 J ( chain) S 60 J ( to) S 60 J ( check) S 60 J ( the) S 60 J ( input) S 60 J ( IRP's) S 
1920 11280 P (parameters) S 60 J ( before) S 60 J ( passing) S 60 J ( a) S 60 J ( read/write) S 60 J ( request) S 60 J ( on) S 60 J ( to) S 60 J ( lower) S 60 J ( drivers.) S 60 J ( Consequently,) S 60 J ( many) S 
1920 11540 P (lower-level) S 60 J ( NT) S 60 J ( drivers) S 60 J ( can) S 60 J ( assume) S 60 J ( that) S 60 J ( their) S 60 J ( I/O) S 60 J ( stack) S 60 J ( locations) S 60 J ( in) S 60 J ( a) S 60 J ( read/write) S 60 J ( IRP) S 60 J ( have) S 60 J ( valid) S 
1920 11800 P (parameters.) S 60 J ( The) S 60 J ( lower-) S 60 J ( or) S 60 J ( lowest-level) S 60 J ( driver) S 60 J ( in) S 60 J ( a) S 60 J ( chain) S 60 J ( can) S 60 J ( check) S 60 J ( the) S 60 J ( validity) S 60 J ( of) S 60 J ( the) S 
1920 12060 P (parameters) S 60 J ( in) S 60 J ( its) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location,) S 60 J ( but) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( is) S 60 J ( not) S 60 J ( necessarily) S 60 J ( required) S 60 J ( to) S 60 J ( do) S 60 J ( so) S 
1920 12320 P (unless) S 60 J ( the) S 60 J ( underlying) S 60 J ( device) S 60 J ( places) S 60 J ( constraints) S 60 J ( on) S 60 J ( data) S 60 J ( transfers.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (18) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (When) S 60 J ( the) S 60 J ( preceding) S 60 J ( DispatchRead) S 60 J ( routine) S 60 J ( completes) S 60 J ( an) S 60 J ( IRP) S 60 J ( with) S 60 J ( an) S 60 J ( error,) S 60 J ( it) S 60 J ( sets) S 60 J ( the) S 
1200 2320 P 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( of) S 60 J ( the) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( to) S 60 J ( zero) S 60 J ( to) S 60 J ( indicate) S 60 J ( that) S 60 J ( no) S 60 J ( data) S 60 J ( was) S 60 J ( transferred.) S 60 J ( Note) S 
1200 2580 P (also) S 60 J ( that) S 60 J ( this) S 60 J ( DispatchRead) S 60 J ( routine) S 60 J ( gives) S 60 J ( the) S 60 J ( originator) S 60 J ( of) S 60 J ( an) S 60 J ( erroneous) S 60 J ( read) S 60 J ( request) S 60 J ( no) S 
1200 2840 P 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( \(IO_NO_INCREMENT\)) S 60 J ( when) S 60 J ( it) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F (.) S 
1200 3480 P 0 12 F 8 12 F B (6.4.2) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( DispatchReadWrite) S 67 J ( Using) S 67 J ( Direct) S 67 J ( I/O) S E 
1200 4100 P 0 12 F 24 12 F (Like) S 60 J ( every) S 60 J ( system-supplied) S 60 J ( mass-storage) S 60 J ( device) S 60 J ( driver,) S 60 J ( the) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver,) S 60 J ( described) S 60 J ( in) S 
1200 4360 P (Chapter) S 60 J ( 2,) S 60 J ( has) S 60 J ( a) S 60 J ( combined) S 60 J ( DispatchReadWrite) S 60 J ( routine.) S 60 J ( This) S 60 J ( driver) S 60 J ( uses) S 60 J ( direct) S 60 J ( I/O) S 60 J ( because) S 60 J ( it) S 
1200 4620 P (transfers) S 60 J ( large) S 60 J ( amounts) S 60 J ( of) S 60 J ( data) S 60 J ( at) S 60 J ( a) S 60 J ( time.) S 
1200 5000 P (Even) S 60 J ( though) S 60 J ( the) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver) S 60 J ( is) S 60 J ( always) S 60 J ( layered) S 60 J ( beneath) S 60 J ( at) S 60 J ( least) S 60 J ( one) S 60 J ( driver) S 60 J ( \(an) S 60 J ( FSD\),) S 60 J ( its) S 
1200 5260 P (DispatchReadWrite) S 60 J ( routine) S 60 J ( checks) S 60 J ( the) S 60 J ( validity) S 60 J ( of) S 60 J ( the) S 60 J ( parameters) S 60 J ( in) S 60 J ( its) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( for) S 
1200 5520 P (incoming) S 60 J ( read) S 60 J ( and) S 60 J ( write) S 60 J ( requests.) S 60 J ( One) S 60 J ( test) S 60 J ( is) S 60 J ( a) S 60 J ( "sanity) S 60 J ( check,") S 60 J ( but) S 60 J ( the) S 60 J ( other) S 60 J ( is) S 60 J ( dictated) S 60 J ( by) S 
1200 5780 P (device-specific) S 60 J ( constraints) S 60 J ( on) S 60 J ( data) S 60 J ( transfer) S 60 J ( operations.) S 
1200 6160 P (The) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( of) S 60 J ( a) S 60 J ( driver) S 60 J ( that) S 60 J ( uses) S 60 J ( direct) S 60 J ( I/O) S 60 J ( should) S 60 J ( be) S 60 J ( similar) S 60 J ( to) S 60 J ( that) S 60 J ( of) S 60 J ( the) S 
1200 6420 P (following) S 60 J ( routine.) S 60 J ( Note) S 60 J ( the) S 60 J ( similarities) S 60 J ( between) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 60 J ( DispatchRead) S 
1200 6680 P (routine,) S 60 J ( described) S 60 J ( in) S 60 J ( the) S 60 J ( preceding) S 60 J ( section,) S 60 J ( and) S 60 J ( an) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver's) S 60 J ( DispatchReadWrite) S 
1200 6940 P (routine,) S 60 J ( as) S 60 J ( follows:) S 
1680 7460 P 0 12 F 0 12 F ({) S 
1680 7720 P () S 480 J ( PPARTITION_EXTENSION) S 144 J ( partitionExtension) S 144 J ( =) S 
1680 7980 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
1680 8240 P () S 480 J ( PDISK_EXTENSION) S 144 J ( diskExtension) S 144 J ( =) S 
1680 8500 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( partitionExtension->Partition0;) S 
1680 8760 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
1680 9020 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
1680 9280 P () S 480 J ( ULONG) S 144 J ( firstSectorOfRequest;) S 
1680 9540 P (//) S 
1680 9800 P (//) S 144 J ( Check) S 144 J ( for) S 144 J ( invalid) S 144 J ( parameters.) S 144 J ( It) S 144 J ( is) S 144 J ( an) S 144 J ( error) S 
1680 10060 P (//) S 144 J ( for) S 144 J ( the) S 144 J ( starting) S 144 J ( offset) S 144 J ( +) S 144 J ( length) S 144 J ( to) S 144 J ( go) S 144 J ( past) S 
1680 10320 P (//) S 144 J ( the) S 144 J ( end) S 144 J ( of) S 144 J ( the) S 144 J ( partition) S 144 J ( or) S 144 J ( for) S 144 J ( the) S 144 J ( length) S 
1680 10580 P (//) S 144 J ( to) S 144 J ( not) S 144 J ( be) S 144 J ( a) S 144 J ( proper) S 144 J ( multiple) S 144 J ( of) S 144 J ( the) S 144 J ( sector) S 144 J ( size.) S 
1680 10840 P (//) S 144 J ( There) S 144 J ( are) S 144 J ( other) S 144 J ( possible) S 144 J ( errors,) S 144 J ( but) S 144 J ( the) S 144 J ( file) S 144 J ( system) S 
1680 11100 P (//) S 144 J ( should) S 144 J ( not) S 144 J ( send) S 144 J ( any) S 144 J ( requests) S 144 J ( that) S 144 J ( cause) S 144 J ( fatal) S 144 J ( errors.) S 
1680 11360 P (//) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (19) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( if) S 144 J ( \(RtlLargeIntegerGreaterThan\() S 
2400 2320 P () S 480 J ( ) S 480 J ( RtlLargeIntegerAdd\() S 
2400 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.ByteOffset,) S 
2400 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( RtlConvertUlongToLargeInteger\() S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.Length\)\),) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( partitionExtension->PartitionLength\)) S 144 J ( ||) S 
2400 3620 P () S 480 J ( ) S 480 J ( \(irpSp->Parameters.Read.Length) S 144 J ( &) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(diskExtension->BytesPerSector) S 144 J ( -) S 144 J ( 1\)\)\)) S 144 J ( {) S 
2400 4140 P (//) S 
2400 4400 P (//) S 144 J ( Do) S 144 J ( not) S 144 J ( give) S 144 J ( an) S 144 J ( I/O) S 144 J ( boost) S 144 J ( for) S 144 J ( parameter) S 144 J ( errors.) S 
2400 4660 P (//) S 
2400 4920 P () S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( STATUS_INVALID_PARAMETER;) S 
2400 5180 P () S 480 J ( ) S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
2400 5440 P () S 480 J ( ) S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_NO_INCREMENT\);) S 
2400 5700 P () S 480 J ( ) S 480 J ( return\(STATUS_INVALID_PARAMETER\);) S 
2400 5960 P () S 480 J ( }) S 
2400 6220 P (//) S 
2400 6480 P (//) S 144 J ( The) S 144 J ( offset) S 144 J ( passed) S 144 J ( in) S 144 J ( is) S 144 J ( relative) S 144 J ( to) S 144 J ( the) S 144 J ( start) S 144 J ( of) S 144 J ( the) S 
2400 6740 P (//) S 144 J ( partition.) S 144 J ( This) S 144 J ( driver) S 144 J ( always) S 144 J ( works) S 144 J ( from) S 144 J ( Partition) S 144 J ( 0) S 
2400 7000 P (//) S 144 J ( \(the) S 144 J ( whole) S 144 J ( disk\),) S 144 J ( so) S 144 J ( must) S 144 J ( adjust) S 144 J ( the) S 144 J ( offset.) S 
2400 7260 P (//) S 
2400 7520 P () S 480 J ( irpSp->Parameters.Read.ByteOffset) S 144 J ( =) S 
2400 7780 P () S 480 J ( ) S 480 J ( RtlLargeIntegerAdd\() S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.ByteOffset,) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( partitionExtension->StartingOffset\);) S 
2400 8560 P (//) S 
2400 8820 P (//) S 144 J ( Mark) S 144 J ( IRP) S 144 J ( pending) S 144 J ( and) S 144 J ( queue) S 144 J ( packet,) S 144 J ( passing) S 144 J ( sector) S 144 J ( number) S 
2400 9080 P (//) S 144 J ( for) S 144 J ( C-SCAN) S 144 J ( ordering) S 144 J ( of) S 144 J ( queued) S 144 J ( IRPs.) S 
2400 9340 P (//) S 
2400 9600 P () S 480 J ( IoMarkIrpPending\(Irp\);) S 
2400 9860 P () S 480 J ( firstSectorOfRequest) S 144 J ( =) S 
2400 10120 P () S 480 J ( ) S 480 J ( RtlLargeIntegerShiftRight\() S 
2400 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.ByteOffset,) S 
2400 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->) S 
2400 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ByteShiftToSector\).LowPart;) S 
2400 11160 P () S 480 J ( IoStartPacket\() S 
2400 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->DeviceObject,) S 
2400 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp,) S 
2400 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &firstSectorOfRequest,) S 
2400 12200 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( NULL\);) S 
2400 12460 P () S 480 J ( return) S 144 J ( STATUS_PENDING;) S 
2400 12720 P (}) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (20) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2180 P 0 12 F 24 12 F (Like) S 60 J ( the) S 60 J ( DispatchRead) S 60 J ( routine) S 60 J ( described) S 60 J ( in) S 60 J ( Section) S 60 J ( 6.4.1,) S 60 J ( this) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( first) S 
1200 2440 P (calls) S 60 J ( ) S 0 12 F 24 12 F B (IoGetCurrentStackLocation) S E 0 12 F 24 12 F () S 60 J ( and) S 60 J ( checks) S 60 J ( the) S 60 J ( validity) S 60 J ( of) S 60 J ( parameters) S 60 J ( in) S 60 J ( the) S 60 J ( driver's) S 60 J ( I/O) S 
1200 2700 P (stack) S 60 J ( location.) S 60 J ( If) S 60 J ( it) S 60 J ( finds) S 60 J ( an) S 60 J ( error,) S 60 J ( it) S 60 J ( sets) S 60 J ( the) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( and) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 
1200 2960 P 0 12 F 24 12 F (with) S 60 J ( the) S 60 J ( IRP) S 60 J ( and) S 60 J ( a) S 60 J ( ) S 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( of) S 60 J ( IO_NO_INCREMENT.) S 
1200 3340 P (Otherwise,) S 60 J ( it) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoMarkIrpPending) S E 0 12 F 24 12 F (,) S 60 J ( queues) S 60 J ( the) S 60 J ( request) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F (,) S 60 J ( and) S 60 J ( returns) S 
1200 3600 P (STATUS_PENDING.) S 60 J ( Note) S 60 J ( that) S 60 J ( this) S 60 J ( driver) S 60 J ( controls) S 60 J ( the) S 60 J ( order) S 60 J ( in) S 60 J ( which) S 60 J ( IRPs) S 60 J ( are) S 60 J ( queued) S 60 J ( to) S 60 J ( its) S 
1200 3860 P (device) S 60 J ( \() S 0 12 F 0 12 F (&firstSectorOfRequest) S 0 12 F 24 12 F (\)) S 60 J ( for) S 60 J ( faster) S 60 J ( I/O) S 60 J ( throughput.) S 
1200 4240 P (Another) S 60 J ( routine) S 60 J ( in) S 60 J ( the) S 60 J ( driver) S 60 J ( dequeues) S 60 J ( the) S 60 J ( IRP) S 60 J ( later,) S 60 J ( determines) S 60 J ( whether) S 60 J ( the) S 60 J ( requested) S 60 J ( length) S 
1200 4500 P (must) S 60 J ( be) S 60 J ( split) S 60 J ( into) S 60 J ( partial) S 60 J ( transfer) S 60 J ( operations,) S 60 J ( and) S 60 J ( programs) S 60 J ( the) S 60 J ( device) S 60 J ( to) S 60 J ( transfer) S 60 J ( data.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (21) S E B () S 720 J ( ) S E 
1920 2080 P 0 12 F 8 12 F B (6.4.3) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( DispatchReadWrite) S 67 J ( Routines) S 67 J ( in) S 67 J ( Higher-level) S 67 J ( Drivers) S E 
1920 2700 P 0 12 F 24 12 F (Both) S 60 J ( the) S 60 J ( preceding) S 60 J ( Dispatch) S 60 J ( routines) S 60 J ( returned) S 60 J ( STATUS_PENDING) S 60 J ( for) S 60 J ( and) S 60 J ( queued) S 60 J ( IRPs) S 60 J ( with) S 
1920 2960 P (valid) S 60 J ( parameters.) S 60 J ( However,) S 60 J ( an) S 60 J ( intermediate) S 60 J ( or) S 60 J ( highest-level) S 60 J ( driver) S 60 J ( layered) S 60 J ( over) S 60 J ( the) S 60 J ( "AT") S 60 J ( disk) S 
1920 3220 P (driver) S 60 J ( described) S 60 J ( in) S 60 J ( Section) S 60 J ( 6.4.2) S 60 J ( might) S 60 J ( not) S 60 J ( queue) S 60 J ( IRPs.) S 60 J ( Instead,) S 60 J ( it) S 60 J ( can) S 60 J ( call) S 
1920 3480 P 0 12 F 24 12 F B (IoGetNextIrpStackLocation) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( get) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( next-lower-level) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 
1920 3740 P (location) S 60 J ( in) S 60 J ( the) S 60 J ( IRP,) S 60 J ( copy) S 60 J ( the) S 60 J ( parameters) S 60 J ( for) S 60 J ( the) S 60 J ( request) S 60 J ( from) S 60 J ( its) S 60 J ( own) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( to) S 60 J ( the) S 
1920 4000 P (next-lower) S 60 J ( driver's,) S 60 J ( and) S 60 J ( pass) S 60 J ( the) S 60 J ( IRP) S 60 J ( on) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F (.) S 60 J ( Such) S 60 J ( a) S 60 J ( driver) S 60 J ( might) S 60 J ( or) S 60 J ( might) S 60 J ( not) S 
1920 4260 P (call) S 60 J ( ) S 0 12 F 24 12 F B (IoSetCompletionRoutine) S E 0 12 F 24 12 F () S 60 J ( before) S 60 J ( passing) S 60 J ( the) S 60 J ( IRP) S 60 J ( on,) S 60 J ( depending) S 60 J ( on) S 60 J ( the) S 60 J ( operation) S 60 J ( and) S 60 J ( on) S 
1920 4520 P (the) S 60 J ( design) S 60 J ( of) S 60 J ( the) S 60 J ( drivers) S 60 J ( in) S 60 J ( its) S 60 J ( chain.) S 
1920 4900 P (For) S 60 J ( example,) S 60 J ( a) S 60 J ( SCSI) S 60 J ( floppy) S 60 J ( driver) S 60 J ( is) S 60 J ( a) S 60 J ( true) S 60 J ( NT) S 60 J ( intermediate) S 60 J ( driver,) S 60 J ( layered) S 60 J ( somewhere) S 60 J ( below) S 
1920 5160 P (an) S 60 J ( FSD) S 60 J ( and) S 60 J ( above) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( SCSI) S 60 J ( port) S 60 J ( driver.) S 60 J ( A) S 60 J ( SCSI) S 60 J ( floppy) S 60 J ( driver's) S 
1920 5420 P (DispatchReadWrite) S 60 J ( routine) S 60 J ( is) S 60 J ( somewhat) S 60 J ( similar) S 60 J ( to) S 60 J ( the) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver's) S 60 J ( shown) S 60 J ( in) S 60 J ( Section) S 
1920 5680 P (6.4.2,) S 60 J ( except) S 60 J ( this) S 60 J ( driver) S 60 J ( must) S 60 J ( handle) S 60 J ( removable) S 60 J ( media) S 60 J ( and) S 60 J ( certain) S 60 J ( additional) S 60 J ( requirements) S 60 J ( as) S 
1920 5940 P (an) S 60 J ( NT) S 60 J ( SCSI) S 60 J ( class) S 60 J ( driver.) S 
1920 6320 P (In) S 60 J ( particular,) S 60 J ( any) S 60 J ( SCSI) S 60 J ( class) S 60 J ( driver's) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( is) S 60 J ( responsible) S 60 J ( for) S 60 J ( splitting) S 60 J ( up) S 
1920 6580 P (large) S 60 J ( transfer) S 60 J ( requests,) S 60 J ( if) S 60 J ( necessary,) S 60 J ( before) S 60 J ( it) S 60 J ( sends) S 60 J ( an) S 60 J ( IRP) S 60 J ( with) S 60 J ( the) S 60 J ( major) S 60 J ( function) S 60 J ( code) S 
1920 6840 P (IRP_MJ_READ) S 60 J ( or) S 60 J ( IRP_MJ_WRITE) S 60 J ( to) S 60 J ( the) S 60 J ( SCSI) S 60 J ( port/miniport) S 60 J ( driver) S 60 J ( pair.) S 60 J ( For) S 60 J ( more) S 
1920 7100 P (information) S 60 J ( about) S 60 J ( handling) S 60 J ( removable) S 60 J ( media,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
1920 7360 P (requirements) S 60 J ( for) S 60 J ( SCSI) S 60 J ( class) S 60 J ( drivers) S 60 J ( and) S 60 J ( about) S 60 J ( how) S 60 J ( to) S 60 J ( split) S 60 J ( up) S 60 J ( a) S 60 J ( large) S 60 J ( transfer) S 60 J ( request,) S 60 J ( see) S 
1920 7620 P (Appendix) S 60 J ( B) S 60 J ( and) S 60 J ( the) S 60 J ( section) S 60 J ( on) S 60 J ( adapter) S 60 J ( objects) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 3.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (22) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (The) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( of) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( that) S 60 J ( sets) S 60 J ( up) S 60 J ( its) S 60 J ( device) S 60 J ( objects) S 60 J ( for) S 
1200 2320 P (direct) S 60 J ( I/O) S 60 J ( should) S 60 J ( have) S 60 J ( code) S 60 J ( similar) S 60 J ( to) S 60 J ( a) S 60 J ( SCSI) S 60 J ( floppy) S 60 J ( driver's,) S 60 J ( as) S 60 J ( follows:) S 
1680 2840 P 0 12 F 0 12 F ({) S 
1680 3100 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
1680 3620 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
1680 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
1680 4140 P () S 480 J ( ULONG) S 144 J ( transferByteCount) S 144 J ( =) S 144 J ( irpSp->Parameters.Read.Length;) S 
1680 4400 P () S 480 J ( LARGE_INTEGER) S 144 J ( startingOffset) S 144 J ( =) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.Read.ByteOffset;) S 
1680 4920 P () S 480 J ( ULONG) S 144 J ( maxTransferLength) S 144 J ( =) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->PortCapabilities->) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( MaximumTransferLength;) S 
1680 5700 P () S 480 J ( ULONG) S 144 J ( transferPages;) S 
1680 5960 P () S 480 J ( NTSTATUS) S 144 J ( status;) S 
1680 6220 P (//) S 
1680 6480 P (//) S 144 J ( Check) S 144 J ( whether) S 144 J ( the) S 144 J ( media) S 144 J ( might've) S 144 J ( been) S 144 J ( changed.) S 
1680 6740 P (//) S 
1680 7000 P () S 480 J ( if) S 144 J ( \(\(DeviceObject->Flags) S 144 J ( &) S 144 J ( DO_VERIFY_VOLUME\)) S 144 J ( &&) S 
1680 7260 P () S 480 J ( ) S 480 J ( !\(irpSp->Flags) S 144 J ( &) S 144 J ( SL_OVERRIDE_VERIFY_VOLUME\)\)) S 144 J ( {) S 
1680 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( return) S 144 J ( STATUS_VERIFY_REQUIRED;) S 
1680 8040 P () S 480 J ( }) S 
1680 8300 P () S 480 J ( IoMarkIrpPending\(Irp\);) S 
1680 8560 P (//) S 
1680 8820 P (//) S 144 J ( Add) S 144 J ( partition) S 144 J ( byte) S 144 J ( offset) S 144 J ( to) S 144 J ( make) S 144 J ( starting) S 144 J ( byte) S 144 J ( relative) S 
1680 9080 P (//) S 144 J ( to) S 144 J ( the) S 144 J ( beginning) S 144 J ( of) S 144 J ( the) S 144 J ( diskette.) S 
1680 9340 P (//) S 
1680 9600 P () S 480 J ( irpSp->Parameters.Read.ByteOffset) S 144 J ( =) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( RtlLargeIntegerAdd\() S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( startingOffset,) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->StartingOffset\);) S 
1680 10640 P (//) S 
1680 10900 P (//) S 144 J ( Check) S 144 J ( whether) S 144 J ( requested) S 144 J ( transfer) S 144 J ( exceeds) S 144 J ( the) S 144 J ( underlying) S 
1680 11160 P (//) S 144 J ( device's) S 144 J ( ability) S 144 J ( to) S 144 J ( transfer) S 144 J ( data.) S 
1680 11420 P (//) S 
1680 11680 P () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (23) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( transferPages) S 144 J ( =) S 144 J ( ADDRESS_AND_SIZE_TO_SPAN_PAGES\() S 
2400 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( MmGetMdlVirtualAddress\(Irp->MdlAddress\),) S 
2400 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( transferByteCount\);) S 
2400 2840 P () S 480 J ( if) S 144 J ( \(\(transferByteCount) S 144 J ( >) S 144 J ( maxTransferLength\)) S 144 J ( ||) S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(transferPages) S 144 J ( >) S 144 J ( deviceExtension->) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( PortCapabilities->MaximumPhysicalPages\)\)) S 144 J ( {) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
2400 3880 P () S 480 J ( ) S 480 J ( SplitRequest\(DeviceObject,) S 144 J ( Irp,) S 144 J ( maxTransferLength\);) S 
2400 4140 P () S 480 J ( ) S 480 J ( return) S 144 J ( STATUS_PENDING;) S 
2400 4400 P () S 480 J ( }) S 
2400 4660 P (}) S 
2400 4920 P (//) S 
2400 5180 P (//) S 144 J ( Since) S 144 J ( the) S 144 J ( requested) S 144 J ( transfer) S 144 J ( does) S 144 J ( not) S 144 J ( exceed) S 144 J ( the) S 144 J ( capacity) S 
2400 5440 P (//) S 144 J ( of) S 144 J ( the) S 144 J ( underlying) S 144 J ( device,) S 144 J ( set) S 144 J ( up) S 144 J ( the) S 144 J ( next-lower) S 144 J ( driver's) S 
2400 5700 P (//) S 144 J ( I/O) S 144 J ( stack) S 144 J ( location) S 144 J ( in) S 144 J ( the) S 144 J ( IRP.) S 144 J ( \(BuildRequest) S 144 J ( calls) S 
2400 5960 P (//) S 144 J ( IoGetNextIrpStackLocation.\)) S 
2400 6220 P (//) S 
2400 6480 P () S 480 J ( BuildRequest\(deviceExtension->PortDeviceObject,) S 144 J ( Irp\);) S 
2400 6740 P (//) S 
2400 7000 P (//) S 144 J ( Return) S 144 J ( the) S 144 J ( results) S 144 J ( of) S 144 J ( calling) S 144 J ( the) S 144 J ( underlying) S 
2400 7260 P (//) S 144 J ( port/miniport) S 144 J ( drivers) S 144 J ( to) S 144 J ( process) S 144 J ( the) S 144 J ( request.) S 
2400 7520 P (//) S 
2400 7780 P () S 480 J ( return) S 144 J ( IoCallDriver\() S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->PortDeviceObject,) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp\);) S 
2400 8560 P (}) S 
1920 8940 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( the) S 60 J ( internal) S 60 J ( BuildRequest) S 60 J ( and) S 60 J ( SplitRequest) S 60 J ( routines) S 60 J ( called) S 60 J ( by) S 60 J ( the) S 60 J ( preceding) S 
1920 9200 P (DispatchReadWrite) S 60 J ( each) S 60 J ( register) S 60 J ( an) S 60 J ( IoCompletion) S 60 J ( routine) S 60 J ( with) S 60 J ( each) S 60 J ( request) S 60 J ( to) S 60 J ( transfer) S 60 J ( data.) S 
1920 9460 P (The) S 60 J ( IoCompletion) S 60 J ( routine) S 60 J ( set) S 60 J ( by) S 60 J ( BuildRequest) S 60 J ( can) S 60 J ( retry) S 60 J ( transfer) S 60 J ( requests) S 60 J ( that) S 60 J ( are) S 60 J ( failed) S 60 J ( before) S 
1920 9720 P (completing) S 60 J ( the) S 60 J ( IRP.) S 
1920 10100 P (The) S 60 J ( internal) S 60 J ( SplitRequest) S 60 J ( routine) S 60 J ( must) S 60 J ( allocate) S 60 J ( one) S 60 J ( or) S 60 J ( more) S 60 J ( IRPs,) S 60 J ( which) S 60 J ( it) S 60 J ( sets) S 60 J ( up) S 60 J ( for) S 60 J ( the) S 
1920 10360 P (next-lower) S 60 J ( driver,) S 60 J ( to) S 60 J ( request) S 60 J ( some) S 60 J ( number) S 60 J ( of) S 60 J ( partial) S 60 J ( transfers.) S 60 J ( Consequently,) S 60 J ( the) S 60 J ( SplitRequest) S 
1920 10620 P (routine) S 60 J ( also) S 60 J ( registers) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( IoCompletion) S 60 J ( routine) S 60 J ( to) S 60 J ( track) S 60 J ( how) S 60 J ( much) S 60 J ( data) S 60 J ( is) S 
1920 10880 P (transferred) S 60 J ( in) S 60 J ( each) S 60 J ( partial) S 60 J ( transfer) S 60 J ( operation) S 60 J ( so) S 60 J ( that) S 60 J ( the) S 60 J ( IoCompletion) S 60 J ( routine) S 60 J ( can) S 60 J ( release) S 60 J ( any) S 
1920 11140 P (driver-allocated) S 60 J ( IRPs) S 60 J ( and,) S 60 J ( eventually,) S 60 J ( complete) S 60 J ( the) S 60 J ( original) S 60 J ( request.) S 60 J ( If) S 60 J ( the) S 60 J ( underlying) S 60 J ( NT) S 
1920 11400 P (SCSI) S 60 J ( port) S 60 J ( driver) S 60 J ( returns) S 60 J ( an) S 60 J ( IRP) S 60 J ( for) S 60 J ( a) S 60 J ( partial) S 60 J ( transfer) S 60 J ( with) S 60 J ( an) S 60 J ( error,) S 60 J ( the) S 60 J ( floppy) S 60 J ( class) S 60 J ( driver's) S 
1920 11660 P (IoCompletion) S 60 J ( routine) S 60 J ( either) S 60 J ( retries) S 60 J ( the) S 60 J ( partial) S 60 J ( transfer) S 60 J ( request) S 60 J ( or) S 60 J ( completes) S 60 J ( the) S 60 J ( original) S 60 J ( IRP) S 
1920 11920 P (with) S 60 J ( its) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( set) S 60 J ( with) S 60 J ( the) S 60 J ( returned) S 60 J ( error,) S 60 J ( after) S 60 J ( freeing) S 60 J ( any) S 60 J ( IRPs) S 60 J ( and) S 60 J ( memory) S 60 J ( the) S 
1920 12180 P (SCSI) S 60 J ( floppy) S 60 J ( driver) S 60 J ( has) S 60 J ( allocated.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (24) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2080 P 0 12 F 8 12 F B (6.4.4) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( Points) S 67 J ( to) S 67 J ( Consider) S 67 J ( in) S 67 J ( Implementing) S 67 J ( DispatchReadWrite) S E 
1200 2700 P 0 12 F 24 12 F (Keep) S 60 J ( the) S 60 J ( following) S 60 J ( points) S 60 J ( in) S 60 J ( mind) S 60 J ( when) S 60 J ( implementing) S 60 J ( a) S 60 J ( DispatchRead,) S 60 J ( DispatchWrite,) S 60 J ( or) S 
1200 2960 P (DispatchReadWrite) S 60 J ( routine:) S 
1200 3280 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( It) S 60 J ( is) S 60 J ( the) S 60 J ( responsiblity) S 60 J ( of) S 60 J ( the) S 60 J ( highest-level) S 60 J ( driver) S 60 J ( in) S 60 J ( a) S 60 J ( chain) S 60 J ( of) S 60 J ( layered) S 60 J ( drivers) S 60 J ( to) S 60 J ( check) S 60 J ( the) S 
1680 3540 P (parameters) S 60 J ( of) S 60 J ( incoming) S 60 J ( read/write) S 60 J ( IRPs) S 60 J ( for) S 60 J ( validity) S 60 J ( before) S 60 J ( setting) S 60 J ( up) S 60 J ( the) S 60 J ( next-lower-) S 
1680 3800 P (level) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( in) S 60 J ( an) S 60 J ( IRP.) S 
1200 4120 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Intermediate) S 60 J ( and) S 60 J ( lowest-level) S 60 J ( drivers) S 60 J ( generally) S 60 J ( can) S 60 J ( rely) S 60 J ( on) S 60 J ( the) S 60 J ( highest-level) S 60 J ( driver) S 60 J ( in) S 
1680 4380 P (their) S 60 J ( chain) S 60 J ( to) S 60 J ( pass) S 60 J ( down) S 60 J ( transfer) S 60 J ( requests) S 60 J ( with) S 60 J ( valid) S 60 J ( parameters.) S 60 J ( However,) S 60 J ( any) S 60 J ( driver) S 60 J ( can) S 
1680 4640 P (perform) S 60 J ( sanity) S 60 J ( checks) S 60 J ( on) S 60 J ( the) S 60 J ( parameters) S 60 J ( in) S 60 J ( its) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( of) S 60 J ( an) S 60 J ( IRP,) S 60 J ( and) S 60 J ( each) S 
1680 4900 P (device) S 60 J ( driver) S 60 J ( should) S 60 J ( check) S 60 J ( the) S 60 J ( parameters) S 60 J ( for) S 60 J ( conditions) S 60 J ( that) S 60 J ( might) S 60 J ( violate) S 60 J ( any) S 
1680 5160 P (restrictions) S 60 J ( imposed) S 60 J ( by) S 60 J ( the) S 60 J ( device.) S 
1200 5480 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( a) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( completes) S 60 J ( an) S 60 J ( IRP) S 60 J ( with) S 60 J ( an) S 60 J ( error,) S 60 J ( it) S 60 J ( should) S 60 J ( set) S 60 J ( the) S 60 J ( I/O) S 
1680 5740 P (stack) S 60 J ( location) S 60 J ( ) S 0 12 F 24 12 F B (Status) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( with) S 60 J ( an) S 60 J ( appropriate) S 60 J ( NTSTATUS-type) S 60 J ( value,) S 60 J ( set) S 60 J ( the) S 
1680 6000 P 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( to) S 60 J ( zero,) S 60 J ( and) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( IRP) S 60 J ( and) S 60 J ( a) S 
1680 6260 P 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( of) S 60 J ( IO_NO_INCREMENT.) S 
1200 6580 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( a) S 60 J ( driver) S 60 J ( uses) S 60 J ( buffered) S 60 J ( I/O,) S 60 J ( it) S 60 J ( might) S 60 J ( need) S 60 J ( to) S 60 J ( define) S 60 J ( a) S 60 J ( structure) S 60 J ( to) S 60 J ( contain) S 60 J ( data) S 60 J ( to) S 60 J ( be) S 
1680 6840 P (transferred) S 60 J ( and) S 60 J ( might) S 60 J ( need) S 60 J ( to) S 60 J ( buffer) S 60 J ( some) S 60 J ( number) S 60 J ( of) S 60 J ( these) S 60 J ( structures) S 60 J ( internally.) S 
1200 7160 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( a) S 60 J ( driver) S 60 J ( uses) S 60 J ( direct) S 60 J ( I/O,) S 60 J ( it) S 60 J ( might) S 60 J ( need) S 60 J ( to) S 60 J ( check) S 60 J ( whether) S 60 J ( the) S 60 J ( MDL) S 60 J ( at) S 60 J ( ) S 0 12 F 24 12 F B (Irp->MdlAddress) S E 
1680 7420 P 0 12 F 24 12 F (describes) S 60 J ( a) S 60 J ( buffer) S 60 J ( containing) S 60 J ( too) S 60 J ( much) S 60 J ( data) S 60 J ( \(or) S 60 J ( too) S 60 J ( many) S 60 J ( page) S 60 J ( breaks\)) S 60 J ( for) S 60 J ( the) S 60 J ( underlying) S 
1680 7680 P (device) S 60 J ( to) S 60 J ( handle) S 60 J ( in) S 60 J ( a) S 60 J ( single) S 60 J ( transfer) S 60 J ( operation.) S 60 J ( If) S 60 J ( so,) S 60 J ( the) S 60 J ( driver) S 60 J ( must) S 60 J ( split) S 60 J ( up) S 60 J ( the) S 60 J ( original) S 
1680 7940 P (transfer) S 60 J ( request) S 60 J ( into) S 60 J ( a) S 60 J ( sequence) S 60 J ( of) S 60 J ( smaller) S 60 J ( transfer) S 60 J ( operations.) S 
1680 8260 P (A) S 60 J ( device) S 60 J ( driver's) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( can) S 60 J ( postpone) S 60 J ( splitting) S 60 J ( a) S 60 J ( large) S 60 J ( transfer) S 
1680 8520 P (request) S 60 J ( until) S 60 J ( another) S 60 J ( driver) S 60 J ( routine) S 60 J ( dequeues) S 60 J ( the) S 60 J ( IRP.) S 60 J ( A) S 60 J ( class) S 60 J ( driver) S 60 J ( might) S 60 J ( split) S 60 J ( up) S 60 J ( such) S 60 J ( a) S 
1680 8780 P (request) S 60 J ( in) S 60 J ( its) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( for) S 60 J ( the) S 60 J ( underlying) S 60 J ( port) S 60 J ( driver.) S 60 J ( \(SCSI) S 60 J ( class) S 
1680 9040 P (drivers) S 60 J ( for) S 60 J ( mass) S 60 J ( storage) S 60 J ( devices) S 60 J ( are) S 60 J ( required) S 60 J ( to) S 60 J ( do) S 60 J ( this.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
1680 9300 P (requirements) S 60 J ( for) S 60 J ( SCSI) S 60 J ( drivers,) S 60 J ( see) S 60 J ( Appendix) S 60 J ( B.\)) S 
1200 9620 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( driver) S 60 J ( queues) S 60 J ( the) S 60 J ( IRP) S 60 J ( for) S 60 J ( further) S 60 J ( processing) S 60 J ( by) S 60 J ( its) S 60 J ( own) S 60 J ( routines) S 60 J ( or) S 60 J ( passes) S 60 J ( the) S 60 J ( IRP,) S 
1680 9880 P (it) S 60 J ( must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoMarkIrpPending) S E 0 12 F 24 12 F () S 60 J ( before) S 60 J ( it) S 60 J ( queues) S 60 J ( the) S 60 J ( IRP.) S 60 J ( The) S 60 J ( DispatchReadWrite) S 
1680 10140 P (routine) S 60 J ( should) S 60 J ( return) S 60 J ( control) S 60 J ( with) S 60 J ( STATUS_PENDING,) S 60 J ( as) S 60 J ( well.) S 60 J ( A) S 60 J ( higher-level) S 60 J ( driver's) S 
1680 10400 P (DispatchReadWrite) S 60 J ( routine) S 60 J ( should) S 60 J ( not) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoMarkIrpPending) S E 0 12 F 24 12 F () S 60 J ( nor) S 60 J ( return) S 
1680 10660 P (STATUS_PENDING) S 60 J ( unless) S 60 J ( it) S 60 J ( has) S 60 J ( queued) S 60 J ( the) S 60 J ( IRP) S 60 J ( for) S 60 J ( further) S 60 J ( processing) S 60 J ( itself.) S 
1200 10980 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( the) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( passes) S 60 J ( an) S 60 J ( IRP) S 60 J ( on) S 60 J ( to) S 60 J ( lower) S 60 J ( drivers,) S 60 J ( it) S 60 J ( must) S 60 J ( set) S 60 J ( up) S 60 J ( the) S 60 J ( I/O) S 
1680 11240 P (stack) S 60 J ( location) S 60 J ( for) S 60 J ( the) S 60 J ( next-lower) S 60 J ( driver) S 60 J ( in) S 60 J ( the) S 60 J ( IRP.) S 60 J ( Whether) S 60 J ( the) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( also) S 
1680 11500 P (sets) S 60 J ( an) S 60 J ( IoCompletion) S 60 J ( routine) S 60 J ( in) S 60 J ( the) S 60 J ( IRP) S 60 J ( before) S 60 J ( passing) S 60 J ( it) S 60 J ( on) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F () S 60 J ( depends) S 
1680 11760 P (on) S 60 J ( the) S 60 J ( design) S 60 J ( of) S 60 J ( the) S 60 J ( driver) S 60 J ( and) S 60 J ( of) S 60 J ( those) S 60 J ( layered) S 60 J ( under) S 60 J ( it.) S 60 J ( However,) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver) S 
1680 12020 P (must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoSetCompletionRoutine) S E 0 12 F 24 12 F () S 60 J ( before) S 60 J ( it) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F () S 60 J ( if) S 60 J ( it) S 60 J ( allocates) S 60 J ( any) S 
1680 12280 P (resources) S 60 J ( \(such) S 60 J ( as) S 60 J ( IRPs) S 60 J ( or) S 60 J ( memory\),) S 60 J ( which) S 60 J ( its) S 60 J ( IoCompletion) S 60 J ( routine) S 60 J ( must) S 60 J ( free) S 60 J ( when) S 
1680 12540 P (lower) S 60 J ( drivers) S 60 J ( have) S 60 J ( completed) S 60 J ( the) S 60 J ( request) S 60 J ( but) S 60 J ( before) S 60 J ( the) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( completes) S 60 J ( the) S 
1680 12800 P (original) S 60 J ( IRP.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (25) S E B () S 720 J ( ) S E 
1920 2120 P 0 12 F 8 14 F B (6.5) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Implementing) S 78 J ( a) S 78 J ( Dispatch\(Internal\)DeviceControl) S 78 J ( Routine) S E 
1920 2740 P 0 12 F 24 12 F (For) S 60 J ( every) S 60 J ( common) S 60 J ( type) S 60 J ( of) S 60 J ( peripheral) S 60 J ( device,) S 60 J ( the) S 60 J ( system) S 60 J ( defines) S 60 J ( a) S 60 J ( set) S 60 J ( of) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( for) S 
1920 3000 P (device) S 60 J ( control) S 60 J ( requests) S 60 J ( that) S 60 J ( new) S 60 J ( drivers) S 60 J ( for) S 60 J ( each) S 60 J ( type) S 60 J ( of) S 60 J ( device) S 60 J ( must) S 60 J ( support.) S 60 J ( In) S 60 J ( most) S 60 J ( cases,) S 
1920 3260 P (the) S 60 J ( system-defined) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( for) S 60 J ( a) S 60 J ( given) S 60 J ( type) S 60 J ( of) S 60 J ( device) S 60 J ( are) S 60 J ( not) S 60 J ( exported) S 60 J ( to) S 60 J ( user-mode) S 
1920 3520 P (applications.) S 60 J ( The) S 60 J ( only) S 60 J ( exceptions) S 60 J ( to) S 60 J ( this) S 60 J ( are) S 60 J ( a) S 60 J ( subset) S 60 J ( of) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( for) S 60 J ( disk) S 60 J ( and) S 60 J ( serial) S 
1920 3780 P (drivers,) S 60 J ( which) S 60 J ( are) S 60 J ( exported) S 60 J ( for) S 60 J ( use) S 60 J ( by) S 60 J ( disk-management) S 60 J ( applications) S 60 J ( or) S 60 J ( for) S 60 J ( use) S 60 J ( by) S 60 J ( comm) S 
1920 4040 P (applications.) S 
1920 4420 P (Some) S 60 J ( of) S 60 J ( the) S 60 J ( system-defined) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( are) S 60 J ( used) S 60 J ( by) S 60 J ( higher-level) S 60 J ( NT) S 60 J ( drivers) S 60 J ( that) S 60 J ( create) S 
1920 4680 P (IRPs) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (IoBuildDeviceIoControlRequest) S E 0 12 F 24 12 F () S 60 J ( for) S 60 J ( the) S 60 J ( underlying) S 60 J ( device) S 60 J ( driver.) S 60 J ( Others) S 60 J ( are) S 60 J ( used) S 
1920 4940 P (by) S 60 J ( Win32) S 60 J ( drivers) S 60 J ( or) S 60 J ( particular) S 60 J ( Win32) S 60 J ( components) S 60 J ( to) S 60 J ( communicate) S 60 J ( with) S 60 J ( an) S 60 J ( underlying) S 60 J ( device) S 
1920 5200 P (driver) S 60 J ( by) S 60 J ( calling) S 60 J ( the) S 60 J ( Win32) S 60 J ( function) S 60 J ( ) S 0 12 F 24 12 F B (DeviceIoControl) S E 0 12 F 24 12 F (.) S 60 J ( In) S 60 J ( turn,) S 60 J ( this) S 60 J ( Win32) S 60 J ( function) S 60 J ( calls) S 60 J ( an) S 
1920 5460 P (NT) S 60 J ( system) S 60 J ( service,) S 60 J ( and) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( sets) S 60 J ( up) S 60 J ( an) S 60 J ( IRP) S 60 J ( with) S 60 J ( the) S 60 J ( major) S 60 J ( function) S 60 J ( code) S 
1920 5720 P (IRP_MJ_DEVICE_CONTROL) S 60 J ( and) S 60 J ( the) S 60 J ( given) S 60 J ( I/O) S 60 J ( control) S 60 J ( code) S 60 J ( in) S 60 J ( the) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( at) S 
1920 5980 P 0 12 F 24 12 F B (Parameters.DeviceIoControl.IoControlCode) S E 0 12 F 24 12 F (.) S 60 J ( Then,) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( calls) S 60 J ( the) S 
1920 6240 P (DispatchDeviceControl) S 60 J ( routine) S 60 J ( of) S 60 J ( the) S 60 J ( highest-level) S 60 J ( driver) S 60 J ( in) S 60 J ( the) S 60 J ( chain) S 60 J ( with) S 60 J ( the) S 60 J ( IRP.) S 
1920 6620 P (Most) S 60 J ( of) S 60 J ( the) S 60 J ( system-defined) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( are) S 60 J ( set) S 60 J ( up) S 60 J ( to) S 60 J ( use) S 60 J ( buffered) S 60 J ( I/O,) S 60 J ( because) S 60 J ( this) S 60 J ( type) S 
1920 6880 P (of) S 60 J ( request) S 60 J ( seldom) S 60 J ( requires) S 60 J ( the) S 60 J ( transfer) S 60 J ( of) S 60 J ( large) S 60 J ( amounts) S 60 J ( of) S 60 J ( data.) S 60 J ( That) S 60 J ( is,) S 60 J ( even) S 60 J ( drivers) S 60 J ( that) S 60 J ( set) S 
1920 7140 P (up) S 60 J ( their) S 60 J ( device) S 60 J ( objects) S 60 J ( for) S 60 J ( direct) S 60 J ( I/O) S 60 J ( usually) S 60 J ( are) S 60 J ( sent) S 60 J ( IRPs) S 60 J ( for) S 60 J ( device) S 60 J ( control) S 60 J ( requests) S 60 J ( with) S 
1920 7400 P (data) S 60 J ( to) S 60 J ( be) S 60 J ( transferred) S 60 J ( in\(to\)) S 60 J ( the) S 60 J ( buffer) S 60 J ( at) S 60 J ( ) S 0 12 F 24 12 F B (Irp->AssociatedIrp.SystemBuffer) S E 0 12 F 24 12 F (.) S 60 J ( For) S 60 J ( specific) S 
1920 7660 P (information) S 60 J ( about) S 60 J ( the) S 60 J ( set) S 60 J ( of) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( that) S 60 J ( different) S 60 J ( kinds) S 60 J ( of) S 60 J ( NT) S 60 J ( drivers) S 60 J ( must) S 60 J ( support,) S 
1920 7920 P (see) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F I (Kernel-mode) S 60 J ( Driver) S 60 J ( Reference) S E 0 12 F 24 12 F (.) S 60 J ( Note) S 60 J ( that) S 60 J ( certain) S 60 J ( types) S 60 J ( of) S 60 J ( new) S 60 J ( NT) S 60 J ( device) S 60 J ( drivers) S 60 J ( also) S 
1920 8180 P (must) S 60 J ( handle) S 60 J ( IRP_MJ_INTERNAL_DEVICE_CONTROL) S 60 J ( requests) S 60 J ( if) S 60 J ( they) S 60 J ( interoperate) S 60 J ( with) S 
1920 8440 P (system-supplied) S 60 J ( drivers.) S 
1920 8820 P (The) S 60 J ( following) S 60 J ( subsections) S 60 J ( show) S 60 J ( how) S 60 J ( a) S 60 J ( representative) S 60 J ( set) S 60 J ( of) S 60 J ( NT) S 60 J ( drivers) S 60 J ( would) S 60 J ( handle) S 60 J ( the) S 
1920 9080 P (receipt) S 60 J ( of) S 60 J ( a) S 60 J ( device) S 60 J ( control) S 60 J ( request) S 60 J ( as) S 60 J ( a) S 60 J ( guide) S 60 J ( to) S 60 J ( implementing) S 60 J ( DispatchDeviceControl) S 60 J ( routines) S 
1920 9340 P (in) S 60 J ( new) S 60 J ( drivers.) S 60 J ( Section) S 60 J ( 6.5.4) S 60 J ( summarizes) S 60 J ( points) S 60 J ( to) S 60 J ( consider) S 60 J ( in) S 60 J ( implementing) S 60 J ( a) S 
1920 9600 P (DispatchDeviceControl) S 60 J ( or) S 60 J ( DispatchInternalDeviceControl) S 60 J ( routine.) S 
1920 10240 P 0 12 F 8 12 F B (6.5.1) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( DispatchDeviceControl) S 67 J ( Routines) S 67 J ( in) S 67 J ( Lowest-level) S 67 J ( Drivers) S E 
1920 10860 P 0 12 F 24 12 F (An) S 60 J ( IRP_MJ_DEVICE_CONTROL) S 60 J ( request) S 60 J ( for) S 60 J ( a) S 60 J ( lowest-level) S 60 J ( NT) S 60 J ( driver) S 60 J ( either) S 60 J ( requires) S 60 J ( the) S 
1920 11120 P (driver) S 60 J ( to) S 60 J ( change) S 60 J ( the) S 60 J ( state) S 60 J ( of) S 60 J ( its) S 60 J ( device) S 60 J ( or) S 60 J ( to) S 60 J ( return) S 60 J ( information) S 60 J ( about) S 60 J ( the) S 60 J ( state) S 60 J ( of) S 60 J ( its) S 60 J ( device.) S 
1920 11380 P (Because) S 60 J ( most) S 60 J ( kinds) S 60 J ( of) S 60 J ( drivers) S 60 J ( are) S 60 J ( required) S 60 J ( to) S 60 J ( handle) S 60 J ( a) S 60 J ( number) S 60 J ( of) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes,) S 60 J ( their) S 
1920 11640 P (DispatchDeviceControl) S 60 J ( routines) S 60 J ( usually) S 60 J ( contain) S 60 J ( a) S 60 J ( ) S 0 12 F 24 12 F B (switch) S E 0 12 F 24 12 F () S 60 J ( statement.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (26) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (For) S 60 J ( example,) S 60 J ( an) S 60 J ( NT) S 60 J ( device) S 60 J ( driver) S 60 J ( with) S 60 J ( a) S 60 J ( device-dedicated) S 60 J ( thread) S 60 J ( and) S 60 J ( an) S 60 J ( internal) S 60 J ( driver) S 60 J ( queue) S 
1200 2320 P (might) S 60 J ( have) S 60 J ( a) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( structured) S 60 J ( in) S 60 J ( a) S 60 J ( manner) S 60 J ( similar) S 60 J ( to) S 60 J ( a) S 60 J ( floppy) S 
1200 2580 P (driver's,) S 60 J ( as) S 60 J ( follows:) S 
1680 3100 P 0 12 F 0 12 F ({) S 
1680 3360 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
1680 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
1680 3880 P () S 480 J ( PDISKETTE_EXTENSION) S 144 J ( disketteExtension) S 144 J ( =) S 
1680 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
1680 4400 P () S 480 J ( PDISK_GEOMETRY) S 144 J ( outputBuffer;) S 
1680 4660 P () S 480 J ( NTSTATUS) S 144 J ( ntStatus;) S 
1680 4920 P () S 480 J ( ULONG) S 144 J ( outputBufferLength;) S 
1680 5180 P () S 480 J ( UCHAR) S 144 J ( i;) S 
1680 5440 P () S 480 J ( DRIVE_MEDIA_TYPE) S 144 J ( lowestDriveMediaType;) S 
1680 5700 P () S 480 J ( DRIVE_MEDIA_TYPE) S 144 J ( highestDriveMediaType;) S 
1680 5960 P (//) S 
1680 6220 P (//) S 144 J ( Switch) S 144 J ( on) S 144 J ( I/O) S 144 J ( control) S 144 J ( code) S 144 J ( in) S 144 J ( the) S 144 J ( IRP.) S 
1680 6480 P (//) S 
1680 6740 P () S 480 J ( switch\(irpSp->) S 
1680 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Parameters.DeviceIoControl.IoControlCode\)) S 144 J ( {) S 
1680 7260 P () S 480 J ( ) S 480 J ( case) S 144 J ( IOCTL_DISK_CHECK_VERIFY:) S 
1680 7520 P () S 480 J ( ) S 480 J ( case) S 144 J ( IOCTL_DISK_GET_DRIVE_GEOMETRY:) S 144 J ( {) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoMarkIrpPending\(Irp\);) S 
1680 8040 P (//) S 
1680 8300 P (//) S 144 J ( The) S 144 J ( thread) S 144 J ( must) S 144 J ( know) S 144 J ( which) S 144 J ( diskette) S 144 J ( to) S 144 J ( operate) S 144 J ( on) S 144 J ( but) S 
1680 8560 P (//) S 144 J ( the) S 144 J ( request) S 144 J ( list) S 144 J ( passes) S 144 J ( only) S 144 J ( the) S 144 J ( IRP,) S 144 J ( so) S 144 J ( stick) S 144 J ( a) S 144 J ( pointer) S 
1680 8820 P (//) S 144 J ( to) S 144 J ( the) S 144 J ( disketteExtension) S 144 J ( into) S 144 J ( the) S 144 J ( IRP's) S 144 J ( Type3InputBuffer,) S 
1680 9080 P (//) S 144 J ( which) S 144 J ( is) S 144 J ( an) S 144 J ( unused) S 144 J ( field) S 144 J ( for) S 144 J ( floppy) S 144 J ( IOCTL) S 144 J ( requests.) S 
1680 9340 P (//) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Parameters.DeviceIoControl.Type3InputBuffer) S 144 J ( =) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(PVOID\)disketteExtension;) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (27) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Queue) S 144 J ( the) S 144 J ( request) S 144 J ( and) S 144 J ( wake) S 144 J ( up) S 144 J ( the) S 144 J ( floppy) S 144 J ( thread) S 
2400 2580 P (//) S 144 J ( to) S 144 J ( process) S 144 J ( it.) S 
2400 2840 P (//) S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ExInterlockedInsertTailList\() S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &disketteExtension->) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerData->ListEntry,) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &Irp->Tail.Overlay.ListEntry,) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &disketteExtension->) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerData->ListSpinLock\);) S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( KeReleaseSemaphore\() S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &disketteExtension->) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerData->RequestSemaphore,) S 
2400 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(KPRIORITY\)) S 144 J ( 0,) S 
2400 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 1,) S 
2400 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( FALSE\);) S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ntStatus) S 144 J ( =) S 144 J ( STATUS_PENDING;) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 6740 P () S 480 J ( ) S 480 J ( }) S 
2400 7000 P () S 480 J ( ) S 480 J ( case) S 144 J ( IOCTL_DISK_FORMAT_TRACKS:) S 144 J ( {) S 
2400 7260 P (//) S 
2400 7520 P (//) S 144 J ( Make) S 144 J ( sure) S 144 J ( the) S 144 J ( IRP) S 144 J ( has) S 144 J ( all) S 144 J ( necessary) S 144 J ( format) S 144 J ( parameters.) S 
2400 7780 P (//) S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(irpSp->) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Parameters.DeviceIoControl.) S 
2400 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( InputBufferLength) S 144 J ( <) S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sizeof\(FORMAT_PARAMETERS\)\)) S 144 J ( {) S 
2400 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ntStatus) S 144 J ( =) S 144 J ( STATUS_INVALID_PARAMETER;) S 
2400 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
2400 9860 P (//) S 
2400 10120 P (//) S 144 J ( Make) S 144 J ( sure) S 144 J ( the) S 144 J ( parameters) S 144 J ( also) S 144 J ( are) S 144 J ( reasonable.) S 
2400 10380 P (//) S 
2400 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (28) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( Format) S 144 J ( parameters) S 144 J ( OK,) S 144 J ( so) S 144 J ( queue) S 144 J ( the) S 144 J ( request) S 144 J ( and) S 144 J ( wake) S 144 J ( up) S 
1680 2580 P (//) S 144 J ( the) S 144 J ( floppy) S 144 J ( thread) S 144 J ( to) S 144 J ( process) S 144 J ( it.) S 
1680 2840 P (//) S 
1680 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoMarkIrpPending\(Irp\);) S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 3620 P () S 480 J ( ) S 480 J ( }) S 
1680 3880 P () S 480 J ( ) S 480 J ( case) S 144 J ( IOCTL_DISK_GET_MEDIA_TYPES:) S 144 J ( {) S 
1680 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( lowestDriveMediaType) S 144 J ( =) S 144 J ( DriveMediaLimits[) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( disketteExtension->) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DriveType].LowestDriveMediaType;) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( highestDriveMediaType) S 144 J ( =) S 144 J ( DriveMediaLimits[) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( disketteExtension->) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DriveType].HighestDriveMediaType;) S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( outputBufferLength) S 144 J ( =) S 144 J ( irpSp->) S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Parameters.DeviceIoControl.) S 
1680 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( OutputBufferLength;) S 
1680 6480 P (//) S 
1680 6740 P (//) S 144 J ( Make) S 144 J ( sure) S 144 J ( the) S 144 J ( buffer) S 144 J ( has) S 144 J ( enough) S 144 J ( room) S 144 J ( to) S 144 J ( return) S 144 J ( at) S 144 J ( least) S 
1680 7000 P (//) S 144 J ( one) S 144 J ( description) S 144 J ( of) S 144 J ( a) S 144 J ( supported) S 144 J ( media) S 144 J ( type.) S 
1680 7260 P (//) S 
1680 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(outputBufferLength) S 144 J ( <) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(sizeof\(DISK_GEOMETRY\)\)\)) S 144 J ( {) S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ntStatus) S 144 J ( =) S 144 J ( STATUS_BUFFER_TOO_SMALL;) S 
1680 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
1680 8820 P (//) S 
1680 9080 P (//) S 144 J ( Assume) S 144 J ( success,) S 144 J ( although) S 144 J ( ntStatus) S 144 J ( might) S 144 J ( need) S 144 J ( to) S 144 J ( be) S 
1680 9340 P (//) S 144 J ( modified) S 144 J ( to) S 144 J ( warn) S 144 J ( of) S 144 J ( buffer) S 144 J ( overflow) S 144 J ( if) S 144 J ( the) S 144 J ( buffer) S 
1680 9600 P (//) S 144 J ( cannot) S 144 J ( hold) S 144 J ( ALL) S 144 J ( of) S 144 J ( the) S 144 J ( media) S 144 J ( descriptions.) S 
1680 9860 P (//) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ntStatus) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(outputBufferLength) S 144 J ( <) S 144 J ( \(sizeof\(DISK_GEOMETRY\)) S 144 J ( *) S 
1680 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(highestDriveMediaType) S 144 J ( -) S 144 J ( lowestDriveMediaType) S 
1680 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( +) S 144 J ( 1\)\)\)) S 144 J ( {) S 
1680 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ntStatus) S 144 J ( =) S 144 J ( STATUS_BUFFER_OVERFLOW;) S 
1680 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (29) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( ) S 480 J ( outputBuffer) S 144 J ( =) S 144 J ( \(PDISK_GEOMETRY\)) S 144 J ( Irp->) S 
2400 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AssociatedIrp.SystemBuffer;) S 
2400 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( for) S 144 J ( \() S 
2400 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( fill) S 144 J ( in) S 144 J ( supported) S 144 J ( media) S 144 J ( type) S 
2400 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->IoStatus.Information) S 144 J ( +=) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sizeof\(DISK_GEOMETRY\);) S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( for) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 4140 P () S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( case) S 144 J ( IOCTL_DISK_GET_MEDIA_TYPES) S 
2400 4400 P () S 480 J ( ) S 480 J ( default:) S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ntStatus) S 144 J ( =) S 144 J ( STATUS_INVALID_DEVICE_REQUEST;) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 5180 P () S 480 J ( ) S 480 J ( }) S 
2400 5440 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( switch) S 
2400 5700 P () S 480 J ( if) S 144 J ( \(ntStatus) S 144 J ( !=) S 144 J ( STATUS_PENDING\)) S 144 J ( {) S 
2400 5960 P () S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( ntStatus;) S 
2400 6220 P () S 480 J ( ) S 480 J ( if) S 144 J ( \() S 144 J ( !NT_SUCCESS\(ntStatus\)) S 144 J ( &&) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoIsErrorUserInduced\(ntStatus\)\)) S 144 J ( {) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IoSetHardErrorOrVerifyDevice\() S 
2400 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp,) S 
2400 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject\);) S 
2400 7520 P () S 480 J ( ) S 480 J ( }) S 
2400 7780 P () S 480 J ( ) S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_NO_INCREMENT\);) S 
2400 8040 P () S 480 J ( }) S 
2400 8300 P () S 480 J ( return) S 144 J ( ntStatus;) S 
2400 8560 P (}) S 
1920 8940 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( this) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( satisfies) S 60 J ( at) S 60 J ( least) S 60 J ( one) S 60 J ( I/O) S 60 J ( control) S 60 J ( request) S 
1920 9200 P (\(IOCTL_DISK_GET_MEDIA_TYPES\),) S 60 J ( besides) S 60 J ( completing) S 60 J ( every) S 60 J ( IRP) S 60 J ( in) S 60 J ( which) S 60 J ( it) S 60 J ( finds) S 
1920 9460 P (parameter) S 60 J ( errors.) S 60 J ( For) S 60 J ( better) S 60 J ( performance,) S 60 J ( every) S 60 J ( device) S 60 J ( driver) S 60 J ( should) S 60 J ( satisfy) S 60 J ( any) S 60 J ( device) S 60 J ( control) S 
1920 9720 P (request) S 60 J ( that) S 60 J ( it) S 60 J ( can) S 60 J ( \(without) S 60 J ( queueing) S 60 J ( the) S 60 J ( IRP\)) S 60 J ( in) S 60 J ( its) S 60 J ( DispatchDeviceControl) S 60 J ( routine.) S 
1920 10100 P (For) S 60 J ( those) S 60 J ( IRPs) S 60 J ( that) S 60 J ( the) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( can) S 60 J ( complete,) S 60 J ( it) S 60 J ( should) S 60 J ( call) S 
1920 10360 P 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( ) S 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( of) S 60 J ( IO_NO_INCREMENT.) S 60 J ( The) S 
1920 10620 P (DispatchDeviceControl) S 60 J ( routine) S 60 J ( must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoMarkIrpPending) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( each) S 60 J ( request) S 60 J ( that) S 60 J ( it) S 60 J ( queues) S 
1920 10880 P (for) S 60 J ( further) S 60 J ( processing) S 60 J ( on) S 60 J ( the) S 60 J ( device.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (30) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2080 P 0 12 F 8 12 F B (6.5.2) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( DispatchDeviceControl) S 67 J ( Routines) S 67 J ( in) S 67 J ( Higher-level) S 67 J ( Drivers) S E 
1200 2700 P 0 12 F 24 12 F (Usually,) S 60 J ( the) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( of) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( simply) S 60 J ( sets) S 60 J ( up) S 60 J ( the) S 60 J ( I/O) S 
1200 2960 P (stack) S 60 J ( location) S 60 J ( in) S 60 J ( the) S 60 J ( IRP) S 60 J ( for) S 60 J ( the) S 60 J ( next-lower-level) S 60 J ( driver) S 60 J ( and) S 60 J ( passes) S 60 J ( the) S 60 J ( IRP) S 60 J ( on) S 60 J ( with) S 
1200 3220 P 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F (.) S 60 J ( Such) S 60 J ( a) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( seldom) S 60 J ( checks) S 60 J ( the) S 60 J ( validity) S 60 J ( of) S 
1200 3480 P (parameters) S 60 J ( in) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( because) S 60 J ( the) S 60 J ( underlying) S 60 J ( device) S 60 J ( driver) S 60 J ( is) S 60 J ( assumed) S 60 J ( to) S 60 J ( have) S 60 J ( better) S 
1200 3740 P (information) S 60 J ( about) S 60 J ( how) S 60 J ( to) S 60 J ( handle) S 60 J ( each) S 60 J ( device-type-specific) S 60 J ( I/O) S 60 J ( control) S 60 J ( request) S 60 J ( on) S 60 J ( its) S 60 J ( own) S 
1200 4000 P (device.) S 
1200 4380 P (A) S 60 J ( possible) S 60 J ( exception) S 60 J ( to) S 60 J ( this) S 60 J ( general) S 60 J ( rule) S 60 J ( is) S 60 J ( the) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( in) S 60 J ( the) S 60 J ( class) S 
1200 4640 P (driver) S 60 J ( of) S 60 J ( a) S 60 J ( class/port) S 60 J ( driver) S 60 J ( pair.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( handling) S 60 J ( device) S 60 J ( control) S 60 J ( requests) S 
1200 4900 P (in) S 60 J ( paired) S 60 J ( class/port) S 60 J ( drivers,) S 60 J ( see) S 60 J ( Section) S 60 J ( 6.5.3,) S 60 J ( next.) S 
1200 5280 P (Any) S 60 J ( new) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( that) S 60 J ( is) S 60 J ( not) S 60 J ( closely) S 60 J ( associated) S 60 J ( with) S 60 J ( a) S 60 J ( particular) S 60 J ( device) S 60 J ( driver) S 
1200 5540 P (should) S 60 J ( simply) S 60 J ( set) S 60 J ( up) S 60 J ( the) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( for) S 60 J ( the) S 60 J ( next-lower-level) S 60 J ( driver) S 60 J ( and) S 60 J ( pass) S 60 J ( the) S 
1200 5800 P (IRP_MJ_DEVICE_CONTROL) S 60 J ( request) S 60 J ( on) S 60 J ( for) S 60 J ( further) S 60 J ( processing.) S 60 J ( A) S 60 J ( device) S 60 J ( control) S 60 J ( request) S 60 J ( is) S 
1200 6060 P (usually) S 60 J ( handled) S 60 J ( asynchronously) S 60 J ( unless) S 60 J ( the) S 60 J ( device) S 60 J ( driver) S 60 J ( must) S 60 J ( process) S 60 J ( data) S 60 J ( transferred) S 60 J ( from) S 
1200 6320 P (the) S 60 J ( device) S 60 J ( before) S 60 J ( it) S 60 J ( completes) S 60 J ( the) S 60 J ( request.) S 60 J ( That) S 60 J ( is,) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver's) S 
1200 6580 P (DispatchDeviceControl) S 60 J ( routine) S 60 J ( can) S 60 J ( frequently) S 60 J ( return) S 60 J ( control) S 60 J ( to) S 60 J ( the) S 60 J ( system) S 60 J ( as) S 60 J ( follows:) S 
1680 7100 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 7360 P () S 480 J ( return) S 144 J ( IoCallDriver\(DeviceObject->NextDeviceObject,) S 144 J ( Irp\)) S 
1200 7740 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( that) S 60 J ( sets) S 60 J ( up) S 60 J ( device) S 60 J ( control) S 60 J ( requests) S 60 J ( for) S 60 J ( an) S 60 J ( underlying) S 60 J ( device) S 
1200 8000 P (driver) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (IoBuildDeviceIoControlRequest) S E 0 12 F 24 12 F () S 60 J ( also) S 60 J ( can) S 60 J ( handle) S 60 J ( its) S 60 J ( device) S 60 J ( control) S 60 J ( request) S 
1200 8260 P (synchronously) S 60 J ( by) S 60 J ( waiting) S 60 J ( on) S 60 J ( an) S 60 J ( optional) S 60 J ( event) S 60 J ( that) S 60 J ( is) S 60 J ( associated) S 60 J ( with) S 60 J ( the) S 60 J ( driver-allocated) S 60 J ( IRP.) S 
1200 8900 P 0 12 F 8 12 F B (6.5.3) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( Dispatch\(Internal\)DeviceControl) S 67 J ( Routines) S 67 J ( in) S 67 J ( Class/Port) S 67 J ( Drivers) S E 
1200 9520 P 0 12 F 24 12 F (The) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( of) S 60 J ( a) S 60 J ( class/port) S 60 J ( pair) S 60 J ( can) S 60 J ( sometimes) S 60 J ( complete) S 60 J ( IRPs) S 60 J ( in) S 60 J ( its) S 
1200 9780 P (DispatchDeviceControl) S 60 J ( routine.) S 60 J ( For) S 60 J ( example,) S 60 J ( if) S 60 J ( a) S 60 J ( class) S 60 J ( driver) S 60 J ( gathers) S 60 J ( and) S 60 J ( stores) S 60 J ( information) S 
1200 10040 P (about) S 60 J ( the) S 60 J ( features) S 60 J ( of) S 60 J ( the) S 60 J ( underlying) S 60 J ( device) S 60 J ( during) S 60 J ( initialization,) S 60 J ( which) S 60 J ( might) S 60 J ( be) S 60 J ( sought) S 60 J ( in) S 60 J ( a) S 
1200 10300 P (subsequent) S 60 J ( IRP_MJ_DEVICE_CONTROL) S 60 J ( request,) S 60 J ( the) S 60 J ( class) S 60 J ( driver) S 60 J ( might) S 60 J ( satisfy) S 60 J ( such) S 60 J ( a) S 
1200 10560 P (request) S 60 J ( without) S 60 J ( passing) S 60 J ( it) S 60 J ( on) S 60 J ( to) S 60 J ( the) S 60 J ( underlying) S 60 J ( device) S 60 J ( driver) S 60 J ( to) S 60 J ( save) S 60 J ( processing) S 60 J ( time.) S 
1200 10820 P (Depending) S 60 J ( on) S 60 J ( the) S 60 J ( designer,) S 60 J ( a) S 60 J ( class) S 60 J ( driver) S 60 J ( also) S 60 J ( might) S 60 J ( check) S 60 J ( the) S 60 J ( IRP's) S 60 J ( parameters) S 60 J ( for) S 60 J ( its) S 60 J ( paired) S 
1200 11080 P (port) S 60 J ( driver) S 60 J ( so) S 60 J ( that) S 60 J ( it) S 60 J ( could) S 60 J ( send) S 60 J ( down) S 60 J ( only) S 60 J ( requests) S 60 J ( with) S 60 J ( valid) S 60 J ( parameters.) S 
1200 11460 P (Closely) S 60 J ( coupled) S 60 J ( class/port) S 60 J ( drivers) S 60 J ( also) S 60 J ( can) S 60 J ( define) S 60 J ( a) S 60 J ( private) S 60 J ( set) S 60 J ( of) S 60 J ( device-specific) S 60 J ( I/O) S 60 J ( control) S 
1200 11720 P (codes) S 60 J ( that) S 60 J ( the) S 60 J ( class) S 60 J ( driver) S 60 J ( uses) S 60 J ( to) S 60 J ( set) S 60 J ( up) S 60 J ( IRPs) S 60 J ( for) S 
1200 11980 P (IRP_MJ_INTERNAL_DEVICE_CONTROL) S 60 J ( requests) S 60 J ( to) S 60 J ( the) S 60 J ( port) S 60 J ( driver.) S 60 J ( For) S 60 J ( example,) S 60 J ( the) S 
1200 12240 P (system-supplied) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver,) S 60 J ( as) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Section) S 60 J ( 6.2.2,) S 60 J ( sends) S 60 J ( internal) S 60 J ( device) S 
1200 12500 P (control) S 60 J ( requests) S 60 J ( to) S 60 J ( enable/disable) S 60 J ( keyboard) S 60 J ( interrupts) S 60 J ( to) S 60 J ( the) S 60 J ( underlying) S 60 J ( port) S 60 J ( driver\(s\)) S 60 J ( from) S 60 J ( the) S 
1200 12760 P (class) S 60 J ( driver's) S 60 J ( DispatchCreateClose) S 60 J ( routine.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (31) S E B () S 720 J ( ) S E 
1920 2180 P 0 12 F 24 12 F (The) S 60 J ( system-supplied) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( handles) S 60 J ( IRP_MJ_DEVICE_CONTROL) S 60 J ( requests) S 
1920 2440 P (by) S 60 J ( setting) S 60 J ( up) S 60 J ( IRP_MJ_INTERNAL_DEVICE_CONTROL) S 60 J ( requests) S 60 J ( for) S 60 J ( an) S 60 J ( underlying) S 60 J ( port) S 
1920 2700 P (driver) S 60 J ( as) S 60 J ( follows:) S 
2400 3220 P 0 12 F 0 12 F ({) S 
2400 3480 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
2400 3740 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
2400 4000 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( nextSp) S 144 J ( =) S 
2400 4260 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoGetNextIrpStackLocation\(Irp\);) S 
2400 4520 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
2400 4780 P () S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
2400 5040 P () S 480 J ( NTSTATUS) S 144 J ( status) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 
2400 5300 P () S 480 J ( ULONG) S 144 J ( unitId;) S 
2400 5560 P (//) S 
2400 5820 P (//) S 144 J ( Check) S 144 J ( for) S 144 J ( inadequate) S 144 J ( input) S 144 J ( buffer) S 144 J ( length.) S 144 J ( At) S 144 J ( a) S 144 J ( minimum,) S 
2400 6080 P (//) S 144 J ( the) S 144 J ( input) S 144 J ( buffer) S 144 J ( length) S 144 J ( should) S 144 J ( contain) S 144 J ( the) S 144 J ( unit) S 144 J ( ID) S 
2400 6340 P (//) S 144 J ( specifying) S 144 J ( one) S 144 J ( of) S 144 J ( the) S 144 J ( connected) S 144 J ( port) S 144 J ( devices.) S 
2400 6600 P (//) S 144 J ( If) S 144 J ( the) S 144 J ( input) S 144 J ( buffer) S 144 J ( length) S 144 J ( is) S 144 J ( zero,) S 144 J ( assume) S 144 J ( the) S 144 J ( unit) S 144 J ( ID) S 
2400 6860 P (//) S 144 J ( is) S 144 J ( also) S 144 J ( zero) S 144 J ( for) S 144 J ( backward) S 144 J ( compatibility.) S 
2400 7120 P (//) S 
2400 7380 P () S 480 J ( if) S 144 J ( \(irpSp->) S 
2400 7640 P () S 480 J ( ) S 480 J ( Parameters.DeviceIoControl.InputBufferLength) S 144 J ( ==) S 144 J ( 0\)) S 144 J ( {) S 
2400 7900 P () S 480 J ( ) S 480 J ( unitId) S 144 J ( =) S 144 J ( 0;) S 
2400 8160 P () S 480 J ( }) S 144 J ( else) S 144 J ( if) S 144 J ( \(irpSp->) S 
2400 8420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Parameters.DeviceIoControl.InputBufferLength) S 144 J ( <) S 
2400 8680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sizeof\(KEYBOARD_UNIT_ID_PARAMETER\)\)) S 144 J ( {) S 
2400 8940 P () S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_BUFFER_TOO_SMALL;) S 
2400 9200 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
2400 9460 P () S 480 J ( ) S 480 J ( unitId) S 144 J ( =) S 144 J ( \(\(PKEYBOARD_UNIT_ID_PARAMETER\)) S 
2400 9720 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp->AssociatedIrp.SystemBuffer\)->UnitId;) S 
2400 9980 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(unitId) S 144 J ( >=) S 
2400 10240 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->MaximumPortsServiced\)) S 144 J ( {) S 
2400 10500 P () S 480 J ( ) S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_INVALID_PARAMETER;) S 
2400 10760 P () S 480 J ( ) S 480 J ( }) S 
2400 11020 P () S 480 J ( }) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (32) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F () S 480 J ( if) S 144 J ( \(NT_SUCCESS\(status\)\)) S 144 J ( {) S 
1680 2320 P (//) S 
1680 2580 P (//) S 144 J ( Pass) S 144 J ( the) S 144 J ( device) S 144 J ( control) S 144 J ( request) S 144 J ( on) S 144 J ( to) S 144 J ( the) S 144 J ( port) S 144 J ( driver.) S 
1680 2840 P (//) S 144 J ( Copy) S 144 J ( the) S 144 J ( input) S 144 J ( parameters) S 144 J ( to) S 144 J ( the) S 144 J ( port) S 144 J ( driver's) S 
1680 3100 P (//) S 144 J ( I/O) S 144 J ( stack) S 144 J ( location,) S 144 J ( and) S 144 J ( change) S 144 J ( the) S 144 J ( major) S 144 J ( function) S 
1680 3360 P (//) S 144 J ( code) S 144 J ( to) S 144 J ( internal) S 144 J ( device) S 144 J ( control.) S 
1680 3620 P (//) S 
1680 3880 P () S 480 J ( ) S 480 J ( ASSERT\(nextSp) S 144 J ( !=) S 144 J ( NULL\);) S 
1680 4140 P () S 480 J ( ) S 480 J ( nextSp->Parameters.DeviceIoControl) S 144 J ( =) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( irpSp->Parameters.DeviceIoControl;) S 
1680 4660 P () S 480 J ( ) S 480 J ( nextSp->MajorFunction) S 144 J ( =) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( IRP_MJ_INTERNAL_DEVICE_CONTROL;) S 
1680 5180 P () S 480 J ( ) S 480 J ( IoMarkIrpPending\(Irp\);) S 
1680 5440 P () S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( IoCallDriver\() S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->) S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( PortDeviceObjectList[unitId],) S 
1680 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Irp\);) S 
1680 6480 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 6740 P (//) S 
1680 7000 P (//) S 144 J ( Complete) S 144 J ( the) S 144 J ( request.) S 
1680 7260 P (//) S 
1680 7520 P () S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( status;) S 
1680 7780 P () S 480 J ( ) S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
1680 8040 P () S 480 J ( ) S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_NO_INCREMENT\);) S 
1680 8300 P () S 480 J ( }) S 
1680 8560 P () S 480 J ( return\(status\);) S 
1680 8820 P (}) S 
1200 9200 P 0 12 F 24 12 F (Because) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( is) S 60 J ( designed) S 60 J ( to) S 60 J ( layer) S 60 J ( itself) S 60 J ( over) S 60 J ( more) S 60 J ( than) S 60 J ( one) S 60 J ( port) S 60 J ( driver,) S 60 J ( it) S 
1200 9460 P (checks) S 60 J ( whether) S 60 J ( the) S 60 J ( request) S 60 J ( is) S 60 J ( bound) S 60 J ( for) S 60 J ( an) S 60 J ( underlying) S 60 J ( device) S 60 J ( the) S 60 J ( driver) S 60 J ( recognizes,) S 60 J ( and) S 60 J ( fails) S 
1200 9720 P (the) S 60 J ( IRP) S 60 J ( if) S 60 J ( it) S 60 J ( is) S 60 J ( not.) S 60 J ( Otherwise,) S 60 J ( it) S 60 J ( sets) S 60 J ( up) S 60 J ( the) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( in) S 60 J ( the) S 60 J ( IRP) S 60 J ( for) S 60 J ( the) S 60 J ( port) S 60 J ( driver) S 
1200 9980 P (and) S 60 J ( passes) S 60 J ( the) S 60 J ( request) S 60 J ( on) S 60 J ( for) S 60 J ( further) S 60 J ( processing.) S 
1200 10360 P (Note) S 60 J ( that) S 60 J ( any) S 60 J ( new) S 60 J ( keyboard) S 60 J ( driver) S 60 J ( that) S 60 J ( interoperates) S 60 J ( with) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( keyboard) S 60 J ( class) S 
1200 10620 P (driver) S 60 J ( also) S 60 J ( must) S 60 J ( support) S 60 J ( its) S 60 J ( internal) S 60 J ( device) S 60 J ( control) S 60 J ( requests.) S 
1200 11000 P (One) S 60 J ( of) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 60 J ( underlying) S 60 J ( port) S 60 J ( drivers) S 60 J ( is) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( i8042) S 
1200 11260 P (keyboard) S 60 J ( and) S 60 J ( auxiliary) S 60 J ( device) S 60 J ( driver,) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 2.) S 60 J ( This) S 60 J ( driver's) S 
1200 11520 P (DispatchInternalDeviceControl) S 60 J ( routine) S 60 J ( processes) S 60 J ( requests) S 60 J ( that) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( sends) S 
1200 11780 P (both) S 60 J ( from) S 60 J ( its) S 60 J ( DispatchCreateClose) S 60 J ( and) S 60 J ( DispatchDeviceControl) S 60 J ( routines.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (33) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (Any) S 60 J ( new) S 60 J ( keyboard) S 60 J ( port) S 60 J ( driver) S 60 J ( should) S 60 J ( handle) S 60 J ( internal) S 60 J ( device) S 60 J ( control) S 60 J ( requests) S 60 J ( in) S 60 J ( a) S 60 J ( manner) S 
1920 2320 P (similar) S 60 J ( to) S 60 J ( the) S 60 J ( i8042) S 60 J ( port) S 60 J ( driver's) S 60 J ( DispatchInternalDeviceControl) S 60 J ( routine,) S 60 J ( as) S 60 J ( follows:) S 
2400 2840 P 0 12 F 0 12 F ({) S 
2400 3100 P (PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
2400 3360 P () S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\(Irp\);) S 
2400 3620 P (PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
2400 3880 P () S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
2400 4140 P (Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
2400 4400 P (NTSTATUS) S 144 J ( status;) S 
2400 4660 P (I8042_INITIALIZE_DATA_CONTEXT) S 144 J ( initializeDataContext;) S 
2400 4920 P (PVOID) S 144 J ( parameters;) S 
2400 5180 P (PKEYBOARD_ATTRIBUTES) S 144 J ( keyboardAttributes;) S 
2400 5440 P (ULONG) S 144 J ( sizeOfTranslation;) S 
2400 5700 P (//) S 
2400 5960 P (//) S 144 J ( Case) S 144 J ( on) S 144 J ( the) S 144 J ( I/O) S 144 J ( control) S 144 J ( code) S 144 J ( in) S 144 J ( the) S 144 J ( IRP.) S 
2400 6220 P (//) S 
2400 6480 P () S 480 J ( switch) S 144 J ( \(irpSp->) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Parameters.DeviceIoControl.IoControlCode\)) S 144 J ( {) S 
2400 7000 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
2400 7260 P () S 480 J ( ) S 480 J ( case) S 144 J ( IOCTL_INTERNAL_KEYBOARD_ENABLE:) S 
2400 7520 P (//) S 
2400 7780 P (//) S 144 J ( Enable) S 144 J ( keyboard) S 144 J ( interrupts) S 144 J ( \(mark) S 144 J ( IRP) S 144 J ( pending) S 144 J ( and) S 144 J ( handle) S 
2400 8040 P (//) S 144 J ( request) S 144 J ( in) S 144 J ( StartIo\).) S 
2400 8300 P (//) S 
2400 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_PENDING;) S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 9080 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
2400 9340 P () S 480 J ( ) S 480 J ( case) S 144 J ( IOCTL_KEYBOARD_QUERY_ATTRIBUTES:) S 
2400 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(irpSp->) S 
2400 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Parameters.DeviceIoControl.) S 
2400 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( OutputBufferLength) S 144 J ( <) S 
2400 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( sizeof\(KEYBOARD_ATTRIBUTES\)\)) S 144 J ( {) S 
2400 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_BUFFER_TOO_SMALL;) S 
2400 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
2400 11160 P (//) S 
2400 11420 P (//) S 144 J ( Copy) S 144 J ( the) S 144 J ( attributes) S 144 J ( from) S 144 J ( the) S 144 J ( device) S 144 J ( extension) S 
2400 11680 P (//) S 144 J ( to) S 144 J ( the) S 144 J ( buffer.) S 
2400 11940 P (//) S 0 12 F 
PE 
1200 1220 P 10 12 F B (6-) S E B (34) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( *\(PKEYBOARD_ATTRIBUTES\)) S 144 J ( IrpSp->) S 
1680 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AssociatedIrp.SystemBuffer) S 144 J ( =) S 
1680 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->) S 
1680 2840 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Configuration.KeyboardAttributes;) S 
1680 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
1680 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
1680 3880 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 4140 P () S 480 J ( ) S 480 J ( default:) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( status) S 144 J ( =) S 144 J ( STATUS_INVALID_DEVICE_REQUEST;) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
1680 4920 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( switch) S 
1680 5180 P () S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( status;) S 
1680 5440 P () S 480 J ( if) S 144 J ( \(status) S 144 J ( ==) S 144 J ( STATUS_PENDING\)) S 144 J ( {) S 
1680 5700 P () S 480 J ( ) S 480 J ( IoMarkIrpPending\(Irp\);) S 
1680 5960 P () S 480 J ( ) S 480 J ( IoStartPacket\(DeviceObject,) S 144 J ( Irp,) S 144 J ( \(PULONG\)NULL,) S 144 J ( NULL\);) S 
1680 6220 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 6480 P () S 480 J ( ) S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_NO_INCREMENT\);) S 
1680 6740 P () S 480 J ( }) S 
1680 7000 P () S 480 J ( return\(status\);) S 
1680 7260 P (}) S 
1200 7640 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( a) S 60 J ( new,) S 60 J ( monolithic) S 60 J ( keyboard) S 60 J ( driver) S 60 J ( would) S 60 J ( not) S 60 J ( be) S 60 J ( required) S 60 J ( to) S 60 J ( support) S 60 J ( the) S 
1200 7900 P (IOCTL_INTERNAL_KEYBOARD_) S 0 12 F 24 12 F I (xxx) S E 0 12 F 24 12 F () S 60 J ( I/O) S 60 J ( control) S 60 J ( codes.) S 60 J ( Since) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( would) S 60 J ( not) S 
1200 8160 P (interoperate) S 60 J ( with) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver,) S 60 J ( the) S 60 J ( new) S 60 J ( keyboard) S 60 J ( driver) S 60 J ( could) S 
1200 8420 P (supply) S 60 J ( a) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( to) S 60 J ( handle) S 60 J ( only) S 60 J ( the) S 60 J ( required) S 
1200 8680 P (IOCTL_KEYBOARD_) S 0 12 F 24 12 F I (xxx) S E 0 12 F 24 12 F () S 60 J ( requests) S 60 J ( that) S 60 J ( originate) S 60 J ( in) S 60 J ( the) S 60 J ( Win32) S 60 J ( subsystem.) S 
1200 9060 P (For) S 60 J ( a) S 60 J ( closely) S 60 J ( coupled) S 60 J ( pair) S 60 J ( of) S 60 J ( port/class) S 60 J ( drivers,) S 60 J ( the) S 60 J ( class) S 60 J ( driver) S 60 J ( might) S 60 J ( handle) S 60 J ( the) S 60 J ( processing) S 60 J ( of) S 
1200 9320 P (certain) S 60 J ( device) S 60 J ( control) S 60 J ( requests) S 60 J ( without) S 60 J ( passing) S 60 J ( them) S 60 J ( on) S 60 J ( to) S 60 J ( the) S 60 J ( port) S 60 J ( driver.) S 60 J ( The) S 60 J ( designer) S 60 J ( of) S 60 J ( a) S 
1200 9580 P (new) S 60 J ( class/port) S 60 J ( driver) S 60 J ( pair) S 60 J ( can) S 60 J ( implement) S 60 J ( the) S 60 J ( class) S 60 J ( driver's) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( to) S 
1200 9840 P (do) S 60 J ( either) S 60 J ( of) S 60 J ( the) S 60 J ( following:) S 
1200 10160 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Check) S 60 J ( the) S 60 J ( validity) S 60 J ( of) S 60 J ( the) S 60 J ( parameters) S 60 J ( in) S 60 J ( its) S 60 J ( own) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( in) S 60 J ( the) S 60 J ( IRP,) S 60 J ( set) S 60 J ( the) S 60 J ( I/O) S 
1680 10420 P (status) S 60 J ( block) S 60 J ( if) S 60 J ( it) S 60 J ( finds) S 60 J ( any) S 60 J ( parameter) S 60 J ( errors,) S 60 J ( and) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( IRP) S 
1680 10680 P (and) S 60 J ( a) S 60 J ( ) S 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( of) S 60 J ( IO_NO_INCREMENT;) S 60 J ( otherwise,) S 60 J ( call) S 
1680 10940 P 0 12 F 24 12 F B (IoGetNextIrpStackLocation) S E 0 12 F 24 12 F (,) S 60 J ( copy) S 60 J ( its) S 60 J ( own) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( into) S 60 J ( the) S 60 J ( port) S 60 J ( driver's,) S 60 J ( and) S 
1680 11200 P (pass) S 60 J ( the) S 60 J ( IRP) S 60 J ( on) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F (.) S 
1200 11520 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Or,) S 60 J ( do) S 60 J ( nothing) S 60 J ( more) S 60 J ( than) S 60 J ( set) S 60 J ( up) S 60 J ( the) S 60 J ( port) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( in) S 60 J ( the) S 60 J ( IRP) S 60 J ( without) S 
1680 11780 P (checking) S 60 J ( parameters) S 60 J ( and) S 60 J ( pass) S 60 J ( it) S 60 J ( on) S 60 J ( to) S 60 J ( the) S 60 J ( port) S 60 J ( driver) S 60 J ( for) S 60 J ( processing.) S 
1200 12160 P (NT) S 60 J ( SCSI) S 60 J ( class) S 60 J ( drivers) S 60 J ( have) S 60 J ( special) S 60 J ( requirements) S 60 J ( for) S 60 J ( handling) S 60 J ( device) S 60 J ( control) S 60 J ( requests.) S 60 J ( For) S 
1200 12420 P (more) S 60 J ( information) S 60 J ( about) S 60 J ( these) S 60 J ( requirements,) S 60 J ( see) S 60 J ( Appendix) S 60 J ( B.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4874 J ( Dispatch) S 55 J ( Routines) S 807 J ( 6-) S E B (35) S E B () S 720 J ( ) S E 
1920 2080 P 0 12 F 8 12 F B (6.5.4) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( Points) S 67 J ( to) S 67 J ( Consider) S 67 J ( in) S 67 J ( Implementing) S 67 J ( Dispatch\(Internal\)DeviceControl) S E 
1920 2700 P 0 12 F 24 12 F (Keep) S 60 J ( the) S 60 J ( following) S 60 J ( points) S 60 J ( in) S 60 J ( mind) S 60 J ( when) S 60 J ( implementing) S 60 J ( a) S 60 J ( new) S 60 J ( DispatchDeviceControl) S 60 J ( or) S 
1920 2960 P (DispatchInternalDeviceControl) S 60 J ( routine:) S 
1920 3280 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( At) S 60 J ( a) S 60 J ( minimum,) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( must) S 60 J ( copy) S 60 J ( the) S 60 J ( parameters) S 60 J ( for) S 60 J ( an) S 
2400 3540 P (IRP_MJ_DEVICE_CONTROL) S 60 J ( or) S 60 J ( IRP_MJ_INTERNAL_DEVICE_CONTROL) S 60 J ( request) S 
2400 3800 P (from) S 60 J ( its) S 60 J ( own) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 60 J ( in) S 60 J ( the) S 60 J ( IRP) S 60 J ( to) S 60 J ( the) S 60 J ( next-lower-level) S 60 J ( driver's) S 60 J ( I/O) S 60 J ( stack) S 
2400 4060 P (location.) S 60 J ( Then,) S 60 J ( it) S 60 J ( must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( next-lower) S 60 J ( driver's) S 60 J ( device) S 
2400 4320 P (object) S 60 J ( and) S 60 J ( the) S 60 J ( IRP.) S 60 J ( Such) S 60 J ( a) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( should) S 60 J ( propagate) S 60 J ( the) S 60 J ( status) S 60 J ( value) S 60 J ( returned) S 
2400 4580 P (by) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F () S 60 J ( when) S 60 J ( it) S 60 J ( returns) S 60 J ( control.) S 
1920 4900 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( At) S 60 J ( the) S 60 J ( discretion) S 60 J ( of) S 60 J ( the) S 60 J ( driver) S 60 J ( designer,) S 60 J ( the) S 60 J ( class) S 60 J ( driver) S 60 J ( of) S 60 J ( a) S 60 J ( closely) S 60 J ( coupled) S 60 J ( class/port) S 
2400 5160 P (driver) S 60 J ( pair) S 60 J ( can) S 60 J ( process) S 60 J ( and) S 60 J ( complete) S 60 J ( a) S 60 J ( subset) S 60 J ( of) S 60 J ( device) S 60 J ( control) S 60 J ( requests) S 60 J ( without) S 60 J ( passing) S 
2400 5420 P (them) S 60 J ( on) S 60 J ( to) S 60 J ( the) S 60 J ( underlying) S 60 J ( port) S 60 J ( driver.) S 60 J ( However,) S 60 J ( such) S 60 J ( a) S 60 J ( class) S 60 J ( driver) S 60 J ( must) S 60 J ( pass) S 60 J ( on) S 60 J ( all) S 
2400 5680 P (device) S 60 J ( control) S 60 J ( requests) S 60 J ( that) S 60 J ( require) S 60 J ( a) S 60 J ( change) S 60 J ( of) S 60 J ( state) S 60 J ( for) S 60 J ( the) S 60 J ( device) S 60 J ( and) S 60 J ( those) S 60 J ( that) S 60 J ( require) S 
2400 5940 P (the) S 60 J ( return) S 60 J ( of) S 60 J ( "volatile") S 60 J ( information) S 60 J ( about) S 60 J ( the) S 60 J ( device) S 60 J ( \(such) S 60 J ( as) S 60 J ( its) S 60 J ( current) S 60 J ( mode\).) S 
1920 6260 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( underlying) S 60 J ( device) S 60 J ( driver) S 60 J ( must) S 60 J ( process) S 60 J ( most) S 60 J ( device) S 60 J ( control) S 60 J ( requests.) S 60 J ( A) S 60 J ( device) S 
2400 6520 P (driver's) S 60 J ( DispatchDeviceControl) S 60 J ( routine) S 60 J ( usually) S 60 J ( begins) S 60 J ( processing) S 60 J ( these) S 60 J ( requests) S 60 J ( by) S 
2400 6780 P 0 12 F 24 12 F B (switch) S E 0 12 F 24 12 F (ing) S 60 J ( on) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Parameters.DeviceIoControl.IoControlCode) S E 0 12 F 24 12 F () S 60 J ( in) S 60 J ( its) S 60 J ( I/O) S 60 J ( stack) S 60 J ( location) S 
2400 7040 P (of) S 60 J ( each) S 60 J ( IRP.) S 
1920 7360 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( device) S 60 J ( driver) S 60 J ( should) S 60 J ( check) S 60 J ( the) S 60 J ( parameters) S 60 J ( passed) S 60 J ( in) S 60 J ( with) S 60 J ( the) S 60 J ( request) S 60 J ( and) S 60 J ( fail) S 60 J ( the) S 60 J ( IRP) S 
2400 7620 P (with) S 60 J ( an) S 60 J ( appropriate) S 60 J ( error) S 60 J ( if) S 60 J ( any) S 60 J ( parameter) S 60 J ( is) S 60 J ( invalid.) S 60 J ( The) S 60 J ( most) S 60 J ( common) S 60 J ( check) S 60 J ( on) S 60 J ( the) S 
2400 7880 P (validity) S 60 J ( of) S 60 J ( parameters) S 60 J ( to) S 60 J ( these) S 60 J ( requests) S 60 J ( has) S 60 J ( the) S 60 J ( form:) S 
1920 8200 P () S 1080 J ( ) S 360 J ( ) S 0 12 F 24 12 F B (if) S 60 J ( \(Irp->Parameters.DeviceIoControl.InputBufferLength) S 60 J ( <) S E 
3360 8460 P B (\(sizeof\() S E 0 12 F 24 12 F I (IOCTL_SPECIFIC_STRUCTURE) S E 0 12 F 24 12 F B (\)\)\)) S 60 J ( {) S E 
1920 8780 P 0 12 F 24 12 F () S 1080 J ( ) S 360 J ( ) S 0 12 F 24 12 F B (status) S 60 J ( =) S 60 J ( STATUS_) S E 0 12 F 24 12 F I (xxx) S E 0 12 F 24 12 F B (;) S E 
1920 9100 P 0 12 F 24 12 F () S 664 J ( ) S 296 J ( or) S 
1920 9420 P () S 1080 J ( ) S 360 J ( ) S 0 12 F 24 12 F B (if) S 60 J ( \(Irp->Parameters.DeviceIoControl.OutputBufferLength) S 60 J ( <) S E 
3360 9680 P B (\(sizeof\() S E 0 12 F 24 12 F I (IOCTL_SPECIFIC_STRUCTURE) S E 0 12 F 24 12 F B (\)\)\)) S 60 J ( {) S E 
1920 10000 P 0 12 F 24 12 F () S 1080 J ( ) S 360 J ( ) S 0 12 F 24 12 F B (status) S 60 J ( =) S 60 J ( STATUS_) S E 0 12 F 24 12 F I (xxx) S E 0 12 F 24 12 F B (;) S E 
1920 10320 P 0 12 F 24 12 F () S 664 J ( ) S 296 J ( where) S 
1920 10640 P () S 1080 J ( ) S 360 J ( The) S 60 J ( status) S 60 J ( value) S 60 J ( set) S 60 J ( is) S 60 J ( one) S 60 J ( of) S 60 J ( STATUS_BUFFER_TOO_SMALL) S 60 J ( or) S 
3360 10900 P (STATUS_INVALID_PARAMETER.) S 
1920 11220 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( particular) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( a) S 60 J ( device) S 60 J ( driver) S 60 J ( handles) S 60 J ( must) S 60 J ( include) S 60 J ( any) S 60 J ( device-type-) S 
2400 11480 P (specific,) S 60 J ( system-defined) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes) S 60 J ( for) S 60 J ( the) S 60 J ( same) S 60 J ( type) S 60 J ( of) S 60 J ( device.) S 60 J ( See) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F I (Kernel-) S E 
2400 11740 P I (mode) S 60 J ( Driver) S 60 J ( Reference) S E 0 12 F 24 12 F () S 60 J ( for) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( the) S 60 J ( system) S 60 J ( requirements) S 60 J ( for) S 60 J ( each) S 60 J ( type) S 
2400 12000 P (of) S 60 J ( device) S 60 J ( and) S 60 J ( the) S 60 J ( system-defined) S 60 J ( structures) S 60 J ( for) S 60 J ( these) S 60 J ( I/O) S 60 J ( control) S 60 J ( codes.) S 
1920 12320 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Every) S 60 J ( device) S 60 J ( driver's) S 60 J ( DispatchDeviceControl) S 60 J ( or) S 60 J ( DispatchInternalDeviceControl) S 60 J ( routine) S 
2400 12580 P (must) S 60 J ( handle) S 60 J ( the) S 60 J ( receipt) S 60 J ( of) S 60 J ( an) S 60 J ( unrecognized) S 60 J ( I/O) S 60 J ( control) S 60 J ( code) S 60 J ( by) S 60 J ( setting) S 60 J ( the) S 60 J ( I/O) S 60 J ( status) S 
2400 12840 P (block) S 60 J ( with) S 60 J ( an) S 60 J ( appropriate) S 60 J ( NTSTATUS) S 60 J ( value,) S 60 J ( setting) S 60 J ( its) S 60 J ( ) S 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( to) S 60 J ( zero,) S 60 J ( and) S 
2400 13100 P (completing) S 60 J ( the) S 60 J ( IRP) S 60 J ( with) S 60 J ( a) S 60 J ( ) S 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( of) S 60 J ( IO_NO_INCREMENT.) S 0 12 F 
PE PSe
