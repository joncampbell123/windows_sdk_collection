%!PS-Adobe-2.0 
PSp 15840 SFL 
1920 2440 P 8 18 F B (Chapter) S 100 J ( 10) S E 
1920 2840 P B (SynchCritSection) S 100 J ( Routines) S E 
1920 3600 P 0 12 F 24 12 F (As) S 60 J ( its) S 60 J ( name) S 60 J ( suggests,) S 60 J ( a) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( is) S 60 J ( a) S 60 J ( critical) S 60 J ( section) S 60 J ( of) S 60 J ( code) S 60 J ( whose) S 60 J ( access) S 60 J ( to) S 
1920 3860 P (a) S 60 J ( shared) S 60 J ( context) S 60 J ( area) S 60 J ( must) S 60 J ( be) S 60 J ( synchronized) S 60 J ( with) S 60 J ( possible) S 60 J ( accesses) S 60 J ( by) S 60 J ( other) S 60 J ( driver) S 60 J ( routines,) S 60 J ( in) S 
1920 4120 P (particular) S 60 J ( an) S 60 J ( ISR.) S 60 J ( For) S 60 J ( NT) S 60 J ( device) S 60 J ( drivers,) S 60 J ( the) S 60 J ( StartIo) S 60 J ( and) S 60 J ( DpcForIsr) S 60 J ( or) S 60 J ( CustomDpc) S 60 J ( routines) S 
1920 4380 P (frequently) S 60 J ( must) S 60 J ( access) S 60 J ( some) S 60 J ( of) S 60 J ( the) S 60 J ( same) S 60 J ( memory) S 60 J ( or) S 60 J ( device) S 60 J ( registers) S 60 J ( as) S 60 J ( the) S 60 J ( driver's) S 60 J ( ISR.) S 
1920 4640 P (Depending) S 60 J ( on) S 60 J ( such) S 60 J ( a) S 60 J ( driver's) S 60 J ( device) S 60 J ( or) S 60 J ( its) S 60 J ( design,) S 60 J ( an) S 60 J ( AdapterControl,) S 60 J ( ControllerControl,) S 60 J ( or) S 
1920 4900 P (timer) S 60 J ( routine) S 60 J ( also) S 60 J ( might) S 60 J ( access) S 60 J ( driver-maintained) S 60 J ( state) S 60 J ( and/or) S 60 J ( device) S 60 J ( registers) S 60 J ( shared) S 60 J ( with) S 60 J ( its) S 
1920 5160 P (ISR.) S 
1920 5540 P (If) S 60 J ( any) S 60 J ( non-ISR) S 60 J ( routine) S 60 J ( attempted) S 60 J ( to) S 60 J ( access) S 60 J ( such) S 60 J ( a) S 60 J ( shared) S 60 J ( area) S 60 J ( directly,) S 60 J ( the) S 60 J ( device) S 60 J ( could) S 
1920 5800 P (interrupt) S 60 J ( while) S 60 J ( that) S 60 J ( routine) S 60 J ( was) S 60 J ( programming) S 60 J ( device) S 60 J ( registers) S 60 J ( or) S 60 J ( updating) S 60 J ( state) S 60 J ( information.) S 
1920 6060 P (In) S 60 J ( other) S 60 J ( words,) S 60 J ( the) S 60 J ( ISR) S 60 J ( might) S 60 J ( change) S 60 J ( the) S 60 J ( state) S 60 J ( or) S 60 J ( device) S 60 J ( registers) S 60 J ( out) S 60 J ( from) S 60 J ( under) S 60 J ( the) S 60 J ( StartIo,) S 
1920 6320 P (DpcForIsr,) S 60 J ( CustomDpc,) S 60 J ( AdapterControl,) S 60 J ( ControllerControl,) S 60 J ( or) S 60 J ( timer) S 60 J ( routine) S 60 J ( whenever) S 60 J ( a) S 
1920 6580 P (device) S 60 J ( interrupt) S 60 J ( occurred.) S 
1920 6960 P (This) S 60 J ( chapter) S 60 J ( summarizes) S 60 J ( the) S 60 J ( required) S 60 J ( functionality) S 60 J ( of) S 60 J ( an) S 60 J ( NT) S 60 J ( device) S 60 J ( driver's) S 60 J ( standard) S 
1920 7220 P (SynchCritSection) S 60 J ( routine\(s\).) S 60 J ( See) S 60 J ( Chapters) S 60 J ( 4,) S 60 J ( 7) S 60 J ( through) S 60 J ( 11,) S 60 J ( and) S 60 J ( 14) S 60 J ( for) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
1920 7480 P (StartIo,) S 60 J ( ISR,) S 60 J ( DpcForIsr,) S 60 J ( CustomDpc,) S 60 J ( AdapterControl,) S 60 J ( ControllerControl,) S 60 J ( IoTimer,) S 60 J ( and) S 
1920 7740 P (CustomTimerDpc) S 60 J ( routines.) S 
1920 8540 P 0 12 F 8 14 F B (10.1) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( SynchCritSection) S 78 J ( Routine) S 78 J ( Requirements) S E 
1920 9160 P 0 12 F 24 12 F (Every) S 60 J ( non-ISR) S 60 J ( routine) S 60 J ( in) S 60 J ( an) S 60 J ( NT) S 60 J ( device) S 60 J ( driver) S 60 J ( must) S 60 J ( synchronize) S 60 J ( its) S 60 J ( access) S 60 J ( to) S 60 J ( areas) S 60 J ( shared) S 60 J ( with) S 
1920 9420 P (its) S 60 J ( ISR) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( interrupt) S 60 J ( object\(s\)) S 
1920 9680 P (associated) S 60 J ( with) S 60 J ( the) S 60 J ( ISR) S 60 J ( and) S 60 J ( with) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( SynchCritSection) S 60 J ( routine.) S 60 J ( Making) S 60 J ( this) S 60 J ( call) S 
1920 9940 P (protects) S 60 J ( the) S 60 J ( shared) S 60 J ( data) S 60 J ( or) S 60 J ( device) S 60 J ( registers) S 60 J ( with) S 60 J ( the) S 60 J ( spin) S 60 J ( lock) S 60 J ( that) S 60 J ( is) S 60 J ( associated) S 60 J ( with) S 60 J ( the) S 
1920 10200 P (driver's) S 60 J ( interrupt) S 60 J ( object\(s\).) S 60 J ( Holding) S 60 J ( the) S 60 J ( spin) S 60 J ( lock) S 60 J ( masks) S 60 J ( device) S 60 J ( interrupts) S 60 J ( on) S 60 J ( the) S 
1920 10460 P (SynchCritSection) S 60 J ( routine's) S 60 J ( processor,) S 60 J ( and) S 60 J ( prevents) S 60 J ( the) S 60 J ( shared) S 60 J ( area) S 60 J ( from) S 60 J ( being) S 60 J ( simultaneously) S 
1920 10720 P (accessed) S 60 J ( from) S 60 J ( the) S 60 J ( ISR) S 60 J ( \(or) S 60 J ( another) S 60 J ( SynchCritSection) S 60 J ( routine\)) S 60 J ( in) S 60 J ( symmetric) S 60 J ( multiprocessor) S 
1920 10980 P (machines.) S 
1920 11360 P (A) S 60 J ( SynchCritSection) S 60 J ( routine,) S 60 J ( like) S 60 J ( an) S 60 J ( ISR,) S 60 J ( is) S 60 J ( run) S 60 J ( at) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F I (SynchronizeIrql) S E 0 12 F 24 12 F () S 60 J ( value) S 60 J ( specified) S 60 J ( when) S 
1920 11620 P (the) S 60 J ( driver) S 60 J ( registered) S 60 J ( its) S 60 J ( ISR) S 60 J ( with) S 60 J ( ) S 0 12 F 24 12 F B (IoConnectInterrupt) S E 0 12 F 24 12 F (.) S 60 J ( Running) S 60 J ( at) S 60 J ( DIRQL) S 60 J ( restricts) S 60 J ( the) S 60 J ( set) S 60 J ( of) S 
1920 11880 P (support) S 60 J ( routines) S 60 J ( a) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( can) S 60 J ( call.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( managing) S 
1920 12140 P (IRQLs,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 60 J ( For) S 60 J ( specific) S 60 J ( information) S 60 J ( about) S 60 J ( the) S 60 J ( IRQL\(s\)) S 60 J ( at) S 60 J ( which) S 60 J ( any) S 60 J ( particular) S 
1920 12400 P (support) S 60 J ( routine) S 60 J ( can) S 60 J ( be) S 60 J ( called,) S 60 J ( see) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F I (Kernel-mode) S 60 J ( Driver) S 60 J ( Reference) S E 0 12 F 24 12 F (.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (10-) S E B (2) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (Like) S 60 J ( the) S 60 J ( ISR,) S 60 J ( a) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( must) S 60 J ( execute) S 60 J ( as) S 60 J ( quickly) S 60 J ( as) S 60 J ( possible,) S 60 J ( doing) S 60 J ( only) S 60 J ( what) S 
1200 2320 P (is) S 60 J ( necessary) S 60 J ( to) S 60 J ( set) S 60 J ( up) S 60 J ( device) S 60 J ( registers,) S 60 J ( update) S 60 J ( context) S 60 J ( data,) S 60 J ( and) S 60 J ( so) S 60 J ( forth,) S 60 J ( before) S 60 J ( returning) S 
1200 2580 P (control) S 60 J ( to) S 60 J ( the) S 60 J ( routine) S 60 J ( that) S 60 J ( called) S 0 12 F 24 12 F B () S 60 J ( KeSynchronizeExecution) S E 0 12 F 24 12 F (.) S 
1200 2960 P 0 12 F 24 12 F I (Because) S 60 J ( it) S 60 J ( is) S 60 J ( run) S 60 J ( at) S 60 J ( DIRQL,) S 60 J ( a) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( must) S 60 J ( return) S 60 J ( control) S 60 J ( as) S 60 J ( quickly) S 60 J ( as) S E 
1200 3220 P I (possible.) S E 0 12 F 24 12 F () S 60 J ( Each) S 60 J ( new) S 60 J ( NT) S 60 J ( device) S 60 J ( driver) S 60 J ( should) S 60 J ( be) S 60 J ( designed) S 60 J ( to) S 60 J ( minimize) S 60 J ( the) S 60 J ( time) S 60 J ( it) S 60 J ( spends) S 
1200 3480 P (running) S 60 J ( at) S 60 J ( DIRQL) S 60 J ( for) S 60 J ( each) S 60 J ( IRP) S 60 J ( it) S 60 J ( processes) S 60 J ( on) S 60 J ( the) S 60 J ( device.) S 
1200 4280 P 0 12 F 8 14 F B (10.2) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Implementing) S 78 J ( SynchCritSection) S 78 J ( Routines) S E 
1200 4900 P 0 12 F 24 12 F (NT) S 60 J ( device) S 60 J ( drivers) S 60 J ( use) S 60 J ( their) S 60 J ( SynchCritSection) S 60 J ( routines) S 60 J ( for) S 60 J ( two) S 60 J ( basic) S 60 J ( purposes:) S 
1200 5220 P () S 104 J ( 1) S 256 J ( To) S 60 J ( program) S 60 J ( a) S 60 J ( physical) S 60 J ( device,) S 60 J ( shared) S 60 J ( with) S 60 J ( the) S 60 J ( ISR,) S 60 J ( for) S 60 J ( an) S 60 J ( I/O) S 60 J ( operation) S 
1200 5540 P () S 104 J ( 2) S 256 J ( To) S 60 J ( access) S 60 J ( state) S 60 J ( information) S 60 J ( that) S 60 J ( is) S 60 J ( shared) S 60 J ( with) S 60 J ( the) S 60 J ( ISR) S 60 J ( from) S 60 J ( other) S 60 J ( driver) S 60 J ( routines) S 
1200 5920 P (For) S 60 J ( any) S 60 J ( incoming) S 60 J ( I/O) S 60 J ( request,) S 60 J ( NT) S 60 J ( device) S 60 J ( drivers) S 60 J ( do) S 60 J ( as) S 60 J ( much) S 60 J ( I/O) S 60 J ( processing) S 60 J ( as) S 60 J ( possible) S 60 J ( at) S 
1200 6180 P (IRQL) S 60 J ( PASSIVE_LEVEL) S 60 J ( or) S 60 J ( DISPATCH_LEVEL) S 60 J ( before) S 60 J ( they) S 60 J ( program) S 60 J ( a) S 60 J ( device) S 60 J ( for) S 60 J ( an) S 60 J ( I/O) S 
1200 6440 P (operation.) S 60 J ( For) S 60 J ( example,) S 60 J ( the) S 60 J ( drivers) S 60 J ( whose) S 60 J ( StartIo) S 60 J ( routines) S 60 J ( were) S 60 J ( discussed) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 7,) S 60 J ( call) S 
1200 6700 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( from) S 60 J ( the) S 60 J ( following) S 60 J ( driver) S 60 J ( routines:) S 
1200 7020 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( parallel) S 60 J ( driver) S 60 J ( makes) S 60 J ( the) S 60 J ( call) S 60 J ( with) S 60 J ( its) S 60 J ( SynchCritSection) S 60 J ( routine,) S 
1680 7280 P (ParStartCriticalFunctions,) S 60 J ( from) S 60 J ( its) S 60 J ( internal) S 60 J ( ParSynchronizeExecution) S 60 J ( routine,) S 60 J ( which) S 60 J ( was) S 
1680 7540 P (called) S 60 J ( by) S 60 J ( the) S 60 J ( ParStartIo) S 60 J ( routine,) S 60 J ( as) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 7.) S 
1680 7860 P (Note) S 60 J ( that) S 60 J ( the) S 60 J ( IRP) S 60 J ( and) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 60 J ( input) S 60 J ( to) S 60 J ( this) S 60 J ( driver's) S 60 J ( ParStartIo) S 60 J ( routine) S 
1680 8120 P (represent) S 60 J ( the) S 60 J ( current) S 60 J ( request) S 60 J ( for) S 60 J ( a) S 60 J ( single) S 60 J ( parallel) S 60 J ( port.) S 
1200 8440 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver) S 60 J ( makes) S 60 J ( the) S 60 J ( call) S 60 J ( with) S 60 J ( its) S 60 J ( SynchCritSection) S 60 J ( routine,) S 60 J ( AtStartDevice,) S 
1680 8700 P (from) S 60 J ( its) S 60 J ( ControllerControl) S 60 J ( routine,) S 60 J ( AtInitiate,) S 60 J ( as) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 11,) S 60 J ( effectively) S 
1680 8960 P (postponing) S 60 J ( setting) S 60 J ( up) S 60 J ( the) S 60 J ( disk) S 60 J ( controller) S 60 J ( for) S 60 J ( an) S 60 J ( input) S 60 J ( IRP) S 60 J ( as) S 60 J ( long) S 60 J ( as) S 60 J ( possible.) S 
1680 9280 P (This) S 60 J ( driver's) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( cannot) S 60 J ( program) S 60 J ( the) S 60 J ( disk) S 60 J ( controller,) S 60 J ( which) S 60 J ( might) S 60 J ( already) S 60 J ( be) S 
1680 9540 P (in) S 60 J ( use) S 60 J ( for) S 60 J ( an) S 60 J ( I/O) S 60 J ( operation) S 60 J ( on) S 60 J ( the) S 60 J ( other) S 60 J ( attached) S 60 J ( disk,) S 60 J ( until) S 60 J ( the) S 60 J ( physical) S 60 J ( controller) S 60 J ( is) S 60 J ( free.) S 
1680 9800 P (First,) S 60 J ( this) S 60 J ( driver) S 60 J ( must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoAllocateController) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( AtInitiate) S 60 J ( to) S 60 J ( synchronize) S 
1680 10060 P (operations) S 60 J ( through) S 60 J ( the) S 60 J ( disk) S 60 J ( controller,) S 60 J ( and) S 60 J ( then) S 60 J ( it) S 60 J ( sets) S 60 J ( up) S 60 J ( an) S 60 J ( I/O) S 60 J ( operation) S 60 J ( from) S 
1680 10320 P (AtInitiate,) S 60 J ( which,) S 60 J ( in) S 60 J ( turn,) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( AtStartDevice.) S 
1680 10640 P (If) S 60 J ( a) S 60 J ( transfer) S 60 J ( operation) S 60 J ( on) S 60 J ( the) S 60 J ( disk) S 60 J ( controller) S 60 J ( does) S 60 J ( not) S 60 J ( fully) S 60 J ( satisfy) S 60 J ( a) S 60 J ( particular) S 60 J ( request,) S 60 J ( the) S 
1680 10900 P ("AT") S 60 J ( disk) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( routine,) S 60 J ( as) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 9,) S 60 J ( also) S 60 J ( uses) S 60 J ( AtStartDevice) S 60 J ( to) S 
1680 11160 P (program) S 60 J ( the) S 60 J ( disk) S 60 J ( controller) S 60 J ( for) S 60 J ( additional) S 60 J ( transfer) S 60 J ( operations.) S 
1200 11540 P (In) S 60 J ( a) S 60 J ( similar) S 60 J ( manner,) S 60 J ( the) S 60 J ( driver) S 60 J ( of) S 60 J ( a) S 60 J ( DMA) S 60 J ( device) S 60 J ( should) S 60 J ( call) S 60 J ( its) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( to) S 
1200 11800 P (program) S 60 J ( its) S 60 J ( device) S 60 J ( for) S 60 J ( an) S 60 J ( I/O) S 60 J ( operation) S 60 J ( either) S 60 J ( from) S 60 J ( its) S 60 J ( AdapterControl) S 60 J ( routine) S 60 J ( or) S 60 J ( after) S 60 J ( its) S 
1200 12060 P (AdapterControl) S 60 J ( has) S 60 J ( been) S 60 J ( called) S 60 J ( for) S 60 J ( a) S 60 J ( given) S 60 J ( request.) S 60 J ( A) S 60 J ( driver's) S 60 J ( AdapterControl) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 
1200 12320 P (only) S 60 J ( when) S 60 J ( the) S 60 J ( driver's) S 60 J ( adapter) S 60 J ( object,) S 60 J ( representing) S 60 J ( a) S 60 J ( system) S 60 J ( DMA) S 60 J ( controller) S 60 J ( channel) S 60 J ( or) S 60 J ( a) S 
1200 12580 P (busmaster) S 60 J ( DMA) S 60 J ( device,) S 60 J ( is) S 60 J ( not) S 60 J ( in) S 60 J ( use) S 60 J ( by) S 60 J ( any) S 60 J ( other) S 60 J ( driver) S 60 J ( routine.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
1200 12840 P (adapter) S 60 J ( objects) S 60 J ( and) S 60 J ( how) S 60 J ( to) S 60 J ( stage) S 60 J ( DMA) S 60 J ( processing,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 3.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
1200 13100 P (AdapterControl) S 60 J ( routines,) S 60 J ( see) S 60 J ( also) S 60 J ( Chapter) S 60 J ( 11.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4065 J ( SynchCritSection) S 55 J ( Routines) S 807 J ( 10-) S E B (3) S E B () S 720 J ( ) S E 
1920 2180 P 0 12 F 24 12 F (Drivers) S 60 J ( whose) S 60 J ( DpcForIsr,) S 60 J ( CustomDpc,) S 60 J ( IoTimer,) S 60 J ( or) S 60 J ( CustomTimerDpc) S 60 J ( routines) S 60 J ( access) S 60 J ( the) S 
1920 2440 P (device) S 60 J ( or) S 60 J ( share) S 60 J ( state) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( extension) S 60 J ( with) S 60 J ( the) S 60 J ( ISR) S 60 J ( also) S 60 J ( use) S 60 J ( various) S 60 J ( techniques) S 60 J ( to) S 60 J ( make) S 
1920 2700 P (their) S 60 J ( SynchCritSection) S 60 J ( routines) S 60 J ( run) S 60 J ( as) S 60 J ( quickly) S 60 J ( as) S 60 J ( possible.) S 60 J ( Two) S 60 J ( of) S 60 J ( the) S 60 J ( drivers) S 60 J ( whose) S 
1920 2960 P (DpcForIsr) S 60 J ( routines) S 60 J ( were) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 9) S 60 J ( use) S 60 J ( the) S 60 J ( following) S 60 J ( techniques) S 60 J ( to) S 60 J ( minimize) S 60 J ( the) S 
1920 3220 P (execution) S 60 J ( intervals) S 60 J ( of) S 60 J ( their) S 60 J ( SynchCritSection) S 60 J ( routines:) S 
1920 3540 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( i8042) S 60 J ( port) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( queues) S 60 J ( itself) S 60 J ( as) S 60 J ( a) S 60 J ( CustomTimerDpc) S 60 J ( routine,) S 60 J ( rather) S 60 J ( than) S 
2400 3800 P (stalling) S 60 J ( on) S 60 J ( the) S 60 J ( processor,) S 60 J ( if) S 60 J ( the) S 60 J ( system-supplied) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver's) S 
2400 4060 P (KeyboardClassServiceCallback) S 60 J ( \(see) S 60 J ( Chapter) S 60 J ( 9) S 60 J ( or) S 60 J ( 12\)) S 60 J ( has) S 60 J ( already) S 60 J ( transferred) S 60 J ( as) S 60 J ( many) S 
2400 4320 P (keystrokes) S 60 J ( as) S 60 J ( its) S 60 J ( internal) S 60 J ( ring) S 60 J ( buffer) S 60 J ( can) S 60 J ( hold) S 60 J ( from) S 60 J ( the) S 60 J ( i8042) S 60 J ( port) S 60 J ( driver's) S 60 J ( data) S 60 J ( input) S 
2400 4580 P (queue.) S 
1920 4900 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver) S 60 J ( also) S 60 J ( maintains) S 60 J ( a) S 60 J ( timer) S 60 J ( counter) S 60 J ( in) S 60 J ( its) S 60 J ( device) S 60 J ( extension) S 60 J ( to) S 60 J ( check) S 
2400 5160 P (whether) S 60 J ( a) S 60 J ( device) S 60 J ( I/O) S 60 J ( operation) S 60 J ( has) S 60 J ( timed) S 60 J ( out.) S 60 J ( Its) S 60 J ( AtInitiate) S 60 J ( routine) S 60 J ( initializes) S 60 J ( the) S 60 J ( timer) S 
2400 5420 P (count.) S 60 J ( Its) S 60 J ( IoTimer) S 60 J ( routine) S 60 J ( \(see) S 60 J ( Chapter) S 60 J ( 11\)) S 60 J ( decrements) S 60 J ( this) S 60 J ( counter) S 60 J ( by) S 60 J ( calling) S 
2400 5680 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( yet) S 60 J ( another) S 60 J ( SynchCritSection) S 60 J ( routine,) S 
2400 5940 P (AtCheckTimerSynch,) S 60 J ( which,) S 60 J ( like) S 60 J ( the) S 60 J ( driver's) S 60 J ( DpcForIsr,) S 60 J ( can) S 60 J ( call) S 
2400 6200 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( AtDiskStartReset.) S 60 J ( Its) S 60 J ( ISR,) S 60 J ( as) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 8,) S 60 J ( clears) S 
2400 6460 P (the) S 60 J ( timer) S 60 J ( counter) S 60 J ( when) S 60 J ( it) S 60 J ( is) S 60 J ( called) S 60 J ( to) S 60 J ( handle) S 60 J ( an) S 60 J ( interrupt) S 60 J ( from) S 60 J ( the) S 60 J ( disk) S 60 J ( controller.) S 
1920 6840 P (The) S 60 J ( following) S 60 J ( subsections) S 60 J ( discuss) S 60 J ( SynchCritSection) S 60 J ( routines,) S 60 J ( showing) S 60 J ( a) S 60 J ( representative) S 60 J ( set) S 60 J ( of) S 
1920 7100 P (SynchCritSection) S 60 J ( routines) S 60 J ( that) S 60 J ( are) S 60 J ( called) S 60 J ( from) S 60 J ( drivers') S 60 J ( StartIo,) S 60 J ( ControllerControl,) S 60 J ( DpcForIsr,) S 
1920 7360 P (and) S 60 J ( IoTimer) S 60 J ( routines.) S 
1920 8000 P 0 12 F 8 12 F B (10.2.1) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( SynchCritSection) S 67 J ( Routines) S 67 J ( to) S 67 J ( Program) S 67 J ( the) S 67 J ( Device) S E 
1920 8620 P 0 12 F 24 12 F (As) S 60 J ( already) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Section) S 60 J ( 10.2,) S 60 J ( the) S 60 J ( parallel) S 60 J ( driver) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 
1920 8880 P (its) S 60 J ( ParStartCriticalFunctions) S 60 J ( routine) S 60 J ( to) S 60 J ( set) S 60 J ( up) S 60 J ( the) S 60 J ( parallel) S 60 J ( controller) S 60 J ( for) S 60 J ( a) S 60 J ( write) S 60 J ( operation.) S 60 J ( As) S 
1920 9140 P (mentioned) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 7,) S 60 J ( the) S 60 J ( internal) S 60 J ( ParSynchronizeExecution) S 60 J ( routine) S 60 J ( calls) S 
1920 9400 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( only) S 60 J ( if) S 60 J ( the) S 60 J ( driver) S 60 J ( has) S 60 J ( claimed) S 60 J ( an) S 60 J ( interrupt) S 60 J ( for) S 60 J ( the) S 60 J ( port) S 60 J ( and) S 60 J ( is) S 60 J ( using) S 
1920 9660 P (interrupt-driven) S 60 J ( I/O;) S 60 J ( otherwise,) S 60 J ( this) S 60 J ( driver) S 60 J ( uses) S 60 J ( a) S 60 J ( CustomTimerDpc) S 60 J ( routine) S 60 J ( to) S 60 J ( write) S 60 J ( data) S 
1920 9920 P (through) S 60 J ( the) S 60 J ( parallel) S 60 J ( port.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (10-) S E B (4) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (Consequently,) S 60 J ( the) S 60 J ( IRQL) S 60 J ( at) S 60 J ( which) S 60 J ( the) S 60 J ( driver's) S 60 J ( ParStartCriticalFunctions) S 60 J ( runs) S 60 J ( depends) S 60 J ( on) S 
1200 2320 P (whether) S 60 J ( this) S 60 J ( driver) S 60 J ( is) S 60 J ( using) S 60 J ( an) S 60 J ( interrupt) S 60 J ( \(at) S 60 J ( DIRQL\)) S 60 J ( or) S 60 J ( is) S 60 J ( using) S 60 J ( a) S 60 J ( timer) S 60 J ( \(at) S 
1200 2580 P (DISPATCH_LEVEL\).) S 60 J ( In) S 60 J ( either) S 60 J ( case,) S 60 J ( ParStartCriticalFunctions) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 60 J ( an) S 60 J ( input) S 60 J ( pointer) S 
1200 2840 P (\(of) S 60 J ( type) S 60 J ( PVOID\)) S 60 J ( to) S 60 J ( a) S 60 J ( driver-determined) S 60 J ( context,) S 60 J ( as) S 60 J ( follows:) S 
1680 3360 P 0 12 F 0 12 F ({) S 
1680 3620 P () S 480 J ( PDEVICE_OBJECT) S 144 J ( deviceObject) S 144 J ( =) S 144 J ( Context;) S 
1680 3880 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp) S 144 J ( =) S 
1680 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( IoGetCurrentIrpStackLocation\() S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceObject->CurrentIrp\);) S 
1680 4660 P () S 480 J ( PPAR_DEVICE_EXTENSION) S 144 J ( extension) S 144 J ( =) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( deviceObject->DeviceExtension;) S 
1680 5440 P () S 480 J ( extension->Command) S 144 J ( =) S 144 J ( ParWrite;) S 
1680 5700 P (//) S 
1680 5960 P (//) S 144 J ( Initialize) S 144 J ( the) S 144 J ( state) S 144 J ( machine) S 144 J ( for) S 144 J ( this) S 144 J ( packet) S 
1680 6220 P (//) S 144 J ( so) S 144 J ( the) S 144 J ( remainder) S 144 J ( of) S 144 J ( the) S 144 J ( driver) S 144 J ( can) S 144 J ( determine) S 
1680 6480 P (//) S 144 J ( the) S 144 J ( number) S 144 J ( of) S 144 J ( characters) S 144 J ( to) S 144 J ( be) S 144 J ( written) S 144 J ( to) S 144 J ( the) S 144 J ( device.) S 
1680 6740 P (//) S 
1680 7000 P () S 480 J ( extension->CompletingIoControl) S 144 J ( =) S 144 J ( FALSE;) S 
1680 7260 P () S 480 J ( extension->CountBuffer) S 144 J ( =) S 144 J ( irpSp->Parameters.Write.Length;) S 
1680 7520 P (//) S 
1680 7780 P (//) S 144 J ( Patch) S 144 J ( for) S 144 J ( a) S 144 J ( particular) S 144 J ( printer) S 144 J ( model) S 144 J ( without) S 144 J ( an) S 144 J ( INIT) S 144 J ( pin.) S 
1680 8040 P (//) S 
1680 8300 P () S 480 J ( if) S 144 J ( \(!extension->Initialized\)) S 144 J ( {) S 
1680 8560 P () S 480 J ( ) S 480 J ( UCHAR) S 144 J ( deviceStatus) S 144 J ( =) S 
1680 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( GetStatus\(extension->Controller\);) S 
1680 9080 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(PAR_OK\(deviceStatus\)\)) S 144 J ( {) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( extension->Initialized) S 144 J ( =) S 144 J ( TRUE;) S 
1680 9600 P () S 480 J ( ) S 480 J ( }) S 
1680 9860 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( patch) S 
1680 10120 P () S 480 J ( if) S 144 J ( \(extension->Initialized\)) S 144 J ( {) S 
1680 10380 P () S 480 J ( ) S 480 J ( ParInitiateIo\(deviceObject\);) S 
1680 10640 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 10900 P () S 480 J ( ) S 480 J ( extension->AutoFeed) S 144 J ( =) S 144 J ( FALSE;) S 
1680 11160 P () S 480 J ( ) S 480 J ( ParInitializeDevice\(extension\);) S 
1680 11420 P () S 480 J ( }) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4065 J ( SynchCritSection) S 55 J ( Routines) S 807 J ( 10-) S E B (5) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( If) S 144 J ( the) S 144 J ( driver's) S 144 J ( running) S 144 J ( off) S 144 J ( a) S 144 J ( timer,) S 144 J ( just) S 144 J ( queue) S 144 J ( off) S 
2400 2580 P (//) S 144 J ( the) S 144 J ( "polling") S 144 J ( code.) S 
2400 2840 P (//) S 
2400 3100 P () S 480 J ( if) S 144 J ( \(extension->UsingATimer\)) S 144 J ( {) S 
2400 3360 P () S 480 J ( ) S 480 J ( KeInsertQueueDpc\() S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &extension->PollingDpc,) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( NULL,) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( NULL\);) S 
2400 4400 P () S 480 J ( }) S 
2400 4660 P () S 480 J ( return) S 144 J ( FALSE;) S 
2400 4920 P (}) S 
1920 5300 P 0 12 F 24 12 F (If) S 60 J ( the) S 60 J ( preceding) S 60 J ( routine) S 60 J ( is) S 60 J ( running) S 60 J ( at) S 60 J ( DIRQL,) S 60 J ( the) S 60 J ( ParInitiateIo) S 60 J ( routine) S 60 J ( it) S 60 J ( calls) S 60 J ( also) S 60 J ( runs) S 60 J ( at) S 
1920 5560 P (DIRQL,) S 60 J ( as) S 60 J ( follows:) S 
2400 6080 P 0 12 F 0 12 F ({) S 
2400 6340 P () S 480 J ( PPAR_DEVICE_EXTENSION) S 144 J ( extension) S 144 J ( =) S 
2400 6600 P () S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
2400 6860 P () S 480 J ( PIRP) S 144 J ( irp;) S 
2400 7120 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp;) S 
2400 7380 P () S 480 J ( PUCHAR) S 144 J ( irpBuffer;) S 
2400 7900 P () S 480 J ( if) S 144 J ( \(extension->Initialized\)) S 144 J ( {) S 
2400 8160 P () S 480 J ( ) S 480 J ( UCHAR) S 144 J ( deviceStatus;) S 
2400 8420 P () S 480 J ( ) S 480 J ( ULONG) S 144 J ( numberWritten) S 144 J ( =) S 144 J ( 0;) S 
2400 8680 P () S 480 J ( ) S 480 J ( ULONG) S 144 J ( maxNumberToWrite;) S 
2400 8940 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(extension->InterruptMode) S 144 J ( =) S 144 J ( Latched\)) S 144 J ( {) S 
2400 9200 P () S 480 J ( ) S 480 J ( ) S 480 J ( maxNumberToWrite) S 144 J ( =) S 144 J ( 256;) S 
2400 9460 P () S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
2400 9720 P () S 480 J ( ) S 480 J ( ) S 480 J ( maxNumberToWrite) S 144 J ( =) S 144 J ( 32;) S 
2400 9980 P () S 480 J ( ) S 480 J ( }) S 
2400 10240 P () S 480 J ( ) S 480 J ( irp) S 144 J ( =) S 144 J ( DeviceObject->CurrentIrp;) S 
2400 10500 P () S 480 J ( ) S 480 J ( irpSp) S 144 J ( =) S 144 J ( IoGetCurrentIrpStackLocation\(irp\);) S 
2400 10760 P () S 480 J ( ) S 480 J ( irpBuffer) S 144 J ( =) S 144 J ( \(PUCHAR\)\(irp->) S 
2400 11020 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( AssociatedIrp.SystemBuffer\);) S 
2400 11280 P () S 480 J ( ) S 480 J ( irpBuffer) S 144 J ( =) S 144 J ( &irpBuffer[irpSp->) S 
2400 11540 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Parameters.Write.Length) S 144 J ( -) S 
2400 11800 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension->CountBuffer];) S 0 12 F 
PE 
1200 1220 P 10 12 F B (10-) S E B (6) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( do) S 144 J ( {) S 
1680 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( deviceStatus) S 144 J ( =) S 144 J ( GetStatus\(extension->Controller\);) S 
1680 2580 P (//) S 
1680 2840 P (//) S 144 J ( Write) S 144 J ( to) S 144 J ( the) S 144 J ( port) S 144 J ( only) S 144 J ( when) S 144 J ( the) S 144 J ( device) S 144 J ( is) S 144 J ( on) S 144 J ( line.) S 
1680 3100 P (//) S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(PAR_ONLINE\(deviceStatus\)\)) S 144 J ( {) S 
1680 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( StoreData\() S 
1680 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension->Controller,) S 
1680 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( *irpBuffer\);) S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( irpBuffer++;) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( extension->CountBuffer--;) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( numberWritten++;) S 
1680 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( debugging) S 
1680 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
1680 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
1680 6220 P () S 480 J ( ) S 480 J ( }) S 144 J ( while) S 144 J ( \(extension->CountBuffer) S 144 J ( &&) S 
1680 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(numberWritten) S 144 J ( <) S 144 J ( maxNumberToWrite\)\);) S 
1680 6740 P () S 480 J ( }) S 
1680 7000 P () S 480 J ( extension->TimerCount) S 144 J ( =) S 144 J ( extension->TimerStart;) S 
1680 7260 P () S 480 J ( return) S 144 J ( FALSE;) S 
1680 7520 P (}) S 
1200 7900 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( this) S 60 J ( driver's) S 60 J ( ISR,) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 8,) S 60 J ( also) S 60 J ( called) S 60 J ( the) S 60 J ( internal) S 60 J ( ParInitiateIo) S 60 J ( routine) S 60 J ( if) S 
1200 8160 P (there) S 60 J ( were) S 60 J ( characters) S 60 J ( remaining) S 60 J ( \(according) S 60 J ( to) S 60 J ( the) S 60 J ( ) S 0 12 F 0 12 F (extension->CountBuffer) S 0 12 F 24 12 F () S 60 J ( value\)) S 60 J ( to) S 
1200 8420 P (be) S 60 J ( written) S 60 J ( through) S 60 J ( the) S 60 J ( port) S 60 J ( controller.) S 
1200 8800 P (Note) S 60 J ( also) S 60 J ( that,) S 60 J ( if) S 60 J ( the) S 60 J ( driver) S 60 J ( has) S 60 J ( not) S 60 J ( claimed) S 60 J ( an) S 60 J ( interrupt) S 60 J ( for) S 60 J ( the) S 60 J ( parallel) S 60 J ( port) S 60 J ( or) S 60 J ( has) S 60 J ( disabled) S 
1200 9060 P (device) S 60 J ( interrupts,) S 60 J ( its) S 60 J ( ISR) S 60 J ( and) S 60 J ( ParStartCriticalFunctions) S 60 J ( routines) S 60 J ( both) S 60 J ( run) S 60 J ( at) S 60 J ( IRQL) S 
1200 9320 P (DISPATCH_LEVEL:) S 60 J ( that) S 60 J ( is,) S 60 J ( its) S 60 J ( ISR) S 60 J ( is) S 60 J ( called) S 60 J ( from) S 60 J ( the) S 60 J ( CustomTimerDpc,) S 60 J ( ParPolling,) S 60 J ( which) S 
1200 9580 P (ParStartCriticalFunctions) S 60 J ( queued) S 60 J ( for) S 60 J ( execution) S 60 J ( as) S 60 J ( a) S 60 J ( CustomDpc) S 60 J ( routine) S 60 J ( when) S 60 J ( it) S 60 J ( called) S 
1200 9840 P 0 12 F 24 12 F B (KeInsertQueueDpc) S E 0 12 F 24 12 F (.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( CustomTimerDpc) S 60 J ( routines) S 60 J ( like) S 60 J ( ParPolling,) S 
1200 10100 P (see) S 60 J ( Chapter) S 60 J ( 14.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4065 J ( SynchCritSection) S 55 J ( Routines) S 807 J ( 10-) S E B (7) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 6,) S 60 J ( drivers) S 60 J ( that) S 60 J ( use) S 60 J ( direct) S 60 J ( I/O) S 60 J ( might) S 60 J ( have) S 60 J ( to) S 60 J ( split) S 60 J ( up) S 60 J ( transfer) S 60 J ( requests) S 
1920 2320 P (that) S 60 J ( are) S 60 J ( too) S 60 J ( large) S 60 J ( for) S 60 J ( their) S 60 J ( devices) S 60 J ( to) S 60 J ( handle) S 60 J ( in) S 60 J ( a) S 60 J ( single) S 60 J ( transfer) S 60 J ( operation.) S 60 J ( As) S 60 J ( mentioned) S 60 J ( in) S 
1920 2580 P (Chapter) S 60 J ( 9,) S 60 J ( the) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver,) S 60 J ( can) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( AtStartDevice) S 
1920 2840 P (routine) S 60 J ( both) S 60 J ( from) S 60 J ( its) S 60 J ( ControllerControl) S 60 J ( and) S 60 J ( DpcForIsr) S 60 J ( routines) S 60 J ( for) S 60 J ( a) S 60 J ( single) S 60 J ( IRP.) S 60 J ( Each) S 60 J ( of) S 60 J ( these) S 
1920 3100 P (routines) S 60 J ( passes) S 60 J ( a) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 60 J ( that) S 60 J ( represents) S 60 J ( the) S 60 J ( disk) S 60 J ( to) S 
1920 3360 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F (.) S 60 J ( On) S 60 J ( entry,) S 60 J ( AtStartDevice) S 60 J ( is) S 60 J ( given) S 60 J ( this) S 60 J ( pointer) S 60 J ( to) S 60 J ( the) S 60 J ( driver-) S 
1920 3620 P (determined) S 60 J ( context) S 60 J ( for) S 60 J ( the) S 60 J ( requested) S 60 J ( I/O) S 60 J ( operation,) S 60 J ( as) S 60 J ( follows:) S 
2400 4140 P 0 12 F 0 12 F ({) S 
2400 4400 P () S 480 J ( PDISK_EXTENSION) S 144 J ( diskExtension) S 144 J ( =) S 144 J ( Context;) S 
2400 4660 P () S 480 J ( PCONTROLLER_EXTENSION) S 144 J ( controllerExtension) S 144 J ( =) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->ControllerExtension;) S 
2400 5180 P () S 480 J ( NTSTATUS) S 144 J ( ntStatus;) S 
2400 5440 P () S 480 J ( ULONG) S 144 J ( loopCount) S 144 J ( =) S 144 J ( 0;) S 
2400 5700 P () S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( make) S 144 J ( sure) S 144 J ( controller) S 144 J ( is) S 144 J ( not) S 144 J ( busy) S 
2400 5960 P (//) S 
2400 6220 P (//) S 144 J ( Will) S 144 J ( soon) S 144 J ( cause) S 144 J ( an) S 144 J ( interrupt) S 144 J ( that) S 144 J ( will) S 144 J ( require) S 
2400 6480 P (//) S 144 J ( servicing) S 144 J ( by) S 144 J ( the) S 144 J ( DPC,) S 144 J ( so) S 144 J ( set) S 144 J ( these) S 144 J ( variables) S 144 J ( accordingly.) S 
2400 6740 P (//) S 
2400 7000 P () S 480 J ( controllerExtension->InterruptRequiresDpc) S 144 J ( =) S 144 J ( TRUE;) S 
2400 7260 P () S 480 J ( controllerExtension->WhichDeviceObject) S 144 J ( =) S 
2400 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->DeviceObject;) S 
2400 7780 P () S 480 J ( controllerExtension->InterruptTimer) S 144 J ( =) S 144 J ( START_TIMER;) S 
2400 8040 P (//) S 
2400 8300 P (//) S 144 J ( Program) S 144 J ( the) S 144 J ( operation) S 144 J ( on) S 144 J ( the) S 144 J ( controller.) S 
2400 8560 P (//) S 
2400 8820 P () S 480 J ( WRITE_CONTROLLER\() S 
2400 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->ControllerAddress) S 144 J ( +) S 
2400 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( SECTOR_COUNT_REGISTER,) S 
2400 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(diskExtension->TotalTransferLength) S 144 J ( /) S 
2400 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->BytesPerSector\)\);) S 
2400 10120 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( other) S 144 J ( WRITE_CONTROLLERs) S 144 J ( to) S 144 J ( registers) S 
2400 10380 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( set) S 144 J ( up) S 144 J ( identically) S 144 J ( for) S 144 J ( all) S 144 J ( operations) S 
2400 10640 P () S 480 J ( switch) S 144 J ( \(diskExtension->OperationType\)) S 144 J ( {) S 
2400 10900 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_READ:) S 144 J ( {) S 
2400 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( WRITE_CONTROLLER\() S 
2400 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->ControllerAddress) S 144 J ( +) S 
2400 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( COMMAND_REGISTER,) S 
2400 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->ReadCommand\);) S 
2400 12200 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 12460 P () S 480 J ( ) S 480 J ( }) S 0 12 F 
PE 
1200 1220 P 10 12 F B (10-) S E B (8) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_DEVICE_CONTROL:) S 144 J ( {) S 
1680 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 2580 P () S 480 J ( ) S 480 J ( }) S 
1680 2840 P () S 480 J ( ) S 480 J ( case) S 144 J ( IRP_MJ_WRITE:) S 144 J ( {) S 
1680 3100 P () S 480 J ( ) S 480 J ( ) S 480 J ( WRITE_CONTROLLER\() S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->ControllerAddress) S 144 J ( +) S 
1680 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( WRITE_PRECOMP_REGISTER,) S 
1680 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->WritePrecomp\);) S 
1680 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( WRITE_CONTROLLER\() S 
1680 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->ControllerAddress) S 144 J ( +) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( COMMAND_REGISTER,) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->WriteCommand\);) S 
1680 5180 P (//) S 
1680 5440 P (//) S 144 J ( Can't) S 144 J ( put) S 144 J ( data) S 144 J ( in) S 144 J ( the) S 144 J ( controller) S 144 J ( cache) S 144 J ( until) S 144 J ( it's) S 144 J ( ready.) S 
1680 5700 P (//) S 144 J ( \(To) S 144 J ( indicate) S 144 J ( readiness,) S 144 J ( it) S 144 J ( will) S 144 J ( turn) S 144 J ( off) S 144 J ( the) S 144 J ( BUSY_STATUS) S 
1680 5960 P (//) S 144 J ( bit) S 144 J ( and) S 144 J ( then) S 144 J ( assert) S 144 J ( DATA_REQUEST_STATUS;) S 144 J ( there's) S 144 J ( no) S 
1680 6220 P (//) S 144 J ( interrupt,) S 144 J ( so) S 144 J ( have) S 144 J ( to) S 144 J ( wait) S 144 J ( for) S 144 J ( that) S 144 J ( bit) S 144 J ( here\).) S 144 J ( This) S 
1680 6480 P (//) S 144 J ( can) S 144 J ( be) S 144 J ( a) S 144 J ( long) S 144 J ( wait) S 144 J ( on) S 144 J ( systems) S 144 J ( with) S 144 J ( power-saving) S 144 J ( features,) S 
1680 6740 P (//) S 144 J ( but) S 144 J ( should) S 144 J ( be) S 144 J ( reasonably) S 144 J ( fast) S 144 J ( on) S 144 J ( other) S 144 J ( systems.) S 
1680 7000 P (//) S 
1680 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ntStatus) S 144 J ( =) S 144 J ( AtWaitControllerReady\() S 
1680 7520 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension,) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 10,) S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( 5000\);) S 
1680 8300 P (//) S 
1680 8560 P (//) S 144 J ( Now) S 144 J ( wait) S 144 J ( for) S 144 J ( DATA_REQUEST_STATUS.) S 
1680 8820 P (//) S 
1680 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(NT_SUCCESS\(ntStatus\)\)) S 144 J ( {) S 
1680 9340 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( while) S 144 J ( \(\() S 144 J ( !\(READ_CONTROLLER\() S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->) S 
1680 9860 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerAddress) S 144 J ( +) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( STATUS_REGISTER\)) S 144 J ( &) S 
1680 10380 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DATA_REQUEST_STATUS\)\)) S 144 J ( &&) S 
1680 10640 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(loopCount++) S 144 J ( <) S 144 J ( 5000\)\)) S 144 J ( {) S 
1680 10900 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( KeStallExecutionProcessor\(10L\);) S 
1680 11160 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( stall) S 144 J ( no) S 144 J ( more) S 144 J ( than) S 144 J ( 50ms) S 
1680 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(loopCount) S 144 J ( >=) S 144 J ( 5000\)) S 144 J ( {) S 
1680 11680 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( report) S 144 J ( error) S 144 J ( if) S 144 J ( debugging) S 
1680 11940 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4065 J ( SynchCritSection) S 55 J ( Routines) S 807 J ( 10-) S E B (9) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Might) S 144 J ( have) S 144 J ( timed) S 144 J ( out,) S 144 J ( but) S 144 J ( blast) S 144 J ( ahead) S 144 J ( anyway:) S 
2400 2580 P (//) S 144 J ( the) S 144 J ( controller) S 144 J ( won't) S 144 J ( interrupt) S 144 J ( since) S 144 J ( it) S 144 J ( won't) S 
2400 2840 P (//) S 144 J ( get) S 144 J ( all) S 144 J ( of) S 144 J ( this) S 144 J ( information,) S 144 J ( so) S 144 J ( this'll) S 144 J ( time) S 144 J ( out) S 
2400 3100 P (//) S 144 J ( since) S 144 J ( the) S 144 J ( timer) S 144 J ( is) S 144 J ( still) S 144 J ( running.) S 144 J ( Copy) S 144 J ( the) S 144 J ( data) S 
2400 3360 P (//) S 144 J ( to) S 144 J ( the) S 144 J ( cache) S 144 J ( and) S 144 J ( update) S 144 J ( the) S 144 J ( user's) S 144 J ( address.) S 
2400 3620 P (//) S 
2400 3880 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( if) S 144 J ( \(loopCount) S 144 J ( <) S 144 J ( 5000\)) S 144 J ( {) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( WRITE_CONTROLLER_BUFFER\() S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->) S 
2400 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ControllerAddress) S 144 J ( +) S 
2400 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DATA_REGISTER,) S 
2400 5180 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->CurrentAddress,) S 
2400 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->BytesPerInterrupt\);) S 
2400 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->CurrentAddress) S 144 J ( +=) S 
2400 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( diskExtension->BytesPerInterrupt\);) S 
2400 6220 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( }) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( break;) S 
2400 7000 P () S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( case) S 144 J ( IRP_MJ_WRITE) S 
2400 7260 P () S 480 J ( ) S 480 J ( default:) S 144 J ( {) S 
2400 7520 P (//) S 
2400 7780 P (//) S 144 J ( Should) S 144 J ( never) S 144 J ( get) S 144 J ( to) S 144 J ( here.) S 144 J ( Read,) S 144 J ( write,) S 144 J ( and) S 144 J ( the) S 144 J ( VERIFY) S 
2400 8040 P (//) S 144 J ( IOCTL) S 144 J ( should) S 144 J ( be) S 144 J ( the) S 144 J ( only) S 144 J ( possibilities.) S 
2400 8300 P (//) S 
2400 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( report) S 144 J ( error) S 144 J ( \(BUGCHECK...\)) S 144 J ( if) S 144 J ( debugging) S 
2400 8820 P () S 480 J ( ) S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( cases) S 
2400 9080 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( switch) S 
2400 9340 P () S 480 J ( return) S 144 J ( TRUE;) S 
2400 9600 P (}) S 
1920 9980 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( AtStartDevice) S 60 J ( relies) S 60 J ( on) S 60 J ( the) S 60 J ( driver's) S 60 J ( time-out) S 60 J ( handling) S 60 J ( if) S 60 J ( it) S 60 J ( cannot) S 60 J ( program) S 60 J ( the) S 60 J ( disk) S 
1920 10240 P (controller) S 60 J ( for) S 60 J ( a) S 60 J ( write) S 60 J ( operation) S 60 J ( within) S 60 J ( a) S 60 J ( reasonable) S 60 J ( interval.) S 60 J ( If) S 60 J ( necessary,) S 60 J ( this) S 60 J ( driver) S 60 J ( resets) S 60 J ( the) S 
1920 10500 P (controller) S 60 J ( when) S 60 J ( operations) S 60 J ( time) S 60 J ( out) S 60 J ( for) S 60 J ( either) S 60 J ( attached) S 60 J ( disk:) S 60 J ( that) S 60 J ( is,) S 60 J ( the) S 60 J ( driver's) S 60 J ( DpcForIsr) S 
1920 10760 P (routine) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( AtDiskStartReset.) S 60 J ( Its) S 60 J ( IoTimer) S 60 J ( routine) S 60 J ( also) S 60 J ( might) S 
1920 11020 P (call) S 60 J ( AtDiskStartReset) S 60 J ( indirectly) S 60 J ( from) S 60 J ( the) S 60 J ( SynchCritSection) S 60 J ( routine,) S 60 J ( AtCheckTimerSynch) S 60 J ( \(see) S 
1920 11280 P (Section) S 60 J ( 10.2.2,) S 60 J ( next\),) S 60 J ( that) S 60 J ( it) S 60 J ( passes) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F (.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (10-) S E B (10) S E B () S 818 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2080 P 0 12 F 8 12 F B (10.2.2) S 67 J ( ) S 67 J ( ) S 67 J ( ) S 67 J ( SynchCritSection) S 67 J ( Routines) S 67 J ( to) S 67 J ( Update) S 67 J ( State) S 67 J ( Information) S E 
1200 2700 P 0 12 F 24 12 F (As) S 60 J ( already) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Section) S 60 J ( 10.2,) S 60 J ( the) S 60 J ( "AT") S 60 J ( disk) S 60 J ( driver) S 60 J ( also) S 60 J ( maintains) S 60 J ( a) S 60 J ( timer) S 60 J ( counter) S 60 J ( in) S 
1200 2960 P (its) S 60 J ( device) S 60 J ( extension) S 60 J ( that) S 60 J ( several) S 60 J ( of) S 60 J ( its) S 60 J ( routines,) S 60 J ( including) S 60 J ( its) S 60 J ( ISR,) S 60 J ( access.) S 60 J ( Its) S 60 J ( ControllerControl) S 
1200 3220 P (routine,) S 60 J ( AtInitiate,) S 60 J ( initializes) S 60 J ( this) S 60 J ( timer) S 60 J ( counter.) S 60 J ( Its) S 60 J ( ISR,) S 60 J ( as) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 8,) S 60 J ( clears) S 60 J ( the) S 
1200 3480 P (timer) S 60 J ( counter) S 60 J ( when) S 60 J ( it) S 60 J ( is) S 60 J ( called) S 60 J ( to) S 60 J ( handle) S 60 J ( an) S 60 J ( interrupt) S 60 J ( from) S 60 J ( the) S 60 J ( disk) S 60 J ( controller.) S 
1200 3860 P (Its) S 60 J ( IoTimer) S 60 J ( routine) S 60 J ( \(see) S 60 J ( Chapter) S 60 J ( 11\)) S 60 J ( decrements) S 60 J ( this) S 60 J ( shared) S 60 J ( counter) S 60 J ( by) S 60 J ( calling) S 
1200 4120 P 0 12 F 24 12 F B (KeSynchronizeExecution) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( following) S 60 J ( SynchCritSection) S 60 J ( routine,) S 
1200 4380 P (AtCheckTimerSynch:) S 
1680 4900 P 0 12 F 0 12 F ({) S 
1680 5160 P () S 480 J ( PCONTROLLER_EXTENSION) S 144 J ( controllerExtension) S 144 J ( =) S 144 J ( Context;) S 
1680 5420 P () S 480 J ( PDISK_EXTENSION) S 144 J ( diskExtension;) S 
1680 5680 P (//) S 
1680 5940 P (//) S 144 J ( When) S 144 J ( the) S 144 J ( counter) S 144 J ( is) S 144 J ( -1,) S 144 J ( the) S 144 J ( timer) S 144 J ( is) S 144 J ( "off,") S 144 J ( so) S 144 J ( don't) S 
1680 6200 P (//) S 144 J ( do) S 144 J ( anything.) S 144 J ( The) S 144 J ( ISR) S 144 J ( might've) S 144 J ( turned) S 144 J ( it) S 144 J ( off) S 144 J ( since) S 
1680 6460 P (//) S 144 J ( it) S 144 J ( was) S 144 J ( last) S 144 J ( checked) S 144 J ( in) S 144 J ( AtDiskCheckTimer,) S 144 J ( which) S 
1680 6720 P (//) S 144 J ( called) S 144 J ( this) S 144 J ( routine.) S 
1680 6980 P (//) S 
1680 7240 P () S 480 J ( if) S 144 J ( \(controllerExtension->InterruptTimer) S 144 J ( ==) S 
1680 7500 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( CANCEL_TIMER\)) S 144 J ( {) S 
1680 7760 P () S 480 J ( ) S 480 J ( return) S 144 J ( TRUE;) S 
1680 8020 P () S 480 J ( }) S 
1680 8280 P (//) S 
1680 8540 P (//) S 144 J ( The) S 144 J ( timer) S 144 J ( is) S 144 J ( "on,") S 144 J ( so) S 144 J ( decrement) S 144 J ( it.) S 
1680 8800 P (//) S 
1680 9060 P () S 480 J ( controllerExtension->InterruptTimer--;) S 
1680 9320 P (//) S 
1680 9580 P (//) S 144 J ( If) S 144 J ( it's) S 144 J ( hit) S 144 J ( zero,) S 144 J ( the) S 144 J ( timer) S 144 J ( has) S 144 J ( expired,) S 
1680 9840 P (//) S 144 J ( so) S 144 J ( reset) S 144 J ( the) S 144 J ( controller.) S 
1680 10100 P (//) S 
1680 10360 P () S 480 J ( if) S 144 J ( \(controllerExtension->InterruptTimer) S 144 J ( ==) S 
1680 10620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( EXPIRED_TIMER\)) S 144 J ( {) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4065 J ( SynchCritSection) S 55 J ( Routines) S 698 J ( 10-) S E B (11) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Make) S 144 J ( sure) S 144 J ( the) S 144 J ( device) S 144 J ( extension) S 144 J ( is) S 144 J ( for) S 144 J ( the) S 144 J ( drive) S 144 J ( that) S 
2400 2580 P (//) S 144 J ( timed) S 144 J ( out.) S 144 J ( It) S 144 J ( can) S 144 J ( only) S 144 J ( be) S 144 J ( the) S 144 J ( device) S 144 J ( extension) S 144 J ( for) S 
2400 2840 P (//) S 144 J ( Disk1) S 144 J ( if) S 144 J ( EXPIRED_TIMER's) S 144 J ( already) S 144 J ( set,) S 144 J ( because) S 144 J ( that's) S 
2400 3100 P (//) S 144 J ( where) S 144 J ( DriverEntry) S 144 J ( stored) S 144 J ( the) S 144 J ( timer) S 144 J ( object) S 144 J ( and) S 144 J ( state) S 
2400 3360 P (//) S 144 J ( when) S 144 J ( it) S 144 J ( created) S 144 J ( device) S 144 J ( objects) S 144 J ( for) S 144 J ( these) S 144 J ( disks.) S 
2400 3620 P (//) S 
2400 3880 P () S 480 J ( ) S 480 J ( diskExtension) S 144 J ( =) S 144 J ( controllerExtension->) S 
2400 4140 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( WhichDeviceObject->) S 
2400 4400 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceExtension;) S 
2400 4660 P (//) S 
2400 4920 P (//) S 144 J ( If) S 144 J ( ALREADY) S 144 J ( resetting) S 144 J ( the) S 144 J ( controller) S 144 J ( when) S 144 J ( it) S 144 J ( timed) S 144 J ( out,) S 
2400 5180 P (//) S 144 J ( there's) S 144 J ( something) S 144 J ( seriously) S 144 J ( wrong) S 144 J ( with) S 144 J ( the) S 144 J ( hardware.) S 
2400 5440 P (//) S 
2400 5700 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(controllerExtension->ResettingController) S 144 J ( !=) S 
2400 5960 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( RESET_NOT_RESETTING\)) S 144 J ( {) S 
2400 6220 P (//) S 
2400 6480 P (//) S 144 J ( Returning) S 144 J ( FALSE) S 144 J ( will) S 144 J ( cause) S 144 J ( the) S 144 J ( current) S 144 J ( IRP) S 144 J ( to) S 144 J ( be) S 
2400 6740 P (//) S 144 J ( completed) S 144 J ( with) S 144 J ( an) S 144 J ( error.) S 144 J ( Subsequent) S 144 J ( IRPs) S 144 J ( will) S 144 J ( probably) S 
2400 7000 P (//) S 144 J ( get) S 144 J ( a) S 144 J ( time) S 144 J ( out) S 144 J ( and) S 144 J ( and) S 144 J ( another) S 144 J ( attempt) S 144 J ( to) S 144 J ( reset) S 
2400 7260 P (//) S 144 J ( the) S 144 J ( controller,) S 144 J ( but) S 144 J ( this) S 144 J ( is) S 144 J ( really) S 144 J ( unlikely) S 144 J ( to) S 144 J ( happen.) S 
2400 7520 P (//) S 
2400 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( controllerExtension->InterruptTimer) S 144 J ( =) S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( CANCEL_TIMER;) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( return) S 144 J ( FALSE;) S 
2400 8560 P () S 480 J ( ) S 480 J ( }) S 
2400 8820 P () S 480 J ( ) S 480 J ( AtDiskStartReset\(diskExtension\);) S 
2400 9080 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( if) S 144 J ( timer) S 144 J ( expired) S 
2400 9340 P () S 480 J ( return) S 144 J ( TRUE;) S 
2400 9600 P (}) S 
1920 9980 P 0 12 F 24 12 F (As) S 60 J ( a) S 60 J ( state) S 60 J ( variable) S 60 J ( accessed) S 60 J ( from) S 60 J ( the) S 60 J ( ISR,) S 60 J ( this) S 60 J ( driver's) S 60 J ( time-out) S 60 J ( counter) S 60 J ( \() S 0 12 F 0 12 F (InterruptTimer) S 0 12 F 24 12 F (\)) S 
1920 10240 P (for) S 60 J ( the) S 60 J ( processing) S 60 J ( of) S 60 J ( each) S 60 J ( IRP) S 60 J ( must) S 60 J ( be) S 60 J ( decremented) S 60 J ( by) S 60 J ( the) S 60 J ( preceding) S 60 J ( SynchCritSection) S 
1920 10500 P (routine.) S 60 J ( The) S 60 J ( driver's) S 60 J ( IoTimer) S 60 J ( routine,) S 60 J ( which) S 60 J ( runs) S 60 J ( at) S 60 J ( IRQL) S 60 J ( DISPATCH_LEVEL,) S 60 J ( cannot) S 
1920 10760 P (maintain) S 60 J ( the) S 60 J ( accuracy) S 60 J ( of) S 60 J ( this) S 60 J ( counter) S 60 J ( directly) S 60 J ( since) S 60 J ( the) S 60 J ( ISR) S 60 J ( could) S 60 J ( be) S 60 J ( simultaneously) S 60 J ( accessing) S 
1920 11020 P (it) S 60 J ( from) S 60 J ( another) S 60 J ( processor) S 60 J ( in) S 60 J ( an) S 60 J ( SMP) S 60 J ( machine.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (10-) S E B (12) S E B () S 818 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (As) S 60 J ( another) S 60 J ( example) S 60 J ( of) S 60 J ( updating) S 60 J ( driver-maintained) S 60 J ( state) S 60 J ( variables,) S 60 J ( consider) S 60 J ( the) S 60 J ( i8042) S 60 J ( port) S 
1200 2320 P (driver's) S 60 J ( SynchCritSection) S 60 J ( routine,) S 60 J ( I8xGetDataQueuePointer:) S 
1680 2840 P 0 12 F 0 12 F ({) S 
1680 3100 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension;) S 
1680 3360 P () S 480 J ( CCHAR) S 144 J ( deviceType;) S 
1680 3620 P (//) S 
1680 3880 P (//) S 144 J ( Get) S 144 J ( address) S 144 J ( of) S 144 J ( device) S 144 J ( extension.) S 
1680 4140 P (//) S 
1680 4400 P () S 480 J ( deviceExtension) S 144 J ( =) S 144 J ( \(PDEVICE_EXTENSION\)) S 
1680 4660 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( \(\(PGET_DATA_POINTER_CONTEXT\)) S 
1680 4920 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Context\)->DeviceExtension;) S 
1680 5180 P () S 480 J ( deviceType) S 144 J ( =) S 144 J ( \(CCHAR\)) S 144 J ( \(\(PGET_DATA_POINTER_CONTEXT\)) S 
1680 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( Context\)->DeviceType;) S 
1680 5700 P (//) S 
1680 5960 P (//) S 144 J ( Get) S 144 J ( the) S 144 J ( DataIn) S 144 J ( and) S 144 J ( DataOut) S 144 J ( pointers) S 
1680 6220 P (//) S 144 J ( for) S 144 J ( the) S 144 J ( indicated) S 144 J ( device.) S 
1680 6480 P (//) S 
1680 6740 P () S 480 J ( if) S 144 J ( \(deviceType) S 144 J ( ==) S 144 J ( KeyboardDeviceType\)) S 144 J ( {) S 
1680 7000 P () S 480 J ( ) S 480 J ( \(\(PGET_DATA_POINTER_CONTEXT\)) S 144 J ( Context\)->DataIn) S 144 J ( =) S 
1680 7260 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->KeyboardExtension.DataIn;) S 
1680 7520 P () S 480 J ( ) S 480 J ( \(\(PGET_DATA_POINTER_CONTEXT\)) S 144 J ( Context\)->DataOut) S 144 J ( =) S 
1680 7780 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->KeyboardExtension.DataOut;) S 
1680 8040 P () S 480 J ( ) S 480 J ( \(\(PGET_DATA_POINTER_CONTEXT\)) S 144 J ( Context\)->InputCount) S 144 J ( =) S 
1680 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->KeyboardExtension.InputCount;) S 
1680 8560 P () S 480 J ( }) S 144 J ( else) S 144 J ( if) S 144 J ( \(deviceType) S 144 J ( ==) S 144 J ( MouseDeviceType\)) S 144 J ( {) S 
1680 8820 P () S 480 J ( ) S 480 J ( \(\(PGET_DATA_POINTER_CONTEXT\)) S 144 J ( Context\)->DataIn) S 144 J ( =) S 
1680 9080 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->MouseExtension.DataIn;) S 
1680 9340 P () S 480 J ( ) S 480 J ( \(\(PGET_DATA_POINTER_CONTEXT\)) S 144 J ( Context\)->DataOut) S 144 J ( =) S 
1680 9600 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->MouseExtension.DataOut;) S 
1680 9860 P () S 480 J ( ) S 480 J ( \(\(PGET_DATA_POINTER_CONTEXT\)) S 144 J ( Context\)->InputCount) S 144 J ( =) S 
1680 10120 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->MouseExtension.InputCount;) S 
1680 10380 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 10640 P () S 480 J ( ) S 480 J ( ASSERT\(FALSE\);) S 
1680 10900 P () S 480 J ( }) S 
1680 11160 P (}) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 4065 J ( SynchCritSection) S 55 J ( Routines) S 698 J ( 10-) S E B (13) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (As) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 9,) S 60 J ( the) S 60 J ( i8042) S 60 J ( port) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( routine\(s\)) S 60 J ( process) S 60 J ( keystrokes) S 60 J ( \(or) S 
1920 2320 P (mouse) S 60 J ( events\)) S 60 J ( on) S 60 J ( each) S 60 J ( device) S 60 J ( attached) S 60 J ( to) S 60 J ( the) S 60 J ( i8042) S 60 J ( controller) S 60 J ( by) S 60 J ( calling) S 60 J ( the) S 60 J ( closely) S 60 J ( coupled) S 
1920 2580 P (class) S 60 J ( driver's) S 60 J ( KeyboardClassServiceCallback) S 60 J ( \(or) S 60 J ( MouseClassServiceCallback\)) S 60 J ( routine) S 60 J ( to) S 
1920 2840 P (move) S 60 J ( the) S 60 J ( incoming) S 60 J ( data) S 60 J ( from) S 60 J ( the) S 60 J ( port) S 60 J ( driver's) S 60 J ( input) S 60 J ( data) S 60 J ( queue) S 60 J ( into) S 60 J ( the) S 60 J ( class) S 60 J ( driver's) S 60 J ( internal) S 
1920 3100 P (ring) S 60 J ( buffer.) S 
1920 3480 P (As) S 60 J ( shown) S 60 J ( by) S 60 J ( the) S 60 J ( preceding) S 60 J ( SynchCritSection) S 60 J ( routine,) S 60 J ( the) S 60 J ( i8042) S 60 J ( port) S 60 J ( driver) S 60 J ( does) S 60 J ( the) S 60 J ( minimum) S 
1920 3740 P (processing) S 60 J ( necessary) S 60 J ( at) S 60 J ( DIRQL) S 60 J ( to) S 60 J ( update) S 60 J ( shared) S 60 J ( state) S 60 J ( information) S 60 J ( that) S 60 J ( its) S 60 J ( i8042..IsrDpc) S 
1920 4000 P (routines) S 60 J ( set) S 60 J ( up) S 60 J ( for) S 60 J ( the) S 60 J ( closely) S 60 J ( coupled) S 60 J ( class) S 60 J ( driver's) S 60 J ( ) S 0 12 F 24 12 F I (Xxx) S E 0 12 F 24 12 F (ClassServiceCallback) S 60 J ( routines) S 60 J ( to) S 60 J ( use.) S 0 12 F 
PE PSe
