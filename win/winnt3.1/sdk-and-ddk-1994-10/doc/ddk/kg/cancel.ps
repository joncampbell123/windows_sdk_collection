%!PS-Adobe-2.0 
PSp 15840 SFL 
1920 2440 P 8 18 F B (Chapter) S 100 J ( 12) S E 
1920 2840 P B (Cancel) S 100 J ( Routines) S E 
1920 3600 P 0 12 F 24 12 F (Any) S 60 J ( highest-level) S 60 J ( NT) S 60 J ( driver) S 60 J ( in) S 60 J ( which) S 60 J ( IRPs) S 60 J ( can) S 60 J ( be) S 60 J ( held) S 60 J ( for) S 60 J ( an) S 60 J ( indefinite) S 60 J ( interval) S 60 J ( should) S 60 J ( have) S 
1920 3860 P (one) S 60 J ( or) S 60 J ( more) S 60 J ( Cancel) S 60 J ( routines.) S 60 J ( For) S 60 J ( example,) S 60 J ( suppose) S 60 J ( a) S 60 J ( user-mode) S 60 J ( thread) S 60 J ( makes) S 60 J ( an) S 60 J ( I/O) S 60 J ( request,) S 
1920 4120 P (which) S 60 J ( is) S 60 J ( queued) S 60 J ( by) S 60 J ( a) S 60 J ( highest-level) S 60 J ( driver's) S 60 J ( Dispatch) S 60 J ( routine,) S 60 J ( and) S 60 J ( the) S 60 J ( requesting) S 60 J ( thread) S 60 J ( is) S 
1920 4380 P (terminated) S 60 J ( while) S 60 J ( the) S 60 J ( IRP) S 60 J ( is) S 60 J ( queued.) S 60 J ( IRPs) S 60 J ( queued) S 60 J ( on) S 60 J ( behalf) S 60 J ( of) S 60 J ( a) S 60 J ( terminated) S 60 J ( thread) S 60 J ( should) S 60 J ( be) S 
1920 4640 P (cancelled.) S 60 J ( Consequently,) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( must) S 60 J ( set) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( in) S 60 J ( each) S 
1920 4900 P (cancelable) S 60 J ( IRP) S 60 J ( that) S 60 J ( it) S 60 J ( queues.) S 
1920 5280 P (The) S 60 J ( number) S 60 J ( of) S 60 J ( Cancel) S 60 J ( routines) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( has) S 60 J ( depends) S 60 J ( on) S 60 J ( the) S 60 J ( driver's) S 60 J ( design.) S 60 J ( In) S 60 J ( general,) S 60 J ( a) S 
1920 5540 P (driver) S 60 J ( should) S 60 J ( have) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( for) S 60 J ( each) S 60 J ( stage) S 60 J ( in) S 60 J ( its) S 60 J ( I/O) S 60 J ( processing) S 60 J ( at) S 60 J ( which) S 60 J ( an) S 60 J ( IRP) S 60 J ( might) S 
1920 5800 P (be) S 60 J ( held) S 60 J ( for) S 60 J ( an) S 60 J ( indefinite) S 60 J ( interval) S 60 J ( \(also) S 60 J ( called) S 60 J ( ) S 0 12 F 24 12 F I (held) S 60 J ( in) S 60 J ( a) S E 0 12 F 24 12 F () S 60 J ( ) S 0 12 F 24 12 F I (cancelable) S 60 J ( state) S E 0 12 F 24 12 F (\).) S 
1920 6180 P (Note) S 60 J ( that) S 60 J ( the) S 60 J ( highest-level) S 60 J ( driver) S 60 J ( in) S 60 J ( a) S 60 J ( chain) S 60 J ( of) S 60 J ( layered) S 60 J ( NT) S 60 J ( drivers) S 60 J ( must) S 60 J ( have) S 60 J ( at) S 60 J ( least) S 60 J ( one) S 
1920 6440 P (Cancel) S 60 J ( routine) S 60 J ( if) S 60 J ( it) S 60 J ( queues) S 60 J ( IRPs.) S 60 J ( Certain) S 60 J ( NT) S 60 J ( drivers) S 60 J ( for) S 60 J ( interactive) S 60 J ( devices,) S 60 J ( such) S 60 J ( as) S 60 J ( keyboard,) S 
1920 6700 P (mouse,) S 60 J ( and) S 60 J ( serial) S 60 J ( drivers,) S 60 J ( are) S 60 J ( likely) S 60 J ( to) S 60 J ( have) S 60 J ( Cancel) S 60 J ( routines.) S 60 J ( NT) S 60 J ( intermediate) S 60 J ( drivers) S 60 J ( that) S 60 J ( are) S 
1920 6960 P (layered) S 60 J ( over) S 60 J ( mass-storage) S 60 J ( device) S 60 J ( drivers) S 60 J ( and) S 60 J ( mass-storage) S 60 J ( device) S 60 J ( drivers) S 60 J ( are) S 60 J ( unlikely) S 60 J ( to) S 60 J ( have) S 
1920 7220 P (Cancel) S 60 J ( routines.) S 60 J ( In) S 60 J ( other) S 60 J ( words,) S 60 J ( it) S 60 J ( is) S 60 J ( the) S 60 J ( responsibility) S 60 J ( of) S 60 J ( an) S 60 J ( NT) S 60 J ( file) S 60 J ( system) S 60 J ( driver) S 60 J ( to) S 60 J ( handle) S 
1920 7480 P (the) S 60 J ( cancelation) S 60 J ( of) S 60 J ( file) S 60 J ( I/O) S 60 J ( requests,) S 60 J ( so) S 60 J ( the) S 60 J ( IRPs) S 60 J ( input) S 60 J ( to) S 60 J ( lower-level) S 60 J ( mass-storage) S 60 J ( drivers) S 60 J ( are) S 
1920 7740 P (not) S 60 J ( cancelable.) S 
1920 8120 P (Note) S 60 J ( also) S 60 J ( that) S 60 J ( the) S 60 J ( designer) S 60 J ( of) S 60 J ( a) S 60 J ( higher-level) S 60 J ( NT) S 60 J ( driver) S 60 J ( can) S 60 J ( make) S 60 J ( no) S 60 J ( assumptions) S 60 J ( about) S 
1920 8380 P (whether) S 60 J ( \(or) S 60 J ( how\)) S 60 J ( existing) S 60 J ( lower-level) S 60 J ( NT) S 60 J ( drivers) S 60 J ( handle) S 60 J ( cancelable) S 60 J ( IRPs.) S 60 J ( While) S 60 J ( a) S 60 J ( new) S 
1920 8640 P (higher-level) S 60 J ( NT) S 60 J ( driver) S 60 J ( can) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoCancelIrp) S E 0 12 F 24 12 F (,) S 60 J ( making) S 60 J ( this) S 60 J ( call) S 60 J ( is) S 60 J ( no) S 60 J ( guarantee) S 60 J ( that) S 60 J ( the) S 60 J ( given) S 
1920 8900 P (IRP) S 60 J ( will) S 60 J ( be) S 60 J ( completed) S 60 J ( with) S 60 J ( its) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( set) S 60 J ( to) S 60 J ( STATUS_CANCELLED.) S 60 J ( As) S 60 J ( soon) S 60 J ( as) S 
1920 9160 P (any) S 60 J ( higher-level) S 60 J ( NT) S 60 J ( driver) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( an) S 60 J ( IRP,) S 60 J ( it) S 60 J ( no) S 60 J ( longer) S 60 J ( "owns") S 60 J ( that) S 60 J ( IRP) S 60 J ( and) S 60 J ( it) S 
1920 9420 P (can) S 60 J ( neither) S 60 J ( determine) S 60 J ( nor) S 60 J ( control) S 60 J ( whatever) S 60 J ( processing) S 60 J ( lower-level) S 60 J ( drivers) S 60 J ( do) S 60 J ( to) S 60 J ( satisfy) S 60 J ( that) S 
1920 9680 P (request.) S 
1920 10060 P (However,) S 60 J ( any) S 60 J ( higher-level) S 60 J ( NT) S 60 J ( driver) S 60 J ( can) S 60 J ( set) S 60 J ( its) S 60 J ( IoCompletion) S 60 J ( routine) S 60 J ( in) S 60 J ( an) S 60 J ( IRP,) S 60 J ( as) S 60 J ( described) S 
1920 10320 P (in) S 60 J ( Chapter) S 60 J ( 13,) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoSetCompletionRoutine) S E 0 12 F 24 12 F () S 60 J ( before) S 60 J ( it) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCallDriver) S E 0 12 F 24 12 F (.) S 60 J ( In) S 60 J ( other) S 
1920 10580 P (words,) S 60 J ( a) S 60 J ( new) S 60 J ( higher-level) S 60 J ( driver) S 60 J ( that) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoCancelIrp) S E 0 12 F 24 12 F () S 60 J ( can) S 60 J ( check) S 60 J ( whether) S 60 J ( the) S 60 J ( given) S 60 J ( IRP) S 60 J ( was) S 
1920 10840 P (cancelled) S 60 J ( only) S 60 J ( in) S 60 J ( its) S 60 J ( IoCompletion) S 60 J ( routine) S 60 J ( and) S 60 J ( only) S 60 J ( if) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( already) S 60 J ( had) S 60 J ( called) S 
1920 11100 P 0 12 F 24 12 F B (IoSetCompletionRoutine) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F I (InvokeOnCancel) S E 0 12 F 24 12 F () S 60 J ( parameter) S 60 J ( set) S 60 J ( to) S 60 J ( TRUE.) S 
1920 11480 P (This) S 60 J ( chapter) S 60 J ( summarizes) S 60 J ( the) S 60 J ( required) S 60 J ( functionality) S 60 J ( of) S 60 J ( an) S 60 J ( NT) S 60 J ( driver's) S 60 J ( standard) S 60 J ( Cancel) S 
1920 11740 P (routine\(s\)) S 60 J ( and) S 60 J ( discusses) S 60 J ( strategies) S 60 J ( for) S 60 J ( managing) S 60 J ( cancelable) S 60 J ( IRPs) S 60 J ( in) S 60 J ( other) S 60 J ( driver) S 60 J ( routines.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (12-) S E B (2) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2120 P 0 12 F 8 14 F B (12.1) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Cancel) S 78 J ( Routine) S 78 J ( Requirements) S E 
1200 2740 P 0 12 F 24 12 F (If) S 60 J ( an) S 60 J ( NT) S 60 J ( driver) S 60 J ( handles) S 60 J ( cancelable) S 60 J ( IRPs,) S 60 J ( it) S 60 J ( is) S 60 J ( responsible) S 60 J ( for) S 60 J ( setting) S 60 J ( the) S 60 J ( appropriate) S 60 J ( Cancel) S 
1200 3000 P (routine) S 60 J ( in) S 60 J ( each) S 60 J ( IRP) S 60 J ( that) S 60 J ( will) S 60 J ( be) S 60 J ( put) S 60 J ( into) S 60 J ( a) S 60 J ( cancelable) S 60 J ( state) S 60 J ( as) S 60 J ( it) S 60 J ( is) S 60 J ( processed) S 60 J ( through) S 60 J ( the) S 
1200 3260 P (driver's) S 60 J ( routines.) S 60 J ( For) S 60 J ( example,) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( should) S 60 J ( do) S 60 J ( the) S 60 J ( following:) S 
1200 3580 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Its) S 60 J ( Dispatch) S 60 J ( routine\(s\)) S 60 J ( should) S 60 J ( specify) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( Cancel) S 60 J ( routine's) S 60 J ( entry) S 60 J ( point) S 60 J ( when) S 
1680 3840 P (the) S 60 J ( driver) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoStartPacket) S E 0 12 F 24 12 F () S 60 J ( if) S 60 J ( the) S 60 J ( driver) S 60 J ( has) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine.) S 60 J ( Otherwise,) S 60 J ( the) S 60 J ( Dispatch) S 
1680 4100 P (routine\(s\)) S 60 J ( must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoAcquireCancelSpinLock) S E 0 12 F 24 12 F (,) S 60 J ( ) S 0 12 F 24 12 F B (IoSetCancelRoutine) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( IRP) S 60 J ( and) S 
1680 4360 P (the) S 60 J ( entry) S 60 J ( point) S 60 J ( for) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine,) S 60 J ( and) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( before) S 60 J ( queueing) S 60 J ( the) S 
1680 4620 P (IRP) S 60 J ( for) S 60 J ( further) S 60 J ( processing.) S 
1200 4940 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( In) S 60 J ( a) S 60 J ( similar) S 60 J ( manner,) S 60 J ( any) S 60 J ( routine) S 60 J ( in) S 60 J ( the) S 60 J ( driver) S 60 J ( that) S 60 J ( passes) S 60 J ( an) S 60 J ( IRP) S 60 J ( on) S 60 J ( for) S 60 J ( further) S 60 J ( processing) S 
1680 5200 P (should) S 60 J ( set) S 60 J ( up) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( if) S 60 J ( the) S 60 J ( request) S 60 J ( could) S 60 J ( be) S 60 J ( held) S 60 J ( indefinitely) S 60 J ( before) S 60 J ( another) S 
1680 5460 P (driver) S 60 J ( routine) S 60 J ( begins) S 60 J ( processing) S 60 J ( it.) S 
1200 5780 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( The) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( \(or) S 60 J ( other) S 60 J ( routine) S 60 J ( that) S 60 J ( removes) S 60 J ( an) S 60 J ( IRP) S 60 J ( from) S 60 J ( a) S 60 J ( driver-managed) S 60 J ( queue\)) S 
1680 6040 P (must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoAcquireCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( and) S 60 J ( check) S 60 J ( whether) S 60 J ( the) S 60 J ( IRP) S 60 J ( has) S 60 J ( already) S 60 J ( been) S 
1680 6300 P (cancelled.) S 60 J ( If) S 60 J ( so,) S 60 J ( the) S 60 J ( StartIo) S 60 J ( routine) S 60 J ( should) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( and) S 60 J ( return.) S 
1680 6560 P (Otherwise,) S 60 J ( it) S 60 J ( should) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoSetCancelRoutine) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( a) S 60 J ( NULL) S 60 J ( function) S 60 J ( pointer) S 60 J ( to) S 60 J ( remove) S 
1680 6820 P (the) S 60 J ( IRP) S 60 J ( from) S 60 J ( the) S 60 J ( cancelable) S 60 J ( state) S 60 J ( before) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( and) S 60 J ( starting) S 
1680 7080 P (the) S 60 J ( requested) S 60 J ( operation) S 60 J ( for) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object.) S 
1200 7400 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Any) S 60 J ( other) S 60 J ( driver) S 60 J ( routine) S 60 J ( that) S 60 J ( dequeues) S 60 J ( an) S 60 J ( IRP) S 60 J ( or) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 60 J ( an) S 60 J ( IRP) S 60 J ( that) S 60 J ( might) S 60 J ( have) S 
1680 7660 P (been) S 60 J ( pending) S 60 J ( for) S 60 J ( an) S 60 J ( indefinite) S 60 J ( interval) S 60 J ( should) S 60 J ( do) S 60 J ( likewise.) S 60 J ( That) S 60 J ( is,) S 60 J ( such) S 60 J ( a) S 60 J ( routine) S 60 J ( must) S 
1680 7920 P (test) S 60 J ( whether) S 60 J ( the) S 60 J ( IRP) S 60 J ( has) S 60 J ( already) S 60 J ( been) S 60 J ( cancelled) S 60 J ( or) S 60 J ( remove) S 60 J ( the) S 60 J ( IRP) S 60 J ( from) S 60 J ( the) S 60 J ( cancelable) S 
1680 8180 P (state) S 60 J ( before) S 60 J ( it) S 60 J ( begins) S 60 J ( I/O) S 60 J ( processing) S 60 J ( for) S 60 J ( that) S 60 J ( IRP.) S 
1200 8560 P (A) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 60 J ( a) S 60 J ( system-supplied) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( already) S 60 J ( held) S 60 J ( on) S 60 J ( its) S 60 J ( behalf.) S 
1200 8820 P (Consequently,) S 60 J ( this) S 60 J ( routine) S 60 J ( is) S 60 J ( run) S 60 J ( in) S 60 J ( an) S 60 J ( arbitrary) S 60 J ( thread) S 60 J ( context) S 60 J ( at) S 60 J ( DISPATCH_LEVEL) S 60 J ( IRQL,) S 
1200 9080 P (unless) S 60 J ( \(or) S 60 J ( until\)) S 60 J ( it) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F (.) S 60 J ( Running) S 60 J ( at) S 60 J ( IRQL) S 60 J ( DISPATCH_LEVEL) S 
1200 9340 P (restricts) S 60 J ( the) S 60 J ( set) S 60 J ( of) S 60 J ( support) S 60 J ( routines) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( can) S 60 J ( call.) S 60 J ( For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 
1200 9600 P (managing) S 60 J ( IRQLs,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 60 J ( For) S 60 J ( specific) S 60 J ( information) S 60 J ( about) S 60 J ( the) S 60 J ( IRQL\(s\)) S 60 J ( at) S 60 J ( which) S 60 J ( any) S 
1200 9860 P (particular) S 60 J ( support) S 60 J ( routine) S 60 J ( can) S 60 J ( be) S 60 J ( called,) S 60 J ( see) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F I (Kernel-mode) S E 0 12 F 24 12 F () S 60 J ( ) S 0 12 F 24 12 F I (Driver) S 60 J ( Reference) S E 0 12 F 24 12 F (.) S 
1200 10240 P (Because) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 60 J ( the) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( held,) S 60 J ( this) S 60 J ( routine) S 60 J ( must) S 60 J ( not) S 60 J ( call) S 
1200 10500 P 0 12 F 24 12 F B (IoAcquireCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( unless) S 60 J ( it) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( first.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 5060 J ( Cancel) S 55 J ( Routines) S 807 J ( 12-) S E B (3) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (Instead,) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( usually) S 60 J ( does) S 60 J ( the) S 60 J ( following:) S 
1920 2380 P () S 104 J ( 1) S 256 J ( Tests) S 60 J ( whether) S 60 J ( the) S 60 J ( pointer) S 60 J ( for) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( matches) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object's) S 60 J ( ) S 0 12 F 24 12 F B (CurrentIrp) S E 
2400 2640 P 0 12 F 24 12 F (address,) S 60 J ( provided) S 60 J ( that) S 60 J ( IRPs) S 60 J ( are) S 60 J ( queued) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( object's) S 60 J ( associated) S 60 J ( device) S 60 J ( queue) S 
1920 2960 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( If) S 60 J ( it) S 60 J ( does) S 60 J ( and) S 60 J ( an) S 60 J ( I/O) S 60 J ( operation) S 60 J ( to) S 60 J ( satisfy) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( already) S 60 J ( has) S 60 J ( been) S 60 J ( started,) S 60 J ( the) S 
2880 3220 P (IRP) S 60 J ( cannot) S 60 J ( be) S 60 J ( cancelled) S 60 J ( so) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( should) S 60 J ( call) S 
2880 3480 P 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( and) S 60 J ( return) S 60 J ( control.) S 
1920 3800 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( If) S 60 J ( it) S 60 J ( does) S 60 J ( but) S 60 J ( the) S 60 J ( current) S 60 J ( state) S 60 J ( of) S 60 J ( the) S 60 J ( IRP) S 60 J ( is) S 60 J ( still) S 60 J ( pending,) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( should) S 
2880 4060 P (set) S 60 J ( the) S 60 J ( IRP's) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( with) S 60 J ( STATUS_CANCELLED) S 60 J ( in) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Status) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( and) S 
2880 4320 P (zero) S 60 J ( in) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( field,) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F (,) S 60 J ( call) S 
2880 4580 P 0 12 F 24 12 F B (IoStartNextPacket) S E 0 12 F 24 12 F () S 60 J ( if) S 60 J ( the) S 60 J ( driver) S 60 J ( has) S 60 J ( a) S 60 J ( StartIo) S 60 J ( routine,) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 
2880 4840 P (the) S 60 J ( input) S 60 J ( IRP,) S 60 J ( and) S 60 J ( return) S 60 J ( control.) S 
1920 5160 P () S 104 J ( 2) S 256 J ( Otherwise,) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( checks) S 60 J ( whether) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( is) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 
2400 5420 P (associated) S 60 J ( with) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 60 J ( by) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveEntryDeviceQueue) S E 0 12 F 24 12 F (,) S 60 J ( or) S 60 J ( it) S 
2400 5680 P (checks) S 60 J ( whether) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( is) S 60 J ( in) S 60 J ( a) S 60 J ( driver-created) S 60 J ( \(interlocked\)) S 60 J ( queue) S 
1920 6000 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( If) S 60 J ( the) S 60 J ( IRP) S 60 J ( was) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( queue,) S 60 J ( calling) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveEntryDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( removes) S 
2880 6260 P (it) S 60 J ( from) S 60 J ( the) S 60 J ( queue.) S 60 J ( If) S 60 J ( the) S 60 J ( IRP) S 60 J ( is) S 60 J ( in) S 60 J ( a) S 60 J ( driver-managed) S 60 J ( interlocked) S 60 J ( queue,) S 60 J ( the) S 60 J ( Cancel) S 
2880 6520 P (routine) S 60 J ( should) S 60 J ( dequeue) S 60 J ( it.) S 60 J ( Then,) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( should) S 60 J ( set) S 60 J ( the) S 60 J ( IRP's) S 60 J ( I/O) S 60 J ( status) S 
2880 6780 P (block) S 60 J ( with) S 60 J ( STATUS_CANCELLED) S 60 J ( in) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Status) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( and) S 60 J ( zero) S 60 J ( in) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Information) S E 
2880 7040 P 0 12 F 24 12 F (field,) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F (,) S 60 J ( start) S 60 J ( the) S 60 J ( next) S 60 J ( queued) S 60 J ( IRP,) S 60 J ( call) S 
2880 7300 P 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( cancelled) S 60 J ( IRP,) S 60 J ( and) S 60 J ( return) S 60 J ( control.) S 
1920 7620 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( If) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( is) S 60 J ( not) S 60 J ( queued,) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( should) S 60 J ( log) S 60 J ( an) S 60 J ( error.) S 
1920 7940 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( If) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( was) S 60 J ( not) S 60 J ( in) S 60 J ( a) S 60 J ( device) S 60 J ( queue,) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( sets) S 60 J ( the) S 60 J ( input) S 60 J ( IRP's) S 
2880 8200 P (I/O) S 60 J ( status) S 60 J ( block) S 60 J ( with) S 60 J ( STATUS_CANCELLED) S 60 J ( in) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Status) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( and) S 60 J ( zero) S 60 J ( in) S 60 J ( the) S 
2880 8460 P 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( field,) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F (,) S 60 J ( and) S 60 J ( calls) S 0 12 F 24 12 F B () S 60 J ( IoCompleteRequest) S E 
2880 8720 P 0 12 F 24 12 F (with) S 60 J ( the) S 60 J ( IRP.) S 
2880 9040 P (If) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( was) S 60 J ( not) S 60 J ( in) S 60 J ( a) S 60 J ( driver-managed) S 60 J ( queue,) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( simply) S 
2880 9300 P (releases) S 60 J ( the) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( and) S 60 J ( returns) S 60 J ( control.) S 60 J ( Such) S 60 J ( a) S 60 J ( driver) S 60 J ( usually) S 60 J ( assumes) S 60 J ( that) S 
2880 9560 P (I/O) S 60 J ( processing) S 60 J ( for) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( has) S 60 J ( already) S 60 J ( begun.) S 
1920 9940 P (Note) S 60 J ( that) S 60 J ( NT) S 60 J ( drivers) S 60 J ( with) S 60 J ( Cancel) S 60 J ( routines) S 60 J ( usually) S 60 J ( handle) S 60 J ( IRP_MJ_CLEANUP) S 60 J ( requests) S 60 J ( as) S 
1920 10200 P (well.) S 60 J ( Their) S 60 J ( DispatchCleanup) S 60 J ( routines) S 60 J ( are) S 60 J ( responsible) S 60 J ( for) S 60 J ( cancelling) S 60 J ( all) S 60 J ( IRPs) S 60 J ( currently) S 60 J ( queued) S 
1920 10460 P (to) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 60 J ( for) S 60 J ( the) S 60 J ( same) S 60 J ( requestor) S 60 J ( \(thread\).) S 60 J ( If) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( manages) S 60 J ( its) S 60 J ( own) S 
1920 10720 P (queueing) S 60 J ( of) S 60 J ( IRPs,) S 60 J ( its) S 60 J ( DispatchCleanup) S 60 J ( routine) S 60 J ( must) S 60 J ( cancel) S 60 J ( all) S 60 J ( queued) S 60 J ( IRPs) S 60 J ( for) S 60 J ( the) S 60 J ( input) S 60 J ( target) S 
1920 10980 P (device) S 60 J ( object) S 60 J ( and) S 60 J ( same) S 60 J ( requestor.) S 60 J ( See) S 60 J ( Chapter) S 60 J ( 6) S 60 J ( for) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( DispatchCleanup) S 
1920 11240 P (routines.) S 
1920 11620 P (Note) S 60 J ( also) S 60 J ( that) S 60 J ( the) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( maintains) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (CurrentIrp) S E 0 12 F 24 12 F () S 60 J ( field) S 60 J ( in) S 60 J ( a) S 60 J ( device) S 60 J ( object) S 60 J ( only) S 60 J ( if) S 60 J ( IRPs) S 
1920 11880 P (are) S 60 J ( queued) S 60 J ( in) S 60 J ( the) S 60 J ( associated) S 60 J ( device) S 60 J ( queue) S 60 J ( object.) S 60 J ( If) S 60 J ( a) S 60 J ( driver) S 60 J ( manages) S 60 J ( its) S 60 J ( own) S 60 J ( queues) S 60 J ( of) S 60 J ( IRPs,) S 
1920 12140 P (its) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( cannot) S 60 J ( test) S 60 J ( an) S 60 J ( input) S 60 J ( IRP) S 60 J ( against) S 60 J ( the) S 60 J ( input) S 60 J ( device) S 60 J ( object's) S 60 J ( ) S 0 12 F 24 12 F B (CurrentIrp) S E 
1920 12400 P 0 12 F 24 12 F (address.) S 60 J ( Such) S 60 J ( a) S 60 J ( driver) S 60 J ( must) S 60 J ( maintain) S 60 J ( its) S 60 J ( own) S 60 J ( state) S 60 J ( about) S 60 J ( which) S 60 J ( IRP) S 60 J ( is) S 60 J ( currently) S 60 J ( being) S 
1920 12660 P (processed.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (12-) S E B (4) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2120 P 0 12 F 8 14 F B (12.2) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Implementing) S 78 J ( a) S 78 J ( Cancel) S 78 J ( Routine) S E 
1200 2740 P 0 12 F 24 12 F (The) S 60 J ( I/O) S 60 J ( Manager) S 60 J ( calls) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( with) S 60 J ( an) S 60 J ( input) S 60 J ( IRP) S 60 J ( to) S 60 J ( be) S 60 J ( cancelled.) S 
1200 3000 P (Such) S 60 J ( an) S 60 J ( IRP) S 60 J ( might) S 60 J ( be) S 60 J ( one) S 60 J ( that) S 60 J ( this) S 60 J ( driver's) S 60 J ( DispatchReadWrite) S 60 J ( routine) S 60 J ( has) S 60 J ( queued) S 60 J ( just) S 60 J ( as) S 60 J ( the) S 
1200 3260 P (current) S 60 J ( Win32) S 60 J ( application) S 60 J ( is) S 60 J ( being) S 60 J ( closed) S 60 J ( by) S 60 J ( the) S 60 J ( user.) S 60 J ( Such) S 60 J ( an) S 60 J ( IRP) S 60 J ( also) S 60 J ( might) S 60 J ( be) S 60 J ( one) S 60 J ( that) S 60 J ( a) S 
1200 3520 P (user-mode) S 60 J ( application) S 60 J ( explicitly) S 60 J ( cancelled,) S 60 J ( depending) S 60 J ( on) S 60 J ( the) S 60 J ( nature) S 60 J ( of) S 60 J ( the) S 60 J ( underlying) S 60 J ( device.) S 
1200 3900 P (In) S 60 J ( other) S 60 J ( words,) S 60 J ( a) S 60 J ( request) S 60 J ( to) S 60 J ( be) S 60 J ( cancelled) S 60 J ( might) S 60 J ( be) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (CurrentIrp) S E 0 12 F 24 12 F () S 60 J ( in) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object,) S 
1200 4160 P (might) S 60 J ( already) S 60 J ( be) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( associated) S 60 J ( with) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object,) S 60 J ( or) S 60 J ( might) S 60 J ( be) S 60 J ( in) S 60 J ( a) S 
1200 4420 P (driver-managed) S 60 J ( internal) S 60 J ( queue) S 60 J ( of) S 60 J ( IRPs) S 60 J ( when) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( is) S 60 J ( called.) S 
1200 4800 P (For) S 60 J ( example,) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver,) S 60 J ( whose) S 60 J ( DispatchCleanup) S 60 J ( routine) S 60 J ( was) S 60 J ( described) S 60 J ( in) S 
1200 5060 P (Chapter) S 60 J ( 6,) S 60 J ( can) S 60 J ( be) S 60 J ( called) S 60 J ( to) S 60 J ( cancel) S 60 J ( an) S 60 J ( outstanding) S 60 J ( read) S 60 J ( request) S 60 J ( for) S 60 J ( the) S 60 J ( Win32) S 60 J ( user) S 60 J ( input) S 60 J ( thread.) S 
1200 5320 P (Its) S 60 J ( KeyboardClassCancel) S 60 J ( routine,) S 60 J ( which) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 60 J ( the) S 60 J ( system) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( held) S 60 J ( on) S 60 J ( its) S 
1200 5580 P (behalf,) S 60 J ( handles) S 60 J ( such) S 60 J ( a) S 60 J ( request) S 60 J ( as) S 60 J ( follows:) S 
1680 6100 P 0 12 F 0 12 F ({) S 
1680 6360 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
1680 6620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
1680 6880 P () S 480 J ( KIRQL) S 144 J ( currentIrql;) S 
1680 7140 P () S 480 J ( KIRQL) S 144 J ( cancelIrql;) S 
1680 7400 P (//) S 
1680 7660 P (//) S 144 J ( Release) S 144 J ( the) S 144 J ( system's) S 144 J ( cancel) S 144 J ( spin) S 144 J ( lock) S 144 J ( and) S 144 J ( grab) S 144 J ( the) S 144 J ( spin) S 
1680 7920 P (//) S 144 J ( lock) S 144 J ( that) S 144 J ( protects) S 144 J ( the) S 144 J ( RequestIsPending) S 144 J ( Boolean) S 144 J ( in) S 144 J ( the) S 
1680 8180 P (//) S 144 J ( device) S 144 J ( extension.) S 144 J ( Have) S 144 J ( to) S 144 J ( release) S 144 J ( the) S 144 J ( cancel) S 144 J ( spin) S 144 J ( lock) S 
1680 8440 P (//) S 144 J ( to) S 144 J ( prevent) S 144 J ( possible) S 144 J ( deadlock) S 144 J ( when) S 144 J ( trying) S 144 J ( to) S 144 J ( acquire) S 
1680 8700 P (//) S 144 J ( the) S 144 J ( deviceExtension->SpinLock.) S 
1680 8960 P (//) S 
1680 9220 P () S 480 J ( IoReleaseCancelSpinLock\(Irp->CancelIrql\);) S 
1680 9480 P () S 480 J ( KeAcquireSpinLock\() S 
1680 9740 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock,) S 
1680 10000 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &currentIrql\);) S 
1680 10260 P () S 480 J ( if) S 144 J ( \(\(deviceExtension->RequestIsPending\)) S 144 J ( &&) S 
1680 10520 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(Irp) S 144 J ( ==) S 144 J ( DeviceObject->CurrentIrp\)\)) S 144 J ( {) S 
1680 10780 P (//) S 
1680 11040 P (//) S 144 J ( The) S 144 J ( current) S 144 J ( request) S 144 J ( is) S 144 J ( being) S 144 J ( cancelled.) S 144 J ( Set) S 144 J ( the) S 
1680 11300 P (//) S 144 J ( CurrentIrp) S 144 J ( to) S 144 J ( NULL,) S 144 J ( clear) S 144 J ( RequestIsPending,) S 
1680 11560 P (//) S 144 J ( and) S 144 J ( release) S 144 J ( the) S 144 J ( device) S 144 J ( extension) S 144 J ( spin) S 144 J ( lock) S 
1680 11820 P (//) S 144 J ( before) S 144 J ( starting) S 144 J ( the) S 144 J ( next) S 144 J ( packet.) S 
1680 12080 P (//) S 
1680 12340 P () S 480 J ( ) S 480 J ( DeviceObject->CurrentIrp) S 144 J ( =) S 144 J ( NULL;) S 
1680 12600 P () S 480 J ( ) S 480 J ( deviceExtension->RequestIsPending) S 144 J ( =) S 144 J ( FALSE;) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 5060 J ( Cancel) S 55 J ( Routines) S 807 J ( 12-) S E B (5) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F () S 480 J ( ) S 480 J ( KeReleaseSpinLock\() S 
2400 2320 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock,) S 
2400 2580 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &currentIrql\);) S 
2400 2840 P () S 480 J ( ) S 480 J ( IoStartNextPacket\(DeviceObject,) S 144 J ( TRUE\);) S 
2400 3100 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
2400 3360 P (//) S 
2400 3620 P (//) S 144 J ( Input) S 144 J ( request) S 144 J ( must) S 144 J ( be) S 144 J ( in) S 144 J ( the) S 144 J ( device) S 144 J ( queue.) S 
2400 3880 P (//) S 144 J ( Reacquire) S 144 J ( the) S 144 J ( cancel) S 144 J ( spin) S 144 J ( lock,) S 144 J ( remove) S 144 J ( the) S 144 J ( request) S 
2400 4140 P (//) S 144 J ( from) S 144 J ( the) S 144 J ( queue,) S 144 J ( release) S 144 J ( both) S 144 J ( spin) S 144 J ( locks,) S 144 J ( and) S 144 J ( complete) S 
2400 4400 P (//) S 144 J ( the) S 144 J ( request) S 144 J ( with) S 144 J ( STATUS_CANCELLED.) S 
2400 4660 P (//) S 
2400 4920 P () S 480 J ( ) S 480 J ( IoAcquireCancelSpinLock\(&cancelIrql\);) S 
2400 5180 P () S 480 J ( ) S 480 J ( if) S 144 J ( \(TRUE) S 144 J ( !=) S 144 J ( KeRemoveEntryDeviceQueue\() S 
2400 5440 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &DeviceObject->deviceQueue,) S 
2400 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &Irp->Tail.Overlay.DeviceQueueEntry\)\)) S 144 J ( {) S 
2400 5960 P (//) S 
2400 6220 P (//) S 144 J ( Oops.) S 144 J ( This) S 144 J ( code) S 144 J ( path) S 144 J ( should) S 144 J ( never) S 144 J ( run:) S 144 J ( input) S 144 J ( IRP) S 
2400 6480 P (//) S 144 J ( is) S 144 J ( neither) S 144 J ( CurrentIrp) S 144 J ( nor) S 144 J ( queued.) S 
2400 6740 P (//) S 
2400 7000 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( Report) S 144 J ( an) S 144 J ( error.) S 
2400 7260 P () S 480 J ( ) S 480 J ( }) S 
2400 7520 P () S 480 J ( ) S 480 J ( IoReleaseCancelSpinLock\(cancelIrql\);) S 
2400 7780 P () S 480 J ( ) S 480 J ( KeReleaseSpinLock\() S 
2400 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock,) S 
2400 8300 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( currentIrql\);) S 
2400 8560 P () S 480 J ( }) S 144 J ( //) S 144 J ( end) S 144 J ( else) S 
2400 8820 P (//) S 
2400 9080 P (//) S 144 J ( Complete) S 144 J ( the) S 144 J ( input) S 144 J ( request) S 144 J ( with) S 144 J ( STATUS_CANCELLED.) S 
2400 9340 P (//) S 
2400 9600 P () S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( STATUS_CANCELLED;) S 
2400 9860 P () S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( 0;) S 
2400 10120 P () S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_KEYBOARD_INCREMENT\);) S 
2400 10380 P () S 480 J ( return;) S 
2400 10640 P (}) S 
1920 11020 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( this) S 60 J ( driver) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveEntryDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( test) S 60 J ( whether) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( is) S 60 J ( in) S 
1920 11280 P (the) S 60 J ( device) S 60 J ( queue) S 60 J ( because) S 60 J ( this) S 60 J ( support) S 60 J ( routine) S 60 J ( either) S 60 J ( removes) S 60 J ( the) S 60 J ( given) S 60 J ( IRP) S 60 J ( from) S 60 J ( the) S 60 J ( device) S 
1920 11540 P (queue) S 60 J ( or) S 60 J ( does) S 60 J ( nothing) S 60 J ( except) S 60 J ( return) S 60 J ( FALSE,) S 60 J ( indicating) S 60 J ( that) S 60 J ( the) S 60 J ( given) S 60 J ( entry) S 60 J ( was) S 60 J ( not) S 60 J ( queued.) S 
1920 11800 P (The) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( cannot) S 60 J ( assume) S 60 J ( that) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( is) S 60 J ( at) S 60 J ( the) S 60 J ( head) S 60 J ( of) S 60 J ( the) S 60 J ( device) S 60 J ( queue,) S 60 J ( so) S 60 J ( it) S 
1920 12060 P (cannot) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( compare) S 60 J ( the) S 60 J ( pointers) S 60 J ( to) S 60 J ( the) S 60 J ( returned) S 60 J ( IRP) S 60 J ( and) S 60 J ( input) S 
1920 12320 P (IRP.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (12-) S E B (6) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 24 12 F (If) S 60 J ( an) S 60 J ( NT) S 60 J ( driver) S 60 J ( manages) S 60 J ( its) S 60 J ( own) S 60 J ( internal) S 60 J ( queues) S 60 J ( of) S 60 J ( IRPs,) S 60 J ( its) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( can) S 60 J ( be) S 60 J ( called) S 60 J ( with) S 
1200 2320 P (an) S 60 J ( input) S 60 J ( IRP) S 60 J ( that) S 60 J ( is) S 60 J ( neither) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (CurrentIrp) S E 0 12 F 24 12 F () S 60 J ( for) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 60 J ( nor) S 60 J ( an) S 60 J ( IRP) S 60 J ( in) S 60 J ( the) S 
1200 2580 P (driver's) S 60 J ( internal) S 60 J ( queue.) S 60 J ( If) S 60 J ( this) S 60 J ( occurs,) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( should) S 60 J ( do) S 60 J ( the) S 60 J ( following:) S 
1200 2900 P () S 104 J ( 1) S 256 J ( Log) S 60 J ( an) S 60 J ( error.) S 
1200 3220 P () S 104 J ( 2) S 256 J ( Release) S 60 J ( any) S 60 J ( spin) S 60 J ( locks) S 60 J ( it) S 60 J ( is) S 60 J ( currently) S 60 J ( holding.) S 
1200 3540 P () S 104 J ( 3) S 256 J ( Return) S 60 J ( control.) S 
1200 4340 P 0 12 F 8 14 F B (12.3) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Managing) S 78 J ( Cancelable) S 78 J ( IRPs) S E 
1200 4960 P 0 12 F 24 12 F (As) S 60 J ( mentioned) S 60 J ( in) S 60 J ( Section) S 60 J ( 12.1,) S 60 J ( any) S 60 J ( driver) S 60 J ( routine) S 60 J ( called) S 60 J ( with) S 60 J ( an) S 60 J ( input) S 60 J ( IRP) S 60 J ( that) S 60 J ( might) S 60 J ( have) S 
1200 5220 P (been) S 60 J ( held) S 60 J ( pending) S 60 J ( for) S 60 J ( an) S 60 J ( indefinite) S 60 J ( interval) S 60 J ( must) S 60 J ( check) S 60 J ( whether) S 60 J ( the) S 60 J ( request) S 60 J ( has) S 60 J ( already) S 60 J ( been) S 
1200 5480 P (cancelled.) S 
1200 5860 P (For) S 60 J ( example,) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( whose) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( was) S 60 J ( shown) S 60 J ( in) S 60 J ( Section) S 60 J ( 12.2) S 
1200 6120 P (maintains) S 60 J ( Booleans) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( extension) S 60 J ( so) S 60 J ( its) S 60 J ( KeyboardClassStartIo) S 60 J ( and) S 
1200 6380 P (KeyboardClassServiceCallback) S 60 J ( routines) S 60 J ( can) S 60 J ( check) S 60 J ( whether) S 60 J ( the) S 60 J ( Cancel) S 60 J ( \(or) S 60 J ( DispatchCleanup\)) S 
1200 6640 P (routine) S 60 J ( might) S 60 J ( be) S 60 J ( cancelling) S 60 J ( an) S 60 J ( IRP.) S 60 J ( Each) S 60 J ( of) S 60 J ( these) S 60 J ( routines) S 60 J ( also) S 60 J ( must) S 60 J ( remove) S 60 J ( an) S 60 J ( input) S 60 J ( IRP) S 
1200 6900 P (from) S 60 J ( the) S 60 J ( cancelable) S 60 J ( state) S 60 J ( before) S 60 J ( beginning) S 60 J ( I/O) S 60 J ( processing) S 60 J ( to) S 60 J ( satisfy) S 60 J ( the) S 60 J ( request:) S 60 J ( that) S 60 J ( is,) S 60 J ( each) S 
1200 7160 P (of) S 60 J ( these) S 60 J ( routines) S 60 J ( must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoAcquireCancelSpinLock) S E 0 12 F 24 12 F (,) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoSetCancelRoutine) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( reset) S 60 J ( the) S 
1200 7420 P (entry) S 60 J ( point) S 60 J ( for) S 60 J ( the) S 60 J ( driver's) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( to) S 60 J ( NULL,) S 60 J ( and) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 
1200 7680 P 0 12 F 24 12 F I (before) S E 0 12 F 24 12 F () S 60 J ( either) S 60 J ( routine) S 60 J ( begins) S 60 J ( I/O) S 60 J ( processing) S 60 J ( for) S 60 J ( the) S 60 J ( input) S 60 J ( IRP.) S 
1200 8060 P (Consider) S 60 J ( the) S 60 J ( following) S 60 J ( code) S 60 J ( in) S 60 J ( the) S 60 J ( KeyboardClassStartIo) S 60 J ( routine,) S 60 J ( which) S 60 J ( processes) S 60 J ( read) S 
1200 8320 P (requests) S 60 J ( from) S 60 J ( the) S 60 J ( Win32) S 60 J ( user) S 60 J ( input) S 60 J ( thread) S 60 J ( on) S 60 J ( behalf) S 60 J ( of) S 60 J ( the) S 60 J ( current) S 60 J ( user) S 60 J ( application:) S 
1680 8840 P 0 12 F 0 12 F ({) S 
1680 9100 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
1680 9360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
1680 9620 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp;) S 
1680 9880 P () S 480 J ( KIRQL) S 144 J ( cancelIrql;) S 
1680 10140 P () S 480 J ( PCHAR) S 144 J ( destination;) S 
1680 10400 P () S 480 J ( ULONG) S 144 J ( bytesInQueue;) S 
1680 10660 P () S 480 J ( ULONG) S 144 J ( bytesToMove;) S 
1680 10920 P () S 480 J ( ULONG) S 144 J ( moveSize;) S 
1680 11180 P (//) S 
1680 11440 P (//) S 144 J ( Bump) S 144 J ( the) S 144 J ( error) S 144 J ( log) S 144 J ( sequence) S 144 J ( number) S 144 J ( in) S 144 J ( case) S 144 J ( an) S 144 J ( error) S 
1680 11700 P (//) S 144 J ( has) S 144 J ( to) S 144 J ( be) S 144 J ( logged) S 144 J ( later.) S 
1680 11960 P (//) S 
1680 12220 P () S 480 J ( deviceExtension->SequenceNumber) S 144 J ( +=) S 144 J ( 1;) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 5060 J ( Cancel) S 55 J ( Routines) S 807 J ( 12-) S E B (7) S E B () S 720 J ( ) S E 
2400 2060 P 0 12 F 0 12 F (//) S 
2400 2320 P (//) S 144 J ( Acquire) S 144 J ( spin) S 144 J ( lock) S 144 J ( that) S 144 J ( protects) S 144 J ( the) S 144 J ( ring) S 144 J ( buffer) S 
2400 2580 P (//) S 144 J ( and) S 144 J ( associated) S 144 J ( pointers.) S 144 J ( Already) S 144 J ( running) S 144 J ( at) S 144 J ( IRQL) S 
2400 2840 P (//) S 144 J ( DISPATCH_LEVEL.) S 
2400 3100 P (//) S 
2400 3360 P () S 480 J ( KeAcquireSpinLockAtDpcLevel\() S 
2400 3620 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock\);) S 
2400 3880 P (//) S 
2400 4140 P (//) S 144 J ( Acquire) S 144 J ( the) S 144 J ( cancel) S 144 J ( spin) S 144 J ( lock) S 144 J ( to) S 144 J ( verify) S 144 J ( that) S 144 J ( the) S 144 J ( IRP) S 144 J ( has) S 
2400 4400 P (//) S 144 J ( not) S 144 J ( been) S 144 J ( cancelled) S 144 J ( already) S 144 J ( and) S 144 J ( that) S 144 J ( it) S 144 J ( is) S 144 J ( not) S 144 J ( being) S 
2400 4660 P (//) S 144 J ( cancelled) S 144 J ( by) S 144 J ( an) S 144 J ( in-progress) S 144 J ( cleanup) S 144 J ( operation.) S 
2400 4920 P (//) S 
2400 5180 P () S 480 J ( IoAcquireCancelSpinLock\(&cancelIrql\);) S 
2400 5440 P () S 480 J ( if) S 144 J ( \(Irp->Cancel) S 144 J ( ||) S 
2400 5700 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( deviceExtension->CleanupWasInitiated\)) S 144 J ( {) S 
2400 5960 P () S 480 J ( ) S 480 J ( IoReleaseCancelSpinLock\(cancelIrql\);) S 
2400 6220 P () S 480 J ( ) S 480 J ( KeReleaseSpinLockFromDpcLevel\() S 
2400 6480 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock\);) S 
2400 6740 P () S 480 J ( ) S 480 J ( return;) S 
2400 7000 P () S 480 J ( }) S 
2400 7260 P (//) S 
2400 7520 P (//) S 144 J ( If) S 144 J ( the) S 144 J ( ring) S 144 J ( buffer) S 144 J ( is) S 144 J ( not) S 144 J ( empty,) S 144 J ( satisfy) S 144 J ( the) S 144 J ( read) S 
2400 7780 P (//) S 144 J ( request.) S 144 J ( Otherwise,) S 144 J ( hold) S 144 J ( the) S 144 J ( request) S 144 J ( pending.) S 
2400 8040 P (//) S 
2400 8300 P () S 480 J ( if) S 144 J ( \(deviceExtension->InputCount) S 144 J ( !=) S 144 J ( 0\)) S 144 J ( {) S 
2400 8560 P (//) S 
2400 8820 P (//) S 144 J ( First,) S 144 J ( remove) S 144 J ( the) S 144 J ( request) S 144 J ( from) S 144 J ( the) S 144 J ( cancelable) S 144 J ( state) S 
2400 9080 P (//) S 144 J ( and) S 144 J ( free) S 144 J ( the) S 144 J ( cancel) S 144 J ( spin) S 144 J ( lock.) S 144 J ( Then,) S 144 J ( copy) S 144 J ( as) S 144 J ( much) S 
2400 9340 P (//) S 144 J ( of) S 144 J ( the) S 144 J ( input) S 144 J ( data) S 144 J ( as) S 144 J ( possible) S 144 J ( from) S 144 J ( the) S 144 J ( ring) S 144 J ( buffer) S 
2400 9600 P (//) S 144 J ( to) S 144 J ( Irp->AssociatedIrp.SystemBuffer) S 144 J ( to) S 144 J ( satisfy) S 
2400 9860 P (//) S 144 J ( the) S 144 J ( read...) S 
2400 10120 P (//) S 
2400 10380 P () S 480 J ( ) S 480 J ( IoSetCancelRoutine\(Irp,) S 144 J ( NULL\);) S 
2400 10640 P () S 480 J ( ) S 480 J ( DeviceObject->CurrentIrp) S 144 J ( =) S 144 J ( NULL;) S 
2400 10900 P () S 480 J ( ) S 480 J ( IoReleaseCancelSpinLock\(cancelIrql\);) S 
2400 11160 P () S 480 J ( ) S 480 J ( irpSp) S 144 J ( =) S 144 J ( IoGetCurrentIrpStackLocation;) S 
2400 11420 P () S 480 J ( ) S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 144 J ( //) S 144 J ( Satisfy) S 144 J ( read) S 144 J ( request.) S 
2400 11680 P () S 480 J ( ) S 480 J ( deviceExtension->RequestIsPending) S 144 J ( =) S 144 J ( FALSE;) S 0 12 F 
PE 
1200 1220 P 10 12 F B (12-) S E B (8) S E B () S 927 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( Release) S 144 J ( the) S 144 J ( ring) S 144 J ( buffer) S 144 J ( spin) S 144 J ( lock,) S 144 J ( start) S 
1680 2580 P (//) S 144 J ( the) S 144 J ( next) S 144 J ( packet,) S 144 J ( and) S 144 J ( complete) S 144 J ( this) S 144 J ( request.) S 
1680 2840 P (//) S 
1680 3100 P () S 480 J ( ) S 480 J ( KeReleaseSpinLockFromDpcLevel\() S 
1680 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock\);) S 
1680 3620 P () S 480 J ( ) S 480 J ( Irp->IoStatus.Status) S 144 J ( =) S 144 J ( STATUS_SUCCESS;) S 
1680 3880 P () S 480 J ( ) S 480 J ( Irp->IoStatus.Information) S 144 J ( =) S 144 J ( bytesToMove;) S 
1680 4140 P () S 480 J ( ) S 480 J ( Irp->Parameters.Read.Length) S 144 J ( =) S 144 J ( bytesToMove;) S 
1680 4400 P () S 480 J ( ) S 480 J ( IoStartNextPacket\(DeviceObject,) S 144 J ( TRUE\);) S 
1680 4660 P () S 480 J ( ) S 480 J ( IoCompleteRequest\(Irp,) S 144 J ( IO_KEYBOARD_INCREMENT\);) S 
1680 4920 P () S 480 J ( }) S 144 J ( else) S 144 J ( {) S 
1680 5180 P (//) S 
1680 5440 P (//) S 144 J ( Set) S 144 J ( RequestIsPending) S 144 J ( to) S 144 J ( indicate) S 144 J ( this) S 144 J ( request) S 
1680 5700 P (//) S 144 J ( is) S 144 J ( being) S 144 J ( held) S 144 J ( for) S 144 J ( the) S 144 J ( callback) S 144 J ( routine) S 144 J ( to) S 144 J ( complete.) S 
1680 5960 P (//) S 144 J ( It) S 144 J ( remains) S 144 J ( in) S 144 J ( the) S 144 J ( cancelable) S 144 J ( state.) S 
1680 6220 P (//) S 144 J ( When) S 144 J ( new) S 144 J ( input) S 144 J ( is) S 144 J ( received,) S 144 J ( KeyboardClassServiceCallback) S 
1680 6480 P (//) S 144 J ( will) S 144 J ( complete) S 144 J ( the) S 144 J ( request) S 144 J ( eventually.) S 
1680 6740 P (//) S 144 J ( For) S 144 J ( now,) S 144 J ( just) S 144 J ( release) S 144 J ( the) S 144 J ( spin) S 144 J ( locks.) S 
1680 7000 P (//) S 
1680 7260 P () S 480 J ( ) S 480 J ( deviceExtension->RequestIsPending) S 144 J ( =) S 144 J ( TRUE;) S 
1680 7520 P () S 480 J ( ) S 480 J ( IoReleaseCancelSpinLock\(cancelIrql\);) S 
1680 7780 P () S 480 J ( ) S 480 J ( KeReleaseSpinLockFromDpcLevel\() S 
1680 8040 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock\);) S 
1680 8300 P () S 480 J ( }) S 
1680 8560 P () S 480 J ( return;) S 
1680 8820 P (}) S 
1200 9200 P 0 12 F 24 12 F (Note) S 60 J ( that) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( maintains) S 60 J ( state) S 60 J ( information) S 60 J ( about) S 60 J ( whether) S 60 J ( there) S 60 J ( is) S 60 J ( a) S 
1200 9460 P (pending) S 60 J ( read) S 60 J ( request) S 60 J ( and) S 60 J ( whether) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( is) S 60 J ( being) S 60 J ( cancelled) S 60 J ( by) S 60 J ( the) S 60 J ( DispatchCleanup) S 
1200 9720 P (routine) S 60 J ( in) S 60 J ( its) S 60 J ( device) S 60 J ( extension.) S 60 J ( This) S 60 J ( driver) S 60 J ( relies) S 60 J ( on) S 60 J ( the) S 60 J ( Win32) S 60 J ( user) S 60 J ( input) S 60 J ( thread) S 60 J ( to) S 60 J ( direct) S 
1200 9980 P (keyboard) S 60 J ( input) S 60 J ( to) S 60 J ( the) S 60 J ( appropriate) S 60 J ( application.) S 60 J ( Note) S 60 J ( also) S 60 J ( that) S 60 J ( a) S 60 J ( pending) S 60 J ( read) S 60 J ( request) S 60 J ( might) S 60 J ( be) S 
1200 10240 P (cancelled) S 60 J ( subsequently,) S 60 J ( while) S 60 J ( the) S 60 J ( keyboard) S 60 J ( class) S 60 J ( driver) S 60 J ( is) S 60 J ( waiting) S 60 J ( for) S 60 J ( input) S 60 J ( from) S 60 J ( the) S 60 J ( device.) S 
1200 10620 P (In) S 60 J ( other) S 60 J ( words,) S 60 J ( its) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( might) S 60 J ( be) S 60 J ( called) S 60 J ( with) S 60 J ( the) S 60 J ( IRP) S 60 J ( that) S 60 J ( the) S 60 J ( preceding) S 
1200 10880 P (KeyboardClassStartIo) S 60 J ( routine) S 60 J ( held) S 60 J ( pending) S 60 J ( before) S 60 J ( KeyboardClassServiceCallback) S 60 J ( is) S 60 J ( next) S 
1200 11140 P (entered) S 60 J ( to) S 60 J ( collect) S 60 J ( keystrokes) S 60 J ( coming) S 60 J ( in) S 60 J ( from) S 60 J ( the) S 60 J ( device.) S 60 J ( As) S 60 J ( also) S 60 J ( shown) S 60 J ( in) S 60 J ( Chapter) S 60 J ( 9,) S 60 J ( the) S 
1200 11400 P (KeyboardClassServiceCallback) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( at) S 60 J ( IRQL) S 60 J ( DISPATCH_LEVEL) S 60 J ( from) S 60 J ( the) S 
1200 11660 P (underlying) S 60 J ( port) S 60 J ( driver's) S 60 J ( DpcForIsr) S 60 J ( routine.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 5060 J ( Cancel) S 55 J ( Routines) S 807 J ( 12-) S E B (9) S E B () S 720 J ( ) S E 
1920 2060 P 0 12 F 24 12 F (Consequently,) S 60 J ( the) S 60 J ( KeyboardClassServiceCallback) S 60 J ( routine) S 60 J ( also) S 60 J ( must) S 60 J ( check) S 60 J ( whether) S 60 J ( there) S 60 J ( is) S 60 J ( an) S 
1920 2320 P (outstanding) S 60 J ( read) S 60 J ( request) S 60 J ( and,) S 60 J ( if) S 60 J ( so,) S 60 J ( reset) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( in) S 60 J ( the) S 60 J ( IRP,) S 60 J ( as) S 60 J ( follows:) S 
2400 2840 P 0 12 F 0 12 F ({) S 
2400 3100 P () S 480 J ( PDEVICE_EXTENSION) S 144 J ( deviceExtension) S 144 J ( =) S 
2400 3360 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( DeviceObject->DeviceExtension;) S 
2400 3620 P () S 480 J ( PIRP) S 144 J ( irp;) S 
2400 3880 P () S 480 J ( PIO_STACK_LOCATION) S 144 J ( irpSp;) S 
2400 4140 P () S 480 J ( KIRQL) S 144 J ( cancelIrql;) S 
2400 4400 P () S 480 J ( ULONG) S 144 J ( bytesInQueue;) S 
2400 4660 P () S 480 J ( ULONG) S 144 J ( bytesToMove;) S 
2400 4920 P () S 480 J ( ULONG) S 144 J ( moveSize) S 144 J ( =) S 144 J ( 0;) S 
2400 5180 P () S 480 J ( BOOLEAN) S 144 J ( satisfiedPendingReadRequest) S 144 J ( =) S 144 J ( FALSE;) S 
2400 5440 P () S 480 J ( PIO_ERROR_LOG_PACKET) S 144 J ( errorLogEntry;) S 
2400 5700 P (//) S 
2400 5960 P (//) S 144 J ( Initialized) S 144 J ( from) S 144 J ( input) S 144 J ( arguments.) S 
2400 6220 P (//) S 
2400 6480 P () S 480 J ( ULONG) S 144 J ( bytesInQueue) S 144 J ( =) S 
2400 6740 P () S 480 J ( ) S 480 J ( ) S 480 J ( \(PCHAR\)) S 144 J ( InputDataEnd) S 144 J ( -) S 144 J ( \(PCHAR\)) S 144 J ( InputDataStart;) S 
2400 7000 P () S 480 J ( *InputDataConsumed) S 144 J ( =) S 144 J ( 0;) S 
2400 7260 P (//) S 
2400 7520 P (//) S 144 J ( Acquire) S 144 J ( the) S 144 J ( deviceExtension) S 144 J ( spin) S 144 J ( lock) S 144 J ( to) S 144 J ( look) S 144 J ( at) S 
2400 7780 P (//) S 144 J ( RequestIsPending) S 144 J ( synchronously.) S 144 J ( If) S 144 J ( there) S 144 J ( is) S 144 J ( a) S 144 J ( pending) S 
2400 8040 P (//) S 144 J ( read) S 144 J ( request,) S 144 J ( satisfy) S 144 J ( it.) S 
2400 8300 P (//) S 
2400 8560 P () S 480 J ( KeAcquireSpinLockAtDpcLevel\() S 
2400 8820 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock\);) S 
2400 9080 P () S 480 J ( if) S 144 J ( \(deviceExtension->RequestIsPending\)) S 144 J ( {) S 
2400 9340 P (//) S 
2400 9600 P (//) S 144 J ( Acquire) S 144 J ( the) S 144 J ( cancel) S 144 J ( spin) S 144 J ( lock,) S 144 J ( remove) S 144 J ( the) S 144 J ( request) S 
2400 9860 P (//) S 144 J ( from) S 144 J ( the) S 144 J ( cancelable) S 144 J ( state,) S 144 J ( and) S 144 J ( free) S 144 J ( the) S 144 J ( cancel) S 144 J ( spin) S 144 J ( lock.) S 
2400 10120 P (//) S 
2400 10380 P () S 480 J ( ) S 480 J ( IoAcquireCancelSpinLock\(&cancelIrql\);) S 
2400 10640 P () S 480 J ( ) S 480 J ( irp) S 144 J ( =) S 144 J ( DeviceObject->CurrentIrp;) S 
2400 10900 P () S 480 J ( ) S 480 J ( IoSetCancelRoutine\(irp,) S 144 J ( NULL\);) S 
2400 11160 P () S 480 J ( ) S 480 J ( DeviceObject->CurrentIrp) S 144 J ( =) S 144 J ( NULL;) S 
2400 11420 P () S 480 J ( ) S 480 J ( IoReleaseCancelSpinLock\(cancelIrql\);) S 
2400 11680 P () S 480 J ( ) S 480 J ( deviceExtension->RequestIsPending) S 144 J ( =) S 144 J ( FALSE;) S 0 12 F 
PE 
1200 1220 P 10 12 F B (12-) S E B (10) S E B () S 818 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1680 2060 P 0 12 F 0 12 F (//) S 
1680 2320 P (//) S 144 J ( Copy) S 144 J ( as) S 144 J ( much) S 144 J ( data) S 144 J ( as) S 144 J ( possible) S 144 J ( from) S 144 J ( the) S 144 J ( port) S 144 J ( driver's) S 
1680 2580 P (//) S 144 J ( input) S 144 J ( data) S 144 J ( queue) S 144 J ( to) S 144 J ( Irp->AssociatedIrp.SystemBuffer) S 
1680 2840 P (//) S 144 J ( to) S 144 J ( satisfy) S 144 J ( the) S 144 J ( read) S 144 J ( request.) S 
1680 3100 P (//) S 
1680 3360 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 3620 P () S 480 J ( ) S 480 J ( satisfiedPendingReadRequest) S 144 J ( =) S 144 J ( TRUE;) S 
1680 3880 P () S 480 J ( }) S 
1680 4140 P (//) S 
1680 4400 P (//) S 144 J ( If) S 144 J ( there) S 144 J ( is) S 144 J ( still) S 144 J ( data) S 144 J ( in) S 144 J ( the) S 144 J ( port) S 144 J ( driver's) S 144 J ( input) S 144 J ( data) S 
1680 4660 P (//) S 144 J ( queue,) S 144 J ( move) S 144 J ( it) S 144 J ( to) S 144 J ( the) S 144 J ( ring) S 144 J ( buffer.) S 
1680 4920 P (//) S 
1680 5180 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 5440 P (//) S 
1680 5700 P (//) S 144 J ( Log) S 144 J ( an) S 144 J ( overrun) S 144 J ( error) S 144 J ( if) S 144 J ( too) S 144 J ( many) S 144 J ( keystrokes) S 144 J ( coming) S 144 J ( in) S 
1680 5960 P (//) S 144 J ( for) S 144 J ( the) S 144 J ( ring) S 144 J ( buffer) S 144 J ( to) S 144 J ( hold.) S 
1680 6220 P (//) S 
1680 6480 P () S 480 J ( ) S 480 J ( :) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( ) S 144 J ( :) S 
1680 6740 P () S 480 J ( }) S 
1680 7000 P (//) S 
1680 7260 P (//) S 144 J ( Release) S 144 J ( the) S 144 J ( ring) S 144 J ( buffer) S 144 J ( spin) S 144 J ( lock.) S 144 J ( If) S 144 J ( an) S 144 J ( outstanding) S 
1680 7520 P (//) S 144 J ( read) S 144 J ( request) S 144 J ( was) S 144 J ( satisfied) S 144 J ( here,) S 144 J ( start) S 144 J ( the) S 144 J ( next) S 
1680 7780 P (//) S 144 J ( packet) S 144 J ( and) S 144 J ( complete) S 144 J ( the) S 144 J ( request.) S 
1680 8040 P (//) S 
1680 8300 P () S 480 J ( KeReleaseSpinLockFromDpcLevel\() S 
1680 8560 P () S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( ) S 480 J ( &deviceExtension->SpinLock\);) S 
1680 8820 P () S 480 J ( if) S 144 J ( \(satisfiedPendingReadRequest\)) S 144 J ( {) S 
1680 9080 P () S 480 J ( ) S 480 J ( IoStartNextPacket\(DeviceObject,) S 144 J ( TRUE\);) S 
1680 9340 P () S 480 J ( ) S 480 J ( IoCompleteRequest\(irp,) S 144 J ( IO_KEYBOARD_INCREMENT\);) S 
1680 9600 P () S 480 J ( }) S 
1680 9860 P () S 480 J ( return;) S 
1680 10120 P (}) S 
1200 10500 P 0 12 F 24 12 F (Before) S 60 J ( the) S 60 J ( KeyboardClassServiceCallback) S 60 J ( routine) S 60 J ( satisfies) S 60 J ( a) S 60 J ( pending) S 60 J ( read) S 60 J ( request,) S 60 J ( it) S 60 J ( must) S 60 J ( call) S 
1200 10760 P 0 12 F 24 12 F B (IoAcquireCancelSpinLock) S E 0 12 F 24 12 F (,) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoSetCancelRoutine) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( reset) S 60 J ( its) S 60 J ( Cancel) S 60 J ( entry) S 60 J ( point) S 60 J ( in) S 60 J ( the) S 
1200 11020 P (IRP) S 60 J ( to) S 60 J ( NULL,) S 60 J ( and) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F (.) S 
1200 11400 P (Any) S 60 J ( driver) S 60 J ( that) S 60 J ( handles) S 60 J ( cancelable) S 60 J ( IRPs) S 60 J ( must) S 60 J ( do) S 60 J ( likewise) S 60 J ( so) S 60 J ( that) S 60 J ( its) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( cannot) S 60 J ( be) S 
1200 11660 P (called) S 60 J ( with) S 60 J ( the) S 60 J ( IRP) S 60 J ( that) S 60 J ( another) S 60 J ( driver) S 60 J ( routine) S 60 J ( is) S 60 J ( currently) S 60 J ( processing.) S 60 J ( Using) S 60 J ( the) S 60 J ( system-) S 
1200 11920 P (supplied) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( in) S 60 J ( this) S 60 J ( manner) S 60 J ( ensures) S 60 J ( that) S 60 J ( only) S 60 J ( one) S 60 J ( routine) S 60 J ( in) S 60 J ( the) S 60 J ( driver) S 60 J ( is) S 60 J ( allowed) S 
1200 12180 P (to) S 60 J ( change) S 60 J ( the) S 60 J ( cancelable) S 60 J ( state) S 60 J ( of) S 60 J ( an) S 60 J ( IRP) S 60 J ( at) S 60 J ( any) S 60 J ( given) S 60 J ( moment) S 60 J ( in) S 60 J ( SMP) S 60 J ( machines.) S 0 12 F 
PE 
1920 1220 P 10 12 F B () S 5060 J ( Cancel) S 55 J ( Routines) S 698 J ( 12-) S E B (11) S E B () S 720 J ( ) S E 
1920 2120 P 0 12 F 8 14 F B (12.4) S 78 J ( ) S 78 J ( ) S 78 J ( ) S 78 J ( Points) S 78 J ( to) S 78 J ( Consider) S 78 J ( In) S 78 J ( Handling) S 78 J ( Cancelable) S 78 J ( IRPs) S E 
1920 2740 P 0 12 F 24 12 F (Keep) S 60 J ( the) S 60 J ( following) S 60 J ( points) S 60 J ( in) S 60 J ( mind) S 60 J ( when) S 60 J ( implementing) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( and) S 60 J ( handling) S 
1920 3000 P (cancelable) S 60 J ( IRPs:) S 
1920 3320 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 60 J ( the) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( already) S 60 J ( held,) S 60 J ( so) S 60 J ( it) S 60 J ( must) S 60 J ( call) S 
2400 3580 P 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( before) S 60 J ( it) S 60 J ( returns) S 60 J ( control.) S 60 J ( It) S 60 J ( must) S 60 J ( not) S 60 J ( call) S 
2400 3840 P 0 12 F 24 12 F B (IoAcquireCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( unless) S 60 J ( it) S 60 J ( calls) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( first,) S 60 J ( and) S 60 J ( it) S 60 J ( must) S 
2400 4100 P (make) S 60 J ( a) S 60 J ( reciprocal) S 60 J ( call) S 60 J ( to) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F () S 60 J ( for) S 60 J ( each) S 60 J ( call) S 60 J ( it) S 60 J ( makes) S 60 J ( to) S 
2400 4360 P 0 12 F 24 12 F B (IoAcquireCancelSpinLock) S E 0 12 F 24 12 F (.) S 
1920 4680 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( Unless) S 60 J ( a) S 60 J ( driver) S 60 J ( manages) S 60 J ( its) S 60 J ( own) S 60 J ( internal) S 60 J ( queues) S 60 J ( of) S 60 J ( IRPs,) S 60 J ( its) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 
2400 4940 P (an) S 60 J ( input) S 60 J ( IRP) S 60 J ( that) S 60 J ( could) S 60 J ( be) S 60 J ( either) S 60 J ( of) S 60 J ( the) S 60 J ( following:) S 
1920 5260 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( The) S 60 J ( ) S 0 12 F 24 12 F B (CurrentIrp) S E 0 12 F 24 12 F () S 60 J ( in) S 60 J ( the) S 60 J ( input) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 
1920 5580 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( An) S 60 J ( entry) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( queue) S 60 J ( associated) S 60 J ( with) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object) S 
1920 5900 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Unless) S 60 J ( a) S 60 J ( driver) S 60 J ( manages) S 60 J ( its) S 60 J ( own) S 60 J ( internal) S 60 J ( queues) S 60 J ( of) S 60 J ( IRPs,) S 60 J ( its) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( should) S 60 J ( call) S 
2400 6160 P 0 12 F 24 12 F B (KeRemoveEntryDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( to) S 60 J ( test) S 60 J ( whether) S 60 J ( it) S 60 J ( is) S 60 J ( an) S 60 J ( entry) S 60 J ( in) S 60 J ( the) S 
2400 6420 P (device) S 60 J ( queue) S 60 J ( associated) S 60 J ( with) S 60 J ( the) S 60 J ( target) S 60 J ( device) S 60 J ( object.) S 60 J ( Such) S 60 J ( a) S 60 J ( driver's) S 60 J ( Cancel) S 60 J ( routine) S 
2400 6680 P 0 12 F 24 12 F I (cannot) S E 0 12 F 24 12 F () S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( or) S 60 J ( ) S 0 12 F 24 12 F B (KeRemoveByKeyDeviceQueue) S E 0 12 F 24 12 F () S 60 J ( because) S 60 J ( it) S 
2400 6940 P (cannot) S 60 J ( assume) S 60 J ( that) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( is) S 60 J ( at) S 60 J ( any) S 60 J ( particular) S 60 J ( position) S 60 J ( in) S 60 J ( the) S 60 J ( device) S 60 J ( queue.) S 
1920 7260 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( a) S 60 J ( driver) S 60 J ( does) S 60 J ( manage) S 60 J ( its) S 60 J ( own) S 60 J ( internal) S 60 J ( queue) S 60 J ( of) S 60 J ( IRPs) S 60 J ( and) S 60 J ( has) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine,) S 60 J ( the) S 
2400 7520 P (queue) S 60 J ( must) S 60 J ( be) S 60 J ( an) S 60 J ( interlocked) S 60 J ( queue) S 60 J ( protected) S 60 J ( by) S 60 J ( an) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock.) S 60 J ( Otherwise,) S 60 J ( such) S 
2400 7780 P (a) S 60 J ( driver's) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( might) S 60 J ( be) S 60 J ( called) S 60 J ( with) S 60 J ( an) S 60 J ( IRP) S 60 J ( for) S 60 J ( which) S 60 J ( another) S 60 J ( driver) S 60 J ( routine) S 
2400 8040 P (could) S 60 J ( begin) S 60 J ( concurrent) S 60 J ( I/O) S 60 J ( processing) S 60 J ( in) S 60 J ( an) S 60 J ( SMP) S 60 J ( machine.) S 
1920 8360 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( Provided) S 60 J ( that) S 60 J ( the) S 60 J ( current) S 60 J ( state) S 60 J ( of) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( is) S 60 J ( pending,) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( must) S 60 J ( do) S 60 J ( the) S 
2400 8620 P (following:) S 
1920 8940 P () S 544 J ( 1) S 296 J ( Set) S 60 J ( the) S 60 J ( input) S 60 J ( IRP's) S 60 J ( I/O) S 60 J ( status) S 60 J ( block) S 60 J ( with) S 60 J ( STATUS_CANCELLED) S 60 J ( in) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Status) S E 
2880 9200 P 0 12 F 24 12 F (field) S 60 J ( and) S 60 J ( zero) S 60 J ( in) S 60 J ( the) S 60 J ( ) S 0 12 F 24 12 F B (Information) S E 0 12 F 24 12 F () S 60 J ( field.) S 
1920 9520 P () S 544 J ( 2) S 296 J ( Release) S 60 J ( any) S 60 J ( spin) S 60 J ( locks) S 60 J ( it) S 60 J ( is) S 60 J ( holding,) S 60 J ( including) S 60 J ( the) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock.) S 
1920 9840 P () S 544 J ( 3) S 296 J ( Call) S 60 J ( ) S 0 12 F 24 12 F B (IoCompleteRequest) S E 0 12 F 24 12 F () S 60 J ( with) S 60 J ( the) S 60 J ( input) S 60 J ( IRP) S 60 J ( and) S 60 J ( a) S 60 J ( system-defined,) S 60 J ( device-type-) S 
2880 10100 P (specific) S 60 J ( ) S 0 12 F 24 12 F I (PriorityBoost) S E 0 12 F 24 12 F () S 60 J ( value) S 60 J ( because) S 60 J ( the) S 60 J ( originator) S 60 J ( of) S 60 J ( the) S 60 J ( request,) S 60 J ( which) S 60 J ( is) S 60 J ( always) S 60 J ( a) S 
2880 10360 P (specific) S 60 J ( thread,) S 60 J ( is) S 60 J ( assumed) S 60 J ( to) S 60 J ( have) S 60 J ( waited) S 60 J ( for) S 60 J ( an) S 60 J ( indefinite) S 60 J ( interval) S 60 J ( on) S 60 J ( the) S 60 J ( IRP.) S 
1920 10680 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( a) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( is) S 60 J ( called) S 60 J ( with) S 60 J ( an) S 60 J ( input) S 60 J ( IRP) S 60 J ( for) S 60 J ( which) S 60 J ( the) S 60 J ( driver) S 60 J ( has) S 60 J ( already) S 60 J ( started) S 60 J ( I/O) S 
2400 10940 P (processing,) S 60 J ( the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( should) S 60 J ( release) S 60 J ( the) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( and) S 60 J ( return) S 60 J ( control.) S 
1920 11260 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( Any) S 60 J ( other) S 60 J ( driver) S 60 J ( routine) S 60 J ( that) S 60 J ( processes) S 60 J ( cancelable) S 60 J ( IRPs) S 60 J ( must) S 60 J ( check) S 60 J ( whether) S 60 J ( an) S 60 J ( IRP) S 60 J ( has) S 
2400 11520 P (already) S 60 J ( been) S 60 J ( cancelled) S 60 J ( before) S 60 J ( it) S 60 J ( begins) S 60 J ( operations) S 60 J ( to) S 60 J ( satisfy) S 60 J ( the) S 60 J ( request.) S 60 J ( Such) S 60 J ( a) S 60 J ( routine) S 
2400 11780 P (must) S 60 J ( call) S 60 J ( ) S 0 12 F 24 12 F B (IoAcquireCancelSpinLock) S E 0 12 F 24 12 F (,) S 60 J ( ) S 0 12 F 24 12 F B (IoSetCancelRoutine) S E 0 12 F 24 12 F () S 60 J ( to) S 60 J ( reset) S 60 J ( its) S 60 J ( entry) S 60 J ( point) S 60 J ( for) S 
2400 12040 P (the) S 60 J ( Cancel) S 60 J ( routine) S 60 J ( to) S 60 J ( NULL) S 60 J ( in) S 60 J ( the) S 60 J ( IRP,) S 60 J ( and) S 60 J ( ) S 0 12 F 24 12 F B (IoReleaseCancelSpinLock) S E 0 12 F 24 12 F (.) S 60 J ( Only) S 60 J ( then) S 60 J ( can) S 
2400 12300 P (that) S 60 J ( routine) S 60 J ( begin) S 60 J ( its) S 60 J ( I/O) S 60 J ( processing) S 60 J ( for) S 60 J ( the) S 60 J ( input) S 60 J ( IRP.) S 0 12 F 
PE 
1200 1220 P 10 12 F B (12-) S E B (12) S E B () S 818 J ( Kernel-mode) S 55 J ( Driver) S 55 J ( Design) S 55 J ( Guide) S E 
1200 2060 P 0 12 F 60 10 F B () S 72 J ( n) S E 0 12 F 24 12 F () S 256 J ( A) S 60 J ( driver) S 60 J ( can) S 60 J ( \(or) S 60 J ( must,) S 60 J ( depending) S 60 J ( on) S 60 J ( its) S 60 J ( design\)) S 60 J ( maintain) S 60 J ( additional) S 60 J ( state) S 60 J ( information) S 60 J ( in) S 
1680 2320 P (its) S 60 J ( device) S 60 J ( extension) S 60 J ( to) S 60 J ( track) S 60 J ( the) S 60 J ( cancelable) S 60 J ( status) S 60 J ( of) S 60 J ( IRPs.) S 60 J ( If) S 60 J ( this) S 60 J ( state) S 60 J ( is) S 60 J ( shared) S 60 J ( by) S 60 J ( driver) S 
1680 2580 P (routines) S 60 J ( running) S 60 J ( at) S 60 J ( DISPATCH_LEVEL) S 60 J ( IRQL,) S 60 J ( the) S 60 J ( shared) S 60 J ( data) S 60 J ( can) S 60 J ( be) S 60 J ( protected) S 60 J ( with) S 60 J ( a) S 
1680 2840 P (driver-allocated) S 60 J ( and) S 60 J ( initialized) S 60 J ( executive) S 60 J ( spin) S 60 J ( lock.) S 60 J ( However,) S 60 J ( such) S 60 J ( a) S 60 J ( driver) S 60 J ( should) S 
1680 3100 P (manage) S 60 J ( its) S 60 J ( acquisitions) S 60 J ( and) S 60 J ( releases) S 60 J ( of) S 60 J ( the) S 60 J ( system-provided) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( and) S 60 J ( its) S 60 J ( own) S 
1680 3360 P (spin) S 60 J ( lock) S 60 J ( carefully,) S 60 J ( according) S 60 J ( to) S 60 J ( the) S 60 J ( following) S 60 J ( guidelines:) S 
1200 3680 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( The) S 60 J ( driver) S 60 J ( should) S 60 J ( be) S 60 J ( designed) S 60 J ( to) S 60 J ( hold) S 60 J ( the) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( for) S 60 J ( the) S 60 J ( shortest) S 60 J ( possible) S 
2160 3940 P (interval\(s\).) S 
1200 4260 P () S 512 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 296 J ( If) S 60 J ( the) S 60 J ( driver's) S 60 J ( calls) S 60 J ( to) S 60 J ( acquire) S 60 J ( each) S 60 J ( spin) S 60 J ( lock) S 60 J ( are) S 60 J ( nested,) S 60 J ( the) S 60 J ( system's) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 
2160 4520 P (should) S 60 J ( be) S 60 J ( acquired) S 60 J ( after) S 60 J ( the) S 60 J ( driver) S 60 J ( acquires) S 60 J ( its) S 60 J ( own) S 60 J ( spin) S 60 J ( lock.) S 60 J ( Therefore,) S 60 J ( the) S 
2160 4780 P (system's) S 60 J ( cancel) S 60 J ( spin) S 60 J ( lock) S 60 J ( should) S 60 J ( be) S 60 J ( released) S 60 J ( before) S 60 J ( the) S 60 J ( driver) S 60 J ( releases) S 60 J ( its) S 60 J ( own) S 60 J ( spin) S 
2160 5040 P (lock.) S 
1200 5360 P () S 72 J ( ) S 0 12 F 60 10 F B (n) S E 0 12 F 24 12 F () S 256 J ( If) S 60 J ( a) S 60 J ( device) S 60 J ( driver) S 60 J ( maintains) S 60 J ( state) S 60 J ( information) S 60 J ( about) S 60 J ( cancelable) S 60 J ( IRPs) S 60 J ( that) S 60 J ( various) S 60 J ( driver) S 
1680 5620 P (routines) S 60 J ( share) S 60 J ( with) S 60 J ( its) S 60 J ( ISR,) S 60 J ( these) S 60 J ( other) S 60 J ( routines) S 60 J ( must) S 60 J ( synchronize) S 60 J ( access) S 60 J ( to) S 60 J ( the) S 60 J ( shared) S 
1680 5880 P (state) S 60 J ( with) S 60 J ( the) S 60 J ( ISR.) S 60 J ( That) S 60 J ( is,) S 60 J ( only) S 60 J ( a) S 60 J ( driver-supplied) S 60 J ( SynchCritSection) S 60 J ( routine) S 60 J ( or) S 60 J ( the) S 60 J ( ISR) S 
1680 6140 P (can) S 60 J ( access) S 60 J ( such) S 60 J ( shared) S 60 J ( state) S 60 J ( in) S 60 J ( a) S 60 J ( multiprocessor-safe) S 60 J ( way.) S 
1200 6520 P (For) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( using) S 60 J ( spin) S 60 J ( locks,) S 60 J ( see) S 60 J ( Chapter) S 60 J ( 16.) S 60 J ( See) S 60 J ( Chapters) S 60 J ( 8) S 60 J ( and) S 60 J ( 10,) S 
1200 6780 P (respectively,) S 60 J ( for) S 60 J ( more) S 60 J ( information) S 60 J ( about) S 60 J ( ISRs) S 60 J ( and) S 60 J ( SynchCritSection) S 60 J ( routines.) S 0 12 F 
PE PSe
